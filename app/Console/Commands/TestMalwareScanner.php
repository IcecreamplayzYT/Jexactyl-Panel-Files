<?php
/*
namespace Jexactyl\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\File;

class TestMalwareScanner extends Command
{
    protected $signature = 'malware-scanner:test';
    protected $description = 'Test malware scanner installation and configuration';

    public function handle()
    {
        $this->info('ðŸ” Testing Malware Scanner Installation...');
        $this->newLine();

        $allPassed = true;

        // Test 1: Check if commands are registered
        $this->info('[1/7] Checking command registration...');
        if ($this->testCommandRegistration()) {
            $this->line('   âœ“ Commands registered');
        } else {
            $this->error('   âœ— Commands not found');
            $allPassed = false;
        }

        // Test 2: Check config file
        $this->info('[2/7] Checking configuration file...');
        if ($this->testConfigFile()) {
            $this->line('   âœ“ Config file loaded');
        } else {
            $this->error('   âœ— Config file missing or invalid');
            $allPassed = false;
        }

        // Test 3: Check webhook URL
        $this->info('[3/7] Checking Discord webhook...');
        if ($this->testWebhookUrl()) {
            $this->line('   âœ“ Webhook URL configured');
        } else {
            $this->warn('   ! Webhook URL not configured (optional)');
        }

        // Test 4: Check log directory
        $this->info('[4/7] Checking log directory...');
        if ($this->testLogDirectory()) {
            $this->line('   âœ“ Log directory exists and is writable');
        } else {
            $this->error('   âœ— Log directory missing or not writable');
            $allPassed = false;
        }

        // Test 5: Check database migration
        $this->info('[5/7] Checking database schema...');
        if ($this->testDatabaseSchema()) {
            $this->line('   âœ“ Suspension reason column exists');
        } else {
            $this->warn('   ! Suspension reason column missing (run migration)');
        }

        // Test 6: Test pattern matching
        $this->info('[6/7] Testing malware patterns...');
        if ($this->testPatterns()) {
            $this->line('   âœ“ Pattern matching working');
        } else {
            $this->error('   âœ— Pattern matching failed');
            $allPassed = false;
        }

        // Test 7: Check scheduler
        $this->info('[7/7] Checking Laravel scheduler...');
        if ($this->testScheduler()) {
            $this->line('   âœ“ Scheduler configured');
        } else {
            $this->warn('   ! Scheduler may not be configured (check cron)');
        }

        $this->newLine();

        if ($allPassed) {
            $this->info('âœ… All critical tests passed!');
            $this->newLine();
            $this->line('Next steps:');
            $this->line('1. Configure Discord webhook URL in .env');
            $this->line('2. Run database migration if needed');
            $this->line('3. Test manual scan: php artisan servers:scan-malware');
            $this->line('4. Verify scheduler is running: php artisan schedule:list');
        } else {
            $this->error('âŒ Some tests failed. Please fix the issues above.');
        }

        return $allPassed ? Command::SUCCESS : Command::FAILURE;
    }

    private function testCommandRegistration(): bool
    {
        $commands = $this->getApplication()->all();
        return isset($commands['servers:scan-malware']) && isset($commands['servers:cleanup-suspended']);
    }

    private function testConfigFile(): bool
    {
        try {
            $config = config('malware_scanner');
            return is_array($config) && isset($config['scan_extensions']);
        } catch (\Exception $e) {
            return false;
        }
    }

    private function testWebhookUrl(): bool
    {
        $url = config('malware_scanner.discord_webhook_url');
        return !empty($url) && filter_var($url, FILTER_VALIDATE_URL);
    }

    private function testLogDirectory(): bool
    {
        $logPath = storage_path('logs');
        return File::isDirectory($logPath) && File::isWritable($logPath);
    }

    private function testDatabaseSchema(): bool
    {
        try {
            return \Schema::hasColumn('servers', 'suspension_reason');
        } catch (\Exception $e) {
            return false;
        }
    }

    private function testPatterns(): bool
    {
        // Test some basic patterns
        $testCases = [
            ['discord.selfbot', true],
            ['viewbot script', true],
            ['normal code', false],
        ];

        $pattern = '/discord\.selfbot|viewbot/i';

        foreach ($testCases as [$text, $shouldMatch]) {
            $matches = preg_match($pattern, $text);
            if ($matches !== (int)$shouldMatch) {
                return false;
            }
        }

        return true;
    }

    private function testScheduler(): bool
    {
        try {
            // Check if schedule:run command exists
            $commands = $this->getApplication()->all();
            return isset($commands['schedule:run']);
        } catch (\Exception $e) {
            return false;
        }
    }
}w