This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
app/
  Console/
    Commands/
      Environment/
        AppSettingsCommand.php
        DatabaseSettingsCommand.php
        EmailSettingsCommand.php
      Location/
        DeleteLocationCommand.php
        MakeLocationCommand.php
      Maintenance/
        CleanServiceBackupFilesCommand.php
        PruneOrphanedBackupsCommand.php
      Node/
        MakeNodeCommand.php
        NodeConfigurationCommand.php
        NodeListCommand.php
      Overrides/
        SeedCommand.php
        UpCommand.php
      Schedule/
        AnalyticsCollectionCommand.php
        AnalyticsReviewCommand.php
        CouponCommand.php
        ProcessRunnableCommand.php
        PruneCommand.php
        RenewalCommand.php
      Server/
        BulkPowerActionCommand.php
      User/
        DeleteUserCommand.php
        DisableTwoFactorCommand.php
        MakeUserCommand.php
      CheckPendingRobuxPurchases.php
      InfoCommand.php
      UpgradeCommand.php
    Kernel.php
    RequiresDatabaseMigrations.php
  Contracts/
    Core/
      ReceivesEvents.php
    Criteria/
      CriteriaInterface.php
    Extensions/
      HashidsInterface.php
    Http/
      ClientPermissionsRequest.php
    Repository/
      AllocationRepositoryInterface.php
      ApiKeyRepositoryInterface.php
      ApiPermissionRepositoryInterface.php
      DatabaseHostRepositoryInterface.php
      DatabaseRepositoryInterface.php
      EggRepositoryInterface.php
      EggVariableRepositoryInterface.php
      LocationRepositoryInterface.php
      NestRepositoryInterface.php
      NodeRepositoryInterface.php
      PermissionRepositoryInterface.php
      RepositoryInterface.php
      ScheduleRepositoryInterface.php
      ServerRepositoryInterface.php
      ServerVariableRepositoryInterface.php
      SessionRepositoryInterface.php
      SettingsRepositoryInterface.php
      SubuserRepositoryInterface.php
      TaskRepositoryInterface.php
      UserRepositoryInterface.php
  Events/
    Auth/
      DirectLogin.php
      FailedCaptcha.php
      FailedPasswordReset.php
      ProvidedAuthenticationToken.php
    Server/
      Created.php
      Creating.php
      Deleted.php
      Deleting.php
      Installed.php
      Saved.php
      Saving.php
      Updated.php
      Updating.php
    Subuser/
      Created.php
      Creating.php
      Deleted.php
      Deleting.php
    User/
      Created.php
      Creating.php
      Deleted.php
      Deleting.php
    ActivityLogged.php
    Event.php
  Exceptions/
    Http/
      Base/
        InvalidPasswordProvidedException.php
      Connection/
        DaemonConnectionException.php
      Server/
        FileSizeTooLargeException.php
        FileTypeNotEditableException.php
        ServerStateConflictException.php
      HttpForbiddenException.php
      TwoFactorAuthRequiredException.php
    Model/
      DataValidationException.php
    Repository/
      Daemon/
        InvalidPowerSignalException.php
      DuplicateDatabaseNameException.php
      RecordNotFoundException.php
      RepositoryException.php
    Service/
      Allocation/
        AllocationDoesNotBelongToServerException.php
        AutoAllocationNotEnabledException.php
        CidrOutOfRangeException.php
        InvalidPortMappingException.php
        NoAutoAllocationSpaceAvailableException.php
        PortOutOfRangeException.php
        ServerUsingAllocationException.php
        TooManyPortsInRangeException.php
      Backup/
        BackupLockedException.php
        TooManyBackupsException.php
      Database/
        DatabaseClientFeatureNotEnabledException.php
        NoSuitableDatabaseHostException.php
        TooManyDatabasesException.php
      Deployment/
        NoViableAllocationException.php
        NoViableNodeException.php
      Egg/
        Variable/
          BadValidationRuleException.php
          ReservedVariableNameException.php
        BadJsonFormatException.php
        HasChildrenException.php
        InvalidCopyFromException.php
        NoParentConfigurationFoundException.php
      Helper/
        CdnVersionFetchingException.php
      Location/
        HasActiveNodesException.php
      Node/
        ConfigurationNotPersistedException.php
      Schedule/
        Task/
          TaskIntervalTooLongException.php
      Server/
        RequiredVariableMissingException.php
      Subuser/
        ServerSubuserExistsException.php
        UserIsServerOwnerException.php
      User/
        TwoFactorAuthenticationTokenInvalid.php
      HasActiveServersException.php
      InvalidFileUploadException.php
      ServiceLimitExceededException.php
    Solutions/
      ManifestDoesNotExistSolution.php
    Transformer/
      InvalidTransformerLevelException.php
    AccountNotFoundException.php
    AutoDeploymentException.php
    DisplayException.php
    Handler.php
    JexactylException.php
    ManifestDoesNotExistException.php
  Extensions/
    Backups/
      BackupManager.php
    Facades/
      Theme.php
    Filesystem/
      S3Filesystem.php
    Illuminate/
      Database/
        Eloquent/
          Builder.php
      Events/
        Contracts/
          SubscribesToEvents.php
    Laravel/
      Sanctum/
        NewAccessToken.php
    Lcobucci/
      JWT/
        Encoding/
          TimestampDates.php
    League/
      Fractal/
        Serializers/
          JexactylSerializer.php
    Spatie/
      Fractalistic/
        Fractal.php
    Themes/
      Theme.php
    DynamicDatabaseConnection.php
    Hashids.php
  Facades/
    Activity.php
    LogBatch.php
    LogTarget.php
  Helpers/
    Time.php
    Utilities.php
  Http/
    Controllers/
      Admin/
        Jexactyl/
          AdvancedController.php
          AlertsController.php
          AppearanceController.php
          ApprovalsController.php
          CouponsController.php
          IndexController.php
          MailController.php
          ReferralsController.php
          RegistrationController.php
          ServerController.php
          StoreController.php
          UpgradeController.php
        Nests/
          EggController.php
          EggScriptController.php
          EggShareController.php
          EggVariableController.php
          NestController.php
        Nodes/
          NodeController.php
          NodeViewController.php
          SystemInformationController.php
        Servers/
          CreateServerController.php
          ServerController.php
          ServerTransferController.php
          ServerViewController.php
        Users/
          ResourceController.php
          UserController.php
        ApiController.php
        DatabaseController.php
        LocationController.php
        MountController.php
        NodeAutoDeployController.php
        NodesController.php
        ServersController.php
        TicketsController.php
      Api/
        Application/
          Locations/
            LocationController.php
          Nests/
            EggController.php
            NestController.php
          Nodes/
            AllocationController.php
            NodeConfigurationController.php
            NodeController.php
            NodeDeploymentController.php
          Servers/
            DatabaseController.php
            ExternalServerController.php
            ServerController.php
            ServerDetailsController.php
            ServerManagementController.php
            StartupController.php
          Users/
            ExternalUserController.php
            UserController.php
            UserResourcesController.php
          ApplicationApiController.php
          ApprovalsController.php
        Client/
          Servers/
            ActivityLogController.php
            AnalyticsController.php
            BackupController.php
            CommandController.php
            DatabaseController.php
            EditController.php
            FileController.php
            FileUploadController.php
            NetworkAllocationController.php
            PluginController.php
            PowerController.php
            RenewalController.php
            ResourceUtilizationController.php
            ScheduleController.php
            ScheduleTaskController.php
            ServerController.php
            SettingsController.php
            StartupController.php
            SubuserController.php
            WebsocketController.php
          Store/
            PayPalController.php
            ResourceController.php
            RobuxController.php
            ServerController.php
            StripeController.php
          AccountController.php
          ActivityLogController.php
          ApiKeyController.php
          ClientApiController.php
          ClientController.php
          DiscordController.php
          ReferralsController.php
          SSHKeyController.php
          TicketController.php
          TwoFactorController.php
        Remote/
          Backups/
            BackupRemoteUploadController.php
            BackupStatusController.php
          Servers/
            ServerDetailsController.php
            ServerInstallController.php
            ServerTransferController.php
          ActivityProcessingController.php
          EggInstallController.php
          SftpAuthenticationController.php
        RobloxWebhookController.php
      Auth/
        AbstractLoginController.php
        DiscordController.php
        ForgotPasswordController.php
        GoogleController.php
        LoginCheckpointController.php
        LoginController.php
        RegisterController.php
        ResetPasswordController.php
        VerifyAccountController.php
      Base/
        IndexController.php
        LocaleController.php
        StripeController.php
      Controller.php
    Middleware/
      Activity/
        AccountSubject.php
        ServerSubject.php
        TrackAPIKey.php
      Admin/
        Servers/
          ServerInstalled.php
      Api/
        Application/
          AuthenticateApplicationUser.php
        Client/
          Server/
            AuthenticateServerAccess.php
            ResourceBelongsToServer.php
          RequireClientApiKey.php
          SubstituteClientBindings.php
        Daemon/
          DaemonAuthenticate.php
        AuthenticateIPAccess.php
        IsValidJson.php
      AdminAuthenticate.php
      EncryptCookies.php
      EnsureStatefulRequests.php
      LanguageMiddleware.php
      MaintenanceMiddleware.php
      RedirectIfAuthenticated.php
      RequireTwoFactorAuthentication.php
      TrimStrings.php
      VerifyCsrfToken.php
      VerifyReCaptcha.php
    Requests/
      Admin/
        Api/
          StoreApplicationApiKeyRequest.php
        Egg/
          EggFormRequest.php
          EggImportFormRequest.php
          EggScriptFormRequest.php
          EggVariableFormRequest.php
        Jexactyl/
          Coupons/
            IndexFormRequest.php
            StoreFormRequest.php
          AdvancedFormRequest.php
          AlertFormRequest.php
          AppearanceFormRequest.php
          ApprovalFormRequest.php
          MailFormRequest.php
          ReferralsFormRequest.php
          RegistrationFormRequest.php
          ServerFormRequest.php
          StoreFormRequest.php
        Nest/
          StoreNestFormRequest.php
        Node/
          AllocationAliasFormRequest.php
          AllocationFormRequest.php
          NodeFormRequest.php
        Servers/
          Databases/
            StoreServerDatabaseRequest.php
        Tickets/
          TicketMessageRequest.php
          TicketStatusRequest.php
          TicketToggleRequest.php
        Users/
          ResourceFormRequest.php
          UserFormRequest.php
        AdminFormRequest.php
        BaseFormRequest.php
        DatabaseHostFormRequest.php
        LocationFormRequest.php
        MountFormRequest.php
        NewUserFormRequest.php
        ServerFormRequest.php
      Api/
        Application/
          Allocations/
            DeleteAllocationRequest.php
            GetAllocationsRequest.php
            StoreAllocationRequest.php
          Locations/
            DeleteLocationRequest.php
            GetLocationRequest.php
            GetLocationsRequest.php
            StoreLocationRequest.php
            UpdateLocationRequest.php
          Nests/
            Eggs/
              GetEggRequest.php
              GetEggsRequest.php
            GetNestsRequest.php
          Nodes/
            DeleteNodeRequest.php
            GetDeployableNodesRequest.php
            GetNodeRequest.php
            GetNodesRequest.php
            StoreNodeRequest.php
            UpdateNodeRequest.php
          Servers/
            Databases/
              GetServerDatabaseRequest.php
              GetServerDatabasesRequest.php
              ServerDatabaseWriteRequest.php
              StoreServerDatabaseRequest.php
            GetExternalServerRequest.php
            GetServerRequest.php
            GetServersRequest.php
            ServerWriteRequest.php
            StoreServerRequest.php
            UpdateServerBuildConfigurationRequest.php
            UpdateServerDetailsRequest.php
            UpdateServerStartupRequest.php
          Users/
            DeleteUserRequest.php
            GetExternalUserRequest.php
            GetUsersRequest.php
            StoreUserRequest.php
            UpdateUserRequest.php
          ApplicationApiRequest.php
        Client/
          Account/
            StoreApiKeyRequest.php
            StoreSSHKeyRequest.php
            UpdateEmailRequest.php
            UpdatePasswordRequest.php
            UpdateUsernameRequest.php
          Servers/
            Backups/
              StoreBackupRequest.php
            Databases/
              DeleteDatabaseRequest.php
              GetDatabasesRequest.php
              RotatePasswordRequest.php
              StoreDatabaseRequest.php
            Files/
              ChmodFilesRequest.php
              CompressFilesRequest.php
              CopyFileRequest.php
              CreateFolderRequest.php
              DecompressFilesRequest.php
              DeleteFileRequest.php
              DownloadFileRequest.php
              GetFileContentsRequest.php
              ListFilesRequest.php
              PullFileRequest.php
              RenameFileRequest.php
              UploadFileRequest.php
              WriteFileContentRequest.php
            Network/
              DeleteAllocationRequest.php
              GetNetworkRequest.php
              NewAllocationRequest.php
              SetPrimaryAllocationRequest.php
              UpdateAllocationRequest.php
            Schedules/
              DeleteScheduleRequest.php
              StoreScheduleRequest.php
              StoreTaskRequest.php
              TriggerScheduleRequest.php
              UpdateScheduleRequest.php
              ViewScheduleRequest.php
            Settings/
              ReinstallServerRequest.php
              RenameServerRequest.php
              SetDockerImageRequest.php
            Startup/
              GetStartupRequest.php
              UpdateStartupVariableRequest.php
            Subusers/
              DeleteSubuserRequest.php
              GetSubuserRequest.php
              StoreSubuserRequest.php
              SubuserRequest.php
              UpdateSubuserRequest.php
            DeleteServerRequest.php
            EditServerRequest.php
            GetServerRequest.php
            SendCommandRequest.php
            SendPowerRequest.php
            ShareConsoleRequest.php
            UpdateBackgroundRequest.php
          Store/
            Gateways/
              PayPalRequest.php
              StripeRequest.php
            CreateServerRequest.php
            PurchaseResourceRequest.php
          ClientApiRequest.php
          GetServersRequest.php
        Remote/
          ActivityEventRequest.php
          AuthenticateWebsocketDetailsRequest.php
          InstallationDataRequest.php
          ReportBackupCompleteRequest.php
          SftpAuthenticationFormRequest.php
      Auth/
        LoginCheckpointRequest.php
        LoginRequest.php
        RegisterRequest.php
        ResetPasswordRequest.php
      FrontendUserFormRequest.php
      LocaleRequest.php
    Resources/
      Wings/
        ServerConfigurationCollection.php
    ViewComposers/
      Composer.php
      SettingComposer.php
      StoreComposer.php
    Kernel.php
  Jobs/
    Schedule/
      RunTaskJob.php
    Job.php
  Listeners/
    Auth/
      AuthenticationListener.php
      PasswordResetListener.php
      TwoFactorListener.php
  Models/
    Filters/
      AdminServerFilter.php
      MultiFieldServerFilter.php
    Objects/
      DeploymentObject.php
    Traits/
      HasAccessTokens.php
    ActivityLog.php
    ActivityLogSubject.php
    Allocation.php
    AnalyticsData.php
    AnalyticsMessage.php
    ApiKey.php
    APILog.php
    Backup.php
    Coupon.php
    Database.php
    DatabaseHost.php
    Egg.php
    EggMount.php
    EggVariable.php
    Location.php
    Model.php
    Mount.php
    MountNode.php
    MountServer.php
    Nest.php
    Node.php
    Permission.php
    RecoveryToken.php
    ReferralCode.php
    ReferralUses.php
    RobuxPurchase.php
    Schedule.php
    Server.php
    ServerTransfer.php
    ServerVariable.php
    Session.php
    Setting.php
    Subuser.php
    Task.php
    TaskLog.php
    Ticket.php
    TicketMessage.php
    User.php
    UserSSHKey.php
  Notifications/
    AccountCreated.php
    AddedToServer.php
    MailTested.php
    RemovedFromServer.php
    SendPasswordReset.php
    ServerInstalled.php
    VerifyEmail.php
  Observers/
    EggVariableObserver.php
    ServerObserver.php
    SubuserObserver.php
    UserObserver.php
  Policies/
    .gitkeep
    ServerPolicy.php
  Providers/
    ActivityLogServiceProvider.php
    AppServiceProvider.php
    AuthServiceProvider.php
    BackupsServiceProvider.php
    BladeServiceProvider.php
    BroadcastServiceProvider.php
    EventServiceProvider.php
    HashidsServiceProvider.php
    RepositoryServiceProvider.php
    RouteServiceProvider.php
    SettingsServiceProvider.php
    ViewComposerServiceProvider.php
  Repositories/
    Eloquent/
      AllocationRepository.php
      ApiKeyRepository.php
      BackupRepository.php
      DatabaseHostRepository.php
      DatabaseRepository.php
      EggRepository.php
      EggVariableRepository.php
      EloquentRepository.php
      LocationRepository.php
      MountRepository.php
      NestRepository.php
      NodeRepository.php
      PermissionRepository.php
      RecoveryTokenRepository.php
      ScheduleRepository.php
      ServerRepository.php
      ServerVariableRepository.php
      SessionRepository.php
      SettingsRepository.php
      SubuserRepository.php
      TaskRepository.php
      UserRepository.php
    Wings/
      DaemonBackupRepository.php
      DaemonCommandRepository.php
      DaemonConfigurationRepository.php
      DaemonFileRepository.php
      DaemonPowerRepository.php
      DaemonRepository.php
      DaemonServerRepository.php
      DaemonTransferRepository.php
    Repository.php
  Rules/
    Fqdn.php
    Username.php
  Services/
    Acl/
      Api/
        AdminAcl.php
    Activity/
      ActivityLogBatchService.php
      ActivityLogService.php
      ActivityLogTargetableService.php
    Allocations/
      AllocationDeletionService.php
      AssignmentService.php
      FindAssignableAllocationService.php
    Analytics/
      AnalyticsReviewService.php
    Api/
      KeyCreationService.php
    Backups/
      DeleteBackupService.php
      DownloadLinkService.php
      InitiateBackupService.php
    Databases/
      Hosts/
        HostCreationService.php
        HostDeletionService.php
        HostUpdateService.php
      DatabaseManagementService.php
      DatabasePasswordService.php
      DeployServerDatabaseService.php
    Deployment/
      AllocationSelectionService.php
      FindViableNodesService.php
    Eggs/
      Scripts/
        InstallScriptService.php
      Sharing/
        EggExporterService.php
        EggImporterService.php
        EggUpdateImporterService.php
      Variables/
        VariableCreationService.php
        VariableUpdateService.php
      EggConfigurationService.php
      EggCreationService.php
      EggDeletionService.php
      EggParserService.php
      EggUpdateService.php
    Helpers/
      AssetHashService.php
      SoftwareVersionService.php
    Locations/
      LocationCreationService.php
      LocationDeletionService.php
      LocationUpdateService.php
    Nests/
      NestCreationService.php
      NestDeletionService.php
      NestUpdateService.php
    Nodes/
      NodeCreationService.php
      NodeDeletionService.php
      NodeJWTService.php
      NodeUpdateService.php
    Referrals/
      UseReferralService.php
    Schedules/
      ProcessScheduleService.php
    Servers/
      BuildModificationService.php
      DetailsModificationService.php
      EnvironmentService.php
      GetUserPermissionsService.php
      ReinstallServerService.php
      ServerConfigurationStructureService.php
      ServerCreationService.php
      ServerDeletionService.php
      ServerEditService.php
      ServerRenewalService.php
      StartupCommandService.php
      StartupModificationService.php
      SuspensionService.php
      VariableValidatorService.php
    Store/
      ResourcePurchaseService.php
      StoreCreationService.php
      StoreVerificationService.php
    Subusers/
      SubuserCreationService.php
    Users/
      ToggleTwoFactorService.php
      TwoFactorSetupService.php
      UserCreationService.php
      UserDeletionService.php
      UserUpdateService.php
  Traits/
    Commands/
      EnvironmentWriterTrait.php
    Controllers/
      JavascriptInjection.php
      PlainJavascriptInjection.php
    Helpers/
      AvailableLanguages.php
    Services/
      HasUserLevels.php
      ReturnsUpdatedModels.php
      ValidatesValidationRules.php
  Transformers/
    Api/
      Application/
        AllocationTransformer.php
        BaseTransformer.php
        DatabaseHostTransformer.php
        EggTransformer.php
        EggVariableTransformer.php
        LocationTransformer.php
        NestTransformer.php
        NodeTransformer.php
        ServerDatabaseTransformer.php
        ServerTransformer.php
        ServerVariableTransformer.php
        SubuserTransformer.php
        UserResourcesTransformer.php
        UserTransformer.php
      Client/
        Analytics/
          DataTransformer.php
          MessageTransformer.php
        Referrals/
          ReferralActivityTransformer.php
          ReferralCodeTransformer.php
        Store/
          CostTransformer.php
          EggTransformer.php
          NestTransformer.php
          NodeTransformer.php
          UserTransformer.php
        Tickets/
          TicketMessageTransformer.php
          TicketTransformer.php
        AccountTransformer.php
        ActivityLogTransformer.php
        AllocationTransformer.php
        ApiKeyTransformer.php
        BackupTransformer.php
        BaseClientTransformer.php
        DatabaseTransformer.php
        EggTransformer.php
        EggVariableTransformer.php
        FileObjectTransformer.php
        ScheduleTransformer.php
        ServerTransformer.php
        StatsTransformer.php
        SubuserTransformer.php
        TaskTransformer.php
        UserSSHKeyTransformer.php
        UserTransformer.php
  helpers.php
bootstrap/
  app.php
  tests.php
config/
  egg_features/
    eula.php
  prologue/
    alerts.php
  activity.php
  app.php
  auth.php
  backups.php
  broadcasting.php
  cache.php
  compile.php
  cors.php
  database.php
  filesystems.php
  fractal.php
  gateways.php
  hashids.php
  hashing.php
  http.php
  javascript.php
  jexactyl.php
  logging.php
  mail.php
  queue.php
  recaptcha.php
  sanctum.php
  services.php
  session.php
  store.php
  theme.php
  trustedproxy.php
  view.php
database/
  Factories/
    AllocationFactory.php
    ApiKeyFactory.php
    BackupFactory.php
    DatabaseFactory.php
    DatabaseHostFactory.php
    EggFactory.php
    EggVariableFactory.php
    LocationFactory.php
    NestFactory.php
    NodeFactory.php
    ScheduleFactory.php
    ServerFactory.php
    SubuserFactory.php
    TaskFactory.php
    UserFactory.php
    UserSSHKeyFactory.php
  migrations/
    2016_01_23_195641_add_allocations_table.php
    2016_01_23_195851_add_api_keys.php
    2016_01_23_200044_add_api_permissions.php
    2016_01_23_200159_add_downloads.php
    2016_01_23_200421_create_failed_jobs_table.php
    2016_01_23_200440_create_jobs_table.php
    2016_01_23_200528_add_locations.php
    2016_01_23_200648_add_nodes.php
    2016_01_23_201433_add_password_resets.php
    2016_01_23_201531_add_permissions.php
    2016_01_23_201649_add_server_variables.php
    2016_01_23_201748_add_servers.php
    2016_01_23_202544_add_service_options.php
    2016_01_23_202731_add_service_varibles.php
    2016_01_23_202943_add_services.php
    2016_01_23_203119_create_settings_table.php
    2016_01_23_203150_add_subusers.php
    2016_01_23_203159_add_users.php
    2016_01_23_203947_create_sessions_table.php
    2016_01_25_234418_rename_permissions_column.php
    2016_02_07_172148_add_databases_tables.php
    2016_02_07_181319_add_database_servers_table.php
    2016_02_13_154306_add_service_option_default_startup.php
    2016_02_20_155318_add_unique_service_field.php
    2016_02_27_163411_add_tasks_table.php
    2016_02_27_163447_add_tasks_log_table.php
    2016_03_18_155649_add_nullable_field_lastrun.php
    2016_08_30_212718_add_ip_alias.php
    2016_08_30_213301_modify_ip_storage_method.php
    2016_09_01_193520_add_suspension_for_servers.php
    2016_09_01_211924_remove_active_column.php
    2016_09_02_190647_add_sftp_password_storage.php
    2016_09_04_171338_update_jobs_tables.php
    2016_09_04_172028_update_failed_jobs_table.php
    2016_09_04_182835_create_notifications_table.php
    2016_09_07_163017_add_unique_identifier.php
    2016_09_14_145945_allow_longer_regex_field.php
    2016_09_17_194246_add_docker_image_column.php
    2016_09_21_165554_update_servers_column_name.php
    2016_09_29_213518_rename_double_insurgency.php
    2016_10_07_152117_build_api_log_table.php
    2016_10_14_164802_update_api_keys.php
    2016_10_23_181719_update_misnamed_bungee.php
    2016_10_23_193810_add_foreign_keys_servers.php
    2016_10_23_201624_add_foreign_allocations.php
    2016_10_23_202222_add_foreign_api_keys.php
    2016_10_23_202703_add_foreign_api_permissions.php
    2016_10_23_202953_add_foreign_database_servers.php
    2016_10_23_203105_add_foreign_databases.php
    2016_10_23_203335_add_foreign_nodes.php
    2016_10_23_203522_add_foreign_permissions.php
    2016_10_23_203857_add_foreign_server_variables.php
    2016_10_23_204157_add_foreign_service_options.php
    2016_10_23_204321_add_foreign_service_variables.php
    2016_10_23_204454_add_foreign_subusers.php
    2016_10_23_204610_add_foreign_tasks.php
    2016_11_04_000949_add_ark_service_option_fixed.php
    2016_11_11_220649_add_pack_support.php
    2016_11_11_231731_set_service_name_unique.php
    2016_11_27_142519_add_pack_column.php
    2016_12_01_173018_add_configurable_upload_limit.php
    2016_12_02_185206_correct_service_variables.php
    2017_01_03_150436_fix_misnamed_option_tag.php
    2017_01_07_154228_create_node_configuration_tokens_table.php
    2017_01_12_135449_add_more_user_data.php
    2017_02_02_175548_UpdateColumnNames.php
    2017_02_03_140948_UpdateNodesTable.php
    2017_02_03_155554_RenameColumns.php
    2017_02_05_164123_AdjustColumnNames.php
    2017_02_05_164516_AdjustColumnNamesForServicePacks.php
    2017_02_09_174834_SetupPermissionsPivotTable.php
    2017_02_10_171858_UpdateAPIKeyColumnNames.php
    2017_03_03_224254_UpdateNodeConfigTokensColumns.php
    2017_03_05_212803_DeleteServiceExecutableOption.php
    2017_03_10_162934_AddNewServiceOptionsColumns.php
    2017_03_10_173607_MigrateToNewServiceSystem.php
    2017_03_11_215455_ChangeServiceVariablesValidationRules.php
    2017_03_12_150648_MoveFunctionsFromFileToDatabase.php
    2017_03_14_175631_RenameServicePacksToSingluarPacks.php
    2017_03_14_200326_AddLockedStatusToTable.php
    2017_03_16_181109_ReOrganizeDatabaseServersToDatabaseHost.php
    2017_03_16_181515_CleanupDatabasesDatabase.php
    2017_03_18_204953_AddForeignKeyToPacks.php
    2017_03_31_221948_AddServerDescriptionColumn.php
    2017_04_02_163232_DropDeletedAtColumnFromServers.php
    2017_04_15_125021_UpgradeTaskSystem.php
    2017_04_20_171943_AddScriptsToServiceOptions.php
    2017_04_21_151432_AddServiceScriptTrackingToServers.php
    2017_04_27_145300_AddCopyScriptFromColumn.php
    2017_04_27_223629_AddAbilityToDefineConnectionOverSSLWithDaemonBehindProxy.php
    2017_05_01_141528_DeleteDownloadTable.php
    2017_05_01_141559_DeleteNodeConfigurationTable.php
    2017_06_10_152951_add_external_id_to_users.php
    2017_06_25_133923_ChangeForeignKeyToBeOnCascadeDelete.php
    2017_07_08_152806_ChangeUserPermissionsToDeleteOnUserDeletion.php
    2017_07_08_154416_SetAllocationToReferenceNullOnServerDelete.php
    2017_07_08_154650_CascadeDeletionWhenAServerOrVariableIsDeleted.php
    2017_07_24_194433_DeleteTaskWhenParentServerIsDeleted.php
    2017_08_05_115800_CascadeNullValuesForDatabaseHostWhenNodeIsDeleted.php
    2017_08_05_144104_AllowNegativeValuesForOverallocation.php
    2017_08_05_174811_SetAllocationUnqiueUsingMultipleFields.php
    2017_08_15_214555_CascadeDeletionWhenAParentServiceIsDeleted.php
    2017_08_18_215428_RemovePackWhenParentServiceOptionIsDeleted.php
    2017_09_10_225749_RenameTasksTableForStructureRefactor.php
    2017_09_10_225941_CreateSchedulesTable.php
    2017_09_10_230309_CreateNewTasksTableForSchedules.php
    2017_09_11_002938_TransferOldTasksToNewScheduler.php
    2017_09_13_211810_UpdateOldPermissionsToPointToNewScheduleSystem.php
    2017_09_23_170933_CreateDaemonKeysTable.php
    2017_09_23_173628_RemoveDaemonSecretFromServersTable.php
    2017_09_23_185022_RemoveDaemonSecretFromSubusersTable.php
    2017_10_02_202000_ChangeServicesToUseAMoreUniqueIdentifier.php
    2017_10_02_202007_ChangeToABetterUniqueServiceConfiguration.php
    2017_10_03_233202_CascadeDeletionWhenServiceOptionIsDeleted.php
    2017_10_06_214026_ServicesToNestsConversion.php
    2017_10_06_214053_ServiceOptionsToEggsConversion.php
    2017_10_06_215741_ServiceVariablesToEggVariablesConversion.php
    2017_10_24_222238_RemoveLegacySFTPInformation.php
    2017_11_11_161922_Add2FaLastAuthorizationTimeColumn.php
    2017_11_19_122708_MigratePubPrivFormatToSingleKey.php
    2017_12_04_184012_DropAllocationsWhenNodeIsDeleted.php
    2017_12_12_220426_MigrateSettingsTableToNewFormat.php
    2018_01_01_122821_AllowNegativeValuesForServerSwap.php
    2018_01_11_213943_AddApiKeyPermissionColumns.php
    2018_01_13_142012_SetupTableForKeyEncryption.php
    2018_01_13_145209_AddLastUsedAtColumn.php
    2018_02_04_145617_AllowTextInUserExternalId.php
    2018_02_10_151150_remove_unique_index_on_external_id_column.php
    2018_02_17_134254_ensure_unique_allocation_id_on_servers_table.php
    2018_02_24_112356_add_external_id_column_to_servers_table.php
    2018_02_25_160152_remove_default_null_value_on_table.php
    2018_02_25_160604_define_unique_index_on_users_external_id.php
    2018_03_01_192831_add_database_and_port_limit_columns_to_servers_table.php
    2018_03_15_124536_add_description_to_nodes.php
    2018_05_04_123826_add_maintenance_to_nodes.php
    2018_09_03_143756_allow_egg_variables_to_have_longer_values.php
    2018_09_03_144005_allow_server_variables_to_have_longer_values.php
    2019_03_02_142328_set_allocation_limit_default_null.php
    2019_03_02_151321_fix_unique_index_to_account_for_host.php
    2020_03_22_163911_merge_permissions_table_into_subusers.php
    2020_03_22_164814_drop_permissions_table.php
    2020_04_03_203624_add_threads_column_to_servers_table.php
    2020_04_03_230614_create_backups_table.php
    2020_04_04_131016_add_table_server_transfers.php
    2020_04_10_141024_store_node_tokens_as_encrypted_value.php
    2020_04_17_203438_allow_nullable_descriptions.php
    2020_04_22_055500_add_max_connections_column.php
    2020_04_26_111208_add_backup_limit_to_servers.php
    2020_05_20_234655_add_mounts_table.php
    2020_05_21_192756_add_mount_server_table.php
    2020_07_02_213612_create_user_recovery_tokens_table.php
    2020_07_09_201845_add_notes_column_for_allocations.php
    2020_08_20_205533_add_backup_state_column_to_backups.php
    2020_08_22_132500_update_bytes_to_unsigned_bigint.php
    2020_08_23_175331_modify_checksums_column_for_backups.php
    2020_09_13_110007_drop_packs_from_servers.php
    2020_09_13_110021_drop_packs_from_api_key_permissions.php
    2020_09_13_110047_drop_packs_table.php
    2020_09_13_113503_drop_daemon_key_table.php
    2020_10_10_165437_change_unique_database_name_to_account_for_server.php
    2020_10_26_194904_remove_nullable_from_schedule_name_field.php
    2020_11_02_201014_add_features_column_to_eggs.php
    2020_12_12_102435_support_multiple_docker_images_and_updates.php
    2020_12_14_013707_make_successful_nullable_in_server_transfers.php
    2020_12_17_014330_add_archived_field_to_server_transfers_table.php
    2020_12_24_092449_make_allocation_fields_json.php
    2020_12_26_184914_add_upload_id_column_to_backups_table.php
    2021_01_10_153937_add_file_denylist_to_egg_configs.php
    2021_01_13_013420_add_cron_month.php
    2021_01_17_102401_create_audit_logs_table.php
    2021_01_17_152623_add_generic_server_status_column.php
    2021_01_26_210502_update_file_denylist_to_json.php
    2021_02_23_205021_add_index_for_server_and_action.php
    2021_02_23_212657_make_sftp_port_unsigned_int.php
    2021_03_21_104718_force_cron_month_field_to_have_value_if_missing.php
    2021_05_01_092457_add_continue_on_failure_option_to_tasks.php
    2021_05_01_092523_add_only_run_when_server_online_option_to_schedules.php
    2021_05_03_201016_add_support_for_locking_a_backup.php
    2021_07_12_013420_remove_userinteraction.php
    2021_07_17_211512_create_user_ssh_keys_table.php
    2021_08_03_210600_change_successful_field_to_default_to_false_on_backups_table.php
    2021_08_21_175111_add_foreign_keys_to_mount_node_table.php
    2021_08_21_175118_add_foreign_keys_to_mount_server_table.php
    2021_08_21_180921_add_foreign_keys_to_egg_mount_table.php
    2022_01_25_030847_drop_google_analytics.php
    2022_05_07_165334_migrate_egg_images_array_to_new_format.php
    2022_05_22_113825_add_account_logs_table.php
    2022_05_25_162614_add_store_columns_to_users_table.php
    2022_05_28_135717_create_activity_logs_table.php
    2022_05_29_140349_create_activity_log_actors_table.php
    2022_06_04_173523_add_all_resources_to_users_table.php
    2022_06_12_144516_add_renew_columns_to_servers_table.php
    2022_06_17_223301_add_theme_table.php
    2022_06_18_112822_track_api_key_usage_for_activity_events.php
    2022_06_18_224647_add_paypal_table.php
    2022_06_20_123938_add_ip_to_users_table.php
    2022_06_20_130855_drop_account_logs_table.php
    2022_06_20_131128_drop_audit_logs_table.php
    2022_07_11_230950_add_referral_codes_table.php
    2022_07_12_165032_add_referral_code_to_users_table.php
    2022_07_23_190604_add_discord_id_to_users.php
    2022_08_07_001901_add_bg_to_servers_table.php
    2022_08_10_134436_add_deployable_column_to_nodes_table.php
    2022_08_10_145812_add_approved_to_users_table.php
    2022_08_16_214400_add_force_outgoing_ip_column_to_eggs_table.php
    2022_08_16_230204_add_installed_at_column_to_servers_table.php
    2022_09_04_051735_add_verified_to_users_table.php
    2022_09_05_010352_add_verification_tokens_table.php
    2022_09_13_173359_add_default_server_deletion_key_to_settings_table.php
    2022_10_25_212742_add_private_column_to_nests_table.php
    2022_11_08_215353_make_nest_visibility_required_to_nests_table.php
    2022_11_10_131338_create_referral_uses_table.php
    2022_11_27_231907_create_coupons_table.php
    2022_12_12_213937_update_mail_settings_to_new_format.php
    2022_12_13_190432_create_tickets_table.php
    2022_12_13_192408_create_ticket_messages_table.php
    2023_01_09_163835_create_analytics_messages_table.php
    2023_01_09_163856_create_analytics_data_table.php
    2023_01_23_183911_add_deploy_fee_to_nodes_table.php
    2023_01_24_210051_add_uuid_column_to_failed_jobs_table.php
    2026_01_03_192512_add_google_to_users_table.php
    2026_01_07_154400_createrobuxpurchasestable.php
  Seeders/
    eggs/
      minecraft/
        egg-bungeecord.json
        egg-forge-minecraft.json
        egg-paper.json
        egg-sponge--sponge-vanilla.json
        egg-vanilla-minecraft.json
      rust/
        egg-rust.json
      source-engine/
        egg-ark--survival-evolved.json
        egg-counter--strike--global-offensive.json
        egg-custom-source-engine-game.json
        egg-garrys-mod.json
        egg-insurgency.json
        egg-team-fortress2.json
      voice-servers/
        egg-mumble-server.json
        egg-teamspeak3-server.json
    .gitkeep
    DatabaseSeeder.php
    EggSeeder.php
    NestSeeder.php
  .gitignore
public/
  api/
    status.php
  favicons/
    android-chrome-192x192.png
    android-chrome-512x512.png
    android-icon-144x144.png
    android-icon-192x192.png
    android-icon-36x36.png
    android-icon-48x48.png
    android-icon-72x72.png
    android-icon-96x96.png
    apple-icon-114x114.png
    apple-icon-120x120.png
    apple-icon-144x144.png
    apple-icon-152x152.png
    apple-icon-180x180.png
    apple-icon-57x57.png
    apple-icon-60x60.png
    apple-icon-72x72.png
    apple-icon-76x76.png
    apple-icon-precomposed.png
    apple-icon.png
    apple-touch-icon.png
    browserconfig.xml
    df4b367461890fa5fd0d9339d3c3f9c6.ico.zip
    favicon-16x16.png
    favicon-32x32.png
    favicon-96x96.png
    favicon.ico
    manifest.json
    ms-icon-144x144.png
    ms-icon-150x150.png
    ms-icon-310x310.png
    ms-icon-70x70.png
    mstile-150x150.png
    safari-pinned-tab.svg
  js/
    autocomplete.js
    keyboard.polyfill.js
    laroute.js
  themes/
    blue/
      css/
        blue.css
    dark/
      css/
        dark.css
    default/
      css/
        checkbox.css
      js/
        admin/
          server/
            transfer.js
          functions.js
          new-server.js
          statistics.js
    jexactyl/
      css/
        jexactyl.css
    light/
      css/
        light.css
    minecraft/
      css/
        minecraft.css
    pterodactyl/
      css/
        admin/
          dark-mode-global.css
          dark-mode-servers.css
        checkbox.css
        pterodactyl.css
        terminal.css
      js/
        admin/
          server/
            transfer.js
          functions.js
          new-server.js
        plugins/
          minecraft/
            eula.js
  .gitignore
  .htaccess
  index.php
  logo.png
  robots.txt
resources/
  lang/
    en/
      admin/
        nests.php
        node.php
        server.php
        user.php
      command/
        messages.php
      dashboard/
        account.php
        index.php
      server/
        users.php
      activity.php
      auth.php
      exceptions.php
      pagination.php
      passwords.php
      strings.php
      validation.php
  scripts/
    __mocks__/
      file.ts
    api/
      account/
        activity.ts
        createApiKey.ts
        createReferralCode.ts
        deleteApiKey.ts
        deleteReferralCode.ts
        disableAccountTwoFactor.ts
        discord.ts
        earnCredits.ts
        enableAccountTwoFactor.ts
        getApiKeys.ts
        getLatestActivity.ts
        getReferralActivity.ts
        getReferralCodes.ts
        getTwoFactorTokenData.ts
        redeemCoupon.ts
        ssh-keys.ts
        tickets.ts
        updateAccountEmail.ts
        updateAccountPassword.ts
        updateAccountUsername.ts
        useReferralCode.ts
        verify.ts
      auth/
        discord.ts
        google.ts
        login.ts
        loginCheckpoint.ts
        performPasswordReset.ts
        register.ts
        requestPasswordResetEmail.ts
      definitions/
        user/
          index.ts
          models.d.ts
          transformers.ts
        helpers.ts
        index.d.ts
      server/
        backups/
          createServerBackup.ts
          deleteBackup.ts
          getBackupDownloadUrl.ts
          index.ts
        databases/
          createServerDatabase.ts
          deleteServerDatabase.ts
          getServerDatabases.ts
          rotateDatabasePassword.ts
        files/
          chmodFiles.ts
          compressFiles.ts
          copyFile.ts
          createDirectory.ts
          decompressFiles.ts
          deleteFiles.ts
          getFileContents.ts
          getFileDownloadUrl.ts
          getFileUploadUrl.ts
          loadDirectory.ts
          pullFile.ts
          renameFiles.ts
          saveFileContents.ts
        network/
          createServerAllocation.ts
          deleteServerAllocation.ts
          setPrimaryServerAllocation.ts
          setServerAllocationNotes.ts
        plugins/
          getPlugins.ts
          installPlugin.ts
        schedules/
          createOrUpdateSchedule.ts
          createOrUpdateScheduleTask.ts
          deleteSchedule.ts
          deleteScheduleTask.ts
          getServerSchedule.ts
          getServerSchedules.ts
          triggerScheduleExecution.ts
        users/
          createOrUpdateSubuser.ts
          deleteSubuser.ts
          getServerSubusers.ts
        activity.ts
        analytics.ts
        changeBackground.ts
        deleteServer.ts
        editServer.ts
        getServer.ts
        getServerResourceUsage.ts
        getWebsocketToken.ts
        reinstallServer.ts
        renameServer.ts
        renewServer.ts
        setSelectedDockerImage.ts
        types.d.ts
        updateStartupVariable.ts
      store/
        gateways/
          paypal.ts
          stripe.ts
        createServer.ts
        getCosts.ts
        getEggs.ts
        getNests.ts
        getNodes.ts
        getResources.ts
        purchaseResource.ts
        robux.ts
      swr/
        getServerAllocations.ts
        getServerBackups.ts
        getServerStartup.ts
      getServers.ts
      getSystemPermissions.ts
      http.ts
      interceptors.ts
      transformers.ts
    assets/
      css/
        GlobalStylesheet.ts
      images/
        discord.svg
        divide_square.svg
        not_found.svg
        plus_square.svg
        pterodactyl.svg
        server_error.svg
        server_installing.svg
        server_restore.svg
      tailwind.css
    components/
      auth/
        auth.css
        DiscordContainer.tsx
        DiscordFormContainer.tsx
        ForgotPasswordContainer.tsx
        LoginCheckpointContainer.tsx
        LoginContainer.tsx
        LoginFormContainer.tsx
        RegisterContainer.tsx
        ResetPasswordContainer.tsx
      dashboard/
        activity/
          ActivityLogContainer.tsx
        forms/
          AddReferralCodeForm.tsx
          ConfigureTwoFactorForm.tsx
          CreateApiKeyForm.tsx
          CreateSSHKeyForm.tsx
          DisableTOTPDialog.tsx
          DiscordAccountForm.tsx
          RecoveryTokensDialog.tsx
          SetupTOTPDialog.tsx
          UpdateEmailAddressForm.tsx
          UpdatePasswordForm.tsx
          UpdateUsernameForm.tsx
        search/
          SearchContainer.tsx
          SearchModal.tsx
        ssh/
          AccountSSHContainer.tsx
          CreateSSHKeyForm.tsx
          DeleteSSHKeyButton.tsx
        AccountApiContainer.tsx
        AccountOverviewContainer.tsx
        AccountSecurityContainer.tsx
        ApiKeyModal.tsx
        CouponContainer.tsx
        DashboardContainer.tsx
        ReferralContainer.tsx
        ServerRow.tsx
      elements/
        activity/
          ActivityLogEntry.tsx
          ActivityLogMetaButton.tsx
          style.module.css
        alert/
          Alert.tsx
          index.ts
        button/
          Button.tsx
          index.ts
          style.module.css
          types.ts
        dialog/
          ConfirmationDialog.tsx
          context.ts
          Dialog.tsx
          DialogFooter.tsx
          DialogIcon.tsx
          index.ts
          style.module.css
          types.d.ts
        dropdown/
          Dropdown.tsx
          DropdownButton.tsx
          DropdownItem.tsx
          index.ts
          style.module.css
        inputs/
          Checkbox.tsx
          index.ts
          InputField.tsx
          styles.module.css
        store/
          PurchaseBox.tsx
          ResourceBar.tsx
          StoreBanner.tsx
          StoreError.tsx
        table/
          PaginationFooter.tsx
        tooltip/
          Tooltip.tsx
        transitions/
          FadeTransition.tsx
          index.ts
        AuthenticatedRoute.tsx
        Button.tsx
        Can.tsx
        Checkbox.tsx
        Code.tsx
        CodemirrorEditor.tsx
        ConfirmationModal.tsx
        ContentBox.tsx
        ContentContainer.tsx
        CopyOnClick.tsx
        DropdownMenu.tsx
        ErrorBoundary.tsx
        Fade.tsx
        Field.tsx
        FormikFieldWrapper.tsx
        FormikSwitch.tsx
        GreyRowBox.tsx
        Icon.tsx
        InformationBox.tsx
        InformationContainer.tsx
        Input.tsx
        InputError.tsx
        InputSpinner.tsx
        Label.tsx
        MobileNavigation.tsx
        Modal.tsx
        PageContentBlock.tsx
        Pagination.tsx
        PermissionRoute.tsx
        Portal.tsx
        ProgressBar.tsx
        ScreenBlock.tsx
        Select.tsx
        ServerContentBlock.tsx
        SidePanel.tsx
        Spinner.tsx
        SpinnerOverlay.tsx
        StoreContainer.tsx
        SubNavigation.tsx
        Suspended.tsx
        Switch.tsx
        TitledGreyBox.tsx
        Translate.tsx
      server/
        analytics/
          AnalyticsContainer.tsx
          UsageMetrics.tsx
        backups/
          BackupContainer.tsx
          BackupContextMenu.tsx
          BackupRow.tsx
          CreateBackupButton.tsx
        console/
          chart.ts
          ChartBlock.tsx
          Console.tsx
          ConsoleShareContainer.tsx
          PowerButtons.tsx
          RenewalInfo.tsx
          ServerConsoleContainer.tsx
          ServerDetailsBlock.tsx
          StatBlock.tsx
          StatGraphs.tsx
          style.module.css
        databases/
          CreateDatabaseButton.tsx
          DatabaseRow.tsx
          DatabasesContainer.tsx
          RotatePasswordButton.tsx
        edit/
          EditContainer.tsx
        features/
          eula/
            EulaModalFeature.tsx
          Features.tsx
          GSLTokenModalFeature.tsx
          index.ts
          JavaVersionModalFeature.tsx
          PIDLimitModalFeature.tsx
          SteamDiskSpaceFeature.tsx
        files/
          ChmodFileModal.tsx
          FileDropdownMenu.tsx
          FileEditContainer.tsx
          FileManagerBreadcrumbs.tsx
          FileManagerContainer.tsx
          FileManagerStatus.tsx
          FileNameModal.tsx
          FileObjectRow.tsx
          MassActionsBar.tsx
          NewDirectoryButton.tsx
          PullFileModal.tsx
          RenameFileModal.tsx
          SelectFileCheckbox.tsx
          style.module.css
          UploadButton.tsx
        network/
          AllocationRow.tsx
          DeleteAllocationButton.tsx
          NetworkContainer.tsx
        schedules/
          DeleteScheduleButton.tsx
          EditScheduleModal.tsx
          NewTaskButton.tsx
          RunScheduleButton.tsx
          ScheduleCheatsheetCards.tsx
          ScheduleContainer.tsx
          ScheduleCronRow.tsx
          ScheduleEditContainer.tsx
          ScheduleRow.tsx
          ScheduleTaskRow.tsx
          TaskDetailsModal.tsx
        settings/
          ChangeBackgroundBox.tsx
          DeleteServerBox.tsx
          ReinstallServerBox.tsx
          RenameServerBox.tsx
          SettingsContainer.tsx
        startup/
          StartupContainer.tsx
          VariableBox.tsx
        users/
          AddSubuserButton.tsx
          EditSubuserModal.tsx
          PermissionRow.tsx
          PermissionTitleBox.tsx
          RemoveSubuserButton.tsx
          SelectAllPermissions.tsx
          UserRow.tsx
          UsersContainer.tsx
        ConflictStateRenderer.tsx
        events.ts
        ExternalConsole.tsx
        InstallListener.tsx
        PluginContainer.tsx
        ServerActivityLogContainer.tsx
        ServerConfigurationBlock.tsx
        TransferListener.tsx
        UptimeDuration.tsx
        WebsocketHandler.tsx
      store/
        forms/
          PaypalPurchaseForm.tsx
          RobuxPurchaseForm.tsx
          StripePurchaseForm.tsx
        CreateContainer.tsx
        OverviewContainer.tsx
        PurchaseContainer.tsx
        ResourcesContainer.tsx
      tickets/
        forms/
          NewMessageDialog.tsx
          NewTicketDialog.tsx
        OverviewContainer.tsx
        ViewContainer.tsx
      App.tsx
      Avatar.tsx
      FlashMessageRender.tsx
      history.ts
      MessageBox.tsx
      NavigationBar.tsx
      types.ts
    context/
      ModalContext.ts
    hoc/
      asDialog.tsx
      asModal.tsx
      RequireServerPermission.tsx
    lib/
      formatters.spec.ts
      formatters.ts
      helpers.spec.ts
      helpers.ts
      objects.spec.ts
      objects.ts
      strings.spec.ts
      strings.ts
    plugins/
      useDeepCompareEffect.ts
      useDeepCompareMemo.ts
      useDeepMemoize.ts
      useEventListener.ts
      useFileManagerSwr.ts
      useFilteredObject.ts
      useFlash.ts
      useLocationHash.ts
      usePermissions.ts
      usePersistedState.ts
      useSWRKey.ts
      useWebsocketEvent.ts
      useWindowDimensions.ts
      Websocket.ts
      XtermScrollDownHelperAddon.ts
    routers/
      AuthenticationRouter.tsx
      DashboardRouter.tsx
      IndexRouter.tsx
      routes.ts
      ServerRouter.tsx
      StoreRouter.tsx
      TicketRouter.tsx
    state/
      server/
        databases.ts
        files.ts
        index.ts
        schedules.ts
        socket.ts
        subusers.ts
      flashes.ts
      hooks.ts
      index.ts
      permissions.ts
      progress.ts
      settings.ts
      storefront.ts
      user.ts
    easy-peasy.d.ts
    globals.d.ts
    helpers.ts
    i18n.ts
    index.tsx
    macros.d.ts
    modes.ts
    scan-server.js
    setup-tests.ts
    theme.ts
    TransitionRouter.tsx
  ts/
    utils/
      FileScanner.ts
  views/
    admin/
      api/
        index.blade.php
        new.blade.php
      databases/
        index.blade.php
        view.blade.php
      eggs/
        new.blade.php
        scripts.blade.php
        variables.blade.php
        view.blade.php
      jexactyl/
        advanced.blade.php
        alerts.blade.php
        appearance.blade.php
        approvals.blade.php
        coupons.blade.php
        index.blade.php
        mail.blade.php
        referrals.blade.php
        registration.blade.php
        server.blade.php
        store.blade.php
        upgrade.blade.php
      locations/
        index.blade.php
        view.blade.php
      mounts/
        index.blade.php
        view.blade.php
      nests/
        index.blade.php
        new.blade.php
        view.blade.php
      nodes/
        view/
          allocation.blade.php
          configuration.blade.php
          index.blade.php
          servers.blade.php
          settings.blade.php
        index.blade.php
        new.blade.php
      servers/
        partials/
          navigation.blade.php
        view/
          build.blade.php
          database.blade.php
          delete.blade.php
          details.blade.php
          index.blade.php
          manage.blade.php
          mounts.blade.php
          startup.blade.php
        index.blade.php
        new.blade.php
      settings/
        advanced.blade.php
        index.blade.php
        mail.blade.php
      tickets/
        index.blade.php
        view.blade.php
      users/
        index.blade.php
        new.blade.php
        resources.blade.php
        view.blade.php
      index.blade.php
    errors/
      401.blade.php
      402.blade.php
      403.blade.php
      404.blade.php
      419.blade.php
      429.blade.php
      500.blade.php
      503.blade.php
      layout.blade.php
      minimal.blade.php
    layouts/
      admin.blade.php
      scripts.blade.php
    partials/
      admin/
        jexactyl/
          nav.blade.php
        settings/
          nav.blade.php
          notice.blade.php
        users/
          nav.blade.php
      schedules/
        task-template.blade.php
    templates/
      auth/
        core.blade.php
      base/
        core.blade.php
      wrapper.blade.php
routes/
  admin.php
  api-application.php
  api-client.php
  api-remote.php
  auth.php
  base.php
storage/
  app/
    .gitignore
  clockwork/
    .gitignore
  debugbar/
    .gitignore
.editorconfig
.eslintignore
.eslintrc.js
.gitignore
.prettierrc.json
artisan
babel.config.js
build-log.txt
BUILDING.md
CHANGELOG.md
check-robux-purchases.sh
composer.json
docker-compose.example.yml
Dockerfile
favicon_generator.py
jest.config.js
jexactyl_database.sql
LICENSE
package.json
panel.tar.gz
postcss.config.js
README.md
SECURITY.md
tailwind.config.js
tsconfig.json
webpack.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/Models/RobuxPurchase.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\Model;

class RobuxPurchase extends Model
{
    protected $fillable = [
        'user_id',
        'roblox_username',
        'roblox_user_id',
        'gamepass_id',
        'credits',
        'robux_amount',
        'status',
        'completed_at',
        'error_message',
        'check_attempts',
    ];

    protected $casts = [
        'completed_at' => 'datetime',
        'check_attempts' => 'integer',
    ];

    public function user()
    {
        return $this->belongsTo(User::class);
    }

    public function isPending()
    {
        return $this->status === 'pending';
    }

    public function markCompleted()
    {
        $this->update([
            'status' => 'completed',
            'completed_at' => now(),
        ]);
    }

    public function markFailed($message)
    {
        $this->update([
            'status' => 'failed',
            'error_message' => $message,
        ]);
    }

    public function incrementCheckAttempts()
    {
        $this->increment('check_attempts');
    }
}
</file>

<file path="public/api/status.php">
<?php
/**
 * BetterStack Status API Proxy
 * Place this file in: /var/www/jexactyl/public/api/status.php
 */

header('Content-Type: application/json');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET');

// Your BetterStack API token
$apiToken = 'GezDNGwHktAdcqBrEYLd6GwA';

// First, we need to get your status page ID
// You can find it by visiting: https://uptime.betterstack.com/api/v2/status-pages
// with your API token

// For now, let's fetch all status pages and use the first one
$ch = curl_init();

// Fetch all status pages
curl_setopt($ch, CURLOPT_URL, 'https://uptime.betterstack.com/api/v2/status-pages');
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, [
    'Authorization: Bearer ' . $apiToken,
    'Content-Type: application/json'
]);

$response = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);

if ($httpCode !== 200) {
    http_response_code(500);
    echo json_encode([
        'status' => 'operational',
        'error' => 'Failed to fetch status',
        'fallback' => true
    ]);
    curl_close($ch);
    exit;
}

$data = json_decode($response, true);

// Check if we got data
if (!isset($data['data']) || empty($data['data'])) {
    http_response_code(500);
    echo json_encode([
        'status' => 'operational',
        'error' => 'No status pages found',
        'fallback' => true
    ]);
    curl_close($ch);
    exit;
}

// Get the first status page's aggregate state
$statusPage = $data['data'][0];
$aggregateState = $statusPage['attributes']['aggregate_state'] ?? 'operational';

curl_close($ch);

// Return the status
echo json_encode([
    'status' => $aggregateState,
    'page_id' => $statusPage['id'],
    'company_name' => $statusPage['attributes']['company_name'] ?? 'Unknown',
    'fallback' => false
]);
</file>

<file path="public/themes/pterodactyl/css/admin/dark-mode-global.css">
/* ===================================
   JEXACTYL ADMIN DARK MODE - GLOBAL STYLES
   =================================== */

:root {
    /* Dark Theme Colors */
    --dark-bg-primary: #0f0f0f;
    --dark-bg-secondary: #1a1a1a;
    --dark-bg-tertiary: #242424;
    --dark-bg-elevated: #2d2d2d;
    
    --dark-text-primary: #ffffff;
    --dark-text-secondary: #a0a0a0;
    --dark-text-muted: #707070;
    
    --dark-border: #333333;
    --dark-border-light: #404040;
    
    /* Brand Colors */
    --primary: #3b82f6;
    --primary-hover: #2563eb;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #06b6d4;
    
    /* Accent Colors */
    --accent-purple: #8b5cf6;
    --accent-orange: #f97316;
    
    /* Shadows */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
}

/* ===================================
   BASE STYLES
   =================================== */

body {
    background-color: var(--dark-bg-primary);
    color: var(--dark-text-primary);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

.content-wrapper {
    background-color: var(--dark-bg-primary);
    min-height: 100vh;
}

/* ===================================
   HEADER / NAVBAR
   =================================== */

.main-header {
    background: var(--dark-bg-secondary);
    border-bottom: 1px solid var(--dark-border);
}

.main-header .navbar {
    background: var(--dark-bg-secondary);
    margin: 0;
}

.main-header .logo {
    background: var(--dark-bg-primary);
    color: var(--dark-text-primary);
    border-right: 1px solid var(--dark-border);
    font-weight: 600;
}

.main-header .logo:hover {
    background: var(--dark-bg-tertiary);
}

.navbar-nav > li > a {
    color: var(--dark-text-secondary);
}

.navbar-nav > li > a:hover {
    background: var(--dark-bg-tertiary);
    color: var(--dark-text-primary);
}

/* ===================================
   SIDEBAR
   =================================== */

.main-sidebar {
    background: var(--dark-bg-secondary);
    border-right: 1px solid var(--dark-border);
}

.sidebar {
    background: var(--dark-bg-secondary);
    padding-top: 0;
}

.sidebar-menu {
    padding: 8px 0;
}

.sidebar-menu > li {
    border-left: 3px solid transparent;
    transition: all 0.2s ease;
}

.sidebar-menu > li > a {
    color: var(--dark-text-secondary);
    padding: 14px 20px;
    font-size: 14px;
    transition: all 0.2s ease;
}

.sidebar-menu > li > a > .fa,
.sidebar-menu > li > a > .fas,
.sidebar-menu > li > a > .far {
    width: 20px;
    margin-right: 10px;
}

.sidebar-menu > li:hover > a {
    background: var(--dark-bg-tertiary);
    color: var(--dark-text-primary);
}

.sidebar-menu > li.active {
    border-left-color: var(--primary);
    background: var(--dark-bg-tertiary);
}

.sidebar-menu > li.active > a {
    color: var(--dark-text-primary);
    background: transparent;
}

/* ===================================
   BOXES / CARDS
   =================================== */

.box {
    background: var(--dark-bg-secondary);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
}

.box-header {
    background: var(--dark-bg-secondary);
    border-bottom: 1px solid var(--dark-border);
    padding: 16px 20px;
    border-radius: 8px 8px 0 0;
}

.box-title {
    color: var(--dark-text-primary);
    font-size: 16px;
    font-weight: 600;
}

.box-body {
    padding: 20px;
    background: var(--dark-bg-secondary);
}

.box-footer {
    background: var(--dark-bg-tertiary);
    border-top: 1px solid var(--dark-border);
    padding: 16px 20px;
    border-radius: 0 0 8px 8px;
}

/* Box Color Variants */
.box-primary .box-header {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border-bottom: none;
}

.box-success .box-header {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border-bottom: none;
}

.box-warning .box-header {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    border-bottom: none;
}

.box-danger .box-header {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    border-bottom: none;
}

.box-info .box-header {
    background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
    color: white;
    border-bottom: none;
}

/* ===================================
   FORMS
   =================================== */

.form-control {
    background-color: var(--dark-bg-primary);
    border: 1px solid var(--dark-border);
    color: var(--dark-text-primary);
    border-radius: 6px;
    padding: 10px 14px;
    transition: all 0.2s ease;
}

.form-control:focus {
    background-color: var(--dark-bg-primary);
    border-color: var(--primary);
    color: var(--dark-text-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-control::placeholder {
    color: var(--dark-text-muted);
}

.form-control:disabled {
    background-color: var(--dark-bg-tertiary);
    color: var(--dark-text-muted);
    cursor: not-allowed;
}

select.form-control {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23a0a0a0' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 16px 12px;
}

textarea.form-control {
    resize: vertical;
    min-height: 100px;
}

.input-group-addon {
    background: var(--dark-bg-tertiary);
    border: 1px solid var(--dark-border);
    color: var(--dark-text-secondary);
    border-radius: 6px;
}

.control-label {
    color: var(--dark-text-primary);
    font-weight: 500;
    margin-bottom: 8px;
}

/* ===================================
   BUTTONS
   =================================== */

.btn {
    border-radius: 6px;
    padding: 8px 16px;
    font-weight: 500;
    transition: all 0.2s ease;
    border: none;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-success:hover {
    background: #059669;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-warning {
    background: var(--warning);
    color: white;
}

.btn-warning:hover {
    background: #d97706;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-default {
    background: var(--dark-bg-tertiary);
    color: var(--dark-text-primary);
    border: 1px solid var(--dark-border);
}

.btn-default:hover {
    background: var(--dark-bg-elevated);
    border-color: var(--dark-border-light);
}

/* ===================================
   TABLES
   =================================== */

.table {
    background: var(--dark-bg-secondary);
    color: var(--dark-text-primary);
}

.table > thead > tr > th {
    background: var(--dark-bg-tertiary);
    color: var(--dark-text-primary);
    border-bottom: 2px solid var(--dark-border);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.5px;
    padding: 14px 12px;
}

.table > tbody > tr > td {
    border-top: 1px solid var(--dark-border);
    padding: 14px 12px;
    vertical-align: middle;
}

.table-hover > tbody > tr:hover {
    background: var(--dark-bg-tertiary);
    cursor: pointer;
}

.table > tbody > tr.active,
.table > tbody > tr.active > td {
    background: var(--dark-bg-elevated);
}

/* ===================================
   ALERTS
   =================================== */

.alert {
    border-radius: 8px;
    border: none;
    padding: 16px 20px;
}

.alert-success {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
    border-left: 4px solid var(--success);
}

.alert-info {
    background: rgba(6, 182, 212, 0.1);
    color: #06b6d4;
    border-left: 4px solid var(--info);
}

.alert-warning {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
    border-left: 4px solid var(--warning);
}

.alert-danger {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border-left: 4px solid var(--danger);
}

/* ===================================
   LABELS / BADGES
   =================================== */

.label {
    border-radius: 4px;
    padding: 4px 10px;
    font-weight: 500;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.label-success {
    background: var(--success);
    color: white;
}

.label-warning {
    background: var(--warning);
    color: white;
}

.label-danger {
    background: var(--danger);
    color: white;
}

.label-primary {
    background: var(--primary);
    color: white;
}

.label-default {
    background: var(--dark-bg-tertiary);
    color: var(--dark-text-secondary);
}

/* ===================================
   BREADCRUMBS
   =================================== */

.breadcrumb {
    background: transparent;
    padding: 12px 0;
    margin-bottom: 20px;
}

.breadcrumb > li {
    color: var(--dark-text-secondary);
}

.breadcrumb > li > a {
    color: var(--primary);
    text-decoration: none;
}

.breadcrumb > li > a:hover {
    color: var(--primary-hover);
}

.breadcrumb > .active {
    color: var(--dark-text-primary);
}

/* ===================================
   MODALS
   =================================== */

.modal-content {
    background: var(--dark-bg-secondary);
    border: 1px solid var(--dark-border);
    border-radius: 12px;
    box-shadow: var(--shadow-lg);
}

.modal-header {
    background: var(--dark-bg-tertiary);
    border-bottom: 1px solid var(--dark-border);
    border-radius: 12px 12px 0 0;
    padding: 20px 24px;
}

.modal-title {
    color: var(--dark-text-primary);
    font-weight: 600;
}

.modal-body {
    padding: 24px;
}

.modal-footer {
    background: var(--dark-bg-tertiary);
    border-top: 1px solid var(--dark-border);
    border-radius: 0 0 12px 12px;
    padding: 16px 24px;
}

.close {
    color: var(--dark-text-secondary);
    opacity: 1;
}

.close:hover {
    color: var(--dark-text-primary);
}

/* ===================================
   PAGINATION
   =================================== */

.pagination > li > a,
.pagination > li > span {
    background: var(--dark-bg-secondary);
    border: 1px solid var(--dark-border);
    color: var(--dark-text-primary);
}

.pagination > li > a:hover {
    background: var(--dark-bg-tertiary);
    border-color: var(--dark-border-light);
}

.pagination > .active > a,
.pagination > .active > span {
    background: var(--primary);
    border-color: var(--primary);
}

/* ===================================
   NAV TABS
   =================================== */

.nav-tabs-custom {
    background: var(--dark-bg-secondary);
    border-radius: 8px;
    box-shadow: var(--shadow-sm);
}

.nav-tabs-custom > .nav-tabs {
    border-bottom: 1px solid var(--dark-border);
}

.nav-tabs-custom > .nav-tabs > li {
    margin-bottom: -1px;
}

.nav-tabs-custom > .nav-tabs > li > a {
    color: var(--dark-text-secondary);
    border-radius: 8px 8px 0 0;
    padding: 12px 20px;
}

.nav-tabs-custom > .nav-tabs > li > a:hover {
    background: var(--dark-bg-tertiary);
    color: var(--dark-text-primary);
}

.nav-tabs-custom > .nav-tabs > li.active > a {
    background: var(--dark-bg-secondary);
    color: var(--primary);
    border: 1px solid var(--dark-border);
    border-bottom-color: transparent;
    border-top: 3px solid var(--primary);
}

/* ===================================
   INFO BOXES / SMALL BOXES
   =================================== */

.info-box {
    background: var(--dark-bg-secondary);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    box-shadow: var(--shadow-sm);
}

.info-box-icon {
    background: var(--dark-bg-tertiary);
    color: var(--primary);
}

.small-box {
    border-radius: 8px;
    box-shadow: var(--shadow-md);
}

.small-box > .inner {
    padding: 16px;
}

.small-box h3 {
    color: white;
}

.small-box p {
    color: rgba(255, 255, 255, 0.8);
}

.small-box .icon {
    color: rgba(255, 255, 255, 0.2);
}

.small-box-footer {
    background: rgba(0, 0, 0, 0.2);
    color: rgba(255, 255, 255, 0.8);
}

/* ===================================
   CODE / PRE
   =================================== */

code {
    background: var(--dark-bg-tertiary);
    color: var(--accent-orange);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.9em;
}

pre {
    background: var(--dark-bg-primary);
    border: 1px solid var(--dark-border);
    color: var(--dark-text-primary);
    border-radius: 6px;
    padding: 16px;
}

/* ===================================
   UTILITIES
   =================================== */

.text-muted {
    color: var(--dark-text-secondary) !important;
}

small.text-muted {
    color: var(--dark-text-muted) !important;
}

.bg-gray {
    background: var(--dark-bg-tertiary) !important;
}

.text-white {
    color: var(--dark-text-primary) !important;
}

/* ===================================
   CONTENT HEADER
   =================================== */

.content-header {
    padding: 24px 15px 12px;
}

.content-header h1 {
    color: var(--dark-text-primary);
    font-weight: 600;
    font-size: 28px;
    margin: 0;
}

.content-header h1 small {
    color: var(--dark-text-secondary);
    font-size: 16px;
    font-weight: 400;
    margin-left: 8px;
}

/* ===================================
   SELECT2 DROPDOWN
   =================================== */

.select2-container--default .select2-selection--single {
    background-color: var(--dark-bg-primary);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    height: 40px;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    color: var(--dark-text-primary);
    line-height: 38px;
}

.select2-dropdown {
    background-color: var(--dark-bg-secondary);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
}

.select2-container--default .select2-results__option {
    color: var(--dark-text-primary);
}

.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: var(--primary);
}

/* ===================================
   CHECKBOX / RADIO
   =================================== */

.checkbox-primary input[type="checkbox"]:checked + label::before,
.radio-primary input[type="radio"]:checked + label::before {
    background-color: var(--primary);
    border-color: var(--primary);
}

/* ===================================
   SCROLLBAR
   =================================== */

::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

::-webkit-scrollbar-track {
    background: var(--dark-bg-primary);
}

::-webkit-scrollbar-thumb {
    background: var(--dark-bg-elevated);
    border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
    background: #404040;
}
</file>

<file path="public/themes/pterodactyl/css/admin/dark-mode-servers.css">
/* ===================================
   ADMIN SERVERS - DARK MODE STYLES
   Based on reference images
   =================================== */

/* ===================================
   SERVER LIST TABLE
   =================================== */

.server-list-wrapper {
    background: var(--dark-bg-secondary);
    border-radius: 8px;
    overflow: hidden;
}

.server-list-table {
    width: 100%;
    background: transparent;
}

.server-list-table thead th {
    background: var(--dark-bg-tertiary);
    color: var(--dark-text-secondary);
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 16px 20px;
    border: none;
}

.server-list-table tbody tr {
    border-bottom: 1px solid var(--dark-border);
    transition: all 0.2s ease;
}

.server-list-table tbody tr:hover {
    background: var(--dark-bg-tertiary);
}

.server-list-table tbody td {
    padding: 16px 20px;
    vertical-align: middle;
    color: var(--dark-text-primary);
}

/* Server Name Column */
.server-name {
    font-weight: 500;
    color: var(--dark-text-primary);
}

.server-name a {
    color: var(--primary);
    text-decoration: none;
    transition: color 0.2s ease;
}

.server-name a:hover {
    color: var(--primary-hover);
}

/* UUID Column */
.server-uuid code {
    background: var(--dark-bg-primary);
    color: var(--accent-orange);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-family: 'Monaco', 'Menlo', monospace;
}

/* Status Labels */
.server-status-label {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-active {
    background: rgba(16, 185, 129, 0.15);
    color: var(--success);
}

.status-suspended {
    background: rgba(245, 158, 11, 0.15);
    color: var(--warning);
}

.status-installing {
    background: rgba(6, 182, 212, 0.15);
    color: var(--info);
}

/* Action Buttons */
.server-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.server-action-btn {
    background: var(--dark-bg-tertiary);
    border: 1px solid var(--dark-border);
    color: var(--dark-text-secondary);
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.server-action-btn:hover {
    background: var(--dark-bg-elevated);
    color: var(--dark-text-primary);
    transform: translateY(-1px);
}

.server-action-btn.btn-manage {
    color: var(--primary);
}

.server-action-btn.btn-console {
    color: var(--success);
}

/* ===================================
   SERVER VIEW / DETAILS
   =================================== */

.server-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.server-info-card {
    background: var(--dark-bg-secondary);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    padding: 20px;
}

.server-info-card h3 {
    color: var(--dark-text-primary);
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--dark-border);
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.info-row:last-child {
    border-bottom: none;
}

.info-label {
    color: var(--dark-text-secondary);
    font-size: 14px;
}

.info-value {
    color: var(--dark-text-primary);
    font-weight: 500;
}

.info-value code {
    background: var(--dark-bg-primary);
    color: var(--accent-orange);
    padding: 4px 8px;
    border-radius: 4px;
}

/* ===================================
   SERVER RESOURCE CARDS
   =================================== */

.resource-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.resource-card {
    background: var(--dark-bg-secondary);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    padding: 20px;
    position: relative;
    overflow: hidden;
}

.resource-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), var(--accent-purple));
}

.resource-card.memory::before {
    background: linear-gradient(90deg, #10b981, #059669);
}

.resource-card.disk::before {
    background: linear-gradient(90deg, #f59e0b, #d97706);
}

.resource-card.cpu::before {
    background: linear-gradient(90deg, #06b6d4, #0891b2);
}

.resource-icon {
    width: 48px;
    height: 48px;
    background: var(--dark-bg-tertiary);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 12px;
    font-size: 24px;
}

.resource-card .resource-icon {
    color: var(--primary);
}

.resource-card.memory .resource-icon {
    color: var(--success);
}

.resource-card.disk .resource-icon {
    color: var(--warning);
}

.resource-card.cpu .resource-icon {
    color: var(--info);
}

.resource-label {
    color: var(--dark-text-secondary);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.resource-value {
    color: var(--dark-text-primary);
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 8px;
}

.resource-progress {
    width: 100%;
    height: 6px;
    background: var(--dark-bg-primary);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 12px;
}

.resource-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--accent-purple));
    transition: width 0.3s ease;
    border-radius: 3px;
}

.resource-card.memory .resource-progress-bar {
    background: linear-gradient(90deg, #10b981, #059669);
}

.resource-card.disk .resource-progress-bar {
    background: linear-gradient(90deg, #f59e0b, #d97706);
}

.resource-card.cpu .resource-progress-bar {
    background: linear-gradient(90deg, #06b6d4, #0891b2);
}

/* ===================================
   SERVER BUILD CONFIGURATION
   =================================== */

.build-config-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.resource-slider-group {
    margin-bottom: 24px;
}

.resource-slider-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.slider-label-text {
    color: var(--dark-text-primary);
    font-weight: 500;
}

.slider-value {
    background: var(--dark-bg-tertiary);
    padding: 4px 12px;
    border-radius: 6px;
    color: var(--primary);
    font-weight: 600;
}

.resource-slider {
    width: 100%;
    height: 8px;
    background: var(--dark-bg-primary);
    border-radius: 4px;
    outline: none;
    -webkit-appearance: none;
}

.resource-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    background: var(--primary);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.resource-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: var(--primary);
    border-radius: 50%;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

/* ===================================
   SERVER ALLOCATION MANAGEMENT
   =================================== */

.allocation-list {
    background: var(--dark-bg-secondary);
    border-radius: 8px;
    overflow: hidden;
}

.allocation-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--dark-border);
}

.allocation-item:last-child {
    border-bottom: none;
}

.allocation-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.allocation-icon {
    width: 40px;
    height: 40px;
    background: var(--dark-bg-tertiary);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
}

.allocation-details {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.allocation-address {
    color: var(--dark-text-primary);
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 14px;
}

.allocation-alias {
    color: var(--dark-text-secondary);
    font-size: 12px;
}

.allocation-actions {
    display: flex;
    gap: 8px;
}

.allocation-badge {
    background: rgba(59, 130, 246, 0.15);
    color: var(--primary);
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
}

.allocation-badge.primary {
    background: rgba(16, 185, 129, 0.15);
    color: var(--success);
}

/* ===================================
   SERVER CREATION / NEW SERVER
   =================================== */

.server-creation-steps {
    display: flex;
    gap: 16px;
    margin-bottom: 32px;
}

.creation-step {
    flex: 1;
    background: var(--dark-bg-secondary);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    padding: 16px;
    text-align: center;
    position: relative;
}

.creation-step.active {
    border-color: var(--primary);
}

.creation-step.completed {
    border-color: var(--success);
}

.step-number {
    width: 32px;
    height: 32px;
    background: var(--dark-bg-tertiary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 12px;
    color: var(--dark-text-secondary);
    font-weight: 600;
}

.creation-step.active .step-number {
    background: var(--primary);
    color: white;
}

.creation-step.completed .step-number {
    background: var(--success);
    color: white;
}

.step-label {
    color: var(--dark-text-secondary);
    font-size: 14px;
}

.creation-step.active .step-label {
    color: var(--dark-text-primary);
}

/* ===================================
   RESPONSIVE ADJUSTMENTS
   =================================== */

@media (max-width: 768px) {
    .server-details-grid,
    .build-config-section {
        grid-template-columns: 1fr;
    }
    
    .resource-cards-grid {
        grid-template-columns: 1fr;
    }
    
    .server-list-table {
        font-size: 12px;
    }
    
    .server-list-table tbody td,
    .server-list-table thead th {
        padding: 12px 16px;
    }
}
</file>

<file path="resources/scripts/api/auth/google.ts">
import http from '@/api/http';

/**
 * Initiates Google OAuth flow
 * Returns the redirect URL to Google's OAuth consent screen
 */
export default (): Promise<string> => {
    return new Promise((resolve, reject) => {
        http.get('/auth/google')
            .then(({ data }) => resolve(data || '/auth/google'))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/components/auth/auth.css">
/* Fix scrollbar issue on auth pages */
body {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
}

/* Ensure full height without scroll */
#root {
    min-height: 100vh;
    overflow-x: hidden;
}

/* Fix any potential margin/padding issues */
* {
    box-sizing: border-box;
}

/* Remove default body margin that causes scrollbar */
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;

}
</file>

<file path="favicon_generator.py">
#!/usr/bin/env python3

from PIL import Image
import os

# Working directory
work_dir = "/var/www/jexactyl/public/favicons"
source_image = os.path.join(work_dir, "Neo-002-Transparent-Sized.png")

# Define all the favicon sizes and names
favicon_configs = [
    # Android Chrome icons
    ("android-chrome-192x192.png", 192),
    ("android-chrome-512x512.png", 512),
    ("android-icon-36x36.png", 36),
    ("android-icon-48x48.png", 48),
    ("android-icon-72x72.png", 72),
    ("android-icon-96x96.png", 96),
    ("android-icon-144x144.png", 144),
    ("android-icon-192x192.png", 192),
    
    # Apple icons
    ("apple-icon-57x57.png", 57),
    ("apple-icon-60x60.png", 60),
    ("apple-icon-72x72.png", 72),
    ("apple-icon-76x76.png", 76),
    ("apple-icon-114x114.png", 114),
    ("apple-icon-120x120.png", 120),
    ("apple-icon-144x144.png", 144),
    ("apple-icon-152x152.png", 152),
    ("apple-icon-180x180.png", 180),
    ("apple-icon-precomposed.png", 180),
    ("apple-icon.png", 180),
    ("apple-touch-icon.png", 180),
    
    # Standard favicons
    ("favicon-16x16.png", 16),
    ("favicon-32x32.png", 32),
    ("favicon-96x96.png", 96),
    
    # MS icons
    ("ms-icon-70x70.png", 70),
    ("ms-icon-144x144.png", 144),
    ("ms-icon-150x150.png", 150),
    ("ms-icon-310x310.png", 310),
    
    # Other
    ("mstile-150x150.png", 150),
]

print(f"Opening source image: {source_image}")
img = Image.open(source_image)

# Convert to RGBA if not already (to preserve transparency)
if img.mode != 'RGBA':
    img = img.convert('RGBA')

# Generate all the different sized icons
for filename, size in favicon_configs:
    print(f"Creating {filename} ({size}x{size})...")
    
    # Resize the image using high-quality Lanczos resampling
    resized_img = img.resize((size, size), Image.Resampling.LANCZOS)
    
    # Save to the favicons folder
    output_path = os.path.join(work_dir, filename)
    resized_img.save(output_path, "PNG")

# Generate the .ico file (favicon.ico with multiple sizes)
print("Creating favicon.ico...")
ico_sizes = [(16, 16), (32, 32), (48, 48)]
ico_images = [img.resize(size, Image.Resampling.LANCZOS) for size in ico_sizes]
ico_path = os.path.join(work_dir, "favicon.ico")
ico_images[0].save(ico_path, format='ICO', sizes=ico_sizes)

print(f"\n All favicons generated successfully!")
print(f"Total files created: {len(favicon_configs) + 1}")
</file>

<file path="jexactyl_database.sql">

</file>

<file path="app/Http/Controllers/Api/Client/Store/RobuxController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Store;

use Jexactyl\Models\User;
use Illuminate\Http\Request;
use Jexactyl\Models\RobuxPurchase;
use Illuminate\Support\Facades\Http;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\Support\Facades\Validator;

class RobuxController extends Controller
{
    // Gamepass configuration
    private const GAMEPASSES = [
        1663798085 => ['credits' => 1000, 'robux' => 500],
        1660180971 => ['credits' => 200, 'robux' => 100],
        1661360602 => ['credits' => 500, 'robux' => 250],
        1661098750 => ['credits' => 100, 'robux' => 50],
    ];

    private const UNIVERSE_ID = 9519660777;

    /**
     * Get Roblox user profile by username
     */
    public function getUserProfile(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'username' => 'required|string|min:3|max:20',
        ]);

        if ($validator->fails()) {
            return response()->json(['error' => $validator->errors()->first()], 422);
        }

        $username = $request->input('username');

        try {
            // Get user ID from username
            $userResponse = Http::post('https://users.roblox.com/v1/usernames/users', [
                'usernames' => [$username],
                'excludeBannedUsers' => true,
            ]);

            if (!$userResponse->successful() || empty($userResponse->json('data'))) {
                return response()->json(['error' => 'Roblox user not found'], 404);
            }

            $userData = $userResponse->json('data')[0];
            $userId = $userData['id'];

            // Get user thumbnail
            $thumbnailResponse = Http::get("https://thumbnails.roblox.com/v1/users/avatar-headshot", [
                'userIds' => $userId,
                'size' => '150x150',
                'format' => 'Png',
            ]);

            $thumbnail = $thumbnailResponse->json('data')[0]['imageUrl'] ?? null;

            // Get user description
            $profileResponse = Http::get("https://users.roblox.com/v1/users/{$userId}");
            $description = $profileResponse->json('description') ?? 'No description';

            return response()->json([
                'id' => $userId,
                'username' => $userData['name'],
                'displayName' => $userData['displayName'],
                'description' => $description,
                'thumbnail' => $thumbnail,
            ]);
        } catch (\Exception $e) {
            return response()->json(['error' => 'Failed to fetch Roblox profile: ' . $e->getMessage()], 500);
        }
    }

    /**
     * Get available gamepass products
     */
    public function getProducts()
    {
        $products = [];
        
        foreach (self::GAMEPASSES as $gamepassId => $config) {
            $products[] = [
                'id' => $gamepassId,
                'credits' => $config['credits'],
                'price' => $config['robux'],
                'product_url' => "https://www.roblox.com/game-pass/{$gamepassId}",
            ];
        }

        return response()->json($products);
    }

    /**
     * Initiate a Robux purchase
     */
    public function initiatePurchase(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'roblox_user_id' => 'required|integer',
            'roblox_username' => 'required|string',
            'gamepass_id' => 'required|integer',
        ]);

        if ($validator->fails()) {
            return response()->json(['error' => $validator->errors()->first()], 422);
        }

        $gamepassId = $request->input('gamepass_id');

        if (!isset(self::GAMEPASSES[$gamepassId])) {
            return response()->json(['error' => 'Invalid gamepass selected'], 422);
        }

        $config = self::GAMEPASSES[$gamepassId];

        // Check if user already has a pending purchase for this gamepass
        $existingPurchase = RobuxPurchase::where('user_id', $request->user()->id)
            ->where('status', 'pending')
            ->where('gamepass_id', $gamepassId)
            ->first();

        if ($existingPurchase) {
            return response()->json([
                'purchase_id' => $existingPurchase->id,
                'product_url' => "https://www.roblox.com/game-pass/{$gamepassId}",
                'message' => 'You already have a pending purchase for this gamepass',
            ]);
        }

        // Create pending purchase
        $purchase = RobuxPurchase::create([
            'user_id' => $request->user()->id,
            'roblox_username' => $request->input('roblox_username'),
            'roblox_user_id' => $request->input('roblox_user_id'),
            'gamepass_id' => $gamepassId,
            'credits' => $config['credits'],
            'robux_amount' => $config['robux'],
            'status' => 'pending',
        ]);

        return response()->json([
            'purchase_id' => $purchase->id,
            'product_url' => "https://www.roblox.com/game-pass/{$gamepassId}",
            'credits' => $config['credits'],
            'robux' => $config['robux'],
        ]);
    }

    /**
     * Check if user owns the gamepass
     */
    public function checkPurchase(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'purchase_id' => 'required|integer',
        ]);

        if ($validator->fails()) {
            return response()->json(['error' => $validator->errors()->first()], 422);
        }

        $purchase = RobuxPurchase::where('id', $request->input('purchase_id'))
            ->where('user_id', $request->user()->id)
            ->first();

        if (!$purchase) {
            return response()->json(['error' => 'Purchase not found'], 404);
        }

        if ($purchase->status === 'completed') {
            return response()->json([
                'success' => true,
                'message' => 'Purchase already completed!',
                'credits_added' => $purchase->credits,
            ]);
        }

        // Check if user owns the gamepass
        $ownsGamepass = $this->checkGamepassOwnership($purchase->roblox_user_id, $purchase->gamepass_id);

        if ($ownsGamepass) {
            // Add credits to user
            $user = $request->user();
            $user->update(['store_balance' => $user->store_balance + $purchase->credits]);

            // Mark purchase as completed
            $purchase->markCompleted();

            return response()->json([
                'success' => true,
                'message' => 'Purchase verified! Credits have been added to your account.',
                'credits_added' => $purchase->credits,
            ]);
        }

        $purchase->incrementCheckAttempts();

        return response()->json([
            'success' => false,
            'message' => 'Purchase not detected yet. Please make sure you have purchased the gamepass.',
        ]);
    }

    /**
     * Check if a Roblox user owns a specific gamepass
     */
    private function checkGamepassOwnership($userId, $gamepassId)
    {
        try {
            // Use Roblox API to check gamepass ownership
            $response = Http::get("https://inventory.roblox.com/v1/users/{$userId}/items/GamePass/{$gamepassId}");

            if (!$response->successful()) {
                return false;
            }

            $data = $response->json('data');
            return !empty($data);
        } catch (\Exception $e) {
            \Log::error('Failed to check gamepass ownership: ' . $e->getMessage());
            return false;
        }
    }

    /**
     * Cancel a pending purchase
     */
    public function cancelPurchase(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'purchase_id' => 'required|integer',
        ]);

        if ($validator->fails()) {
            return response()->json(['error' => $validator->errors()->first()], 422);
        }

        $purchase = RobuxPurchase::where('id', $request->input('purchase_id'))
            ->where('user_id', $request->user()->id)
            ->where('status', 'pending')
            ->first();

        if (!$purchase) {
            return response()->json(['error' => 'Purchase not found or already processed'], 404);
        }

        $purchase->update(['status' => 'cancelled']);

        return response()->json(['success' => true, 'message' => 'Purchase cancelled']);
    }
}
</file>

<file path="app/Http/Controllers/Api/RobloxWebhookController.php">
<?php

namespace Jexactyl\Http\Controllers\Api;

use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Models\RobloxPurchase;
use Jexactyl\Models\User;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class RobloxWebhookController extends Controller
{
    public function handlePurchase(Request $request)
    {
        // Log that the webhook was received (for debugging)
        Log::info('Roblox webhook received', ['request_data' => $request->all()]);

        // 1. Verify the request signature using your shared secret
        $receivedSignature = $request->header('X-Roblox-Signature');
        $webhookSecret = config('services.roblox.webhook_secret', env('ROBLOX_WEBHOOK_SECRET'));
        
        if ($webhookSecret && $receivedSignature) {
            $calculatedSignature = hash_hmac('sha256', $request->getContent(), $webhookSecret);
            if (!hash_equals($calculatedSignature, $receivedSignature)) {
                Log::warning('Roblox webhook: Invalid signature.');
                return response()->json(['error' => 'Invalid signature.'], 401);
            }
        }

        // 2. Validate the incoming data structure
        try {
            $validated = $request->validate([
                'verification.robloxUserId' => 'required|integer',
                'verification.purchaseCode' => 'required|string',
                'verification.productId' => 'required|integer',
                'verification.receiptId' => 'required|string',
                'verification.robloxUsername' => 'required|string',
                'verification.playerThumbnail' => 'nullable|url',
            ]);
        } catch (\Illuminate\Validation\ValidationException $e) {
            Log::warning('Roblox webhook: Validation failed.', ['errors' => $e->errors()]);
            return response()->json(['error' => 'Invalid data format.', 'details' => $e->errors()], 422);
        }

        $data = $validated['verification'];

        // 3. Find the pending purchase using the unique code
        $pendingPurchase = RobloxPurchase::where('unique_code', $data['purchaseCode'])
                                         ->where('status', 'pending')
                                         ->first();

        if (!$pendingPurchase) {
            Log::warning('Roblox webhook: Invalid or expired purchase code.', ['code' => $data['purchaseCode']]);
            return response()->json(['error' => 'Invalid or expired purchase code.'], 404);
        }

        // 4. Verify the Roblox User ID matches
        if ($pendingPurchase->roblox_user_id != $data['robloxUserId']) {
            Log::error('Roblox User ID mismatch for purchase.', [
                'expected' => $pendingPurchase->roblox_user_id,
                'received' => $data['robloxUserId'],
                'code' => $data['purchaseCode']
            ]);
            return response()->json(['error' => 'User ID mismatch. Purchase not authorized.'], 403);
        }

        // 5. Check for duplicate processing using the Roblox Receipt ID
        if (RobloxPurchase::where('receipt_id', $data['receiptId'])->exists()) {
            Log::info('Roblox webhook: Duplicate receipt detected.', ['receipt' => $data['receiptId']]);
            return response()->json(['status' => 'already_processed']);
        }

        // 6. All checks passed! Grant credits.
        $user = User::find($pendingPurchase->user_id);
        if (!$user) {
            Log::error('Roblox webhook: User not found for purchase.', ['user_id' => $pendingPurchase->user_id]);
            return response()->json(['error' => 'User not found.'], 404);
        }

        $user->increment('store_balance', $pendingPurchase->credits);

        // 7. Update the purchase record
        $pendingPurchase->update([
            'status' => 'completed',
            'receipt_id' => $data['receiptId'],
            'completed_at' => now(),
        ]);

        Log::info('Credits granted via Roblox purchase.', [
            'user' => $user->id,
            'credits' => $pendingPurchase->credits,
            'receipt' => $data['receiptId']
        ]);

        return response()->json(['success' => true, 'credits_added' => $pendingPurchase->credits]);
    }
}
</file>

<file path="app/Http/Controllers/Auth/GoogleController.php">
<?php

namespace Jexactyl\Http\Controllers\Auth;

use Jexactyl\Models\User;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Str;
use Laravel\Socialite\Facades\Socialite;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Services\Users\UserCreationService;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;

class GoogleController extends Controller
{
    private SettingsRepositoryInterface $settings;
    private UserCreationService $creationService;

    public function __construct(
        UserCreationService $creationService,
        SettingsRepositoryInterface $settings
    ) {
        $this->creationService = $creationService;
        $this->settings = $settings;
    }

    /**
     * Redirect to Google OAuth
     */
    public function index()
    {
        return Socialite::driver('google')
            ->stateless()
            ->redirect();
    }

    /**
     * Handle Google callback
     */
    public function callback(Request $request)
    {
        try {
            $googleUser = Socialite::driver('google')
                ->stateless()
                ->user();
            
            \Log::info('Google OAuth callback', [
                'email' => $googleUser->getEmail(),
                'name' => $googleUser->getName(),
            ]);
            
            // Check if user exists by google_id or email
            $user = User::where('google_id', $googleUser->getId())
                ->orWhere('email', $googleUser->getEmail())
                ->first();
            
            if ($user) {
                \Log::info('Existing user found', ['user_id' => $user->id]);
                
                // User exists, update google_id if not set
                if (!$user->google_id) {
                    $user->update(['google_id' => $googleUser->getId()]);
                }
                
                Auth::login($user, true);
                return redirect('/');
            }
            
            \Log::info('Creating new user from Google OAuth');
            
            // Create new user using UserCreationService (like Discord does)
            $approved = true;
            if ($this->settings->get('jexactyl::approvals:enabled') == 'true') {
                $approved = false;
            }
            
            $username = $this->generateUniqueUsername($googleUser->getName());
            
            $data = [
                'uuid' => Str::uuid()->toString(),
                'approved' => $approved,
                'email' => $googleUser->getEmail(),
                'username' => $username,
                'google_id' => $googleUser->getId(),
                'name_first' => $this->getFirstName($googleUser->getName()),
                'name_last' => $this->getLastName($googleUser->getName()),
                'password' => $this->genString(),
                'ip' => $request->getClientIp(),
                'store_cpu' => $this->settings->get('jexactyl::registration:cpu', 0),
                'store_memory' => $this->settings->get('jexactyl::registration:memory', 0),
                'store_disk' => $this->settings->get('jexactyl::registration:disk', 0),
                'store_slots' => $this->settings->get('jexactyl::registration:slot', 0),
                'store_ports' => $this->settings->get('jexactyl::registration:port', 0),
                'store_backups' => $this->settings->get('jexactyl::registration:backup', 0),
                'store_databases' => $this->settings->get('jexactyl::registration:database', 0),
            ];
            
            \Log::info('User creation data prepared', ['username' => $username]);
            
            $this->creationService->handle($data);
            
            \Log::info('User created via UserCreationService');
            
            // Find the newly created user and log in
            $user = User::where('google_id', $googleUser->getId())->first();
            
            if (!$user) {
                throw new \Exception('User was created but could not be found');
            }
            
            \Log::info('Logging in user', ['user_id' => $user->id]);
            
            Auth::loginUsingId($user->id, true);
            
            return redirect('/');
            
        } catch (\Exception $e) {
            \Log::error('Google OAuth Error', [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
            ]);
            
            return redirect('/auth/login')
                ->withErrors(['email' => 'Authentication failed: ' . $e->getMessage()]);
        }
    }
    
    private function getFirstName(string $fullName): string
    {
        $parts = explode(' ', $fullName);
        return $parts[0] ?? 'User';
    }
    
    private function getLastName(string $fullName): string
    {
        $parts = explode(' ', $fullName);
        return count($parts) > 1 ? end($parts) : '';
    }
    
    private function generateUniqueUsername(string $name): string
    {
        $baseUsername = strtolower(preg_replace('/[^a-zA-Z0-9]/', '', $name));
        
        if (strlen($baseUsername) < 3) {
            $baseUsername = 'user' . $baseUsername;
        }
        
        $username = $baseUsername;
        $counter = 1;
        
        while (User::where('username', $username)->exists()) {
            $username = $baseUsername . $counter;
            $counter++;
        }
        
        return $username;
    }
    
    private function genString(): string
    {
        $chars = '1234567890ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
        return substr(str_shuffle($chars), 0, 16);
    }
}
</file>

<file path="database/migrations/2026_01_03_192512_add_google_to_users_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->string('google_id')->nullable()->unique()->after('password');
            $table->string('avatar')->nullable()->after('google_id');
        });
    }

    public function down(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn(['google_id', 'avatar']);
        });
    }
};
</file>

<file path="database/migrations/2026_01_07_154400_createrobuxpurchasestable.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateRobuxPurchasesTable extends Migration
{
    public function up()
    {
        Schema::create('robux_purchases', function (Blueprint $table) {
            $table->id();
            $table->unsignedInteger('user_id');
            $table->string('roblox_username');
            $table->bigInteger('roblox_user_id');
            $table->bigInteger('gamepass_id');
            $table->integer('credits');
            $table->integer('robux_amount');
            $table->enum('status', ['pending', 'completed', 'failed', 'cancelled'])->default('pending');
            $table->timestamp('completed_at')->nullable();
            $table->text('error_message')->nullable();
            $table->integer('check_attempts')->default(0);
            $table->timestamps();

            $table->foreign('user_id')->references('id')->on('users')->onDelete('cascade');
            $table->index(['status', 'created_at']);
            $table->index(['roblox_user_id', 'gamepass_id']);
        });
    }

    public function down()
    {
        Schema::dropIfExists('robux_purchases');
    }
}
</file>

<file path="resources/scripts/api/store/robux.ts">
import http from '@/api/http';

export interface RobloxProfile {
    id: number;
    username: string;
    displayName: string;
    description: string;
    thumbnail: string;
}

export interface RobloxProduct {
    id: number;
    credits: number;
    price: number;
    product_url: string;
}

export interface PurchaseResponse {
    purchase_id: number;
    product_url: string;
    credits: number;
    robux: number;
    message?: string;
}

export interface CheckPurchaseResponse {
    success: boolean;
    message: string;
    credits_added?: number;
}

/**
 * Get Roblox user profile by username
 */
export const getRobloxProfile = async (username: string): Promise<RobloxProfile> => {
    const { data } = await http.post('/api/client/store/robux/profile', { username });
    return data;
};

/**
 * Get available Robux products (gamepasses)
 */
export const getRobloxProducts = async (): Promise<RobloxProduct[]> => {
    const { data } = await http.get('/api/client/store/robux/products');
    return data;
};

/**
 * Initiate a Robux purchase
 */
export const initiateRobloxPurchase = async (
    robloxUserId: number,
    robloxUsername: string,
    gamepassId: number
): Promise<PurchaseResponse> => {
    const { data } = await http.post('/api/client/store/robux/purchase', {
        roblox_user_id: robloxUserId,
        roblox_username: robloxUsername,
        gamepass_id: gamepassId,
    });
    return data;
};

/**
 * Check if a purchase has been completed
 */
export const checkRobloxPayment = async (purchaseId: number): Promise<CheckPurchaseResponse> => {
    const { data } = await http.post('/api/client/store/robux/check', {
        purchase_id: purchaseId,
    });
    return data;
};

/**
 * Cancel a pending purchase
 */
export const cancelRobloxPurchase = async (purchaseId: number): Promise<void> => {
    await http.post('/api/client/store/robux/cancel', {
        purchase_id: purchaseId,
    });
};
</file>

<file path="check-robux-purchases.sh">
#!/bin/bash
ARTISAN_PATH="/var/www/jexactyl"
LOG_FILE="/var/www/jexactyl/storage/logs/robux-checker.log"

cd $ARTISAN_PATH

echo "Starting Robux purchase checker at $(date)" >> $LOG_FILE

while true; do
    php artisan robux:check-purchases >> $LOG_FILE 2>&1
    sleep 5
done
</file>

<file path="app/Console/Commands/CheckPendingRobuxPurchases.php">
<?php

namespace Jexactyl\Console\Commands;

use Jexactyl\Models\User;
use Illuminate\Console\Command;
use Jexactyl\Models\RobuxPurchase;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;

class CheckPendingRobuxPurchases extends Command
{
    protected $signature = 'robux:check-purchases';
    protected $description = 'Check pending Robux purchases and verify gamepass ownership';

    public function handle()
    {
        $pendingPurchases = RobuxPurchase::where('status', 'pending')
            ->where('created_at', '>=', now()->subMinutes(15)) // Check purchases from last 15 minutes
            ->get();

        if ($pendingPurchases->isEmpty()) {
            $this->info('No pending purchases to check.');
            return;
        }

        $this->info("Checking {$pendingPurchases->count()} pending purchases...");

        foreach ($pendingPurchases as $purchase) {
            $this->checkPurchase($purchase);
        }

        $this->info('Finished checking pending purchases.');
    }

    private function checkPurchase(RobuxPurchase $purchase)
    {
        $this->info("Checking purchase #{$purchase->id} for user {$purchase->roblox_username}...");

        try {
            // Check if user owns the gamepass
            $ownsGamepass = $this->checkGamepassOwnership($purchase->roblox_user_id, $purchase->gamepass_id);

            if ($ownsGamepass) {
                // Add credits to user
                $user = User::find($purchase->user_id);
                if ($user) {
                    $user->update(['store_balance' => $user->store_balance + $purchase->credits]);
                    $purchase->markCompleted();
                    
                    $this->info(" Purchase #{$purchase->id} completed! Added {$purchase->credits} credits to user #{$user->id}");
                    Log::info("Robux purchase completed: User #{$user->id} received {$purchase->credits} credits");
                } else {
                    $purchase->markFailed('User not found');
                    $this->error(" Purchase #{$purchase->id} failed: User not found");
                }
            } else {
                // Increment check attempts
                $purchase->incrementCheckAttempts();
                $this->info("  Purchase #{$purchase->id} not yet completed (attempt #{$purchase->check_attempts})");

                // Auto-fail after 15 minutes (180 attempts at 5 seconds each)
                if ($purchase->check_attempts >= 180) {
                    $purchase->markFailed('Purchase verification timed out after 15 minutes');
                    $this->warn("  Purchase #{$purchase->id} timed out after 15 minutes");
                }
            }
        } catch (\Exception $e) {
            $this->error(" Error checking purchase #{$purchase->id}: {$e->getMessage()}");
            Log::error("Error checking Robux purchase #{$purchase->id}: {$e->getMessage()}");
            
            $purchase->incrementCheckAttempts();
        }
    }

    private function checkGamepassOwnership($userId, $gamepassId)
    {
        try {
            // Use Roblox inventory API to check gamepass ownership
            $response = Http::get("https://inventory.roblox.com/v1/users/{$userId}/items/GamePass/{$gamepassId}");

            if (!$response->successful()) {
                return false;
            }

            $data = $response->json('data');
            
            // If data array is not empty, user owns the gamepass
            return !empty($data);
        } catch (\Exception $e) {
            Log::error("Failed to check gamepass ownership for user {$userId}, gamepass {$gamepassId}: {$e->getMessage()}");
            return false;
        }
    }
}
</file>

<file path="resources/scripts/components/store/forms/RobuxPurchaseForm.tsx">
import tw from 'twin.macro';
import React, { useState, useEffect } from 'react';
import useFlash from '@/plugins/useFlash';
import { Dialog } from '@/components/elements/dialog';
import { Button } from '@/components/elements/button/index';
import TitledGreyBox from '@/components/elements/TitledGreyBox';
import FlashMessageRender from '@/components/FlashMessageRender';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import Input from '@/components/elements/Input';
import {
    getRobloxProfile,
    getRobloxProducts,
    initiateRobloxPurchase,
    checkRobloxPayment,
    cancelRobloxPurchase,
    RobloxProfile,
    RobloxProduct,
} from '@/api/store/robux';

type Step = 'username' | 'confirm-profile' | 'select-package' | 'pending';

export default () => {
    const { clearFlashes, clearAndAddHttpError, addFlash } = useFlash();
    const [step, setStep] = useState<Step>('username');
    const [username, setUsername] = useState('');
    const [profile, setProfile] = useState<RobloxProfile | null>(null);
    const [products, setProducts] = useState<RobloxProduct[]>([]);
    const [selectedProduct, setSelectedProduct] = useState<RobloxProduct | null>(null);
    const [purchaseId, setPurchaseId] = useState<number | null>(null);
    const [loading, setLoading] = useState(false);
    const [checking, setChecking] = useState(false);
    const [timeRemaining, setTimeRemaining] = useState(900); // 15 minutes in seconds

    useEffect(() => {
        // Load products on mount
        getRobloxProducts()
            .then(setProducts)
            .catch((error) => {
                console.error('Failed to load products:', error);
                clearAndAddHttpError({ key: 'store:robux', error });
            });
    }, []);

    const fetchProfile = async () => {
        if (!username.trim()) {
            clearAndAddHttpError({ key: 'store:robux', error: 'Please enter a Roblox username' });
            return;
        }

        setLoading(true);
        clearFlashes('store:robux');

        try {
            const profileData = await getRobloxProfile(username);
            setProfile(profileData);
            setStep('confirm-profile');
        } catch (error: any) {
            clearAndAddHttpError({ key: 'store:robux', error });
        } finally {
            setLoading(false);
        }
    };

    const confirmProfile = () => {
        setStep('select-package');
    };

    const selectPackage = async (product: RobloxProduct) => {
        if (!profile) return;

        setLoading(true);
        clearFlashes('store:robux');
        setSelectedProduct(product);

        try {
            const response = await initiateRobloxPurchase(profile.id, profile.username, product.id);
            setPurchaseId(response.purchase_id);
            setStep('pending');

            if (response.message) {
                addFlash({ key: 'store:robux', type: 'info', message: response.message });
            }
        } catch (error: any) {
            clearAndAddHttpError({ key: 'store:robux', error });
        } finally {
            setLoading(false);
        }
    };

    const checkPayment = async () => {
        if (!purchaseId) return;

        setChecking(true);
        clearFlashes('store:robux');

        try {
            const response = await checkRobloxPayment(purchaseId);

            if (response.success) {
                addFlash({
                    key: 'store:robux',
                    type: 'success',
                    message: `${response.message} You received ${response.credits_added} credits!`,
                });
                // Reload page to show updated balance
                setTimeout(() => window.location.reload(), 2000);
            } else {
                clearAndAddHttpError({ key: 'store:robux', error: response.message });
            }
        } catch (error: any) {
            clearAndAddHttpError({ key: 'store:robux', error });
        } finally {
            setChecking(false);
        }
    };

    // Auto-check payment every 10 seconds when in pending state
    useEffect(() => {
        if (step !== 'pending' || !purchaseId) return;

        // Reset timer when entering pending state
        setTimeRemaining(900);

        const interval = setInterval(async () => {
            try {
                const response = await checkRobloxPayment(purchaseId);
                if (response.success) {
                    clearInterval(interval);
                    addFlash({
                        key: 'store:robux',
                        type: 'success',
                        message: `${response.message} You received ${response.credits_added} credits!`,
                    });
                    setTimeout(() => window.location.reload(), 2000);
                }
            } catch (error) {
                // Silently continue checking
            }
        }, 10000); // Check every 10 seconds

        return () => clearInterval(interval);
    }, [step, purchaseId]);

    // Countdown timer
    useEffect(() => {
        if (step !== 'pending') return;

        const timer = setInterval(() => {
            setTimeRemaining((prev) => {
                if (prev <= 1) {
                    clearInterval(timer);
                    addFlash({
                        key: 'store:robux',
                        type: 'danger',
                        message: 'Purchase verification timed out. Please contact support if you completed the purchase.',
                    });
                    resetForm();
                    return 0;
                }
                return prev - 1;
            });
        }, 1000);

        return () => clearInterval(timer);
    }, [step]);

    const formatTime = (seconds: number) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    };

    const cancelPurchase = async () => {
        if (!purchaseId) return;

        try {
            await cancelRobloxPurchase(purchaseId);
            resetForm();
            addFlash({ key: 'store:robux', type: 'info', message: 'Purchase cancelled' });
        } catch (error: any) {
            clearAndAddHttpError({ key: 'store:robux', error });
        }
    };

    const resetForm = () => {
        setStep('username');
        setUsername('');
        setProfile(null);
        setSelectedProduct(null);
        setPurchaseId(null);
        clearFlashes('store:robux');
    };

    // Step 1: Enter Username
    if (step === 'username') {
        return (
            <TitledGreyBox title={'Purchase via Robux'}>
                <FlashMessageRender byKey={'store:robux'} css={tw`mb-4`} />
                <SpinnerOverlay visible={loading} />

                <div css={tw`mb-4`}>
                    <label css={tw`block text-sm font-medium mb-2 text-gray-300`}>Roblox Username</label>
                    <Input
                        type="text"
                        placeholder="Enter your Roblox username"
                        value={username}
                        onChange={(e) => setUsername(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && fetchProfile()}
                        disabled={loading}
                    />
                    <p css={tw`text-xs text-gray-400 mt-1`}>
                        We'll verify your profile to ensure the correct account receives credits
                    </p>
                </div>

                <Button onClick={fetchProfile} disabled={loading || !username.trim()}>
                    Continue
                </Button>
            </TitledGreyBox>
        );
    }

    // Step 2: Confirm Profile
    if (step === 'confirm-profile' && profile) {
        return (
            <TitledGreyBox title={'Confirm Your Profile'}>
                <FlashMessageRender byKey={'store:robux'} css={tw`mb-4`} />

                <div css={tw`flex items-start gap-4 mb-6 bg-neutral-700 rounded-lg p-4`}>
                    <img
                        src={profile.thumbnail}
                        alt={profile.username}
                        css={tw`w-20 h-20 rounded-lg`}
                    />
                    <div css={tw`flex-1`}>
                        <h3 css={tw`text-lg font-semibold text-white`}>{profile.username}</h3>
                        <p css={tw`text-sm text-gray-400`}>@{profile.displayName}</p>
                        <p css={tw`text-xs text-gray-500 mt-2 line-clamp-2`}>
                            {profile.description || 'No description'}
                        </p>
                    </div>
                </div>

                <p css={tw`text-sm text-gray-300 mb-4`}>Is this your Roblox account?</p>

                <div css={tw`flex gap-2`}>
                    <Button onClick={confirmProfile} css={tw`flex-1`}>
                        Yes, Continue
                    </Button>
                    <Button onClick={resetForm} css={tw`bg-gray-600 hover:bg-gray-700`}>
                        No, Go Back
                    </Button>
                </div>
            </TitledGreyBox>
        );
    }

    // Step 3: Select Package
    if (step === 'select-package') {
        return (
            <TitledGreyBox title={'Select Credit Package'}>
                <FlashMessageRender byKey={'store:robux'} css={tw`mb-4`} />
                <SpinnerOverlay visible={loading} />

                <div css={tw`space-y-3 mb-4`}>
                    {products
                        .sort((a, b) => b.credits - a.credits)
                        .map((product) => (
                            <button
                                key={product.id}
                                onClick={() => selectPackage(product)}
                                disabled={loading}
                                css={tw`w-full bg-neutral-700 hover:bg-neutral-600 rounded-lg p-4 text-left transition-colors border-2 border-transparent hover:border-blue-500`}
                            >
                                <div css={tw`flex justify-between items-center`}>
                                    <div>
                                        <h4 css={tw`text-lg font-semibold text-white`}>
                                            {product.credits} Credits
                                        </h4>
                                        <p css={tw`text-sm text-gray-400`}>{product.price} Robux</p>
                                    </div>
                                    <div css={tw`text-blue-400 font-medium`}>Select </div>
                                </div>
                            </button>
                        ))}
                </div>

                <Button onClick={resetForm} css={tw`bg-gray-600 hover:bg-gray-700 w-full`}>
                    Cancel
                </Button>
            </TitledGreyBox>
        );
    }

    // Step 4: Pending Purchase
    if (step === 'pending' && selectedProduct && profile) {
        return (
            <TitledGreyBox title={'Complete Your Purchase'}>
                <FlashMessageRender byKey={'store:robux'} css={tw`mb-4`} />

                <div css={tw`bg-blue-500 bg-opacity-10 border border-blue-500 rounded-lg p-4 mb-4`}>
                    <div css={tw`flex justify-between items-start mb-2`}>
                        <h3 css={tw`text-blue-400 font-bold`}>Purchase Pending</h3>
                        <div css={tw`text-right`}>
                            <div css={tw`text-blue-400 font-mono text-lg`}>{formatTime(timeRemaining)}</div>
                            <div css={tw`text-xs text-blue-300`}>Time remaining</div>
                        </div>
                    </div>
                    <p css={tw`text-sm text-gray-300 mb-2`}>
                        Purchasing <span css={tw`font-bold text-white`}>{selectedProduct.credits} credits</span> for{' '}
                        <span css={tw`font-bold text-white`}>{selectedProduct.price} Robux</span>
                    </p>
                    <p css={tw`text-xs text-gray-400`}>Account: {profile.username}</p>
                    <div css={tw`mt-3 flex items-center gap-2 text-xs text-green-400`}>
                        <div css={tw`animate-pulse`}></div>
                        <span>Auto-checking every 10 seconds...</span>
                    </div>
                </div>

                <div css={tw`bg-neutral-700 rounded-lg p-4 mb-4`}>
                    <h4 css={tw`font-semibold text-white mb-3`}>Follow these steps:</h4>
                    <ol css={tw`text-sm text-gray-300 space-y-2 pl-1`}>
                        <li css={tw`flex items-start gap-2`}>
                            <span css={tw`text-blue-400 font-bold`}>1.</span>
                            <span>Click "Open Gamepass" button below</span>
                        </li>
                        <li css={tw`flex items-start gap-2`}>
                            <span css={tw`text-blue-400 font-bold`}>2.</span>
                            <span>Purchase the gamepass on Roblox (take your time!)</span>
                        </li>
                        <li css={tw`flex items-start gap-2`}>
                            <span css={tw`text-blue-400 font-bold`}>3.</span>
                            <span>Your credits will be added automatically</span>
                        </li>
                    </ol>

                    <div css={tw`mt-4 p-3 bg-green-500 bg-opacity-10 border border-green-500 rounded`}>
                        <p css={tw`text-xs text-green-300`}>
                             You can switch tabs or apps - we'll keep checking for up to 15 minutes!
                        </p>
                    </div>

                    <div css={tw`mt-3 p-3 bg-yellow-500 bg-opacity-10 border border-yellow-500 rounded`}>
                        <p css={tw`text-xs text-yellow-300`}>
                             If you already own this gamepass, remove it from your inventory first by clicking the 3
                            dots and selecting "Remove from Inventory"
                        </p>
                    </div>
                </div>

                <a
                    href={selectedProduct.product_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    css={tw`block w-full bg-green-600 hover:bg-green-700 text-white text-center font-medium py-3 px-4 rounded-lg mb-3 transition-colors`}
                >
                    Open Gamepass on Roblox 
                </a>

                <div css={tw`flex gap-2`}>
                    <Button onClick={checkPayment} disabled={checking} css={tw`flex-1 bg-gray-600 hover:bg-gray-700`}>
                        {checking ? 'Checking...' : 'Check Now (Optional)'}
                    </Button>
                    <Button onClick={cancelPurchase} css={tw`bg-red-600 hover:bg-red-700`}>
                        Cancel
                    </Button>
                </div>
            </TitledGreyBox>
        );
    }

    return null;
};
</file>

<file path="app/Console/Commands/Environment/AppSettingsCommand.php">
<?php

namespace Jexactyl\Console\Commands\Environment;

use Illuminate\Console\Command;
use Illuminate\Contracts\Console\Kernel;
use Jexactyl\Traits\Commands\EnvironmentWriterTrait;

class AppSettingsCommand extends Command
{
    use EnvironmentWriterTrait;

    public const CACHE_DRIVERS = [
        'redis' => 'Redis (recommended)',
        'memcached' => 'Memcached',
        'file' => 'Filesystem',
    ];

    public const SESSION_DRIVERS = [
        'redis' => 'Redis (recommended)',
        'memcached' => 'Memcached',
        'database' => 'MySQL Database',
        'file' => 'Filesystem',
        'cookie' => 'Cookie',
    ];

    public const QUEUE_DRIVERS = [
        'redis' => 'Redis (recommended)',
        'database' => 'MySQL Database',
        'sync' => 'Sync',
    ];

    protected $description = 'Configure basic environment settings for the Panel.';

    protected $signature = 'p:environment:setup
                            {--new-salt : Whether or not to generate a new salt for Hashids.}
                            {--author= : The email that services created on this instance should be linked to.}
                            {--url= : The URL that this Panel is running on.}
                            {--timezone= : The timezone to use for Panel times.}
                            {--cache= : The cache driver backend to use.}
                            {--session= : The session driver backend to use.}
                            {--queue= : The queue driver backend to use.}
                            {--redis-host= : Redis host to use for connections.}
                            {--redis-pass= : Password used to connect to redis.}
                            {--redis-port= : Port to connect to redis over.}
                            {--settings-ui= : Enable or disable the settings UI.}';

    protected array $variables = [];

    /**
     * AppSettingsCommand constructor.
     */
    public function __construct(private Kernel $console)
    {
        parent::__construct();
    }

    /**
     * Handle command execution.
     *
     * @throws \Jexactyl\Exceptions\JexactylException
     */
    public function handle(): int
    {
        if (empty(config('hashids.salt')) || $this->option('new-salt')) {
            $this->variables['HASHIDS_SALT'] = str_random(20);
        }

        $this->output->comment('Provide the email address that eggs exported by this Panel should be from. This should be a valid email address.');
        $this->variables['APP_SERVICE_AUTHOR'] = $this->option('author') ?? $this->ask(
            'Egg Author Email',
            config('jexactyl.service.author', 'unknown@unknown.com')
        );

        if (!filter_var($this->variables['APP_SERVICE_AUTHOR'], FILTER_VALIDATE_EMAIL)) {
            $this->output->error('The service author email provided is invalid.');

            return 1;
        }

        $this->output->comment('The application URL MUST begin with https:// or http:// depending on if you are using SSL or not. If you do not include the scheme your emails and other content will link to the wrong location.');
        $this->variables['APP_URL'] = $this->option('url') ?? $this->ask(
            'Application URL',
            config('app.url', 'https://example.com')
        );

        $this->output->comment('The timezone should match one of PHP\'s supported timezones. If you are unsure, please reference https://php.net/manual/en/timezones.php.');
        $this->variables['APP_TIMEZONE'] = $this->option('timezone') ?? $this->anticipate(
            'Application Timezone',
            \DateTimeZone::listIdentifiers(),
            config('app.timezone')
        );

        $selected = config('cache.default', 'redis');
        $this->variables['CACHE_DRIVER'] = $this->option('cache') ?? $this->choice(
            'Cache Driver',
            self::CACHE_DRIVERS,
            array_key_exists($selected, self::CACHE_DRIVERS) ? $selected : null
        );

        $selected = config('session.driver', 'redis');
        $this->variables['SESSION_DRIVER'] = $this->option('session') ?? $this->choice(
            'Session Driver',
            self::SESSION_DRIVERS,
            array_key_exists($selected, self::SESSION_DRIVERS) ? $selected : null
        );

        $selected = config('queue.default', 'redis');
        $this->variables['QUEUE_CONNECTION'] = $this->option('queue') ?? $this->choice(
            'Queue Driver',
            self::QUEUE_DRIVERS,
            array_key_exists($selected, self::QUEUE_DRIVERS) ? $selected : null
        );

        if (!is_null($this->option('settings-ui'))) {
            $this->variables['APP_ENVIRONMENT_ONLY'] = $this->option('settings-ui') == 'true' ? 'false' : 'true';
        } else {
            $this->variables['APP_ENVIRONMENT_ONLY'] = $this->confirm('Enable UI based settings editor?', true) ? 'false' : 'true';
        }

        // Make sure session cookies are set as "secure" when using HTTPS
        if (str_starts_with($this->variables['APP_URL'], 'https://')) {
            $this->variables['SESSION_SECURE_COOKIE'] = 'true';
        }

        $this->checkForRedis();
        $this->writeToEnvironment($this->variables);

        $this->info($this->console->output());

        return 0;
    }

    /**
     * Check if redis is selected, if so, request connection details and verify them.
     */
    private function checkForRedis()
    {
        $items = collect($this->variables)->filter(function ($item) {
            return $item === 'redis';
        });

        // Redis was not selected, no need to continue.
        if (count($items) === 0) {
            return;
        }

        $this->output->note('You\'ve selected the Redis driver for one or more options, please provide valid connection information below. In most cases you can use the defaults provided unless you have modified your setup.');
        $this->variables['REDIS_HOST'] = $this->option('redis-host') ?? $this->ask(
            'Redis Host',
            config('database.redis.default.host')
        );

        $askForRedisPassword = true;
        if (!empty(config('database.redis.default.password'))) {
            $this->variables['REDIS_PASSWORD'] = config('database.redis.default.password');
            $askForRedisPassword = $this->confirm('It seems a password is already defined for Redis, would you like to change it?');
        }

        if ($askForRedisPassword) {
            $this->output->comment('By default a Redis server instance has no password as it is running locally and inaccessible to the outside world. If this is the case, simply hit enter without entering a value.');
            $this->variables['REDIS_PASSWORD'] = $this->option('redis-pass') ?? $this->output->askHidden(
                'Redis Password'
            );
        }

        if (empty($this->variables['REDIS_PASSWORD'])) {
            $this->variables['REDIS_PASSWORD'] = 'null';
        }

        $this->variables['REDIS_PORT'] = $this->option('redis-port') ?? $this->ask(
            'Redis Port',
            config('database.redis.default.port')
        );
    }
}
</file>

<file path="app/Console/Commands/Environment/DatabaseSettingsCommand.php">
<?php

namespace Jexactyl\Console\Commands\Environment;

use Illuminate\Console\Command;
use Illuminate\Contracts\Console\Kernel;
use Illuminate\Database\DatabaseManager;
use Jexactyl\Traits\Commands\EnvironmentWriterTrait;

class DatabaseSettingsCommand extends Command
{
    use EnvironmentWriterTrait;

    protected $description = 'Configure database settings for the Panel.';

    protected $signature = 'p:environment:database
                            {--host= : The connection address for the MySQL server.}
                            {--port= : The connection port for the MySQL server.}
                            {--database= : The database to use.}
                            {--username= : Username to use when connecting.}
                            {--password= : Password to use for this database.}';

    protected array $variables = [];

    /**
     * DatabaseSettingsCommand constructor.
     */
    public function __construct(private DatabaseManager $database, private Kernel $console)
    {
        parent::__construct();
    }

    /**
     * Handle command execution.
     *
     * @throws \Jexactyl\Exceptions\JexactylException
     */
    public function handle(): int
    {
        $this->output->note('It is highly recommended to not use "localhost" as your database host as we have seen frequent socket connection issues. If you want to use a local connection you should be using "127.0.0.1".');
        $this->variables['DB_HOST'] = $this->option('host') ?? $this->ask(
            'Database Host',
            config('database.connections.mysql.host', '127.0.0.1')
        );

        $this->variables['DB_PORT'] = $this->option('port') ?? $this->ask(
            'Database Port',
            config('database.connections.mysql.port', 3306)
        );

        $this->variables['DB_DATABASE'] = $this->option('database') ?? $this->ask(
            'Database Name',
            config('database.connections.mysql.database', 'panel')
        );

        $this->output->note('Using the "root" account for MySQL connections is not only highly frowned upon, it is also not allowed by this application. You\'ll need to have created a MySQL user for this software.');
        $this->variables['DB_USERNAME'] = $this->option('username') ?? $this->ask(
            'Database Username',
            config('database.connections.mysql.username', 'jexactyl')
        );

        $askForMySQLPassword = true;
        if (!empty(config('database.connections.mysql.password')) && $this->input->isInteractive()) {
            $this->variables['DB_PASSWORD'] = config('database.connections.mysql.password');
            $askForMySQLPassword = $this->confirm('It appears you already have a MySQL connection password defined, would you like to change it?');
        }

        if ($askForMySQLPassword) {
            $this->variables['DB_PASSWORD'] = $this->option('password') ?? $this->secret('Database Password');
        }

        try {
            $this->testMySQLConnection();
        } catch (\PDOException $exception) {
            $this->output->error(sprintf('Unable to connect to the MySQL server using the provided credentials. The error returned was "%s".', $exception->getMessage()));
            $this->output->error('Your connection credentials have NOT been saved. You will need to provide valid connection information before proceeding.');

            if ($this->confirm('Go back and try again?')) {
                $this->database->disconnect('_jexactyl_command_test');

                return $this->handle();
            }

            return 1;
        }

        $this->writeToEnvironment($this->variables);

        $this->info($this->console->output());

        return 0;
    }

    /**
     * Test that we can connect to the provided MySQL instance and perform a selection.
     */
    private function testMySQLConnection()
    {
        config()->set('database.connections._jexactyl_command_test', [
            'driver' => 'mysql',
            'host' => $this->variables['DB_HOST'],
            'port' => $this->variables['DB_PORT'],
            'database' => $this->variables['DB_DATABASE'],
            'username' => $this->variables['DB_USERNAME'],
            'password' => $this->variables['DB_PASSWORD'],
            'charset' => 'utf8mb4',
            'collation' => 'utf8mb4_unicode_ci',
            'strict' => true,
        ]);

        $this->database->connection('_jexactyl_command_test')->getPdo();
    }
}
</file>

<file path="app/Console/Commands/Environment/EmailSettingsCommand.php">
<?php

namespace Jexactyl\Console\Commands\Environment;

use Illuminate\Console\Command;
use Jexactyl\Traits\Commands\EnvironmentWriterTrait;
use Illuminate\Contracts\Config\Repository as ConfigRepository;

class EmailSettingsCommand extends Command
{
    use EnvironmentWriterTrait;

    protected $description = 'Set or update the email sending configuration for the Panel.';

    protected $signature = 'p:environment:mail
                            {--driver= : The mail driver to use.}
                            {--email= : Email address that messages from the Panel will originate from.}
                            {--from= : The name emails from the Panel will appear to be from.}
                            {--encryption=}
                            {--host=}
                            {--port=}
                            {--endpoint=}
                            {--username=}
                            {--password=}';

    protected array $variables = [];

    /**
     * EmailSettingsCommand constructor.
     */
    public function __construct(private ConfigRepository $config)
    {
        parent::__construct();
    }

    /**
     * Handle command execution.
     *
     * @throws \Jexactyl\Exceptions\JexactylException
     */
    public function handle()
    {
        $this->variables['MAIL_DRIVER'] = $this->option('driver') ?? $this->choice(
            trans('command/messages.environment.mail.ask_driver'),
            [
                'smtp' => 'SMTP Server',
                'mail' => 'PHP\'s Internal Mail Function',
                'mailgun' => 'Mailgun Transactional Email',
                'mandrill' => 'Mandrill Transactional Email',
                'postmark' => 'Postmark Transactional Email',
            ],
            $this->config->get('mail.default', 'smtp')
        );

        $method = 'setup' . studly_case($this->variables['MAIL_DRIVER']) . 'DriverVariables';
        if (method_exists($this, $method)) {
            $this->{$method}();
        }

        $this->variables['MAIL_FROM_ADDRESS'] = $this->option('email') ?? $this->ask(
            trans('command/messages.environment.mail.ask_mail_from'),
            $this->config->get('mail.from.address')
        );

        $this->variables['MAIL_FROM_NAME'] = $this->option('from') ?? $this->ask(
            trans('command/messages.environment.mail.ask_mail_name'),
            $this->config->get('mail.from.name')
        );

        $this->writeToEnvironment($this->variables);

        $this->line('Updating stored environment configuration file.');
        $this->line('');
    }

    /**
     * Handle variables for SMTP driver.
     */
    private function setupSmtpDriverVariables()
    {
        $this->variables['MAIL_HOST'] = $this->option('host') ?? $this->ask(
            trans('command/messages.environment.mail.ask_smtp_host'),
            $this->config->get('mail.mailers.smtp.host')
        );

        $this->variables['MAIL_PORT'] = $this->option('port') ?? $this->ask(
            trans('command/messages.environment.mail.ask_smtp_port'),
            $this->config->get('mail.mailers.smtp.port')
        );

        $this->variables['MAIL_USERNAME'] = $this->option('username') ?? $this->ask(
            trans('command/messages.environment.mail.ask_smtp_username'),
            $this->config->get('mail.mailers.smtp.username')
        );

        $this->variables['MAIL_PASSWORD'] = $this->option('password') ?? $this->secret(
            trans('command/messages.environment.mail.ask_smtp_password')
        );

        $this->variables['MAIL_ENCRYPTION'] = $this->option('encryption') ?? $this->choice(
            trans('command/messages.environment.mail.ask_encryption'),
            ['tls' => 'TLS', 'ssl' => 'SSL', '' => 'None'],
            $this->config->get('mail.mailers.smtp.encryption', 'tls')
        );
    }

    /**
     * Handle variables for mailgun driver.
     */
    private function setupMailgunDriverVariables()
    {
        $this->variables['MAILGUN_DOMAIN'] = $this->option('host') ?? $this->ask(
            trans('command/messages.environment.mail.ask_mailgun_domain'),
            $this->config->get('services.mailgun.domain')
        );

        $this->variables['MAILGUN_SECRET'] = $this->option('password') ?? $this->ask(
            trans('command/messages.environment.mail.ask_mailgun_secret'),
            $this->config->get('services.mailgun.secret')
        );

        $this->variables['MAILGUN_ENDPOINT'] = $this->option('endpoint') ?? $this->ask(
            trans('command/messages.environment.mail.ask_mailgun_endpoint'),
            $this->config->get('services.mailgun.endpoint')
        );
    }

    /**
     * Handle variables for mandrill driver.
     */
    private function setupMandrillDriverVariables()
    {
        $this->variables['MANDRILL_SECRET'] = $this->option('password') ?? $this->ask(
            trans('command/messages.environment.mail.ask_mandrill_secret'),
            $this->config->get('services.mandrill.secret')
        );
    }

    /**
     * Handle variables for postmark driver.
     */
    private function setupPostmarkDriverVariables()
    {
        $this->variables['MAIL_DRIVER'] = 'smtp';
        $this->variables['MAIL_HOST'] = 'smtp.postmarkapp.com';
        $this->variables['MAIL_PORT'] = 587;
        $this->variables['MAIL_USERNAME'] = $this->variables['MAIL_PASSWORD'] = $this->option('username') ?? $this->ask(
            trans('command/messages.environment.mail.ask_postmark_username'),
            $this->config->get('mail.username')
        );
    }
}
</file>

<file path="app/Console/Commands/Location/DeleteLocationCommand.php">
<?php

namespace Jexactyl\Console\Commands\Location;

use Illuminate\Console\Command;
use Illuminate\Support\Collection;
use Jexactyl\Services\Locations\LocationDeletionService;
use Jexactyl\Contracts\Repository\LocationRepositoryInterface;

class DeleteLocationCommand extends Command
{
    protected $description = 'Deletes a location from the Panel.';

    protected $signature = 'p:location:delete {--short= : The short code of the location to delete.}';

    protected Collection $locations;

    /**
     * DeleteLocationCommand constructor.
     */
    public function __construct(
        private LocationDeletionService $deletionService,
        private LocationRepositoryInterface $repository
    ) {
        parent::__construct();
    }

    /**
     * Respond to the command request.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     * @throws \Jexactyl\Exceptions\Service\Location\HasActiveNodesException
     */
    public function handle()
    {
        $this->locations = $this->locations ?? $this->repository->all();
        $short = $this->option('short') ?? $this->anticipate(
            trans('command/messages.location.ask_short'),
            $this->locations->pluck('short')->toArray()
        );

        $location = $this->locations->where('short', $short)->first();
        if (is_null($location)) {
            $this->error(trans('command/messages.location.no_location_found'));
            if ($this->input->isInteractive()) {
                $this->handle();
            }

            return;
        }

        $this->deletionService->handle($location->id);
        $this->line(trans('command/messages.location.deleted'));
    }
}
</file>

<file path="app/Console/Commands/Location/MakeLocationCommand.php">
<?php

namespace Jexactyl\Console\Commands\Location;

use Illuminate\Console\Command;
use Jexactyl\Services\Locations\LocationCreationService;

class MakeLocationCommand extends Command
{
    protected $signature = 'p:location:make
                            {--short= : The shortcode name of this location (ex. us1).}
                            {--long= : A longer description of this location.}';

    protected $description = 'Creates a new location on the system via the CLI.';

    /**
     * Create a new command instance.
     */
    public function __construct(private LocationCreationService $creationService)
    {
        parent::__construct();
    }

    /**
     * Handle the command execution process.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function handle()
    {
        $short = $this->option('short') ?? $this->ask(trans('command/messages.location.ask_short'));
        $long = $this->option('long') ?? $this->ask(trans('command/messages.location.ask_long'));

        $location = $this->creationService->handle(compact('short', 'long'));
        $this->line(trans('command/messages.location.created', [
            'name' => $location->short,
            'id' => $location->id,
        ]));
    }
}
</file>

<file path="app/Console/Commands/Maintenance/CleanServiceBackupFilesCommand.php">
<?php

namespace Jexactyl\Console\Commands\Maintenance;

use Carbon\Carbon;
use Illuminate\Console\Command;
use Illuminate\Contracts\Filesystem\Filesystem;
use Illuminate\Contracts\Filesystem\Factory as FilesystemFactory;

class CleanServiceBackupFilesCommand extends Command
{
    public const BACKUP_THRESHOLD_MINUTES = 5;

    protected $description = 'Clean orphaned .bak files created when modifying services.';

    protected $signature = 'p:maintenance:clean-service-backups';

    protected Filesystem $disk;

    /**
     * CleanServiceBackupFilesCommand constructor.
     */
    public function __construct(FilesystemFactory $filesystem)
    {
        parent::__construct();

        $this->disk = $filesystem->disk();
    }

    /**
     * Handle command execution.
     */
    public function handle()
    {
        $files = $this->disk->files('services/.bak');

        collect($files)->each(function (\SplFileInfo $file) {
            $lastModified = Carbon::createFromTimestamp($this->disk->lastModified($file->getPath()));
            if ($lastModified->diffInMinutes(Carbon::now()) > self::BACKUP_THRESHOLD_MINUTES) {
                $this->disk->delete($file->getPath());
                $this->info(trans('command/messages.maintenance.deleting_service_backup', ['file' => $file->getFilename()]));
            }
        });
    }
}
</file>

<file path="app/Console/Commands/Maintenance/PruneOrphanedBackupsCommand.php">
<?php

namespace Jexactyl\Console\Commands\Maintenance;

use Carbon\CarbonImmutable;
use Illuminate\Console\Command;
use Jexactyl\Repositories\Eloquent\BackupRepository;

class PruneOrphanedBackupsCommand extends Command
{
    protected $signature = 'p:maintenance:prune-backups {--prune-age=}';

    protected $description = 'Marks all backups that have not completed in the last "n" minutes as being failed.';

    /**
     * PruneOrphanedBackupsCommand constructor.
     */
    public function __construct(private BackupRepository $backupRepository)
    {
        parent::__construct();
    }

    public function handle()
    {
        $since = $this->option('prune-age') ?? config('backups.prune_age', 360);
        if (!$since || !is_digit($since)) {
            throw new \InvalidArgumentException('The "--prune-age" argument must be a value greater than 0.');
        }

        $query = $this->backupRepository->getBuilder()
            ->whereNull('completed_at')
            ->where('created_at', '<=', CarbonImmutable::now()->subMinutes($since)->toDateTimeString());

        $count = $query->count();
        if (!$count) {
            $this->info('There are no orphaned backups to be marked as failed.');

            return;
        }

        $this->warn("Marking $count backups that have not been marked as completed in the last $since minutes as failed.");

        $query->update([
            'is_successful' => false,
            'completed_at' => CarbonImmutable::now(),
            'updated_at' => CarbonImmutable::now(),
        ]);
    }
}
</file>

<file path="app/Console/Commands/Node/MakeNodeCommand.php">
<?php

namespace Jexactyl\Console\Commands\Node;

use Illuminate\Console\Command;
use Jexactyl\Services\Nodes\NodeCreationService;

class MakeNodeCommand extends Command
{
    protected $signature = 'p:node:make
                            {--name= : A name to identify the node.}
                            {--description= : A description to identify the node.}
                            {--locationId= : A valid locationId.}
                            {--fqdn= : The domain name (e.g node.example.com) to be used for connecting to the daemon. An IP address may only be used if you are not using SSL for this node.}
                            {--public= : Should the node be public or private? (public=1 / private=0).}
                            {--scheme= : Which scheme should be used? (Enable SSL=https / Disable SSL=http).}
                            {--proxy= : Is the daemon behind a proxy? (Yes=1 / No=0).}
                            {--maintenance= : Should maintenance mode be enabled? (Enable Maintenance mode=1 / Disable Maintenance mode=0).}
                            {--maxMemory= : Set the max memory amount.}
                            {--overallocateMemory= : Enter the amount of ram to overallocate (% or -1 to overallocate the maximum).}
                            {--maxDisk= : Set the max disk amount.}
                            {--overallocateDisk= : Enter the amount of disk to overallocate (% or -1 to overallocate the maximum).}
                            {--uploadSize= : Enter the maximum upload filesize.}
                            {--daemonListeningPort= : Enter the wings listening port.}
                            {--daemonSFTPPort= : Enter the wings SFTP listening port.}
                            {--daemonBase= : Enter the base folder.}';

    protected $description = 'Creates a new node on the system via the CLI.';

    /**
     * MakeNodeCommand constructor.
     */
    public function __construct(private NodeCreationService $creationService)
    {
        parent::__construct();
    }

    /**
     * Handle the command execution process.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function handle()
    {
        $data['name'] = $this->option('name') ?? $this->ask('Enter a short identifier used to distinguish this node from others');
        $data['description'] = $this->option('description') ?? $this->ask('Enter a description to identify the node');
        $data['location_id'] = $this->option('locationId') ?? $this->ask('Enter a valid location id');
        $data['scheme'] = $this->option('scheme') ?? $this->anticipate(
            'Please either enter https for SSL or http for a non-ssl connection',
            ['https', 'http'],
            'https'
        );
        $data['fqdn'] = $this->option('fqdn') ?? $this->ask('Enter a domain name (e.g node.example.com) to be used for connecting to the daemon. An IP address may only be used if you are not using SSL for this node');
        $data['public'] = $this->option('public') ?? $this->confirm('Should this node be public? As a note, setting a node to private you will be denying the ability to auto-deploy to this node.', true);
        $data['behind_proxy'] = $this->option('proxy') ?? $this->confirm('Is your FQDN behind a proxy?');
        $data['maintenance_mode'] = $this->option('maintenance') ?? $this->confirm('Should maintenance mode be enabled?');
        $data['memory'] = $this->option('maxMemory') ?? $this->ask('Enter the maximum amount of memory');
        $data['memory_overallocate'] = $this->option('overallocateMemory') ?? $this->ask('Enter the amount of memory to over allocate by, -1 will disable checking and 0 will prevent creating new servers');
        $data['disk'] = $this->option('maxDisk') ?? $this->ask('Enter the maximum amount of disk space');
        $data['disk_overallocate'] = $this->option('overallocateDisk') ?? $this->ask('Enter the amount of memory to over allocate by, -1 will disable checking and 0 will prevent creating new server');
        $data['upload_size'] = $this->option('uploadSize') ?? $this->ask('Enter the maximum filesize upload', '100');
        $data['daemonListen'] = $this->option('daemonListeningPort') ?? $this->ask('Enter the wings listening port', '8080');
        $data['daemonSFTP'] = $this->option('daemonSFTPPort') ?? $this->ask('Enter the wings SFTP listening port', '2022');
        $data['daemonBase'] = $this->option('daemonBase') ?? $this->ask('Enter the base folder', '/var/lib/pterodactyl/volumes');

        $node = $this->creationService->handle($data);
        $this->line('Successfully created a new node on the location ' . $data['location_id'] . ' with the name ' . $data['name'] . ' and has an id of ' . $node->id . '.');
    }
}
</file>

<file path="app/Console/Commands/Node/NodeConfigurationCommand.php">
<?php

namespace Jexactyl\Console\Commands\Node;

use Jexactyl\Models\Node;
use Illuminate\Console\Command;

class NodeConfigurationCommand extends Command
{
    protected $signature = 'p:node:configuration
                            {node : The ID or UUID of the node to return the configuration for.}
                            {--format=yaml : The output format. Options are "yaml" and "json".}';

    protected $description = 'Displays the configuration for the specified node.';

    public function handle(): int
    {
        $column = ctype_digit((string) $this->argument('node')) ? 'id' : 'uuid';

        /** @var \Jexactyl\Models\Node $node */
        $node = Node::query()->where($column, $this->argument('node'))->firstOr(function () {
            $this->error('The selected node does not exist.');

            exit(1);
        });

        $format = $this->option('format');
        if (!in_array($format, ['yaml', 'yml', 'json'])) {
            $this->error('Invalid format specified. Valid options are "yaml" and "json".');

            return 1;
        }

        if ($format === 'json') {
            $this->output->write($node->getJsonConfiguration(true));
        } else {
            $this->output->write($node->getYamlConfiguration());
        }

        $this->output->newLine();

        return 0;
    }
}
</file>

<file path="app/Console/Commands/Node/NodeListCommand.php">
<?php

namespace Jexactyl\Console\Commands\Node;

use Jexactyl\Models\Node;
use Illuminate\Console\Command;

class NodeListCommand extends Command
{
    protected $signature = 'p:node:list {--format=text : The output format: "text" or "json". }';

    public function handle(): int
    {
        $nodes = Node::query()->with('location')->get()->map(function (Node $node) {
            return [
                'id' => $node->id,
                'uuid' => $node->uuid,
                'name' => $node->name,
                'location' => $node->location->short,
                'host' => $node->getConnectionAddress(),
            ];
        });

        if ($this->option('format') === 'json') {
            $this->output->write($nodes->toJson(JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES));
        } else {
            $this->table(['ID', 'UUID', 'Name', 'Location', 'Host'], $nodes->toArray());
        }

        $this->output->newLine();

        return 0;
    }
}
</file>

<file path="app/Console/Commands/Overrides/SeedCommand.php">
<?php

namespace Jexactyl\Console\Commands\Overrides;

use Jexactyl\Console\RequiresDatabaseMigrations;
use Illuminate\Database\Console\Seeds\SeedCommand as BaseSeedCommand;

class SeedCommand extends BaseSeedCommand
{
    use RequiresDatabaseMigrations;

    /**
     * Block someone from running this seed command if they have not completed
     * the migration process.
     */
    public function handle(): int
    {
        if (!$this->hasCompletedMigrations()) {
            $this->showMigrationWarning();

            return 1;
        }

        return parent::handle();
    }
}
</file>

<file path="app/Console/Commands/Overrides/UpCommand.php">
<?php

namespace Jexactyl\Console\Commands\Overrides;

use Jexactyl\Console\RequiresDatabaseMigrations;
use Illuminate\Foundation\Console\UpCommand as BaseUpCommand;

class UpCommand extends BaseUpCommand
{
    use RequiresDatabaseMigrations;

    /**
     * Block someone from running this up command if they have not completed
     * the migration process.
     */
    public function handle(): int
    {
        if (!$this->hasCompletedMigrations()) {
            $this->showMigrationWarning();

            return 1;
        }

        return parent::handle() ?? 0;
    }
}
</file>

<file path="app/Console/Commands/Schedule/AnalyticsCollectionCommand.php">
<?php

namespace Jexactyl\Console\Commands\Schedule;

use Jexactyl\Models\Server;
use Illuminate\Console\Command;
use Jexactyl\Models\AnalyticsData;
use Jexactyl\Repositories\Wings\DaemonServerRepository;

class AnalyticsCollectionCommand extends Command
{
    /**
     * @var string
     */
    protected $signature = 'p:schedule:analytics';

    /**
     * @var string
     */
    protected $description = 'Collect analytics on server performance.';

    /**
     * AnalyticsCollectionCommand constructor.
     */
    public function __construct(private DaemonServerRepository $repository)
    {
        parent::__construct();
    }

    /**
     * Handle command execution.
     */
    public function handle()
    {
        foreach (Server::all() as $server) {
            $this->line($server->id . ' is being processed');

            $stats = $this->repository->setServer($server)->getDetails();
            $usage = $stats['utilization'];

            if ($stats['state'] === 'offline') {
                $this->line($server->id . ' is offline, skipping');
                continue;
            }

            if (AnalyticsData::where('server_id', $server->id)->count() >= 6) {
                $this->line($server->id . ' exceeds 6 entries, deleting oldest');
                AnalyticsData::where('server_id', $server->id)->orderBy('created_at', 'asc')->first()->delete();
            }

            try {
                AnalyticsData::create([
                    'server_id' => $server->id,
                    'cpu' => $usage['cpu_absolute'] / ($server->cpu / 100),
                    'memory' => ($usage['memory_bytes'] / 1024) / $server->memory / 10,
                    'disk' => ($usage['disk_bytes'] / 1024) / $server->disk / 10,
                ]);

                $this->line($server->id . ' analytics have been saved to database');
            } catch (\Exception $ex) {
                $this->error($server->id . ' failed to write stats: ' . $ex->getMessage());
            }
        }
    }
}
</file>

<file path="app/Console/Commands/Schedule/AnalyticsReviewCommand.php">
<?php

namespace Jexactyl\Console\Commands\Schedule;

use Jexactyl\Models\Server;
use Illuminate\Console\Command;
use Jexactyl\Services\Analytics\AnalyticsReviewService;

class AnalyticsReviewCommand extends Command
{
    /**
     * @var string
     */
    protected $signature = 'p:schedule:analytics-review';

    /**
     * @var string
     */
    protected $description = 'Reviews server analytics and creates messages for servers.';

    /**
     * AnalyticsReviewCommand constructor.
     */
    public function __construct(private AnalyticsReviewService $reviewService)
    {
        parent::__construct();
    }

    /**
     * Handle command execution.
     */
    public function handle()
    {
        foreach (Server::all() as $server) {
            $this->reviewService->handle($server);
        }
    }
}
</file>

<file path="app/Console/Commands/Schedule/CouponCommand.php">
<?php

namespace Jexactyl\Console\Commands\Schedule;

use Carbon\Carbon;
use Jexactyl\Models\Coupon;
use Illuminate\Console\Command;

class CouponCommand extends Command
{
    protected $signature = 'p:schedule:coupon';
    protected $description = 'Process coupon expirations.';

    public function handle(): void
    {
        $this->line('Beginning check for expired coupons.');
        $coupons = Coupon::query()->get();
        foreach ($coupons as $coupon) {
            $carbon = new Carbon($coupon->expires);
            $expires = $carbon->timestamp;
            if (Carbon::now()->timestamp >= $expires) {
                $coupon->update(['expired' => true]);
                $this->line('Coupon #' . $coupon->id . ' has been set as expired.');
            }
        }
        $this->line('Completed check for expired coupons.');
    }
}
</file>

<file path="app/Console/Commands/Schedule/ProcessRunnableCommand.php">
<?php

namespace Jexactyl\Console\Commands\Schedule;

use Exception;
use Jexactyl\Models\Schedule;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\Log;
use Illuminate\Database\Eloquent\Builder;
use Jexactyl\Services\Schedules\ProcessScheduleService;

class ProcessRunnableCommand extends Command
{
    protected $signature = 'p:schedule:process';

    protected $description = 'Process schedules in the database and determine which are ready to run.';

    /**
     * Handle command execution.
     */
    public function handle(): int
    {
        $schedules = Schedule::query()
            ->with('tasks')
            ->whereRelation('server', fn (Builder $builder) => $builder->whereNull('status'))
            ->where('is_active', true)
            ->where('is_processing', false)
            ->whereRaw('next_run_at <= NOW()')
            ->get();

        if ($schedules->count() < 1) {
            $this->line('There are no scheduled tasks for servers that need to be run.');

            return 0;
        }

        $bar = $this->output->createProgressBar(count($schedules));
        foreach ($schedules as $schedule) {
            $bar->clear();
            $this->processSchedule($schedule);
            $bar->advance();
            $bar->display();
        }

        $this->line('');

        return 0;
    }

    /**
     * Processes a given schedule and logs and errors encountered the console output. This should
     * never throw an exception out, otherwise you'll end up killing the entire run group causing
     * any other schedules to not process correctly.
     *
     * @see https://github.com/pterodactyl/panel/issues/2609
     */
    protected function processSchedule(Schedule $schedule)
    {
        if ($schedule->tasks->isEmpty()) {
            return;
        }

        try {
            $this->getLaravel()->make(ProcessScheduleService::class)->handle($schedule);

            $this->line(trans('command/messages.schedule.output_line', [
                'schedule' => $schedule->name,
                'hash' => $schedule->hashid,
            ]));
        } catch (\Throwable|\Exception $exception) {
            Log::error($exception, ['schedule_id' => $schedule->id]);

            $this->error("An error was encountered while processing Schedule #$schedule->id: " . $exception->getMessage());
        }
    }
}
</file>

<file path="app/Console/Commands/Schedule/PruneCommand.php">
<?php

namespace Jexactyl\Console\Commands\Schedule;

use Jexactyl\Models\Server;
use Illuminate\Console\Command;
use Jexactyl\Services\Servers\ServerDeletionService;

class PruneCommand extends Command
{
    /**
     * @var string
     */
    protected $signature = 'p:schedule:prune';

    /**
     * @var string
     */
    protected $description = 'Delete all suspended servers.';

    /**
     * DeleteUserCommand constructor.
     */
    public function __construct(private ServerDeletionService $deletionService)
    {
        parent::__construct();
    }

    /**
     * Handle command execution.
     */
    public function handle(Server $server)
    {
        $this->line('Running server prune...');
        $this->process($server);
        $this->line('Script completed successfully.');
    }

    /**
     * Takes one day off of the time a server has until it needs to be
     * renewed.
     */
    protected function process(Server $server)
    {
        $servers = $server->where('renewable', true)->get();
        $this->line('Processing renewals for ' . $servers->count() . ' servers.');

        foreach ($servers as $s) {
            $this->line('Processing server ' . $s->name . ', ID: ' . $s->id, false);

            if ($s->isSuspended()) {
                $this->line('Deleting server ' . $s->name, false);
                $this->deletionService->withForce(true)->returnResources(true)->handle($s);
            }
        }
    }
}
</file>

<file path="app/Console/Commands/Schedule/RenewalCommand.php">
<?php

namespace Jexactyl\Console\Commands\Schedule;

use Jexactyl\Models\Server;
use Illuminate\Console\Command;
use Jexactyl\Services\Servers\SuspensionService;
use Jexactyl\Services\Servers\ServerDeletionService;
use Exception;
class RenewalCommand extends Command
{
    /**
     * @var string
     */
    protected $signature = 'p:schedule:renewal';

    /**
     * @var string
     */
    protected $description = 'Process renewals for servers.';

    /**
     * DeleteUserCommand constructor.
     */
    public function __construct(
        private SuspensionService $suspensionService,
        private ServerDeletionService $deletionService
    ) {
        parent::__construct();
    }

    /**
     * Handle command execution.
     */
    public function handle(Server $server)
    {
        $this->line('Executing daily renewal script.');
        $this->process($server);
        $this->line('Renewals completed successfully.');
    }

    /**
     * Takes one day off of the time a server has until it needs to be
     * renewed.
     */
    protected function process(Server $server)
    {
        $servers = $server->where('renewable', true)->get();
        $this->line('Processing renewals for ' . $servers->count() . ' servers.');

        foreach ($servers as $svr) {
            try {
                $this->line('Renewing server ' . $svr->name, false);
    
                $svr->update(['renewal' => $svr->renewal - 1]);
    
                if ($svr->renewal <= 0) {
                    $this->line('Suspending server ' . $svr->name, false);
                    $this->suspensionService->toggle($svr, 'suspend');
                }
    
                if ($svr->renewal <= -7) {
                    $this->line('Deleting server ' . $svr->name, false);
                    $this->deletionService->handle($svr);
                }
            } catch (Exception $e) {
                $this->line('Error processing server ' . $svr->name . ': ' . $e->getMessage());
            }
        }
    }
}
</file>

<file path="app/Console/Commands/Server/BulkPowerActionCommand.php">
<?php

namespace Jexactyl\Console\Commands\Server;

use Jexactyl\Models\Server;
use Illuminate\Console\Command;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Validation\ValidationException;
use Illuminate\Validation\Factory as ValidatorFactory;
use Jexactyl\Repositories\Wings\DaemonPowerRepository;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;

class BulkPowerActionCommand extends Command
{
    protected $signature = 'p:server:bulk-power
                            {action : The action to perform (start, stop, restart, kill)}
                            {--servers= : A comma separated list of servers.}
                            {--nodes= : A comma separated list of nodes.}';

    protected $description = 'Perform bulk power management on large groupings of servers or nodes at once.';

    /**
     * BulkPowerActionCommand constructor.
     */
    public function __construct(private DaemonPowerRepository $powerRepository, private ValidatorFactory $validator)
    {
        parent::__construct();
    }

    /**
     * Handle the bulk power request.
     *
     * @throws \Illuminate\Validation\ValidationException
     */
    public function handle()
    {
        $action = $this->argument('action');
        $nodes = empty($this->option('nodes')) ? [] : explode(',', $this->option('nodes'));
        $servers = empty($this->option('servers')) ? [] : explode(',', $this->option('servers'));

        $validator = $this->validator->make([
            'action' => $action,
            'nodes' => $nodes,
            'servers' => $servers,
        ], [
            'action' => 'string|in:start,stop,kill,restart',
            'nodes' => 'array',
            'nodes.*' => 'integer|min:1',
            'servers' => 'array',
            'servers.*' => 'integer|min:1',
        ]);

        if ($validator->fails()) {
            foreach ($validator->getMessageBag()->all() as $message) {
                $this->output->error($message);
            }

            throw new ValidationException($validator);
        }

        $count = $this->getQueryBuilder($servers, $nodes)->count();
        if (!$this->confirm(trans('command/messages.server.power.confirm', ['action' => $action, 'count' => $count])) && $this->input->isInteractive()) {
            return;
        }

        $bar = $this->output->createProgressBar($count);
        $powerRepository = $this->powerRepository;
        $this->getQueryBuilder($servers, $nodes)->each(function (Server $server) use ($action, $powerRepository, &$bar) {
            $bar->clear();

            try {
                $powerRepository->setServer($server)->send($action);
            } catch (DaemonConnectionException $exception) {
                $this->output->error(trans('command/messages.server.power.action_failed', [
                    'name' => $server->name,
                    'id' => $server->id,
                    'node' => $server->node->name,
                    'message' => $exception->getMessage(),
                ]));
            }

            $bar->advance();
            $bar->display();
        });

        $this->line('');
    }

    /**
     * Returns the query builder instance that will return the servers that should be affected.
     */
    protected function getQueryBuilder(array $servers, array $nodes): Builder
    {
        $instance = Server::query()->whereNull('status');

        if (!empty($nodes) && !empty($servers)) {
            $instance->whereIn('id', $servers)->orWhereIn('node_id', $nodes);
        } elseif (empty($nodes) && !empty($servers)) {
            $instance->whereIn('id', $servers);
        } elseif (!empty($nodes) && empty($servers)) {
            $instance->whereIn('node_id', $nodes);
        }

        return $instance->with('node');
    }
}
</file>

<file path="app/Console/Commands/User/DeleteUserCommand.php">
<?php

namespace Jexactyl\Console\Commands\User;

use Jexactyl\Models\User;
use Webmozart\Assert\Assert;
use Illuminate\Console\Command;
use Jexactyl\Services\Users\UserDeletionService;

class DeleteUserCommand extends Command
{
    protected $description = 'Deletes a user from the Panel if no servers are attached to their account.';

    protected $signature = 'p:user:delete {--user=}';

    /**
     * DeleteUserCommand constructor.
     */
    public function __construct(private UserDeletionService $deletionService)
    {
        parent::__construct();
    }

    public function handle(): int
    {
        $search = $this->option('user') ?? $this->ask(trans('command/messages.user.search_users'));
        Assert::notEmpty($search, 'Search term should be an email address, got: %s.');

        $results = User::query()
            ->where('id', 'LIKE', "$search%")
            ->orWhere('username', 'LIKE', "$search%")
            ->orWhere('email', 'LIKE', "$search%")
            ->get();

        if (count($results) < 1) {
            $this->error(trans('command/messages.user.no_users_found'));
            if ($this->input->isInteractive()) {
                return $this->handle();
            }

            return 1;
        }

        if ($this->input->isInteractive()) {
            $tableValues = [];
            foreach ($results as $user) {
                $tableValues[] = [$user->id, $user->email, $user->name];
            }

            $this->table(['User ID', 'Email', 'Name'], $tableValues);
            if (!$deleteUser = $this->ask(trans('command/messages.user.select_search_user'))) {
                return $this->handle();
            }
        } else {
            if (count($results) > 1) {
                $this->error(trans('command/messages.user.multiple_found'));

                return 1;
            }

            $deleteUser = $results->first();
        }

        if ($this->confirm(trans('command/messages.user.confirm_delete')) || !$this->input->isInteractive()) {
            $this->deletionService->handle($deleteUser);
            $this->info(trans('command/messages.user.deleted'));
        }

        return 0;
    }
}
</file>

<file path="app/Console/Commands/User/DisableTwoFactorCommand.php">
<?php

namespace Jexactyl\Console\Commands\User;

use Illuminate\Console\Command;
use Jexactyl\Contracts\Repository\UserRepositoryInterface;

class DisableTwoFactorCommand extends Command
{
    protected $description = 'Disable two-factor authentication for a specific user in the Panel.';

    protected $signature = 'p:user:disable2fa {--email= : The email of the user to disable 2-Factor for.}';

    /**
     * DisableTwoFactorCommand constructor.
     */
    public function __construct(private UserRepositoryInterface $repository)
    {
        parent::__construct();
    }

    /**
     * Handle command execution process.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function handle()
    {
        if ($this->input->isInteractive()) {
            $this->output->warning(trans('command/messages.user.2fa_help_text'));
        }

        $email = $this->option('email') ?? $this->ask(trans('command/messages.user.ask_email'));
        $user = $this->repository->setColumns(['id', 'email'])->findFirstWhere([['email', '=', $email]]);

        $this->repository->withoutFreshModel()->update($user->id, [
            'use_totp' => false,
            'totp_secret' => null,
        ]);
        $this->info(trans('command/messages.user.2fa_disabled', ['email' => $user->email]));
    }
}
</file>

<file path="app/Console/Commands/User/MakeUserCommand.php">
<?php

namespace Jexactyl\Console\Commands\User;

use Illuminate\Console\Command;
use Jexactyl\Services\Users\UserCreationService;

class MakeUserCommand extends Command
{
    protected $description = 'Creates a user on the system via the CLI.';

    protected $signature = 'p:user:make {--email=} {--username=} {--name-first=} {--name-last=} {--password=} {--admin=} {--no-password}';

    /**
     * MakeUserCommand constructor.
     */
    public function __construct(private UserCreationService $creationService)
    {
        parent::__construct();
    }

    /**
     * Handle command request to create a new user.
     *
     * @throws \Exception
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function handle()
    {
        $root_admin = $this->option('admin') ?? $this->confirm(trans('command/messages.user.ask_admin'));
        $email = $this->option('email') ?? $this->ask(trans('command/messages.user.ask_email'));
        $username = $this->option('username') ?? $this->ask(trans('command/messages.user.ask_username'));
        $name_first = $this->option('name-first') ?? $this->ask(trans('command/messages.user.ask_name_first'));
        $name_last = $this->option('name-last') ?? $this->ask(trans('command/messages.user.ask_name_last'));

        if (is_null($password = $this->option('password')) && !$this->option('no-password')) {
            $this->warn(trans('command/messages.user.ask_password_help'));
            $this->line(trans('command/messages.user.ask_password_tip'));
            $password = $this->secret(trans('command/messages.user.ask_password'));
        }

        $user = $this->creationService->handle(compact('email', 'username', 'name_first', 'name_last', 'password', 'root_admin'));
        $this->table(['Field', 'Value'], [
            ['UUID', $user->uuid],
            ['Email', $user->email],
            ['Username', $user->username],
            ['Name', $user->name],
            ['Admin', $user->root_admin ? 'Yes' : 'No'],
        ]);
    }
}
</file>

<file path="app/Console/Commands/InfoCommand.php">
<?php

namespace Jexactyl\Console\Commands;

use Illuminate\Console\Command;
use Jexactyl\Services\Helpers\SoftwareVersionService;
use Illuminate\Contracts\Config\Repository as ConfigRepository;

class InfoCommand extends Command
{
    protected $description = 'Displays the application, database, and email configurations along with the panel version.';

    protected $signature = 'p:info';

    /**
     * VersionCommand constructor.
     */
    public function __construct(private ConfigRepository $config, private SoftwareVersionService $versionService)
    {
        parent::__construct();
    }

    /**
     * Handle execution of command.
     */
    public function handle()
    {
        $this->output->title('Version Information');
        $this->table([], [
            ['Panel Version', $this->config->get('app.version')],
            ['Latest Version', $this->versionService->getPanel()],
            ['Up-to-Date', $this->versionService->isLatestPanel() ? 'Yes' : $this->formatText('No', 'bg=red')],
            ['Unique Identifier', $this->config->get('jexactyl.service.author')],
        ], 'compact');

        $this->output->title('Application Configuration');
        $this->table([], [
            ['Environment', $this->formatText($this->config->get('app.env'), $this->config->get('app.env') === 'production' ?: 'bg=red')],
            ['Debug Mode', $this->formatText($this->config->get('app.debug') ? 'Yes' : 'No', !$this->config->get('app.debug') ?: 'bg=red')],
            ['Installation URL', $this->config->get('app.url')],
            ['Installation Directory', base_path()],
            ['Timezone', $this->config->get('app.timezone')],
            ['Cache Driver', $this->config->get('cache.default')],
            ['Queue Driver', $this->config->get('queue.default')],
            ['Session Driver', $this->config->get('session.driver')],
            ['Filesystem Driver', $this->config->get('filesystems.default')],
            ['Default Theme', $this->config->get('themes.active')],
            ['Proxies', implode(', ', $this->config->get('trustedproxy.proxies'))],
        ], 'compact');

        $this->output->title('Database Configuration');
        $driver = $this->config->get('database.default');
        $this->table([], [
            ['Driver', $driver],
            ['Host', $this->config->get("database.connections.$driver.host")],
            ['Port', $this->config->get("database.connections.$driver.port")],
            ['Database', $this->config->get("database.connections.$driver.database")],
            ['Username', $this->config->get("database.connections.$driver.username")],
        ], 'compact');

        // TODO: Update this to handle other mail drivers
        $this->output->title('Email Configuration');
        $this->table([], [
            ['Driver', $this->config->get('mail.default')],
            ['Host', $this->config->get('mail.mailers.smtp.host')],
            ['Port', $this->config->get('mail.mailers.smtp.port')],
            ['Username', $this->config->get('mail.mailers.smtp.username')],
            ['From Address', $this->config->get('mail.from.address')],
            ['From Name', $this->config->get('mail.from.name')],
            ['Encryption', $this->config->get('mail.mailers.smtp.encryption')],
        ], 'compact');
    }

    /**
     * Format output in a Name: Value manner.
     */
    private function formatText(string $value, string $opts = ''): string
    {
        return sprintf('<%s>%s</>', $opts, $value);
    }
}
</file>

<file path="app/Console/Commands/UpgradeCommand.php">
<?php

namespace Jexactyl\Console\Commands;

use Jexactyl\Console\Kernel;
use Illuminate\Console\Command;
use Symfony\Component\Process\Process;
use Symfony\Component\Console\Helper\ProgressBar;

class UpgradeCommand extends Command
{
    protected const DEFAULT_URL = 'https://github.com/jexactyl/jexactyl/releases/%s/panel.tar.gz';

    protected $signature = 'p:upgrade
        {--user= : The user that PHP runs under. All files will be owned by this user.}
        {--group= : The group that PHP runs under. All files will be owned by this group.}
        {--url= : The specific archive to download.}
        {--release= : A specific version to download from GitHub. Leave blank to use latest.}
        {--skip-download : If set no archive will be downloaded.}';

    protected $description = 'Downloads a new archive from Jexactyl\'s GitHub and executes the upgrade commands.';

    /**
     * Executes an upgrade command which will run through all of our standard
     * commands for Jexactyl and enable users to basically just download
     * the archive and execute this and be done.
     *
     * This places the application in maintenance mode as well while the commands
     * are being executed.
     *
     * @throws \Exception
     */
    public function handle()
    {
        $skipDownload = $this->option('skip-download');
        if (!$skipDownload) {
            $this->output->warning('This command does not verify the integrity of downloaded assets. Please ensure that you trust the download source before continuing. If you do not wish to download an archive, please indicate that using the --skip-download flag, or answering "no" to the question below.');
            $this->output->comment('Download Source (set with --url=):');
            $this->line($this->getUrl());
        }

        if (version_compare(PHP_VERSION, '8.0') < 0) {
            $this->error('Cannot execute self-upgrade process. The minimum required PHP version required is 8.0, you have [' . PHP_VERSION . '].');
        }

        $user = 'www-data';
        $group = 'www-data';
        if ($this->input->isInteractive()) {
            if (!$skipDownload) {
                $skipDownload = !$this->confirm('Would you like to download and unpack the archive files for the latest version?', true);
            }

            if (is_null($this->option('user'))) {
                $userDetails = posix_getpwuid(fileowner('public'));
                $user = $userDetails['name'] ?? 'www-data';

                if (!$this->confirm("Your webserver user has been detected as <fg=blue>[{$user}]:</> is this correct?", true)) {
                    $user = $this->anticipate(
                        'Please enter the name of the user running your webserver process. This varies from system to system, but is generally "www-data", "nginx", or "apache".',
                        [
                            'www-data',
                            'nginx',
                            'apache',
                        ]
                    );
                }
            }

            if (is_null($this->option('group'))) {
                $groupDetails = posix_getgrgid(filegroup('public'));
                $group = $groupDetails['name'] ?? 'www-data';

                if (!$this->confirm("Your webserver group has been detected as <fg=blue>[{$group}]:</> is this correct?", true)) {
                    $group = $this->anticipate(
                        'Please enter the name of the group running your webserver process. Normally this is the same as your user.',
                        [
                            'www-data',
                            'nginx',
                            'apache',
                        ]
                    );
                }
            }

            if (!$this->confirm('Are you sure you want to run the upgrade process for your Panel?')) {
                $this->warn('Upgrade process terminated by user.');

                return;
            }
        }

        ini_set('output_buffering', '0');
        $bar = $this->output->createProgressBar($skipDownload ? 9 : 10);
        $bar->start();

        if (!$skipDownload) {
            $this->withProgress($bar, function () {
                $this->line("\$upgrader> curl -L \"{$this->getUrl()}\" | tar -xzv");
                $process = Process::fromShellCommandline("curl -L \"{$this->getUrl()}\" | tar -xzv");
                $process->run(function ($type, $buffer) {
                    $this->{$type === Process::ERR ? 'error' : 'line'}($buffer);
                });
            });
        }

        $this->withProgress($bar, function () {
            $this->line('$upgrader> php artisan down');
            $this->call('down');
        });

        $this->withProgress($bar, function () {
            $this->line('$upgrader> chmod -R 755 storage bootstrap/cache');
            $process = new Process(['chmod', '-R', '755', 'storage', 'bootstrap/cache']);
            $process->run(function ($type, $buffer) {
                $this->{$type === Process::ERR ? 'error' : 'line'}($buffer);
            });
        });

        $this->withProgress($bar, function () {
            $command = ['composer', 'install', '--no-ansi'];
            if (config('app.env') === 'production' && !config('app.debug')) {
                $command[] = '--optimize-autoloader';
                $command[] = '--no-dev';
            }

            $this->line('$upgrader> ' . implode(' ', $command));
            $process = new Process($command);
            $process->setTimeout(10 * 60);
            $process->run(function ($type, $buffer) {
                $this->line($buffer);
            });
        });

        /** @var \Illuminate\Foundation\Application $app */
        $app = require __DIR__ . '/../../../bootstrap/app.php';
        /** @var \Jexactyl\Console\Kernel $kernel */
        $kernel = $app->make(Kernel::class);
        $kernel->bootstrap();
        $this->setLaravel($app);

        $this->withProgress($bar, function () {
            $this->line('$upgrader> php artisan view:clear');
            $this->call('view:clear');
        });

        $this->withProgress($bar, function () {
            $this->line('$upgrader> php artisan config:clear');
            $this->call('config:clear');
        });

        $this->withProgress($bar, function () {
            $this->line('$upgrader> php artisan migrate --force --seed');
            $this->call('migrate', ['--force' => true, '--seed' => true]);
        });

        $this->withProgress($bar, function () use ($user, $group) {
            $this->line("\$upgrader> chown -R {$user}:{$group} *");
            $process = Process::fromShellCommandline("chown -R {$user}:{$group} *", $this->getLaravel()->basePath());
            $process->setTimeout(10 * 60);
            $process->run(function ($type, $buffer) {
                $this->{$type === Process::ERR ? 'error' : 'line'}($buffer);
            });
        });

        $this->withProgress($bar, function () {
            $this->line('$upgrader> php artisan queue:restart');
            $this->call('queue:restart');
        });

        $this->withProgress($bar, function () {
            $this->line('$upgrader> php artisan up');
            $this->call('up');
        });

        $this->newLine(2);
        $this->info('Panel has been successfully upgraded. Please ensure you also update any Wings instances: https://pterodactyl.io/wings/1.0/upgrading.html');
    }

    protected function withProgress(ProgressBar $bar, \Closure $callback)
    {
        $bar->clear();
        $callback();
        $bar->advance();
        $bar->display();
    }

    protected function getUrl(): string
    {
        if ($this->option('url')) {
            return $this->option('url');
        }

        return sprintf(self::DEFAULT_URL, $this->option('release') ? 'download/v' . $this->option('release') : 'latest/download');
    }
}
</file>

<file path="app/Console/Kernel.php">
<?php

namespace Jexactyl\Console;

use Jexactyl\Models\ActivityLog;
use Illuminate\Console\Scheduling\Schedule;
use Illuminate\Database\Console\PruneCommand;
use Illuminate\Foundation\Console\Kernel as ConsoleKernel;
use Jexactyl\Console\Commands\Schedule\AnalyticsReviewCommand;
use Jexactyl\Console\Commands\Schedule\ProcessRunnableCommand;
use Jexactyl\Console\Commands\Schedule\AnalyticsCollectionCommand;
use Jexactyl\Console\Commands\Maintenance\PruneOrphanedBackupsCommand;
use Jexactyl\Console\Commands\Maintenance\CleanServiceBackupFilesCommand;

class Kernel extends ConsoleKernel
{
    /**
     * Register the commands for the application.
     */
    protected function commands()
    {
        $this->load(__DIR__ . '/Commands');
    }

    // Refer to: https://github.com/illuminate/console/blob/master/Scheduling/ManagesFrequencies.php
    // for time frequencies in terms of running commands, e.g. |->everyThirtyMinutes();|

    /**
     * Define the application's command schedule.
     */
    protected function schedule(Schedule $schedule)
    {
        // Execute scheduled commands for servers every minute, as if there was a normal cron running.
        $schedule->command(ProcessRunnableCommand::class)->everyMinute()->withoutOverlapping();
        $schedule->command(CleanServiceBackupFilesCommand::class)->daily();

        if (config('backups.prune_age')) {
            // Every 30 minutes, run the backup pruning command so that any abandoned backups can be deleted.
            $schedule->command(PruneOrphanedBackupsCommand::class)->everyThirtyMinutes();
        }

        // Run analysis commands to collect and process data.
        $schedule->command(AnalyticsCollectionCommand::class)->everyFifteenMinutes();
        $schedule->command(AnalyticsReviewCommand::class)->everyThreeHours();

        if (config('activity.prune_days')) {
            $schedule->command(PruneCommand::class, ['--model' => [ActivityLog::class]])->daily();
        }
    }
}
</file>

<file path="app/Console/RequiresDatabaseMigrations.php">
<?php

namespace Jexactyl\Console;

/**
 * @mixin \Illuminate\Console\Command
 */
trait RequiresDatabaseMigrations
{
    /**
     * Checks if the migrations have finished running by comparing the last migration file.
     */
    protected function hasCompletedMigrations(): bool
    {
        /** @var \Illuminate\Database\Migrations\Migrator $migrator */
        $migrator = $this->getLaravel()->make('migrator');

        $files = $migrator->getMigrationFiles(database_path('migrations'));

        if (!$migrator->repositoryExists()) {
            return false;
        }

        if (array_diff(array_keys($files), $migrator->getRepository()->getRan())) {
            return false;
        }

        return true;
    }

    /**
     * Throw a massive error into the console to hopefully catch the users attention and get
     * them to properly run the migrations rather than ignoring all of the other previous
     * errors...
     */
    protected function showMigrationWarning(): void
    {
        $this->getOutput()->writeln('<options=bold>
| @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ |
|                                                                              |
|               Your database has not been properly migrated!                  |
|                                                                              |
| @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ |</>

You must run the following command to finish migrating your database:

  <fg=green;options=bold>php artisan migrate --step --force</>

You will not be able to use Jexactyl Panel as expected without fixing your
database state by running the command above.
');

        $this->getOutput()->error('You must correct the error above before continuing.');
    }
}
</file>

<file path="app/Contracts/Core/ReceivesEvents.php">
<?php

namespace Jexactyl\Contracts\Core;

use Jexactyl\Events\Event;

interface ReceivesEvents
{
    /**
     * Handles receiving an event from the application.
     */
    public function handle(Event $notification): void;
}
</file>

<file path="app/Contracts/Criteria/CriteriaInterface.php">
<?php

namespace Jexactyl\Contracts\Criteria;

use Jexactyl\Repositories\Repository;
use Illuminate\Database\Eloquent\Model;

interface CriteriaInterface
{
    /**
     * Apply selected criteria to a repository call.
     */
    public function apply(Model $model, Repository $repository): mixed;
}
</file>

<file path="app/Contracts/Extensions/HashidsInterface.php">
<?php

namespace Jexactyl\Contracts\Extensions;

use Hashids\HashidsInterface as VendorHashidsInterface;

interface HashidsInterface extends VendorHashidsInterface
{
    /**
     * Decode an encoded hashid and return the first result.
     *
     * @throws \InvalidArgumentException
     */
    public function decodeFirst(string $encoded, string $default = null): mixed;
}
</file>

<file path="app/Contracts/Http/ClientPermissionsRequest.php">
<?php

namespace Jexactyl\Contracts\Http;

interface ClientPermissionsRequest
{
    /**
     * Returns the permissions string indicating which permission should be used to
     * validate that the authenticated user has permission to perform this action against
     * the given resource (server).
     */
    public function permission(): string;
}
</file>

<file path="app/Contracts/Repository/AllocationRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

use Jexactyl\Models\Allocation;

interface AllocationRepositoryInterface extends RepositoryInterface
{
    /**
     * Return all the allocations that exist for a node that are not currently
     * allocated.
     */
    public function getUnassignedAllocationIds(int $node): array;

    /**
     * Return a single allocation from those meeting the requirements.
     */
    public function getRandomAllocation(array $nodes, array $ports, bool $dedicated = false): ?Allocation;
}
</file>

<file path="app/Contracts/Repository/ApiKeyRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

use Jexactyl\Models\User;
use Illuminate\Support\Collection;

interface ApiKeyRepositoryInterface extends RepositoryInterface
{
    /**
     * Get all the account API keys that exist for a specific user.
     */
    public function getAccountKeys(User $user): Collection;

    /**
     * Get all the application API keys that exist for a specific user.
     */
    public function getApplicationKeys(User $user): Collection;

    /**
     * Delete an account API key from the panel for a specific user.
     */
    public function deleteAccountKey(User $user, string $identifier): int;

    /**
     * Delete an application API key from the panel for a specific user.
     */
    public function deleteApplicationKey(User $user, string $identifier): int;
}
</file>

<file path="app/Contracts/Repository/ApiPermissionRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

interface ApiPermissionRepositoryInterface extends RepositoryInterface
{
}
</file>

<file path="app/Contracts/Repository/DatabaseHostRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

use Illuminate\Support\Collection;

interface DatabaseHostRepositoryInterface extends RepositoryInterface
{
    /**
     * Return database hosts with a count of databases and the node
     * information for which it is attached.
     */
    public function getWithViewDetails(): Collection;
}
</file>

<file path="app/Contracts/Repository/DatabaseRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

use Illuminate\Support\Collection;
use Illuminate\Contracts\Pagination\LengthAwarePaginator;

interface DatabaseRepositoryInterface extends RepositoryInterface
{
    public const DEFAULT_CONNECTION_NAME = 'dynamic';

    /**
     * Set the connection name to execute statements against.
     */
    public function setConnection(string $connection): self;

    /**
     * Return the connection to execute statements against.
     */
    public function getConnection(): string;

    /**
     * Return all the databases belonging to a server.
     */
    public function getDatabasesForServer(int $server): Collection;

    /**
     * Return all the databases for a given host with the server relationship loaded.
     */
    public function getDatabasesForHost(int $host, int $count = 25): LengthAwarePaginator;

    /**
     * Create a new database on a given connection.
     */
    public function createDatabase(string $database): bool;

    /**
     * Create a new database user on a given connection.
     */
    public function createUser(string $username, string $remote, string $password, ?int $max_connections): bool;

    /**
     * Give a specific user access to a given database.
     */
    public function assignUserToDatabase(string $database, string $username, string $remote): bool;

    /**
     * Flush the privileges for a given connection.
     */
    public function flush(): bool;

    /**
     * Drop a given database on a specific connection.
     */
    public function dropDatabase(string $database): bool;

    /**
     * Drop a given user on a specific connection.
     */
    public function dropUser(string $username, string $remote): bool;
}
</file>

<file path="app/Contracts/Repository/EggRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

use Jexactyl\Models\Egg;
use Illuminate\Database\Eloquent\Collection;

interface EggRepositoryInterface extends RepositoryInterface
{
    /**
     * Return an egg with the variables relation attached.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithVariables(int $id): Egg;

    /**
     * Return all eggs and their relations to be used in the daemon API.
     */
    public function getAllWithCopyAttributes(): Collection;

    /**
     * Return an egg with the scriptFrom and configFrom relations loaded onto the model.
     */
    public function getWithCopyAttributes(int|string $value, string $column = 'id'): Egg;

    /**
     * Return all the data needed to export a service.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithExportAttributes(int $id): Egg;

    /**
     * Confirm a copy script belongs to the same nest as the item trying to use it.
     */
    public function isCopyableScript(int $copyFromId, int $service): bool;
}
</file>

<file path="app/Contracts/Repository/EggVariableRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

use Illuminate\Support\Collection;

interface EggVariableRepositoryInterface extends RepositoryInterface
{
    /**
     * Return editable variables for a given egg. Editable variables must be set to
     * user viewable in order to be picked up by this function.
     */
    public function getEditableVariables(int $egg): Collection;
}
</file>

<file path="app/Contracts/Repository/LocationRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

use Jexactyl\Models\Location;
use Illuminate\Support\Collection;

interface LocationRepositoryInterface extends RepositoryInterface
{
    /**
     * Return locations with a count of nodes and servers attached to it.
     */
    public function getAllWithDetails(): Collection;

    /**
     * Return all the available locations with the nodes as a relationship.
     */
    public function getAllWithNodes(): Collection;

    /**
     * Return all the nodes and their respective count of servers for a location.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithNodes(int $id): Location;

    /**
     * Return a location and the count of nodes in that location.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithNodeCount(int $id): Location;
}
</file>

<file path="app/Contracts/Repository/NestRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

use Jexactyl\Models\Nest;
use Illuminate\Database\Eloquent\Collection;

interface NestRepositoryInterface extends RepositoryInterface
{
    /**
     * Return a nest or all nests with their associated eggs and variables.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithEggs(int $id = null): Collection|Nest;

    /**
     * Return a nest or all nests and the count of eggs and servers for that nest.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithCounts(int $id = null): Collection|Nest;

    /**
     * Return a nest along with its associated eggs and the servers relation on those eggs.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithEggServers(int $id): Nest;
}
</file>

<file path="app/Contracts/Repository/NodeRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

use Jexactyl\Models\Node;
use Illuminate\Support\Collection;

interface NodeRepositoryInterface extends RepositoryInterface
{
    public const THRESHOLD_PERCENTAGE_LOW = 75;
    public const THRESHOLD_PERCENTAGE_MEDIUM = 90;

    /**
     * Return the usage stats for a single node.
     */
    public function getUsageStats(Node $node): array;

    /**
     * Return the usage stats for a single node.
     */
    public function getUsageStatsRaw(Node $node): array;

    /**
     * Return a single node with location and server information.
     */
    public function loadLocationAndServerCount(Node $node, bool $refresh = false): Node;

    /**
     * Attach a paginated set of allocations to a node mode including
     * any servers that are also attached to those allocations.
     */
    public function loadNodeAllocations(Node $node, bool $refresh = false): Node;

    /**
     * Return a collection of nodes for all locations to use in server creation UI.
     */
    public function getNodesForServerCreation(): Collection;
}
</file>

<file path="app/Contracts/Repository/PermissionRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

interface PermissionRepositoryInterface extends RepositoryInterface
{
}
</file>

<file path="app/Contracts/Repository/RepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

use Illuminate\Support\Collection;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Contracts\Pagination\LengthAwarePaginator;

interface RepositoryInterface
{
    /**
     * Return an identifier or Model object to be used by the repository.
     */
    public function model(): string;

    /**
     * Return the model being used for this repository instance.
     */
    public function getModel(): Model;

    /**
     * Returns an instance of a query builder.
     */
    public function getBuilder(): Builder;

    /**
     * Returns the columns to be selected or returned by the query.
     */
    public function getColumns(): array;

    /**
     * An array of columns to filter the response by.
     */
    public function setColumns(array|string $columns = ['*']): self;

    /**
     * Stop repository update functions from returning a fresh
     * model when changes are committed.
     */
    public function withoutFreshModel(): self;

    /**
     * Return a fresh model with a repository updates a model.
     */
    public function withFreshModel(): self;

    /**
     * Set whether the repository should return a fresh model
     * when changes are committed.
     */
    public function setFreshModel(bool $fresh = true): self;

    /**
     * Create a new model instance and persist it to the database.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function create(array $fields, bool $validate = true, bool $force = false): mixed;

    /**
     * Find a model that has the specific ID passed.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function find(int $id): mixed;

    /**
     * Find a model matching an array of where clauses.
     */
    public function findWhere(array $fields): Collection;

    /**
     * Find and return the first matching instance for the given fields.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function findFirstWhere(array $fields): mixed;

    /**
     * Return a count of records matching the passed arguments.
     */
    public function findCountWhere(array $fields): int;

    /**
     * Delete a given record from the database.
     */
    public function delete(int $id): int;

    /**
     * Delete records matching the given attributes.
     */
    public function deleteWhere(array $attributes): int;

    /**
     * Update a given ID with the passed array of fields.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(int $id, array $fields, bool $validate = true, bool $force = false): mixed;

    /**
     * Perform a mass update where matching records are updated using whereIn.
     * This does not perform any model data validation.
     */
    public function updateWhereIn(string $column, array $values, array $fields): int;

    /**
     * Update a record if it exists in the database, otherwise create it.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function updateOrCreate(array $where, array $fields, bool $validate = true, bool $force = false): mixed;

    /**
     * Return all records associated with the given model.
     */
    public function all(): Collection;

    /**
     * Return a paginated result set using a search term if set on the repository.
     */
    public function paginated(int $perPage): LengthAwarePaginator;

    /**
     * Insert a single or multiple records into the database at once skipping
     * validation and mass assignment checking.
     */
    public function insert(array $data): bool;

    /**
     * Insert multiple records into the database and ignore duplicates.
     */
    public function insertIgnore(array $values): bool;

    /**
     * Get the amount of entries in the database.
     */
    public function count(): int;
}
</file>

<file path="app/Contracts/Repository/ScheduleRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

use Jexactyl\Models\Schedule;
use Illuminate\Support\Collection;

interface ScheduleRepositoryInterface extends RepositoryInterface
{
    /**
     * Return all the schedules for a given server.
     */
    public function findServerSchedules(int $server): Collection;

    /**
     * Return a schedule model with all the associated tasks as a relationship.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getScheduleWithTasks(int $schedule): Schedule;
}
</file>

<file path="app/Contracts/Repository/ServerRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

use Jexactyl\Models\Server;
use Illuminate\Support\Collection;
use Illuminate\Contracts\Pagination\LengthAwarePaginator;

interface ServerRepositoryInterface extends RepositoryInterface
{
    /**
     * Load the egg relations onto the server model.
     */
    public function loadEggRelations(Server $server, bool $refresh = false): Server;

    /**
     * Return a collection of servers with their associated data for rebuild operations.
     */
    public function getDataForRebuild(int $server = null, int $node = null): Collection;

    /**
     * Return a collection of servers with their associated data for reinstall operations.
     */
    public function getDataForReinstall(int $server = null, int $node = null): Collection;

    /**
     * Return a server model and all variables associated with the server.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function findWithVariables(int $id): Server;

    /**
     * Get the primary allocation for a given server. If a model is passed into
     * the function, load the allocation relationship onto it. Otherwise, find and
     * return the server from the database.
     */
    public function getPrimaryAllocation(Server $server, bool $refresh = false): Server;

    /**
     * Return enough data to be used for the creation of a server via the daemon.
     */
    public function getDataForCreation(Server $server, bool $refresh = false): Server;

    /**
     * Load associated databases onto the server model.
     */
    public function loadDatabaseRelations(Server $server, bool $refresh = false): Server;

    /**
     * Get data for use when updating a server on the Daemon. Returns an array of
     * the egg which is used for build and rebuild. Only loads relations
     * if they are missing, or refresh is set to true.
     */
    public function getDaemonServiceData(Server $server, bool $refresh = false): array;

    /**
     * Return a server by UUID.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getByUuid(string $uuid): Server;

    /**
     * Check if a given UUID and UUID-Short string are unique to a server.
     */
    public function isUniqueUuidCombo(string $uuid, string $short): bool;

    /**
     * Returns all the servers that exist for a given node in a paginated response.
     */
    public function loadAllServersForNode(int $node, int $limit): LengthAwarePaginator;
}
</file>

<file path="app/Contracts/Repository/ServerVariableRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

interface ServerVariableRepositoryInterface extends RepositoryInterface
{
}
</file>

<file path="app/Contracts/Repository/SessionRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

use Illuminate\Support\Collection;

interface SessionRepositoryInterface extends RepositoryInterface
{
    /**
     * Return all the active sessions for a user.
     */
    public function getUserSessions(int $user): Collection;

    /**
     * Delete a session for a given user.
     */
    public function deleteUserSession(int $user, string $session): ?int;
}
</file>

<file path="app/Contracts/Repository/SettingsRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

interface SettingsRepositoryInterface extends RepositoryInterface
{
    /**
     * Store a new persistent setting in the database.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function set(string $key, string $value = null);

    /**
     * Retrieve a persistent setting from the database.
     */
    public function get(string $key, mixed $default): mixed;

    /**
     * Remove a key from the database cache.
     */
    public function forget(string $key);
}
</file>

<file path="app/Contracts/Repository/SubuserRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

use Jexactyl\Models\Subuser;

interface SubuserRepositoryInterface extends RepositoryInterface
{
    /**
     * Return a subuser with the associated server relationship.
     */
    public function loadServerAndUserRelations(Subuser $subuser, bool $refresh = false): Subuser;

    /**
     * Return a subuser with the associated permissions relationship.
     */
    public function getWithPermissions(Subuser $subuser, bool $refresh = false): Subuser;

    /**
     * Return a subuser and associated permissions given a user_id and server_id.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithPermissionsUsingUserAndServer(int $user, int $server): Subuser;
}
</file>

<file path="app/Contracts/Repository/TaskRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

use Jexactyl\Models\Task;

interface TaskRepositoryInterface extends RepositoryInterface
{
    /**
     * Get a task and the server relationship for that task.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getTaskForJobProcess(int $id): Task;

    /**
     * Returns the next task in a schedule.
     */
    public function getNextTask(int $schedule, int $index): ?Task;
}
</file>

<file path="app/Contracts/Repository/UserRepositoryInterface.php">
<?php

namespace Jexactyl\Contracts\Repository;

interface UserRepositoryInterface extends RepositoryInterface
{
}
</file>

<file path="app/Events/Auth/DirectLogin.php">
<?php

namespace Jexactyl\Events\Auth;

use Jexactyl\Models\User;
use Jexactyl\Events\Event;

class DirectLogin extends Event
{
    public function __construct(public User $user, public bool $remember)
    {
    }
}
</file>

<file path="app/Events/Auth/FailedCaptcha.php">
<?php

namespace Jexactyl\Events\Auth;

use Jexactyl\Events\Event;
use Illuminate\Queue\SerializesModels;

class FailedCaptcha extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public string $ip, public string $domain)
    {
    }
}
</file>

<file path="app/Events/Auth/FailedPasswordReset.php">
<?php

namespace Jexactyl\Events\Auth;

use Jexactyl\Events\Event;
use Illuminate\Queue\SerializesModels;

class FailedPasswordReset extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public string $ip, public string $email)
    {
    }
}
</file>

<file path="app/Events/Auth/ProvidedAuthenticationToken.php">
<?php

namespace Jexactyl\Events\Auth;

use Jexactyl\Models\User;
use Jexactyl\Events\Event;

class ProvidedAuthenticationToken extends Event
{
    public function __construct(public User $user, public bool $recovery = false)
    {
    }
}
</file>

<file path="app/Events/Server/Created.php">
<?php

namespace Jexactyl\Events\Server;

use Jexactyl\Events\Event;
use Jexactyl\Models\Server;
use Illuminate\Queue\SerializesModels;

class Created extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public Server $server)
    {
    }
}
</file>

<file path="app/Events/Server/Creating.php">
<?php

namespace Jexactyl\Events\Server;

use Jexactyl\Events\Event;
use Jexactyl\Models\Server;
use Illuminate\Queue\SerializesModels;

class Creating extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public Server $server)
    {
    }
}
</file>

<file path="app/Events/Server/Deleted.php">
<?php

namespace Jexactyl\Events\Server;

use Jexactyl\Events\Event;
use Jexactyl\Models\Server;
use Illuminate\Queue\SerializesModels;

class Deleted extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public Server $server)
    {
    }
}
</file>

<file path="app/Events/Server/Deleting.php">
<?php

namespace Jexactyl\Events\Server;

use Jexactyl\Events\Event;
use Jexactyl\Models\Server;
use Illuminate\Queue\SerializesModels;

class Deleting extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public Server $server)
    {
    }
}
</file>

<file path="app/Events/Server/Installed.php">
<?php

namespace Jexactyl\Events\Server;

use Jexactyl\Events\Event;
use Jexactyl\Models\Server;
use Illuminate\Queue\SerializesModels;

class Installed extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public Server $server)
    {
    }
}
</file>

<file path="app/Events/Server/Saved.php">
<?php

namespace Jexactyl\Events\Server;

use Jexactyl\Events\Event;
use Jexactyl\Models\Server;
use Illuminate\Queue\SerializesModels;

class Saved extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public Server $server)
    {
    }
}
</file>

<file path="app/Events/Server/Saving.php">
<?php

namespace Jexactyl\Events\Server;

use Jexactyl\Events\Event;
use Jexactyl\Models\Server;
use Illuminate\Queue\SerializesModels;

class Saving extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public Server $server)
    {
    }
}
</file>

<file path="app/Events/Server/Updated.php">
<?php

namespace Jexactyl\Events\Server;

use Jexactyl\Events\Event;
use Jexactyl\Models\Server;
use Illuminate\Queue\SerializesModels;

class Updated extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public Server $server)
    {
    }
}
</file>

<file path="app/Events/Server/Updating.php">
<?php

namespace Jexactyl\Events\Server;

use Jexactyl\Events\Event;
use Jexactyl\Models\Server;
use Illuminate\Queue\SerializesModels;

class Updating extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public Server $server)
    {
    }
}
</file>

<file path="app/Events/Subuser/Created.php">
<?php

namespace Jexactyl\Events\Subuser;

use Jexactyl\Events\Event;
use Jexactyl\Models\Subuser;
use Illuminate\Queue\SerializesModels;

class Created extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public Subuser $subuser)
    {
    }
}
</file>

<file path="app/Events/Subuser/Creating.php">
<?php

namespace Jexactyl\Events\Subuser;

use Jexactyl\Events\Event;
use Jexactyl\Models\Subuser;
use Illuminate\Queue\SerializesModels;

class Creating extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public Subuser $subuser)
    {
    }
}
</file>

<file path="app/Events/Subuser/Deleted.php">
<?php

namespace Jexactyl\Events\Subuser;

use Jexactyl\Events\Event;
use Jexactyl\Models\Subuser;
use Illuminate\Queue\SerializesModels;

class Deleted extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public Subuser $subuser)
    {
    }
}
</file>

<file path="app/Events/Subuser/Deleting.php">
<?php

namespace Jexactyl\Events\Subuser;

use Jexactyl\Events\Event;
use Jexactyl\Models\Subuser;
use Illuminate\Queue\SerializesModels;

class Deleting extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public Subuser $subuser)
    {
    }
}
</file>

<file path="app/Events/User/Created.php">
<?php

namespace Jexactyl\Events\User;

use Jexactyl\Models\User;
use Jexactyl\Events\Event;
use Illuminate\Queue\SerializesModels;

class Created extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public User $user)
    {
    }
}
</file>

<file path="app/Events/User/Creating.php">
<?php

namespace Jexactyl\Events\User;

use Jexactyl\Models\User;
use Jexactyl\Events\Event;
use Illuminate\Queue\SerializesModels;

class Creating extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public User $user)
    {
    }
}
</file>

<file path="app/Events/User/Deleted.php">
<?php

namespace Jexactyl\Events\User;

use Jexactyl\Models\User;
use Jexactyl\Events\Event;
use Illuminate\Queue\SerializesModels;

class Deleted extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public User $user)
    {
    }
}
</file>

<file path="app/Events/User/Deleting.php">
<?php

namespace Jexactyl\Events\User;

use Jexactyl\Models\User;
use Jexactyl\Events\Event;
use Illuminate\Queue\SerializesModels;

class Deleting extends Event
{
    use SerializesModels;

    /**
     * Create a new event instance.
     */
    public function __construct(public User $user)
    {
    }
}
</file>

<file path="app/Events/ActivityLogged.php">
<?php

namespace Jexactyl\Events;

use Illuminate\Support\Str;
use Jexactyl\Models\ActivityLog;
use Illuminate\Database\Eloquent\Model;

class ActivityLogged extends Event
{
    public function __construct(public ActivityLog $model)
    {
    }

    public function is(string $event): bool
    {
        return $this->model->event === $event;
    }

    public function actor(): ?Model
    {
        return $this->isSystem() ? null : $this->model->actor;
    }

    public function isServerEvent(): bool
    {
        return Str::startsWith($this->model->event, 'server:');
    }

    public function isSystem(): bool
    {
        return is_null($this->model->actor_id);
    }
}
</file>

<file path="app/Events/Event.php">
<?php

namespace Jexactyl\Events;

abstract class Event
{
}
</file>

<file path="app/Exceptions/Http/Base/InvalidPasswordProvidedException.php">
<?php

namespace Jexactyl\Exceptions\Http\Base;

use Jexactyl\Exceptions\DisplayException;

class InvalidPasswordProvidedException extends DisplayException
{
}
</file>

<file path="app/Exceptions/Http/Connection/DaemonConnectionException.php">
<?php

namespace Jexactyl\Exceptions\Http\Connection;

use Illuminate\Http\Response;
use Illuminate\Support\Facades\Log;
use GuzzleHttp\Exception\GuzzleException;
use Jexactyl\Exceptions\DisplayException;

/**
 * @method \GuzzleHttp\Exception\GuzzleException getPrevious()
 */
class DaemonConnectionException extends DisplayException
{
    private int $statusCode = Response::HTTP_GATEWAY_TIMEOUT;

    /**
     * Every request to the Wings instance will return a unique X-Request-Id header
     * which allows for all errors to be efficiently tied to a specific request that
     * triggered them, and gives users a more direct method of informing hosts when
     * something goes wrong.
     */
    private ?string $requestId;

    /**
     * Throw a displayable exception caused by a daemon connection error.
     */
    public function __construct(GuzzleException $previous, bool $useStatusCode = true)
    {
        /** @var \GuzzleHttp\Psr7\Response|null $response */
        $response = method_exists($previous, 'getResponse') ? $previous->getResponse() : null;
        $this->requestId = $response?->getHeaderLine('X-Request-Id');

        if ($useStatusCode) {
            $this->statusCode = is_null($response) ? $this->statusCode : $response->getStatusCode();
            // There are rare conditions where wings encounters a panic condition and crashes the
            // request being made after content has already been sent over the wire. In these cases
            // you can end up with a "successful" response code that is actual an error.
            //
            // Handle those better here since we shouldn't ever end up in this exception state and
            // be returning a 2XX level response.
            if ($this->statusCode < 400) {
                $this->statusCode = Response::HTTP_BAD_GATEWAY;
            }
        }

        if (is_null($response)) {
            $message = 'Could not establish a connection to the machine running this server. Please try again.';
        } else {
            $message = sprintf('There was an error while communicating with the machine running this server. This error has been logged, please try again. (code: %s) (request_id: %s)', $response->getStatusCode(), $this->requestId ?? '<nil>');
        }

        // Attempt to pull the actual error message off the response and return that if it is not
        // a 500 level error.
        if ($this->statusCode < 500 && !is_null($response)) {
            $body = json_decode($response->getBody()->__toString(), true);
            $message = sprintf('An error occurred on the remote host: %s. (request id: %s)', $body['error'] ?? $message, $this->requestId ?? '<nil>');
        }

        $level = $this->statusCode >= 500 && $this->statusCode !== 504
            ? DisplayException::LEVEL_ERROR
            : DisplayException::LEVEL_WARNING;

        parent::__construct($message, $previous, $level);
    }

    /**
     * Override the default reporting method for DisplayException by just logging immediately
     * here and including the specific X-Request-Id header that was returned by the call.
     */
    public function report()
    {
        Log::{$this->getErrorLevel()}($this->getPrevious(), [
            'request_id' => $this->requestId,
        ]);
    }

    /**
     * Return the HTTP status code for this exception.
     */
    public function getStatusCode(): int
    {
        return $this->statusCode;
    }

    public function getRequestId(): ?string
    {
        return $this->requestId;
    }
}
</file>

<file path="app/Exceptions/Http/Server/FileSizeTooLargeException.php">
<?php

namespace Jexactyl\Exceptions\Http\Server;

use Jexactyl\Exceptions\DisplayException;

class FileSizeTooLargeException extends DisplayException
{
    /**
     * FileSizeTooLargeException constructor.
     */
    public function __construct()
    {
        parent::__construct('The file you are attempting to open is too large to view in the file editor.');
    }
}
</file>

<file path="app/Exceptions/Http/Server/FileTypeNotEditableException.php">
<?php

namespace Jexactyl\Exceptions\Http\Server;

use Jexactyl\Exceptions\DisplayException;

class FileTypeNotEditableException extends DisplayException
{
}
</file>

<file path="app/Exceptions/Http/Server/ServerStateConflictException.php">
<?php

namespace Jexactyl\Exceptions\Http\Server;

use Jexactyl\Models\Server;
use Symfony\Component\HttpKernel\Exception\ConflictHttpException;

class ServerStateConflictException extends ConflictHttpException
{
    /**
     * Exception thrown when the server is in an unsupported state for API access or
     * certain operations within the codebase.
     */
    public function __construct(Server $server, \Throwable $previous = null)
    {
        $message = 'This server is currently in an unsupported state, please try again later.';
        if ($server->isSuspended()) {
            $message = 'This server is currently suspended and the functionality requested is unavailable.';
        } elseif ($server->node->isUnderMaintenance()) {
            $message = 'The node of this server is currently under maintenance and the functionality requested is unavailable.';
        } elseif (!$server->isInstalled()) {
            $message = 'This server has not yet completed its installation process, please try again later.';
        } elseif ($server->status === Server::STATUS_RESTORING_BACKUP) {
            $message = 'This server is currently restoring from a backup, please try again later.';
        } elseif (!is_null($server->transfer)) {
            $message = 'This server is currently being transferred to a new machine, please try again later.';
        }

        parent::__construct($message, $previous);
    }
}
</file>

<file path="app/Exceptions/Http/HttpForbiddenException.php">
<?php

namespace Jexactyl\Exceptions\Http;

use Illuminate\Http\Response;
use Symfony\Component\HttpKernel\Exception\HttpException;

class HttpForbiddenException extends HttpException
{
    /**
     * HttpForbiddenException constructor.
     */
    public function __construct(string $message = null, \Throwable $previous = null)
    {
        parent::__construct(Response::HTTP_FORBIDDEN, $message, $previous);
    }
}
</file>

<file path="app/Exceptions/Http/TwoFactorAuthRequiredException.php">
<?php

namespace Jexactyl\Exceptions\Http;

use Illuminate\Http\Response;
use Symfony\Component\HttpKernel\Exception\HttpException;
use Symfony\Component\HttpKernel\Exception\HttpExceptionInterface;

class TwoFactorAuthRequiredException extends HttpException implements HttpExceptionInterface
{
    /**
     * TwoFactorAuthRequiredException constructor.
     */
    public function __construct(\Throwable $previous = null)
    {
        parent::__construct(Response::HTTP_BAD_REQUEST, 'Two-factor authentication is required on this account in order to access this endpoint.', $previous);
    }
}
</file>

<file path="app/Exceptions/Model/DataValidationException.php">
<?php

namespace Jexactyl\Exceptions\Model;

use Illuminate\Support\MessageBag;
use Illuminate\Database\Eloquent\Model;
use Jexactyl\Exceptions\JexactylException;
use Illuminate\Contracts\Validation\Validator;
use Illuminate\Contracts\Support\MessageProvider;
use Symfony\Component\HttpKernel\Exception\HttpExceptionInterface;

class DataValidationException extends JexactylException implements HttpExceptionInterface, MessageProvider
{
    /**
     * DataValidationException constructor.
     */
    public function __construct(protected Validator $validator, protected Model $model)
    {
        $message = sprintf(
            'Could not save %s[%s]: failed to validate data: %s',
            get_class($model),
            $model->getKey(),
            $validator->errors()->toJson()
        );

        parent::__construct($message);
    }

    /**
     * Return the validator message bag.
     */
    public function getMessageBag(): MessageBag
    {
        return $this->validator->errors();
    }

    /**
     * Return the status code for this request.
     */
    public function getStatusCode(): int
    {
        return 500;
    }

    public function getHeaders(): array
    {
        return [];
    }

    public function getValidator(): Validator
    {
        return $this->validator;
    }

    public function getModel(): Model
    {
        return $this->model;
    }
}
</file>

<file path="app/Exceptions/Repository/Daemon/InvalidPowerSignalException.php">
<?php

namespace Jexactyl\Exceptions\Repository\Daemon;

use Jexactyl\Exceptions\Repository\RepositoryException;

class InvalidPowerSignalException extends RepositoryException
{
}
</file>

<file path="app/Exceptions/Repository/DuplicateDatabaseNameException.php">
<?php

namespace Jexactyl\Exceptions\Repository;

use Jexactyl\Exceptions\DisplayException;

class DuplicateDatabaseNameException extends DisplayException
{
}
</file>

<file path="app/Exceptions/Repository/RecordNotFoundException.php">
<?php

namespace Jexactyl\Exceptions\Repository;

use Illuminate\Http\Response;
use Symfony\Component\HttpKernel\Exception\HttpExceptionInterface;

class RecordNotFoundException extends RepositoryException implements HttpExceptionInterface
{
    /**
     * Returns the status code.
     */
    public function getStatusCode(): int
    {
        return Response::HTTP_NOT_FOUND;
    }

    /**
     * Returns response headers.
     */
    public function getHeaders(): array
    {
        return [];
    }
}
</file>

<file path="app/Exceptions/Repository/RepositoryException.php">
<?php

namespace Jexactyl\Exceptions\Repository;

use Jexactyl\Exceptions\JexactylException;

class RepositoryException extends JexactylException
{
}
</file>

<file path="app/Exceptions/Service/Allocation/AllocationDoesNotBelongToServerException.php">
<?php

namespace Jexactyl\Exceptions\Service\Allocation;

use Jexactyl\Exceptions\JexactylException;

class AllocationDoesNotBelongToServerException extends JexactylException
{
}
</file>

<file path="app/Exceptions/Service/Allocation/AutoAllocationNotEnabledException.php">
<?php

namespace Jexactyl\Exceptions\Service\Allocation;

use Jexactyl\Exceptions\DisplayException;

class AutoAllocationNotEnabledException extends DisplayException
{
    /**
     * AutoAllocationNotEnabledException constructor.
     */
    public function __construct()
    {
        parent::__construct(
            'Server auto-allocation is not enabled for this instance.'
        );
    }
}
</file>

<file path="app/Exceptions/Service/Allocation/CidrOutOfRangeException.php">
<?php

namespace Jexactyl\Exceptions\Service\Allocation;

use Jexactyl\Exceptions\DisplayException;

class CidrOutOfRangeException extends DisplayException
{
    /**
     * CidrOutOfRangeException constructor.
     */
    public function __construct()
    {
        parent::__construct(trans('exceptions.allocations.cidr_out_of_range'));
    }
}
</file>

<file path="app/Exceptions/Service/Allocation/InvalidPortMappingException.php">
<?php

namespace Jexactyl\Exceptions\Service\Allocation;

use Jexactyl\Exceptions\DisplayException;

class InvalidPortMappingException extends DisplayException
{
    /**
     * InvalidPortMappingException constructor.
     */
    public function __construct(mixed $port)
    {
        parent::__construct(trans('exceptions.allocations.invalid_mapping', ['port' => $port]));
    }
}
</file>

<file path="app/Exceptions/Service/Allocation/NoAutoAllocationSpaceAvailableException.php">
<?php

namespace Jexactyl\Exceptions\Service\Allocation;

use Jexactyl\Exceptions\DisplayException;

class NoAutoAllocationSpaceAvailableException extends DisplayException
{
    /**
     * NoAutoAllocationSpaceAvailableException constructor.
     */
    public function __construct()
    {
        parent::__construct(
            'Cannot assign additional allocation: no more space available on node.'
        );
    }
}
</file>

<file path="app/Exceptions/Service/Allocation/PortOutOfRangeException.php">
<?php

namespace Jexactyl\Exceptions\Service\Allocation;

use Jexactyl\Exceptions\DisplayException;

class PortOutOfRangeException extends DisplayException
{
    /**
     * PortOutOfRangeException constructor.
     */
    public function __construct()
    {
        parent::__construct(trans('exceptions.allocations.port_out_of_range'));
    }
}
</file>

<file path="app/Exceptions/Service/Allocation/ServerUsingAllocationException.php">
<?php

namespace Jexactyl\Exceptions\Service\Allocation;

use Jexactyl\Exceptions\DisplayException;

class ServerUsingAllocationException extends DisplayException
{
}
</file>

<file path="app/Exceptions/Service/Allocation/TooManyPortsInRangeException.php">
<?php

namespace Jexactyl\Exceptions\Service\Allocation;

use Jexactyl\Exceptions\DisplayException;

class TooManyPortsInRangeException extends DisplayException
{
    /**
     * TooManyPortsInRangeException constructor.
     */
    public function __construct()
    {
        parent::__construct(trans('exceptions.allocations.too_many_ports'));
    }
}
</file>

<file path="app/Exceptions/Service/Backup/BackupLockedException.php">
<?php

namespace Jexactyl\Exceptions\Service\Backup;

use Jexactyl\Exceptions\DisplayException;

class BackupLockedException extends DisplayException
{
    /**
     * TooManyBackupsException constructor.
     */
    public function __construct()
    {
        parent::__construct('Cannot delete a backup that is marked as locked.');
    }
}
</file>

<file path="app/Exceptions/Service/Backup/TooManyBackupsException.php">
<?php

namespace Jexactyl\Exceptions\Service\Backup;

use Jexactyl\Exceptions\DisplayException;

class TooManyBackupsException extends DisplayException
{
    /**
     * TooManyBackupsException constructor.
     */
    public function __construct(int $backupLimit)
    {
        parent::__construct(
            sprintf('Cannot create a new backup, this server has reached its limit of %d backups.', $backupLimit)
        );
    }
}
</file>

<file path="app/Exceptions/Service/Database/DatabaseClientFeatureNotEnabledException.php">
<?php

namespace Jexactyl\Exceptions\Service\Database;

use Jexactyl\Exceptions\JexactylException;

class DatabaseClientFeatureNotEnabledException extends JexactylException
{
    public function __construct()
    {
        parent::__construct('Client database creation is not enabled in this Panel.');
    }
}
</file>

<file path="app/Exceptions/Service/Database/NoSuitableDatabaseHostException.php">
<?php

namespace Jexactyl\Exceptions\Service\Database;

use Jexactyl\Exceptions\DisplayException;

class NoSuitableDatabaseHostException extends DisplayException
{
    /**
     * NoSuitableDatabaseHostException constructor.
     */
    public function __construct()
    {
        parent::__construct('No database host was found that meets the requirements for this server.');
    }
}
</file>

<file path="app/Exceptions/Service/Database/TooManyDatabasesException.php">
<?php

namespace Jexactyl\Exceptions\Service\Database;

use Jexactyl\Exceptions\DisplayException;

class TooManyDatabasesException extends DisplayException
{
    public function __construct()
    {
        parent::__construct('Operation aborted: creating a new database would put this server over the defined limit.');
    }
}
</file>

<file path="app/Exceptions/Service/Deployment/NoViableAllocationException.php">
<?php

namespace Jexactyl\Exceptions\Service\Deployment;

use Jexactyl\Exceptions\DisplayException;

class NoViableAllocationException extends DisplayException
{
}
</file>

<file path="app/Exceptions/Service/Deployment/NoViableNodeException.php">
<?php

namespace Jexactyl\Exceptions\Service\Deployment;

use Jexactyl\Exceptions\DisplayException;

class NoViableNodeException extends DisplayException
{
}
</file>

<file path="app/Exceptions/Service/Egg/Variable/BadValidationRuleException.php">
<?php

namespace Jexactyl\Exceptions\Service\Egg\Variable;

use Jexactyl\Exceptions\DisplayException;

class BadValidationRuleException extends DisplayException
{
}
</file>

<file path="app/Exceptions/Service/Egg/Variable/ReservedVariableNameException.php">
<?php

namespace Jexactyl\Exceptions\Service\Egg\Variable;

use Jexactyl\Exceptions\DisplayException;

class ReservedVariableNameException extends DisplayException
{
}
</file>

<file path="app/Exceptions/Service/Egg/BadJsonFormatException.php">
<?php

namespace Jexactyl\Exceptions\Service\Egg;

use Jexactyl\Exceptions\DisplayException;

class BadJsonFormatException extends DisplayException
{
}
</file>

<file path="app/Exceptions/Service/Egg/HasChildrenException.php">
<?php

namespace Jexactyl\Exceptions\Service\Egg;

use Jexactyl\Exceptions\DisplayException;

class HasChildrenException extends DisplayException
{
}
</file>

<file path="app/Exceptions/Service/Egg/InvalidCopyFromException.php">
<?php

namespace Jexactyl\Exceptions\Service\Egg;

use Jexactyl\Exceptions\DisplayException;

class InvalidCopyFromException extends DisplayException
{
}
</file>

<file path="app/Exceptions/Service/Egg/NoParentConfigurationFoundException.php">
<?php

namespace Jexactyl\Exceptions\Service\Egg;

use Jexactyl\Exceptions\DisplayException;

class NoParentConfigurationFoundException extends DisplayException
{
}
</file>

<file path="app/Exceptions/Service/Helper/CdnVersionFetchingException.php">
<?php

namespace Jexactyl\Exceptions\Service\Helper;

class CdnVersionFetchingException extends \Exception
{
}
</file>

<file path="app/Exceptions/Service/Location/HasActiveNodesException.php">
<?php

namespace Jexactyl\Exceptions\Service\Location;

use Illuminate\Http\Response;
use Jexactyl\Exceptions\DisplayException;

class HasActiveNodesException extends DisplayException
{
    public function getStatusCode(): int
    {
        return Response::HTTP_BAD_REQUEST;
    }
}
</file>

<file path="app/Exceptions/Service/Node/ConfigurationNotPersistedException.php">
<?php

namespace Jexactyl\Exceptions\Service\Node;

use Jexactyl\Exceptions\DisplayException;

class ConfigurationNotPersistedException extends DisplayException
{
}
</file>

<file path="app/Exceptions/Service/Schedule/Task/TaskIntervalTooLongException.php">
<?php

namespace Jexactyl\Exceptions\Service\Schedule\Task;

use Jexactyl\Exceptions\DisplayException;

class TaskIntervalTooLongException extends DisplayException
{
}
</file>

<file path="app/Exceptions/Service/Server/RequiredVariableMissingException.php">
<?php

namespace Jexactyl\Exceptions\Service\Server;

use Jexactyl\Exceptions\JexactylException;

class RequiredVariableMissingException extends JexactylException
{
}
</file>

<file path="app/Exceptions/Service/Subuser/ServerSubuserExistsException.php">
<?php

namespace Jexactyl\Exceptions\Service\Subuser;

use Jexactyl\Exceptions\DisplayException;

class ServerSubuserExistsException extends DisplayException
{
}
</file>

<file path="app/Exceptions/Service/Subuser/UserIsServerOwnerException.php">
<?php

namespace Jexactyl\Exceptions\Service\Subuser;

use Jexactyl\Exceptions\DisplayException;

class UserIsServerOwnerException extends DisplayException
{
}
</file>

<file path="app/Exceptions/Service/User/TwoFactorAuthenticationTokenInvalid.php">
<?php

namespace Jexactyl\Exceptions\Service\User;

use Jexactyl\Exceptions\DisplayException;

class TwoFactorAuthenticationTokenInvalid extends DisplayException
{
    /**
     * TwoFactorAuthenticationTokenInvalid constructor.
     */
    public function __construct()
    {
        parent::__construct('The provided two-factor authentication token was not valid.');
    }
}
</file>

<file path="app/Exceptions/Service/HasActiveServersException.php">
<?php

namespace Jexactyl\Exceptions\Service;

use Illuminate\Http\Response;
use Jexactyl\Exceptions\DisplayException;

class HasActiveServersException extends DisplayException
{
    public function getStatusCode(): int
    {
        return Response::HTTP_BAD_REQUEST;
    }
}
</file>

<file path="app/Exceptions/Service/InvalidFileUploadException.php">
<?php

namespace Jexactyl\Exceptions\Service;

use Jexactyl\Exceptions\DisplayException;

class InvalidFileUploadException extends DisplayException
{
}
</file>

<file path="app/Exceptions/Service/ServiceLimitExceededException.php">
<?php

namespace Jexactyl\Exceptions\Service;

use Jexactyl\Exceptions\DisplayException;

class ServiceLimitExceededException extends DisplayException
{
    /**
     * Exception thrown when something goes over a defined limit, such as allocated
     * ports, tasks, databases, etc.
     */
    public function __construct(string $message, \Throwable $previous = null)
    {
        parent::__construct($message, $previous, self::LEVEL_WARNING);
    }
}
</file>

<file path="app/Exceptions/Solutions/ManifestDoesNotExistSolution.php">
<?php

namespace Jexactyl\Exceptions\Solutions;

use Spatie\Ignition\Contracts\Solution;

class ManifestDoesNotExistSolution implements Solution
{
    public function getSolutionTitle(): string
    {
        return "The manifest.json file hasn't been generated yet";
    }

    public function getSolutionDescription(): string
    {
        return 'Run yarn run build:production to build the frontend first.';
    }

    public function getDocumentationLinks(): array
    {
        return [
            'Docs' => 'https://github.com/Jexactyl/Jexactyl/blob/develop/package.json',
        ];
    }
}
</file>

<file path="app/Exceptions/Transformer/InvalidTransformerLevelException.php">
<?php

namespace Jexactyl\Exceptions\Transformer;

use Jexactyl\Exceptions\JexactylException;

class InvalidTransformerLevelException extends JexactylException
{
}
</file>

<file path="app/Exceptions/AccountNotFoundException.php">
<?php

namespace Jexactyl\Exceptions;

class AccountNotFoundException extends \Exception
{
}
</file>

<file path="app/Exceptions/AutoDeploymentException.php">
<?php

namespace Jexactyl\Exceptions;

class AutoDeploymentException extends \Exception
{
}
</file>

<file path="app/Exceptions/DisplayException.php">
<?php

namespace Jexactyl\Exceptions;

use Exception;
use Illuminate\Http\Request;
use Psr\Log\LoggerInterface;
use Illuminate\Http\Response;
use Illuminate\Http\JsonResponse;
use Illuminate\Container\Container;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Symfony\Component\HttpKernel\Exception\HttpExceptionInterface;

class DisplayException extends JexactylException implements HttpExceptionInterface
{
    public const LEVEL_DEBUG = 'debug';
    public const LEVEL_INFO = 'info';
    public const LEVEL_WARNING = 'warning';
    public const LEVEL_ERROR = 'error';

    /**
     * DisplayException constructor.
     */
    public function __construct(string $message, ?\Throwable $previous = null, protected string $level = self::LEVEL_ERROR, int $code = 0)
    {
        parent::__construct($message, $code, $previous);
    }

    public function getErrorLevel(): string
    {
        return $this->level;
    }

    public function getStatusCode(): int
    {
        return Response::HTTP_BAD_REQUEST;
    }

    public function getHeaders(): array
    {
        return [];
    }

    /**
     * Render the exception to the user by adding a flashed message to the session
     * and then redirecting them back to the page that they came from. If the
     * request originated from an API hit, return the error in JSONAPI spec format.
     */
    public function render(Request $request): JsonResponse|RedirectResponse
    {
        if ($request->expectsJson()) {
            return response()->json(Handler::toArray($this), $this->getStatusCode(), $this->getHeaders());
        }

        app(AlertsMessageBag::class)->danger($this->getMessage())->flash();

        return redirect()->back()->withInput();
    }

    /**
     * Log the exception to the logs using the defined error level only if the previous
     * exception is set.
     *
     * @throws \Throwable
     */
    public function report()
    {
        if (!$this->getPrevious() instanceof \Exception || !Handler::isReportable($this->getPrevious())) {
            return null;
        }

        try {
            $logger = Container::getInstance()->make(LoggerInterface::class);
        } catch (Exception) {
            throw $this->getPrevious();
        }

        return $logger->{$this->getErrorLevel()}($this->getPrevious());
    }
}
</file>

<file path="app/Exceptions/Handler.php">
<?php

namespace Jexactyl\Exceptions;

use Exception;
use Illuminate\Support\Arr;
use Illuminate\Support\Str;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Collection;
use Illuminate\Container\Container;
use Illuminate\Database\Connection;
use Illuminate\Http\RedirectResponse;
use Illuminate\Foundation\Application;
use Illuminate\Auth\AuthenticationException;
use Illuminate\Session\TokenMismatchException;
use Illuminate\Validation\ValidationException;
use Symfony\Component\HttpFoundation\Response;
use Illuminate\Auth\Access\AuthorizationException;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Symfony\Component\HttpKernel\Exception\HttpException;
use Symfony\Component\Mailer\Exception\TransportException;
use Jexactyl\Exceptions\Repository\RecordNotFoundException;
use Illuminate\Foundation\Exceptions\Handler as ExceptionHandler;
use Symfony\Component\HttpKernel\Exception\HttpExceptionInterface;

class Handler extends ExceptionHandler
{
    /**
     * The validation parser in Laravel formats custom rules using the class name
     * resulting in some weird rule names. This string will be parsed out and
     * replaced with 'p_' in the response code.
     */
    private const JEXACTYL_RULE_STRING = 'jexactyl\_rules\_';

    /**
     * A list of the exception types that should not be reported.
     */
    protected $dontReport = [
        AuthenticationException::class,
        AuthorizationException::class,
        HttpException::class,
        ModelNotFoundException::class,
        RecordNotFoundException::class,
        TokenMismatchException::class,
        ValidationException::class,
    ];

    /**
     * Maps exceptions to a specific response code. This handles special exception
     * types that don't have a defined response code.
     */
    protected static array $exceptionResponseCodes = [
        AuthenticationException::class => 401,
        AuthorizationException::class => 403,
        ValidationException::class => 422,
    ];

    /**
     * A list of the inputs that are never flashed for validation exceptions.
     */
    protected $dontFlash = [
        'token',
        'secret',
        'password',
        'password_confirmation',
    ];

    /**
     * Registers the exception handling callbacks for the application. This
     * will capture specific exception types that we do not want to include
     * the detailed stack traces for since they could reveal credentials to
     * whoever can read the logs.
     *
     * @noinspection PhpUnusedLocalVariableInspection
     */
    public function register()
    {
        if (config('app.exceptions.report_all', false)) {
            $this->dontReport = [];
        }

        $this->reportable(function (\PDOException $ex) {
            $ex = $this->generateCleanedExceptionStack($ex);
        });

        $this->reportable(function (TransportException $ex) {
            $ex = $this->generateCleanedExceptionStack($ex);
        });
    }

    private function generateCleanedExceptionStack(\Throwable $exception): string
    {
        $cleanedStack = '';
        foreach ($exception->getTrace() as $index => $item) {
            $cleanedStack .= sprintf(
                "#%d %s(%d): %s%s%s\n",
                $index,
                Arr::get($item, 'file'),
                Arr::get($item, 'line'),
                Arr::get($item, 'class'),
                Arr::get($item, 'type'),
                Arr::get($item, 'function')
            );
        }

        $message = sprintf(
            '%s: %s in %s:%d',
            class_basename($exception),
            $exception->getMessage(),
            $exception->getFile(),
            $exception->getLine()
        );

        return $message . "\nStack trace:\n" . trim($cleanedStack);
    }

    /**
     * Render an exception into an HTTP response.
     *
     * @param \Illuminate\Http\Request $request
     *
     * @throws \Throwable
     */
    public function render($request, \Throwable $e): Response
    {
        $connections = $this->container->make(Connection::class);

        // If we are currently wrapped up inside a transaction, we will roll all the way
        // back to the beginning. This needs to happen, otherwise session data does not
        // get properly persisted.
        //
        // This is kind of a hack, and ideally things like this should be handled as
        // much as possible at the code level, but there are a lot of spots that do a
        // ton of actions and were written before this bug discovery was made.
        //
        // @see https://github.com/pteroactyl/panel/pull/1468
        if ($connections->transactionLevel()) {
            $connections->rollBack(0);
        }

        return parent::render($request, $e);
    }

    /**
     * Transform a validation exception into a consistent format to be returned for
     * calls to the API.
     *
     * @param \Illuminate\Http\Request $request
     */
    public function invalidJson($request, ValidationException $exception): JsonResponse
    {
        $codes = Collection::make($exception->validator->failed())->mapWithKeys(function ($reasons, $field) {
            $cleaned = [];
            foreach ($reasons as $reason => $attrs) {
                $cleaned[] = Str::snake($reason);
            }

            return [str_replace('.', '_', $field) => $cleaned];
        })->toArray();

        $errors = Collection::make($exception->errors())->map(function ($errors, $field) use ($codes, $exception) {
            $response = [];
            foreach ($errors as $key => $error) {
                $meta = [
                    'source_field' => $field,
                    'rule' => str_replace(self::JEXACTYL_RULE_STRING, 'p_', Arr::get(
                        $codes,
                        str_replace('.', '_', $field) . '.' . $key
                    )),
                ];

                $converted = $this->convertExceptionToArray($exception)['errors'][0];
                $converted['detail'] = $error;
                $converted['meta'] = array_merge($converted['meta'] ?? [], $meta);

                $response[] = $converted;
            }

            return $response;
        })->flatMap(function ($errors) {
            return $errors;
        })->toArray();

        return response()->json(['errors' => $errors], $exception->status);
    }

    /**
     * Return the exception as a JSONAPI representation for use on API requests.
     */
    protected function convertExceptionToArray(\Throwable $e, array $override = []): array
    {
        $match = self::$exceptionResponseCodes[get_class($e)] ?? null;

        $error = [
            'code' => class_basename($e),
            'status' => method_exists($e, 'getStatusCode')
                ? strval($e->getStatusCode())
                : strval($match ?? '500'),
            'detail' => $e instanceof HttpExceptionInterface || !is_null($match)
                ? $e->getMessage()
                : 'An unexpected error was encountered while processing this request, please try again.',
        ];

        if ($e instanceof ModelNotFoundException || $e->getPrevious() instanceof ModelNotFoundException) {
            // Show a nicer error message compared to the standard "No query results for model"
            // response that is normally returned. If we are in debug mode this will get overwritten
            // with a more specific error message to help narrow down things.
            $error['detail'] = 'The requested resource could not be found on the server.';
        }

        if (config('app.debug')) {
            $error = array_merge($error, [
                'detail' => $e->getMessage(),
                'source' => [
                    'line' => $e->getLine(),
                    'file' => str_replace(Application::getInstance()->basePath(), '', $e->getFile()),
                ],
                'meta' => [
                    'trace' => Collection::make($e->getTrace())
                        ->map(fn ($trace) => Arr::except($trace, ['args']))
                        ->all(),
                    'previous' => Collection::make($this->extractPrevious($e))
                        ->map(fn ($exception) => $e->getTrace())
                        ->map(fn ($trace) => Arr::except($trace, ['args']))
                        ->all(),
                ],
            ]);
        }

        return ['errors' => [array_merge($error, $override)]];
    }

    /**
     * Return an array of exceptions that should not be reported.
     */
    public static function isReportable(\Exception $exception): bool
    {
        return (new static(Container::getInstance()))->shouldReport($exception);
    }

    /**
     * Convert an authentication exception into an unauthenticated response.
     *
     * @param \Illuminate\Http\Request $request
     */
    protected function unauthenticated($request, AuthenticationException $exception): JsonResponse|RedirectResponse
    {
        if ($request->expectsJson()) {
            return new JsonResponse($this->convertExceptionToArray($exception), JsonResponse::HTTP_UNAUTHORIZED);
        }

        return redirect()->guest('/auth/login');
    }

    /**
     * Extracts all the previous exceptions that lead to the one passed into this
     * function being thrown.
     *
     * @return \Throwable[]
     */
    protected function extractPrevious(\Throwable $e): array
    {
        $previous = [];
        while ($value = $e->getPrevious()) {
            if (!$value instanceof \Throwable) {
                break;
            }
            $previous[] = $value;
            $e = $value;
        }

        return $previous;
    }

    /**
     * Helper method to allow reaching into the handler to convert an exception
     * into the expected array response type.
     */
    public static function toArray(\Throwable $e): array
    {
        return (new self(app()))->convertExceptionToArray($e);
    }
}
</file>

<file path="app/Exceptions/JexactylException.php">
<?php

namespace Jexactyl\Exceptions;

class JexactylException extends \Exception
{
}
</file>

<file path="app/Exceptions/ManifestDoesNotExistException.php">
<?php

namespace Jexactyl\Exceptions;

use Spatie\Ignition\Contracts\Solution;
use Spatie\Ignition\Contracts\ProvidesSolution;

class ManifestDoesNotExistException extends \Exception implements ProvidesSolution
{
    public function getSolution(): Solution
    {
        return new Solutions\ManifestDoesNotExistSolution();
    }
}
</file>

<file path="app/Extensions/Backups/BackupManager.php">
<?php

namespace Jexactyl\Extensions\Backups;

use Closure;
use Aws\S3\S3Client;
use Illuminate\Support\Arr;
use Illuminate\Support\Str;
use Webmozart\Assert\Assert;
use Illuminate\Foundation\Application;
use League\Flysystem\FilesystemAdapter;
use Jexactyl\Extensions\Filesystem\S3Filesystem;
use League\Flysystem\InMemory\InMemoryFilesystemAdapter;
use Illuminate\Contracts\Config\Repository as ConfigRepository;

class BackupManager
{
    protected ConfigRepository $config;

    /**
     * The array of resolved backup drivers.
     */
    protected array $adapters = [];

    /**
     * The registered custom driver creators.
     */
    protected array $customCreators;

    /**
     * BackupManager constructor.
     */
    public function __construct(protected Application $app)
    {
        $this->config = $app->make(ConfigRepository::class);
    }

    /**
     * Returns a backup adapter instance.
     */
    public function adapter(string $name = null): FilesystemAdapter
    {
        return $this->get($name ?: $this->getDefaultAdapter());
    }

    /**
     * Set the given backup adapter instance.
     */
    public function set(string $name, FilesystemAdapter $disk): self
    {
        $this->adapters[$name] = $disk;

        return $this;
    }

    /**
     * Gets a backup adapter.
     */
    protected function get(string $name): FilesystemAdapter
    {
        return $this->adapters[$name] = $this->resolve($name);
    }

    /**
     * Resolve the given backup disk.
     */
    protected function resolve(string $name): FilesystemAdapter
    {
        $config = $this->getConfig($name);

        if (empty($config['adapter'])) {
            throw new \InvalidArgumentException("Backup disk [$name] does not have a configured adapter.");
        }

        $adapter = $config['adapter'];

        if (isset($this->customCreators[$name])) {
            return $this->callCustomCreator($config);
        }

        $adapterMethod = 'create' . Str::studly($adapter) . 'Adapter';
        if (method_exists($this, $adapterMethod)) {
            $instance = $this->{$adapterMethod}($config);

            Assert::isInstanceOf($instance, FilesystemAdapter::class);

            return $instance;
        }

        throw new \InvalidArgumentException("Adapter [$adapter] is not supported.");
    }

    /**
     * Calls a custom creator for a given adapter type.
     */
    protected function callCustomCreator(array $config): mixed
    {
        return $this->customCreators[$config['adapter']]($this->app, $config);
    }

    /**
     * Creates a new Wings adapter.
     */
    public function createWingsAdapter(array $config): FilesystemAdapter
    {
        return new InMemoryFilesystemAdapter();
    }

    /**
     * Creates a new S3 adapter.
     */
    public function createS3Adapter(array $config): FilesystemAdapter
    {
        $config['version'] = 'latest';

        if (!empty($config['key']) && !empty($config['secret'])) {
            $config['credentials'] = Arr::only($config, ['key', 'secret', 'token']);
        }

        $client = new S3Client($config);

        return new S3Filesystem($client, $config['bucket'], $config['prefix'] ?? '', $config['options'] ?? []);
    }

    /**
     * Returns the configuration associated with a given backup type.
     */
    protected function getConfig(string $name): array
    {
        return $this->config->get("backups.disks.$name") ?: [];
    }

    /**
     * Get the default backup driver name.
     */
    public function getDefaultAdapter(): string
    {
        return $this->config->get('backups.default');
    }

    /**
     * Set the default session driver name.
     */
    public function setDefaultAdapter(string $name): void
    {
        $this->config->set('backups.default', $name);
    }

    /**
     * Unset the given adapter instances.
     *
     * @param string|string[] $adapter
     */
    public function forget(array|string $adapter): self
    {
        foreach ((array) $adapter as $adapterName) {
            unset($this->adapters[$adapterName]);
        }

        return $this;
    }

    /**
     * Register a custom adapter creator closure.
     */
    public function extend(string $adapter, \Closure $callback): self
    {
        $this->customCreators[$adapter] = $callback;

        return $this;
    }
}
</file>

<file path="app/Extensions/Facades/Theme.php">
<?php

namespace Jexactyl\Extensions\Facades;

use Illuminate\Support\Facades\Facade;

class Theme extends Facade
{
    protected static function getFacadeAccessor(): string
    {
        return 'extensions.themes';
    }
}
</file>

<file path="app/Extensions/Filesystem/S3Filesystem.php">
<?php

namespace Jexactyl\Extensions\Filesystem;

use Aws\S3\S3ClientInterface;
use League\Flysystem\AwsS3V3\AwsS3V3Adapter;

class S3Filesystem extends AwsS3V3Adapter
{
    public function __construct(
        private S3ClientInterface $client,
        private string $bucket,
        string $prefix = '',
        array $options = [],
    ) {
        parent::__construct(
            $client,
            $bucket,
            $prefix,
            null,
            null,
            $options,
        );
    }

    public function getClient(): S3ClientInterface
    {
        return $this->client;
    }

    public function getBucket(): string
    {
        return $this->bucket;
    }
}
</file>

<file path="app/Extensions/Illuminate/Database/Eloquent/Builder.php">
<?php

namespace Jexactyl\Extensions\Illuminate\Database\Eloquent;

use Illuminate\Database\Eloquent\Builder as EloquentBuilder;

class Builder extends EloquentBuilder
{
    /**
     * Do nothing.
     */
    public function search(): self
    {
        return $this;
    }
}
</file>

<file path="app/Extensions/Illuminate/Events/Contracts/SubscribesToEvents.php">
<?php

namespace Jexactyl\Extensions\Illuminate\Events\Contracts;

use Illuminate\Contracts\Events\Dispatcher;

interface SubscribesToEvents
{
    public function subscribe(Dispatcher $events): void;
}
</file>

<file path="app/Extensions/Laravel/Sanctum/NewAccessToken.php">
<?php

namespace Jexactyl\Extensions\Laravel\Sanctum;

use Jexactyl\Models\ApiKey;
use Laravel\Sanctum\NewAccessToken as SanctumAccessToken;

/**
 * @property \Jexactyl\Models\ApiKey $accessToken
 */
class NewAccessToken extends SanctumAccessToken
{
    /**
     * NewAccessToken constructor.
     *
     * @noinspection PhpMissingParentConstructorInspection
     */
    public function __construct(ApiKey $accessToken, string $plainTextToken)
    {
        $this->accessToken = $accessToken;
        $this->plainTextToken = $plainTextToken;
    }
}
</file>

<file path="app/Extensions/Lcobucci/JWT/Encoding/TimestampDates.php">
<?php

namespace Jexactyl\Extensions\Lcobucci\JWT\Encoding;

use Lcobucci\JWT\ClaimsFormatter;
use Lcobucci\JWT\Token\RegisteredClaims;

final class TimestampDates implements ClaimsFormatter
{
    /**
     * The default time encoder for JWTs using this library is not supported correctly
     * by Wings and will cause a flood of errors and panic conditions because the times
     * cannot be parsed correctly. The default is time with microseconds, we just need
     * to use the normal unix timestamp here.
     */
    public function formatClaims(array $claims): array
    {
        foreach (RegisteredClaims::DATE_CLAIMS as $claim) {
            if (!array_key_exists($claim, $claims)) {
                continue;
            }

            assert($claims[$claim] instanceof \DateTimeImmutable);
            $claims[$claim] = $claims[$claim]->getTimestamp();
        }

        return $claims;
    }
}
</file>

<file path="app/Extensions/League/Fractal/Serializers/JexactylSerializer.php">
<?php

namespace Jexactyl\Extensions\League\Fractal\Serializers;

use League\Fractal\Serializer\ArraySerializer;

class JexactylSerializer extends ArraySerializer
{
    /**
     * Serialize an item.
     */
    public function item(?string $resourceKey, array $data): array
    {
        return [
            'object' => $resourceKey,
            'attributes' => $data,
        ];
    }

    /**
     * Serialize a collection.
     */
    public function collection(?string $resourceKey, array $data): array
    {
        $response = [];
        foreach ($data as $datum) {
            $response[] = $this->item($resourceKey, $datum);
        }

        return [
            'object' => 'list',
            'data' => $response,
        ];
    }

    /**
     * Serialize a null resource.
     */
    public function null(): ?array
    {
        return [
            'object' => 'null_resource',
            'attributes' => null,
        ];
    }

    /**
     * Merge the included resources with the parent resource being serialized.
     */
    public function mergeIncludes(array $transformedData, array $includedData): array
    {
        foreach ($includedData as $key => $datum) {
            $transformedData['relationships'][$key] = $datum;
        }

        return $transformedData;
    }
}
</file>

<file path="app/Extensions/Spatie/Fractalistic/Fractal.php">
<?php

namespace Jexactyl\Extensions\Spatie\Fractalistic;

use League\Fractal\Scope;
use League\Fractal\TransformerAbstract;
use Spatie\Fractal\Fractal as SpatieFractal;
use Illuminate\Contracts\Pagination\LengthAwarePaginator;
use League\Fractal\Pagination\IlluminatePaginatorAdapter;
use Jexactyl\Extensions\League\Fractal\Serializers\JexactylSerializer;

class Fractal extends SpatieFractal
{
    /**
     * Create fractal data.
     *
     * @throws \Spatie\Fractalistic\Exceptions\InvalidTransformation
     * @throws \Spatie\Fractalistic\Exceptions\NoTransformerSpecified
     */
    public function createData(): Scope
    {
        // Set the serializer by default.
        if (is_null($this->serializer)) {
            $this->serializer = new JexactylSerializer();
        }

        // Automatically set the paginator on the response object if the
        // data being provided implements a paginator.
        if (is_null($this->paginator) && $this->data instanceof LengthAwarePaginator) {
            $this->paginator = new IlluminatePaginatorAdapter($this->data);
        }

        // If the resource name is not set attempt to pull it off the transformer
        // itself and set it automatically.
        if (
            is_null($this->resourceName)
            && $this->transformer instanceof TransformerAbstract
            && method_exists($this->transformer, 'getResourceName')
        ) {
            $this->resourceName = $this->transformer->getResourceName();
        }

        return parent::createData();
    }
}
</file>

<file path="app/Extensions/Themes/Theme.php">
<?php

namespace Jexactyl\Extensions\Themes;

class Theme
{
    public function js($path): string
    {
        return sprintf('<script src="%s"></script>' . PHP_EOL, $this->getUrl($path));
    }

    public function css($path): string
    {
        return sprintf('<link media="all" type="text/css" rel="stylesheet" href="%s"/>' . PHP_EOL, $this->getUrl($path));
    }

    protected function getUrl($path): string
    {
        return '/themes/default/' . ltrim($path, '/');
    }
}
</file>

<file path="app/Extensions/DynamicDatabaseConnection.php">
<?php

namespace Jexactyl\Extensions;

use Jexactyl\Models\DatabaseHost;
use Illuminate\Contracts\Encryption\Encrypter;
use Illuminate\Config\Repository as ConfigRepository;
use Jexactyl\Contracts\Repository\DatabaseHostRepositoryInterface;

class DynamicDatabaseConnection
{
    public const DB_CHARSET = 'utf8';
    public const DB_COLLATION = 'utf8_unicode_ci';
    public const DB_DRIVER = 'mysql';

    /**
     * DynamicDatabaseConnection constructor.
     */
    public function __construct(
        protected ConfigRepository $config,
        protected Encrypter $encrypter,
        protected DatabaseHostRepositoryInterface $repository
    ) {
    }

    /**
     * Adds a dynamic database connection entry to the runtime config.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function set(string $connection, DatabaseHost|int $host, string $database = 'mysql'): void
    {
        if (!$host instanceof DatabaseHost) {
            $host = $this->repository->find($host);
        }

        $this->config->set('database.connections.' . $connection, [
            'driver' => self::DB_DRIVER,
            'host' => $host->host,
            'port' => $host->port,
            'database' => $database,
            'username' => $host->username,
            'password' => $this->encrypter->decrypt($host->password),
            'charset' => self::DB_CHARSET,
            'collation' => self::DB_COLLATION,
        ]);
    }
}
</file>

<file path="app/Extensions/Hashids.php">
<?php

namespace Jexactyl\Extensions;

use Hashids\Hashids as VendorHashids;
use Jexactyl\Contracts\Extensions\HashidsInterface;

class Hashids extends VendorHashids implements HashidsInterface
{
    /**
     * {@inheritdoc}
     */
    public function decodeFirst(string $encoded, string $default = null): mixed
    {
        $result = $this->decode($encoded);
        if (!is_array($result)) {
            return $default;
        }

        return array_first($result, null, $default);
    }
}
</file>

<file path="app/Facades/Activity.php">
<?php

namespace Jexactyl\Facades;

use Illuminate\Support\Facades\Facade;
use Jexactyl\Services\Activity\ActivityLogService;

class Activity extends Facade
{
    protected static function getFacadeAccessor(): string
    {
        return ActivityLogService::class;
    }
}
</file>

<file path="app/Facades/LogBatch.php">
<?php

namespace Jexactyl\Facades;

use Illuminate\Support\Facades\Facade;
use Jexactyl\Services\Activity\ActivityLogBatchService;

class LogBatch extends Facade
{
    protected static function getFacadeAccessor(): string
    {
        return ActivityLogBatchService::class;
    }
}
</file>

<file path="app/Facades/LogTarget.php">
<?php

namespace Jexactyl\Facades;

use Illuminate\Support\Facades\Facade;
use Jexactyl\Services\Activity\ActivityLogTargetableService;

class LogTarget extends Facade
{
    protected static function getFacadeAccessor(): string
    {
        return ActivityLogTargetableService::class;
    }
}
</file>

<file path="app/Helpers/Time.php">
<?php

namespace Jexactyl\Helpers;

use Carbon\CarbonImmutable;

final class Time
{
    /**
     * Gets the time offset from the provided timezone relative to UTC as a number. This
     * is used in the database configuration since we can't always rely on there being support
     * for named timezones in MySQL.
     *
     * Returns the timezone as a string like +08:00 or -05:00 depending on the app timezone.
     */
    public static function getMySQLTimezoneOffset(string $timezone): string
    {
        $offset = round(CarbonImmutable::now($timezone)->getTimezone()->getOffset(CarbonImmutable::now('UTC')) / 3600);

        return sprintf('%s%s:00', $offset > 0 ? '+' : '-', str_pad((string) abs($offset), 2, '0', STR_PAD_LEFT));
    }
}
</file>

<file path="app/Helpers/Utilities.php">
<?php

namespace Jexactyl\Helpers;

use Carbon\Carbon;
use Cron\CronExpression;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\ViewErrorBag;

class Utilities
{
    /**
     * Generates a random string and injects special characters into it, in addition to
     * the randomness of the alphanumeric default response.
     */
    public static function randomStringWithSpecialCharacters(int $length = 16): string
    {
        $string = str_random($length);
        // Given a random string of characters, randomly loop through the characters and replace some
        // with special characters to avoid issues with MySQL password requirements on some servers.
        try {
            for ($i = 0; $i < random_int(2, 6); ++$i) {
                $character = ['!', '@', '=', '.', '+', '^'][random_int(0, 5)];

                $string = substr_replace($string, $character, random_int(0, $length - 1), 1);
            }
        } catch (\Exception $exception) {
            // Just log the error and hope for the best at this point.
            Log::error($exception);
        }

        return $string;
    }

    /**
     * Converts schedule cron data into a carbon object.
     *
     * @throws \Exception
     */
    public static function getScheduleNextRunDate(string $minute, string $hour, string $dayOfMonth, string $month, string $dayOfWeek): Carbon
    {
        return Carbon::instance((new CronExpression(
            sprintf('%s %s %s %s %s', $minute, $hour, $dayOfMonth, $month, $dayOfWeek)
        ))->getNextRunDate());
    }

    public static function checked(string $name, mixed $default): string
    {
        $errors = session('errors');

        if (isset($errors) && $errors instanceof ViewErrorBag && $errors->any()) {
            return old($name) ? 'checked' : '';
        }

        return ($default) ? 'checked' : '';
    }
}
</file>

<file path="app/Http/Controllers/Admin/Jexactyl/AdvancedController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Jexactyl;

use Illuminate\View\View;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Illuminate\Contracts\Console\Kernel;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\View\Factory as ViewFactory;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;
use Jexactyl\Http\Requests\Admin\Jexactyl\AdvancedFormRequest;
use Illuminate\Contracts\Config\Repository as ConfigRepository;

class AdvancedController extends Controller
{
    /**
     * AdvancedController constructor.
     */
    public function __construct(
        private AlertsMessageBag $alert,
        private ConfigRepository $config,
        private Kernel $kernel,
        private SettingsRepositoryInterface $settings,
        private ViewFactory $view
    ) {
    }

    /**
     * Render advanced Panel settings UI.
     */
    public function index(): View
    {
        $warning = false;

        if (
            $this->config->get('recaptcha._shipped_secret_key') == $this->config->get('recaptcha.secret_key')
            || $this->config->get('recaptcha._shipped_website_key') == $this->config->get('recaptcha.website_key')
        ) {
            $warning = true;
        }

        return $this->view->make('admin.jexactyl.advanced', [
            'warning' => $warning,
            'logo' => $this->settings->get('settings::app:logo', 'https://avatars.githubusercontent.com/u/91636558'),
        ]);
    }

    /**
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(AdvancedFormRequest $request): RedirectResponse
    {
        foreach ($request->normalize() as $key => $value) {
            $this->settings->set('settings::' . $key, $value);
        }

        $this->kernel->call('queue:restart');
        $this->alert->success('Advanced settings have been updated successfully and the queue worker was restarted to apply these changes.')->flash();

        return redirect()->route('admin.jexactyl.advanced');
    }
}
</file>

<file path="app/Http/Controllers/Admin/Jexactyl/AlertsController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Jexactyl;

use Illuminate\View\View;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Exceptions\Model\DataValidationException;
use Jexactyl\Exceptions\Repository\RecordNotFoundException;
use Jexactyl\Http\Requests\Admin\Jexactyl\AlertFormRequest;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;

class AlertsController extends Controller
{
    /**
     * AppearanceController constructor.
     */
    public function __construct(
        private AlertsMessageBag $alert,
        private SettingsRepositoryInterface $settings
    ) {
    }

    /**
     * Render the Jexactyl settings interface.
     */
    public function index(): View
    {
        return view('admin.jexactyl.alerts', [
            'type' => $this->settings->get('jexactyl::alert:type', 'success'),
            'message' => $this->settings->get('jexactyl::alert:message'),
        ]);
    }

    /**
     * Update or create an alert.
     *
     * @throws DataValidationException|RecordNotFoundException
     */
    public function update(AlertFormRequest $request): RedirectResponse
    {
        foreach ($request->normalize() as $key => $value) {
            $this->settings->set('jexactyl::' . $key, $value);
        }

        $this->alert->success('Jexactyl Alert has been updated.')->flash();

        return redirect()->route('admin.jexactyl.alerts');
    }

    /**
     * Delete the current alert.
     */
    public function remove(): RedirectResponse
    {
        $this->settings->forget('jexactyl::alert:type');
        $this->settings->forget('jexactyl::alert:message');

        $this->alert->success('Jexactyl Alert has been removed.')->flash();

        return redirect()->route('admin.jexactyl.alerts');
    }
}
</file>

<file path="app/Http/Controllers/Admin/Jexactyl/AppearanceController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Jexactyl;

use Illuminate\View\View;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\Contracts\Config\Repository;
use Jexactyl\Exceptions\Model\DataValidationException;
use Jexactyl\Exceptions\Repository\RecordNotFoundException;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;
use Jexactyl\Http\Requests\Admin\Jexactyl\AppearanceFormRequest;

class AppearanceController extends Controller
{
    /**
     * AppearanceController constructor.
     */
    public function __construct(
        private Repository $config,
        private AlertsMessageBag $alert,
        private SettingsRepositoryInterface $settings
    ) {
    }

    /**
     * Render the Jexactyl settings interface.
     */
    public function index(): View
    {
        return view('admin.jexactyl.appearance', [
            'name' => config('app.name'),
            'logo' => config('app.logo'),

            'admin' => config('theme.admin'),
            'user' => ['background' => config('theme.user.background')],
        ]);
    }

    /**
     * Handle settings update.
     *
     * @throws DataValidationException|RecordNotFoundException
     */
    public function update(AppearanceFormRequest $request): RedirectResponse
    {
        foreach ($request->normalize() as $key => $value) {
            $this->settings->set('settings::' . $key, $value);
        }

        $this->alert->success('Jexactyl Appearance has been updated.')->flash();

        return redirect()->route('admin.jexactyl.appearance');
    }
}
</file>

<file path="app/Http/Controllers/Admin/Jexactyl/ApprovalsController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Jexactyl;

use Illuminate\View\View;
use Jexactyl\Models\User;
use Illuminate\Http\Request;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;
use Jexactyl\Http\Requests\Admin\Jexactyl\ApprovalFormRequest;

class ApprovalsController extends Controller
{
    /**
     * ApprovalsController constructor.
     */
    public function __construct(
        private AlertsMessageBag $alert,
        private SettingsRepositoryInterface $settings,
    ) {
    }

    /**
     * Render the Jexactyl referrals interface.
     */
    public function index(): View
    {
        $users = User::where('approved', false)->get();

        return view('admin.jexactyl.approvals', [
            'enabled' => $this->settings->get('jexactyl::approvals:enabled', false),
            'webhook' => $this->settings->get('jexactyl::approvals:webhook'),
            'users' => $users,
        ]);
    }

    /**
     * Updates the settings for approvals.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(ApprovalFormRequest $request): RedirectResponse
    {
        foreach ($request->normalize() as $key => $value) {
            $this->settings->set('jexactyl::approvals:' . $key, $value);
        }

        $this->alert->success('Jexactyl Approval settings have been updated.')->flash();

        return redirect()->route('admin.jexactyl.approvals');
    }

    /**
     * Perform a bulk action for approval status.
     */
    public function bulkAction(Request $request, string $action): RedirectResponse
    {
        if ($action === 'approve') {
            User::query()->where('approved', false)->update(['approved' => true]);
        } else {
            try {
                User::query()->where('approved', false)->delete();
            } catch (DisplayException $ex) {
                throw new DisplayException('Unable to complete action: ' . $ex->getMessage());
            }
        }

        $this->alert->success('All users have been ' . $action === 'approve' ? 'approved ' : 'denied successfully.')->flash();

        return redirect()->route('admin.jexactyl.approvals');
    }

    /**
     * Approve an incoming approval request.
     */
    public function approve(Request $request, int $id): RedirectResponse
    {
        $user = User::where('id', $id)->first();
        $user->update(['approved' => true]);
        // This gives the user access to the frontend.

        $this->alert->success($user->username . ' has been approved.')->flash();

        return redirect()->route('admin.jexactyl.approvals');
    }

    /**
     * Deny an incoming approval request.
     */
    public function deny(Request $request, int $id): RedirectResponse
    {
        $user = User::where('id', $id)->first();
        $user->delete();
        // While typically we should look for associated servers, there
        // shouldn't be any present - as the user has been waiting for approval.

        $this->alert->success($user->username . ' has been denied.')->flash();

        return redirect()->route('admin.jexactyl.approvals');
    }
}
</file>

<file path="app/Http/Controllers/Admin/Jexactyl/CouponsController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Jexactyl;

use Carbon\Carbon;
use Illuminate\View\View;
use Jexactyl\Models\Coupon;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Exceptions\Model\DataValidationException;
use Jexactyl\Exceptions\Repository\RecordNotFoundException;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;
use Jexactyl\Http\Requests\Admin\Jexactyl\Coupons\IndexFormRequest;
use Jexactyl\Http\Requests\Admin\Jexactyl\Coupons\StoreFormRequest;

class CouponsController extends Controller
{
    public function __construct(private AlertsMessageBag $alert, private SettingsRepositoryInterface $settings)
    {
    }

    public function index(): View
    {
        return view('admin.jexactyl.coupons', [
            'coupons' => Coupon::all(),
            'enabled' => $this->settings->get('jexactyl::coupons:enabled'),
        ]);
    }

    /**
     * @throws DataValidationException
     * @throws RecordNotFoundException
     */
    public function update(IndexFormRequest $request): RedirectResponse
    {
        foreach ($request->normalize() as $key => $value) {
            $this->settings->set('jexactyl::coupons:' . $key, $value);
        }

        $this->alert->success('The coupons system has been successfully updated.')->flash();

        return redirect()->route('admin.jexactyl.coupons');
    }

    /**
     * @throws DisplayException
     */
    public function store(StoreFormRequest $request): RedirectResponse
    {
        if ($request->input('expires')) {
            $expires_at = Carbon::now()->addHours($request->input('expires'));
        } else {
            $expires_at = null;
        }

        if (Coupon::where(['code' => $request->input('code')])->exists()) {
            throw new DisplayException('You cannot create a coupon with an already existing code.');
        }

        Coupon::query()->insert([
            'expires' => $expires_at,
            'created_at' => Carbon::now(),
            'code' => $request->input('code'),
            'uses' => $request->input('uses'),
            'cr_amount' => $request->input('credits'),
        ]);

        $this->alert->success('Successfully created a coupon.')->flash();

        return redirect()->route('admin.jexactyl.coupons');
    }
}
</file>

<file path="app/Http/Controllers/Admin/Jexactyl/IndexController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Jexactyl;

use Illuminate\View\View;
use Illuminate\Support\Facades\DB;
use Illuminate\Http\RedirectResponse;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Extensions\Spatie\Fractalistic\Fractal;
use Jexactyl\Services\Helpers\SoftwareVersionService;
use Jexactyl\Repositories\Wings\DaemonServerRepository;
use Jexactyl\Traits\Controllers\PlainJavascriptInjection;
use Jexactyl\Contracts\Repository\NodeRepositoryInterface;
use Jexactyl\Contracts\Repository\ServerRepositoryInterface;

class IndexController extends Controller
{
    use PlainJavascriptInjection;

    public function __construct(
        private Fractal $fractal,
        private DaemonServerRepository $repository,
        private SoftwareVersionService $versionService,
        private NodeRepositoryInterface $nodeRepository,
        private ServerRepositoryInterface $serverRepository,
    ) {
    }

    public function index(): View
    {
        $nodes = $this->nodeRepository->all();
        $servers = $this->serverRepository->all();
        $allocations = DB::table('allocations')->count();
        $suspended = DB::table('servers')->where('status', 'suspended')->count();

        $memoryUsed = 0;
        $memoryTotal = 0;
        $diskUsed = 0;
        $diskTotal = 0;

        foreach ($nodes as $node) {
            $stats = $this->nodeRepository->getUsageStatsRaw($node);

            $memoryUsed += $stats['memory']['value'];
            $memoryTotal += $stats['memory']['max'];
            $diskUsed += $stats['disk']['value'];
            $diskTotal += $stats['disk']['max'];
        }

        $this->injectJavascript([
            'servers' => $servers,
            'diskUsed' => $diskUsed,
            'diskTotal' => $diskTotal,
            'suspended' => $suspended,
            'memoryUsed' => $memoryUsed,
            'memoryTotal' => $memoryTotal,
        ]);

        return view('admin.jexactyl.index', [
            'version' => $this->versionService,
            'servers' => $servers,
            'allocations' => $allocations,
            'used' => [
                'memory' => $memoryUsed,
                'disk' => $memoryTotal,
            ],
            'available' => [
                'memory' => $memoryTotal,
                'disk' => $diskTotal,
            ],
        ]);
    }

    /**
     * Handle settings update.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(BaseSettingsFormRequest $request): RedirectResponse
    {
        foreach ($request->normalize() as $key => $value) {
            $this->settings->set('jexactyl::' . $key, $value);
        }

        $this->alert->success('Jexactyl Settings have been updated.')->flash();

        return redirect()->route('admin.settings');
    }
}
</file>

<file path="app/Http/Controllers/Admin/Jexactyl/MailController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Jexactyl;

use Illuminate\View\View;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Jexactyl\Notifications\MailTested;
use Illuminate\Contracts\Console\Kernel;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\View\Factory as ViewFactory;
use Illuminate\Support\Facades\Notification;
use Illuminate\Contracts\Encryption\Encrypter;
use Jexactyl\Providers\SettingsServiceProvider;
use Jexactyl\Http\Requests\Admin\Jexactyl\MailFormRequest;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;
use Illuminate\Contracts\Config\Repository as ConfigRepository;

class MailController extends Controller
{
    /**
     * MailController constructor.
     */
    public function __construct(
        private ConfigRepository $config,
        private Encrypter $encrypter,
        private Kernel $kernel,
        private SettingsRepositoryInterface $settings,
        private ViewFactory $view
    ) {
    }

    /**
     * Render UI for editing mail settings. This UI should only display if
     * the server is configured to send mail using SMTP.
     */
    public function index(): View
    {
        return $this->view->make('admin.jexactyl.mail', [
            'disabled' => $this->config->get('mail.default') !== 'smtp',
        ]);
    }

    /**
     * Handle request to update SMTP mail settings.
     *
     * @throws DisplayException
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(MailFormRequest $request): Response
    {
        if ($this->config->get('mail.default') !== 'smtp') {
            throw new DisplayException('This feature is only available if SMTP is the selected email driver for the Panel.');
        }

        $values = $request->normalize();
        if (array_get($values, 'mail:mailers:smtp:password') === '!e') {
            $values['mail:mailers:smtp:password'] = '';
        }

        foreach ($values as $key => $value) {
            if (in_array($key, SettingsServiceProvider::getEncryptedKeys()) && !empty($value)) {
                $value = $this->encrypter->encrypt($value);
            }

            $this->settings->set('settings::' . $key, $value);
        }

        $this->kernel->call('queue:restart');

        return response('', 204);
    }

    /**
     * Submit a request to send a test mail message.
     */
    public function test(Request $request): Response
    {
        try {
            Notification::route('mail', $request->user()->email)
                ->notify(new MailTested($request->user()));
        } catch (\Exception $exception) {
            return response($exception->getMessage(), 500);
        }

        return response('', 204);
    }
}
</file>

<file path="app/Http/Controllers/Admin/Jexactyl/ReferralsController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Jexactyl;

use Illuminate\View\View;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;
use Jexactyl\Http\Requests\Admin\Jexactyl\ReferralsFormRequest;

class ReferralsController extends Controller
{
    /**
     * RegistrationController constructor.
     */
    public function __construct(
        private AlertsMessageBag $alert,
        private SettingsRepositoryInterface $settings
    ) {
    }

    /**
     * Render the Jexactyl referrals interface.
     */
    public function index(): View
    {
        return view('admin.jexactyl.referrals', [
            'enabled' => $this->settings->get('jexactyl::referrals:enabled', false),
            'reward' => $this->settings->get('jexactyl::referrals:reward', 250),
        ]);
    }

    /**
     * Handle settings update.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(ReferralsFormRequest $request): RedirectResponse
    {
        foreach ($request->normalize() as $key => $value) {
            $this->settings->set('jexactyl::referrals:' . $key, $value);
        }

        $this->alert->success('Referral system has been updated.')->flash();

        return redirect()->route('admin.jexactyl.referrals');
    }
}
</file>

<file path="app/Http/Controllers/Admin/Jexactyl/RegistrationController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Jexactyl;

use Illuminate\View\View;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;
use Jexactyl\Http\Requests\Admin\Jexactyl\RegistrationFormRequest;

class RegistrationController extends Controller
{
    /**
     * RegistrationController constructor.
     */
    public function __construct(
        private AlertsMessageBag $alert,
        private SettingsRepositoryInterface $settings
    ) {
    }

    /**
     * Render the Jexactyl settings interface.
     */
    public function index(): View
    {
        return view('admin.jexactyl.registration', [
            'enabled' => $this->settings->get('jexactyl::registration:enabled', false),
            'verification' => $this->settings->get('jexactyl::registration:verification', false),

            'discord_enabled' => $this->settings->get('jexactyl::discord:enabled', false),
            'discord_id' => $this->settings->get('jexactyl::discord:id', 0),
            'discord_secret' => $this->settings->get('jexactyl::discord:secret', 0),

            'cpu' => $this->settings->get('jexactyl::registration:cpu', 100),
            'memory' => $this->settings->get('jexactyl::registration:memory', 1024),
            'disk' => $this->settings->get('jexactyl::registration:disk', 5120),
            'slot' => $this->settings->get('jexactyl::registration:slot', 1),
            'port' => $this->settings->get('jexactyl::registration:port', 1),
            'backup' => $this->settings->get('jexactyl::registration:backup', 1),
            'database' => $this->settings->get('jexactyl::registration:database', 0),
        ]);
    }

    /**
     * Handle settings update.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(RegistrationFormRequest $request): RedirectResponse
    {
        foreach ($request->normalize() as $key => $value) {
            $this->settings->set('jexactyl::' . $key, $value);
        }

        $this->alert->success('Jexactyl Registration has been updated.')->flash();

        return redirect()->route('admin.jexactyl.registration');
    }
}
</file>

<file path="app/Http/Controllers/Admin/Jexactyl/ServerController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Jexactyl;

use Illuminate\View\View;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Http\Requests\Admin\Jexactyl\ServerFormRequest;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;

class ServerController extends Controller
{
    /**
     * StoreController constructor.
     */
    public function __construct(
        private AlertsMessageBag $alert,
        private SettingsRepositoryInterface $settings
    ) {
    }

    /**
     * Render the Jexactyl settings interface.
     */
    public function index(): View
    {
        $prefix = 'jexactyl::renewal:';

        return view('admin.jexactyl.server', [
            'enabled' => $this->settings->get($prefix . 'enabled', false),
            'default' => $this->settings->get($prefix . 'default', 7),
            'cost' => $this->settings->get($prefix . 'cost', 20),
            'editing' => $this->settings->get($prefix . 'editing', false),
            'deletion' => $this->settings->get($prefix . 'deletion', true),
        ]);
    }

    /**
     * Handle settings update.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(ServerFormRequest $request): RedirectResponse
    {
        foreach ($request->normalize() as $key => $value) {
            $this->settings->set('jexactyl::renewal:' . $key, $value);
        }

        $this->alert->success('Jexactyl Server settings has been updated.')->flash();

        return redirect()->route('admin.jexactyl.server');
    }
}
</file>

<file path="app/Http/Controllers/Admin/Jexactyl/StoreController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Jexactyl;

use Illuminate\View\View;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Exceptions\Model\DataValidationException;
use Jexactyl\Exceptions\Repository\RecordNotFoundException;
use Jexactyl\Http\Requests\Admin\Jexactyl\StoreFormRequest;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;

class StoreController extends Controller
{
    /**
     * StoreController constructor.
     */
    public function __construct(
        private AlertsMessageBag $alert,
        private SettingsRepositoryInterface $settings
    ) {
    }

    /**
     * Render the Jexactyl store settings interface.
     */
    public function index(): View
    {
        $prefix = 'jexactyl::store:';

        $currencies = [];
        foreach (config('store.currencies') as $key => $value) {
            $currencies[] = ['code' => $key, 'name' => $value];
        }

        return view('admin.jexactyl.store', [
            'enabled' => $this->settings->get($prefix . 'enabled', false),
            'paypal_enabled' => $this->settings->get($prefix . 'paypal:enabled', false),
            'stripe_enabled' => $this->settings->get($prefix . 'stripe:enabled', false),
            'selected_currency' => $this->settings->get($prefix . 'currency', 'USD'),
            'currencies' => $currencies,

            'earn_enabled' => $this->settings->get('jexactyl::earn:enabled', false),
            'earn_amount' => $this->settings->get('jexactyl::earn:amount', 1),

            'cpu' => $this->settings->get($prefix . 'cost:cpu', 100),
            'memory' => $this->settings->get($prefix . 'cost:memory', 50),
            'disk' => $this->settings->get($prefix . 'cost:disk', 25),
            'slot' => $this->settings->get($prefix . 'cost:slot', 250),
            'port' => $this->settings->get($prefix . 'cost:port', 20),
            'backup' => $this->settings->get($prefix . 'cost:backup', 20),
            'database' => $this->settings->get($prefix . 'cost:database', 20),

            'limit_cpu' => $this->settings->get($prefix . 'limit:cpu', 100),
            'limit_memory' => $this->settings->get($prefix . 'limit:memory', 4096),
            'limit_disk' => $this->settings->get($prefix . 'limit:disk', 10240),
            'limit_port' => $this->settings->get($prefix . 'limit:port', 1),
            'limit_backup' => $this->settings->get($prefix . 'limit:backup', 1),
            'limit_database' => $this->settings->get($prefix . 'limit:database', 1),
        ]);
    }

    /**
     * Handle settings update.
     *
     * @throws DataValidationException
     * @throws RecordNotFoundException
     */
    public function update(StoreFormRequest $request): RedirectResponse
    {
        foreach ($request->normalize() as $key => $value) {
            $this->settings->set('jexactyl::' . $key, $value);
        }

        $this->alert->success('If you have enabled a payment gateway, please remember to configure them. <a href="https://docs.jexactyl.com">Documentation</a>')->flash();

        return redirect()->route('admin.jexactyl.store');
    }
}
</file>

<file path="app/Http/Controllers/Admin/Jexactyl/UpgradeController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Jexactyl;

use Illuminate\View\View;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\View\Factory as ViewFactory;

class UpgradeController extends Controller
{
    public function __construct(private ViewFactory $view)
    {
        //
    }

    /**
     * Render the v4 upgrade interface.
     */
    public function index(): View
    {
        return $this->view->make('admin.jexactyl.upgrade', [
            'php_version' => phpversion(),
            'total_memory' => $this->getTotalSystemMemory(),
            'storage_available' => $this->getTotalSystemDisk(),
        ]);
    }

    /**
     * Get the total amount of system memory of this host.
     */
    private function getTotalSystemMemory(): float
    {
        $memInfo = file_get_contents('/proc/meminfo');

        if (preg_match('/^MemTotal:\s+(\d+)\skB$/m', $memInfo, $matches)) {
            $memKB = (int) $matches[1];
            return round($memKB / 1024 / 1024, 2);
        }
    }

    /**
     * Ensure the disk has enough space to continue.
     */
    private function getTotalSystemDisk(): bool
    {
        if (disk_free_space('/') < 1024 * 1024 * 4096) {
            return false;
        }

        return true;
    }
}
</file>

<file path="app/Http/Controllers/Admin/Nests/EggController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Nests;

use Jexactyl\Models\Egg;
use Illuminate\View\View;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\View\Factory as ViewFactory;
use Jexactyl\Services\Eggs\EggUpdateService;
use Jexactyl\Services\Eggs\EggCreationService;
use Jexactyl\Services\Eggs\EggDeletionService;
use Jexactyl\Http\Requests\Admin\Egg\EggFormRequest;
use Jexactyl\Contracts\Repository\EggRepositoryInterface;
use Jexactyl\Contracts\Repository\NestRepositoryInterface;

class EggController extends Controller
{
    /**
     * EggController constructor.
     */
    public function __construct(
        protected AlertsMessageBag $alert,
        protected EggCreationService $creationService,
        protected EggDeletionService $deletionService,
        protected EggRepositoryInterface $repository,
        protected EggUpdateService $updateService,
        protected NestRepositoryInterface $nestRepository,
        protected ViewFactory $view
    ) {
    }

    /**
     * Handle a request to display the Egg creation page.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function create(): View
    {
        $nests = $this->nestRepository->getWithEggs();
        \JavaScript::put(['nests' => $nests->keyBy('id')]);

        return $this->view->make('admin.eggs.new', ['nests' => $nests]);
    }

    /**
     * Handle request to store a new Egg.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Service\Egg\NoParentConfigurationFoundException
     */
    public function store(EggFormRequest $request): RedirectResponse
    {
        $data = $request->validated();
        $data['docker_images'] = $this->normalizeDockerImages($data['docker_images'] ?? null);

        $egg = $this->creationService->handle($data);
        $this->alert->success(trans('admin/nests.eggs.notices.egg_created'))->flash();

        return redirect()->route('admin.nests.egg.view', $egg->id);
    }

    /**
     * Handle request to view a single Egg.
     */
    public function view(Egg $egg): View
    {
        return $this->view->make('admin.eggs.view', [
            'egg' => $egg,
            'images' => array_map(
                fn ($key, $value) => $key === $value ? $value : "$key|$value",
                array_keys($egg->docker_images),
                $egg->docker_images,
            ),
        ]);
    }

    /**
     * Handle request to update an Egg.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     * @throws \Jexactyl\Exceptions\Service\Egg\NoParentConfigurationFoundException
     */
    public function update(EggFormRequest $request, Egg $egg): RedirectResponse
    {
        $data = $request->validated();
        $data['docker_images'] = $this->normalizeDockerImages($data['docker_images'] ?? null);

        $this->updateService->handle($egg, $data);
        $this->alert->success(trans('admin/nests.eggs.notices.updated'))->flash();

        return redirect()->route('admin.nests.egg.view', $egg->id);
    }

    /**
     * Handle request to destroy an egg.
     *
     * @throws \Jexactyl\Exceptions\Service\Egg\HasChildrenException
     * @throws \Jexactyl\Exceptions\Service\HasActiveServersException
     */
    public function destroy(Egg $egg): RedirectResponse
    {
        $this->deletionService->handle($egg->id);
        $this->alert->success(trans('admin/nests.eggs.notices.deleted'))->flash();

        return redirect()->route('admin.nests.view', $egg->nest_id);
    }

    /**
     * Normalizes a string of docker image data into the expected egg format.
     */
    protected function normalizeDockerImages(string $input = null): array
    {
        $data = array_map(fn ($value) => trim($value), explode("\n", $input ?? ''));

        $images = [];
        // Iterate over the image data provided and convert it into a name => image
        // pairing that is used to improve the display on the front-end.
        foreach ($data as $value) {
            $parts = explode('|', $value, 2);
            $images[$parts[0]] = empty($parts[1]) ? $parts[0] : $parts[1];
        }

        return $images;
    }
}
</file>

<file path="app/Http/Controllers/Admin/Nests/EggScriptController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Nests;

use Jexactyl\Models\Egg;
use Illuminate\View\View;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\View\Factory as ViewFactory;
use Jexactyl\Services\Eggs\Scripts\InstallScriptService;
use Jexactyl\Contracts\Repository\EggRepositoryInterface;
use Jexactyl\Http\Requests\Admin\Egg\EggScriptFormRequest;

class EggScriptController extends Controller
{
    /**
     * EggScriptController constructor.
     */
    public function __construct(
        protected AlertsMessageBag $alert,
        protected EggRepositoryInterface $repository,
        protected InstallScriptService $installScriptService,
        protected ViewFactory $view
    ) {
    }

    /**
     * Handle requests to render installation script for an Egg.
     */
    public function index(int $egg): View
    {
        $egg = $this->repository->getWithCopyAttributes($egg);
        $copy = $this->repository->findWhere([
            ['copy_script_from', '=', null],
            ['nest_id', '=', $egg->nest_id],
            ['id', '!=', $egg],
        ]);

        $rely = $this->repository->findWhere([
            ['copy_script_from', '=', $egg->id],
        ]);

        return $this->view->make('admin.eggs.scripts', [
            'copyFromOptions' => $copy,
            'relyOnScript' => $rely,
            'egg' => $egg,
        ]);
    }

    /**
     * Handle a request to update the installation script for an Egg.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     * @throws \Jexactyl\Exceptions\Service\Egg\InvalidCopyFromException
     */
    public function update(EggScriptFormRequest $request, Egg $egg): RedirectResponse
    {
        $this->installScriptService->handle($egg, $request->normalize());
        $this->alert->success(trans('admin/nests.eggs.notices.script_updated'))->flash();

        return redirect()->route('admin.nests.egg.scripts', $egg);
    }
}
</file>

<file path="app/Http/Controllers/Admin/Nests/EggShareController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Nests;

use Jexactyl\Models\Egg;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Symfony\Component\HttpFoundation\Response;
use Jexactyl\Services\Eggs\Sharing\EggExporterService;
use Jexactyl\Services\Eggs\Sharing\EggImporterService;
use Jexactyl\Http\Requests\Admin\Egg\EggImportFormRequest;
use Jexactyl\Services\Eggs\Sharing\EggUpdateImporterService;

class EggShareController extends Controller
{
    /**
     * EggShareController constructor.
     */
    public function __construct(
        protected AlertsMessageBag $alert,
        protected EggExporterService $exporterService,
        protected EggImporterService $importerService,
        protected EggUpdateImporterService $updateImporterService
    ) {
    }

    /**
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function export(Egg $egg): Response
    {
        $filename = trim(preg_replace('/\W/', '-', kebab_case($egg->name)), '-');

        return response($this->exporterService->handle($egg->id), 200, [
            'Content-Transfer-Encoding' => 'binary',
            'Content-Description' => 'File Transfer',
            'Content-Disposition' => 'attachment; filename=egg-' . $filename . '.json',
            'Content-Type' => 'application/json',
        ]);
    }

    /**
     * Import a new service option using an XML file.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     * @throws \Jexactyl\Exceptions\Service\Egg\BadJsonFormatException
     * @throws \Jexactyl\Exceptions\Service\InvalidFileUploadException
     */
    public function import(EggImportFormRequest $request): RedirectResponse
    {
        $egg = $this->importerService->handle($request->file('import_file'), $request->input('import_to_nest'));
        $this->alert->success(trans('admin/nests.eggs.notices.imported'))->flash();

        return redirect()->route('admin.nests.egg.view', ['egg' => $egg->id]);
    }

    /**
     * Update an existing Egg using a new imported file.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     * @throws \Jexactyl\Exceptions\Service\Egg\BadJsonFormatException
     * @throws \Jexactyl\Exceptions\Service\InvalidFileUploadException
     */
    public function update(EggImportFormRequest $request, Egg $egg): RedirectResponse
    {
        $this->updateImporterService->handle($egg, $request->file('import_file'));
        $this->alert->success(trans('admin/nests.eggs.notices.updated_via_import'))->flash();

        return redirect()->route('admin.nests.egg.view', ['egg' => $egg]);
    }
}
</file>

<file path="app/Http/Controllers/Admin/Nests/EggVariableController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Nests;

use Jexactyl\Models\Egg;
use Illuminate\View\View;
use Jexactyl\Models\EggVariable;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\View\Factory as ViewFactory;
use Jexactyl\Contracts\Repository\EggRepositoryInterface;
use Jexactyl\Services\Eggs\Variables\VariableUpdateService;
use Jexactyl\Http\Requests\Admin\Egg\EggVariableFormRequest;
use Jexactyl\Services\Eggs\Variables\VariableCreationService;
use Jexactyl\Contracts\Repository\EggVariableRepositoryInterface;

class EggVariableController extends Controller
{
    /**
     * EggVariableController constructor.
     */
    public function __construct(
        protected AlertsMessageBag $alert,
        protected VariableCreationService $creationService,
        protected VariableUpdateService $updateService,
        protected EggRepositoryInterface $repository,
        protected EggVariableRepositoryInterface $variableRepository,
        protected ViewFactory $view
    ) {
    }

    /**
     * Handle request to view the variables attached to an Egg.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function view(int $egg): View
    {
        $egg = $this->repository->getWithVariables($egg);

        return $this->view->make('admin.eggs.variables', ['egg' => $egg]);
    }

    /**
     * Handle a request to create a new Egg variable.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Service\Egg\Variable\BadValidationRuleException
     * @throws \Jexactyl\Exceptions\Service\Egg\Variable\ReservedVariableNameException
     */
    public function store(EggVariableFormRequest $request, Egg $egg): RedirectResponse
    {
        $this->creationService->handle($egg->id, $request->normalize());
        $this->alert->success(trans('admin/nests.variables.notices.variable_created'))->flash();

        return redirect()->route('admin.nests.egg.variables', $egg->id);
    }

    /**
     * Handle a request to update an existing Egg variable.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     * @throws \Jexactyl\Exceptions\Service\Egg\Variable\ReservedVariableNameException
     */
    public function update(EggVariableFormRequest $request, Egg $egg, EggVariable $variable): RedirectResponse
    {
        $this->updateService->handle($variable, $request->normalize());
        $this->alert->success(trans('admin/nests.variables.notices.variable_updated', [
            'variable' => $variable->name,
        ]))->flash();

        return redirect()->route('admin.nests.egg.variables', $egg->id);
    }

    /**
     * Handle a request to delete an existing Egg variable from the Panel.
     */
    public function destroy(int $egg, EggVariable $variable): RedirectResponse
    {
        $this->variableRepository->delete($variable->id);
        $this->alert->success(trans('admin/nests.variables.notices.variable_deleted', [
            'variable' => $variable->name,
        ]))->flash();

        return redirect()->route('admin.nests.egg.variables', $egg);
    }
}
</file>

<file path="app/Http/Controllers/Admin/Nests/NestController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Nests;

use Illuminate\View\View;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\View\Factory as ViewFactory;
use Jexactyl\Services\Nests\NestUpdateService;
use Jexactyl\Services\Nests\NestCreationService;
use Jexactyl\Services\Nests\NestDeletionService;
use Jexactyl\Contracts\Repository\NestRepositoryInterface;
use Jexactyl\Http\Requests\Admin\Nest\StoreNestFormRequest;

class NestController extends Controller
{
    /**
     * NestController constructor.
     */
    public function __construct(
        protected AlertsMessageBag $alert,
        protected NestCreationService $nestCreationService,
        protected NestDeletionService $nestDeletionService,
        protected NestRepositoryInterface $repository,
        protected NestUpdateService $nestUpdateService,
        protected ViewFactory $view
    ) {
    }

    /**
     * Render nest listing page.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function index(): View
    {
        return $this->view->make('admin.nests.index', [
            'nests' => $this->repository->getWithCounts(),
        ]);
    }

    /**
     * Render nest creation page.
     */
    public function create(): View
    {
        return $this->view->make('admin.nests.new');
    }

    /**
     * Handle the storage of a new nest.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function store(StoreNestFormRequest $request): RedirectResponse
    {
        $nest = $this->nestCreationService->handle($request->normalize());
        $this->alert->success(trans('admin/nests.notices.created', ['name' => $nest->name]))->flash();

        return redirect()->route('admin.nests.view', $nest->id);
    }

    /**
     * Return details about a nest including all the eggs and servers per egg.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function view(int $nest): View
    {
        return $this->view->make('admin.nests.view', [
            'nest' => $this->repository->getWithEggServers($nest),
        ]);
    }

    /**
     * Handle request to update a nest.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(StoreNestFormRequest $request, int $nest): RedirectResponse
    {
        $this->nestUpdateService->handle($nest, $request->normalize());
        $this->alert->success(trans('admin/nests.notices.updated'))->flash();

        return redirect()->route('admin.nests.view', $nest);
    }

    /**
     * Handle request to delete a nest.
     *
     * @throws \Jexactyl\Exceptions\Service\HasActiveServersException
     */
    public function destroy(int $nest): RedirectResponse
    {
        $this->nestDeletionService->handle($nest);
        $this->alert->success(trans('admin/nests.notices.deleted'))->flash();

        return redirect()->route('admin.nests');
    }
}
</file>

<file path="app/Http/Controllers/Admin/Nodes/NodeController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Nodes;

use Illuminate\View\View;
use Jexactyl\Models\Node;
use Illuminate\Http\Request;
use Spatie\QueryBuilder\QueryBuilder;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\Contracts\View\Factory as ViewFactory;

class NodeController extends Controller
{
    /**
     * NodeController constructor.
     */
    public function __construct(private ViewFactory $view)
    {
    }

    /**
     * Returns a listing of nodes on the system.
     */
    public function index(Request $request): View
    {
        $nodes = QueryBuilder::for(
            Node::query()->with('location')->withCount('servers')
        )
            ->allowedFilters(['uuid', 'name'])
            ->allowedSorts(['id'])
            ->paginate(25);

        return $this->view->make('admin.nodes.index', ['nodes' => $nodes]);
    }
}
</file>

<file path="app/Http/Controllers/Admin/Nodes/NodeViewController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Nodes;

use Illuminate\View\View;
use Jexactyl\Models\Node;
use Illuminate\Http\Request;
use Jexactyl\Models\Allocation;
use Illuminate\Support\Collection;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Repositories\Eloquent\NodeRepository;
use Jexactyl\Repositories\Eloquent\ServerRepository;
use Jexactyl\Traits\Controllers\JavascriptInjection;
use Illuminate\Contracts\View\Factory as ViewFactory;
use Jexactyl\Services\Helpers\SoftwareVersionService;
use Jexactyl\Repositories\Eloquent\LocationRepository;
use Jexactyl\Repositories\Eloquent\AllocationRepository;

class NodeViewController extends Controller
{
    use JavascriptInjection;

    /**
     * NodeViewController constructor.
     */
    public function __construct(
        private AllocationRepository $allocationRepository,
        private LocationRepository $locationRepository,
        private NodeRepository $repository,
        private ServerRepository $serverRepository,
        private SoftwareVersionService $versionService,
        private ViewFactory $view
    ) {
    }

    /**
     * Returns index view for a specific node on the system.
     */
    public function index(Request $request, Node $node): View
    {
        $node = $this->repository->loadLocationAndServerCount($node);

        return $this->view->make('admin.nodes.view.index', [
            'node' => $node,
            'stats' => $this->repository->getUsageStats($node),
            'version' => $this->versionService,
        ]);
    }

    /**
     * Returns the settings page for a specific node.
     */
    public function settings(Request $request, Node $node): View
    {
        return $this->view->make('admin.nodes.view.settings', [
            'node' => $node,
            'locations' => $this->locationRepository->all(),
            'deployable' => $node->deployable,
        ]);
    }

    /**
     * Return the node configuration page for a specific node.
     */
    public function configuration(Request $request, Node $node): View
    {
        return $this->view->make('admin.nodes.view.configuration', compact('node'));
    }

    /**
     * Return the node allocation management page.
     */
    public function allocations(Request $request, Node $node): View
    {
        $node = $this->repository->loadNodeAllocations($node);

        $this->plainInject(['node' => Collection::wrap($node)->only(['id'])]);

        return $this->view->make('admin.nodes.view.allocation', [
            'node' => $node,
            'allocations' => Allocation::query()->where('node_id', $node->id)
                ->groupBy('ip')
                ->orderByRaw('INET_ATON(ip) ASC')
                ->get(['ip']),
        ]);
    }

    /**
     * Return a listing of servers that exist for this specific node.
     */
    public function servers(Request $request, Node $node): View
    {
        $this->plainInject([
            'node' => Collection::wrap($node->makeVisible(['daemon_token_id', 'daemon_token']))
                ->only(['scheme', 'fqdn', 'daemonListen', 'daemon_token_id', 'daemon_token']),
        ]);

        return $this->view->make('admin.nodes.view.servers', [
            'node' => $node,
            'servers' => $this->serverRepository->loadAllServersForNode($node->id, 25),
        ]);
    }
}
</file>

<file path="app/Http/Controllers/Admin/Nodes/SystemInformationController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Nodes;

use Jexactyl\Models\Node;
use Illuminate\Support\Str;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Repositories\Wings\DaemonConfigurationRepository;

class SystemInformationController extends Controller
{
    /**
     * SystemInformationController constructor.
     */
    public function __construct(private DaemonConfigurationRepository $repository)
    {
    }

    /**
     * Returns system information from the Daemon.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function __invoke(Request $request, Node $node): JsonResponse
    {
        $data = $this->repository->setNode($node)->getSystemInformation();

        return new JsonResponse([
            'version' => $data['version'] ?? '',
            'system' => [
                'type' => Str::title($data['os'] ?? 'Unknown'),
                'arch' => $data['architecture'] ?? '--',
                'release' => $data['kernel_version'] ?? '--',
                'cpus' => $data['cpu_count'] ?? 0,
            ],
        ]);
    }
}
</file>

<file path="app/Http/Controllers/Admin/Servers/CreateServerController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Servers;

use Illuminate\View\View;
use Jexactyl\Models\Node;
use Jexactyl\Models\Location;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\View\Factory as ViewFactory;
use Jexactyl\Repositories\Eloquent\NestRepository;
use Jexactyl\Repositories\Eloquent\NodeRepository;
use Jexactyl\Http\Requests\Admin\ServerFormRequest;
use Jexactyl\Services\Servers\ServerCreationService;

class CreateServerController extends Controller
{
    /**
     * CreateServerController constructor.
     */
    public function __construct(
        private AlertsMessageBag $alert,
        private NestRepository $nestRepository,
        private NodeRepository $nodeRepository,
        private ServerCreationService $creationService,
        private ViewFactory $view
    ) {
    }

    /**
     * Displays the create server page.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function index(): View|RedirectResponse
    {
        $nodes = Node::all();
        if (count($nodes) < 1) {
            $this->alert->warning(trans('admin/server.alerts.node_required'))->flash();

            return redirect()->route('admin.nodes');
        }

        $nests = $this->nestRepository->getWithEggs();

        \JavaScript::put([
            'nodeData' => $this->nodeRepository->getNodesForServerCreation(),
            'nests' => $nests->map(function ($item) {
                return array_merge($item->toArray(), [
                    'eggs' => $item->eggs->keyBy('id')->toArray(),
                ]);
            })->keyBy('id'),
        ]);

        return $this->view->make('admin.servers.new', [
            'locations' => Location::all(),
            'nests' => $nests,
        ]);
    }

    /**
     * Create a new server on the remote system.
     *
     * @throws \Illuminate\Validation\ValidationException
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Service\Deployment\NoViableAllocationException
     * @throws \Jexactyl\Exceptions\Service\Deployment\NoViableNodeException
     * @throws \Throwable
     */
    public function store(ServerFormRequest $request): RedirectResponse
    {
        $data = $request->except(['_token']);
        if (!empty($data['custom_image'])) {
            $data['image'] = $data['custom_image'];
            unset($data['custom_image']);
        }

        $server = $this->creationService->handle($data);

        $this->alert->success(trans('admin/server.alerts.server_created'))->flash();

        return new RedirectResponse('/admin/servers/view/' . $server->id);
    }
}
</file>

<file path="app/Http/Controllers/Admin/Servers/ServerController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Servers;

use Illuminate\View\View;
use Jexactyl\Models\Server;
use Illuminate\Http\Request;
use Spatie\QueryBuilder\QueryBuilder;
use Spatie\QueryBuilder\AllowedFilter;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Models\Filters\AdminServerFilter;
use Illuminate\Contracts\View\Factory as ViewFactory;

class ServerController extends Controller
{
    /**
     * ServerController constructor.
     */
    public function __construct(private ViewFactory $view)
    {
    }

    /**
     * Returns all the servers that exist on the system using a paginated result set. If
     * a query is passed along in the request it is also passed to the repository function.
     */
    public function index(Request $request): View
    {
        $servers = QueryBuilder::for(Server::query()->with('node', 'user', 'allocation'))
            ->allowedFilters([
                AllowedFilter::exact('owner_id'),
                AllowedFilter::custom('*', new AdminServerFilter()),
            ])
            ->paginate(config()->get('jexactyl.paginate.admin.servers'));

        return $this->view->make('admin.servers.index', ['servers' => $servers]);
    }
}
</file>

<file path="app/Http/Controllers/Admin/Servers/ServerTransferController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Servers;

use Carbon\CarbonImmutable;
use Jexactyl\Models\Server;
use Illuminate\Http\Request;
use Jexactyl\Models\ServerTransfer;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Services\Nodes\NodeJWTService;
use Illuminate\Database\ConnectionInterface;
use Jexactyl\Repositories\Eloquent\NodeRepository;
use Jexactyl\Repositories\Wings\DaemonTransferRepository;
use Jexactyl\Contracts\Repository\AllocationRepositoryInterface;

class ServerTransferController extends Controller
{
    /**
     * ServerTransferController constructor.
     */
    public function __construct(
        private AlertsMessageBag $alert,
        private AllocationRepositoryInterface $allocationRepository,
        private ConnectionInterface $connection,
        private DaemonTransferRepository $daemonTransferRepository,
        private NodeJWTService $nodeJWTService,
        private NodeRepository $nodeRepository
    ) {
    }

    /**
     * Starts a transfer of a server to a new node.
     *
     * @throws \Throwable
     */
    public function transfer(Request $request, Server $server): RedirectResponse
    {
        $validatedData = $request->validate([
            'node_id' => 'required|exists:nodes,id',
            'allocation_id' => 'required|bail|unique:servers|exists:allocations,id',
            'allocation_additional' => 'nullable',
        ]);

        $node_id = $validatedData['node_id'];
        $allocation_id = intval($validatedData['allocation_id']);
        $additional_allocations = array_map('intval', $validatedData['allocation_additional'] ?? []);

        // Check if the node is viable for the transfer.
        $node = $this->nodeRepository->getNodeWithResourceUsage($node_id);
        if (!$node->isViable($server->memory, $server->disk)) {
            $this->alert->danger(trans('admin/server.alerts.transfer_not_viable'))->flash();

            return redirect()->route('admin.servers.view.manage', $server->id);
        }

        $server->validateTransferState();

        $this->connection->transaction(function () use ($server, $node_id, $allocation_id, $additional_allocations) {
            // Create a new ServerTransfer entry.
            $transfer = new ServerTransfer();

            $transfer->server_id = $server->id;
            $transfer->old_node = $server->node_id;
            $transfer->new_node = $node_id;
            $transfer->old_allocation = $server->allocation_id;
            $transfer->new_allocation = $allocation_id;
            $transfer->old_additional_allocations = $server->allocations->where('id', '!=', $server->allocation_id)->pluck('id');
            $transfer->new_additional_allocations = $additional_allocations;

            $transfer->save();

            // Add the allocations to the server, so they cannot be automatically assigned while the transfer is in progress.
            $this->assignAllocationsToServer($server, $node_id, $allocation_id, $additional_allocations);

            // Generate a token for the destination node that the source node can use to authenticate with.
            $token = $this->nodeJWTService
                ->setExpiresAt(CarbonImmutable::now()->addMinutes(15))
                ->setSubject($server->uuid)
                ->handle($transfer->newNode, $server->uuid, 'sha256');

            // Notify the source node of the pending outgoing transfer.
            $this->daemonTransferRepository->setServer($server)->notify($transfer->newNode, $token);

            return $transfer;
        });

        $this->alert->success(trans('admin/server.alerts.transfer_started'))->flash();

        return redirect()->route('admin.servers.view.manage', $server->id);
    }

    /**
     * Assigns the specified allocations to the specified server.
     */
    private function assignAllocationsToServer(Server $server, int $node_id, int $allocation_id, array $additional_allocations)
    {
        $allocations = $additional_allocations;
        $allocations[] = $allocation_id;

        $unassigned = $this->allocationRepository->getUnassignedAllocationIds($node_id);

        $updateIds = [];
        foreach ($allocations as $allocation) {
            if (!in_array($allocation, $unassigned)) {
                continue;
            }

            $updateIds[] = $allocation;
        }

        if (!empty($updateIds)) {
            $this->allocationRepository->updateWhereIn('id', $updateIds, ['server_id' => $server->id]);
        }
    }
}
</file>

<file path="app/Http/Controllers/Admin/Servers/ServerViewController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Servers;

use Illuminate\View\View;
use Jexactyl\Models\Nest;
use Jexactyl\Models\Server;
use Illuminate\Http\Request;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Services\Servers\EnvironmentService;
use Jexactyl\Repositories\Eloquent\NestRepository;
use Jexactyl\Repositories\Eloquent\NodeRepository;
use Jexactyl\Repositories\Eloquent\MountRepository;
use Jexactyl\Repositories\Eloquent\ServerRepository;
use Jexactyl\Traits\Controllers\JavascriptInjection;
use Illuminate\Contracts\View\Factory as ViewFactory;
use Jexactyl\Repositories\Eloquent\LocationRepository;
use Jexactyl\Repositories\Eloquent\DatabaseHostRepository;

class ServerViewController extends Controller
{
    use JavascriptInjection;

    /**
     * ServerViewController constructor.
     */
    public function __construct(
        private DatabaseHostRepository $databaseHostRepository,
        private LocationRepository $locationRepository,
        private MountRepository $mountRepository,
        private NestRepository $nestRepository,
        private NodeRepository $nodeRepository,
        private ServerRepository $repository,
        private EnvironmentService $environmentService,
        private ViewFactory $view
    ) {
    }

    /**
     * Returns the index view for a server.
     */
    public function index(Request $request, Server $server): View
    {
        return $this->view->make('admin.servers.view.index', compact('server'));
    }

    /**
     * Returns the server details page.
     */
    public function details(Request $request, Server $server): View
    {
        return $this->view->make('admin.servers.view.details', compact('server'));
    }

    /**
     * Returns a view of server build settings.
     */
    public function build(Request $request, Server $server): View
    {
        $allocations = $server->node->allocations->toBase();

        return $this->view->make('admin.servers.view.build', [
            'server' => $server,
            'assigned' => $allocations->where('server_id', $server->id)->sortBy('port')->sortBy('ip'),
            'unassigned' => $allocations->where('server_id', null)->sortBy('port')->sortBy('ip'),
        ]);
    }

    /**
     * Returns the server startup management page.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function startup(Request $request, Server $server): View
    {
        $nests = $this->nestRepository->getWithEggs();
        $variables = $this->environmentService->handle($server);

        $this->plainInject([
            'server' => $server,
            'server_variables' => $variables,
            'nests' => $nests->map(function (Nest $item) {
                return array_merge($item->toArray(), [
                    'eggs' => $item->eggs->keyBy('id')->toArray(),
                ]);
            })->keyBy('id'),
        ]);

        return $this->view->make('admin.servers.view.startup', compact('server', 'nests'));
    }

    /**
     * Returns all the databases that exist for the server.
     */
    public function database(Request $request, Server $server): View
    {
        return $this->view->make('admin.servers.view.database', [
            'hosts' => $this->databaseHostRepository->all(),
            'server' => $server,
        ]);
    }

    /**
     * Returns all the mounts that exist for the server.
     */
    public function mounts(Request $request, Server $server): View
    {
        $server->load('mounts');

        return $this->view->make('admin.servers.view.mounts', [
            'mounts' => $this->mountRepository->getMountListForServer($server),
            'server' => $server,
        ]);
    }

    /**
     * Returns the base server management page, or an exception if the server
     * is in a state that cannot be recovered from.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    public function manage(Request $request, Server $server): View
    {
        if ($server->status === Server::STATUS_INSTALL_FAILED) {
            throw new DisplayException('This server is in a failed install state and cannot be recovered. Please delete and re-create the server.');
        }

        // Check if the panel doesn't have at least 2 nodes configured.
        $nodes = $this->nodeRepository->all();
        $canTransfer = false;

        if (count($nodes) >= 2) {
            $canTransfer = true;
        }

        \JavaScript::put([
            'nodeData' => $this->nodeRepository->getNodesForServerCreation(),
        ]);

        return $this->view->make('admin.servers.view.manage', [
            'server' => $server,
            'locations' => $this->locationRepository->all(),
            'canTransfer' => $canTransfer,
        ]);
    }

    /**
     * Returns the server deletion page.
     */
    public function delete(Request $request, Server $server): View
    {
        return $this->view->make('admin.servers.view.delete', compact('server'));
    }
}
</file>

<file path="app/Http/Controllers/Admin/Users/ResourceController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Users;

use Illuminate\View\View;
use Jexactyl\Models\User;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Services\Users\UserUpdateService;
use Jexactyl\Exceptions\Model\DataValidationException;
use Jexactyl\Exceptions\Repository\RecordNotFoundException;
use Jexactyl\Http\Requests\Admin\Users\ResourceFormRequest;

class ResourceController extends Controller
{
    /**
     * UserController constructor.
     */
    public function __construct(private AlertsMessageBag $alert, private UserUpdateService $updateService)
    {
    }

    /**
     * Display user resource page.
     */
    public function view(User $user): View
    {
        return view('admin.users.resources', ['user' => $user]);
    }

    /**
     * Update a user's resource balances.
     *
     * @throws DataValidationException
     * @throws RecordNotFoundException
     */
    public function update(ResourceFormRequest $request, User $user): RedirectResponse
    {
        $this->updateService
            ->setUserLevel(User::USER_LEVEL_ADMIN)
            ->handle($user, $request->normalize());

        $this->alert->success('User resources have been updated.')->flash();

        return redirect()->route('admin.users.resources', $user->id);
    }
}
</file>

<file path="app/Http/Controllers/Admin/Users/UserController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin\Users;

use Illuminate\View\View;
use Jexactyl\Models\User;
use Jexactyl\Models\Model;
use Illuminate\Http\Request;
use Illuminate\Support\Collection;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Spatie\QueryBuilder\QueryBuilder;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\View\Factory as ViewFactory;
use Jexactyl\Services\Users\UserUpdateService;
use Jexactyl\Traits\Helpers\AvailableLanguages;
use Illuminate\Contracts\Translation\Translator;
use Jexactyl\Services\Users\UserCreationService;
use Jexactyl\Services\Users\UserDeletionService;
use Jexactyl\Http\Requests\Admin\NewUserFormRequest;
use Jexactyl\Http\Requests\Admin\Users\UserFormRequest;
use Jexactyl\Contracts\Repository\UserRepositoryInterface;

class UserController extends Controller
{
    use AvailableLanguages;

    /**
     * UserController constructor.
     */
    public function __construct(
        protected AlertsMessageBag $alert,
        protected UserCreationService $creationService,
        protected UserDeletionService $deletionService,
        protected Translator $translator,
        protected UserUpdateService $updateService,
        protected UserRepositoryInterface $repository,
        protected ViewFactory $view
    ) {
    }

    /**
     * Display user index page.
     */
    public function index(Request $request): View
    {
        $users = QueryBuilder::for(
            User::query()->select('users.*')
                ->selectRaw('COUNT(DISTINCT(subusers.id)) as subuser_of_count')
                ->selectRaw('COUNT(DISTINCT(servers.id)) as servers_count')
                ->leftJoin('subusers', 'subusers.user_id', '=', 'users.id')
                ->leftJoin('servers', 'servers.owner_id', '=', 'users.id')
                ->groupBy('users.id')
        )
            ->allowedFilters(['username', 'email', 'uuid'])
            ->allowedSorts(['id', 'uuid'])
            ->paginate(50);

        return $this->view->make('admin.users.index', ['users' => $users]);
    }

    /**
     * Display new user page.
     */
    public function create(): View
    {
        return $this->view->make('admin.users.new', [
            'languages' => $this->getAvailableLanguages(true),
        ]);
    }

    /**
     * Display user view page.
     */
    public function view(User $user): View
    {
        return $this->view->make('admin.users.view', [
            'user' => $user,
            'languages' => $this->getAvailableLanguages(true),
        ]);
    }

    /**
     * Delete a user from the system.
     *
     * @throws \Exception
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    public function delete(Request $request, User $user): RedirectResponse
    {
        if ($request->user()->id === $user->id) {
            throw new DisplayException($this->translator->get('admin/user.exceptions.user_has_servers'));
        }

        $this->deletionService->handle($user);

        return redirect()->route('admin.users');
    }

    /**
     * Create a user.
     *
     * @throws \Exception
     * @throws \Throwable
     */
    public function store(NewUserFormRequest $request): RedirectResponse
    {
        $user = $this->creationService->handle($request->normalize());
        $this->alert->success($this->translator->get('admin/user.notices.account_created'))->flash();

        return redirect()->route('admin.users.view', $user->id);
    }

    /**
     * Update a user on the system.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(UserFormRequest $request, User $user): RedirectResponse
    {
        $this->updateService
            ->setUserLevel(User::USER_LEVEL_ADMIN)
            ->handle($user, $request->normalize());

        $this->alert->success(trans('admin/user.notices.account_updated'))->flash();

        return redirect()->route('admin.users.view', $user->id);
    }

    /**
     * Get a JSON response of users on the system.
     */
    public function json(Request $request): Model|Collection
    {
        $users = QueryBuilder::for(User::query())->allowedFilters(['email'])->paginate(25);

        // Handle single user requests.
        if ($request->query('user_id')) {
            $user = User::query()->findOrFail($request->input('user_id'));
            $user->md5 = md5(strtolower($user->email));

            return $user;
        }

        return $users->map(function ($item) {
            $item->md5 = md5(strtolower($item->email));

            return $item;
        });
    }
}
</file>

<file path="app/Http/Controllers/Admin/ApiController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin;

use Illuminate\View\View;
use Jexactyl\Models\ApiKey;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\View\Factory as ViewFactory;
use Jexactyl\Services\Api\KeyCreationService;
use Jexactyl\Contracts\Repository\ApiKeyRepositoryInterface;
use Jexactyl\Http\Requests\Admin\Api\StoreApplicationApiKeyRequest;

class ApiController extends Controller
{
    /**
     * ApiController constructor.
     */
    public function __construct(
        private AlertsMessageBag $alert,
        private ApiKeyRepositoryInterface $repository,
        private KeyCreationService $keyCreationService,
        private ViewFactory $view,
    ) {
    }

    /**
     * Render view showing all of a user's application API keys.
     */
    public function index(Request $request): View
    {
        return $this->view->make('admin.api.index', [
            'keys' => $this->repository->getApplicationKeys($request->user()),
        ]);
    }

    /**
     * Render view allowing an admin to create a new application API key.
     *
     * @throws \ReflectionException
     */
    public function create(): View
    {
        $resources = AdminAcl::getResourceList();
        sort($resources);

        return $this->view->make('admin.api.new', [
            'resources' => $resources,
            'permissions' => [
                'r' => AdminAcl::READ,
                'rw' => AdminAcl::READ | AdminAcl::WRITE,
                'n' => AdminAcl::NONE,
            ],
        ]);
    }

    /**
     * Store the new key and redirect the user back to the application key listing.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function store(StoreApplicationApiKeyRequest $request): RedirectResponse
    {
        $this->keyCreationService->setKeyType(ApiKey::TYPE_APPLICATION)->handle([
            'memo' => $request->input('memo'),
            'user_id' => $request->user()->id,
        ], $request->getKeyPermissions());

        $this->alert->success('A new application API key has been generated for your account.')->flash();

        return redirect()->route('admin.api.index');
    }

    /**
     * Delete an application API key from the database.
     */
    public function delete(Request $request, string $identifier): Response
    {
        $this->repository->deleteApplicationKey($request->user(), $identifier);

        return response('', 204);
    }
}
</file>

<file path="app/Http/Controllers/Admin/DatabaseController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin;

use Exception;
use Illuminate\View\View;
use Jexactyl\Models\DatabaseHost;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\View\Factory as ViewFactory;
use Jexactyl\Services\Databases\Hosts\HostUpdateService;
use Jexactyl\Http\Requests\Admin\DatabaseHostFormRequest;
use Jexactyl\Services\Databases\Hosts\HostCreationService;
use Jexactyl\Services\Databases\Hosts\HostDeletionService;
use Jexactyl\Contracts\Repository\DatabaseRepositoryInterface;
use Jexactyl\Contracts\Repository\LocationRepositoryInterface;
use Jexactyl\Contracts\Repository\DatabaseHostRepositoryInterface;

class DatabaseController extends Controller
{
    /**
     * DatabaseController constructor.
     */
    public function __construct(
        private AlertsMessageBag $alert,
        private DatabaseHostRepositoryInterface $repository,
        private DatabaseRepositoryInterface $databaseRepository,
        private HostCreationService $creationService,
        private HostDeletionService $deletionService,
        private HostUpdateService $updateService,
        private LocationRepositoryInterface $locationRepository,
        private ViewFactory $view
    ) {
    }

    /**
     * Display database host index.
     */
    public function index(): View
    {
        return $this->view->make('admin.databases.index', [
            'locations' => $this->locationRepository->getAllWithNodes(),
            'hosts' => $this->repository->getWithViewDetails(),
        ]);
    }

    /**
     * Display database host to user.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function view(int $host): View
    {
        return $this->view->make('admin.databases.view', [
            'locations' => $this->locationRepository->getAllWithNodes(),
            'host' => $this->repository->find($host),
            'databases' => $this->databaseRepository->getDatabasesForHost($host),
        ]);
    }

    /**
     * Handle request to create a new database host.
     *
     * @throws \Throwable
     */
    public function create(DatabaseHostFormRequest $request): RedirectResponse
    {
        try {
            $host = $this->creationService->handle($request->normalize());
        } catch (\Exception $exception) {
            if ($exception instanceof \PDOException || $exception->getPrevious() instanceof \PDOException) {
                $this->alert->danger(
                    sprintf('There was an error while trying to connect to the host or while executing a query: "%s"', $exception->getMessage())
                )->flash();

                return redirect()->route('admin.databases')->withInput($request->validated());
            } else {
                throw $exception;
            }
        }

        $this->alert->success('Successfully created a new database host on the system.')->flash();

        return redirect()->route('admin.databases.view', $host->id);
    }

    /**
     * Handle updating database host.
     *
     * @throws \Throwable
     */
    public function update(DatabaseHostFormRequest $request, DatabaseHost $host): RedirectResponse
    {
        $redirect = redirect()->route('admin.databases.view', $host->id);

        try {
            $this->updateService->handle($host->id, $request->normalize());
            $this->alert->success('Database host was updated successfully.')->flash();
        } catch (\Exception $exception) {
            // Catch any SQL related exceptions and display them back to the user, otherwise just
            // throw the exception like normal and move on with it.
            if ($exception instanceof \PDOException || $exception->getPrevious() instanceof \PDOException) {
                $this->alert->danger(
                    sprintf('There was an error while trying to connect to the host or while executing a query: "%s"', $exception->getMessage())
                )->flash();

                return $redirect->withInput($request->normalize());
            } else {
                throw $exception;
            }
        }

        return $redirect;
    }

    /**
     * Handle request to delete a database host.
     *
     * @throws \Jexactyl\Exceptions\Service\HasActiveServersException
     */
    public function delete(int $host): RedirectResponse
    {
        $this->deletionService->handle($host);
        $this->alert->success('The requested database host has been deleted from the system.')->flash();

        return redirect()->route('admin.databases');
    }
}
</file>

<file path="app/Http/Controllers/Admin/LocationController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin;

use Illuminate\View\View;
use Jexactyl\Models\Location;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\View\Factory as ViewFactory;
use Jexactyl\Http\Requests\Admin\LocationFormRequest;
use Jexactyl\Services\Locations\LocationUpdateService;
use Jexactyl\Services\Locations\LocationCreationService;
use Jexactyl\Services\Locations\LocationDeletionService;
use Jexactyl\Contracts\Repository\LocationRepositoryInterface;

class LocationController extends Controller
{
    /**
     * LocationController constructor.
     */
    public function __construct(
        protected AlertsMessageBag $alert,
        protected LocationCreationService $creationService,
        protected LocationDeletionService $deletionService,
        protected LocationRepositoryInterface $repository,
        protected LocationUpdateService $updateService,
        protected ViewFactory $view
    ) {
    }

    /**
     * Return the location overview page.
     */
    public function index(): View
    {
        return $this->view->make('admin.locations.index', [
            'locations' => $this->repository->getAllWithDetails(),
        ]);
    }

    /**
     * Return the location view page.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function view(int $id): View
    {
        return $this->view->make('admin.locations.view', [
            'location' => $this->repository->getWithNodes($id),
        ]);
    }

    /**
     * Handle request to create new location.
     *
     * @throws \Throwable
     */
    public function create(LocationFormRequest $request): RedirectResponse
    {
        $location = $this->creationService->handle($request->normalize());
        $this->alert->success('Location was created successfully.')->flash();

        return redirect()->route('admin.locations.view', $location->id);
    }

    /**
     * Handle request to update or delete location.
     *
     * @throws \Throwable
     */
    public function update(LocationFormRequest $request, Location $location): RedirectResponse
    {
        if ($request->input('action') === 'delete') {
            return $this->delete($location);
        }

        $this->updateService->handle($location->id, $request->normalize());
        $this->alert->success('Location was updated successfully.')->flash();

        return redirect()->route('admin.locations.view', $location->id);
    }

    /**
     * Delete a location from the system.
     *
     * @throws \Exception
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    public function delete(Location $location): RedirectResponse
    {
        try {
            $this->deletionService->handle($location->id);

            return redirect()->route('admin.locations');
        } catch (DisplayException $ex) {
            $this->alert->danger($ex->getMessage())->flash();
        }

        return redirect()->route('admin.locations.view', $location->id);
    }
}
</file>

<file path="app/Http/Controllers/Admin/MountController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin;

use Ramsey\Uuid\Uuid;
use Illuminate\View\View;
use Jexactyl\Models\Nest;
use Jexactyl\Models\Mount;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Jexactyl\Models\Location;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\View\Factory as ViewFactory;
use Jexactyl\Http\Requests\Admin\MountFormRequest;
use Jexactyl\Repositories\Eloquent\MountRepository;
use Jexactyl\Contracts\Repository\NestRepositoryInterface;
use Jexactyl\Contracts\Repository\LocationRepositoryInterface;

class MountController extends Controller
{
    /**
     * MountController constructor.
     */
    public function __construct(
        protected AlertsMessageBag $alert,
        protected NestRepositoryInterface $nestRepository,
        protected LocationRepositoryInterface $locationRepository,
        protected MountRepository $repository,
        protected ViewFactory $view
    ) {
    }

    /**
     * Return the mount overview page.
     */
    public function index(): View
    {
        return $this->view->make('admin.mounts.index', [
            'mounts' => $this->repository->getAllWithDetails(),
        ]);
    }

    /**
     * Return the mount view page.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function view(string $id): View
    {
        $nests = Nest::query()->with('eggs')->get();
        $locations = Location::query()->with('nodes')->get();

        return $this->view->make('admin.mounts.view', [
            'mount' => $this->repository->getWithRelations($id),
            'nests' => $nests,
            'locations' => $locations,
        ]);
    }

    /**
     * Handle request to create new mount.
     *
     * @throws \Throwable
     */
    public function create(MountFormRequest $request): RedirectResponse
    {
        $model = (new Mount())->fill($request->validated());
        $model->forceFill(['uuid' => Uuid::uuid4()->toString()]);

        $model->saveOrFail();
        $mount = $model->fresh();

        $this->alert->success('Mount was created successfully.')->flash();

        return redirect()->route('admin.mounts.view', $mount->id);
    }

    /**
     * Handle request to update or delete location.
     *
     * @throws \Throwable
     */
    public function update(MountFormRequest $request, Mount $mount): RedirectResponse
    {
        if ($request->input('action') === 'delete') {
            return $this->delete($mount);
        }

        $mount->forceFill($request->validated())->save();

        $this->alert->success('Mount was updated successfully.')->flash();

        return redirect()->route('admin.mounts.view', $mount->id);
    }

    /**
     * Delete a location from the system.
     *
     * @throws \Exception
     */
    public function delete(Mount $mount): RedirectResponse
    {
        $mount->delete();

        return redirect()->route('admin.mounts');
    }

    /**
     * Adds eggs to the mount's many-to-many relation.
     */
    public function addEggs(Request $request, Mount $mount): RedirectResponse
    {
        $validatedData = $request->validate([
            'eggs' => 'required|exists:eggs,id',
        ]);

        $eggs = $validatedData['eggs'] ?? [];
        if (count($eggs) > 0) {
            $mount->eggs()->attach($eggs);
        }

        $this->alert->success('Mount was updated successfully.')->flash();

        return redirect()->route('admin.mounts.view', $mount->id);
    }

    /**
     * Adds nodes to the mount's many-to-many relation.
     */
    public function addNodes(Request $request, Mount $mount): RedirectResponse
    {
        $data = $request->validate(['nodes' => 'required|exists:nodes,id']);

        $nodes = $data['nodes'] ?? [];
        if (count($nodes) > 0) {
            $mount->nodes()->attach($nodes);
        }

        $this->alert->success('Mount was updated successfully.')->flash();

        return redirect()->route('admin.mounts.view', $mount->id);
    }

    /**
     * Deletes an egg from the mount's many-to-many relation.
     */
    public function deleteEgg(Mount $mount, int $egg_id): Response
    {
        $mount->eggs()->detach($egg_id);

        return response('', 204);
    }

    /**
     * Deletes a node from the mount's many-to-many relation.
     */
    public function deleteNode(Mount $mount, int $node_id): Response
    {
        $mount->nodes()->detach($node_id);

        return response('', 204);
    }
}
</file>

<file path="app/Http/Controllers/Admin/NodeAutoDeployController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin;

use Jexactyl\Models\Node;
use Jexactyl\Models\ApiKey;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Services\Api\KeyCreationService;
use Illuminate\Contracts\Encryption\Encrypter;
use Jexactyl\Repositories\Eloquent\ApiKeyRepository;

class NodeAutoDeployController extends Controller
{
    /**
     * NodeAutoDeployController constructor.
     */
    public function __construct(
        private ApiKeyRepository $repository,
        private Encrypter $encrypter,
        private KeyCreationService $keyCreationService
    ) {
    }

    /**
     * Generates a new API key for the logged-in user with only permission to read
     * nodes, and returns that as the deployment key for a node.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function __invoke(Request $request, Node $node): JsonResponse
    {
        /** @var \Jexactyl\Models\ApiKey|null $key */
        $key = $this->repository->getApplicationKeys($request->user())
            ->filter(function (ApiKey $key) {
                foreach ($key->getAttributes() as $permission => $value) {
                    if ($permission === 'r_nodes' && $value === 1) {
                        return true;
                    }
                }

                return false;
            })
            ->first();

        // We couldn't find a key that exists for this user with only permission for
        // reading nodes. Go ahead and create it now.
        if (!$key) {
            $key = $this->keyCreationService->setKeyType(ApiKey::TYPE_APPLICATION)->handle([
                'user_id' => $request->user()->id,
                'memo' => 'Automatically generated node deployment key.',
                'allowed_ips' => [],
            ], ['r_nodes' => 1]);
        }

        return new JsonResponse([
            'node' => $node->id,
            'token' => $key->identifier . $this->encrypter->decrypt($key->token),
        ]);
    }
}
</file>

<file path="app/Http/Controllers/Admin/NodesController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin;

use Illuminate\View\View;
use Jexactyl\Models\Node;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Jexactyl\Models\Allocation;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\View\Factory as ViewFactory;
use Jexactyl\Services\Nodes\NodeUpdateService;
use Jexactyl\Services\Nodes\NodeCreationService;
use Jexactyl\Services\Nodes\NodeDeletionService;
use Illuminate\Cache\Repository as CacheRepository;
use Jexactyl\Services\Allocations\AssignmentService;
use Jexactyl\Services\Helpers\SoftwareVersionService;
use Jexactyl\Http\Requests\Admin\Node\NodeFormRequest;
use Jexactyl\Contracts\Repository\NodeRepositoryInterface;
use Jexactyl\Contracts\Repository\ServerRepositoryInterface;
use Jexactyl\Http\Requests\Admin\Node\AllocationFormRequest;
use Jexactyl\Services\Allocations\AllocationDeletionService;
use Jexactyl\Contracts\Repository\LocationRepositoryInterface;
use Jexactyl\Contracts\Repository\AllocationRepositoryInterface;
use Jexactyl\Http\Requests\Admin\Node\AllocationAliasFormRequest;

class NodesController extends Controller
{
    /**
     * NodesController constructor.
     */
    public function __construct(
        protected AlertsMessageBag $alert,
        protected AllocationDeletionService $allocationDeletionService,
        protected AllocationRepositoryInterface $allocationRepository,
        protected AssignmentService $assignmentService,
        protected CacheRepository $cache,
        protected NodeCreationService $creationService,
        protected NodeDeletionService $deletionService,
        protected LocationRepositoryInterface $locationRepository,
        protected NodeRepositoryInterface $repository,
        protected ServerRepositoryInterface $serverRepository,
        protected NodeUpdateService $updateService,
        protected SoftwareVersionService $versionService,
        protected ViewFactory $view
    ) {
    }

    /**
     * Displays create new node page.
     */
    public function create(): View|RedirectResponse
    {
        $locations = $this->locationRepository->all();
        if (count($locations) < 1) {
            $this->alert->warning(trans('admin/node.notices.location_required'))->flash();

            return redirect()->route('admin.locations');
        }

        return $this->view->make('admin.nodes.new', ['locations' => $locations]);
    }

    /**
     * Post controller to create a new node on the system.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function store(NodeFormRequest $request): RedirectResponse
    {
        $node = $this->creationService->handle($request->normalize());
        $this->alert->info(trans('admin/node.notices.node_created'))->flash();

        return redirect()->route('admin.nodes.view.allocation', $node->id);
    }

    /**
     * Updates settings for a node.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function updateSettings(NodeFormRequest $request, Node $node): RedirectResponse
    {
        $this->updateService->handle($node, $request->normalize(), $request->input('reset_secret') === 'on');
        $this->alert->success(trans('admin/node.notices.node_updated'))->flash();

        return redirect()->route('admin.nodes.view.settings', $node->id)->withInput();
    }

    /**
     * Removes a single allocation from a node.
     *
     * @throws \Jexactyl\Exceptions\Service\Allocation\ServerUsingAllocationException
     */
    public function allocationRemoveSingle(int $node, Allocation $allocation): Response
    {
        $this->allocationDeletionService->handle($allocation);

        return response('', 204);
    }

    /**
     * Removes multiple individual allocations from a node.
     *
     * @throws \Jexactyl\Exceptions\Service\Allocation\ServerUsingAllocationException
     */
    public function allocationRemoveMultiple(Request $request, int $node): Response
    {
        $allocations = $request->input('allocations');
        foreach ($allocations as $rawAllocation) {
            $allocation = new Allocation();
            $allocation->id = $rawAllocation['id'];
            $this->allocationRemoveSingle($node, $allocation);
        }

        return response('', 204);
    }

    /**
     * Remove all allocations for a specific IP at once on a node.
     */
    public function allocationRemoveBlock(Request $request, int $node): RedirectResponse
    {
        $this->allocationRepository->deleteWhere([
            ['node_id', '=', $node],
            ['server_id', '=', null],
            ['ip', '=', $request->input('ip')],
        ]);

        $this->alert->success(trans('admin/node.notices.unallocated_deleted', ['ip' => $request->input('ip')]))
            ->flash();

        return redirect()->route('admin.nodes.view.allocation', $node);
    }

    /**
     * Sets an alias for a specific allocation on a node.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function allocationSetAlias(AllocationAliasFormRequest $request): \Symfony\Component\HttpFoundation\Response
    {
        $this->allocationRepository->update($request->input('allocation_id'), [
            'ip_alias' => (empty($request->input('alias'))) ? null : $request->input('alias'),
        ]);

        return response('', 204);
    }

    /**
     * Creates new allocations on a node.
     *
     * @throws \Jexactyl\Exceptions\Service\Allocation\CidrOutOfRangeException
     * @throws \Jexactyl\Exceptions\Service\Allocation\InvalidPortMappingException
     * @throws \Jexactyl\Exceptions\Service\Allocation\PortOutOfRangeException
     * @throws \Jexactyl\Exceptions\Service\Allocation\TooManyPortsInRangeException
     */
    public function createAllocation(AllocationFormRequest $request, Node $node): RedirectResponse
    {
        $this->assignmentService->handle($node, $request->normalize());
        $this->alert->success(trans('admin/node.notices.allocations_added'))->flash();

        return redirect()->route('admin.nodes.view.allocation', $node->id);
    }

    /**
     * Deletes a node from the system.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    public function delete(int|Node $node): RedirectResponse
    {
        $this->deletionService->handle($node);
        $this->alert->success(trans('admin/node.notices.node_deleted'))->flash();

        return redirect()->route('admin.nodes');
    }
}
</file>

<file path="app/Http/Controllers/Admin/ServersController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin;

use Jexactyl\Models\User;
use Jexactyl\Models\Mount;
use Jexactyl\Models\Server;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Jexactyl\Models\Database;
use Jexactyl\Models\MountServer;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\Validation\ValidationException;
use Jexactyl\Services\Servers\SuspensionService;
use Jexactyl\Repositories\Eloquent\MountRepository;
use Jexactyl\Services\Servers\ServerDeletionService;
use Jexactyl\Services\Servers\ReinstallServerService;
use Jexactyl\Exceptions\Model\DataValidationException;
use Jexactyl\Repositories\Wings\DaemonServerRepository;
use Jexactyl\Services\Servers\BuildModificationService;
use Jexactyl\Services\Databases\DatabasePasswordService;
use Jexactyl\Services\Servers\DetailsModificationService;
use Jexactyl\Services\Servers\StartupModificationService;
use Jexactyl\Contracts\Repository\NestRepositoryInterface;
use Jexactyl\Repositories\Eloquent\DatabaseHostRepository;
use Jexactyl\Services\Databases\DatabaseManagementService;
use Jexactyl\Contracts\Repository\ServerRepositoryInterface;
use Jexactyl\Contracts\Repository\DatabaseRepositoryInterface;
use Illuminate\Contracts\Config\Repository as ConfigRepository;
use Jexactyl\Contracts\Repository\AllocationRepositoryInterface;
use Jexactyl\Services\Servers\ServerConfigurationStructureService;
use Jexactyl\Http\Requests\Admin\Servers\Databases\StoreServerDatabaseRequest;

class ServersController extends Controller
{
    /**
     * ServersController constructor.
     */
    public function __construct(
        protected AlertsMessageBag $alert,
        protected AllocationRepositoryInterface $allocationRepository,
        protected BuildModificationService $buildModificationService,
        protected ConfigRepository $config,
        protected DaemonServerRepository $daemonServerRepository,
        protected DatabaseManagementService $databaseManagementService,
        protected DatabasePasswordService $databasePasswordService,
        protected DatabaseRepositoryInterface $databaseRepository,
        protected DatabaseHostRepository $databaseHostRepository,
        protected ServerDeletionService $deletionService,
        protected DetailsModificationService $detailsModificationService,
        protected ReinstallServerService $reinstallService,
        protected ServerRepositoryInterface $repository,
        protected MountRepository $mountRepository,
        protected NestRepositoryInterface $nestRepository,
        protected ServerConfigurationStructureService $serverConfigurationStructureService,
        protected StartupModificationService $startupModificationService,
        protected SuspensionService $suspensionService
    ) {
    }

    /**
     * Update the details for a server.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function setDetails(Request $request, Server $server): RedirectResponse
    {
        $this->detailsModificationService->handle($server, $request->only([
            'owner_id', 'external_id', 'name', 'description', 'renewable', 'renewal',
        ]));

        $this->alert->success(trans('admin/server.alerts.details_updated'))->flash();

        return redirect()->route('admin.servers.view.details', $server->id);
    }

    /**
     * Toggles the installation status for a server.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function toggleInstall(Server $server): RedirectResponse
    {
        if ($server->status === Server::STATUS_INSTALL_FAILED) {
            throw new DisplayException(trans('admin/server.exceptions.marked_as_failed'));
        }

        $this->repository->update($server->id, [
            'status' => $server->isInstalled() ? Server::STATUS_INSTALLING : null,
        ], true, true);

        $this->alert->success(trans('admin/server.alerts.install_toggled'))->flash();

        return redirect()->route('admin.servers.view.manage', $server->id);
    }

    /**
     * Reinstalls the server with the currently assigned service.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function reinstallServer(Server $server): RedirectResponse
    {
        $this->reinstallService->handle($server);
        $this->alert->success(trans('admin/server.alerts.server_reinstalled'))->flash();

        return redirect()->route('admin.servers.view.manage', $server->id);
    }

    /**
     * Manage the suspension status for a server.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function manageSuspension(Request $request, Server $server): RedirectResponse
    {
        $this->suspensionService->toggle($server, $request->input('action'));
        $this->alert->success(trans('admin/server.alerts.suspension_toggled', [
            'status' => $request->input('action') . 'ed',
        ]))->flash();

        return redirect()->route('admin.servers.view.manage', $server->id);
    }

    /**
     * Update the build configuration for a server.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     * @throws \Illuminate\Validation\ValidationException
     */
    public function updateBuild(Request $request, Server $server): RedirectResponse
    {
        try {
            $this->buildModificationService->handle($server, $request->only([
                'allocation_id', 'add_allocations', 'remove_allocations',
                'memory', 'swap', 'io', 'cpu', 'threads', 'disk',
                'database_limit', 'allocation_limit', 'backup_limit', 'oom_disabled',
            ]));
        } catch (DataValidationException $exception) {
            throw new ValidationException($exception->getValidator());
        }

        $this->alert->success(trans('admin/server.alerts.build_updated'))->flash();

        return redirect()->route('admin.servers.view.build', $server->id);
    }

    /**
     * Start the server deletion process.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Throwable
     */
    public function delete(Request $request, Server $server): RedirectResponse
    {
        $this->deletionService
            ->withForce($request->filled('force_delete'))
            ->returnResources($request->filled('return_resources'))
            ->handle($server);

        $this->alert->success(trans('admin/server.alerts.server_deleted'))->flash();

        return redirect()->route('admin.servers');
    }

    /**
     * Update the startup command as well as variables.
     *
     * @throws \Illuminate\Validation\ValidationException
     */
    public function saveStartup(Request $request, Server $server): RedirectResponse
    {
        $data = $request->except('_token');
        if (!empty($data['custom_docker_image'])) {
            $data['docker_image'] = $data['custom_docker_image'];
            unset($data['custom_docker_image']);
        }

        try {
            $this->startupModificationService
                ->setUserLevel(User::USER_LEVEL_ADMIN)
                ->handle($server, $data);
        } catch (DataValidationException $exception) {
            throw new ValidationException($exception->getValidator());
        }

        $this->alert->success(trans('admin/server.alerts.startup_changed'))->flash();

        return redirect()->route('admin.servers.view.startup', $server->id);
    }

    /**
     * Creates a new database assigned to a specific server.
     *
     * @throws \Throwable
     */
    public function newDatabase(StoreServerDatabaseRequest $request, Server $server): RedirectResponse
    {
        $this->databaseManagementService->create($server, [
            'database' => DatabaseManagementService::generateUniqueDatabaseName($request->input('database'), $server->id),
            'remote' => $request->input('remote'),
            'database_host_id' => $request->input('database_host_id'),
            'max_connections' => $request->input('max_connections'),
        ]);

        return redirect()->route('admin.servers.view.database', $server->id)->withInput();
    }

    /**
     * Resets the database password for a specific database on this server.
     *
     * @throws \Throwable
     */
    public function resetDatabasePassword(Request $request, Server $server): Response
    {
        /** @var \Jexactyl\Models\Database $database */
        $database = $server->databases()->findOrFail($request->input('database'));

        $this->databasePasswordService->handle($database);

        return response('', 204);
    }

    /**
     * Deletes a database from a server.
     *
     * @throws \Exception
     */
    public function deleteDatabase(Server $server, Database $database): Response
    {
        $this->databaseManagementService->delete($database);

        return response('', 204);
    }

    /**
     * Add a mount to a server.
     *
     * @throws \Throwable
     */
    public function addMount(Request $request, Server $server): RedirectResponse
    {
        $mountServer = (new MountServer())->forceFill([
            'mount_id' => $request->input('mount_id'),
            'server_id' => $server->id,
        ]);

        $mountServer->saveOrFail();

        $this->alert->success('Mount was added successfully.')->flash();

        return redirect()->route('admin.servers.view.mounts', $server->id);
    }

    /**
     * Remove a mount from a server.
     */
    public function deleteMount(Server $server, Mount $mount): RedirectResponse
    {
        MountServer::where('mount_id', $mount->id)->where('server_id', $server->id)->delete();

        $this->alert->success('Mount was removed successfully.')->flash();

        return redirect()->route('admin.servers.view.mounts', $server->id);
    }
}
</file>

<file path="app/Http/Controllers/Admin/TicketsController.php">
<?php

namespace Jexactyl\Http\Controllers\Admin;

use Illuminate\View\View;
use Jexactyl\Models\Ticket;
use Illuminate\View\Factory;
use Jexactyl\Models\TicketMessage;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Http\Requests\Admin\Tickets\TicketStatusRequest;
use Jexactyl\Http\Requests\Admin\Tickets\TicketToggleRequest;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;
use Jexactyl\Http\Requests\Admin\Tickets\TicketMessageRequest;

class TicketsController extends Controller
{
    public function __construct(
        protected Factory $view,
        protected AlertsMessageBag $alert,
        protected SettingsRepositoryInterface $settings
    ) {
    }

    /**
     * List the available tickets.
     */
    public function index(): View
    {
        return $this->view->make('admin.tickets.index', [
            'tickets' => Ticket::all(),
            'enabled' => $this->settings->get('jexactyl::tickets:enabled', false),
            'max' => $this->settings->get('jexactyl::tickets:max', 3),
        ]);
    }

    /**
     * View a specific ticket.
     */
    public function view(int $id): View
    {
        return $this->view->make('admin.tickets.view', [
            'ticket' => Ticket::findOrFail($id),
            'messages' => TicketMessage::where('ticket_id', $id)->get(),
        ]);
    }

    /**
     * Enable or disable tickets on the system.
     */
    public function toggle(TicketToggleRequest $request): RedirectResponse
    {
        foreach ($request->normalize() as $key => $value) {
            $this->settings->set('jexactyl::tickets:' . $key, $value);
        }

        return redirect()->route('admin.tickets.index');
    }

    /**
     * Update the status of a ticket.
     */
    public function status(TicketStatusRequest $request, int $id): RedirectResponse
    {
        Ticket::findOrFail($id)->update(['status' => $request->input('status')]);

        TicketMessage::create([
            'user_id' => 0,
            'ticket_id' => $id,
            'content' => 'Ticket status has been set to ' . $request->input('status'),
        ]);

        return redirect()->route('admin.tickets.view', $id);
    }

    /**
     * Add a message to the ticket.
     */
    public function message(TicketMessageRequest $request, int $id): RedirectResponse
    {
        TicketMessage::create([
            'user_id' => $request->user()->id,
            'ticket_id' => $id,
            'content' => $request->input('content'),
        ]);

        return redirect()->route('admin.tickets.view', $id);
    }

    /**
     * Deletes a ticket and the associated messages.
     */
    public function delete(int $id): RedirectResponse
    {
        Ticket::findOrFail($id)->delete();
        TicketMessage::where('ticket_id', $id)->delete();

        $this->alert->success('Ticket ' . $id . ' has been deleted.')->flash();

        return redirect()->route('admin.tickets.index');
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/Locations/LocationController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application\Locations;

use Illuminate\Http\Response;
use Jexactyl\Models\Location;
use Illuminate\Http\JsonResponse;
use Spatie\QueryBuilder\QueryBuilder;
use Jexactyl\Services\Locations\LocationUpdateService;
use Jexactyl\Services\Locations\LocationCreationService;
use Jexactyl\Services\Locations\LocationDeletionService;
use Jexactyl\Transformers\Api\Application\LocationTransformer;
use Jexactyl\Http\Controllers\Api\Application\ApplicationApiController;
use Jexactyl\Http\Requests\Api\Application\Locations\GetLocationRequest;
use Jexactyl\Http\Requests\Api\Application\Locations\GetLocationsRequest;
use Jexactyl\Http\Requests\Api\Application\Locations\StoreLocationRequest;
use Jexactyl\Http\Requests\Api\Application\Locations\DeleteLocationRequest;
use Jexactyl\Http\Requests\Api\Application\Locations\UpdateLocationRequest;

class LocationController extends ApplicationApiController
{
    /**
     * LocationController constructor.
     */
    public function __construct(
        private LocationCreationService $creationService,
        private LocationDeletionService $deletionService,
        private LocationUpdateService $updateService
    ) {
        parent::__construct();
    }

    /**
     * Return all the locations currently registered on the Panel.
     */
    public function index(GetLocationsRequest $request): array
    {
        $locations = QueryBuilder::for(Location::query())
            ->allowedFilters(['short', 'long'])
            ->allowedSorts(['id'])
            ->paginate($request->query('per_page') ?? 50);

        return $this->fractal->collection($locations)
            ->transformWith($this->getTransformer(LocationTransformer::class))
            ->toArray();
    }

    /**
     * Return a single location.
     */
    public function view(GetLocationRequest $request, Location $location): array
    {
        return $this->fractal->item($location)
            ->transformWith($this->getTransformer(LocationTransformer::class))
            ->toArray();
    }

    /**
     * Store a new location on the Panel and return an HTTP/201 response code with the
     * new location attached.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function store(StoreLocationRequest $request): JsonResponse
    {
        $location = $this->creationService->handle($request->validated());

        return $this->fractal->item($location)
            ->transformWith($this->getTransformer(LocationTransformer::class))
            ->addMeta([
                'resource' => route('api.application.locations.view', [
                    'location' => $location->id,
                ]),
            ])
            ->respond(201);
    }

    /**
     * Update a location on the Panel and return the updated record to the user.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(UpdateLocationRequest $request, Location $location): array
    {
        $location = $this->updateService->handle($location, $request->validated());

        return $this->fractal->item($location)
            ->transformWith($this->getTransformer(LocationTransformer::class))
            ->toArray();
    }

    /**
     * Delete a location from the Panel.
     *
     * @throws \Jexactyl\Exceptions\Service\Location\HasActiveNodesException
     */
    public function delete(DeleteLocationRequest $request, Location $location): Response
    {
        $this->deletionService->handle($location);

        return response('', 204);
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/Nests/EggController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application\Nests;

use Jexactyl\Models\Egg;
use Jexactyl\Models\Nest;
use Jexactyl\Transformers\Api\Application\EggTransformer;
use Jexactyl\Http\Requests\Api\Application\Nests\Eggs\GetEggRequest;
use Jexactyl\Http\Requests\Api\Application\Nests\Eggs\GetEggsRequest;
use Jexactyl\Http\Controllers\Api\Application\ApplicationApiController;

class EggController extends ApplicationApiController
{
    /**
     * Return all eggs that exist for a given nest.
     */
    public function index(GetEggsRequest $request, Nest $nest): array
    {
        return $this->fractal->collection($nest->eggs)
            ->transformWith($this->getTransformer(EggTransformer::class))
            ->toArray();
    }

    /**
     * Return a single egg that exists on the specified nest.
     */
    public function view(GetEggRequest $request, Nest $nest, Egg $egg): array
    {
        return $this->fractal->item($egg)
            ->transformWith($this->getTransformer(EggTransformer::class))
            ->toArray();
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/Nests/NestController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application\Nests;

use Jexactyl\Models\Nest;
use Jexactyl\Contracts\Repository\NestRepositoryInterface;
use Jexactyl\Transformers\Api\Application\NestTransformer;
use Jexactyl\Http\Requests\Api\Application\Nests\GetNestsRequest;
use Jexactyl\Http\Controllers\Api\Application\ApplicationApiController;

class NestController extends ApplicationApiController
{
    /**
     * NestController constructor.
     */
    public function __construct(private NestRepositoryInterface $repository)
    {
        parent::__construct();
    }

    /**
     * Return all Nests that exist on the Panel.
     */
    public function index(GetNestsRequest $request): array
    {
        $nests = $this->repository->paginated($request->query('per_page') ?? 50);

        return $this->fractal->collection($nests)
            ->transformWith($this->getTransformer(NestTransformer::class))
            ->toArray();
    }

    /**
     * Return information about a single Nest model.
     */
    public function view(GetNestsRequest $request, Nest $nest): array
    {
        return $this->fractal->item($nest)
            ->transformWith($this->getTransformer(NestTransformer::class))
            ->toArray();
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/Nodes/AllocationController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application\Nodes;

use Jexactyl\Models\Node;
use Jexactyl\Models\Allocation;
use Illuminate\Http\JsonResponse;
use Spatie\QueryBuilder\QueryBuilder;
use Spatie\QueryBuilder\AllowedFilter;
use Illuminate\Database\Eloquent\Builder;
use Jexactyl\Services\Allocations\AssignmentService;
use Jexactyl\Services\Allocations\AllocationDeletionService;
use Jexactyl\Transformers\Api\Application\AllocationTransformer;
use Jexactyl\Http\Controllers\Api\Application\ApplicationApiController;
use Jexactyl\Http\Requests\Api\Application\Allocations\GetAllocationsRequest;
use Jexactyl\Http\Requests\Api\Application\Allocations\StoreAllocationRequest;
use Jexactyl\Http\Requests\Api\Application\Allocations\DeleteAllocationRequest;

class AllocationController extends ApplicationApiController
{
    /**
     * AllocationController constructor.
     */
    public function __construct(
        private AssignmentService $assignmentService,
        private AllocationDeletionService $deletionService
    ) {
        parent::__construct();
    }

    /**
     * Return all the allocations that exist for a given node.
     */
    public function index(GetAllocationsRequest $request, Node $node): array
    {
        $allocations = QueryBuilder::for($node->allocations())
            ->allowedFilters([
                AllowedFilter::exact('ip'),
                AllowedFilter::exact('port'),
                'ip_alias',
                AllowedFilter::callback('server_id', function (Builder $builder, $value) {
                    if (empty($value) || is_bool($value) || !ctype_digit((string) $value)) {
                        return $builder->whereNull('server_id');
                    }

                    return $builder->where('server_id', $value);
                }),
            ])
            ->paginate($request->query('per_page') ?? 50);

        return $this->fractal->collection($allocations)
            ->transformWith($this->getTransformer(AllocationTransformer::class))
            ->toArray();
    }

    /**
     * Store new allocations for a given node.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Service\Allocation\CidrOutOfRangeException
     * @throws \Jexactyl\Exceptions\Service\Allocation\InvalidPortMappingException
     * @throws \Jexactyl\Exceptions\Service\Allocation\PortOutOfRangeException
     * @throws \Jexactyl\Exceptions\Service\Allocation\TooManyPortsInRangeException
     */
    public function store(StoreAllocationRequest $request, Node $node): JsonResponse
    {
        $this->assignmentService->handle($node, $request->validated());

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }

    /**
     * Delete a specific allocation from the Panel.
     *
     * @throws \Jexactyl\Exceptions\Service\Allocation\ServerUsingAllocationException
     */
    public function delete(DeleteAllocationRequest $request, Node $node, Allocation $allocation): JsonResponse
    {
        $this->deletionService->handle($allocation);

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/Nodes/NodeConfigurationController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application\Nodes;

use Jexactyl\Models\Node;
use Illuminate\Http\JsonResponse;
use Jexactyl\Http\Requests\Api\Application\Nodes\GetNodeRequest;
use Jexactyl\Http\Controllers\Api\Application\ApplicationApiController;

class NodeConfigurationController extends ApplicationApiController
{
    /**
     * Returns the configuration information for a node. This allows for automated deployments
     * to remote machines so long as an API key is provided to the machine to make the request
     * with, and the node is known.
     */
    public function __invoke(GetNodeRequest $request, Node $node): JsonResponse
    {
        return new JsonResponse($node->getConfiguration());
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/Nodes/NodeController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application\Nodes;

use Jexactyl\Models\Node;
use Illuminate\Http\JsonResponse;
use Spatie\QueryBuilder\QueryBuilder;
use Jexactyl\Services\Nodes\NodeUpdateService;
use Jexactyl\Services\Nodes\NodeCreationService;
use Jexactyl\Services\Nodes\NodeDeletionService;
use Jexactyl\Transformers\Api\Application\NodeTransformer;
use Jexactyl\Http\Requests\Api\Application\Nodes\GetNodeRequest;
use Jexactyl\Http\Requests\Api\Application\Nodes\GetNodesRequest;
use Jexactyl\Http\Requests\Api\Application\Nodes\StoreNodeRequest;
use Jexactyl\Http\Requests\Api\Application\Nodes\DeleteNodeRequest;
use Jexactyl\Http\Requests\Api\Application\Nodes\UpdateNodeRequest;
use Jexactyl\Http\Controllers\Api\Application\ApplicationApiController;

class NodeController extends ApplicationApiController
{
    /**
     * NodeController constructor.
     */
    public function __construct(
        private NodeCreationService $creationService,
        private NodeDeletionService $deletionService,
        private NodeUpdateService $updateService
    ) {
        parent::__construct();
    }

    /**
     * Return all the nodes currently available on the Panel.
     */
    public function index(GetNodesRequest $request): array
    {
        $nodes = QueryBuilder::for(Node::query())
            ->allowedFilters(['uuid', 'name', 'fqdn', 'daemon_token_id'])
            ->allowedSorts(['id', 'uuid', 'memory', 'disk'])
            ->paginate($request->query('per_page') ?? 50);

        return $this->fractal->collection($nodes)
            ->transformWith($this->getTransformer(NodeTransformer::class))
            ->toArray();
    }

    /**
     * Return data for a single instance of a node.
     */
    public function view(GetNodeRequest $request, Node $node): array
    {
        return $this->fractal->item($node)
            ->transformWith($this->getTransformer(NodeTransformer::class))
            ->toArray();
    }

    /**
     * Create a new node on the Panel. Returns the created node and an HTTP/201
     * status response on success.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function store(StoreNodeRequest $request): JsonResponse
    {
        $node = $this->creationService->handle($request->validated());

        return $this->fractal->item($node)
            ->transformWith($this->getTransformer(NodeTransformer::class))
            ->addMeta([
                'resource' => route('api.application.nodes.view', [
                    'node' => $node->id,
                ]),
            ])
            ->respond(201);
    }

    /**
     * Update an existing node on the Panel.
     *
     * @throws \Throwable
     */
    public function update(UpdateNodeRequest $request, Node $node): array
    {
        $node = $this->updateService->handle(
            $node,
            $request->validated(),
            $request->input('reset_secret') === true
        );

        return $this->fractal->item($node)
            ->transformWith($this->getTransformer(NodeTransformer::class))
            ->toArray();
    }

    /**
     * Deletes a given node from the Panel as long as there are no servers
     * currently attached to it.
     *
     * @throws \Jexactyl\Exceptions\Service\HasActiveServersException
     */
    public function delete(DeleteNodeRequest $request, Node $node): JsonResponse
    {
        $this->deletionService->handle($node);

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/Nodes/NodeDeploymentController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application\Nodes;

use Jexactyl\Services\Deployment\FindViableNodesService;
use Jexactyl\Transformers\Api\Application\NodeTransformer;
use Jexactyl\Http\Controllers\Api\Application\ApplicationApiController;
use Jexactyl\Http\Requests\Api\Application\Nodes\GetDeployableNodesRequest;

class NodeDeploymentController extends ApplicationApiController
{
    /**
     * NodeDeploymentController constructor.
     */
    public function __construct(private FindViableNodesService $viableNodesService)
    {
        parent::__construct();
    }

    /**
     * Finds any nodes that are available using the given deployment criteria. This works
     * similarly to the server creation process, but allows you to pass the deployment object
     * to this endpoint and get back a list of all Nodes satisfying the requirements.
     *
     * @throws \Jexactyl\Exceptions\Service\Deployment\NoViableNodeException
     */
    public function __invoke(GetDeployableNodesRequest $request): array
    {
        $data = $request->validated();
        $nodes = $this->viableNodesService->setLocations($data['location_ids'] ?? [])
            ->setMemory($data['memory'])
            ->setDisk($data['disk'])
            ->handle($request->query('per_page'), $request->query('page'));

        return $this->fractal->collection($nodes)
            ->transformWith($this->getTransformer(NodeTransformer::class))
            ->toArray();
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/Servers/DatabaseController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application\Servers;

use Jexactyl\Models\Server;
use Illuminate\Http\Response;
use Jexactyl\Models\Database;
use Illuminate\Http\JsonResponse;
use Jexactyl\Services\Databases\DatabasePasswordService;
use Jexactyl\Services\Databases\DatabaseManagementService;
use Jexactyl\Transformers\Api\Application\ServerDatabaseTransformer;
use Jexactyl\Http\Controllers\Api\Application\ApplicationApiController;
use Jexactyl\Http\Requests\Api\Application\Servers\Databases\GetServerDatabaseRequest;
use Jexactyl\Http\Requests\Api\Application\Servers\Databases\GetServerDatabasesRequest;
use Jexactyl\Http\Requests\Api\Application\Servers\Databases\ServerDatabaseWriteRequest;
use Jexactyl\Http\Requests\Api\Application\Servers\Databases\StoreServerDatabaseRequest;

class DatabaseController extends ApplicationApiController
{
    /**
     * DatabaseController constructor.
     */
    public function __construct(
        private DatabaseManagementService $databaseManagementService,
        private DatabasePasswordService $databasePasswordService
    ) {
        parent::__construct();
    }

    /**
     * Return a listing of all databases currently available to a single
     * server.
     */
    public function index(GetServerDatabasesRequest $request, Server $server): array
    {
        return $this->fractal->collection($server->databases)
            ->transformWith($this->getTransformer(ServerDatabaseTransformer::class))
            ->toArray();
    }

    /**
     * Return a single server database.
     */
    public function view(GetServerDatabaseRequest $request, Server $server, Database $database): array
    {
        return $this->fractal->item($database)
            ->transformWith($this->getTransformer(ServerDatabaseTransformer::class))
            ->toArray();
    }

    /**
     * Reset the password for a specific server database.
     *
     * @throws \Throwable
     */
    public function resetPassword(ServerDatabaseWriteRequest $request, Server $server, Database $database): JsonResponse
    {
        $this->databasePasswordService->handle($database);

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }

    /**
     * Create a new database on the Panel for a given server.
     *
     * @throws \Throwable
     */
    public function store(StoreServerDatabaseRequest $request, Server $server): JsonResponse
    {
        $database = $this->databaseManagementService->create($server, array_merge($request->validated(), [
            'database' => $request->databaseName(),
        ]));

        return $this->fractal->item($database)
            ->transformWith($this->getTransformer(ServerDatabaseTransformer::class))
            ->addMeta([
                'resource' => route('api.application.servers.databases.view', [
                    'server' => $server->id,
                    'database' => $database->id,
                ]),
            ])
            ->respond(Response::HTTP_CREATED);
    }

    /**
     * Handle a request to delete a specific server database from the Panel.
     */
    public function delete(ServerDatabaseWriteRequest $request, Server $server, Database $database): Response
    {
        $this->databaseManagementService->delete($database);

        return response('', 204);
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/Servers/ExternalServerController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application\Servers;

use Jexactyl\Models\Server;
use Jexactyl\Transformers\Api\Application\ServerTransformer;
use Jexactyl\Http\Controllers\Api\Application\ApplicationApiController;
use Jexactyl\Http\Requests\Api\Application\Servers\GetExternalServerRequest;

class ExternalServerController extends ApplicationApiController
{
    /**
     * Retrieve a specific server from the database using its external ID.
     */
    public function index(GetExternalServerRequest $request, string $external_id): array
    {
        $server = Server::query()->where('external_id', $external_id)->firstOrFail();

        return $this->fractal->item($server)
            ->transformWith($this->getTransformer(ServerTransformer::class))
            ->toArray();
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/Servers/ServerController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application\Servers;

use Jexactyl\Models\Server;
use Illuminate\Http\Response;
use Illuminate\Http\JsonResponse;
use Spatie\QueryBuilder\QueryBuilder;
use Jexactyl\Services\Servers\ServerCreationService;
use Jexactyl\Services\Servers\ServerDeletionService;
use Jexactyl\Transformers\Api\Application\ServerTransformer;
use Jexactyl\Http\Requests\Api\Application\Servers\GetServerRequest;
use Jexactyl\Http\Requests\Api\Application\Servers\GetServersRequest;
use Jexactyl\Http\Requests\Api\Application\Servers\ServerWriteRequest;
use Jexactyl\Http\Requests\Api\Application\Servers\StoreServerRequest;
use Jexactyl\Http\Controllers\Api\Application\ApplicationApiController;

class ServerController extends ApplicationApiController
{
    /**
     * ServerController constructor.
     */
    public function __construct(
        private ServerCreationService $creationService,
        private ServerDeletionService $deletionService
    ) {
        parent::__construct();
    }

    /**
     * Return all the servers that currently exist on the Panel.
     */
    public function index(GetServersRequest $request): array
    {
        $servers = QueryBuilder::for(Server::query())
            ->allowedFilters(['uuid', 'uuidShort', 'name', 'description', 'image', 'external_id'])
            ->allowedSorts(['id', 'uuid'])
            ->paginate($request->query('per_page') ?? 50);

        return $this->fractal->collection($servers)
            ->transformWith($this->getTransformer(ServerTransformer::class))
            ->toArray();
    }

    /**
     * Create a new server on the system.
     *
     * @throws \Throwable
     * @throws \Illuminate\Validation\ValidationException
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     * @throws \Jexactyl\Exceptions\Service\Deployment\NoViableAllocationException
     * @throws \Jexactyl\Exceptions\Service\Deployment\NoViableNodeException
     */
    public function store(StoreServerRequest $request): JsonResponse
    {
        $server = $this->creationService->handle($request->validated(), $request->getDeploymentObject());

        return $this->fractal->item($server)
            ->transformWith($this->getTransformer(ServerTransformer::class))
            ->respond(201);
    }

    /**
     * Show a single server transformed for the application API.
     */
    public function view(GetServerRequest $request, Server $server): array
    {
        return $this->fractal->item($server)
            ->transformWith($this->getTransformer(ServerTransformer::class))
            ->toArray();
    }

    /**
     * Deletes a server.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    public function delete(ServerWriteRequest $request, Server $server, string $force = ''): Response
    {
        $this->deletionService
            ->withForce($force === 'force')
            ->returnResources($request->filled('return_resources'))
            ->handle($server);

        return $this->returnNoContent();
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/Servers/ServerDetailsController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application\Servers;

use Jexactyl\Models\Server;
use Jexactyl\Services\Servers\BuildModificationService;
use Jexactyl\Services\Servers\DetailsModificationService;
use Jexactyl\Transformers\Api\Application\ServerTransformer;
use Jexactyl\Http\Controllers\Api\Application\ApplicationApiController;
use Jexactyl\Http\Requests\Api\Application\Servers\UpdateServerDetailsRequest;
use Jexactyl\Http\Requests\Api\Application\Servers\UpdateServerBuildConfigurationRequest;

class ServerDetailsController extends ApplicationApiController
{
    /**
     * ServerDetailsController constructor.
     */
    public function __construct(
        private BuildModificationService $buildModificationService,
        private DetailsModificationService $detailsModificationService
    ) {
        parent::__construct();
    }

    /**
     * Update the details for a specific server.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function details(UpdateServerDetailsRequest $request, Server $server): array
    {
        $updated = $this->detailsModificationService->returnUpdatedModel()->handle(
            $server,
            $request->validated()
        );

        return $this->fractal->item($updated)
            ->transformWith($this->getTransformer(ServerTransformer::class))
            ->toArray();
    }

    /**
     * Update the build details for a specific server.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function build(UpdateServerBuildConfigurationRequest $request, Server $server): array
    {
        $server = $this->buildModificationService->handle($server, $request->validated());

        return $this->fractal->item($server)
            ->transformWith($this->getTransformer(ServerTransformer::class))
            ->toArray();
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/Servers/ServerManagementController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application\Servers;

use Jexactyl\Models\Server;
use Illuminate\Http\Response;
use Jexactyl\Services\Servers\SuspensionService;
use Jexactyl\Services\Servers\ReinstallServerService;
use Jexactyl\Http\Requests\Api\Application\Servers\ServerWriteRequest;
use Jexactyl\Http\Controllers\Api\Application\ApplicationApiController;

class ServerManagementController extends ApplicationApiController
{
    /**
     * ServerManagementController constructor.
     */
    public function __construct(
        private ReinstallServerService $reinstallServerService,
        private SuspensionService $suspensionService
    ) {
        parent::__construct();
    }

    /**
     * Suspend a server on the Panel.
     *
     * @throws \Throwable
     */
    public function suspend(ServerWriteRequest $request, Server $server): Response
    {
        $this->suspensionService->toggle($server);

        return $this->returnNoContent();
    }

    /**
     * Unsuspend a server on the Panel.
     *
     * @throws \Throwable
     */
    public function unsuspend(ServerWriteRequest $request, Server $server): Response
    {
        $this->suspensionService->toggle($server, SuspensionService::ACTION_UNSUSPEND);

        return $this->returnNoContent();
    }

    /**
     * Mark a server as needing to be reinstalled.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function reinstall(ServerWriteRequest $request, Server $server): Response
    {
        $this->reinstallServerService->handle($server);

        return $this->returnNoContent();
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/Servers/StartupController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application\Servers;

use Jexactyl\Models\User;
use Jexactyl\Models\Server;
use Jexactyl\Services\Servers\StartupModificationService;
use Jexactyl\Transformers\Api\Application\ServerTransformer;
use Jexactyl\Http\Controllers\Api\Application\ApplicationApiController;
use Jexactyl\Http\Requests\Api\Application\Servers\UpdateServerStartupRequest;

class StartupController extends ApplicationApiController
{
    /**
     * StartupController constructor.
     */
    public function __construct(private StartupModificationService $modificationService)
    {
        parent::__construct();
    }

    /**
     * Update the startup and environment settings for a specific server.
     *
     * @throws \Illuminate\Validation\ValidationException
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function index(UpdateServerStartupRequest $request, Server $server): array
    {
        $server = $this->modificationService
            ->setUserLevel(User::USER_LEVEL_ADMIN)
            ->handle($server, $request->validated());

        return $this->fractal->item($server)
            ->transformWith($this->getTransformer(ServerTransformer::class))
            ->toArray();
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/Users/ExternalUserController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application\Users;

use Jexactyl\Models\User;
use Jexactyl\Transformers\Api\Application\UserTransformer;
use Jexactyl\Http\Controllers\Api\Application\ApplicationApiController;
use Jexactyl\Http\Requests\Api\Application\Users\GetExternalUserRequest;

class ExternalUserController extends ApplicationApiController
{
    /**
     * Retrieve a specific user from the database using their external ID.
     */
    public function index(GetExternalUserRequest $request, string $external_id): array
    {
        $user = User::query()->where('external_id', $external_id)->firstOrFail();

        return $this->fractal->item($user)
            ->transformWith($this->getTransformer(UserTransformer::class))
            ->toArray();
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/Users/UserController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application\Users;

use Jexactyl\Models\User;
use Illuminate\Http\JsonResponse;
use Spatie\QueryBuilder\QueryBuilder;
use Jexactyl\Services\Users\UserUpdateService;
use Jexactyl\Services\Users\UserCreationService;
use Jexactyl\Services\Users\UserDeletionService;
use Jexactyl\Transformers\Api\Application\UserTransformer;
use Jexactyl\Http\Requests\Api\Application\Users\GetUsersRequest;
use Jexactyl\Http\Requests\Api\Application\Users\StoreUserRequest;
use Jexactyl\Http\Requests\Api\Application\Users\DeleteUserRequest;
use Jexactyl\Http\Requests\Api\Application\Users\UpdateUserRequest;
use Jexactyl\Http\Controllers\Api\Application\ApplicationApiController;

class UserController extends ApplicationApiController
{
    /**
     * UserController constructor.
     */
    public function __construct(
        private UserCreationService $creationService,
        private UserDeletionService $deletionService,
        private UserUpdateService $updateService
    ) {
        parent::__construct();
    }

    /**
     * Handle request to list all users on the panel. Returns a JSON-API representation
     * of a collection of users including any defined relations passed in
     * the request.
     */
    public function index(GetUsersRequest $request): array
    {
        $users = QueryBuilder::for(User::query())
            ->allowedFilters(['email', 'uuid', 'username', 'external_id'])
            ->allowedSorts(['id', 'uuid'])
            ->paginate($request->query('per_page') ?? 50);

        return $this->fractal->collection($users)
            ->transformWith($this->getTransformer(UserTransformer::class))
            ->toArray();
    }

    /**
     * Handle a request to view a single user. Includes any relations that
     * were defined in the request.
     */
    public function view(GetUsersRequest $request, User $user): array
    {
        return $this->fractal->item($user)
            ->transformWith($this->getTransformer(UserTransformer::class))
            ->toArray();
    }

    /**
     * Update an existing user on the system and return the response. Returns the
     * updated user model response on success. Supports handling of token revocation
     * errors when switching a user from an admin to a normal user.
     *
     * Revocation errors are returned under the 'revocation_errors' key in the response
     * meta. If there are no errors this is an empty array.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(UpdateUserRequest $request, User $user): array
    {
        $this->updateService->setUserLevel(User::USER_LEVEL_ADMIN);
        $user = $this->updateService->handle($user, $request->validated());

        $response = $this->fractal->item($user)
            ->transformWith($this->getTransformer(UserTransformer::class));

        return $response->toArray();
    }

    /**
     * Store a new user on the system. Returns the created user and an HTTP/201
     * header on successful creation.
     *
     * @throws \Exception
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function store(StoreUserRequest $request): JsonResponse
    {
        $user = $this->creationService->handle($request->validated());

        return $this->fractal->item($user)
            ->transformWith($this->getTransformer(UserTransformer::class))
            ->addMeta([
                'resource' => route('api.application.users.view', [
                    'user' => $user->id,
                ]),
            ])
            ->respond(201);
    }

    /**
     * Handle a request to delete a user from the Panel. Returns a HTTP/204 response
     * on successful deletion.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    public function delete(DeleteUserRequest $request, User $user): JsonResponse
    {
        $this->deletionService->handle($user);

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/Users/UserResourcesController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application\Users;

use Jexactyl\Models\User;
use Illuminate\Http\Response;
use Jexactyl\Services\Users\UserUpdateService;
use Jexactyl\Contracts\Repository\UserRepositoryInterface;
use Jexactyl\Http\Requests\Api\Application\Users\GetUsersRequest;
use Jexactyl\Http\Requests\Api\Application\Users\UpdateUserRequest;
use Jexactyl\Transformers\Api\Application\UserResourcesTransformer;
use Jexactyl\Http\Controllers\Api\Application\ApplicationApiController;

class UserResourcesController extends ApplicationApiController
{
    /**
     * @var \Jexactyl\Contracts\Repository\UserRepositoryInterface
     */
    private $repository;

    /**
     * @var \Jexactyl\Services\Users\UserUpdateService
     */
    private $updateService;

    /**
     * UserController constructor.
     */
    public function __construct(
        UserUpdateService $updateService,
        UserRepositoryInterface $repository
    ) {
        parent::__construct();

        $this->repository = $repository;
        $this->updateService = $updateService;
    }

    /**
     * View a user's resources.
     */
    public function view(GetUsersRequest $request, User $user): array
    {
        return $this->fractal->item($user)
            ->transformWith($this->getTransformer(UserResourcesTransformer::class))
            ->toArray()
            ->respond(201);
    }

    /**
     * Update an existing user on the system and return the response. Returns the
     * updated user model response on success. Supports handling of token revocation
     * errors when switching a user from an admin to a normal user.
     *
     * Revocation errors are returned under the 'revocation_errors' key in the response
     * meta. If there are no errors this is an empty array.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(UpdateUserRequest $request, User $user): array
    {
        // TODO: use userUpdateService in future.
        $user->update([
            'store_balance' => $request->input('store_balance'),
            'store_cpu' => $request->input('store_cpu'),
            'store_memory' => $request->input('store_memory'),
            'store_disk' => $request->input('store_disk'),
            'store_slots' => $request->input('store_slots'),
            'store_ports' => $request->input('store_ports'),
            'store_backups' => $request->input('store_backups'),
            'store_databases' => $request->input('store_databases'),
        ]);

        return $this->fractal->item($user)
            > transformWith($this->getTransformer(UserResourcesTransformer::class))
            ->toArray()
            ->respond(201);
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/ApplicationApiController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application;

use Illuminate\Http\Request;
use Webmozart\Assert\Assert;
use Illuminate\Http\Response;
use Illuminate\Support\Collection;
use Illuminate\Container\Container;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Extensions\Spatie\Fractalistic\Fractal;
use Jexactyl\Transformers\Api\Application\BaseTransformer;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;

abstract class ApplicationApiController extends Controller
{
    protected Request $request;

    protected Fractal $fractal;

    /**
     * @var \Jexactyl\Contracts\Repository\SettingsRepositoryInterface
     */
    protected $settings;

    /**
     * ApplicationApiController constructor.
     */
    public function __construct()
    {
        Container::getInstance()->call([$this, 'loadDependencies']);

        // Parse all the includes to use on this request.
        $input = $this->request->input('include', []);
        $input = is_array($input) ? $input : explode(',', $input);

        $includes = (new Collection($input))->map(function ($value) {
            return trim($value);
        })->filter()->toArray();

        $this->fractal->parseIncludes($includes);
        $this->fractal->limitRecursion(2);
    }

    /**
     * Perform dependency injection of certain classes needed for core functionality
     * without littering the constructors of classes that extend this abstract.
     */
    public function loadDependencies(
        Fractal $fractal,
        Request $request,
        SettingsRepositoryInterface $settings,
    ) {
        $this->fractal = $fractal;
        $this->request = $request;
        $this->settings = $settings;
    }

    /**
     * Return an instance of an application transformer.
     *
     * @template T of \Jexactyl\Transformers\Api\Application\BaseTransformer
     *
     * @param class-string<T> $abstract
     *
     * @return T
     *
     * @noinspection PhpDocSignatureInspection
     */
    public function getTransformer(string $abstract)
    {
        Assert::subclassOf($abstract, BaseTransformer::class);

        return $abstract::fromRequest($this->request);
    }

    /**
     * Return an HTTP/204 response for the API.
     */
    protected function returnNoContent(): Response
    {
        return new Response('', Response::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Application/ApprovalsController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Application;

use Jexactyl\Models\User;
use Illuminate\Http\Response;

class ApprovalsController extends ApplicationApiController
{
    /**
     * Render the Jexactyl referrals interface.
     */
    public function index(): User
    {
        return User::where('approved', false)->get();
    }

    /**
     * Approve an incoming approval request.
     */
    public function approve(int $id): Response
    {
        $user = User::where('id', $id)->first();
        $user->update(['approved' => true]);
        // This gives the user access to the frontend.

        return $this->returnNoContent();
    }

    /**
     * Deny an incoming approval request.
     */
    public function deny(int $id): Response
    {
        $user = User::where('id', $id)->first();
        $user->delete();
        // While typically we should look for associated servers, there
        // shouldn't be any present - as the user has been waiting for approval.

        return $this->returnNoContent();
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/ActivityLogController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Jexactyl\Models\User;
use Jexactyl\Models\Server;
use Jexactyl\Models\Permission;
use Jexactyl\Models\ActivityLog;
use Spatie\QueryBuilder\QueryBuilder;
use Spatie\QueryBuilder\AllowedFilter;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Query\JoinClause;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Jexactyl\Transformers\Api\Client\ActivityLogTransformer;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;

class ActivityLogController extends ClientApiController
{
    /**
     * Returns the activity logs for a server.
     */
    public function __invoke(ClientApiRequest $request, Server $server): array
    {
        $this->authorize(Permission::ACTION_ACTIVITY_READ, $server);

        $activity = QueryBuilder::for($server->activity())
            ->with('actor')
            ->allowedSorts(['timestamp'])
            ->allowedFilters([AllowedFilter::partial('event')])
            ->whereNotIn('activity_logs.event', ActivityLog::DISABLED_EVENTS)
            ->when(config('activity.hide_admin_activity'), function (Builder $builder) use ($server) {
                // We could do this with a query and a lot of joins, but that gets pretty
                // painful so for now we'll execute a simpler query.
                $subusers = $server->subusers()->pluck('user_id')->merge($server->owner_id);

                $builder->select('activity_logs.*')
                    ->leftJoin('users', function (JoinClause $join) {
                        $join->on('users.id', 'activity_logs.actor_id')
                            ->where('activity_logs.actor_type', (new User())->getMorphClass());
                    })
                    ->where(function (Builder $builder) use ($subusers) {
                        $builder->whereNull('users.id')
                            ->orWhere('users.root_admin', 0)
                            ->orWhereIn('users.id', $subusers);
                    });
            })
            ->paginate(min($request->query('per_page', 25), 100))
            ->appends($request->query());

        return $this->fractal->collection($activity)
            ->transformWith($this->getTransformer(ActivityLogTransformer::class))
            ->toArray();
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/AnalyticsController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Jexactyl\Models\Server;
use Jexactyl\Models\AnalyticsData;
use Jexactyl\Models\AnalyticsMessage;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Jexactyl\Transformers\Api\Client\Analytics\MessageTransformer;
use Jexactyl\Transformers\Api\Client\Analytics\AnalyticsTransformer;

class AnalyticsController extends ClientApiController
{
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * Returns all of the analytics assigned to a given server.
     */
    public function index(ClientApiRequest $request, Server $server): array
    {
        $data = AnalyticsData::where('server_id', $server->id)->orderBy('created_at', 'desc')->get();

        return $this->fractal->collection($data)
            ->transformWith($this->getTransformer(AnalyticsTransformer::class))
            ->toArray();
    }

    /**
     * Returns all of the analytics messages assigned to a given server.
     */
    public function messages(ClientApiRequest $request, Server $server): array
    {
        $data = AnalyticsMessage::where('server_id', $server->id)->orderBy('created_at', 'desc')->get();

        return $this->fractal->collection($data)
            ->transformWith($this->getTransformer(MessageTransformer::class))
            ->toArray();
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/BackupController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Jexactyl\Models\Backup;
use Jexactyl\Models\Server;
use Illuminate\Http\Request;
use Jexactyl\Facades\Activity;
use Jexactyl\Models\Permission;
use Illuminate\Http\JsonResponse;
use Illuminate\Auth\Access\AuthorizationException;
use Jexactyl\Services\Backups\DeleteBackupService;
use Jexactyl\Services\Backups\DownloadLinkService;
use Jexactyl\Repositories\Eloquent\BackupRepository;
use Jexactyl\Services\Backups\InitiateBackupService;
use Jexactyl\Repositories\Wings\DaemonBackupRepository;
use Jexactyl\Transformers\Api\Client\BackupTransformer;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Symfony\Component\HttpKernel\Exception\BadRequestHttpException;
use Jexactyl\Http\Requests\Api\Client\Servers\Backups\StoreBackupRequest;

class BackupController extends ClientApiController
{
    /**
     * BackupController constructor.
     */
    public function __construct(
        private DaemonBackupRepository $daemonRepository,
        private DeleteBackupService $deleteBackupService,
        private InitiateBackupService $initiateBackupService,
        private DownloadLinkService $downloadLinkService,
        private BackupRepository $repository
    ) {
        parent::__construct();
    }

    /**
     * Returns all the backups for a given server instance in a paginated
     * result set.
     *
     * @throws \Illuminate\Auth\Access\AuthorizationException
     */
    public function index(Request $request, Server $server): array
    {
        if (!$request->user()->can(Permission::ACTION_BACKUP_READ, $server)) {
            throw new AuthorizationException();
        }

        $limit = min($request->query('per_page') ?? 20, 50);

        return $this->fractal->collection($server->backups()->paginate($limit))
            ->transformWith($this->getTransformer(BackupTransformer::class))
            ->addMeta([
                'backup_count' => $this->repository->getNonFailedBackups($server)->count(),
            ])
            ->toArray();
    }

    /**
     * Starts the backup process for a server.
     *
     * @throws \Spatie\Fractalistic\Exceptions\InvalidTransformation
     * @throws \Spatie\Fractalistic\Exceptions\NoTransformerSpecified
     * @throws \Throwable
     */
    public function store(StoreBackupRequest $request, Server $server): array
    {
        $action = $this->initiateBackupService
            ->setIgnoredFiles(explode(PHP_EOL, $request->input('ignored') ?? ''));

        // Only set the lock status if the user even has permission to delete backups,
        // otherwise ignore this status. This gets a little funky since it isn't clear
        // how best to allow a user to create a backup that is locked without also preventing
        // them from just filling up a server with backups that can never be deleted?
        if ($request->user()->can(Permission::ACTION_BACKUP_DELETE, $server)) {
            $action->setIsLocked((bool) $request->input('is_locked'));
        }

        $backup = $action->handle($server, $request->input('name'));

        Activity::event('server:backup.start')
            ->subject($backup)
            ->property(['name' => $backup->name, 'locked' => (bool) $request->input('is_locked')])
            ->log();

        return $this->fractal->item($backup)
            ->transformWith($this->getTransformer(BackupTransformer::class))
            ->toArray();
    }

    /**
     * Toggles the lock status of a given backup for a server.
     *
     * @throws \Throwable
     * @throws \Illuminate\Auth\Access\AuthorizationException
     */
    public function toggleLock(Request $request, Server $server, Backup $backup): array
    {
        if (!$request->user()->can(Permission::ACTION_BACKUP_DELETE, $server)) {
            throw new AuthorizationException();
        }

        $action = $backup->is_locked ? 'server:backup.unlock' : 'server:backup.lock';

        $backup->update(['is_locked' => !$backup->is_locked]);

        Activity::event($action)->subject($backup)->property('name', $backup->name)->log();

        return $this->fractal->item($backup)
            ->transformWith($this->getTransformer(BackupTransformer::class))
            ->toArray();
    }

    /**
     * Returns information about a single backup.
     *
     * @throws \Illuminate\Auth\Access\AuthorizationException
     */
    public function view(Request $request, Server $server, Backup $backup): array
    {
        if (!$request->user()->can(Permission::ACTION_BACKUP_READ, $server)) {
            throw new AuthorizationException();
        }

        return $this->fractal->item($backup)
            ->transformWith($this->getTransformer(BackupTransformer::class))
            ->toArray();
    }

    /**
     * Deletes a backup from the panel as well as the remote source where it is currently
     * being stored.
     *
     * @throws \Throwable
     */
    public function delete(Request $request, Server $server, Backup $backup): JsonResponse
    {
        if (!$request->user()->can(Permission::ACTION_BACKUP_DELETE, $server)) {
            throw new AuthorizationException();
        }

        $this->deleteBackupService->handle($backup);

        Activity::event('server:backup.delete')
            ->subject($backup)
            ->property(['name' => $backup->name, 'failed' => !$backup->is_successful])
            ->log();

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }

    /**
     * Download the backup for a given server instance. For daemon local files, the file
     * will be streamed back through the Panel. For AWS S3 files, a signed URL will be generated
     * which the user is redirected to.
     *
     * @throws \Throwable
     * @throws \Illuminate\Auth\Access\AuthorizationException
     */
    public function download(Request $request, Server $server, Backup $backup): JsonResponse
    {
        if (!$request->user()->can(Permission::ACTION_BACKUP_DOWNLOAD, $server)) {
            throw new AuthorizationException();
        }

        if ($backup->disk !== Backup::ADAPTER_AWS_S3 && $backup->disk !== Backup::ADAPTER_WINGS) {
            throw new BadRequestHttpException('The backup requested references an unknown disk driver type and cannot be downloaded.');
        }

        $url = $this->downloadLinkService->handle($backup, $request->user());

        Activity::event('server:backup.download')->subject($backup)->property('name', $backup->name)->log();

        return new JsonResponse([
            'object' => 'signed_url',
            'attributes' => ['url' => $url],
        ]);
    }

    /**
     * Handles restoring a backup by making a request to the Wings instance telling it
     * to begin the process of finding (or downloading) the backup and unpacking it
     * over the server files.
     *
     * If the "truncate" flag is passed through in this request then all the
     * files that currently exist on the server will be deleted before restoring.
     * Otherwise, the archive will simply be unpacked over the existing files.
     *
     * @throws \Throwable
     */
    public function restore(Request $request, Server $server, Backup $backup): JsonResponse
    {
        if (!$request->user()->can(Permission::ACTION_BACKUP_RESTORE, $server)) {
            throw new AuthorizationException();
        }

        // Cannot restore a backup unless a server is fully installed and not currently
        // processing a different backup restoration request.
        if (!is_null($server->status)) {
            throw new BadRequestHttpException('This server is not currently in a state that allows for a backup to be restored.');
        }

        if (!$backup->is_successful && is_null($backup->completed_at)) {
            throw new BadRequestHttpException('This backup cannot be restored at this time: not completed or failed.');
        }

        $log = Activity::event('server:backup.restore')
            ->subject($backup)
            ->property(['name' => $backup->name, 'truncate' => $request->input('truncate')]);

        $log->transaction(function () use ($backup, $server, $request) {
            // If the backup is for an S3 file we need to generate a unique Download link for
            // it that will allow Wings to actually access the file.
            if ($backup->disk === Backup::ADAPTER_AWS_S3) {
                $url = $this->downloadLinkService->handle($backup, $request->user());
            }

            // Update the status right away for the server so that we know not to allow certain
            // actions against it via the Panel API.
            $server->update(['status' => Server::STATUS_RESTORING_BACKUP]);

            $this->daemonRepository->setServer($server)->restore($backup, $url ?? null, $request->input('truncate'));
        });

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/CommandController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Jexactyl\Models\Server;
use Illuminate\Http\Response;
use Jexactyl\Facades\Activity;
use Psr\Http\Message\ResponseInterface;
use GuzzleHttp\Exception\BadResponseException;
use Jexactyl\Repositories\Wings\DaemonCommandRepository;
use Symfony\Component\HttpKernel\Exception\HttpException;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Jexactyl\Http\Requests\Api\Client\Servers\SendCommandRequest;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;

class CommandController extends ClientApiController
{
    /**
     * CommandController constructor.
     */
    public function __construct(private DaemonCommandRepository $repository)
    {
        parent::__construct();
    }

    /**
     * Send a command to a running server.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function index(SendCommandRequest $request, Server $server): Response
    {
        try {
            $this->repository->setServer($server)->send($request->input('command'));
        } catch (DaemonConnectionException $exception) {
            $previous = $exception->getPrevious();

            if ($previous instanceof BadResponseException) {
                if (
                    $previous->getResponse() instanceof ResponseInterface
                    && $previous->getResponse()->getStatusCode() === Response::HTTP_BAD_GATEWAY
                ) {
                    throw new HttpException(Response::HTTP_BAD_GATEWAY, 'Server must be online in order to send commands.', $exception);
                }
            }

            throw $exception;
        }

        Activity::event('server:console.command')->property('command', $request->input('command'))->log();

        return $this->returnNoContent();
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/DatabaseController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Jexactyl\Models\Server;
use Illuminate\Http\Response;
use Jexactyl\Models\Database;
use Jexactyl\Facades\Activity;
use Jexactyl\Services\Databases\DatabasePasswordService;
use Jexactyl\Transformers\Api\Client\DatabaseTransformer;
use Jexactyl\Services\Databases\DatabaseManagementService;
use Jexactyl\Services\Databases\DeployServerDatabaseService;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Jexactyl\Http\Requests\Api\Client\Servers\Databases\GetDatabasesRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Databases\StoreDatabaseRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Databases\DeleteDatabaseRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Databases\RotatePasswordRequest;

class DatabaseController extends ClientApiController
{
    /**
     * DatabaseController constructor.
     */
    public function __construct(
        private DeployServerDatabaseService $deployDatabaseService,
        private DatabaseManagementService $managementService,
        private DatabasePasswordService $passwordService
    ) {
        parent::__construct();
    }

    /**
     * Return all the databases that belong to the given server.
     */
    public function index(GetDatabasesRequest $request, Server $server): array
    {
        return $this->fractal->collection($server->databases)
            ->transformWith($this->getTransformer(DatabaseTransformer::class))
            ->toArray();
    }

    /**
     * Create a new database for the given server and return it.
     *
     * @throws \Throwable
     * @throws \Jexactyl\Exceptions\Service\Database\TooManyDatabasesException
     * @throws \Jexactyl\Exceptions\Service\Database\DatabaseClientFeatureNotEnabledException
     */
    public function store(StoreDatabaseRequest $request, Server $server): array
    {
        $database = $this->deployDatabaseService->handle($server, $request->validated());

        Activity::event('server:database.create')
            ->subject($database)
            ->property('name', $database->database)
            ->log();

        return $this->fractal->item($database)
            ->parseIncludes(['password'])
            ->transformWith($this->getTransformer(DatabaseTransformer::class))
            ->toArray();
    }

    /**
     * Rotates the password for the given server model and returns a fresh instance to
     * the caller.
     *
     * @throws \Throwable
     */
    public function rotatePassword(RotatePasswordRequest $request, Server $server, Database $database): array
    {
        $this->passwordService->handle($database);
        $database->refresh();

        Activity::event('server:database.rotate-password')
            ->subject($database)
            ->property('name', $database->database)
            ->log();

        return $this->fractal->item($database)
            ->parseIncludes(['password'])
            ->transformWith($this->getTransformer(DatabaseTransformer::class))
            ->toArray();
    }

    /**
     * Removes a database from the server.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function delete(DeleteDatabaseRequest $request, Server $server, Database $database): Response
    {
        $this->managementService->delete($database);

        Activity::event('server:database.delete')
            ->subject($database)
            ->property('name', $database->database)
            ->log();

        return new Response('', Response::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/EditController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Jexactyl\Models\Server;
use Illuminate\Http\Response;
use Illuminate\Http\JsonResponse;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Services\Servers\ServerEditService;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Jexactyl\Http\Requests\Api\Client\Servers\EditServerRequest;

class EditController extends ClientApiController
{
    /**
     * PowerController constructor.
     */
    public function __construct(private ServerEditService $editService)
    {
        parent::__construct();
    }

    /**
     * Edit a server's resource limits.
     *
     * @throws DisplayException
     */
    public function index(EditServerRequest $request, Server $server): JsonResponse
    {
        if ($this->settings->get('jexactyl::renewal:editing') != 'true') {
            throw new DisplayException('Server editing is currently disabled.');
        }

        if ($request->user()->id != $server->owner_id) {
            throw new DisplayException('You do not own this server, so you cannot edit the resources.');
        }

        $this->editService->handle($request, $server);

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/FileController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Carbon\CarbonImmutable;
use Jexactyl\Models\Server;
use Illuminate\Http\Response;
use Jexactyl\Facades\Activity;
use Illuminate\Http\JsonResponse;
use Jexactyl\Services\Nodes\NodeJWTService;
use Jexactyl\Repositories\Wings\DaemonFileRepository;
use Jexactyl\Transformers\Api\Client\FileObjectTransformer;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Jexactyl\Http\Requests\Api\Client\Servers\Files\CopyFileRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Files\PullFileRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Files\ListFilesRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Files\ChmodFilesRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Files\DeleteFileRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Files\RenameFileRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Files\CreateFolderRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Files\CompressFilesRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Files\DecompressFilesRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Files\GetFileContentsRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Files\WriteFileContentRequest;

class FileController extends ClientApiController
{
    /**
     * FileController constructor.
     */
    public function __construct(
        private NodeJWTService $jwtService,
        private DaemonFileRepository $fileRepository
    ) {
        parent::__construct();
    }

    /**
     * Returns a listing of files in a given directory.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function directory(ListFilesRequest $request, Server $server): array
    {
        $contents = $this->fileRepository
            ->setServer($server)
            ->getDirectory($request->get('directory') ?? '/');

        return $this->fractal->collection($contents)
            ->transformWith($this->getTransformer(FileObjectTransformer::class))
            ->toArray();
    }

    /**
     * Return the contents of a specified file for the user.
     *
     * @throws \Throwable
     */
    public function contents(GetFileContentsRequest $request, Server $server): Response
    {
        $response = $this->fileRepository->setServer($server)->getContent(
            $request->get('file'),
            config('jexactyl.files.max_edit_size')
        );

        Activity::event('server:file.read')->property('file', $request->get('file'))->log();

        return new Response($response, Response::HTTP_OK, ['Content-Type' => 'text/plain']);
    }

    /**
     * Generates a one-time token with a link that the user can use to
     * download a given file.
     *
     * @throws \Throwable
     */
    public function download(GetFileContentsRequest $request, Server $server): array
    {
        $token = $this->jwtService
            ->setExpiresAt(CarbonImmutable::now()->addMinutes(15))
            ->setUser($request->user())
            ->setClaims([
                'file_path' => rawurldecode($request->get('file')),
                'server_uuid' => $server->uuid,
            ])
            ->handle($server->node, $request->user()->id . $server->uuid);

        Activity::event('server:file.download')->property('file', $request->get('file'))->log();

        return [
            'object' => 'signed_url',
            'attributes' => [
                'url' => sprintf(
                    '%s/download/file?token=%s',
                    $server->node->getConnectionAddress(),
                    $token->toString()
                ),
            ],
        ];
    }

    /**
     * Writes the contents of the specified file to the server.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function write(WriteFileContentRequest $request, Server $server): JsonResponse
    {
        $this->fileRepository->setServer($server)->putContent($request->get('file'), $request->getContent());

        Activity::event('server:file.write')->property('file', $request->get('file'))->log();

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }

    /**
     * Creates a new folder on the server.
     *
     * @throws \Throwable
     */
    public function create(CreateFolderRequest $request, Server $server): JsonResponse
    {
        $this->fileRepository
            ->setServer($server)
            ->createDirectory($request->input('name'), $request->input('root', '/'));

        Activity::event('server:file.create-directory')
            ->property('name', $request->input('name'))
            ->property('directory', $request->input('root'))
            ->log();

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }

    /**
     * Renames a file on the remote machine.
     *
     * @throws \Throwable
     */
    public function rename(RenameFileRequest $request, Server $server): JsonResponse
    {
        $this->fileRepository
            ->setServer($server)
            ->renameFiles($request->input('root'), $request->input('files'));

        Activity::event('server:file.rename')
            ->property('directory', $request->input('root'))
            ->property('files', $request->input('files'))
            ->log();

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }

    /**
     * Copies a file on the server.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function copy(CopyFileRequest $request, Server $server): JsonResponse
    {
        $this->fileRepository
            ->setServer($server)
            ->copyFile($request->input('location'));

        Activity::event('server:file.copy')->property('file', $request->input('location'))->log();

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }

    /**
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function compress(CompressFilesRequest $request, Server $server): array
    {
        $file = $this->fileRepository->setServer($server)->compressFiles(
            $request->input('root'),
            $request->input('files')
        );

        Activity::event('server:file.compress')
            ->property('directory', $request->input('root'))
            ->property('files', $request->input('files'))
            ->log();

        return $this->fractal->item($file)
            ->transformWith($this->getTransformer(FileObjectTransformer::class))
            ->toArray();
    }

    /**
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function decompress(DecompressFilesRequest $request, Server $server): JsonResponse
    {
        set_time_limit(300);

        $this->fileRepository->setServer($server)->decompressFile(
            $request->input('root'),
            $request->input('file')
        );

        Activity::event('server:file.decompress')
            ->property('directory', $request->input('root'))
            ->property('files', $request->input('file'))
            ->log();

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }

    /**
     * Deletes files or folders for the server in the given root directory.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function delete(DeleteFileRequest $request, Server $server): JsonResponse
    {
        $this->fileRepository->setServer($server)->deleteFiles(
            $request->input('root'),
            $request->input('files')
        );

        Activity::event('server:file.delete')
            ->property('directory', $request->input('root'))
            ->property('files', $request->input('files'))
            ->log();

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }

    /**
     * Updates file permissions for file(s) in the given root directory.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function chmod(ChmodFilesRequest $request, Server $server): JsonResponse
    {
        $this->fileRepository->setServer($server)->chmodFiles(
            $request->input('root'),
            $request->input('files')
        );

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }

    /**
     * Requests that a file be downloaded from a remote location by Wings.
     *
     * @throws \Throwable
     */
    public function pull(PullFileRequest $request, Server $server): JsonResponse
    {
        $this->fileRepository->setServer($server)->pull(
            $request->input('url'),
            $request->input('directory'),
            $request->safe(['filename', 'use_header', 'foreground'])
        );

        Activity::event('server:file.pull')
            ->property('directory', $request->input('directory'))
            ->property('url', $request->input('url'))
            ->log();

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/FileUploadController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Jexactyl\Models\User;
use Carbon\CarbonImmutable;
use Jexactyl\Models\Server;
use Illuminate\Http\JsonResponse;
use Jexactyl\Services\Nodes\NodeJWTService;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Jexactyl\Http\Requests\Api\Client\Servers\Files\UploadFileRequest;

class FileUploadController extends ClientApiController
{
    /**
     * FileUploadController constructor.
     */
    public function __construct(
        private NodeJWTService $jwtService
    ) {
        parent::__construct();
    }

    /**
     * Returns an url where files can be uploaded to.
     */
    public function __invoke(UploadFileRequest $request, Server $server): JsonResponse
    {
        return new JsonResponse([
            'object' => 'signed_url',
            'attributes' => [
                'url' => $this->getUploadUrl($server, $request->user()),
            ],
        ]);
    }

    /**
     * Returns an url where files can be uploaded to.
     */
    protected function getUploadUrl(Server $server, User $user): string
    {
        $token = $this->jwtService
            ->setExpiresAt(CarbonImmutable::now()->addMinutes(15))
            ->setUser($user)
            ->setClaims(['server_uuid' => $server->uuid])
            ->handle($server->node, $user->id . $server->uuid);

        return sprintf(
            '%s/upload/file?token=%s',
            $server->node->getConnectionAddress(),
            $token->toString()
        );
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/NetworkAllocationController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Jexactyl\Models\Server;
use Jexactyl\Facades\Activity;
use Jexactyl\Models\Allocation;
use Illuminate\Http\JsonResponse;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Repositories\Eloquent\ServerRepository;
use Jexactyl\Transformers\Api\Client\AllocationTransformer;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Jexactyl\Services\Allocations\FindAssignableAllocationService;
use Jexactyl\Http\Requests\Api\Client\Servers\Network\GetNetworkRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Network\NewAllocationRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Network\DeleteAllocationRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Network\UpdateAllocationRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Network\SetPrimaryAllocationRequest;

class NetworkAllocationController extends ClientApiController
{
    /**
     * NetworkAllocationController constructor.
     */
    public function __construct(
        private FindAssignableAllocationService $assignableAllocationService,
        private ServerRepository $serverRepository
    ) {
        parent::__construct();
    }

    /**
     * Lists all the allocations available to a server and whether
     * they are currently assigned as the primary for this server.
     */
    public function index(GetNetworkRequest $request, Server $server): array
    {
        return $this->fractal->collection($server->allocations)
            ->transformWith($this->getTransformer(AllocationTransformer::class))
            ->toArray();
    }

    /**
     * Set the primary allocation for a server.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(UpdateAllocationRequest $request, Server $server, Allocation $allocation): array
    {
        $original = $allocation->notes;

        $allocation->forceFill(['notes' => $request->input('notes')])->save();

        if ($original !== $allocation->notes) {
            Activity::event('server:allocation.notes')
                ->subject($allocation)
                ->property(['allocation' => $allocation->toString(), 'old' => $original, 'new' => $allocation->notes])
                ->log();
        }

        return $this->fractal->item($allocation)
            ->transformWith($this->getTransformer(AllocationTransformer::class))
            ->toArray();
    }

    /**
     * Set the primary allocation for a server.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function setPrimary(SetPrimaryAllocationRequest $request, Server $server, Allocation $allocation): array
    {
        $this->serverRepository->update($server->id, ['allocation_id' => $allocation->id]);

        Activity::event('server:allocation.primary')
            ->subject($allocation)
            ->property('allocation', $allocation->toString())
            ->log();

        return $this->fractal->item($allocation)
            ->transformWith($this->getTransformer(AllocationTransformer::class))
            ->toArray();
    }

    /**
     * Set the notes for the allocation for a server.
     *s.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    public function store(NewAllocationRequest $request, Server $server): array
    {
        if ($server->allocations()->count() >= $server->allocation_limit) {
            throw new DisplayException('Cannot assign additional allocations to this server: limit has been reached.');
        }

        $allocation = $this->assignableAllocationService->handle($server);

        Activity::event('server:allocation.create')
            ->subject($allocation)
            ->property('allocation', $allocation->toString())
            ->log();

        return $this->fractal->item($allocation)
            ->transformWith($this->getTransformer(AllocationTransformer::class))
            ->toArray();
    }

    /**
     * Delete an allocation from a server.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    public function delete(DeleteAllocationRequest $request, Server $server, Allocation $allocation): JsonResponse
    {
        // Don't allow the deletion of allocations if the server does not have an
        // allocation limit set.
        if (empty($server->allocation_limit)) {
            throw new DisplayException('You cannot delete allocations for this server: no allocation limit is set.');
        }

        if ($allocation->id === $server->allocation_id) {
            throw new DisplayException('You cannot delete the primary allocation for this server.');
        }

        Allocation::query()->where('id', $allocation->id)->update([
            'notes' => null,
            'server_id' => null,
        ]);

        Activity::event('server:allocation.delete')
            ->subject($allocation)
            ->property('allocation', $allocation->toString())
            ->log();

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/PluginController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use GuzzleHttp\Client;
use Jexactyl\Models\Server;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Illuminate\Http\JsonResponse;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Repositories\Wings\DaemonFileRepository;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Jexactyl\Http\Requests\Api\Client\Servers\Files\PullFileRequest;

class PluginController extends ClientApiController
{
    /**
     * PluginController constructor.
     */
    public function __construct(private DaemonFileRepository $fileRepository)
    {
        parent::__construct();
    }

    /**
     * List all plugins from the Spigot API.
     *
     * @throws DisplayException
     */
    public function index(Request $request): ?array
    {
        $query = $request->input('query');
        if (!$query) {
            return null;
        }

        $client = new Client();

        $api = 'https://api.spiget.org/v2/search/resources/' . urlencode($query) . '?page=1&size=18';

        try {
            $res = $client->request('GET', $api, ['headers' => ['User-Agent' => 'jexactyl/3.x']]);
        } catch (DisplayException $e) {
            throw new DisplayException('Couldn\'t find any results for that query.');
        }

        $plugins = json_decode($res->getBody(), true);

        return [
            'success' => true,
            'data' => [
                'plugins' => $plugins,
            ],
        ];
    }

    /**
     * Install the plugin using the Panel.
     *
     * @throws DisplayException
     */
    public function install(PullFileRequest $request, Server $server, int $id): JsonResponse
    {
        $this->fileRepository->setServer($server)->pull(
            'https://cdn.spiget.org/file/spiget-resources/' . $id . '.jar',
            '/plugins',
            $request->safe(['filename', 'use_header', 'foreground'])
        );

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/PowerController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Jexactyl\Models\Server;
use Illuminate\Http\Response;
use Jexactyl\Facades\Activity;
use Jexactyl\Repositories\Wings\DaemonPowerRepository;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Jexactyl\Http\Requests\Api\Client\Servers\SendPowerRequest;

class PowerController extends ClientApiController
{
    /**
     * PowerController constructor.
     */
    public function __construct(private DaemonPowerRepository $repository)
    {
        parent::__construct();
    }

    /**
     * Send a power action to a server.
     */
    public function index(SendPowerRequest $request, Server $server): Response
    {
        $this->repository->setServer($server)->send(
            $request->input('signal')
        );

        Activity::event(strtolower("server:power.{$request->input('signal')}"))->log();

        return $this->returnNoContent();
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/RenewalController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Jexactyl\Models\Server;
use Illuminate\Http\Response;
use Illuminate\Http\JsonResponse;
use Jexactyl\Services\Servers\ServerRenewalService;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;

class RenewalController extends ClientApiController
{
    public function __construct(private ServerRenewalService $renewalService)
    {
        parent::__construct();
    }

    /**
     * Renew a server.
     */
    public function index(ClientApiRequest $request, Server $server): JsonResponse
    {
        $this->renewalService->handle($request, $server);

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/ResourceUtilizationController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Carbon\Carbon;
use Jexactyl\Models\Server;
use Illuminate\Cache\Repository;
use Jexactyl\Transformers\Api\Client\StatsTransformer;
use Jexactyl\Repositories\Wings\DaemonServerRepository;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Jexactyl\Http\Requests\Api\Client\Servers\GetServerRequest;

class ResourceUtilizationController extends ClientApiController
{
    /**
     * ResourceUtilizationController constructor.
     */
    public function __construct(private Repository $cache, private DaemonServerRepository $repository)
    {
        parent::__construct();
    }

    /**
     * Return the current resource utilization for a server. This value is cached for up to
     * 20 seconds at a time to ensure that repeated requests to this endpoint do not cause
     * a flood of unnecessary API calls.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function __invoke(GetServerRequest $request, Server $server): array
    {
        $key = "resources:$server->uuid";
        $stats = $this->cache->remember($key, Carbon::now()->addSeconds(20), function () use ($server) {
            return $this->repository->setServer($server)->getDetails();
        });

        return $this->fractal->item($stats)
            ->transformWith($this->getTransformer(StatsTransformer::class))
            ->toArray();
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/ScheduleController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Carbon\Carbon;
use Jexactyl\Models\Server;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Jexactyl\Models\Schedule;
use Jexactyl\Facades\Activity;
use Jexactyl\Helpers\Utilities;
use Illuminate\Http\JsonResponse;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Repositories\Eloquent\ScheduleRepository;
use Jexactyl\Services\Schedules\ProcessScheduleService;
use Jexactyl\Transformers\Api\Client\ScheduleTransformer;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;
use Jexactyl\Http\Requests\Api\Client\Servers\Schedules\ViewScheduleRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Schedules\StoreScheduleRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Schedules\DeleteScheduleRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Schedules\UpdateScheduleRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Schedules\TriggerScheduleRequest;

class ScheduleController extends ClientApiController
{
    /**
     * ScheduleController constructor.
     */
    public function __construct(private ScheduleRepository $repository, private ProcessScheduleService $service)
    {
        parent::__construct();
    }

    /**
     * Returns all the schedules belonging to a given server.
     */
    public function index(ViewScheduleRequest $request, Server $server): array
    {
        $schedules = $server->schedules->loadMissing('tasks');

        return $this->fractal->collection($schedules)
            ->transformWith($this->getTransformer(ScheduleTransformer::class))
            ->toArray();
    }

    /**
     * Store a new schedule for a server.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function store(StoreScheduleRequest $request, Server $server): array
    {
        /** @var \Jexactyl\Models\Schedule $model */
        $model = $this->repository->create([
            'server_id' => $server->id,
            'name' => $request->input('name'),
            'cron_day_of_week' => $request->input('day_of_week'),
            'cron_month' => $request->input('month'),
            'cron_day_of_month' => $request->input('day_of_month'),
            'cron_hour' => $request->input('hour'),
            'cron_minute' => $request->input('minute'),
            'is_active' => (bool) $request->input('is_active'),
            'only_when_online' => (bool) $request->input('only_when_online'),
            'next_run_at' => $this->getNextRunAt($request),
        ]);

        Activity::event('server:schedule.create')
            ->subject($model)
            ->property('name', $model->name)
            ->log();

        return $this->fractal->item($model)
            ->transformWith($this->getTransformer(ScheduleTransformer::class))
            ->toArray();
    }

    /**
     * Returns a specific schedule for the server.
     */
    public function view(ViewScheduleRequest $request, Server $server, Schedule $schedule): array
    {
        if ($schedule->server_id !== $server->id) {
            throw new NotFoundHttpException();
        }

        $schedule->loadMissing('tasks');

        return $this->fractal->item($schedule)
            ->transformWith($this->getTransformer(ScheduleTransformer::class))
            ->toArray();
    }

    /**
     * Updates a given schedule with the new data provided.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(UpdateScheduleRequest $request, Server $server, Schedule $schedule): array
    {
        $active = (bool) $request->input('is_active');

        $data = [
            'name' => $request->input('name'),
            'cron_day_of_week' => $request->input('day_of_week'),
            'cron_month' => $request->input('month'),
            'cron_day_of_month' => $request->input('day_of_month'),
            'cron_hour' => $request->input('hour'),
            'cron_minute' => $request->input('minute'),
            'is_active' => $active,
            'only_when_online' => (bool) $request->input('only_when_online'),
            'next_run_at' => $this->getNextRunAt($request),
        ];

        // Toggle the processing state of the scheduled task when it is enabled or disabled so that an
        // invalid state can be reset without manual database intervention.
        //
        // @see https://github.com/pterodactyl/panel/issues/2425
        if ($schedule->is_active !== $active) {
            $data['is_processing'] = false;
        }

        $this->repository->update($schedule->id, $data);

        Activity::event('server:schedule.update')
            ->subject($schedule)
            ->property(['name' => $schedule->name, 'active' => $active])
            ->log();

        return $this->fractal->item($schedule->refresh())
            ->transformWith($this->getTransformer(ScheduleTransformer::class))
            ->toArray();
    }

    /**
     * Executes a given schedule immediately rather than waiting on it's normally scheduled time
     * to pass. This does not care about the schedule state.
     *
     * @throws \Throwable
     */
    public function execute(TriggerScheduleRequest $request, Server $server, Schedule $schedule): JsonResponse
    {
        $this->service->handle($schedule, true);

        Activity::event('server:schedule.execute')->subject($schedule)->property('name', $schedule->name)->log();

        return new JsonResponse([], JsonResponse::HTTP_ACCEPTED);
    }

    /**
     * Deletes a schedule and it's associated tasks.
     */
    public function delete(DeleteScheduleRequest $request, Server $server, Schedule $schedule): JsonResponse
    {
        $this->repository->delete($schedule->id);

        Activity::event('server:schedule.delete')->subject($schedule)->property('name', $schedule->name)->log();

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }

    /**
     * Get the next run timestamp based on the cron data provided.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    protected function getNextRunAt(Request $request): Carbon
    {
        try {
            return Utilities::getScheduleNextRunDate(
                $request->input('minute'),
                $request->input('hour'),
                $request->input('day_of_month'),
                $request->input('month'),
                $request->input('day_of_week')
            );
        } catch (\Exception $exception) {
            throw new DisplayException('The cron data provided does not evaluate to a valid expression.');
        }
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/ScheduleTaskController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Jexactyl\Models\Task;
use Jexactyl\Models\Server;
use Illuminate\Http\Response;
use Jexactyl\Models\Schedule;
use Jexactyl\Facades\Activity;
use Jexactyl\Models\Permission;
use Illuminate\Http\JsonResponse;
use Illuminate\Database\ConnectionInterface;
use Jexactyl\Repositories\Eloquent\TaskRepository;
use Jexactyl\Exceptions\Http\HttpForbiddenException;
use Jexactyl\Transformers\Api\Client\TaskTransformer;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Jexactyl\Exceptions\Service\ServiceLimitExceededException;
use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;
use Jexactyl\Http\Requests\Api\Client\Servers\Schedules\StoreTaskRequest;

class ScheduleTaskController extends ClientApiController
{
    /**
     * ScheduleTaskController constructor.
     */
    public function __construct(
        private ConnectionInterface $connection,
        private TaskRepository $repository
    ) {
        parent::__construct();
    }

    /**
     * Create a new task for a given schedule and store it in the database.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Service\ServiceLimitExceededException
     */
    public function store(StoreTaskRequest $request, Server $server, Schedule $schedule): array
    {
        $limit = config('jexactyl.client_features.schedules.per_schedule_task_limit', 10);
        if ($schedule->tasks()->count() >= $limit) {
            throw new ServiceLimitExceededException("Schedules may not have more than $limit tasks associated with them. Creating this task would put this schedule over the limit.");
        }

        if ($server->backup_limit === 0 && $request->action === 'backup') {
            throw new HttpForbiddenException("A backup task cannot be created when the server's backup limit is set to 0.");
        }

        /** @var \Jexactyl\Models\Task|null $lastTask */
        $lastTask = $schedule->tasks()->orderByDesc('sequence_id')->first();

        /** @var \Jexactyl\Models\Task $task */
        $task = $this->connection->transaction(function () use ($request, $schedule, $lastTask) {
            $sequenceId = ($lastTask->sequence_id ?? 0) + 1;
            $requestSequenceId = $request->integer('sequence_id', $sequenceId);

            // Ensure that the sequence id is at least 1.
            if ($requestSequenceId < 1) {
                $requestSequenceId = 1;
            }

            // If the sequence id from the request is greater than or equal to the next available
            // sequence id, we don't need to do anything special.  Otherwise, we need to update
            // the sequence id of all tasks that are greater than or equal to the request sequence
            // id to be one greater than the current value.
            if ($requestSequenceId < $sequenceId) {
                $schedule->tasks()
                    ->where('sequence_id', '>=', $requestSequenceId)
                    ->increment('sequence_id');
                $sequenceId = $requestSequenceId;
            }

            return $this->repository->create([
                'schedule_id' => $schedule->id,
                'sequence_id' => $sequenceId,
                'action' => $request->input('action'),
                'payload' => $request->input('payload') ?? '',
                'time_offset' => $request->input('time_offset'),
                'continue_on_failure' => $request->boolean('continue_on_failure'),
            ]);
        });

        Activity::event('server:task.create')
            ->subject($schedule, $task)
            ->property(['name' => $schedule->name, 'action' => $task->action, 'payload' => $task->payload])
            ->log();

        return $this->fractal->item($task)
            ->transformWith($this->getTransformer(TaskTransformer::class))
            ->toArray();
    }

    /**
     * Updates a given task for a server.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(StoreTaskRequest $request, Server $server, Schedule $schedule, Task $task): array
    {
        if ($schedule->id !== $task->schedule_id || $server->id !== $schedule->server_id) {
            throw new NotFoundHttpException();
        }

        if ($server->backup_limit === 0 && $request->action === 'backup') {
            throw new HttpForbiddenException("A backup task cannot be created when the server's backup limit is set to 0.");
        }

        $this->connection->transaction(function () use ($request, $schedule, $task) {
            $sequenceId = $request->integer('sequence_id', $task->sequence_id);
            // Ensure that the sequence id is at least 1.
            if ($sequenceId < 1) {
                $sequenceId = 1;
            }

            // Shift all other tasks in the schedule up or down to make room for the new task.
            if ($sequenceId < $task->sequence_id) {
                $schedule->tasks()
                    ->where('sequence_id', '>=', $sequenceId)
                    ->where('sequence_id', '<', $task->sequence_id)
                    ->increment('sequence_id');
            } elseif ($sequenceId > $task->sequence_id) {
                $schedule->tasks()
                    ->where('sequence_id', '>', $task->sequence_id)
                    ->where('sequence_id', '<=', $sequenceId)
                    ->decrement('sequence_id');
            }

            $this->repository->update($task->id, [
                'sequence_id' => $sequenceId,
                'action' => $request->input('action'),
                'payload' => $request->input('payload') ?? '',
                'time_offset' => $request->input('time_offset'),
                'continue_on_failure' => $request->boolean('continue_on_failure'),
            ]);
        });

        Activity::event('server:task.update')
            ->subject($schedule, $task)
            ->property(['name' => $schedule->name, 'action' => $task->action, 'payload' => $task->payload])
            ->log();

        return $this->fractal->item($task->refresh())
            ->transformWith($this->getTransformer(TaskTransformer::class))
            ->toArray();
    }

    /**
     * Delete a given task for a schedule. If there are subsequent tasks stored in the database
     * for this schedule their sequence IDs are decremented properly.
     *
     * @throws \Exception
     */
    public function delete(ClientApiRequest $request, Server $server, Schedule $schedule, Task $task): JsonResponse
    {
        if ($task->schedule_id !== $schedule->id || $schedule->server_id !== $server->id) {
            throw new NotFoundHttpException();
        }

        if (!$request->user()->can(Permission::ACTION_SCHEDULE_UPDATE, $server)) {
            throw new HttpForbiddenException('You do not have permission to perform this action.');
        }

        $schedule->tasks()
            ->where('sequence_id', '>', $task->sequence_id)
            ->decrement('sequence_id');
        $task->delete();

        Activity::event('server:task.delete')->subject($schedule, $task)->property('name', $schedule->name)->log();

        return new JsonResponse(null, Response::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/ServerController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Jexactyl\Models\Server;
use Illuminate\Http\Response;
use Illuminate\Http\JsonResponse;
use Jexactyl\Services\Servers\ServerDeletionService;
use Jexactyl\Transformers\Api\Client\ServerTransformer;
use Jexactyl\Services\Servers\GetUserPermissionsService;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Jexactyl\Http\Requests\Api\Client\Servers\GetServerRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\DeleteServerRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\UpdateBackgroundRequest;

class ServerController extends ClientApiController
{
    /**
     * ServerController constructor.
     */
    public function __construct(private GetUserPermissionsService $permissionsService, private ServerDeletionService $deletionService)
    {
        parent::__construct();
    }

    /**
     * Transform an individual server into a response that can be consumed by a
     * client using the API.
     */
    public function index(GetServerRequest $request, Server $server): array
    {
        return $this->fractal->item($server)
            ->transformWith($this->getTransformer(ServerTransformer::class))
            ->addMeta([
                'is_server_owner' => $request->user()->id === $server->owner_id,
                'user_permissions' => $this->permissionsService->handle($server, $request->user()),
            ])
            ->toArray();
    }

    /**
     * Updates the background image for a server.
     */
    public function updateBackground(UpdateBackgroundRequest $request, Server $server): JsonResponse
    {
        $url = $request->input('bg');
        $server->update(['bg' => $url]);

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }

    /**
     * Deletes the requested server via the API and
     * returns the resources to the authenticated user.
     *
     * @throws DisplayException
     */
    public function delete(DeleteServerRequest $request, Server $server): JsonResponse
    {
        $user = $request->user();

        if ($user->id != $server->owner_id) {
            throw new DisplayException('You are not authorized to perform this action.');
        }

        if ($this->settings->get('jexactyl::renewal:deletion') != 'true') {
            throw new DisplayException('This feature has been locked by administrators.');
        }

        try {
            $this->deletionService->returnResources(true)->handle($server);
        } catch (DisplayException $ex) {
            throw new DisplayException('Unable to delete the server from the system.');
        }

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/SettingsController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Jexactyl\Models\Server;
use Illuminate\Http\Response;
use Jexactyl\Facades\Activity;
use Illuminate\Http\JsonResponse;
use Jexactyl\Repositories\Eloquent\ServerRepository;
use Jexactyl\Services\Servers\ReinstallServerService;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Symfony\Component\HttpKernel\Exception\BadRequestHttpException;
use Jexactyl\Http\Requests\Api\Client\Servers\Settings\RenameServerRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Settings\SetDockerImageRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Settings\ReinstallServerRequest;

class SettingsController extends ClientApiController
{
    /**
     * SettingsController constructor.
     */
    public function __construct(
        private ServerRepository $repository,
        private ReinstallServerService $reinstallServerService
    ) {
        parent::__construct();
    }

    /**
     * Renames a server.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function rename(RenameServerRequest $request, Server $server): JsonResponse
    {
        $name = $request->input('name');
        $description = $request->input('description') ?? $server->description;
        $this->repository->update($server->id, [
            'name' => $name,
            'description' => $description,
        ]);

        if ($server->name !== $name) {
            Activity::event('server:settings.rename')
                ->property(['old' => $server->name, 'new' => $name])
                ->log();
        }

        if ($server->description !== $description) {
            Activity::event('server:settings.description')
                ->property(['old' => $server->description, 'new' => $description])
                ->log();
        }

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }

    /**
     * Reinstalls the server on the daemon.
     *
     * @throws \Throwable
     */
    public function reinstall(ReinstallServerRequest $request, Server $server): JsonResponse
    {
        $this->reinstallServerService->handle($server);

        Activity::event('server:reinstall')->log();

        return new JsonResponse([], Response::HTTP_ACCEPTED);
    }

    /**
     * Changes the Docker image in use by the server.
     *
     * @throws \Throwable
     */
    public function dockerImage(SetDockerImageRequest $request, Server $server): JsonResponse
    {
        if (!in_array($server->image, array_values($server->egg->docker_images))) {
            throw new BadRequestHttpException('This server\'s Docker image has been manually set by an administrator and cannot be updated.');
        }

        $original = $server->image;
        $server->forceFill(['image' => $request->input('docker_image')])->saveOrFail();

        if ($original !== $server->image) {
            Activity::event('server:startup.image')
                ->property(['old' => $original, 'new' => $request->input('docker_image')])
                ->log();
        }

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/StartupController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Jexactyl\Models\Server;
use Jexactyl\Facades\Activity;
use Jexactyl\Services\Servers\StartupCommandService;
use Jexactyl\Repositories\Eloquent\ServerVariableRepository;
use Jexactyl\Transformers\Api\Client\EggVariableTransformer;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Symfony\Component\HttpKernel\Exception\BadRequestHttpException;
use Jexactyl\Http\Requests\Api\Client\Servers\Startup\GetStartupRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Startup\UpdateStartupVariableRequest;

class StartupController extends ClientApiController
{
    /**
     * StartupController constructor.
     */
    public function __construct(
        private StartupCommandService $startupCommandService,
        private ServerVariableRepository $repository
    ) {
        parent::__construct();
    }

    /**
     * Returns the startup information for the server including all the variables.
     */
    public function index(GetStartupRequest $request, Server $server): array
    {
        $startup = $this->startupCommandService->handle($server);

        return $this->fractal->collection(
            $server->variables()->where('user_viewable', true)->get()
        )
            ->transformWith($this->getTransformer(EggVariableTransformer::class))
            ->addMeta([
                'startup_command' => $startup,
                'docker_images' => $server->egg->docker_images,
                'raw_startup_command' => $server->startup,
            ])
            ->toArray();
    }

    /**
     * Updates a single variable for a server.
     *
     * @throws \Illuminate\Validation\ValidationException
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(UpdateStartupVariableRequest $request, Server $server): array
    {
        /** @var \Jexactyl\Models\EggVariable $variable */
        $variable = $server->variables()->where('env_variable', $request->input('key'))->first();
        $original = $variable->server_value;

        if (is_null($variable) || !$variable->user_viewable) {
            throw new BadRequestHttpException('The environment variable you are trying to edit does not exist.');
        } elseif (!$variable->user_editable) {
            throw new BadRequestHttpException('The environment variable you are trying to edit is read-only.');
        }

        // Revalidate the variable value using the egg variable specific validation rules for it.
        $this->validate($request, ['value' => $variable->rules]);

        $this->repository->updateOrCreate([
            'server_id' => $server->id,
            'variable_id' => $variable->id,
        ], [
            'variable_value' => $request->input('value') ?? '',
        ]);

        $variable = $variable->refresh();
        $variable->server_value = $request->input('value');

        $startup = $this->startupCommandService->handle($server);

        if ($variable->env_variable !== $request->input('value')) {
            Activity::event('server:startup.edit')
                ->subject($variable)
                ->property([
                    'variable' => $variable->env_variable,
                    'old' => $original,
                    'new' => $request->input('value'),
                ])
                ->log();
        }

        return $this->fractal->item($variable)
            ->transformWith($this->getTransformer(EggVariableTransformer::class))
            ->addMeta([
                'startup_command' => $startup,
                'raw_startup_command' => $server->startup,
            ])
            ->toArray();
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/SubuserController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Jexactyl\Models\Server;
use Illuminate\Http\Request;
use Jexactyl\Facades\Activity;
use Jexactyl\Models\Permission;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\Log;
use Jexactyl\Repositories\Eloquent\SubuserRepository;
use Jexactyl\Services\Subusers\SubuserCreationService;
use Jexactyl\Repositories\Wings\DaemonServerRepository;
use Jexactyl\Transformers\Api\Client\SubuserTransformer;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;
use Jexactyl\Http\Requests\Api\Client\Servers\Subusers\GetSubuserRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Subusers\StoreSubuserRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Subusers\DeleteSubuserRequest;
use Jexactyl\Http\Requests\Api\Client\Servers\Subusers\UpdateSubuserRequest;

class SubuserController extends ClientApiController
{
    /**
     * SubuserController constructor.
     */
    public function __construct(
        private SubuserRepository $repository,
        private SubuserCreationService $creationService,
        private DaemonServerRepository $serverRepository
    ) {
        parent::__construct();
    }

    /**
     * Return the users associated with this server instance.
     */
    public function index(GetSubuserRequest $request, Server $server): array
    {
        return $this->fractal->collection($server->subusers)
            ->transformWith($this->getTransformer(SubuserTransformer::class))
            ->toArray();
    }

    /**
     * Returns a single subuser associated with this server instance.
     */
    public function view(GetSubuserRequest $request): array
    {
        $subuser = $request->attributes->get('subuser');

        return $this->fractal->item($subuser)
            ->transformWith($this->getTransformer(SubuserTransformer::class))
            ->toArray();
    }

    /**
     * Create a new subuser for the given server.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Service\Subuser\ServerSubuserExistsException
     * @throws \Jexactyl\Exceptions\Service\Subuser\UserIsServerOwnerException
     * @throws \Throwable
     */
    public function store(StoreSubuserRequest $request, Server $server): array
    {
        $response = $this->creationService->handle(
            $server,
            $request->input('email'),
            $this->getDefaultPermissions($request)
        );

        Activity::event('server:subuser.create')
            ->subject($response->user)
            ->property(['email' => $request->input('email'), 'permissions' => $this->getDefaultPermissions($request)])
            ->log();

        return $this->fractal->item($response)
            ->transformWith($this->getTransformer(SubuserTransformer::class))
            ->toArray();
    }

    /**
     * Update a given subuser in the system for the server.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(UpdateSubuserRequest $request, Server $server): array
    {
        /** @var \Jexactyl\Models\Subuser $subuser */
        $subuser = $request->attributes->get('subuser');

        $permissions = $this->getDefaultPermissions($request);
        $current = $subuser->permissions;

        sort($permissions);
        sort($current);

        $log = Activity::event('server:subuser.update')
            ->subject($subuser->user)
            ->property([
                'email' => $subuser->user->email,
                'old' => $current,
                'new' => $permissions,
                'revoked' => true,
            ]);

        // Only update the database and hit up the Wings instance to invalidate JTI's if the permissions
        // have actually changed for the user.
        if ($permissions !== $current) {
            $log->transaction(function ($instance) use ($request, $subuser, $server) {
                $this->repository->update($subuser->id, [
                    'permissions' => $this->getDefaultPermissions($request),
                ]);

                try {
                    $this->serverRepository->setServer($server)->revokeUserJTI($subuser->user_id);
                } catch (DaemonConnectionException $exception) {
                    // Don't block this request if we can't connect to the Wings instance. Chances are it is
                    // offline and the token will be invalid once Wings boots back.
                    Log::warning($exception, ['user_id' => $subuser->user_id, 'server_id' => $server->id]);

                    $instance->property('revoked', false);
                }
            });
        }

        $log->reset();

        return $this->fractal->item($subuser->refresh())
            ->transformWith($this->getTransformer(SubuserTransformer::class))
            ->toArray();
    }

    /**
     * Removes a subusers from a server's assignment.
     */
    public function delete(DeleteSubuserRequest $request, Server $server): JsonResponse
    {
        /** @var \Jexactyl\Models\Subuser $subuser */
        $subuser = $request->attributes->get('subuser');

        $log = Activity::event('server:subuser.delete')
            ->subject($subuser->user)
            ->property('email', $subuser->user->email)
            ->property('revoked', true);

        $log->transaction(function ($instance) use ($server, $subuser) {
            $subuser->delete();

            try {
                $this->serverRepository->setServer($server)->revokeUserJTI($subuser->user_id);
            } catch (DaemonConnectionException $exception) {
                // Don't block this request if we can't connect to the Wings instance.
                Log::warning($exception, ['user_id' => $subuser->user_id, 'server_id' => $server->id]);

                $instance->property('revoked', false);
            }
        });

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }

    /**
     * Returns the default permissions for subusers and parses out any permissions
     * that were passed that do not also exist in the internally tracked list of
     * permissions.
     */
    protected function getDefaultPermissions(Request $request): array
    {
        $allowed = Permission::permissions()
            ->map(function ($value, $prefix) {
                return array_map(function ($value) use ($prefix) {
                    return "$prefix.$value";
                }, array_keys($value['keys']));
            })
            ->flatten()
            ->all();

        $cleaned = array_intersect($request->input('permissions') ?? [], $allowed);

        return array_unique(array_merge($cleaned, [Permission::ACTION_WEBSOCKET_CONNECT]));
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Servers/WebsocketController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Servers;

use Carbon\CarbonImmutable;
use Jexactyl\Models\Server;
use Jexactyl\Models\Permission;
use Illuminate\Http\JsonResponse;
use Jexactyl\Services\Nodes\NodeJWTService;
use Jexactyl\Exceptions\Http\HttpForbiddenException;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Jexactyl\Services\Servers\GetUserPermissionsService;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;

class WebsocketController extends ClientApiController
{
    /**
     * WebsocketController constructor.
     */
    public function __construct(
        private NodeJWTService $jwtService,
        private GetUserPermissionsService $permissionsService
    ) {
        parent::__construct();
    }

    /**
     * Generates a one-time token that is sent along in every websocket call to the Daemon.
     * This is a signed JWT that the Daemon then uses to verify the user's identity, and
     * allows us to continually renew this token and avoid users maintaining sessions wrongly,
     * as well as ensure that user's only perform actions they're allowed to.
     */
    public function __invoke(ClientApiRequest $request, Server $server): JsonResponse
    {
        $user = $request->user();
        if ($user->cannot(Permission::ACTION_WEBSOCKET_CONNECT, $server)) {
            throw new HttpForbiddenException('You do not have permission to connect to this server\'s websocket.');
        }

        $permissions = $this->permissionsService->handle($server, $user);

        $node = $server->node;
        if (!is_null($server->transfer)) {
            // Check if the user has permissions to receive transfer logs.
            if (!in_array('admin.websocket.transfer', $permissions)) {
                throw new HttpForbiddenException('You do not have permission to view server transfer logs.');
            }

            // Redirect the websocket request to the new node if the server has been archived.
            if ($server->transfer->archived) {
                $node = $server->transfer->newNode;
            }
        }

        $token = $this->jwtService
            ->setExpiresAt(CarbonImmutable::now()->addMinutes(10))
            ->setUser($request->user())
            ->setClaims([
                'server_uuid' => $server->uuid,
                'permissions' => $permissions,
            ])
            ->handle($node, $user->id . $server->uuid);

        $socket = str_replace(['https://', 'http://'], ['wss://', 'ws://'], $node->getConnectionAddress());

        return new JsonResponse([
            'data' => [
                'token' => $token->toString(),
                'socket' => $socket . sprintf('/api/servers/%s/ws', $server->uuid),
            ],
        ]);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Store/PayPalController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Store;

use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\DB;
use Illuminate\Http\RedirectResponse;
use Jexactyl\Exceptions\DisplayException;
use PayPalCheckoutSdk\Core\PayPalHttpClient;
use PayPalCheckoutSdk\Core\ProductionEnvironment;
use PayPalCheckoutSdk\Orders\OrdersCreateRequest;
use PayPalCheckoutSdk\Orders\OrdersCaptureRequest;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Jexactyl\Http\Requests\Api\Client\Store\Gateways\PayPalRequest;

class PayPalController extends ClientApiController
{
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * Constructs the PayPal order request and redirects
     * the user over to PayPal for credits purchase.
     *
     * @throws DisplayException
     */
    public function purchase(PayPalRequest $request): JsonResponse
    {
        if ($this->settings->get('jexactyl::store:paypal:enabled') != 'true') {
            throw new DisplayException('Unable to purchase via PayPal: module not enabled');
        }

        $amount = $request->input('amount');
        $cost = config('gateways.paypal.cost', 1) / 100 * $amount;
        $currency = config('gateways.currency', 'USD');

        DB::table('paypal')->insert([
            'user_id' => $request->user()->id,
            'amount' => $amount,
        ]);

        $order = new OrdersCreateRequest();
        $order->prefer('return=representation');

        $order->body = [
            'intent' => 'CAPTURE',
            'purchase_units' => [
                [
                    'reference_id' => uniqid(),
                    'description' => $amount . ' Credits | ' . $this->settings->get('settings::app:name'),
                    'amount' => [
                        'value' => $cost,
                        'currency_code' => strtoupper($currency),
                        'breakdown' => [
                            'item_total' => ['currency_code' => strtoupper($currency), 'value' => $cost],
                        ],
                    ],
                ],
            ],
            'application_context' => [
                'cancel_url' => route('api:client.index'),
                'return_url' => route('api:client:store.paypal.callback'),
                'brand_name' => $this->settings->get('settings::app:name'),
                'shipping_preference' => 'NO_SHIPPING',
            ],
        ];

        try {
            $response = $this->getClient()->execute($order);
        } catch (\Exception $ex) {
            throw new DisplayException('Unable to process order.');
        }

        return new JsonResponse($response->result->links[1]->href ?? '/', 200, [], null, true);
    }

    /**
     * Add balance to a user when the purchase is successful.
     *
     * @throws DisplayException
     */
    public function callback(Request $request): RedirectResponse
    {
        $user = $request->user();
        $data = DB::table('paypal')->where('user_id', $user->id)->first();

        $order = new OrdersCaptureRequest($request->input('token'));
        $order->prefer('return=representation');

        try {
            $res = $this->getClient()->execute($order);
        } catch (DisplayException $ex) {
            throw new DisplayException('Unable to process order.');
        }

        if ($res->statusCode == 200 || 201) {
            $user->update([
                'store_balance' => $user->store_balance + $data->amount,
            ]);
        }

        DB::table('paypal')->where('user_id', $user->id)->delete();

        return redirect('/store');
    }

    /**
     * Returns a PayPal client which can be used
     * for processing orders via the API.
     *
     * @throws DisplayException
     */
    protected function getClient(): PayPalHttpClient
    {
        return new PayPalHttpClient(new ProductionEnvironment(
            config('gateways.paypal.client_id'),
            config('gateways.paypal.client_secret')
        ));
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Store/ResourceController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Store;

use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Illuminate\Http\JsonResponse;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Services\Store\ResourcePurchaseService;
use Jexactyl\Transformers\Api\Client\Store\CostTransformer;
use Jexactyl\Transformers\Api\Client\Store\UserTransformer;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Jexactyl\Http\Requests\Api\Client\Store\PurchaseResourceRequest;

class ResourceController extends ClientApiController
{
    /**
     * ResourceController constructor.
     */
    public function __construct(private ResourcePurchaseService $purchaseService)
    {
        parent::__construct();
    }

    /**
     * Get the resources for the authenticated user.
     *
     * @throws DisplayException
     */
    public function user(Request $request)
    {
        return $this->fractal->item($request->user())
            ->transformWith($this->getTransformer(UserTransformer::class))
            ->toArray();
    }

    /**
     * Get the cost of resources.
     *
     * @throws DisplayException
     */
    public function costs(Request $request)
    {
        $data = [];
        $prefix = 'jexactyl::store:cost:';
        $types = ['cpu', 'memory', 'disk', 'slot', 'port', 'backup', 'database'];

        foreach ($types as $type) {
            array_push($data, $this->settings->get($prefix . $type, 0));
        }

        return $this->fractal->item($data)
            ->transformWith($this->getTransformer(CostTransformer::class))
            ->toArray();
    }

    /**
     * Allows a user to earn credits via passive earning.
     *
     * @throws DisplayException
     */
    public function earn(Request $request)
    {
        $amount = $this->settings->get('jexactyl::earn:amount', 0);

        if ($this->settings->get('jexactyl::earn:enabled') != 'true') {
            throw new DisplayException('Credit earning is currently disabled.');
        }

        try {
            $request->user()->update(['store_balance' => $request->user()->store_balance + $amount]);
        } catch (DisplayException $ex) {
            throw new DisplayException('Unable to passively earn coins.');
        }

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }

    /**
     * Allows users to purchase resources via the store.
     *
     * @throws DisplayException
     */
    public function purchase(PurchaseResourceRequest $request): JsonResponse
    {
        $this->purchaseService->handle($request);

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/Store/ServerController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Store;

use Jexactyl\Models\Nest;
use Jexactyl\Models\Node;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Services\Store\StoreCreationService;
use Jexactyl\Transformers\Api\Client\Store\EggTransformer;
use Jexactyl\Transformers\Api\Client\Store\NestTransformer;
use Jexactyl\Transformers\Api\Client\Store\NodeTransformer;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Jexactyl\Http\Requests\Api\Client\Store\CreateServerRequest;
use Jexactyl\Exceptions\Service\Deployment\NoViableNodeException;

class ServerController extends ClientApiController
{
    /**
     * ServerController constructor.
     */
    public function __construct(private StoreCreationService $creationService)
    {
        parent::__construct();
    }

    public function nodes(Request $request): array
    {
        $nodes = Node::where('deployable', true)->get();

        return $this->fractal->collection($nodes)
            ->transformWith($this->getTransformer(NodeTransformer::class))
            ->toArray();
    }

    /**
     * Get all available nests for server deployment.
     */
    public function nests(Request $request): array
    {
        $nests = Nest::where('private', false)->get();

        return $this->fractal->collection($nests)
            ->transformWith($this->getTransformer(NestTransformer::class))
            ->toArray();
    }

    /**
     * Get all available eggs for server deployment.
     */
    public function eggs(Request $request): array
    {
        $id = $request->input('id') ?? Nest::where('private', false)->first()->id;
        $eggs = Nest::query()->where('id', $id)->where('private', false)->first()->eggs;

        return $this->fractal->collection($eggs)
            ->transformWith($this->getTransformer(EggTransformer::class))
            ->toArray();
    }

    /**
     * Stores a new server on the Panel.
     *
     * @throws DisplayException
     * @throws NoViableNodeException
     */
    public function store(CreateServerRequest $request): JsonResponse
    {
        $user = $request->user();
        $fee = Node::find($request->input('node'))->deploy_fee;

        if (!$user->verified) {
            throw new DisplayException('Server deployment is unavailable for unverified accounts.');
        }

        if (Nest::find($request->input('nest'))->private) {
            throw new DisplayException('This nest is private and cannot be deployed to.');
        }

        if ($user->store_slots < 1) {
            throw new DisplayException('You do not have enough server slots in order to deploy a server.');
        }

        $server = $this->creationService->handle($request);

        $user->update([
            'store_balance' => $user->store_balance - $fee ?? 0,
            'store_cpu' => $user->store_cpu - $request->input('cpu'),
            'store_memory' => $user->store_memory - $request->input('memory'),
            'store_disk' => $user->store_disk - $request->input('disk'),
            'store_slots' => $user->store_slots - 1,
            'store_ports' => $user->store_ports - $request->input('ports'),
            'store_backups' => $user->store_backups - $request->input('backups'),
            'store_databases' => $user->store_databases - $request->input('databases'),
        ]);

        return new JsonResponse(['id' => $server->uuidShort]);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/AccountController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client;

use Jexactyl\Models\User;
use Jexactyl\Models\Coupon;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Jexactyl\Facades\Activity;
use Illuminate\Auth\AuthManager;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\DB;
use Jexactyl\Notifications\VerifyEmail;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Services\Users\UserUpdateService;
use Jexactyl\Transformers\Api\Client\AccountTransformer;
use Jexactyl\Http\Requests\Api\Client\Account\UpdateEmailRequest;
use Jexactyl\Http\Requests\Api\Client\Account\UpdatePasswordRequest;
use Jexactyl\Http\Requests\Api\Client\Account\UpdateUsernameRequest;

class AccountController extends ClientApiController
{
    /**
     * AccountController constructor.
     */
    public function __construct(private AuthManager $manager, private UserUpdateService $updateService)
    {
        parent::__construct();
    }

    public function index(Request $request): array
    {
        return $this->fractal->item($request->user())
            ->transformWith($this->getTransformer(AccountTransformer::class))
            ->toArray();
    }

    /**
     * Update the authenticated user's email address.
     */
    public function updateEmail(UpdateEmailRequest $request): JsonResponse
    {
        $original = $request->user()->email;
        $this->updateService->handle($request->user(), $request->validated());

        if ($original !== $request->input('email')) {
            Activity::event('user:account.email-changed')
                ->property(['old' => $original, 'new' => $request->input('email')])
                ->log();
        }

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }

    /**
     * Update the authenticated user's password. All existing sessions will be logged
     * out immediately.
     *
     * @throws \Throwable
     */
    public function updatePassword(UpdatePasswordRequest $request): JsonResponse
    {
        $user = $this->updateService->handle($request->user(), $request->validated());

        $guard = $this->manager->guard();
        // If you do not update the user in the session you'll end up working with a
        // cached copy of the user that does not include the updated password. Do this
        // to correctly store the new user details in the guard and allow the logout
        // other devices functionality to work.
        $guard->setUser($user);

        // This method doesn't exist in the stateless Sanctum world.
        if (method_exists($guard, 'logoutOtherDevices')) {
            $guard->logoutOtherDevices($request->input('password'));
        }

        Activity::event('user:account.password-changed')->log();

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }

    /**
     * Update the authenticated user's username.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function updateUsername(UpdateUsernameRequest $request): JsonResponse
    {
        $original = $request->user()->username;

        $this->updateService->handle($request->user(), $request->validated());

        Activity::event('user:account.username-changed')
            ->property(['old' => $original, 'new' => $request->input('username')])
            ->log();

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }

    public function verify(Request $request): JsonResponse
    {
        $token = $this->genStr();
        $name = $this->settings->get('settings::app:name', 'Jexactyl');
        DB::table('verification_tokens')->insert(['user' => $request->user()->id, 'token' => $token]);
        $request->user()->notify(new VerifyEmail($request->user(), $name, $token));

        return new JsonResponse(['success' => true, 'data' => []]);
    }

    /**
     * @throws DisplayException
     */
    public function coupon(Request $request)
    {
        $code = $request->input('code');
        $coupon = Coupon::query()->where('code', $code)->first();
        if (!$coupon) {
            throw new DisplayException('Invalid coupon code specified.');
        }
        if ($coupon->getAttribute('expired')) {
            throw new DisplayException('This coupon has expired.');
        }
        if ($coupon->getAttribute('uses') < 1) {
            throw new DisplayException('This coupon has no uses left.');
        }
        $balance = $request->user()->store_balance;
        $request->user()->update(['store_balance' => $balance + $coupon->cr_amount]);
        Coupon::query()->where('code', $code)->update(['uses' => $coupon->uses - 1]);

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }

    private function genStr(): string
    {
        $chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        $pieces = [];
        $max = mb_strlen($chars, '8bit') - 1;
        for ($i = 0; $i < 32; ++$i) {
            $pieces[] = $chars[mt_rand(0, $max)];
        }

        return implode('', $pieces);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/ActivityLogController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client;

use Jexactyl\Models\ActivityLog;
use Spatie\QueryBuilder\QueryBuilder;
use Spatie\QueryBuilder\AllowedFilter;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Jexactyl\Transformers\Api\Client\ActivityLogTransformer;

class ActivityLogController extends ClientApiController
{
    /**
     * Returns a paginated set of the user's activity logs.
     */
    public function __invoke(ClientApiRequest $request): array
    {
        $activity = QueryBuilder::for($request->user()->activity())
            ->with('actor')
            ->allowedFilters([AllowedFilter::partial('event')])
            ->allowedSorts(['timestamp'])
            ->whereNotIn('activity_logs.event', ActivityLog::DISABLED_EVENTS)
            ->paginate(min($request->query('per_page', 5), 100))
            ->appends($request->query());

        return $this->fractal->collection($activity)
            ->transformWith($this->getTransformer(ActivityLogTransformer::class))
            ->toArray();
    }

    /**
     * Returns the latest activity log for a user.
     */
    public function latest(ClientApiRequest $request): array
    {
        $data = $request->user()
            ->activity()
            ->orderBy('timestamp', 'desc')
            ->first();

        return $this->fractal->item($data)
            ->transformWith($this->getTransformer(ActivityLogTransformer::class))
            ->toArray();
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/ApiKeyController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client;

use Jexactyl\Models\ApiKey;
use Jexactyl\Facades\Activity;
use Illuminate\Http\JsonResponse;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Jexactyl\Transformers\Api\Client\ApiKeyTransformer;
use Jexactyl\Http\Requests\Api\Client\Account\StoreApiKeyRequest;

class ApiKeyController extends ClientApiController
{
    /**
     * Returns all the API keys that exist for the given client.
     */
    public function index(ClientApiRequest $request): array
    {
        return $this->fractal->collection($request->user()->apiKeys)
            ->transformWith($this->getTransformer(ApiKeyTransformer::class))
            ->toArray();
    }

    /**
     * Store a new API key for a user's account.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    public function store(StoreApiKeyRequest $request): array
    {
        if ($request->user()->apiKeys->count() >= 25) {
            throw new DisplayException('You have reached the account limit for number of API keys.');
        }

        $token = $request->user()->createToken(
            $request->input('description'),
            $request->input('allowed_ips')
        );

        Activity::event('user:api-key.create')
            ->subject($token->accessToken)
            ->property('identifier', $token->accessToken->identifier)
            ->log();

        return $this->fractal->item($token->accessToken)
            ->transformWith($this->getTransformer(ApiKeyTransformer::class))
            ->addMeta(['secret_token' => $token->plainTextToken])
            ->toArray();
    }

    /**
     * Deletes a given API key.
     */
    public function delete(ClientApiRequest $request, string $identifier): JsonResponse
    {
        /** @var \Jexactyl\Models\ApiKey $key */
        $key = $request->user()->apiKeys()
            ->where('key_type', ApiKey::TYPE_ACCOUNT)
            ->where('identifier', $identifier)
            ->firstOrFail();

        $key->delete();

        Activity::event('user:api-key.delete')
            ->property('identifier', $key->identifier)
            ->log();

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/ClientApiController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client;

use Webmozart\Assert\Assert;
use Jexactyl\Transformers\Api\Client\BaseClientTransformer;
use Jexactyl\Http\Controllers\Api\Application\ApplicationApiController;

abstract class ClientApiController extends ApplicationApiController
{
    /**
     * Returns only the includes which are valid for the given transformer.
     */
    protected function getIncludesForTransformer(BaseClientTransformer $transformer, array $merge = []): array
    {
        $filtered = array_filter($this->parseIncludes(), function ($datum) use ($transformer) {
            return in_array($datum, $transformer->getAvailableIncludes());
        });

        return array_merge($filtered, $merge);
    }

    /**
     * Returns the parsed includes for this request.
     */
    protected function parseIncludes(): array
    {
        $includes = $this->request->query('include') ?? [];

        if (!is_string($includes)) {
            return $includes;
        }

        return array_map(function ($item) {
            return trim($item);
        }, explode(',', $includes));
    }

    /**
     * Return an instance of an application transformer.
     *
     * @template T of \Jexactyl\Transformers\Api\Client\BaseClientTransformer
     *
     * @param class-string<T> $abstract
     *
     * @return T
     *
     * @noinspection PhpDocSignatureInspection
     */
    public function getTransformer(string $abstract)
    {
        Assert::subclassOf($abstract, BaseClientTransformer::class);

        return $abstract::fromRequest($this->request);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/ClientController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client;

use Jexactyl\Models\Server;
use Jexactyl\Models\Permission;
use Spatie\QueryBuilder\QueryBuilder;
use Spatie\QueryBuilder\AllowedFilter;
use Jexactyl\Models\Filters\MultiFieldServerFilter;
use Jexactyl\Transformers\Api\Client\ServerTransformer;
use Jexactyl\Http\Requests\Api\Client\GetServersRequest;

class ClientController extends ClientApiController
{
    /**
     * ClientController constructor.
     */
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * Return all the servers available to the client making the API
     * request, including servers the user has access to as a subuser.
     */
    public function index(GetServersRequest $request): array
    {
        $user = $request->user();
        $transformer = $this->getTransformer(ServerTransformer::class);

        // Start the query builder and ensure we eager load any requested relationships from the request.
        $builder = QueryBuilder::for(
            Server::query()->with($this->getIncludesForTransformer($transformer, ['node']))
        )->allowedFilters([
            'uuid',
            'name',
            'description',
            'external_id',
            AllowedFilter::custom('*', new MultiFieldServerFilter()),
        ]);

        $type = $request->input('type');
        // Either return all the servers the user has access to because they are an admin `?type=admin` or
        // just return all the servers the user has access to because they are the owner or a subuser of the
        // server. If ?type=admin-all is passed all servers on the system will be returned to the user, rather
        // than only servers they can see because they are an admin.
        if (in_array($type, ['admin', 'admin-all'])) {
            // If they aren't an admin but want all the admin servers don't fail the request, just
            // make it a query that will never return any results back.
            if (!$user->root_admin) {
                $builder->whereRaw('1 = 2');
            } else {
                $builder = $type === 'admin-all'
                    ? $builder
                    : $builder->whereNotIn('servers.id', $user->accessibleServers()->pluck('id')->all());
            }
        } elseif ($type === 'owner') {
            $builder = $builder->where('servers.owner_id', $user->id);
        } else {
            $builder = $builder->whereIn('servers.id', $user->accessibleServers()->pluck('id')->all());
        }

        $servers = $builder->paginate(min($request->query('per_page', 50), 100))->appends($request->query());

        return $this->fractal->transformWith($transformer)->collection($servers)->toArray();
    }

    /**
     * Returns all the subuser permissions available on the system.
     */
    public function permissions(): array
    {
        return [
            'object' => 'system_permissions',
            'attributes' => [
                'permissions' => Permission::permissions(),
            ],
        ];
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/DiscordController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client;

use Jexactyl\Models\User;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Http;
use Illuminate\Http\RedirectResponse;

class DiscordController extends ClientApiController
{
    /**
     * AccountController constructor.
     */
    public function __construct()
    {
        parent::__construct();
    }

    public function link(): JsonResponse
    {
        return new JsonResponse([
            'https://discord.com/api/oauth2/authorize?'
            . 'client_id=' . $this->settings->get('jexactyl::discord:id')
            . '&redirect_uri=' . route('api:client.account.discord.callback')
            . '&response_type=code&scope=identify%20email%20guilds%20guilds.join&prompt=none',
        ], 200, [], null, false);
    }

    public function unlink(): JsonResponse
    {
        $user = Auth::user();
        if (!$user) {
            return new JsonResponse(['error' => 'No authenticated user'], 401);
        }
        $user->update(['discord_id' => null]);
        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }

    public function callback(Request $request): RedirectResponse
    {
        $code = Http::asForm()->post('https://discord.com/api/oauth2/token', [
            'client_id' => $this->settings->get('jexactyl::discord:id'),
            'client_secret' => $this->settings->get('jexactyl::discord:secret'),
            'grant_type' => 'authorization_code',
            'code' => $request->input('code'),
            'redirect_uri' => route('api:client.account.discord.callback'),
        ]);

        if (!$code->ok()) {
            return redirect('/account');
        }

        $req = json_decode($code->body());
        if (preg_match('(email|identify)', $req->scope) !== 1) {
            return redirect('/account');
        }

        $discord = json_decode(Http::withHeaders(['Authorization' => 'Bearer ' . $req->access_token])->asForm()->get('https://discord.com/api/users/@me')->body());
        User::query()->where('id', Auth::user()->id)->update(['discord_id' => $discord->id]);

        return redirect('/account');
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/ReferralsController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client;

use Jexactyl\Models\User;
use Illuminate\Http\JsonResponse;
use Jexactyl\Models\ReferralUses;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Services\Referrals\UseReferralService;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Jexactyl\Transformers\Api\Client\Referrals\ReferralCodeTransformer;
use Jexactyl\Transformers\Api\Client\Referrals\ReferralActivityTransformer;

class ReferralsController extends ClientApiController
{
    public function __construct(private UseReferralService $useService)
    {
        parent::__construct();
    }

    /**
     * Returns all of the referral codes that exist for the given client.
     */
    public function index(ClientApiRequest $request): array
    {
        return $this->fractal->collection($request->user()->referralCodes)
            ->transformWith($this->getTransformer(ReferralCodeTransformer::class))
            ->toArray();
    }

    /**
     * Returns all of the referral code uses.
     */
    public function activity(ClientApiRequest $request): array
    {
        $activity = ReferralUses::where('referrer_id', $request->user()->id)->get();

        return $this->fractal->collection($activity)
            ->transformWith($this->getTransformer(ReferralActivityTransformer::class))
            ->toArray();
    }

    /**
     * Use a referral code.
     *
     * @throws DisplayException
     */
    public function use(ClientApiRequest $request): JsonResponse
    {
        if ($request->user()->referral_code) {
            throw new DisplayException('You have already used a referral code.');
        }

        $this->useService->handle($request);

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }

    /**
     * Store a new referral code for a user's account.
     *
     * @throws DisplayException
     */
    public function store(ClientApiRequest $request): array
    {
        if ($request->user()->referralCodes->count() >= 5) {
            throw new DisplayException('You cannot have more than 5 referral codes.');
        }

        $code = $request->user()->referralCodes()->create([
            'user_id' => $request->user()->id,
            'code' => $this->generate(),
        ]);

        return $this->fractal->item($code)
            ->transformWith($this->getTransformer(ReferralCodeTransformer::class))
            ->toArray();
    }

    /**
     * Deletes a referral code.
     */
    public function delete(ClientApiRequest $request, string $code): JsonResponse
    {
        /** @var \Jexactyl\Models\ReferralCode $code */
        $referralCode = $request->user()->referralCodes()
            ->where('code', $code)
            ->firstOrFail();

        $referralCode->delete();

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }

    /**
     * Returns a string used for creating
     * referral codes for the Panel.
     */
    public function generate(): string
    {
        $chars = '1234567890ABCDEFGHIJKLMNOPQRSTUVWXYZ';

        return substr(str_shuffle($chars), 0, 16);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/SSHKeyController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client;

use Jexactyl\Facades\Activity;
use Illuminate\Http\JsonResponse;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Jexactyl\Transformers\Api\Client\UserSSHKeyTransformer;
use Jexactyl\Http\Requests\Api\Client\Account\StoreSSHKeyRequest;

class SSHKeyController extends ClientApiController
{
    /**
     * Returns all the SSH keys that have been configured for the logged-in
     * user account.
     */
    public function index(ClientApiRequest $request): array
    {
        return $this->fractal->collection($request->user()->sshKeys)
            ->transformWith($this->getTransformer(UserSSHKeyTransformer::class))
            ->toArray();
    }

    /**
     * Stores a new SSH key for the authenticated user's account.
     */
    public function store(StoreSSHKeyRequest $request): array
    {
        $model = $request->user()->sshKeys()->create([
            'name' => $request->input('name'),
            'public_key' => $request->getPublicKey(),
            'fingerprint' => $request->getKeyFingerprint(),
        ]);

        Activity::event('user:ssh-key.create')
            ->subject($model)
            ->property('fingerprint', $request->getKeyFingerprint())
            ->log();

        return $this->fractal->item($model)
            ->transformWith($this->getTransformer(UserSSHKeyTransformer::class))
            ->toArray();
    }

    /**
     * Deletes an SSH key from the user's account.
     */
    public function delete(ClientApiRequest $request): JsonResponse
    {
        $this->validate($request, ['fingerprint' => ['required', 'string']]);

        $key = $request->user()->sshKeys()
            ->where('fingerprint', $request->input('fingerprint'))
            ->first();

        if (!is_null($key)) {
            $key->delete();

            Activity::event('user:ssh-key.delete')
                ->subject($key)
                ->property('fingerprint', $key->fingerprint)
                ->log();
        }

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/TicketController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client;

use Jexactyl\Models\Ticket;
use Illuminate\Http\JsonResponse;
use Jexactyl\Models\TicketMessage;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Jexactyl\Transformers\Api\Client\Tickets\TicketTransformer;
use Jexactyl\Transformers\Api\Client\Tickets\TicketMessageTransformer;

class TicketController extends ClientApiController
{
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * Returns all of the tickets assigned to a given client.
     */
    public function index(ClientApiRequest $request): array
    {
        return $this->fractal->collection($request->user()->tickets)
            ->transformWith($this->getTransformer(TicketTransformer::class))
            ->toArray();
    }

    /**
     * Views a specific ticket for a client.
     */
    public function view(ClientApiRequest $request, int $id): array
    {
        return $this->fractal->item(Ticket::findOrFail($id))
            ->transformWith($this->getTransformer(TicketTransformer::class))
            ->toArray();
    }

    /**
     * Gets the messages associated with a ticket.
     */
    public function viewMessages(ClientApiRequest $request, int $id): array
    {
        $messages = TicketMessage::where('ticket_id', $id)->get();

        return $this->fractal->collection($messages)
            ->transformWith($this->getTransformer(TicketMessageTransformer::class))
            ->toArray();
    }

    /**
     * Creates a new ticket on the Panel which is accessible by both
     * administrators and the specific client.
     *
     * @throws DisplayException
     */
    public function new(ClientApiRequest $request): JsonResponse
    {
        $user = $request->user()->id;
        $title = $request->input('title');
        $description = $request->input('description');
        $total = Ticket::where('client_id', $user)->count();

        if ($this->settings->get('jexactyl::tickets:max') <= $total) {
            throw new DisplayException('You already have ' . $total . ' tickets open.');
        }

        $model = Ticket::create([
            'client_id' => $user,
            'title' => $title,
            'status' => Ticket::STATUS_PENDING,
            'content' => $description,
        ]);

        TicketMessage::create([
            'user_id' => $user,
            'ticket_id' => $model->id,
            'content' => $description,
        ]);

        return new JsonResponse(['id' => $model->id]);
    }

    /**
     * Creates a new ticket message on the Panel which is accessible
     * by both administrators and the specific client.
     *
     * @throws DisplayException
     */
    public function newMessage(ClientApiRequest $request, int $id): JsonResponse
    {
        $ticket = Ticket::findOrFail($id);

        $ticket->messages()->create([
            'user_id' => $request->user()->id,
            'ticket_id' => $ticket->id,
            'content' => $request->input('description'),
        ]);

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }

    /**
     * Closes a ticket and deletes the associated messages.
     *
     * @throws DisplayException
     */
    public function close(ClientApiRequest $request, int $id): JsonResponse
    {
        Ticket::findOrFail($id)->delete();
        TicketMessage::where('ticket_id', $id)->delete();

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Client/TwoFactorController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client;

use Carbon\Carbon;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Jexactyl\Facades\Activity;
use Illuminate\Http\JsonResponse;
use Jexactyl\Services\Users\TwoFactorSetupService;
use Jexactyl\Services\Users\ToggleTwoFactorService;
use Illuminate\Contracts\Validation\Factory as ValidationFactory;
use Symfony\Component\HttpKernel\Exception\BadRequestHttpException;

class TwoFactorController extends ClientApiController
{
    /**
     * TwoFactorController constructor.
     */
    public function __construct(
        private ToggleTwoFactorService $toggleTwoFactorService,
        private TwoFactorSetupService $setupService,
        private ValidationFactory $validation
    ) {
        parent::__construct();
    }

    /**
     * Returns two-factor token credentials that allow a user to configure
     * it on their account. If two-factor is already enabled this endpoint
     * will return a 400 error.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function index(Request $request): JsonResponse
    {
        if ($request->user()->use_totp) {
            throw new BadRequestHttpException('Two-factor authentication is already enabled on this account.');
        }

        return new JsonResponse([
            'data' => $this->setupService->handle($request->user()),
        ]);
    }

    /**
     * Updates a user's account to have two-factor enabled.
     *
     * @throws \Throwable
     * @throws \Illuminate\Validation\ValidationException
     */
    public function store(Request $request): JsonResponse
    {
        $validator = $this->validation->make($request->all(), [
            'code' => ['required', 'string', 'size:6'],
            'password' => ['required', 'string'],
        ]);

        $data = $validator->validate();
        if (!password_verify($data['password'], $request->user()->password)) {
            throw new BadRequestHttpException('The password provided was not valid.');
        }

        $tokens = $this->toggleTwoFactorService->handle($request->user(), $data['code'], true);

        Activity::event('user:two-factor.create')->log();

        return new JsonResponse([
            'object' => 'recovery_tokens',
            'attributes' => [
                'tokens' => $tokens,
            ],
        ]);
    }

    /**
     * Disables two-factor authentication on an account if the password provided
     * is valid.
     *
     * @throws \Throwable
     */
    public function delete(Request $request): JsonResponse
    {
        if (!password_verify($request->input('password') ?? '', $request->user()->password)) {
            throw new BadRequestHttpException('The password provided was not valid.');
        }

        /** @var \Jexactyl\Models\User $user */
        $user = $request->user();

        $user->update([
            'totp_authenticated_at' => Carbon::now(),
            'use_totp' => false,
        ]);

        Activity::event('user:two-factor.delete')->log();

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Remote/Backups/BackupRemoteUploadController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Remote\Backups;

use Carbon\CarbonImmutable;
use Jexactyl\Models\Backup;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Extensions\Backups\BackupManager;
use Jexactyl\Extensions\Filesystem\S3Filesystem;
use Symfony\Component\HttpKernel\Exception\ConflictHttpException;
use Symfony\Component\HttpKernel\Exception\BadRequestHttpException;

class BackupRemoteUploadController extends Controller
{
    public const DEFAULT_MAX_PART_SIZE = 5 * 1024 * 1024 * 1024;

    /**
     * BackupRemoteUploadController constructor.
     */
    public function __construct(private BackupManager $backupManager)
    {
    }

    /**
     * Returns the required presigned urls to upload a backup to S3 cloud storage.
     *
     * @throws \Exception
     * @throws \Throwable
     * @throws \Illuminate\Database\Eloquent\ModelNotFoundException
     */
    public function __invoke(Request $request, string $backup): JsonResponse
    {
        // Get the size query parameter.
        $size = (int) $request->query('size');
        if (empty($size)) {
            throw new BadRequestHttpException('A non-empty "size" query parameter must be provided.');
        }

        /** @var \Jexactyl\Models\Backup $backup */
        $backup = Backup::query()->where('uuid', $backup)->firstOrFail();

        // Prevent backups that have already been completed from trying to
        // be uploaded again.
        if (!is_null($backup->completed_at)) {
            throw new ConflictHttpException('This backup is already in a completed state.');
        }

        // Ensure we are using the S3 adapter.
        $adapter = $this->backupManager->adapter();
        if (!$adapter instanceof S3Filesystem) {
            throw new BadRequestHttpException('The configured backup adapter is not an S3 compatible adapter.');
        }

        // The path where backup will be uploaded to
        $path = sprintf('%s/%s.tar.gz', $backup->server->uuid, $backup->uuid);

        // Get the S3 client
        $client = $adapter->getClient();
        $expires = CarbonImmutable::now()->addMinutes(config('backups.presigned_url_lifespan', 60));

        // Params for generating the presigned urls
        $params = [
            'Bucket' => $adapter->getBucket(),
            'Key' => $path,
            'ContentType' => 'application/x-gzip',
        ];

        $storageClass = config('backups.disks.s3.storage_class');
        if (!is_null($storageClass)) {
            $params['StorageClass'] = $storageClass;
        }

        // Execute the CreateMultipartUpload request
        $result = $client->execute($client->getCommand('CreateMultipartUpload', $params));

        // Get the UploadId from the CreateMultipartUpload request, this is needed to create
        // the other presigned urls.
        $params['UploadId'] = $result->get('UploadId');

        // Retrieve configured part size
        $maxPartSize = $this->getConfiguredMaxPartSize();

        // Create as many UploadPart presigned urls as needed
        $parts = [];
        for ($i = 0; $i < ($size / $maxPartSize); ++$i) {
            $parts[] = $client->createPresignedRequest(
                $client->getCommand('UploadPart', array_merge($params, ['PartNumber' => $i + 1])),
                $expires
            )->getUri()->__toString();
        }

        // Set the upload_id on the backup in the database.
        $backup->update(['upload_id' => $params['UploadId']]);

        return new JsonResponse([
            'parts' => $parts,
            'part_size' => $maxPartSize,
        ]);
    }

    /**
     * Get the configured maximum size of a single part in the multipart upload.
     *
     * The function tries to retrieve a configured value from the configuration.
     * If no value is specified, a fallback value will be used.
     *
     * Note if the received config cannot be converted to int (0), is zero or is negative,
     * the fallback value will be used too.
     *
     * The fallback value is {@see BackupRemoteUploadController::DEFAULT_MAX_PART_SIZE}.
     */
    private function getConfiguredMaxPartSize(): int
    {
        $maxPartSize = (int) config('backups.max_part_size', self::DEFAULT_MAX_PART_SIZE);
        if ($maxPartSize <= 0) {
            $maxPartSize = self::DEFAULT_MAX_PART_SIZE;
        }

        return $maxPartSize;
    }
}
</file>

<file path="app/Http/Controllers/Api/Remote/Backups/BackupStatusController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Remote\Backups;

use Carbon\CarbonImmutable;
use Jexactyl\Models\Backup;
use Illuminate\Http\Request;
use Jexactyl\Facades\Activity;
use Illuminate\Http\JsonResponse;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Extensions\Backups\BackupManager;
use Jexactyl\Extensions\Filesystem\S3Filesystem;
use Jexactyl\Http\Requests\Api\Remote\ReportBackupCompleteRequest;
use Symfony\Component\HttpKernel\Exception\BadRequestHttpException;

class BackupStatusController extends Controller
{
    /**
     * BackupStatusController constructor.
     */
    public function __construct(private BackupManager $backupManager)
    {
    }

    /**
     * Handles updating the state of a backup.
     *
     * @throws \Throwable
     */
    public function index(ReportBackupCompleteRequest $request, string $backup): JsonResponse
    {
        /** @var \Jexactyl\Models\Backup $model */
        $model = Backup::query()->where('uuid', $backup)->firstOrFail();

        if ($model->is_successful) {
            throw new BadRequestHttpException('Cannot update the status of a backup that is already marked as completed.');
        }

        $action = $request->boolean('successful') ? 'server:backup.complete' : 'server:backup.fail';
        $log = Activity::event($action)->subject($model, $model->server)->property('name', $model->name);

        $log->transaction(function () use ($model, $request) {
            $successful = $request->boolean('successful');

            $model->fill([
                'is_successful' => $successful,
                // Change the lock state to unlocked if this was a failed backup so that it can be
                // deleted easily. Also does not make sense to have a locked backup on the system
                // that is failed.
                'is_locked' => $successful ? $model->is_locked : false,
                'checksum' => $successful ? ($request->input('checksum_type') . ':' . $request->input('checksum')) : null,
                'bytes' => $successful ? $request->input('size') : 0,
                'completed_at' => CarbonImmutable::now(),
            ])->save();

            // Check if we are using the s3 backup adapter. If so, make sure we mark the backup as
            // being completed in S3 correctly.
            $adapter = $this->backupManager->adapter();
            if ($adapter instanceof S3Filesystem) {
                $this->completeMultipartUpload($model, $adapter, $successful, $request->input('parts'));
            }
        });

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }

    /**
     * Handles toggling the restoration status of a server. The server status field should be
     * set back to null, even if the restoration failed. This is not an unsolvable state for
     * the server, and the user can keep trying to restore, or just use the reinstall button.
     *
     * The only thing the successful field does is update the entry value for the audit logs
     * table tracking for this restoration.
     *
     * @throws \Throwable
     */
    public function restore(Request $request, string $backup): JsonResponse
    {
        /** @var \Jexactyl\Models\Backup $model */
        $model = Backup::query()->where('uuid', $backup)->firstOrFail();

        $model->server->update(['status' => null]);

        Activity::event($request->boolean('successful') ? 'server:backup.restore-complete' : 'server.backup.restore-failed')
            ->subject($model, $model->server)
            ->property('name', $model->name)
            ->log();

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }

    /**
     * Marks a multipart upload in a given S3-compatible instance as failed or successful for
     * the given backup.
     *
     * @throws \Exception
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    protected function completeMultipartUpload(Backup $backup, S3Filesystem $adapter, bool $successful, ?array $parts): void
    {
        // This should never really happen, but if it does don't let us fall victim to Amazon's
        // wildly fun error messaging. Just stop the process right here.
        if (empty($backup->upload_id)) {
            // A failed backup doesn't need to error here, this can happen if the backup encounters
            // an error before we even start the upload. AWS gives you tooling to clear these failed
            // multipart uploads as needed too.
            if (!$successful) {
                return;
            }

            throw new DisplayException('Cannot complete backup request: no upload_id present on model.');
        }

        $params = [
            'Bucket' => $adapter->getBucket(),
            'Key' => sprintf('%s/%s.tar.gz', $backup->server->uuid, $backup->uuid),
            'UploadId' => $backup->upload_id,
        ];

        $client = $adapter->getClient();
        if (!$successful) {
            $client->execute($client->getCommand('AbortMultipartUpload', $params));

            return;
        }

        // Otherwise send a CompleteMultipartUpload request.
        $params['MultipartUpload'] = [
            'Parts' => [],
        ];

        if (is_null($parts)) {
            $params['MultipartUpload']['Parts'] = $client->execute($client->getCommand('ListParts', $params))['Parts'];
        } else {
            foreach ($parts as $part) {
                $params['MultipartUpload']['Parts'][] = [
                    'ETag' => $part['etag'],
                    'PartNumber' => $part['part_number'],
                ];
            }
        }

        $client->execute($client->getCommand('CompleteMultipartUpload', $params));
    }
}
</file>

<file path="app/Http/Controllers/Api/Remote/Servers/ServerDetailsController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Remote\Servers;

use Jexactyl\Models\Server;
use Illuminate\Http\Request;
use Jexactyl\Facades\Activity;
use Illuminate\Http\JsonResponse;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\Database\ConnectionInterface;
use Jexactyl\Services\Eggs\EggConfigurationService;
use Jexactyl\Repositories\Eloquent\ServerRepository;
use Jexactyl\Http\Resources\Wings\ServerConfigurationCollection;
use Jexactyl\Services\Servers\ServerConfigurationStructureService;

class ServerDetailsController extends Controller
{
    /**
     * ServerConfigurationController constructor.
     */
    public function __construct(
        protected ConnectionInterface $connection,
        private ServerRepository $repository,
        private ServerConfigurationStructureService $configurationStructureService,
        private EggConfigurationService $eggConfigurationService
    ) {
    }

    /**
     * Returns details about the server that allows Wings to self-recover and ensure
     * that the state of the server matches the Panel at all times.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function __invoke(Request $request, string $uuid): JsonResponse
    {
        $server = $this->repository->getByUuid($uuid);

        return new JsonResponse([
            'settings' => $this->configurationStructureService->handle($server),
            'process_configuration' => $this->eggConfigurationService->handle($server),
        ]);
    }

    /**
     * Lists all servers with their configurations that are assigned to the requesting node.
     */
    public function list(Request $request): ServerConfigurationCollection
    {
        /** @var \Jexactyl\Models\Node $node */
        $node = $request->attributes->get('node');

        // Avoid run-away N+1 SQL queries by preloading the relationships that are used
        // within each of the services called below.
        $servers = Server::query()->with('allocations', 'egg', 'mounts', 'variables', 'location')
            ->where('node_id', $node->id)
            // If you don't cast this to a string you'll end up with a stringified per_page returned in
            // the metadata, and then Wings will panic crash as a result.
            ->paginate((int) $request->input('per_page', 50));

        return new ServerConfigurationCollection($servers);
    }

    /**
     * Resets the state of all servers on the node to be normal. This is triggered
     * when Wings restarts and is useful for ensuring that any servers on the node
     * do not get incorrectly stuck in installing/restoring from backup states since
     * a Wings reboot would completely stop those processes.
     *
     * @throws \Throwable
     */
    public function resetState(Request $request): JsonResponse
    {
        $node = $request->attributes->get('node');

        // Get all the servers that are currently marked as restoring from a backup
        // on this node that do not have a failed backup tracked in the audit logs table
        // as well.
        //
        // For each of those servers we'll track a new audit log entry to mark them as
        // failed and then update them all to be in a valid state.
        $servers = Server::query()
            ->with([
                'activity' => fn ($builder) => $builder
                    ->where('activity_logs.event', 'server:backup.restore-started')
                    ->latest('timestamp'),
            ])
            ->where('node_id', $node->id)
            ->where('status', Server::STATUS_RESTORING_BACKUP)
            ->get();

        $this->connection->transaction(function () use ($node, $servers) {
            /** @var \Jexactyl\Models\Server $server */
            foreach ($servers as $server) {
                /** @var \Jexactyl\Models\ActivityLog|null $activity */
                $activity = $server->activity->first();
                if (!is_null($activity)) {
                    if ($subject = $activity->subjects->where('subject_type', 'backup')->first()) {
                        // Just create a new audit entry for this event and update the server state
                        // so that power actions, file management, and backups can resume as normal.
                        Activity::event('server:backup.restore-failed')
                            ->subject($server, $subject->subject)
                            ->property('name', $subject->subject->name)
                            ->log();
                    }
                }
            }

            // Update any server marked as installing or restoring as being in a normal state
            // at this point in the process.
            Server::query()->where('node_id', $node->id)
                ->whereIn('status', [Server::STATUS_INSTALLING, Server::STATUS_RESTORING_BACKUP])
                ->update(['status' => null]);
        });

        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Remote/Servers/ServerInstallController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Remote\Servers;

use Carbon\CarbonImmutable;
use Jexactyl\Models\Server;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Illuminate\Http\JsonResponse;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Repositories\Eloquent\ServerRepository;
use Jexactyl\Events\Server\Installed as ServerInstalled;
use Illuminate\Contracts\Events\Dispatcher as EventDispatcher;
use Jexactyl\Http\Requests\Api\Remote\InstallationDataRequest;

class ServerInstallController extends Controller
{
    /**
     * ServerInstallController constructor.
     */
    public function __construct(private ServerRepository $repository, private EventDispatcher $eventDispatcher)
    {
    }

    /**
     * Returns installation information for a server.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function index(Request $request, string $uuid): JsonResponse
    {
        $server = $this->repository->getByUuid($uuid);
        $egg = $server->egg;

        return new JsonResponse([
            'container_image' => $egg->copy_script_container,
            'entrypoint' => $egg->copy_script_entry,
            'script' => $egg->copy_script_install,
        ]);
    }

    /**
     * Updates the installation state of a server.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function store(InstallationDataRequest $request, string $uuid): JsonResponse
    {
        $server = $this->repository->getByUuid($uuid);
        $status = null;

        // Make sure the type of failure is accurate
        if (!$request->boolean('successful')) {
            $status = Server::STATUS_INSTALL_FAILED;

            if ($request->boolean('reinstall')) {
                $status = Server::STATUS_REINSTALL_FAILED;
            }
        }

        // Keep the server suspended if it's already suspended
        if ($server->status === Server::STATUS_SUSPENDED) {
            $status = Server::STATUS_SUSPENDED;
        }

        $this->repository->update($server->id, ['status' => $status, 'installed_at' => CarbonImmutable::now()], true, true);

        // If the server successfully installed, fire installed event.
        // This logic allows individually disabling install and reinstall notifications separately.
        $isInitialInstall = is_null($server->installed_at);
        if ($isInitialInstall && config()->get('jexactyl.email.send_install_notification', true)) {
            $this->eventDispatcher->dispatch(new ServerInstalled($server));
        } elseif (!$isInitialInstall && config()->get('jexactyl.email.send_reinstall_notification', true)) {
            $this->eventDispatcher->dispatch(new ServerInstalled($server));
        }

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Remote/Servers/ServerTransferController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Remote\Servers;

use Illuminate\Http\Response;
use Jexactyl\Models\Allocation;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\Log;
use Jexactyl\Models\ServerTransfer;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\Database\ConnectionInterface;
use Jexactyl\Repositories\Eloquent\ServerRepository;
use Jexactyl\Repositories\Wings\DaemonServerRepository;
use Symfony\Component\HttpKernel\Exception\ConflictHttpException;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;

class ServerTransferController extends Controller
{
    /**
     * ServerTransferController constructor.
     */
    public function __construct(
        private ConnectionInterface $connection,
        private ServerRepository $repository,
        private DaemonServerRepository $daemonServerRepository
    ) {
    }

    /**
     * The daemon notifies us about a transfer failure.
     *
     * @throws \Throwable
     */
    public function failure(string $uuid): JsonResponse
    {
        $server = $this->repository->getByUuid($uuid);
        $transfer = $server->transfer;
        if (is_null($transfer)) {
            throw new ConflictHttpException('Server is not being transferred.');
        }

        return $this->processFailedTransfer($transfer);
    }

    /**
     * The daemon notifies us about a transfer success.
     *
     * @throws \Throwable
     */
    public function success(string $uuid): JsonResponse
    {
        $server = $this->repository->getByUuid($uuid);
        $transfer = $server->transfer;
        if (is_null($transfer)) {
            throw new ConflictHttpException('Server is not being transferred.');
        }

        /** @var \Jexactyl\Models\Server $server */
        $server = $this->connection->transaction(function () use ($server, $transfer) {
            $allocations = array_merge([$transfer->old_allocation], $transfer->old_additional_allocations);

            // Remove the old allocations for the server and re-assign the server to the new
            // primary allocation and node.
            Allocation::query()->whereIn('id', $allocations)->update(['server_id' => null]);
            $server->update([
                'allocation_id' => $transfer->new_allocation,
                'node_id' => $transfer->new_node,
            ]);

            $server = $server->fresh();
            $server->transfer->update(['successful' => true]);

            return $server;
        });

        // Delete the server from the old node making sure to point it to the old node so
        // that we do not delete it from the new node the server was transferred to.
        try {
            $this->daemonServerRepository
                ->setServer($server)
                ->setNode($transfer->oldNode)
                ->delete();
        } catch (DaemonConnectionException $exception) {
            Log::warning($exception, ['transfer_id' => $server->transfer->id]);
        }

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }

    /**
     * Release all the reserved allocations for this transfer and mark it as failed in
     * the database.
     *
     * @throws \Throwable
     */
    protected function processFailedTransfer(ServerTransfer $transfer): JsonResponse
    {
        $this->connection->transaction(function () use (&$transfer) {
            $transfer->forceFill(['successful' => false])->saveOrFail();

            $allocations = array_merge([$transfer->new_allocation], $transfer->new_additional_allocations);
            Allocation::query()->whereIn('id', $allocations)->update(['server_id' => null]);
        });

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }
}
</file>

<file path="app/Http/Controllers/Api/Remote/ActivityProcessingController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Remote;

use Carbon\Carbon;
use Jexactyl\Models\User;
use Illuminate\Support\Str;
use Jexactyl\Models\Server;
use Webmozart\Assert\Assert;
use Jexactyl\Models\ActivityLog;
use Illuminate\Support\Facades\Log;
use Jexactyl\Models\ActivityLogSubject;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Http\Requests\Api\Remote\ActivityEventRequest;

class ActivityProcessingController extends Controller
{
    public function __invoke(ActivityEventRequest $request)
    {
        $tz = Carbon::now()->getTimezone();

        /** @var \Jexactyl\Models\Node $node */
        $node = $request->attributes->get('node');

        $servers = $node->servers()->whereIn('uuid', $request->servers())->get()->keyBy('uuid');
        $users = User::query()->whereIn('uuid', $request->users())->get()->keyBy('uuid');

        $logs = [];
        foreach ($request->input('data') as $datum) {
            /** @var \Jexactyl\Models\Server|null $server */
            $server = $servers->get($datum['server']);
            if (is_null($server) || !Str::startsWith($datum['event'], 'server:')) {
                continue;
            }

            try {
                $when = Carbon::createFromFormat(
                    \DateTimeInterface::RFC3339,
                    preg_replace('/(\.\d+)Z$/', 'Z', $datum['timestamp']),
                    'UTC'
                );
            } catch (\Exception $exception) {
                Log::warning($exception, ['timestamp' => $datum['timestamp']]);

                // If we cannot parse the value for some reason don't blow up this request, just go ahead
                // and log the event with the current time, and set the metadata value to have the original
                // timestamp that was provided.
                $when = Carbon::now();
                $datum['metadata'] = array_merge($datum['metadata'] ?? [], ['original_timestamp' => $datum['timestamp']]);
            }

            $log = [
                'ip' => empty($datum['ip']) ? '127.0.0.1' : $datum['ip'],
                'event' => $datum['event'],
                'properties' => json_encode($datum['metadata'] ?? []),
                // We have to change the time to the current timezone due to the way Laravel is handling
                // the date casting internally. If we just leave it in UTC it ends up getting double-cast
                // and the time is way off.
                'timestamp' => $when->setTimezone($tz),
            ];

            if ($user = $users->get($datum['user'])) {
                $log['actor_id'] = $user->id;
                $log['actor_type'] = $user->getMorphClass();
            }

            if (!isset($logs[$datum['server']])) {
                $logs[$datum['server']] = [];
            }

            $logs[$datum['server']][] = $log;
        }

        foreach ($logs as $key => $data) {
            Assert::isInstanceOf($server = $servers->get($key), Server::class);

            $batch = [];
            foreach ($data as $datum) {
                $id = ActivityLog::insertGetId($datum);
                $batch[] = [
                    'activity_log_id' => $id,
                    'subject_id' => $server->id,
                    'subject_type' => $server->getMorphClass(),
                ];
            }

            ActivityLogSubject::insert($batch);
        }
    }
}
</file>

<file path="app/Http/Controllers/Api/Remote/EggInstallController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Remote;

use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Services\Servers\EnvironmentService;
use Jexactyl\Contracts\Repository\ServerRepositoryInterface;

class EggInstallController extends Controller
{
    /**
     * EggInstallController constructor.
     */
    public function __construct(private EnvironmentService $environment, private ServerRepositoryInterface $repository)
    {
    }

    /**
     * Handle request to get script and installation information for a server
     * that is being created on the node.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function index(Request $request, string $uuid): JsonResponse
    {
        $node = $request->attributes->get('node');

        /** @var \Jexactyl\Models\Server $server */
        $server = $this->repository->findFirstWhere([
            ['uuid', '=', $uuid],
            ['node_id', '=', $node->id],
        ]);

        $this->repository->loadEggRelations($server);
        $egg = $server->getRelation('egg');

        return response()->json([
            'scripts' => [
                'install' => !$egg->copy_script_install ? null : str_replace(["\r\n", "\n", "\r"], "\n", $egg->copy_script_install),
                'privileged' => $egg->script_is_privileged,
            ],
            'config' => [
                'container' => $egg->copy_script_container,
                'entry' => $egg->copy_script_entry,
            ],
            'env' => $this->environment->handle($server),
        ]);
    }
}
</file>

<file path="app/Http/Controllers/Api/Remote/SftpAuthenticationController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Remote;

use Jexactyl\Models\User;
use Jexactyl\Models\Server;
use Illuminate\Http\Request;
use Jexactyl\Facades\Activity;
use Jexactyl\Models\Permission;
use Illuminate\Http\JsonResponse;
use phpseclib3\Crypt\PublicKeyLoader;
use Jexactyl\Http\Controllers\Controller;
use phpseclib3\Exception\NoKeyLoadedException;
use Illuminate\Foundation\Auth\ThrottlesLogins;
use Jexactyl\Exceptions\Http\HttpForbiddenException;
use Jexactyl\Services\Servers\GetUserPermissionsService;
use Symfony\Component\HttpKernel\Exception\BadRequestHttpException;
use Jexactyl\Http\Requests\Api\Remote\SftpAuthenticationFormRequest;
use Symfony\Component\HttpKernel\Exception\TooManyRequestsHttpException;

class SftpAuthenticationController extends Controller
{
    use ThrottlesLogins;

    public function __construct(protected GetUserPermissionsService $permissions)
    {
    }

    /**
     * Authenticate a set of credentials and return the associated server details
     * for a SFTP connection on the daemon. This supports both public key and password
     * based credentials.
     */
    public function __invoke(SftpAuthenticationFormRequest $request): JsonResponse
    {
        $connection = $this->parseUsername($request->input('username'));
        if (empty($connection['server'])) {
            throw new BadRequestHttpException('No valid server identifier was included in the request.');
        }

        if ($this->hasTooManyLoginAttempts($request)) {
            $seconds = $this->limiter()->availableIn($this->throttleKey($request));

            throw new TooManyRequestsHttpException($seconds, "Too many login attempts for this account, please try again in $seconds seconds.");
        }

        $user = $this->getUser($request, $connection['username']);
        $server = $this->getServer($request, $connection['server']);

        if ($request->input('type') !== 'public_key') {
            if (!password_verify($request->input('password'), $user->password)) {
                Activity::event('auth:sftp.fail')->property('method', 'password')->subject($user)->log();

                $this->reject($request);
            }
        } else {
            $key = null;
            try {
                $key = PublicKeyLoader::loadPublicKey(trim($request->input('password')));
            } catch (NoKeyLoadedException) {
                // do nothing
            }

            if (!$key || !$user->sshKeys()->where('fingerprint', $key->getFingerprint('sha256'))->exists()) {
                // We don't log here because of the way the SFTP system works. This endpoint
                // will get hit for every key the user provides, which could be 4 or 5. That is
                // a lot of unnecessary log noise.
                //
                // For now, we'll only log failures due to a bad password as those are not likely
                // to occur more than once in a session for the user, and are more likely to be of
                // value to the end user.
                $this->reject($request, is_null($key));
            }
        }

        $this->validateSftpAccess($user, $server);

        return new JsonResponse([
            'user' => $user->uuid,
            'server' => $server->uuid,
            'permissions' => $this->permissions->handle($server, $user),
        ]);
    }

    /**
     * Finds the server being requested and ensures that it belongs to the node this
     * request stems from.
     */
    protected function getServer(Request $request, string $uuid): Server
    {
        return Server::query()
            ->where(fn ($builder) => $builder->where('uuid', $uuid)->orWhere('uuidShort', $uuid))
            ->where('node_id', $request->attributes->get('node')->id)
            ->firstOr(function () use ($request) {
                $this->reject($request);
            });
    }

    /**
     * Finds a user with the given username or increments the login attempts.
     */
    protected function getUser(Request $request, string $username): User
    {
        return User::query()->where('username', $username)->firstOr(function () use ($request) {
            $this->reject($request);
        });
    }

    /**
     * Parses the username provided to the request.
     *
     * @return array{"username": string, "server": string}
     */
    protected function parseUsername(string $value): array
    {
        // Reverse the string to avoid issues with usernames that contain periods.
        $parts = explode('.', strrev($value), 2);

        // Unreverse the strings after parsing them apart.
        return [
            'username' => strrev(array_get($parts, 1)),
            'server' => strrev(array_get($parts, 0)),
        ];
    }

    /**
     * Rejects the request and increments the login attempts.
     */
    protected function reject(Request $request, bool $increment = true): void
    {
        if ($increment) {
            $this->incrementLoginAttempts($request);
        }

        throw new HttpForbiddenException('Authorization credentials were not correct, please try again.');
    }

    /**
     * Validates that a user should have permission to use SFTP for the given server.
     */
    protected function validateSftpAccess(User $user, Server $server): void
    {
        if (!$user->root_admin && $server->owner_id !== $user->id) {
            $permissions = $this->permissions->handle($server, $user);

            if (!in_array(Permission::ACTION_FILE_SFTP, $permissions)) {
                Activity::event('server:sftp.denied')->actor($user)->subject($server)->log();

                throw new HttpForbiddenException('You do not have permission to access SFTP for this server.');
            }
        }

        $server->validateCurrentState();
    }

    /**
     * Get the throttle key for the given request.
     */
    protected function throttleKey(Request $request): string
    {
        $username = explode('.', strrev($request->input('username', '')));

        return strtolower(strrev($username[0] ?? '') . '|' . $request->ip());
    }
}
</file>

<file path="app/Http/Controllers/Auth/AbstractLoginController.php">
<?php

namespace Jexactyl\Http\Controllers\Auth;

use Jexactyl\Models\User;
use Illuminate\Http\Request;
use Illuminate\Auth\AuthManager;
use Illuminate\Http\JsonResponse;
use Illuminate\Auth\Events\Failed;
use Illuminate\Container\Container;
use Illuminate\Support\Facades\Event;
use Jexactyl\Events\Auth\DirectLogin;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Foundation\Auth\AuthenticatesUsers;

abstract class AbstractLoginController extends Controller
{
    use AuthenticatesUsers;

    protected AuthManager $auth;

    /**
     * Lockout time for failed login requests.
     */
    protected int $lockoutTime;

    /**
     * After how many attempts should logins be throttled and locked.
     */
    protected int $maxLoginAttempts;

    /**
     * Where to redirect users after login / registration.
     */
    protected string $redirectTo = '/';

    /**
     * @var \Jexactyl\Models\AccountLog
     */
    protected $log;

    /**
     * LoginController constructor.
     */
    public function __construct()
    {
        $this->lockoutTime = config('auth.lockout.time');
        $this->maxLoginAttempts = config('auth.lockout.attempts');
        $this->auth = Container::getInstance()->make(AuthManager::class);
    }

    /**
     * Get the failed login response instance.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    protected function sendFailedLoginResponse(Request $request, Authenticatable $user = null, string $message = null)
    {
        $this->incrementLoginAttempts($request);
        $this->fireFailedLoginEvent($user, [
            $this->getField($request->input('user')) => $request->input('user'),
        ]);

        if ($request->route()->named('auth.login-checkpoint')) {
            throw new DisplayException($message ?? trans('auth.two_factor.checkpoint_failed'));
        }

        throw new DisplayException(trans('auth.failed'));
    }

    /**
     * Send the response after the user was authenticated.
     *
     * @throws DisplayException
     */
    protected function sendLoginResponse(User $user, Request $request): JsonResponse
    {
        $request->session()->remove('auth_confirmation_token');
        $request->session()->regenerate();

        $this->clearLoginAttempts($request);

        $this->auth->guard()->login($user, true);

        Event::dispatch(new DirectLogin($user, true));

        return new JsonResponse([
            'data' => [
                'complete' => true,
                'intended' => $this->redirectPath(),
                'user' => $user->toVueObject(),
            ],
        ]);
    }

    /**
     * Determine if the user is logging in using an email or username.
     */
    protected function getField(string $input = null): string
    {
        return ($input && str_contains($input, '@')) ? 'email' : 'username';
    }

    /**
     * Fire a failed login event.
     */
    protected function fireFailedLoginEvent(Authenticatable $user = null, array $credentials = [])
    {
        Event::dispatch(new Failed('auth', $user, $credentials));
    }
}
</file>

<file path="app/Http/Controllers/Auth/DiscordController.php">
<?php

namespace Jexactyl\Http\Controllers\Auth;

use Jexactyl\Models\User;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Http;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Services\Users\UserCreationService;
use Jexactyl\Exceptions\Model\DataValidationException;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;

class DiscordController extends Controller
{
    private SettingsRepositoryInterface $settings;
    private UserCreationService $creationService;

    public function __construct(
        UserCreationService $creationService,
        SettingsRepositoryInterface $settings,
    ) {
        $this->creationService = $creationService;
        $this->settings = $settings;
    }

    /**
     * Uses the Discord API to return a user objext.
     */
    public function index(): JsonResponse
    {
        return new JsonResponse([
            'https://discord.com/api/oauth2/authorize?'
            . 'client_id=' . $this->settings->get('jexactyl::discord:id')
            . '&redirect_uri=' . route('auth.discord.callback')
            . '&response_type=code&scope=identify%20email%20guilds%20guilds.join&prompt=none',
        ], 200, [], null, false);
    }

    /**
     * Returns data from the Discord API to login.
     *
     * @throws DisplayException
     * @throws DataValidationException
     */
    public function callback(Request $request)
    {
        $code = Http::asForm()->post('https://discord.com/api/oauth2/token', [
            'client_id' => $this->settings->get('jexactyl::discord:id'),
            'client_secret' => $this->settings->get('jexactyl::discord:secret'),
            'grant_type' => 'authorization_code',
            'code' => $request->input('code'),
            'redirect_uri' => route('auth.discord.callback'),
        ]);

        if (!$code->ok()) {
            return;
        }

        $req = json_decode($code->body());
        if (preg_match('(email|guilds|identify|guilds.join)', $req->scope) !== 1) {
            return;
        }

        $discord = json_decode(Http::withHeaders(['Authorization' => 'Bearer ' . $req->access_token])->asForm()->get('https://discord.com/api/users/@me')->body());

        if (User::where('discord_id', $discord->id)->exists()) {
            $user = User::where('discord_id', $discord->id)->first();
            Auth::loginUsingId($user->id, true);

            return redirect('/');
        } else {
            $approved = true;

            if ($this->settings->get('jexactyl::discord:enabled') != 'true') {
                return;
            }
            if ($this->settings->get('jexactyl::approvals:enabled') == 'true') {
                $approved = false;
            }

            $data = [
                'approved' => $approved,
                'email' => $discord->email,
                'username' => $discord->id,
                'discord_id' => $discord->id,
                'name_first' => $discord->username,
                'name_last' => $discord->discriminator,
                'password' => $this->genString(),
                'ip' => $request->getClientIp(),
                'store_cpu' => $this->settings->get('jexactyl::registration:cpu', 0),
                'store_memory' => $this->settings->get('jexactyl::registration:memory', 0),
                'store_disk' => $this->settings->get('jexactyl::registration:disk', 0),
                'store_slots' => $this->settings->get('jexactyl::registration:slot', 0),
                'store_ports' => $this->settings->get('jexactyl::registration:port', 0),
                'store_backups' => $this->settings->get('jexactyl::registration:backup', 0),
                'store_databases' => $this->settings->get('jexactyl::registration:database', 0),
            ];

            try {
                $this->creationService->handle($data);
            } catch (\Exception $e) {
                return;
            }
            $user = User::where('username', $discord->id)->first();
            Auth::loginUsingId($user->id, true);

            return redirect('/');
        }
    }

    /**
     * Returns a string used for creating a users
     * username and password on the Panel.
     */
    public function genString(): string
    {
        $chars = '1234567890ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';

        return substr(str_shuffle($chars), 0, 16);
    }
}
</file>

<file path="app/Http/Controllers/Auth/ForgotPasswordController.php">
<?php

namespace Jexactyl\Http\Controllers\Auth;

use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\Password;
use Jexactyl\Http\Controllers\Controller;
use Jexactyl\Events\Auth\FailedPasswordReset;
use Illuminate\Foundation\Auth\SendsPasswordResetEmails;

class ForgotPasswordController extends Controller
{
    use SendsPasswordResetEmails;

    /**
     * Get the response for a failed password reset link.
     */
    protected function sendResetLinkFailedResponse(Request $request, $response): JsonResponse
    {
        // As noted in #358 we will return success even if it failed
        // to avoid pointing out that an account does or does not
        // exist on the system.
        event(new FailedPasswordReset($request->ip(), $request->input('email')));

        return $this->sendResetLinkResponse($request, Password::RESET_LINK_SENT);
    }

    /**
     * Get the response for a successful password reset link.
     *
     * @param string $response
     */
    protected function sendResetLinkResponse(Request $request, $response): JsonResponse
    {
        return response()->json([
            'status' => trans($response),
        ]);
    }
}
</file>

<file path="app/Http/Controllers/Auth/LoginCheckpointController.php">
<?php

namespace Jexactyl\Http\Controllers\Auth;

use Jexactyl\Models\User;
use Carbon\CarbonImmutable;
use Carbon\CarbonInterface;
use Illuminate\Http\JsonResponse;
use PragmaRX\Google2FA\Google2FA;
use Illuminate\Support\Facades\Event;
use Illuminate\Contracts\Encryption\Encrypter;
use Jexactyl\Events\Auth\ProvidedAuthenticationToken;
use Jexactyl\Http\Requests\Auth\LoginCheckpointRequest;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Illuminate\Contracts\Validation\Factory as ValidationFactory;

class LoginCheckpointController extends AbstractLoginController
{
    private const TOKEN_EXPIRED_MESSAGE = 'The authentication token provided has expired, please refresh the page and try again.';

    /**
     * LoginCheckpointController constructor.
     */
    public function __construct(
        private Encrypter $encrypter,
        private Google2FA $google2FA,
        private ValidationFactory $validation
    ) {
        parent::__construct();
    }

    /**
     * Handle a login where the user is required to provide a TOTP authentication
     * token. Once a user has reached this stage it is assumed that they have already
     * provided a valid username and password.
     *
     * @throws \PragmaRX\Google2FA\Exceptions\IncompatibleWithGoogleAuthenticatorException
     * @throws \PragmaRX\Google2FA\Exceptions\InvalidCharactersException
     * @throws \PragmaRX\Google2FA\Exceptions\SecretKeyTooShortException
     * @throws \Exception
     * @throws \Illuminate\Validation\ValidationException
     */
    public function __invoke(LoginCheckpointRequest $request): JsonResponse
    {
        if ($this->hasTooManyLoginAttempts($request)) {
            $this->sendLockoutResponse($request);
        }

        $details = $request->session()->get('auth_confirmation_token');
        if (!$this->hasValidSessionData($details)) {
            $this->sendFailedLoginResponse($request, null, self::TOKEN_EXPIRED_MESSAGE);
        }

        if (!hash_equals($request->input('confirmation_token') ?? '', $details['token_value'])) {
            $this->sendFailedLoginResponse($request);
        }

        try {
            /** @var \Jexactyl\Models\User $user */
            $user = User::query()->findOrFail($details['user_id']);
        } catch (ModelNotFoundException) {
            $this->sendFailedLoginResponse($request, null, self::TOKEN_EXPIRED_MESSAGE);
        }

        // Recovery tokens go through a slightly different pathway for usage.
        if (!is_null($recoveryToken = $request->input('recovery_token'))) {
            if ($this->isValidRecoveryToken($user, $recoveryToken)) {
                Event::dispatch(new ProvidedAuthenticationToken($user, true));

                return $this->sendLoginResponse($user, $request);
            }
        } else {
            $decrypted = $this->encrypter->decrypt($user->totp_secret);

            if ($this->google2FA->verifyKey($decrypted, (string) $request->input('authentication_code') ?? '', config('jexactyl.auth.2fa.window'))) {
                Event::dispatch(new ProvidedAuthenticationToken($user));

                return $this->sendLoginResponse($user, $request);
            }
        }

        $this->sendFailedLoginResponse($request, $user, !empty($recoveryToken) ? 'The recovery token provided is not valid.' : null);
    }

    /**
     * Determines if a given recovery token is valid for the user account. If we find a matching token
     * it will be deleted from the database.
     *
     * @throws \Exception
     */
    protected function isValidRecoveryToken(User $user, string $value): bool
    {
        foreach ($user->recoveryTokens as $token) {
            if (password_verify($value, $token->token)) {
                $token->delete();

                return true;
            }
        }

        return false;
    }

    /**
     * Determines if the data provided from the session is valid or not. This
     * will return false if the data is invalid, or if more time has passed than
     * was configured when the session was written.
     */
    protected function hasValidSessionData(array $data): bool
    {
        $validator = $this->validation->make($data, [
            'user_id' => 'required|integer|min:1',
            'token_value' => 'required|string',
            'expires_at' => 'required',
        ]);

        if ($validator->fails()) {
            return false;
        }

        if (!$data['expires_at'] instanceof CarbonInterface) {
            return false;
        }

        if ($data['expires_at']->isBefore(CarbonImmutable::now())) {
            return false;
        }

        return true;
    }
}
</file>

<file path="app/Http/Controllers/Auth/LoginController.php">
<?php

namespace Jexactyl\Http\Controllers\Auth;

use Jexactyl\Models\User;
use Carbon\CarbonImmutable;
use Illuminate\Support\Str;
use Illuminate\Http\Request;
use Jexactyl\Facades\Activity;
use Illuminate\Http\JsonResponse;
use Illuminate\Contracts\View\View;
use Illuminate\Contracts\View\Factory as ViewFactory;
use Illuminate\Database\Eloquent\ModelNotFoundException;

class LoginController extends AbstractLoginController
{
    /**
     * LoginController constructor.
     */
    public function __construct(private ViewFactory $view)
    {
        parent::__construct();
    }

    /**
     * Handle all incoming requests for the authentication routes and render the
     * base authentication view component. React will take over at this point and
     * turn the login area into an SPA.
     */
    public function index(): View
    {
        return $this->view->make('templates/auth.core');
    }

    /**
     * Handle a login request to the application.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Illuminate\Validation\ValidationException
     */
    public function login(Request $request): JsonResponse
    {
        if ($this->hasTooManyLoginAttempts($request)) {
            $this->fireLockoutEvent($request);
            $this->sendLockoutResponse($request);
        }

        try {
            $username = $request->input('user');

            /** @var \Jexactyl\Models\User $user */
            $user = User::query()->where($this->getField($username), $username)->firstOrFail();
        } catch (ModelNotFoundException) {
            $this->sendFailedLoginResponse($request);
        }

        // Ensure that the account is using a valid username and password before trying to
        // continue. Previously this was handled in the 2FA checkpoint, however that has
        // a flaw in which you can discover if an account exists simply by seeing if you
        // can proceed to the next step in the login process.
        if (!password_verify($request->input('password'), $user->password)) {
            $this->sendFailedLoginResponse($request, $user);
        }

        if (!$user->use_totp) {
            return $this->sendLoginResponse($user, $request);
        }

        Activity::event('auth:checkpoint')->withRequestMetadata()->subject($user)->log();

        $request->session()->put('auth_confirmation_token', [
            'user_id' => $user->id,
            'token_value' => $token = Str::random(64),
            'expires_at' => CarbonImmutable::now()->addMinutes(5),
        ]);

        return new JsonResponse([
            'data' => [
                'complete' => false,
                'confirmation_token' => $token,
            ],
        ]);
    }
}
</file>

<file path="app/Http/Controllers/Auth/RegisterController.php">
<?php

namespace Jexactyl\Http\Controllers\Auth;

use Illuminate\Http\JsonResponse;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Http\Requests\Auth\RegisterRequest;
use Jexactyl\Services\Users\UserCreationService;
use Jexactyl\Exceptions\Model\DataValidationException;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;

class RegisterController extends AbstractLoginController
{
    /**
     * RegisterController constructor.
     */
    public function __construct(private UserCreationService $creationService, private SettingsRepositoryInterface $settings)
    {
        parent::__construct();
    }

    /**
     * Handle a register request to the application.
     *
     * @throws DataValidationException|DisplayException
     */
    public function register(RegisterRequest $request): JsonResponse
    {
        $approved = true;
        $verified = true;
        $prefix = 'jexactyl::registration:';

        if ($this->settings->get($prefix . 'enabled') != 'true') {
            throw new DisplayException('Unable to register user.');
        }

        if ($this->settings->get($prefix . 'verification') === 'true') {
            $verified = false;
        }

        if ($this->settings->get('jexactyl::approvals:enabled') === 'true') {
            $approved = false;
        }

        $this->creationService->handle([
            'email' => $request->input('email'),
            'username' => $request->input('user'),
            'name_first' => 'Jexactyl',
            'name_last' => 'User',
            'password' => $request->input('password'),
            'ip' => $request->getClientIp(),
            'store_cpu' => $this->settings->get($prefix . 'cpu', 0),
            'store_memory' => $this->settings->get($prefix . 'memory', 0),
            'store_disk' => $this->settings->get($prefix . 'disk', 0),
            'store_slots' => $this->settings->get($prefix . 'slot', 0),
            'store_ports' => $this->settings->get($prefix . 'port', 0),
            'store_backups' => $this->settings->get($prefix . 'backup', 0),
            'store_databases' => $this->settings->get($prefix . 'database', 0),
            'approved' => $approved,
            'verified' => $verified,
        ]);

        return new JsonResponse([
            'data' => [
                'complete' => true,
                'intended' => $this->redirectPath(),
            ],
        ]);
    }
}
</file>

<file path="app/Http/Controllers/Auth/ResetPasswordController.php">
<?php

namespace Jexactyl\Http\Controllers\Auth;

use Illuminate\Support\Str;
use Illuminate\Http\JsonResponse;
use Illuminate\Contracts\Hashing\Hasher;
use Illuminate\Support\Facades\Password;
use Illuminate\Auth\Events\PasswordReset;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\Contracts\Events\Dispatcher;
use Illuminate\Foundation\Auth\ResetsPasswords;
use Jexactyl\Http\Requests\Auth\ResetPasswordRequest;
use Jexactyl\Contracts\Repository\UserRepositoryInterface;

class ResetPasswordController extends Controller
{
    use ResetsPasswords;

    /**
     * The URL to redirect users to after password reset.
     */
    public string $redirectTo = '/';

    protected bool $hasTwoFactor = false;

    /**
     * ResetPasswordController constructor.
     */
    public function __construct(
        private Dispatcher $dispatcher,
        private Hasher $hasher,
        private UserRepositoryInterface $userRepository
    ) {
    }

    /**
     * Reset the given user's password.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    public function __invoke(ResetPasswordRequest $request): JsonResponse
    {
        // Here we will attempt to reset the user's password. If it is successful we
        // will update the password on an actual user model and persist it to the
        // database. Otherwise, we will parse the error and return the response.
        $response = $this->broker()->reset(
            $this->credentials($request),
            function ($user, $password) {
                $this->resetPassword($user, $password);
            }
        );

        // If the password was successfully reset, we will redirect the user back to
        // the application's home authenticated view. If there is an error we can
        // redirect them back to where they came from with their error message.
        if ($response === Password::PASSWORD_RESET) {
            return $this->sendResetResponse();
        }

        throw new DisplayException(trans($response));
    }

    /**
     * Reset the given user's password. If the user has two-factor authentication enabled on their
     * account do not automatically log them in. In those cases, send the user back to the login
     * form with a note telling them their password was changed and to log back in.
     *
     * @param \Illuminate\Contracts\Auth\CanResetPassword|\Jexactyl\Models\User $user
     * @param string $password
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    protected function resetPassword($user, $password)
    {
        $user = $this->userRepository->update($user->id, [
            'password' => $this->hasher->make($password),
            $user->getRememberTokenName() => Str::random(60),
        ]);

        $this->dispatcher->dispatch(new PasswordReset($user));

        // If the user is not using 2FA log them in, otherwise skip this step and force a
        // fresh login where they'll be prompted to enter a token.
        if (!$user->use_totp) {
            $this->guard()->login($user);
        }

        $this->hasTwoFactor = $user->use_totp;
    }

    /**
     * Send a successful password reset response back to the callee.
     */
    protected function sendResetResponse(): JsonResponse
    {
        return response()->json([
            'success' => true,
            'redirect_to' => $this->redirectTo,
            'send_to_login' => $this->hasTwoFactor,
        ]);
    }
}
</file>

<file path="app/Http/Controllers/Auth/VerifyAccountController.php">
<?php

namespace Jexactyl\Http\Controllers\Auth;

use Jexactyl\Models\User;
use Illuminate\Support\Facades\DB;
use Illuminate\Http\RedirectResponse;
use Jexactyl\Http\Controllers\Controller;

class VerifyAccountController extends Controller
{
    public function index(string $token): RedirectResponse
    {
        $data = DB::table('verification_tokens')->select('user')->where('token', $token)->first()->user;
        if (!$data) {
            return response()->redirectTo('/');
        }

        $user = User::whereId($data)->first()->id;
        if (!$user) {
            return response()->redirectTo('/');
        }

        User::whereId($user)->update(['verified' => true]);
        DB::table('verification_tokens')->where('user', $user)->delete();

        return response()->redirectTo('/');
    }
}
</file>

<file path="app/Http/Controllers/Base/IndexController.php">
<?php

namespace Jexactyl\Http\Controllers\Base;

use Illuminate\View\View;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\View\Factory as ViewFactory;
use Jexactyl\Contracts\Repository\ServerRepositoryInterface;

class IndexController extends Controller
{
    /**
     * IndexController constructor.
     */
    public function __construct(
        protected ServerRepositoryInterface $repository,
        protected ViewFactory $view
    ) {
    }

    /**
     * Returns listing of user's servers.
     */
    public function index(): View
    {
        return $this->view->make('templates/base.core');
    }
}
</file>

<file path="app/Http/Controllers/Base/LocaleController.php">
<?php

namespace Jexactyl\Http\Controllers\Base;

use Illuminate\Http\JsonResponse;
use Illuminate\Translation\Translator;
use Jexactyl\Http\Controllers\Controller;
use Illuminate\Contracts\Translation\Loader;
use Jexactyl\Http\Requests\LocaleRequest;

class LocaleController extends Controller
{
    protected Loader $loader;

    public function __construct(Translator $translator)
    {
        $this->loader = $translator->getLoader();
    }

    /**
     * Returns translation data given a specific locale and namespace.
     */
    public function __invoke(LocaleRequest $request): JsonResponse
    {
        $locale = $request->input('locale');
        $namespace = $request->input('namespace');
        $response[$locale][$namespace] = $this->i18n($this->loader->load($locale, $namespace));

        return new JsonResponse($response, 200, [
            // Cache this in the browser for an hour, and allow the browser to use a stale
            // cache for up to a day after it was created while it fetches an updated set
            // of translation keys.
            'Cache-Control' => 'public, max-age=3600, stale-while-revalidate=86400',
            'ETag' => md5(json_encode($response, JSON_THROW_ON_ERROR)),
        ]);
    }

    /**
     * Convert standard Laravel translation keys that look like ":foo"
     * into key structures that are supported by the front-end i18n
     * library, like "{{foo}}".
     */
    protected function i18n(array $data): array
    {
        foreach ($data as $key => $value) {
            if (is_array($value)) {
                $data[$key] = $this->i18n($value);
            } else {
                // Find a Laravel style translation replacement in the string and replace it with
                // one that the front-end is able to use. This won't always be present, especially
                // for complex strings or things where we'd never have a backend component anyways.
                //
                // For example:
                // "Hello :name, the :notifications.0.title notification needs :count actions :foo.0.bar."
                //
                // Becomes:
                // "Hello {{name}}, the {{notifications.0.title}} notification needs {{count}} actions {{foo.0.bar}}."
                $data[$key] = preg_replace('/:([\w.-]+\w)([^\w:]?|$)/m', '{{$1}}$2', $value);
            }
        }

        return $data;
    }
}
</file>

<file path="app/Http/Controllers/Base/StripeController.php">
<?php

namespace Jexactyl\Http\Controllers\Base;

use Stripe\Stripe;
use Stripe\Webhook;
use Jexactyl\Models\User;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Jexactyl\Http\Controllers\Controller;
use Stripe\Exception\SignatureVerificationException;

class StripeController extends Controller
{
    public function index(Request $request): Response
    {
        Stripe::setApiKey(config('gateways.stripe.secret'));
        try {
            $event = Webhook::constructEvent($request->getContent(), $request->headers->get('stripe-signature'), config('gateways.stripe.webhook_secret'));
        } catch (SignatureVerificationException $e) {
            return new Response('Error Unvalidated', 401);
        }
        $data = $event->data->toArray()['object'];
        try {
            $msg = match ($event->type) {
                'checkout.session.completed' => $this->completed($data),
                default => 'Ignored - Unhandled Event'
            };
        } catch (\Exception $e) {
            $msg = "Failed - {$e}";
        }

        return new Response($msg, 200);
    }

    private function completed(array $data): string
    {
        if ($data['payment_status'] !== 'paid') {
            return 'Failed - Payment Issue';
        }
        $bal = User::query()->select('store_balance')->where('id', '=', $data['metadata']['user_id'])->first()->store_balance;
        User::query()->where('id', '=', $data['metadata']['user_id'])->update(['store_balance' => $bal + $data['metadata']['credit_amount']]);

        return 'Success - Credits Added';
    }
}
</file>

<file path="app/Http/Controllers/Controller.php">
<?php

namespace Jexactyl\Http\Controllers;

use Illuminate\Foundation\Bus\DispatchesJobs;
use Illuminate\Routing\Controller as BaseController;
use Illuminate\Foundation\Validation\ValidatesRequests;
use Illuminate\Foundation\Auth\Access\AuthorizesRequests;

abstract class Controller extends BaseController
{
    use AuthorizesRequests;
    use DispatchesJobs;
    use ValidatesRequests;
}
</file>

<file path="app/Http/Middleware/Activity/AccountSubject.php">
<?php

namespace Jexactyl\Http\Middleware\Activity;

use Illuminate\Http\Request;
use Jexactyl\Facades\LogTarget;

class AccountSubject
{
    /**
     * Sets the actor and default subject for all requests passing through this
     * middleware to be the currently logged in user.
     */
    public function handle(Request $request, \Closure $next)
    {
        LogTarget::setActor($request->user());
        LogTarget::setSubject($request->user());

        return $next($request);
    }
}
</file>

<file path="app/Http/Middleware/Activity/ServerSubject.php">
<?php

namespace Jexactyl\Http\Middleware\Activity;

use Jexactyl\Models\Server;
use Illuminate\Http\Request;
use Jexactyl\Facades\LogTarget;

class ServerSubject
{
    /**
     * Attempts to automatically scope all of the activity log events registered
     * within the request instance to the given user and server. This only sets
     * the actor and subject if there is a server present on the request.
     *
     * If no server is found this is a no-op as the activity log service can always
     * set the user based on the authmanager response.
     */
    public function handle(Request $request, \Closure $next)
    {
        $server = $request->route()->parameter('server');
        if ($server instanceof Server) {
            LogTarget::setActor($request->user());
            LogTarget::setSubject($server);
        }

        return $next($request);
    }
}
</file>

<file path="app/Http/Middleware/Activity/TrackAPIKey.php">
<?php

namespace Jexactyl\Http\Middleware\Activity;

use Jexactyl\Models\ApiKey;
use Illuminate\Http\Request;
use Jexactyl\Facades\LogTarget;

class TrackAPIKey
{
    /**
     * Determines if the authenticated user making this request is using an actual
     * API key, or it is just a cookie authenticated session. This data is set in a
     * request singleton so that all tracked activity log events are properly associated
     * with the given API key.
     */
    public function handle(Request $request, \Closure $next): mixed
    {
        if ($request->user()) {
            $token = $request->user()->currentAccessToken();

            LogTarget::setApiKeyId($token instanceof ApiKey ? $token->id : null);
        }

        return $next($request);
    }
}
</file>

<file path="app/Http/Middleware/Admin/Servers/ServerInstalled.php">
<?php

namespace Jexactyl\Http\Middleware\Admin\Servers;

use Jexactyl\Models\Server;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Symfony\Component\HttpKernel\Exception\HttpException;
use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;

class ServerInstalled
{
    /**
     * Checks that the server is installed before allowing access through the route.
     */
    public function handle(Request $request, \Closure $next): mixed
    {
        /** @var \Jexactyl\Models\Server|null $server */
        $server = $request->route()->parameter('server');

        if (!$server instanceof Server) {
            throw new NotFoundHttpException('No server resource was located in the request parameters.');
        }

        if (!$server->isInstalled()) {
            throw new HttpException(Response::HTTP_FORBIDDEN, 'Access to this resource is not allowed due to the current installation state.');
        }

        return $next($request);
    }
}
</file>

<file path="app/Http/Middleware/Api/Application/AuthenticateApplicationUser.php">
<?php

namespace Jexactyl\Http\Middleware\Api\Application;

use Illuminate\Http\Request;
use Symfony\Component\HttpKernel\Exception\AccessDeniedHttpException;

class AuthenticateApplicationUser
{
    /**
     * Authenticate that the currently authenticated user is an administrator
     * and should be allowed to proceed through the application API.
     */
    public function handle(Request $request, \Closure $next): mixed
    {
        /** @var \Jexactyl\Models\User|null $user */
        $user = $request->user();
        if (!$user || !$user->root_admin) {
            throw new AccessDeniedHttpException('This account does not have permission to access the API.');
        }

        return $next($request);
    }
}
</file>

<file path="app/Http/Middleware/Api/Client/Server/AuthenticateServerAccess.php">
<?php

namespace Jexactyl\Http\Middleware\Api\Client\Server;

use Jexactyl\Models\Server;
use Illuminate\Http\Request;
use Jexactyl\Exceptions\Http\Server\ServerStateConflictException;
use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;

class AuthenticateServerAccess
{
    /**
     * Routes that this middleware should not apply to if the user is an admin.
     */
    protected array $except = [
        'api:client:server.ws',
    ];

    /**
     * AuthenticateServerAccess constructor.
     */
    public function __construct()
    {
    }

    /**
     * Authenticate that this server exists and is not suspended or marked as installing.
     */
    public function handle(Request $request, \Closure $next): mixed
    {
        /** @var \Jexactyl\Models\User $user */
        $user = $request->user();
        $server = $request->route()->parameter('server');

        if (!$server instanceof Server) {
            throw new NotFoundHttpException(trans('exceptions.api.resource_not_found'));
        }

        // At the very least, ensure that the user trying to make this request is the
        // server owner, a subuser, or a root admin. We'll leave it up to the controllers
        // to authenticate more detailed permissions if needed.
        if ($user->id !== $server->owner_id && !$user->root_admin) {
            // Check for subuser status.
            if (!$server->subusers->contains('user_id', $user->id)) {
                throw new NotFoundHttpException(trans('exceptions.api.resource_not_found'));
            }
        }

        if (!$request->routeIs(['api:client:server.delete', 'api:client:server.renew'])) {
            try {
                $server->validateCurrentState();
            } catch (ServerStateConflictException $exception) {
                // Still allow users to get information about their server if it is installing or
                // being transferred.
                if (!$request->routeIs('api:client:server.view')) {
                    if (($server->isSuspended() || $server->node->isUnderMaintenance()) && !$request->routeIs('api:client:server.resources')) {
                        throw $exception;
                    }
                    if (!$user->root_admin || !$request->routeIs($this->except)) {
                        throw $exception;
                    }
                }
            }
        }

        $request->attributes->set('server', $server);

        return $next($request);
    }
}
</file>

<file path="app/Http/Middleware/Api/Client/Server/ResourceBelongsToServer.php">
<?php

namespace Jexactyl\Http\Middleware\Api\Client\Server;

use Jexactyl\Models\Task;
use Jexactyl\Models\User;
use Jexactyl\Models\Backup;
use Jexactyl\Models\Server;
use Illuminate\Http\Request;
use Jexactyl\Models\Subuser;
use Jexactyl\Models\Database;
use Jexactyl\Models\Schedule;
use Jexactyl\Models\Allocation;
use Illuminate\Database\Eloquent\Model;
use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;

class ResourceBelongsToServer
{
    /**
     * Looks at the request parameters to determine if the given resource belongs
     * to the requested server. If not, a 404 error will be returned to the caller.
     *
     * This is critical to ensuring that all subsequent logic is using exactly the
     * server that is expected, and that we're not accessing a resource completely
     * unrelated to the server provided in the request.
     */
    public function handle(Request $request, \Closure $next): mixed
    {
        $params = $request->route()->parameters();
        if (is_null($params) || !$params['server'] instanceof Server) {
            throw new \InvalidArgumentException('This middleware cannot be used in a context that is missing a server in the parameters.');
        }

        /** @var \Jexactyl\Models\Server $server */
        $server = $request->route()->parameter('server');
        $exception = new NotFoundHttpException('The requested resource was not found for this server.');
        foreach ($params as $key => $model) {
            // Specifically skip the server, we're just trying to see if all of the
            // other resources are assigned to this server. Also skip anything that
            // is not currently a Model instance since those will just end up being
            // a 404 down the road.
            if ($key === 'server' || !$model instanceof Model) {
                continue;
            }

            switch (get_class($model)) {
                // All of these models use "server_id" as the field key for the server
                // they are assigned to, so the logic is identical for them all.
                case Allocation::class:
                case Backup::class:
                case Database::class:
                case Schedule::class:
                case Subuser::class:
                    if ($model->server_id !== $server->id) {
                        throw $exception;
                    }
                    break;
                    // Regular users are a special case here as we need to make sure they're
                    // currently assigned as a subuser on the server.
                case User::class:
                    $subuser = $server->subusers()->where('user_id', $model->id)->first();
                    if (is_null($subuser)) {
                        throw $exception;
                    }
                    // This is a special case to avoid an additional query being triggered
                    // in the underlying logic.
                    $request->attributes->set('subuser', $subuser);
                    break;
                    // Tasks are special since they're (currently) the only item in the API
                    // that requires something in addition to the server in order to be accessed.
                case Task::class:
                    $schedule = $request->route()->parameter('schedule');
                    if ($model->schedule_id !== $schedule->id || $schedule->server_id !== $server->id) {
                        throw $exception;
                    }
                    break;
                default:
                    // Don't return a 404 here since we want to make sure no one relies
                    // on this middleware in a context in which it will not work. Fail safe.
                    throw new \InvalidArgumentException('There is no handler configured for a resource of this type: ' . get_class($model));
            }
        }

        return $next($request);
    }
}
</file>

<file path="app/Http/Middleware/Api/Client/RequireClientApiKey.php">
<?php

namespace Jexactyl\Http\Middleware\Api\Client;

use Jexactyl\Models\ApiKey;
use Illuminate\Http\Request;
use Symfony\Component\HttpKernel\Exception\AccessDeniedHttpException;

class RequireClientApiKey
{
    /**
     * Blocks a request to the Client API endpoints if the user is providing an API token
     * that was created for the application API.
     */
    public function handle(Request $request, \Closure $next): mixed
    {
        $token = $request->user()->currentAccessToken();

        if ($token instanceof ApiKey && $token->key_type === ApiKey::TYPE_APPLICATION) {
            throw new AccessDeniedHttpException('You are attempting to use an application API key on an endpoint that requires a client API key.');
        }

        return $next($request);
    }
}
</file>

<file path="app/Http/Middleware/Api/Client/SubstituteClientBindings.php">
<?php

namespace Jexactyl\Http\Middleware\Api\Client;

use Jexactyl\Models\Server;
use Illuminate\Routing\Middleware\SubstituteBindings;

class SubstituteClientBindings extends SubstituteBindings
{
    /**
     * @param \Illuminate\Http\Request $request
     */
    public function handle($request, \Closure $next): mixed
    {
        // Override default behavior of the model binding to use a specific table
        // column rather than the default 'id'.
        $this->router->bind('server', function ($value) {
            return Server::query()->where(strlen($value) === 8 ? 'uuidShort' : 'uuid', $value)->firstOrFail();
        });

        $this->router->bind('user', function ($value, $route) {
            /** @var \Jexactyl\Models\Subuser $match */
            $match = $route->parameter('server')
                ->subusers()
                ->whereRelation('user', 'uuid', '=', $value)
                ->firstOrFail();

            return $match->user;
        });

        return parent::handle($request, $next);
    }
}
</file>

<file path="app/Http/Middleware/Api/Daemon/DaemonAuthenticate.php">
<?php

namespace Jexactyl\Http\Middleware\Api\Daemon;

use Illuminate\Http\Request;
use Illuminate\Contracts\Encryption\Encrypter;
use Jexactyl\Repositories\Eloquent\NodeRepository;
use Symfony\Component\HttpKernel\Exception\HttpException;
use Jexactyl\Exceptions\Repository\RecordNotFoundException;
use Symfony\Component\HttpKernel\Exception\BadRequestHttpException;
use Symfony\Component\HttpKernel\Exception\AccessDeniedHttpException;

class DaemonAuthenticate
{
    /**
     * Daemon routes that this middleware should be skipped on.
     */
    protected array $except = [
        'daemon.configuration',
    ];

    /**
     * DaemonAuthenticate constructor.
     */
    public function __construct(private Encrypter $encrypter, private NodeRepository $repository)
    {
    }

    /**
     * Check if a request from the daemon can be properly attributed back to a single node instance.
     *
     * @throws \Symfony\Component\HttpKernel\Exception\HttpException
     */
    public function handle(Request $request, \Closure $next): mixed
    {
        if (in_array($request->route()->getName(), $this->except)) {
            return $next($request);
        }

        if (is_null($bearer = $request->bearerToken())) {
            throw new HttpException(401, 'Access to this endpoint must include an Authorization header.', null, ['WWW-Authenticate' => 'Bearer']);
        }

        $parts = explode('.', $bearer);
        // Ensure that all of the correct parts are provided in the header.
        if (count($parts) !== 2 || empty($parts[0]) || empty($parts[1])) {
            throw new BadRequestHttpException('The Authorization header provided was not in a valid format.');
        }

        try {
            /** @var \Jexactyl\Models\Node $node */
            $node = $this->repository->findFirstWhere([
                'daemon_token_id' => $parts[0],
            ]);

            if (hash_equals((string) $this->encrypter->decrypt($node->daemon_token), $parts[1])) {
                $request->attributes->set('node', $node);

                return $next($request);
            }
        } catch (RecordNotFoundException $exception) {
            // Do nothing, we don't want to expose a node not existing at all.
        }

        throw new AccessDeniedHttpException('You are not authorized to access this resource.');
    }
}
</file>

<file path="app/Http/Middleware/Api/AuthenticateIPAccess.php">
<?php

namespace Jexactyl\Http\Middleware\Api;

use IPTools\IP;
use IPTools\Range;
use Illuminate\Http\Request;
use Jexactyl\Facades\Activity;
use Laravel\Sanctum\TransientToken;
use Symfony\Component\HttpKernel\Exception\AccessDeniedHttpException;

class AuthenticateIPAccess
{
    /**
     * Determine if a request IP has permission to access the API.
     *
     * @throws \Exception
     * @throws \Symfony\Component\HttpKernel\Exception\AccessDeniedHttpException
     */
    public function handle(Request $request, \Closure $next): mixed
    {
        /** @var \Laravel\Sanctum\TransientToken|\Jexactyl\Models\ApiKey $token */
        $token = $request->user()->currentAccessToken();

        // If this is a stateful request just push the request through to the next
        // middleware in the stack, there is nothing we need to explicitly check. If
        // this is a valid API Key, but there is no allowed IP restriction, also pass
        // the request through.
        if ($token instanceof TransientToken || empty($token->allowed_ips)) {
            return $next($request);
        }

        $find = new IP($request->ip());
        foreach ($token->allowed_ips as $ip) {
            if (Range::parse($ip)->contains($find)) {
                return $next($request);
            }
        }

        Activity::event('auth:ip-blocked')
            ->actor($request->user())
            ->subject($request->user(), $token)
            ->property('identifier', $token->identifier)
            ->log();

        throw new AccessDeniedHttpException('This IP address (' . $request->ip() . ') does not have permission to access the API using these credentials.');
    }
}
</file>

<file path="app/Http/Middleware/Api/IsValidJson.php">
<?php

namespace Jexactyl\Http\Middleware\Api;

use Illuminate\Http\Request;
use Symfony\Component\HttpKernel\Exception\BadRequestHttpException;

class IsValidJson
{
    /**
     * Throw an exception if the request should be valid JSON data but there is an error while
     * parsing the data. This avoids confusing validation errors where every field is flagged and
     * it is not immediately clear that there is an issue with the JSON being passed.
     */
    public function handle(Request $request, \Closure $next): mixed
    {
        if ($request->isJson() && !empty($request->getContent())) {
            try {
                json_decode($request->getContent(), true, 512, JSON_THROW_ON_ERROR);
            } catch (\JsonException $exception) {
                throw new BadRequestHttpException('The JSON data passed in the request appears to be malformed: ' . $exception->getMessage());
            }
        }

        return $next($request);
    }
}
</file>

<file path="app/Http/Middleware/AdminAuthenticate.php">
<?php

namespace Jexactyl\Http\Middleware;

use Illuminate\Http\Request;
use Symfony\Component\HttpKernel\Exception\AccessDeniedHttpException;

class AdminAuthenticate
{
    /**
     * Handle an incoming request.
     *
     * @throws \Symfony\Component\HttpKernel\Exception\AccessDeniedHttpException
     */
    public function handle(Request $request, \Closure $next): mixed
    {
        if (!$request->user() || !$request->user()->root_admin) {
            throw new AccessDeniedHttpException();
        }

        return $next($request);
    }
}
</file>

<file path="app/Http/Middleware/EncryptCookies.php">
<?php

namespace Jexactyl\Http\Middleware;

use Illuminate\Cookie\Middleware\EncryptCookies as BaseEncrypter;

class EncryptCookies extends BaseEncrypter
{
    /**
     * The names of the cookies that should not be encrypted.
     */
    protected $except = [];
}
</file>

<file path="app/Http/Middleware/EnsureStatefulRequests.php">
<?php

namespace Jexactyl\Http\Middleware;

use Laravel\Sanctum\Http\Middleware\EnsureFrontendRequestsAreStateful;

class EnsureStatefulRequests extends EnsureFrontendRequestsAreStateful
{
    /**
     * Determines if a request is stateful or not. This is determined using the default
     * Sanctum "fromFrontend" helper method. However, we also check if the request includes
     * a cookie value for the Jexactyl session. If so, we assume this is a stateful
     * request.
     *
     * We don't want to support API usage using the cookies, except for requests stemming
     * from the front-end we control.
     */
    public static function fromFrontend($request)
    {
        if (parent::fromFrontend($request)) {
            return true;
        }

        return $request->hasCookie(config('session.cookie'));
    }
}
</file>

<file path="app/Http/Middleware/LanguageMiddleware.php">
<?php

namespace Jexactyl\Http\Middleware;

use Illuminate\Http\Request;
use Illuminate\Foundation\Application;

class LanguageMiddleware
{
    /**
     * LanguageMiddleware constructor.
     */
    public function __construct(private Application $app)
    {
    }

    /**
     * Handle an incoming request and set the user's preferred language.
     */
    public function handle(Request $request, \Closure $next): mixed
    {
        $this->app->setLocale($request->user()->language ?? config('app.locale', 'en'));

        return $next($request);
    }
}
</file>

<file path="app/Http/Middleware/MaintenanceMiddleware.php">
<?php

namespace Jexactyl\Http\Middleware;

use Illuminate\Http\Request;
use Illuminate\Contracts\Routing\ResponseFactory;

class MaintenanceMiddleware
{
    /**
     * MaintenanceMiddleware constructor.
     */
    public function __construct(private ResponseFactory $response)
    {
    }

    /**
     * Handle an incoming request.
     */
    public function handle(Request $request, \Closure $next): mixed
    {
        /** @var \Jexactyl\Models\Server $server */
        $server = $request->attributes->get('server');
        $node = $server->getRelation('node');

        if ($node->maintenance_mode) {
            return $this->response->view('errors.maintenance');
        }

        return $next($request);
    }
}
</file>

<file path="app/Http/Middleware/RedirectIfAuthenticated.php">
<?php

namespace Jexactyl\Http\Middleware;

use Illuminate\Http\Request;
use Illuminate\Auth\AuthManager;

class RedirectIfAuthenticated
{
    /**
     * RedirectIfAuthenticated constructor.
     */
    public function __construct(private AuthManager $authManager)
    {
    }

    /**
     * Handle an incoming request.
     */
    public function handle(Request $request, \Closure $next, string $guard = null): mixed
    {
        if ($this->authManager->guard($guard)->check()) {
            return redirect()->route('index');
        }

        return $next($request);
    }
}
</file>

<file path="app/Http/Middleware/RequireTwoFactorAuthentication.php">
<?php

namespace Jexactyl\Http\Middleware;

use Illuminate\Support\Str;
use Illuminate\Http\Request;
use Prologue\Alerts\AlertsMessageBag;
use Jexactyl\Exceptions\Http\TwoFactorAuthRequiredException;

class RequireTwoFactorAuthentication
{
    public const LEVEL_NONE = 0;
    public const LEVEL_ADMIN = 1;
    public const LEVEL_ALL = 2;

    /**
     * The route to redirect a user to enable 2FA.
     */
    protected string $redirectRoute = '/account';

    /**
     * RequireTwoFactorAuthentication constructor.
     */
    public function __construct(private AlertsMessageBag $alert)
    {
    }

    /**
     * Check the user state on the incoming request to determine if they should be allowed to
     * proceed or not. This checks if the Panel is configured to require 2FA on an account in
     * order to perform actions. If so, we check the level at which it is required (all users
     * or just admins) and then check if the user has enabled it for their account.
     *
     * @throws \Jexactyl\Exceptions\Http\TwoFactorAuthRequiredException
     */
    public function handle(Request $request, \Closure $next): mixed
    {
        /** @var \Jexactyl\Models\User $user */
        $user = $request->user();
        $uri = rtrim($request->getRequestUri(), '/') . '/';
        $current = $request->route()->getName();

        if (!$user || Str::startsWith($uri, ['/auth/']) || Str::startsWith($current, ['auth.', 'account.'])) {
            return $next($request);
        }

        $level = (int) config('jexactyl.auth.2fa_required');
        // If this setting is not configured, or the user is already using 2FA then we can just
        // send them right through, nothing else needs to be checked.
        //
        // If the level is set as admin and the user is not an admin, pass them through as well.
        if ($level === self::LEVEL_NONE || $user->use_totp) {
            return $next($request);
        } elseif ($level === self::LEVEL_ADMIN && !$user->root_admin) {
            return $next($request);
        }

        // For API calls return an exception which gets rendered nicely in the API response.
        if ($request->isJson() || Str::startsWith($uri, '/api/')) {
            throw new TwoFactorAuthRequiredException();
        }

        $this->alert->danger(trans('auth.2fa_must_be_enabled'))->flash();

        return redirect()->to($this->redirectRoute);
    }
}
</file>

<file path="app/Http/Middleware/TrimStrings.php">
<?php

namespace Jexactyl\Http\Middleware;

use Illuminate\Foundation\Http\Middleware\TrimStrings as BaseTrimmer;

class TrimStrings extends BaseTrimmer
{
    /**
     * The names of the attributes that should not be trimmed.
     */
    protected $except = [
        'password',
        'password_confirmation',
    ];
}
</file>

<file path="app/Http/Middleware/VerifyCsrfToken.php">
<?php

namespace Jexactyl\Http\Middleware;

use Illuminate\Foundation\Http\Middleware\VerifyCsrfToken as BaseVerifier;

class VerifyCsrfToken extends BaseVerifier
{
    /**
     * The URIs that should be excluded from CSRF verification. These are
     * never hit by the front-end, and require specific token validation
     * to work.
     */
    protected $except = ['remote/*', 'daemon/*', 'stripe/*'];
}
</file>

<file path="app/Http/Middleware/VerifyReCaptcha.php">
<?php

namespace Jexactyl\Http\Middleware;

use GuzzleHttp\Client;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Jexactyl\Events\Auth\FailedCaptcha;
use Illuminate\Contracts\Config\Repository;
use Illuminate\Contracts\Events\Dispatcher;
use Symfony\Component\HttpKernel\Exception\HttpException;

class VerifyReCaptcha
{
    /**
     * VerifyReCaptcha constructor.
     */
    public function __construct(private Dispatcher $dispatcher, private Repository $config)
    {
    }

    /**
     * Handle an incoming request.
     */
    public function handle(Request $request, \Closure $next): mixed
    {
        if (!$this->config->get('recaptcha.enabled')) {
            return $next($request);
        }

        if ($request->filled('g-recaptcha-response')) {
            $client = new Client();
            $res = $client->post($this->config->get('recaptcha.domain'), [
                'form_params' => [
                    'secret' => $this->config->get('recaptcha.secret_key'),
                    'response' => $request->input('g-recaptcha-response'),
                ],
            ]);

            if ($res->getStatusCode() === 200) {
                $result = json_decode($res->getBody());

                if ($result->success && (!$this->config->get('recaptcha.verify_domain') || $this->isResponseVerified($result, $request))) {
                    return $next($request);
                }
            }
        }

        $this->dispatcher->dispatch(
            new FailedCaptcha(
                $request->ip(),
                !empty($result) ? ($result->hostname ?? null) : null
            )
        );

        throw new HttpException(Response::HTTP_BAD_REQUEST, 'Failed to validate reCAPTCHA data.');
    }

    /**
     * Determine if the response from the recaptcha servers was valid.
     */
    private function isResponseVerified(\stdClass $result, Request $request): bool
    {
        if (!$this->config->get('recaptcha.verify_domain')) {
            return false;
        }

        $url = parse_url($request->url());

        return $result->hostname === array_get($url, 'host');
    }
}
</file>

<file path="app/Http/Requests/Admin/Api/StoreApplicationApiKeyRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Api;

use Jexactyl\Models\ApiKey;
use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class StoreApplicationApiKeyRequest extends AdminFormRequest
{
    /**
     * @throws \ReflectionException
     * @throws \ReflectionException
     */
    public function rules(): array
    {
        $modelRules = ApiKey::getRules();

        return collect(AdminAcl::getResourceList())->mapWithKeys(function ($resource) use ($modelRules) {
            return [AdminAcl::COLUMN_IDENTIFIER . $resource => $modelRules['r_' . $resource]];
        })->merge(['memo' => $modelRules['memo']])->toArray();
    }

    public function attributes(): array
    {
        return [
            'memo' => 'Description',
        ];
    }

    public function getKeyPermissions(): array
    {
        return collect($this->validated())->filter(function ($value, $key) {
            return substr($key, 0, strlen(AdminAcl::COLUMN_IDENTIFIER)) === AdminAcl::COLUMN_IDENTIFIER;
        })->toArray();
    }
}
</file>

<file path="app/Http/Requests/Admin/Egg/EggFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Egg;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class EggFormRequest extends AdminFormRequest
{
    public function rules(): array
    {
        $rules = [
            'name' => 'required|string|max:191',
            'description' => 'nullable|string',
            'docker_images' => 'required|string',
            'force_outgoing_ip' => 'sometimes|boolean',
            'file_denylist' => 'array',
            'startup' => 'required|string',
            'config_from' => 'sometimes|bail|nullable|numeric',
            'config_stop' => 'required_without:config_from|nullable|string|max:191',
            'config_startup' => 'required_without:config_from|nullable|json',
            'config_logs' => 'required_without:config_from|nullable|json',
            'config_files' => 'required_without:config_from|nullable|json',
        ];

        if ($this->method() === 'POST') {
            $rules['nest_id'] = 'required|numeric|exists:nests,id';
        }

        return $rules;
    }

    public function withValidator($validator)
    {
        $validator->sometimes('config_from', 'exists:eggs,id', function () {
            return (int) $this->input('config_from') !== 0;
        });
    }

    public function validated($key = null, $default = null): array
    {
        $data = parent::validated();

        return array_merge($data, [
            'force_outgoing_ip' => array_get($data, 'force_outgoing_ip', false),
        ]);
    }
}
</file>

<file path="app/Http/Requests/Admin/Egg/EggImportFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Egg;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class EggImportFormRequest extends AdminFormRequest
{
    public function rules(): array
    {
        $rules = [
            'import_file' => 'bail|required|file|max:1000|mimetypes:application/json,text/plain',
        ];

        if ($this->method() !== 'PUT') {
            $rules['import_to_nest'] = 'bail|required|integer|exists:nests,id';
        }

        return $rules;
    }
}
</file>

<file path="app/Http/Requests/Admin/Egg/EggScriptFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Egg;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class EggScriptFormRequest extends AdminFormRequest
{
    /**
     * Return the rules to be used when validating the data sent in the request.
     */
    public function rules(): array
    {
        return [
            'script_install' => 'sometimes|nullable|string',
            'script_is_privileged' => 'sometimes|required|boolean',
            'script_entry' => 'sometimes|required|string',
            'script_container' => 'sometimes|required|string',
            'copy_script_from' => 'sometimes|nullable|numeric',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Egg/EggVariableFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Egg;

use Jexactyl\Models\EggVariable;
use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class EggVariableFormRequest extends AdminFormRequest
{
    /**
     * Define rules for validation of this request.
     */
    public function rules(): array
    {
        return [
            'name' => 'required|string|min:1|max:191',
            'description' => 'sometimes|nullable|string',
            'env_variable' => 'required|regex:/^[\w]{1,191}$/|notIn:' . EggVariable::RESERVED_ENV_NAMES,
            'options' => 'sometimes|required|array',
            'rules' => 'bail|required|string',
            'default_value' => 'present',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Jexactyl/Coupons/IndexFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Jexactyl\Coupons;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class IndexFormRequest extends AdminFormRequest
{
    public function rules(): array
    {
        return [
            'enabled' => 'required|boolean',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Jexactyl/Coupons/StoreFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Jexactyl\Coupons;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class StoreFormRequest extends AdminFormRequest
{
    public function rules(): array
    {
        return [
            'code' => 'required|string',
            'uses' => 'required|integer',
            'credits' => 'required|integer',
            'expires' => 'nullable|integer',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Jexactyl/AdvancedFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Jexactyl;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class AdvancedFormRequest extends AdminFormRequest
{
    /**
     * Return all the rules to apply to this request's data.
     */
    public function rules(): array
    {
        return [
            'jexactyl:auth:2fa_required' => 'required|integer|in:0,1,2',

            'recaptcha:enabled' => 'required|in:true,false',
            'recaptcha:secret_key' => 'required|string|max:191',
            'recaptcha:website_key' => 'required|string|max:191',
            'jexactyl:guzzle:timeout' => 'required|integer|between:1,60',
            'jexactyl:guzzle:connect_timeout' => 'required|integer|between:1,60',

            'jexactyl:client_features:allocations:enabled' => 'required|in:true,false',
            'jexactyl:client_features:allocations:range_start' => [
                'nullable',
                'required_if:jexactyl:client_features:allocations:enabled,true',
                'integer',
                'between:1024,65535',
            ],
            'jexactyl:client_features:allocations:range_end' => [
                'nullable',
                'required_if:jexactyl:client_features:allocations:enabled,true',
                'integer',
                'between:1024,65535',
                'gt:jexactyl:client_features:allocations:range_start',
            ],
        ];
    }

    public function attributes(): array
    {
        return [
            'recaptcha:enabled' => 'reCAPTCHA Enabled',
            'recaptcha:secret_key' => 'reCAPTCHA Secret Key',
            'recaptcha:website_key' => 'reCAPTCHA Website Key',
            'jexactyl:guzzle:timeout' => 'HTTP Request Timeout',
            'jexactyl:guzzle:connect_timeout' => 'HTTP Connection Timeout',
            'jexactyl:client_features:allocations:enabled' => 'Auto Create Allocations Enabled',
            'jexactyl:client_features:allocations:range_start' => 'Starting Port',
            'jexactyl:client_features:allocations:range_end' => 'Ending Port',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Jexactyl/AlertFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Jexactyl;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class AlertFormRequest extends AdminFormRequest
{
    public function rules(): array
    {
        return [
            'alert:message' => 'required|string|min:3|max:191',
            'alert:type' => 'required|in:success,info,warning,danger',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Jexactyl/AppearanceFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Jexactyl;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class AppearanceFormRequest extends AdminFormRequest
{
    public function rules(): array
    {
        return [
            'app:name' => 'required|string|max:191',
            'app:logo' => 'required|string|max:191',
            'theme:user:background' => 'nullable|url',
            'theme:admin' => 'required|string|in:jexactyl,dark,light,blue,minecraft',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Jexactyl/ApprovalFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Jexactyl;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class ApprovalFormRequest extends AdminFormRequest
{
    public function rules(): array
    {
        return [
            'enabled' => 'required|in:true,false',
            'webhook' => 'nullable|active_url',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Jexactyl/MailFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Jexactyl;

use Illuminate\Validation\Rule;
use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class MailFormRequest extends AdminFormRequest
{
    /**
     * Return rules to validate mail settings POST data against.
     */
    public function rules(): array
    {
        return [
            'mail:mailers:smtp:host' => 'required|string',
            'mail:mailers:smtp:port' => 'required|integer|between:1,65535',
            'mail:mailers:smtp:encryption' => ['present', Rule::in([null, 'tls', 'ssl'])],
            'mail:mailers:smtp:username' => 'nullable|string|max:191',
            'mail:mailers:smtp:password' => 'nullable|string|max:191',
            'mail:from:address' => 'required|string|email',
            'mail:from:name' => 'nullable|string|max:191',
        ];
    }

    /**
     * Override the default normalization function for this type of request
     * as we need to accept empty values on the keys.
     */
    public function normalize(array $only = null): array
    {
        $keys = array_flip(array_keys($this->rules()));

        if (empty($this->input('mail:mailers:smtp:password'))) {
            unset($keys['mail:mailers:smtp:password']);
        }

        return $this->only(array_flip($keys));
    }
}
</file>

<file path="app/Http/Requests/Admin/Jexactyl/ReferralsFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Jexactyl;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class ReferralsFormRequest extends AdminFormRequest
{
    public function rules(): array
    {
        return [
            'enabled' => 'required|in:true,false',
            'reward' => 'required|min:0',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Jexactyl/RegistrationFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Jexactyl;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class RegistrationFormRequest extends AdminFormRequest
{
    public function rules(): array
    {
        return [
            'registration:enabled' => 'required|in:true,false',
            'registration:verification' => 'required|in:true,false',
            'discord:enabled' => 'required|in:true,false',
            'discord:id' => 'required|int',
            'discord:secret' => 'required|string',

            'registration:cpu' => 'required|int',
            'registration:memory' => 'required|int',
            'registration:disk' => 'required|int',
            'registration:slot' => 'required|int',
            'registration:port' => 'required|int',
            'registration:backup' => 'required|int',
            'registration:database' => 'required|int',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Jexactyl/ServerFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Jexactyl;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class ServerFormRequest extends AdminFormRequest
{
    public function rules(): array
    {
        return [
            'enabled' => 'required|in:true,false',
            'default' => 'required|int|min:1',
            'cost' => 'required|int|min:0',
            'editing' => 'required|in:true,false',
            'deletion' => 'required|in:true,false',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Jexactyl/StoreFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Jexactyl;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class StoreFormRequest extends AdminFormRequest
{
    public function rules(): array
    {
        return [
            'store:enabled' => 'required|in:true,false',
            'store:paypal:enabled' => 'required|in:true,false',
            'store:stripe:enabled' => 'required|in:true,false',
            'store:currency' => 'required|min:1|max:10',

            'earn:enabled' => 'required|in:true,false',
            'earn:amount' => 'required|numeric|min:0',

            'store:cost:cpu' => 'required|int|min:1',
            'store:cost:memory' => 'required|int|min:1',
            'store:cost:disk' => 'required|int|min:1',
            'store:cost:slot' => 'required|int|min:1',
            'store:cost:port' => 'required|int|min:1',
            'store:cost:backup' => 'required|int|min:1',
            'store:cost:database' => 'required|int|min:1',

            'store:limit:cpu' => 'required|int|min:1',
            'store:limit:memory' => 'required|int|min:1',
            'store:limit:disk' => 'required|int|min:1',
            'store:limit:port' => 'required|int|min:1',
            'store:limit:backup' => 'required|int|min:1',
            'store:limit:database' => 'required|int|min:1',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Nest/StoreNestFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Nest;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class StoreNestFormRequest extends AdminFormRequest
{
    public function rules(): array
    {
        return [
            'name' => 'required|string|min:1|max:191',
            'description' => 'string|nullable',
            'private' => 'required|in:0,1',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Node/AllocationAliasFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Node;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class AllocationAliasFormRequest extends AdminFormRequest
{
    public function rules(): array
    {
        return [
            'alias' => 'present|nullable|string',
            'allocation_id' => 'required|numeric|exists:allocations,id',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Node/AllocationFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Node;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class AllocationFormRequest extends AdminFormRequest
{
    public function rules(): array
    {
        return [
            'allocation_ip' => 'required|string',
            'allocation_alias' => 'sometimes|nullable|string|max:191',
            'allocation_ports' => 'required|array',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Node/NodeFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Node;

use Jexactyl\Rules\Fqdn;
use Jexactyl\Models\Node;
use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class NodeFormRequest extends AdminFormRequest
{
    /**
     * Get rules to apply to data in this request.
     */
    public function rules(): array
    {
        if ($this->method() === 'PATCH') {
            return Node::getRulesForUpdate($this->route()->parameter('node'));
        }

        $data = Node::getRules();
        $data['fqdn'][] = Fqdn::make('scheme');

        return $data;
    }
}
</file>

<file path="app/Http/Requests/Admin/Servers/Databases/StoreServerDatabaseRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Servers\Databases;

use Illuminate\Validation\Rule;
use Illuminate\Database\Query\Builder;
use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class StoreServerDatabaseRequest extends AdminFormRequest
{
    /**
     * Validation rules for database creation.
     */
    public function rules(): array
    {
        return [
            'database' => [
                'required',
                'string',
                'min:1',
                'max:24',
                Rule::unique('databases')->where(function (Builder $query) {
                    $query->where('database_host_id', $this->input('database_host_id') ?? 0);
                }),
            ],
            'max_connections' => 'nullable',
            'remote' => 'required|string|regex:/^[0-9%.]{1,15}$/',
            'database_host_id' => 'required|integer|exists:database_hosts,id',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Tickets/TicketMessageRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Tickets;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class TicketMessageRequest extends AdminFormRequest
{
    /**
     * Rules to apply to requests for updating the status
     * of a ticket in the admin control panel.
     */
    public function rules(): array
    {
        return [
            'content' => 'required|min:3|max:191',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Tickets/TicketStatusRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Tickets;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class TicketStatusRequest extends AdminFormRequest
{
    /**
     * Rules to apply to requests for updating the status
     * of a ticket in the admin control panel.
     */
    public function rules(): array
    {
        return [
            'status' => 'required|in:resolved,unresolved,pending,in-progress',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Tickets/TicketToggleRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Tickets;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class TicketToggleRequest extends AdminFormRequest
{
    /**
     * Rules to apply to requests for updating the status
     * of a ticket in the admin control panel.
     */
    public function rules(): array
    {
        return [
            'enabled' => 'required|in:true,false',
            'max' => 'required|min:0|max:10',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Users/ResourceFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Users;

use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class ResourceFormRequest extends AdminFormRequest
{
    /**
     * Rules to apply to requests for updating a users
     * storefront balances via the admin panel.
     */
    public function rules(): array
    {
        return [
            'store_balance' => 'required|int',
            'store_cpu' => 'required|int',
            'store_memory' => 'required|int',
            'store_disk' => 'required|int',
            'store_slots' => 'required|int',
            'store_ports' => 'required|int',
            'store_backups' => 'required|int',
            'store_databases' => 'required|int',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/Users/UserFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin\Users;

use Jexactyl\Models\User;
use Illuminate\Support\Collection;
use Jexactyl\Http\Requests\Admin\AdminFormRequest;

class UserFormRequest extends AdminFormRequest
{
    /**
     * Rules to apply to requests for updating or creating a user
     * in the Admin CP.
     */
    public function rules(): array
    {
        return Collection::make(
            User::getRulesForUpdate($this->route()->parameter('user'))
        )->only([
            'email',
            'username',
            'name_first',
            'name_last',
            'password',
            'language',
            'root_admin',
        ])->toArray();
    }
}
</file>

<file path="app/Http/Requests/Admin/AdminFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin;

use Illuminate\Foundation\Http\FormRequest;

abstract class AdminFormRequest extends FormRequest
{
    /**
     * The rules to apply to the incoming form request.
     */
    abstract public function rules(): array;

    /**
     * Determine if the user is an admin and has permission to access this
     * form controller in the first place.
     */
    public function authorize(): bool
    {
        if (is_null($this->user())) {
            return false;
        }

        return (bool) $this->user()->root_admin;
    }

    /**
     * Return only the fields that we are interested in from the request.
     * This will include empty fields as a null value.
     */
    public function normalize(array $only = null): array
    {
        return $this->only($only ?? array_keys($this->rules()));
    }
}
</file>

<file path="app/Http/Requests/Admin/BaseFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin;

class BaseFormRequest extends AdminFormRequest
{
    public function rules(): array
    {
        return [
            'company' => 'required|between:1,256',
        ];
    }
}
</file>

<file path="app/Http/Requests/Admin/DatabaseHostFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin;

use Jexactyl\Models\DatabaseHost;
use Illuminate\Contracts\Validation\Validator;

class DatabaseHostFormRequest extends AdminFormRequest
{
    public function rules(): array
    {
        if ($this->method() !== 'POST') {
            return DatabaseHost::getRulesForUpdate($this->route()->parameter('host'));
        }

        return DatabaseHost::getRules();
    }

    /**
     * Modify submitted data before it is passed off to the validator.
     */
    protected function getValidatorInstance(): Validator
    {
        if (!$this->filled('node_id')) {
            $this->merge(['node_id' => null]);
        }

        return parent::getValidatorInstance();
    }
}
</file>

<file path="app/Http/Requests/Admin/LocationFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin;

use Jexactyl\Models\Location;

class LocationFormRequest extends AdminFormRequest
{
    /**
     * Set up the validation rules to use for these requests.
     */
    public function rules(): array
    {
        if ($this->method() === 'PATCH') {
            return Location::getRulesForUpdate($this->route()->parameter('location')->id);
        }

        return Location::getRules();
    }
}
</file>

<file path="app/Http/Requests/Admin/MountFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin;

use Jexactyl\Models\Mount;

class MountFormRequest extends AdminFormRequest
{
    /**
     * Set up the validation rules to use for these requests.
     */
    public function rules(): array
    {
        if ($this->method() === 'PATCH') {
            return Mount::getRulesForUpdate($this->route()->parameter('mount')->id);
        }

        return Mount::getRules();
    }
}
</file>

<file path="app/Http/Requests/Admin/NewUserFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin;

use Jexactyl\Models\User;
use Illuminate\Support\Collection;

class NewUserFormRequest extends AdminFormRequest
{
    /**
     * Rules to apply to requests for updating or creating a user
     * in the Admin CP.
     */
    public function rules(): array
    {
        return Collection::make(
            User::getRules()
        )->only([
            'email',
            'username',
            'name_first',
            'name_last',
            'password',
            'language',
            'root_admin',
        ])->toArray();
    }
}
</file>

<file path="app/Http/Requests/Admin/ServerFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Admin;

use Jexactyl\Models\Server;
use Illuminate\Validation\Rule;
use Illuminate\Validation\Validator;

class ServerFormRequest extends AdminFormRequest
{
    /**
     * Rules to be applied to this request.
     */
    public function rules(): array
    {
        $rules = Server::getRules();
        $rules['description'][] = 'nullable';
        $rules['custom_image'] = 'sometimes|nullable|string';

        return $rules;
    }

    /**
     * Run validation after the rules above have been applied.
     */
    public function withValidator(Validator $validator): void
    {
        $validator->after(function ($validator) {
            $validator->sometimes('node_id', 'required|numeric|bail|exists:nodes,id', function ($input) {
                return !$input->auto_deploy;
            });

            $validator->sometimes('allocation_id', [
                'required',
                'numeric',
                'bail',
                Rule::exists('allocations', 'id')->where(function ($query) {
                    $query->where('node_id', $this->input('node_id'));
                    $query->whereNull('server_id');
                }),
            ], function ($input) {
                return !$input->auto_deploy;
            });

            $validator->sometimes('allocation_additional.*', [
                'sometimes',
                'required',
                'numeric',
                Rule::exists('allocations', 'id')->where(function ($query) {
                    $query->where('node_id', $this->input('node_id'));
                    $query->whereNull('server_id');
                }),
            ], function ($input) {
                return !$input->auto_deploy;
            });
        });
    }
}
</file>

<file path="app/Http/Requests/Api/Application/Allocations/DeleteAllocationRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Allocations;

use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class DeleteAllocationRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_ALLOCATIONS;

    protected int $permission = AdminAcl::WRITE;
}
</file>

<file path="app/Http/Requests/Api/Application/Allocations/GetAllocationsRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Allocations;

use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class GetAllocationsRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_ALLOCATIONS;

    protected int $permission = AdminAcl::READ;
}
</file>

<file path="app/Http/Requests/Api/Application/Allocations/StoreAllocationRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Allocations;

use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class StoreAllocationRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_ALLOCATIONS;

    protected int $permission = AdminAcl::WRITE;

    public function rules(): array
    {
        return [
            'ip' => 'required|string',
            'alias' => 'sometimes|nullable|string|max:191',
            'ports' => 'required|array',
            'ports.*' => 'string',
        ];
    }

    public function validated($key = null, $default = null): array
    {
        $data = parent::validated();

        return [
            'allocation_ip' => $data['ip'],
            'allocation_ports' => $data['ports'],
            'allocation_alias' => $data['alias'] ?? null,
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Application/Locations/DeleteLocationRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Locations;

use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class DeleteLocationRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_LOCATIONS;

    protected int $permission = AdminAcl::WRITE;
}
</file>

<file path="app/Http/Requests/Api/Application/Locations/GetLocationRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Locations;

class GetLocationRequest extends GetLocationsRequest
{
}
</file>

<file path="app/Http/Requests/Api/Application/Locations/GetLocationsRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Locations;

use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class GetLocationsRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_LOCATIONS;

    protected int $permission = AdminAcl::READ;
}
</file>

<file path="app/Http/Requests/Api/Application/Locations/StoreLocationRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Locations;

use Jexactyl\Models\Location;
use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class StoreLocationRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_LOCATIONS;

    protected int $permission = AdminAcl::WRITE;

    /**
     * Rules to validate the request against.
     */
    public function rules(): array
    {
        return collect(Location::getRules())->only([
            'long',
            'short',
        ])->toArray();
    }

    /**
     * Rename fields to be more clear in error messages.
     */
    public function attributes(): array
    {
        return [
            'long' => 'Location Description',
            'short' => 'Location Identifier',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Application/Locations/UpdateLocationRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Locations;

use Jexactyl\Models\Location;

class UpdateLocationRequest extends StoreLocationRequest
{
    /**
     * Rules to validate this request against.
     */
    public function rules(): array
    {
        $locationId = $this->route()->parameter('location')->id;

        return collect(Location::getRulesForUpdate($locationId))->only([
            'short',
            'long',
        ])->toArray();
    }
}
</file>

<file path="app/Http/Requests/Api/Application/Nests/Eggs/GetEggRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Nests\Eggs;

use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class GetEggRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_EGGS;

    protected int $permission = AdminAcl::READ;
}
</file>

<file path="app/Http/Requests/Api/Application/Nests/Eggs/GetEggsRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Nests\Eggs;

use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class GetEggsRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_EGGS;

    protected int $permission = AdminAcl::READ;
}
</file>

<file path="app/Http/Requests/Api/Application/Nests/GetNestsRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Nests;

use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class GetNestsRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_NESTS;

    protected int $permission = AdminAcl::READ;
}
</file>

<file path="app/Http/Requests/Api/Application/Nodes/DeleteNodeRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Nodes;

use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class DeleteNodeRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_NODES;

    protected int $permission = AdminAcl::WRITE;
}
</file>

<file path="app/Http/Requests/Api/Application/Nodes/GetDeployableNodesRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Nodes;

class GetDeployableNodesRequest extends GetNodesRequest
{
    public function rules(): array
    {
        return [
            'page' => 'integer',
            'memory' => 'required|integer|min:0',
            'disk' => 'required|integer|min:0',
            'location_ids' => 'array',
            'location_ids.*' => 'integer',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Application/Nodes/GetNodeRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Nodes;

class GetNodeRequest extends GetNodesRequest
{
}
</file>

<file path="app/Http/Requests/Api/Application/Nodes/GetNodesRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Nodes;

use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class GetNodesRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_NODES;

    protected int $permission = AdminAcl::READ;
}
</file>

<file path="app/Http/Requests/Api/Application/Nodes/StoreNodeRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Nodes;

use Jexactyl\Models\Node;
use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class StoreNodeRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_NODES;

    protected int $permission = AdminAcl::WRITE;

    /**
     * Validation rules to apply to this request.
     */
    public function rules(array $rules = null): array
    {
        return collect($rules ?? Node::getRules())->only([
            'public',
            'name',
            'location_id',
            'fqdn',
            'scheme',
            'behind_proxy',
            'maintenance_mode',
            'memory',
            'memory_overallocate',
            'disk',
            'disk_overallocate',
            'deploy_fee',
            'upload_size',
            'daemonListen',
            'daemonSFTP',
            'daemonBase',
        ])->mapWithKeys(function ($value, $key) {
            $key = ($key === 'daemonSFTP') ? 'daemonSftp' : $key;

            return [snake_case($key) => $value];
        })->toArray();
    }

    /**
     * Fields to rename for clarity in the API response.
     */
    public function attributes(): array
    {
        return [
            'daemon_base' => 'Daemon Base Path',
            'upload_size' => 'File Upload Size Limit',
            'location_id' => 'Location',
            'public' => 'Node Visibility',
        ];
    }

    /**
     * Change the formatting of some data keys in the validated response data
     * to match what the application expects in the services.
     */
    public function validated($key = null, $default = null): array
    {
        $response = parent::validated();
        $response['daemonListen'] = $response['daemon_listen'];
        $response['daemonSFTP'] = $response['daemon_sftp'];
        $response['daemonBase'] = $response['daemon_base'] ?? (new Node())->getAttribute('daemonBase');

        unset($response['daemon_base'], $response['daemon_listen'], $response['daemon_sftp']);

        return $response;
    }
}
</file>

<file path="app/Http/Requests/Api/Application/Nodes/UpdateNodeRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Nodes;

use Jexactyl\Models\Node;

class UpdateNodeRequest extends StoreNodeRequest
{
    /**
     * Apply validation rules to this request. Uses the parent class rules()
     * function but passes in the rules for updating rather than creating.
     */
    public function rules(array $rules = null): array
    {
        $node = $this->route()->parameter('node')->id;

        return parent::rules(Node::getRulesForUpdate($node));
    }
}
</file>

<file path="app/Http/Requests/Api/Application/Servers/Databases/GetServerDatabaseRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Servers\Databases;

use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class GetServerDatabaseRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_SERVER_DATABASES;

    protected int $permission = AdminAcl::READ;
}
</file>

<file path="app/Http/Requests/Api/Application/Servers/Databases/GetServerDatabasesRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Servers\Databases;

use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class GetServerDatabasesRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_SERVER_DATABASES;

    protected int $permission = AdminAcl::READ;
}
</file>

<file path="app/Http/Requests/Api/Application/Servers/Databases/ServerDatabaseWriteRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Servers\Databases;

use Jexactyl\Services\Acl\Api\AdminAcl;

class ServerDatabaseWriteRequest extends GetServerDatabasesRequest
{
    protected int $permission = AdminAcl::WRITE;
}
</file>

<file path="app/Http/Requests/Api/Application/Servers/Databases/StoreServerDatabaseRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Servers\Databases;

use Jexactyl\Models\Server;
use Webmozart\Assert\Assert;
use Illuminate\Validation\Rule;
use Illuminate\Database\Query\Builder;
use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Services\Databases\DatabaseManagementService;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class StoreServerDatabaseRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_SERVER_DATABASES;

    protected int $permission = AdminAcl::WRITE;

    /**
     * Validation rules for database creation.
     */
    public function rules(): array
    {
        $server = $this->route()->parameter('server');

        return [
            'database' => [
                'required',
                'alpha_dash',
                'min:1',
                'max:48',
                Rule::unique('databases')->where(function (Builder $query) use ($server) {
                    $query->where('server_id', $server->id)->where('database', $this->databaseName());
                }),
            ],
            'remote' => 'required|string|regex:/^[0-9%.]{1,15}$/',
            'host' => 'required|integer|exists:database_hosts,id',
        ];
    }

    /**
     * Return data formatted in the correct format for the service to consume.
     */
    public function validated($key = null, $default = null): array
    {
        return [
            'database' => $this->input('database'),
            'remote' => $this->input('remote'),
            'database_host_id' => $this->input('host'),
        ];
    }

    /**
     * Format error messages in a more understandable format for API output.
     */
    public function attributes(): array
    {
        return [
            'host' => 'Database Host Server ID',
            'remote' => 'Remote Connection String',
            'database' => 'Database Name',
        ];
    }

    /**
     * Returns the database name in the expected format.
     */
    public function databaseName(): string
    {
        $server = $this->route()->parameter('server');

        Assert::isInstanceOf($server, Server::class);

        return DatabaseManagementService::generateUniqueDatabaseName($this->input('database'), $server->id);
    }
}
</file>

<file path="app/Http/Requests/Api/Application/Servers/GetExternalServerRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Servers;

use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class GetExternalServerRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_SERVERS;

    protected int $permission = AdminAcl::READ;
}
</file>

<file path="app/Http/Requests/Api/Application/Servers/GetServerRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Servers;

use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class GetServerRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_SERVERS;

    protected int $permission = AdminAcl::READ;
}
</file>

<file path="app/Http/Requests/Api/Application/Servers/GetServersRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Servers;

class GetServersRequest extends GetServerRequest
{
    public function rules(): array
    {
        return [
            'search' => 'string|max:100',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Application/Servers/ServerWriteRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Servers;

use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class ServerWriteRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_SERVERS;

    protected int $permission = AdminAcl::WRITE;
}
</file>

<file path="app/Http/Requests/Api/Application/Servers/StoreServerRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Servers;

use Jexactyl\Models\Server;
use Illuminate\Validation\Rule;
use Illuminate\Validation\Validator;
use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Models\Objects\DeploymentObject;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class StoreServerRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_SERVERS;

    protected int $permission = AdminAcl::WRITE;

    /**
     * Rules to be applied to this request.
     */
    public function rules(): array
    {
        $rules = Server::getRules();

        return [
            'external_id' => $rules['external_id'],
            'name' => $rules['name'],
            'description' => array_merge(['nullable'], $rules['description']),
            'user' => $rules['owner_id'],
            'egg' => $rules['egg_id'],
            'docker_image' => $rules['image'],
            'startup' => $rules['startup'],
            'environment' => 'present|array',
            'skip_scripts' => 'sometimes|boolean',
            'oom_disabled' => 'sometimes|boolean',

            // Resource limitations
            'limits' => 'required|array',
            'limits.memory' => $rules['memory'],
            'limits.swap' => $rules['swap'],
            'limits.disk' => $rules['disk'],
            'limits.io' => $rules['io'],
            'limits.threads' => $rules['threads'],
            'limits.cpu' => $rules['cpu'],

            // Application Resource Limits
            'feature_limits' => 'required|array',
            'feature_limits.databases' => $rules['database_limit'],
            'feature_limits.allocations' => $rules['allocation_limit'],
            'feature_limits.backups' => $rules['backup_limit'],

            // Placeholders for rules added in withValidator() function.
            'allocation.default' => '',
            'allocation.additional.*' => '',

            // Automatic deployment rules
            'deploy' => 'sometimes|required|array',
            'deploy.locations' => 'array',
            'deploy.locations.*' => 'integer|min:1',
            'deploy.dedicated_ip' => 'required_with:deploy,boolean',
            'deploy.port_range' => 'array',
            'deploy.port_range.*' => 'string',

            'start_on_completion' => 'sometimes|boolean',
        ];
    }

    /**
     * Normalize the data into a format that can be consumed by the service.
     */
    public function validated($key = null, $default = null): array
    {
        $data = parent::validated();

        return [
            'external_id' => array_get($data, 'external_id'),
            'name' => array_get($data, 'name'),
            'description' => array_get($data, 'description'),
            'owner_id' => array_get($data, 'user'),
            'egg_id' => array_get($data, 'egg'),
            'image' => array_get($data, 'docker_image'),
            'startup' => array_get($data, 'startup'),
            'environment' => array_get($data, 'environment'),
            'memory' => array_get($data, 'limits.memory'),
            'swap' => array_get($data, 'limits.swap'),
            'disk' => array_get($data, 'limits.disk'),
            'io' => array_get($data, 'limits.io'),
            'cpu' => array_get($data, 'limits.cpu'),
            'threads' => array_get($data, 'limits.threads'),
            'skip_scripts' => array_get($data, 'skip_scripts', false),
            'allocation_id' => array_get($data, 'allocation.default'),
            'allocation_additional' => array_get($data, 'allocation.additional'),
            'start_on_completion' => array_get($data, 'start_on_completion', false),
            'database_limit' => array_get($data, 'feature_limits.databases'),
            'allocation_limit' => array_get($data, 'feature_limits.allocations'),
            'backup_limit' => array_get($data, 'feature_limits.backups'),
            'oom_disabled' => array_get($data, 'oom_disabled'),
        ];
    }

    /*
     * Run validation after the rules above have been applied.
     *
     * @param \Illuminate\Validation\Validator $validator
     */
    public function withValidator(Validator $validator): void
    {
        $validator->sometimes('allocation.default', [
            'required', 'integer', 'bail',
            Rule::exists('allocations', 'id')->where(function ($query) {
                $query->whereNull('server_id');
            }),
        ], function ($input) {
            return !$input->deploy;
        });

        $validator->sometimes('allocation.additional.*', [
            'integer',
            Rule::exists('allocations', 'id')->where(function ($query) {
                $query->whereNull('server_id');
            }),
        ], function ($input) {
            return !$input->deploy;
        });

        $validator->sometimes('deploy.locations', 'present', function ($input) {
            return $input->deploy;
        });

        $validator->sometimes('deploy.port_range', 'present', function ($input) {
            return $input->deploy;
        });
    }

    /**
     * Return a deployment object that can be passed to the server creation service.
     */
    public function getDeploymentObject(): ?DeploymentObject
    {
        if (is_null($this->input('deploy'))) {
            return null;
        }

        $object = new DeploymentObject();
        $object->setDedicated($this->input('deploy.dedicated_ip', false));
        $object->setLocations($this->input('deploy.locations', []));
        $object->setPorts($this->input('deploy.port_range', []));

        return $object;
    }
}
</file>

<file path="app/Http/Requests/Api/Application/Servers/UpdateServerBuildConfigurationRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Servers;

use Jexactyl\Models\Server;
use Illuminate\Support\Collection;

class UpdateServerBuildConfigurationRequest extends ServerWriteRequest
{
    /**
     * Return the rules to validate this request against.
     */
    public function rules(): array
    {
        $rules = Server::getRulesForUpdate($this->parameter('server', Server::class));

        return [
            'allocation' => $rules['allocation_id'],
            'oom_disabled' => $rules['oom_disabled'],

            'limits' => 'sometimes|array',
            'limits.memory' => $this->requiredToOptional('memory', $rules['memory'], true),
            'limits.swap' => $this->requiredToOptional('swap', $rules['swap'], true),
            'limits.io' => $this->requiredToOptional('io', $rules['io'], true),
            'limits.cpu' => $this->requiredToOptional('cpu', $rules['cpu'], true),
            'limits.threads' => $this->requiredToOptional('threads', $rules['threads'], true),
            'limits.disk' => $this->requiredToOptional('disk', $rules['disk'], true),

            // Legacy rules to maintain backwards compatable API support without requiring
            // a major version bump.
            //
            // @see https://github.com/pterodactyl/panel/issues/1500
            'memory' => $this->requiredToOptional('memory', $rules['memory']),
            'swap' => $this->requiredToOptional('swap', $rules['swap']),
            'io' => $this->requiredToOptional('io', $rules['io']),
            'cpu' => $this->requiredToOptional('cpu', $rules['cpu']),
            'threads' => $this->requiredToOptional('threads', $rules['threads']),
            'disk' => $this->requiredToOptional('disk', $rules['disk']),

            'add_allocations' => 'bail|array',
            'add_allocations.*' => 'integer',
            'remove_allocations' => 'bail|array',
            'remove_allocations.*' => 'integer',

            'feature_limits' => 'required|array',
            'feature_limits.databases' => $rules['database_limit'],
            'feature_limits.allocations' => $rules['allocation_limit'],
            'feature_limits.backups' => $rules['backup_limit'],
        ];
    }

    /**
     * Convert the allocation field into the expected format for the service handler.
     */
    public function validated($key = null, $default = null): array
    {
        $data = parent::validated();

        $data['allocation_id'] = $data['allocation'];
        $data['database_limit'] = $data['feature_limits']['databases'] ?? null;
        $data['allocation_limit'] = $data['feature_limits']['allocations'] ?? null;
        $data['backup_limit'] = $data['feature_limits']['backups'] ?? null;
        unset($data['allocation'], $data['feature_limits']);

        // Adjust the limits field to match what is expected by the model.
        if (!empty($data['limits'])) {
            foreach ($data['limits'] as $key => $value) {
                $data[$key] = $value;
            }

            unset($data['limits']);
        }

        return $data;
    }

    /**
     * Custom attributes to use in error message responses.
     */
    public function attributes(): array
    {
        return [
            'add_allocations' => 'allocations to add',
            'remove_allocations' => 'allocations to remove',
            'add_allocations.*' => 'allocation to add',
            'remove_allocations.*' => 'allocation to remove',
            'feature_limits.databases' => 'Database Limit',
            'feature_limits.allocations' => 'Allocation Limit',
            'feature_limits.backups' => 'Backup Limit',
        ];
    }

    /**
     * Converts existing rules for certain limits into a format that maintains backwards
     * compatability with the old API endpoint while also supporting a more correct API
     * call.
     *
     * @see https://github.com/pterodactyl/panel/issues/1500
     */
    protected function requiredToOptional(string $field, array $rules, bool $limits = false): array
    {
        if (!in_array('required', $rules)) {
            return $rules;
        }

        return (new Collection($rules))
            ->filter(function ($value) {
                return $value !== 'required';
            })
            ->prepend($limits ? 'required_with:limits' : 'required_without:limits')
            ->toArray();
    }
}
</file>

<file path="app/Http/Requests/Api/Application/Servers/UpdateServerDetailsRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Servers;

use Jexactyl\Models\Server;

class UpdateServerDetailsRequest extends ServerWriteRequest
{
    /**
     * Rules to apply to a server details update request.
     */
    public function rules(): array
    {
        $rules = Server::getRulesForUpdate($this->parameter('server', Server::class));

        return [
            'external_id' => $rules['external_id'],
            'name' => $rules['name'],
            'user' => $rules['owner_id'],
            'description' => array_merge(['nullable'], $rules['description']),
        ];
    }

    /**
     * Convert the posted data into the correct format that is expected
     * by the application.
     */
    public function validated($key = null, $default = null): array
    {
        return [
            'external_id' => $this->input('external_id'),
            'name' => $this->input('name'),
            'owner_id' => $this->input('user'),
            'description' => $this->input('description'),
        ];
    }

    /**
     * Rename some attributes in error messages to clarify the field
     * being discussed.
     */
    public function attributes(): array
    {
        return [
            'user' => 'User ID',
            'name' => 'Server Name',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Application/Servers/UpdateServerStartupRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Servers;

use Jexactyl\Models\Server;
use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class UpdateServerStartupRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_SERVERS;

    protected int $permission = AdminAcl::WRITE;

    /**
     * Validation rules to run the input against.
     */
    public function rules(): array
    {
        $data = Server::getRulesForUpdate($this->parameter('server', Server::class));

        return [
            'startup' => $data['startup'],
            'environment' => 'present|array',
            'egg' => $data['egg_id'],
            'image' => $data['image'],
            'skip_scripts' => 'present|boolean',
        ];
    }

    /**
     * Return the validated data in a format that is expected by the service.
     */
    public function validated($key = null, $default = null): array
    {
        $data = parent::validated();

        return collect($data)->only(['startup', 'environment', 'skip_scripts'])->merge([
            'egg_id' => array_get($data, 'egg'),
            'docker_image' => array_get($data, 'image'),
        ])->toArray();
    }
}
</file>

<file path="app/Http/Requests/Api/Application/Users/DeleteUserRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Users;

use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class DeleteUserRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_USERS;

    protected int $permission = AdminAcl::WRITE;
}
</file>

<file path="app/Http/Requests/Api/Application/Users/GetExternalUserRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Users;

use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class GetExternalUserRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_USERS;

    protected int $permission = AdminAcl::READ;
}
</file>

<file path="app/Http/Requests/Api/Application/Users/GetUsersRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Users;

use Jexactyl\Services\Acl\Api\AdminAcl as Acl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class GetUsersRequest extends ApplicationApiRequest
{
    protected ?string $resource = Acl::RESOURCE_USERS;

    protected int $permission = Acl::READ;
}
</file>

<file path="app/Http/Requests/Api/Application/Users/StoreUserRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Users;

use Jexactyl\Models\User;
use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

class StoreUserRequest extends ApplicationApiRequest
{
    protected ?string $resource = AdminAcl::RESOURCE_USERS;

    protected int $permission = AdminAcl::WRITE;

    /**
     * Return the validation rules for this request.
     */
    public function rules(array $rules = null): array
    {
        $rules = $rules ?? User::getRules();

        $response = collect($rules)->only([
            'external_id',
            'discord_id',
            'email',
            'username',
            'password',
            'language',
            'root_admin',
        ])->toArray();

        $response['first_name'] = $rules['name_first'];
        $response['last_name'] = $rules['name_last'];

        return $response;
    }

    public function validated($key = null, $default = null): array
    {
        $data = parent::validated();

        $data['name_first'] = $data['first_name'];
        $data['name_last'] = $data['last_name'];

        unset($data['first_name'], $data['last_name']);

        return $data;
    }

    /**
     * Rename some fields to be more user friendly.
     */
    public function attributes(): array
    {
        return [
            'external_id' => 'Third Party Identifier',
            'name_first' => 'First Name',
            'name_last' => 'Last Name',
            'root_admin' => 'Root Administrator Status',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Application/Users/UpdateUserRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application\Users;

use Jexactyl\Models\User;

class UpdateUserRequest extends StoreUserRequest
{
    /**
     * Return the validation rules for this request.
     */
    public function rules(array $rules = null): array
    {
        $userId = $this->parameter('user', User::class)->id;

        return parent::rules(User::getRulesForUpdate($userId));
    }
}
</file>

<file path="app/Http/Requests/Api/Application/ApplicationApiRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Application;

use Jexactyl\Models\ApiKey;
use Webmozart\Assert\Assert;
use Laravel\Sanctum\TransientToken;
use Illuminate\Validation\Validator;
use Illuminate\Database\Eloquent\Model;
use Jexactyl\Services\Acl\Api\AdminAcl;
use Jexactyl\Exceptions\JexactylException;
use Illuminate\Foundation\Http\FormRequest;

abstract class ApplicationApiRequest extends FormRequest
{
    /**
     * The resource that should be checked when performing the authorization
     * function for this request.
     */
    protected ?string $resource;

    /**
     * The permission level that a given API key should have for accessing
     * the defined $resource during the request cycle.
     */
    protected int $permission = AdminAcl::NONE;

    /**
     * Determine if the current user is authorized to perform
     * the requested action against the API.
     *
     * @throws \Jexactyl\Exceptions\JexactylException
     */
    public function authorize(): bool
    {
        if (is_null($this->resource)) {
            throw new JexactylException('An ACL resource must be defined on API requests.');
        }

        $token = $this->user()->currentAccessToken();
        if ($token instanceof TransientToken) {
            return true;
        }

        if ($token->key_type === ApiKey::TYPE_ACCOUNT) {
            return true;
        }

        return AdminAcl::check($token, $this->resource, $this->permission);
    }

    /**
     * Default set of rules to apply to API requests.
     */
    public function rules(): array
    {
        return [];
    }

    /**
     * Helper method allowing a developer to easily hook into this logic without having
     * to remember what the method name is called or where to use it. By default this is
     * a no-op.
     */
    public function withValidator(Validator $validator): void
    {
        // do nothing
    }

    /**
     * Returns the named route parameter and asserts that it is a real model that
     * exists in the database.
     *
     * @template T of \Illuminate\Database\Eloquent\Model
     *
     * @param class-string<T> $expect
     *
     * @return T
     *
     * @noinspection PhpDocSignatureInspection
     */
    public function parameter(string $key, string $expect)
    {
        $value = $this->route()->parameter($key);

        Assert::isInstanceOf($value, $expect);
        Assert::isInstanceOf($value, Model::class);
        Assert::true($value->exists);

        /* @var T $value */
        return $value;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Account/StoreApiKeyRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Account;

use IPTools\Range;
use Jexactyl\Models\ApiKey;
use Illuminate\Validation\Validator;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class StoreApiKeyRequest extends ClientApiRequest
{
    public function rules(): array
    {
        $rules = ApiKey::getRules();

        return [
            'description' => $rules['memo'],
            'allowed_ips' => [...$rules['allowed_ips'], 'max:50'],
            'allowed_ips.*' => 'string',
        ];
    }

    /**
     * Check that each of the values entered is actually valid.
     */
    public function withValidator(Validator $validator): void
    {
        $validator->after(function (Validator $validator) {
            if (!is_array($ips = $this->input('allowed_ips'))) {
                return;
            }

            foreach ($ips as $index => $ip) {
                $valid = false;
                try {
                    $valid = Range::parse($ip)->valid();
                } catch (\Exception $exception) {
                    if ($exception->getMessage() !== 'Invalid IP address format') {
                        throw $exception;
                    }
                } finally {
                    $validator->errors()->addIf(!$valid, "allowed_ips.{$index}", '"' . $ip . '" is not a valid IP address or CIDR range.');
                }
            }
        });
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Account/StoreSSHKeyRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Account;

use phpseclib3\Crypt\DSA;
use phpseclib3\Crypt\RSA;
use Jexactyl\Models\UserSSHKey;
use Illuminate\Validation\Validator;
use phpseclib3\Crypt\PublicKeyLoader;
use phpseclib3\Crypt\Common\PublicKey;
use phpseclib3\Exception\NoKeyLoadedException;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class StoreSSHKeyRequest extends ClientApiRequest
{
    protected ?PublicKey $key;

    /**
     * Returns the rules for this request.
     */
    public function rules(): array
    {
        return [
            'name' => UserSSHKey::getRulesForField('name'),
            'public_key' => UserSSHKey::getRulesForField('public_key'),
        ];
    }

    /**
     * Check to see if this SSH key has already been added to the user's account
     * and if so return an error.
     */
    public function withValidator(Validator $validator): void
    {
        $validator->after(function () {
            try {
                $this->key = PublicKeyLoader::loadPublicKey($this->input('public_key'));
            } catch (NoKeyLoadedException $exception) {
                $this->validator->errors()->add('public_key', 'The public key provided is not valid.');

                return;
            }

            if ($this->key instanceof DSA) {
                $this->validator->errors()->add('public_key', 'DSA keys are not supported.');
            }

            if ($this->key instanceof RSA && $this->key->getLength() < 2048) {
                $this->validator->errors()->add('public_key', 'RSA keys must be at least 2048 bytes in length.');
            }

            $fingerprint = $this->key->getFingerprint('sha256');
            if ($this->user()->sshKeys()->where('fingerprint', $fingerprint)->exists()) {
                $this->validator->errors()->add('public_key', 'The public key provided already exists on your account.');
            }
        });
    }

    /**
     * Returns the public key but formatted in a consistent manner.
     */
    public function getPublicKey(): string
    {
        return $this->key->toString('PKCS8');
    }

    /**
     * Returns the SHA256 fingerprint of the key provided.
     */
    public function getKeyFingerprint(): string
    {
        if (!$this->key) {
            throw new \Exception('The public key was not properly loaded for this request.');
        }

        return $this->key->getFingerprint('sha256');
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Account/UpdateEmailRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Account;

use Jexactyl\Models\User;
use Illuminate\Container\Container;
use Illuminate\Contracts\Hashing\Hasher;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Jexactyl\Exceptions\Http\Base\InvalidPasswordProvidedException;

class UpdateEmailRequest extends ClientApiRequest
{
    /**
     * @throws \Jexactyl\Exceptions\Http\Base\InvalidPasswordProvidedException
     */
    public function authorize(): bool
    {
        if (!parent::authorize()) {
            return false;
        }

        $hasher = Container::getInstance()->make(Hasher::class);

        // Verify password matches when changing password or email.
        if (!$hasher->check($this->input('password'), $this->user()->password)) {
            throw new InvalidPasswordProvidedException(trans('validation.internal.invalid_password'));
        }

        return true;
    }

    public function rules(): array
    {
        $rules = User::getRulesForUpdate($this->user());

        return ['email' => $rules['email']];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Account/UpdatePasswordRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Account;

use Illuminate\Container\Container;
use Illuminate\Contracts\Hashing\Hasher;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Jexactyl\Exceptions\Http\Base\InvalidPasswordProvidedException;

class UpdatePasswordRequest extends ClientApiRequest
{
    /**
     * @throws \Jexactyl\Exceptions\Http\Base\InvalidPasswordProvidedException
     */
    public function authorize(): bool
    {
        if (!parent::authorize()) {
            return false;
        }

        $hasher = Container::getInstance()->make(Hasher::class);

        // Verify password matches when changing password or email.
        if (!$hasher->check($this->input('current_password'), $this->user()->password)) {
            throw new InvalidPasswordProvidedException(trans('validation.internal.invalid_password'));
        }

        return true;
    }

    public function rules(): array
    {
        return [
            'password' => ['required', 'string', 'confirmed', 'min:8'],
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Account/UpdateUsernameRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Account;

use Jexactyl\Models\User;
use Illuminate\Container\Container;
use Illuminate\Contracts\Hashing\Hasher;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Jexactyl\Exceptions\Http\Base\InvalidPasswordProvidedException;

class UpdateUsernameRequest extends ClientApiRequest
{
    /**
     * @throws \Jexactyl\Exceptions\Http\Base\InvalidPasswordProvidedException
     */
    public function authorize(): bool
    {
        if (!parent::authorize()) {
            return false;
        }

        $hasher = Container::getInstance()->make(Hasher::class);

        // Verify password matches.
        if (!$hasher->check($this->input('password'), $this->user()->password)) {
            throw new InvalidPasswordProvidedException(trans('validation.internal.invalid_password'));
        }

        return true;
    }

    public function rules(): array
    {
        $rules = User::getRulesForUpdate($this->user());

        return ['username' => $rules['username']];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Backups/StoreBackupRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Backups;

use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class StoreBackupRequest extends ClientApiRequest
{
    public function permission(): string
    {
        return Permission::ACTION_BACKUP_CREATE;
    }

    public function rules(): array
    {
        return [
            'name' => 'nullable|string|max:191',
            'is_locked' => 'nullable|boolean',
            'ignored' => 'nullable|string',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Databases/DeleteDatabaseRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Databases;

use Jexactyl\Models\Permission;
use Jexactyl\Contracts\Http\ClientPermissionsRequest;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class DeleteDatabaseRequest extends ClientApiRequest implements ClientPermissionsRequest
{
    public function permission(): string
    {
        return Permission::ACTION_DATABASE_DELETE;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Databases/GetDatabasesRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Databases;

use Jexactyl\Models\Permission;
use Jexactyl\Contracts\Http\ClientPermissionsRequest;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class GetDatabasesRequest extends ClientApiRequest implements ClientPermissionsRequest
{
    public function permission(): string
    {
        return Permission::ACTION_DATABASE_READ;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Databases/RotatePasswordRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Databases;

use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class RotatePasswordRequest extends ClientApiRequest
{
    /**
     * Check that the user has permission to rotate the password.
     */
    public function permission(): string
    {
        return Permission::ACTION_DATABASE_UPDATE;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Databases/StoreDatabaseRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Databases;

use Jexactyl\Models\Server;
use Webmozart\Assert\Assert;
use Jexactyl\Models\Database;
use Illuminate\Validation\Rule;
use Jexactyl\Models\Permission;
use Illuminate\Database\Query\Builder;
use Jexactyl\Contracts\Http\ClientPermissionsRequest;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Jexactyl\Services\Databases\DatabaseManagementService;

class StoreDatabaseRequest extends ClientApiRequest implements ClientPermissionsRequest
{
    public function permission(): string
    {
        return Permission::ACTION_DATABASE_CREATE;
    }

    public function rules(): array
    {
        $server = $this->route()->parameter('server');

        Assert::isInstanceOf($server, Server::class);

        return [
            'database' => [
                'required',
                'alpha_dash',
                'min:3',
                'max:48',
                // Yes, I am aware that you could have the same database name across two unique hosts. However,
                // I don't really care about that for this validation. We just want to make sure it is unique to
                // the server itself. No need for complexity.
                Rule::unique('databases')->where(function (Builder $query) use ($server) {
                    $query->where('server_id', $server->id)
                        ->where('database', DatabaseManagementService::generateUniqueDatabaseName($this->input('database'), $server->id));
                }),
            ],
            'remote' => Database::getRulesForField('remote'),
        ];
    }

    public function messages(): array
    {
        return [
            'database.unique' => 'The database name you have selected is already in use by this server.',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Files/ChmodFilesRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Files;

use Jexactyl\Models\Permission;
use Jexactyl\Contracts\Http\ClientPermissionsRequest;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class ChmodFilesRequest extends ClientApiRequest implements ClientPermissionsRequest
{
    public function permission(): string
    {
        return Permission::ACTION_FILE_UPDATE;
    }

    public function rules(): array
    {
        return [
            'root' => 'required|nullable|string',
            'files' => 'required|array',
            'files.*.file' => 'required|string',
            'files.*.mode' => 'required|numeric',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Files/CompressFilesRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Files;

use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class CompressFilesRequest extends ClientApiRequest
{
    /**
     * Checks that the authenticated user is allowed to create archives for this server.
     */
    public function permission(): string
    {
        return Permission::ACTION_FILE_ARCHIVE;
    }

    public function rules(): array
    {
        return [
            'root' => 'sometimes|nullable|string',
            'files' => 'required|array',
            'files.*' => 'string',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Files/CopyFileRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Files;

use Jexactyl\Models\Permission;
use Jexactyl\Contracts\Http\ClientPermissionsRequest;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class CopyFileRequest extends ClientApiRequest implements ClientPermissionsRequest
{
    public function permission(): string
    {
        return Permission::ACTION_FILE_CREATE;
    }

    public function rules(): array
    {
        return [
            'location' => 'required|string',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Files/CreateFolderRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Files;

use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class CreateFolderRequest extends ClientApiRequest
{
    /**
     * Checks that the authenticated user is allowed to create files on the server.
     */
    public function permission(): string
    {
        return Permission::ACTION_FILE_CREATE;
    }

    public function rules(): array
    {
        return [
            'root' => 'sometimes|nullable|string',
            'name' => 'required|string',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Files/DecompressFilesRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Files;

use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class DecompressFilesRequest extends ClientApiRequest
{
    /**
     * Checks that the authenticated user is allowed to create new files for the server. We don't
     * rely on the archive permission here as it makes more sense to make sure the user can create
     * additional files rather than make an archive.
     */
    public function permission(): string
    {
        return Permission::ACTION_FILE_CREATE;
    }

    public function rules(): array
    {
        return [
            'root' => 'sometimes|nullable|string',
            'file' => 'required|string',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Files/DeleteFileRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Files;

use Jexactyl\Models\Permission;
use Jexactyl\Contracts\Http\ClientPermissionsRequest;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class DeleteFileRequest extends ClientApiRequest implements ClientPermissionsRequest
{
    public function permission(): string
    {
        return Permission::ACTION_FILE_DELETE;
    }

    public function rules(): array
    {
        return [
            'root' => 'required|nullable|string',
            'files' => 'required|array',
            'files.*' => 'string',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Files/DownloadFileRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Files;

use Jexactyl\Models\Server;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class DownloadFileRequest extends ClientApiRequest
{
    /**
     * Ensure that the user making this request has permission to download files
     * from this server.
     */
    public function authorize(): bool
    {
        return $this->user()->can('file.read', $this->parameter('server', Server::class));
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Files/GetFileContentsRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Files;

use Jexactyl\Models\Permission;
use Jexactyl\Contracts\Http\ClientPermissionsRequest;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class GetFileContentsRequest extends ClientApiRequest implements ClientPermissionsRequest
{
    /**
     * Returns the permissions string indicating which permission should be used to
     * validate that the authenticated user has permission to perform this action aganist
     * the given resource (server).
     */
    public function permission(): string
    {
        return Permission::ACTION_FILE_READ_CONTENT;
    }

    public function rules(): array
    {
        return [
            'file' => 'required|string',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Files/ListFilesRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Files;

use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class ListFilesRequest extends ClientApiRequest
{
    /**
     * Check that the user making this request to the API is authorized to list all
     * the files that exist for a given server.
     */
    public function permission(): string
    {
        return Permission::ACTION_FILE_READ;
    }

    public function rules(): array
    {
        return [
            'directory' => 'sometimes|nullable|string',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Files/PullFileRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Files;

use Jexactyl\Models\Permission;
use Jexactyl\Contracts\Http\ClientPermissionsRequest;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class PullFileRequest extends ClientApiRequest implements ClientPermissionsRequest
{
    public function permission(): string
    {
        return Permission::ACTION_FILE_CREATE;
    }

    public function rules(): array
    {
        return [
            'url' => 'sometimes|string|url',
            'directory' => 'nullable|string',
            'filename' => 'nullable|string',
            'use_header' => 'boolean',
            'foreground' => 'boolean',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Files/RenameFileRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Files;

use Jexactyl\Models\Permission;
use Jexactyl\Contracts\Http\ClientPermissionsRequest;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class RenameFileRequest extends ClientApiRequest implements ClientPermissionsRequest
{
    /**
     * The permission the user is required to have in order to perform this
     * request action.
     */
    public function permission(): string
    {
        return Permission::ACTION_FILE_UPDATE;
    }

    public function rules(): array
    {
        return [
            'root' => 'required|nullable|string',
            'files' => 'required|array',
            'files.*' => 'array',
            'files.*.to' => 'required|string',
            'files.*.from' => 'required|string',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Files/UploadFileRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Files;

use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class UploadFileRequest extends ClientApiRequest
{
    public function permission(): string
    {
        return Permission::ACTION_FILE_CREATE;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Files/WriteFileContentRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Files;

use Jexactyl\Models\Permission;
use Jexactyl\Contracts\Http\ClientPermissionsRequest;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class WriteFileContentRequest extends ClientApiRequest implements ClientPermissionsRequest
{
    /**
     * Returns the permissions string indicating which permission should be used to
     * validate that the authenticated user has permission to perform this action aganist
     * the given resource (server).
     */
    public function permission(): string
    {
        return Permission::ACTION_FILE_CREATE;
    }

    /**
     * There is no rule here for the file contents since we just use the body content
     * on the request to set the file contents. If nothing is passed that is fine since
     * it just means we want to set the file to be empty.
     */
    public function rules(): array
    {
        return [
            'file' => 'required|string',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Network/DeleteAllocationRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Network;

use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class DeleteAllocationRequest extends ClientApiRequest
{
    public function permission(): string
    {
        return Permission::ACTION_ALLOCATION_DELETE;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Network/GetNetworkRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Network;

use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class GetNetworkRequest extends ClientApiRequest
{
    /**
     * Check that the user has permission to view the allocations for
     * this server.
     */
    public function permission(): string
    {
        return Permission::ACTION_ALLOCATION_READ;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Network/NewAllocationRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Network;

use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class NewAllocationRequest extends ClientApiRequest
{
    public function permission(): string
    {
        return Permission::ACTION_ALLOCATION_CREATE;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Network/SetPrimaryAllocationRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Network;

class SetPrimaryAllocationRequest extends UpdateAllocationRequest
{
    public function rules(): array
    {
        return [];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Network/UpdateAllocationRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Network;

use Jexactyl\Models\Allocation;
use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class UpdateAllocationRequest extends ClientApiRequest
{
    public function permission(): string
    {
        return Permission::ACTION_ALLOCATION_UPDATE;
    }

    public function rules(): array
    {
        $rules = Allocation::getRules();

        return [
            'notes' => array_merge($rules['notes'], ['present']),
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Schedules/DeleteScheduleRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Schedules;

use Jexactyl\Models\Permission;

class DeleteScheduleRequest extends ViewScheduleRequest
{
    public function permission(): string
    {
        return Permission::ACTION_SCHEDULE_DELETE;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Schedules/StoreScheduleRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Schedules;

use Jexactyl\Models\Schedule;
use Jexactyl\Models\Permission;

class StoreScheduleRequest extends ViewScheduleRequest
{
    public function permission(): string
    {
        return Permission::ACTION_SCHEDULE_CREATE;
    }

    public function rules(): array
    {
        $rules = Schedule::getRules();

        return [
            'name' => $rules['name'],
            'is_active' => array_merge(['filled'], $rules['is_active']),
            'minute' => $rules['cron_minute'],
            'hour' => $rules['cron_hour'],
            'day_of_month' => $rules['cron_day_of_month'],
            'day_of_week' => $rules['cron_day_of_week'],
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Schedules/StoreTaskRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Schedules;

use Jexactyl\Models\Permission;

class StoreTaskRequest extends ViewScheduleRequest
{
    /**
     * Determine if the user is allowed to create a new task for this schedule. We simply
     * check if they can modify a schedule to determine if they're able to do this. There
     * are no task specific permissions.
     */
    public function permission(): string
    {
        return Permission::ACTION_SCHEDULE_UPDATE;
    }

    public function rules(): array
    {
        return [
            'action' => 'required|in:command,power,backup',
            'payload' => 'required_unless:action,backup|string|nullable',
            'time_offset' => 'required|numeric|min:0|max:900',
            'sequence_id' => 'sometimes|required|numeric|min:1',
            'continue_on_failure' => 'sometimes|required|boolean',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Schedules/TriggerScheduleRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Schedules;

use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class TriggerScheduleRequest extends ClientApiRequest
{
    public function permission(): string
    {
        return Permission::ACTION_SCHEDULE_UPDATE;
    }

    public function rules(): array
    {
        return [];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Schedules/UpdateScheduleRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Schedules;

use Jexactyl\Models\Permission;

class UpdateScheduleRequest extends StoreScheduleRequest
{
    public function permission(): string
    {
        return Permission::ACTION_SCHEDULE_UPDATE;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Schedules/ViewScheduleRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Schedules;

use Jexactyl\Models\Task;
use Jexactyl\Models\Server;
use Jexactyl\Models\Schedule;
use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;

class ViewScheduleRequest extends ClientApiRequest
{
    /**
     * Determine if this resource can be viewed.
     */
    public function authorize(): bool
    {
        if (!parent::authorize()) {
            return false;
        }

        $server = $this->route()->parameter('server');
        $schedule = $this->route()->parameter('schedule');

        // If the schedule does not belong to this server throw a 404 error. Also throw an
        // error if the task being requested does not belong to the associated schedule.
        if ($server instanceof Server && $schedule instanceof Schedule) {
            $task = $this->route()->parameter('task');

            if ($schedule->server_id !== $server->id || ($task instanceof Task && $task->schedule_id !== $schedule->id)) {
                throw new NotFoundHttpException('The requested resource does not exist on the system.');
            }
        }

        return true;
    }

    public function permission(): string
    {
        return Permission::ACTION_SCHEDULE_READ;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Settings/ReinstallServerRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Settings;

use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class ReinstallServerRequest extends ClientApiRequest
{
    public function permission(): string
    {
        return Permission::ACTION_SETTINGS_REINSTALL;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Settings/RenameServerRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Settings;

use Jexactyl\Models\Server;
use Jexactyl\Models\Permission;
use Jexactyl\Contracts\Http\ClientPermissionsRequest;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class RenameServerRequest extends ClientApiRequest implements ClientPermissionsRequest
{
    /**
     * Returns the permissions string indicating which permission should be used to
     * validate that the authenticated user has permission to perform this action against
     * the given resource (server).
     */
    public function permission(): string
    {
        return Permission::ACTION_SETTINGS_RENAME;
    }

    /**
     * The rules to apply when validating this request.
     */
    public function rules(): array
    {
        return [
            'name' => Server::getRules()['name'],
            'description' => 'string|nullable',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Settings/SetDockerImageRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Settings;

use Jexactyl\Models\Server;
use Webmozart\Assert\Assert;
use Illuminate\Validation\Rule;
use Jexactyl\Models\Permission;
use Jexactyl\Contracts\Http\ClientPermissionsRequest;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class SetDockerImageRequest extends ClientApiRequest implements ClientPermissionsRequest
{
    public function permission(): string
    {
        return Permission::ACTION_STARTUP_DOCKER_IMAGE;
    }

    public function rules(): array
    {
        /** @var \Jexactyl\Models\Server $server */
        $server = $this->route()->parameter('server');

        Assert::isInstanceOf($server, Server::class);

        return [
            'docker_image' => ['required', 'string', Rule::in(array_values($server->egg->docker_images))],
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Startup/GetStartupRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Startup;

use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class GetStartupRequest extends ClientApiRequest
{
    public function permission(): string
    {
        return Permission::ACTION_STARTUP_READ;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Startup/UpdateStartupVariableRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Startup;

use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class UpdateStartupVariableRequest extends ClientApiRequest
{
    public function permission(): string
    {
        return Permission::ACTION_STARTUP_UPDATE;
    }

    /**
     * The actual validation of the variable's value will happen inside the controller.
     */
    public function rules(): array
    {
        return [
            'key' => 'required|string',
            'value' => 'present',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Subusers/DeleteSubuserRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Subusers;

use Jexactyl\Models\Permission;

class DeleteSubuserRequest extends SubuserRequest
{
    public function permission(): string
    {
        return Permission::ACTION_USER_DELETE;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Subusers/GetSubuserRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Subusers;

use Jexactyl\Models\Permission;

class GetSubuserRequest extends SubuserRequest
{
    /**
     * Confirm that a user is able to view subusers for the specified server.
     */
    public function permission(): string
    {
        return Permission::ACTION_USER_READ;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Subusers/StoreSubuserRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Subusers;

use Jexactyl\Models\Permission;

class StoreSubuserRequest extends SubuserRequest
{
    public function permission(): string
    {
        return Permission::ACTION_USER_CREATE;
    }

    public function rules(): array
    {
        return [
            'email' => 'required|email|between:1,191',
            'permissions' => 'required|array',
            'permissions.*' => 'string',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Subusers/SubuserRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Subusers;

use Jexactyl\Models\User;
use Illuminate\Http\Request;
use Jexactyl\Models\Subuser;
use Jexactyl\Exceptions\Http\HttpForbiddenException;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Jexactyl\Services\Servers\GetUserPermissionsService;

abstract class SubuserRequest extends ClientApiRequest
{
    protected ?Subuser $model;

    /**
     * Authorize the request and ensure that a user is not trying to modify themselves.
     *
     * @throws \Illuminate\Contracts\Container\BindingResolutionException
     */
    public function authorize(): bool
    {
        if (!parent::authorize()) {
            return false;
        }

        $user = $this->route()->parameter('user');
        // Don't allow a user to edit themselves on the server.
        if ($user instanceof User) {
            if ($user->uuid === $this->user()->uuid) {
                return false;
            }
        }

        // If this is a POST request, validate that the user can even assign the permissions they
        // have selected to assign.
        if ($this->method() === Request::METHOD_POST && $this->has('permissions')) {
            $this->validatePermissionsCanBeAssigned(
                $this->input('permissions') ?? []
            );
        }

        return true;
    }

    /**
     * Validates that the permissions we are trying to assign can actually be assigned
     * by the user making the request.
     *
     * @throws \Illuminate\Contracts\Container\BindingResolutionException
     */
    protected function validatePermissionsCanBeAssigned(array $permissions)
    {
        $user = $this->user();
        /** @var \Jexactyl\Models\Server $server */
        $server = $this->route()->parameter('server');

        // If we are a root admin or the server owner, no need to perform these checks.
        if ($user->root_admin || $user->id === $server->owner_id) {
            return;
        }

        // Otherwise, get the current subuser's permission set, and ensure that the
        // permissions they are trying to assign are not _more_ than the ones they
        // already have.
        /** @var \Jexactyl\Models\Subuser|null $subuser */
        /** @var \Jexactyl\Services\Servers\GetUserPermissionsService $service */
        $service = $this->container->make(GetUserPermissionsService::class);

        if (count(array_diff($permissions, $service->handle($server, $user))) > 0) {
            throw new HttpForbiddenException('Cannot assign permissions to a subuser that your account does not actively possess.');
        }
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/Subusers/UpdateSubuserRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers\Subusers;

use Jexactyl\Models\Permission;

class UpdateSubuserRequest extends SubuserRequest
{
    public function permission(): string
    {
        return Permission::ACTION_USER_UPDATE;
    }

    public function rules(): array
    {
        return [
            'permissions' => 'required|array',
            'permissions.*' => 'string',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/DeleteServerRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers;

use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class DeleteServerRequest extends ClientApiRequest
{
    /**
     * Determine if a client has permission to view this server on the API. This
     * should never be false since this would be checking the same permission as
     * resourceExists().
     */
    public function authorize(): bool
    {
        return true;
    }

    /**
     * Rules to validate this request against.
     */
    public function rules(): array
    {
        return [
            'name' => 'required|string',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/EditServerRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers;

use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class EditServerRequest extends ClientApiRequest
{
    /**
     * Determine if a client has permission to view this server on the API. This
     * should never be false since this would be checking the same permission as
     * resourceExists().
     */
    public function authorize(): bool
    {
        return true;
    }

    /**
     * Rules to validate this request against.
     */
    public function rules(): array
    {
        return [
            'resource' => 'required|string|in:cpu,memory,disk,allocation_limit,backup_limit,database_limit',
            'amount' => 'required|int',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/GetServerRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers;

use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class GetServerRequest extends ClientApiRequest
{
    /**
     * Determine if a client has permission to view this server on the API. This
     * should never be false since this would be checking the same permission as
     * resourceExists().
     */
    public function authorize(): bool
    {
        return true;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/SendCommandRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers;

use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class SendCommandRequest extends ClientApiRequest
{
    /**
     * Determine if the API user has permission to perform this action.
     */
    public function permission(): string
    {
        return Permission::ACTION_CONTROL_CONSOLE;
    }

    /**
     * Rules to validate this request against.
     */
    public function rules(): array
    {
        return [
            'command' => 'required|string|min:1',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/SendPowerRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers;

use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class SendPowerRequest extends ClientApiRequest
{
    /**
     * Determine if the user has permission to send a power command to a server.
     */
    public function permission(): string
    {
        switch ($this->input('signal')) {
            case 'start':
                return Permission::ACTION_CONTROL_START;
            case 'stop':
            case 'kill':
                return Permission::ACTION_CONTROL_STOP;
            case 'restart':
                return Permission::ACTION_CONTROL_RESTART;
        }

        return '__invalid';
    }

    /**
     * Rules to validate this request against.
     */
    public function rules(): array
    {
        return [
            'signal' => 'required|string|in:start,stop,restart,kill',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/ShareConsoleRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers;

use Jexactyl\Models\Permission;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class ShareConsoleRequest extends ClientApiRequest
{
    /**
     * Determine if the API user has permission to perform this action.
     */
    public function permission(): string
    {
        return Permission::ACTION_CONTROL_CONSOLE;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Servers/UpdateBackgroundRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Servers;

use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class UpdateBackgroundRequest extends ClientApiRequest
{
    /**
     * Determine if a client has permission to view this server on the API. This
     * should never be false since this would be checking the same permission as
     * resourceExists().
     */
    public function authorize(): bool
    {
        return true;
    }

    /**
     * Rules to validate this request against.
     */
    public function rules(): array
    {
        return [
            'bg' => 'nullable|url',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Store/Gateways/PayPalRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Store\Gateways;

use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class PayPalRequest extends ClientApiRequest
{
    /**
     * Rules to validate this request against.
     */
    public function rules(): array
    {
        return [
            'amount' => 'required|int',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Store/Gateways/StripeRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Store\Gateways;

use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class StripeRequest extends ClientApiRequest
{
    /**
     * Rules to validate this request against.
     */
    public function rules(): array
    {
        return [
            'amount' => 'required|int',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Store/CreateServerRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Store;

use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class CreateServerRequest extends ClientApiRequest
{
    /**
     * Rules to validate this request against.
     */
    public function rules(): array
    {
        return [
            'name' => 'required|string|min:3|max:191',
            'description' => 'nullable|string|min:3|max:191',
            'cpu' => 'required|int|min:50',
            'memory' => 'required|numeric|min:1',
            'disk' => 'required|numeric|min:1',
            'ports' => 'required|int|min:1',
            'backups' => 'nullable|int',
            'databases' => 'nullable|int',
            'egg' => 'required|int|min:1',
            'nest' => 'required|int|min:1',
            'node' => 'required|int|min:1',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/Store/PurchaseResourceRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client\Store;

use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;

class PurchaseResourceRequest extends ClientApiRequest
{
    /**
     * Rules to validate this request against.
     */
    public function rules(): array
    {
        return [
            'resource' => 'required|string|in:cpu,memory,disk,slots,ports,backups,databases',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Client/ClientApiRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client;

use Jexactyl\Models\Server;
use Jexactyl\Contracts\Http\ClientPermissionsRequest;
use Jexactyl\Http\Requests\Api\Application\ApplicationApiRequest;

/**
 * @method \Jexactyl\Models\User user($guard = null)
 */
class ClientApiRequest extends ApplicationApiRequest
{
    /**
     * Determine if the current user is authorized to perform the requested action against the API.
     */
    public function authorize(): bool
    {
        if ($this instanceof ClientPermissionsRequest || method_exists($this, 'permission')) {
            $server = $this->route()->parameter('server');

            if ($server instanceof Server) {
                return $this->user()->can($this->permission(), $server);
            }

            // If there is no server available on the reqest, trigger a failure since
            // we expect there to be one at this point.
            return false;
        }

        return true;
    }
}
</file>

<file path="app/Http/Requests/Api/Client/GetServersRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Client;

class GetServersRequest extends ClientApiRequest
{
    public function authorize(): bool
    {
        return true;
    }
}
</file>

<file path="app/Http/Requests/Api/Remote/ActivityEventRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Remote;

use Illuminate\Support\Collection;
use Illuminate\Foundation\Http\FormRequest;

class ActivityEventRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    public function rules(): array
    {
        return [
            'data' => ['required', 'array'],
            'data.*' => ['array'],
            'data.*.user' => ['sometimes', 'nullable', 'uuid'],
            'data.*.server' => ['required', 'uuid'],
            'data.*.event' => ['required', 'string'],
            'data.*.metadata' => ['present', 'nullable', 'array'],
            'data.*.ip' => ['sometimes', 'nullable', 'ip'],
            'data.*.timestamp' => ['required', 'string'],
        ];
    }

    /**
     * Returns all the unique server UUIDs that were received in this request.
     */
    public function servers(): array
    {
        return Collection::make($this->input('data'))->pluck('server')->unique()->toArray();
    }

    /**
     * Returns all the unique user UUIDs that were submitted in this request.
     */
    public function users(): array
    {
        return Collection::make($this->input('data'))
            ->filter(function ($value) {
                return !empty($value['user']);
            })
            ->pluck('user')
            ->unique()
            ->toArray();
    }
}
</file>

<file path="app/Http/Requests/Api/Remote/AuthenticateWebsocketDetailsRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Remote;

use Illuminate\Foundation\Http\FormRequest;

class AuthenticateWebsocketDetailsRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    public function rules(): array
    {
        return [
            'server_uuid' => 'required|string',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Remote/InstallationDataRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Remote;

use Illuminate\Foundation\Http\FormRequest;

class InstallationDataRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    public function rules(): array
    {
        return [
            'successful' => 'present|boolean',
            'reinstall' => 'sometimes|boolean',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Remote/ReportBackupCompleteRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Remote;

use Illuminate\Foundation\Http\FormRequest;

class ReportBackupCompleteRequest extends FormRequest
{
    public function rules(): array
    {
        return [
            'successful' => 'required|boolean',
            'checksum' => 'nullable|string|required_if:successful,true',
            'checksum_type' => 'nullable|string|required_if:successful,true',
            'size' => 'nullable|numeric|required_if:successful,true',
            'parts' => 'nullable|array',
            'parts.*.etag' => 'required|string',
            'parts.*.part_number' => 'required|numeric',
        ];
    }
}
</file>

<file path="app/Http/Requests/Api/Remote/SftpAuthenticationFormRequest.php">
<?php

namespace Jexactyl\Http\Requests\Api\Remote;

use Illuminate\Foundation\Http\FormRequest;

class SftpAuthenticationFormRequest extends FormRequest
{
    /**
     * Authenticate the request.
     */
    public function authorize(): bool
    {
        return true;
    }

    /**
     * Rules to apply to the request.
     */
    public function rules(): array
    {
        return [
            'type' => ['nullable', 'in:password,public_key'],
            'username' => ['required', 'string'],
            'password' => ['required', 'string'],
        ];
    }

    /**
     * Return only the fields that we are interested in from the request.
     * This will include empty fields as a null value.
     */
    public function normalize(): array
    {
        return $this->only(
            array_keys($this->rules())
        );
    }
}
</file>

<file path="app/Http/Requests/Auth/LoginCheckpointRequest.php">
<?php

namespace Jexactyl\Http\Requests\Auth;

use Illuminate\Validation\Rule;
use Illuminate\Foundation\Http\FormRequest;

class LoginCheckpointRequest extends FormRequest
{
    /**
     * Determine if the request is authorized.
     */
    public function authorize(): bool
    {
        return true;
    }

    /**
     * Rules to apply to the request.
     */
    public function rules(): array
    {
        return [
            'confirmation_token' => 'required|string',
            'authentication_code' => [
                'nullable',
                'numeric',
                Rule::requiredIf(function () {
                    return empty($this->input('recovery_token'));
                }),
            ],
            'recovery_token' => [
                'nullable',
                'string',
                Rule::requiredIf(function () {
                    return empty($this->input('authentication_code'));
                }),
            ],
        ];
    }
}
</file>

<file path="app/Http/Requests/Auth/LoginRequest.php">
<?php

namespace Jexactyl\Http\Requests\Auth;

use Illuminate\Foundation\Http\FormRequest;

class LoginRequest extends FormRequest
{
    public function authorized(): bool
    {
        return true;
    }

    public function rules(): array
    {
        return [
            'user' => 'required|string|min:1',
            'password' => 'required|string',
        ];
    }
}
</file>

<file path="app/Http/Requests/Auth/RegisterRequest.php">
<?php

namespace Jexactyl\Http\Requests\Auth;

use Illuminate\Foundation\Http\FormRequest;

class RegisterRequest extends FormRequest
{
    public function authorized(): bool
    {
        return true;
    }

    public function rules(): array
    {
        return [
            'user' => 'required|string|min:3',
            'email' => 'required|email',
            'password' => 'required|string|min:8',
        ];
    }
}
</file>

<file path="app/Http/Requests/Auth/ResetPasswordRequest.php">
<?php

namespace Jexactyl\Http\Requests\Auth;

use Illuminate\Foundation\Http\FormRequest;

class ResetPasswordRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    public function rules(): array
    {
        return [
            'token' => 'required|string',
            'email' => 'required|email',
            'password' => 'required|string|confirmed|min:8',
        ];
    }
}
</file>

<file path="app/Http/Requests/FrontendUserFormRequest.php">
<?php

namespace Jexactyl\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

abstract class FrontendUserFormRequest extends FormRequest
{
    abstract public function rules(): array;

    /**
     * Determine if a user is authorized to access this endpoint.
     */
    public function authorize(): bool
    {
        return !is_null($this->user());
    }

    /**
     * Return only the fields that we are interested in from the request.
     * This will include empty fields as a null value.
     */
    public function normalize(): array
    {
        return $this->only(
            array_keys($this->rules())
        );
    }
}
</file>

<file path="app/Http/Requests/LocaleRequest.php">
<?php

namespace Jexactyl\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class LocaleRequest extends FormRequest
{
    public function rules(): array
    {
        return [
            'locale' => ['required', 'string', 'regex:/^[a-z][a-z]$/'],
            'namespace' => ['required', 'string', 'regex:/^[a-z]{1,191}$/'],
        ];
    }
}
</file>

<file path="app/Http/Resources/Wings/ServerConfigurationCollection.php">
<?php

namespace Jexactyl\Http\Resources\Wings;

use Jexactyl\Models\Server;
use Illuminate\Container\Container;
use Jexactyl\Services\Eggs\EggConfigurationService;
use Illuminate\Http\Resources\Json\ResourceCollection;
use Jexactyl\Services\Servers\ServerConfigurationStructureService;

class ServerConfigurationCollection extends ResourceCollection
{
    /**
     * Converts a collection of Server models into an array of configuration responses
     * that can be understood by Wings. Make sure you've properly loaded the required
     * relationships on the Server models before calling this function, otherwise you'll
     * have some serious performance issues from all the N+1 queries.
     */
    public function toArray($request): array
    {
        $egg = Container::getInstance()->make(EggConfigurationService::class);
        $configuration = Container::getInstance()->make(ServerConfigurationStructureService::class);

        return $this->collection->map(function (Server $server) use ($configuration, $egg) {
            return [
                'uuid' => $server->uuid,
                'settings' => $configuration->handle($server),
                'process_configuration' => $egg->handle($server),
            ];
        })->toArray();
    }
}
</file>

<file path="app/Http/ViewComposers/Composer.php">
<?php

namespace Jexactyl\Http\ViewComposers;

use Illuminate\Support\Facades\DB;
use Illuminate\Container\Container;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;

class Composer
{
    private SettingsRepositoryInterface $settings;

    /**
     * Types of value that can be retrieved from the database
     * when loading configured settings for the UI.
     */
    public const TYPE_BOOL = 0;
    public const TYPE_INT = 1;
    public const TYPE_STR = 2;

    /**
     * Composer constructor.
     */
    public function __construct()
    {
        Container::getInstance()->call([$this, 'loadDependencies']);
    }

    /**
     * Perform dependency injection of certain classes needed for core functionality
     * without littering the constructors of classes that extend this abstract.
     */
    public function loadDependencies(SettingsRepositoryInterface $settings)
    {
        $this->settings = $settings;
    }

    protected function getDatabaseAvailability(): bool
    {
        $databases = DB::table('database_hosts')->count();

        if ($databases <= 0) {
            return false;
        }

        return true;
    }

    /**
     * Get the setting from the database and cast it to the correct type.
     */
    protected function setting(string $data, int $type)
    {
        $setting = $this->settings->get('jexactyl::' . $data, false);

        if ($data == 'logo') {
            return $this->settings->get('settings::app:logo', 'https://avatars.githubusercontent.com/u/91636558');
        } elseif ($data == 'background') {
            return $this->settings->get('settings:app:background', null);
        }

        switch ($type) {
            case 1:
                return (int) $setting;
            case 2:
                return (string) $setting;
            case 0:
                return filter_var($setting, FILTER_VALIDATE_BOOLEAN);
            default:
                return $setting;
        }
    }
}
</file>

<file path="app/Http/ViewComposers/SettingComposer.php">
<?php

namespace Jexactyl\Http\ViewComposers;

use Illuminate\View\View;
use Jexactyl\Services\Helpers\AssetHashService;

class SettingComposer extends Composer
{
    /**
     * AssetComposer constructor.
     */
    public function __construct(private AssetHashService $assetHashService)
    {
        parent::__construct();
    }

    /**
     * Provide access to the asset service in the views.
     */
    public function compose(View $view): void
    {
        $view->with('asset', $this->assetHashService);

        $view->with('siteConfiguration', [
            'name' => config('app.name') ?? 'Jexactyl',
            'locale' => config('app.locale') ?? 'en',
            'logo' => config('app.logo'),
            'background' => config('theme.user.background'),

            'recaptcha' => [
                'enabled' => config('recaptcha.enabled', false),
                'siteKey' => config('recaptcha.website_key') ?? '',
            ],

            'alert' => [
                'type' => $this->setting('alert:type', Composer::TYPE_STR),
                'message' => $this->setting('alert:message', Composer::TYPE_STR),
            ],

            'registration' => [
                'email' => $this->setting('registration:enabled', Composer::TYPE_BOOL),
                'discord' => $this->setting('discord:enabled', Composer::TYPE_BOOL),
            ],

            'approvals' => $this->setting('approvals:enabled', Composer::TYPE_BOOL),
            'tickets' => $this->setting('tickets:enabled', Composer::TYPE_BOOL),
            'coupons' => $this->setting('coupons:enabled', Composer::TYPE_BOOL),
            'databases' => $this->getDatabaseAvailability(),
        ]);
    }
}
</file>

<file path="app/Http/ViewComposers/StoreComposer.php">
<?php

namespace Jexactyl\Http\ViewComposers;

use Illuminate\View\View;

class StoreComposer extends Composer
{
    /**
     * StoreComposer constructor.
     */
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * Provide access to the asset service in the views.
     */
    public function compose(View $view)
    {
        $view->with('storeConfiguration', [
            'enabled' => $this->setting('store:enabled', Composer::TYPE_BOOL),
            'currency' => $this->setting('store:currency', Composer::TYPE_STR),

            'gateways' => [
                'paypal' => $this->setting('store:paypal:enabled', Composer::TYPE_BOOL),
                'stripe' => $this->setting('store:stripe:enabled', Composer::TYPE_BOOL),
            ],

            'renewals' => [
                'enabled' => $this->setting('renewal:enabled', Composer::TYPE_BOOL),
                'cost' => $this->setting('renewal:cost', Composer::TYPE_INT),
                'days' => $this->setting('renewal:default', Composer::TYPE_INT),
            ],

            'editing' => [
                'enabled' => $this->setting('renewal:editing', Composer::TYPE_BOOL),
            ],

            'deletion' => [
                'enabled' => $this->setting('renewal:deletion', Composer::TYPE_BOOL),
            ],

            'referrals' => [
                'enabled' => $this->setting('referrals:enabled', Composer::TYPE_BOOL),
                'reward' => $this->setting('referrals:reward', Composer::TYPE_INT),
            ],

            'earn' => [
                'enabled' => $this->setting('earn:enabled', Composer::TYPE_BOOL),
                'amount' => $this->setting('earn:amount', Composer::TYPE_INT),
            ],
        ]);
    }
}
</file>

<file path="app/Http/Kernel.php">
<?php

namespace Jexactyl\Http;

use Illuminate\Auth\Middleware\Authorize;
use Jexactyl\Http\Middleware\TrimStrings;
use Illuminate\Http\Middleware\HandleCors;
use Illuminate\Auth\Middleware\Authenticate;
use Illuminate\Http\Middleware\TrustProxies;
use Jexactyl\Http\Middleware\EncryptCookies;
use Jexactyl\Http\Middleware\Api\IsValidJson;
use Jexactyl\Http\Middleware\VerifyCsrfToken;
use Jexactyl\Http\Middleware\VerifyReCaptcha;
use Illuminate\Session\Middleware\StartSession;
use Jexactyl\Http\Middleware\LanguageMiddleware;
use Jexactyl\Http\Middleware\Activity\TrackAPIKey;
use Illuminate\Routing\Middleware\ThrottleRequests;
use Jexactyl\Http\Middleware\MaintenanceMiddleware;
use Illuminate\Foundation\Http\Kernel as HttpKernel;
use Jexactyl\Http\Middleware\EnsureStatefulRequests;
use Illuminate\Routing\Middleware\SubstituteBindings;
use Jexactyl\Http\Middleware\RedirectIfAuthenticated;
use Illuminate\Session\Middleware\AuthenticateSession;
use Illuminate\View\Middleware\ShareErrorsFromSession;
use Jexactyl\Http\Middleware\Api\AuthenticateIPAccess;
use Illuminate\Auth\Middleware\AuthenticateWithBasicAuth;
use Illuminate\Foundation\Http\Middleware\ValidatePostSize;
use Jexactyl\Http\Middleware\Api\Daemon\DaemonAuthenticate;
use Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse;
use Jexactyl\Http\Middleware\Api\Client\RequireClientApiKey;
use Jexactyl\Http\Middleware\RequireTwoFactorAuthentication;
use Jexactyl\Http\Middleware\Api\Client\SubstituteClientBindings;
use Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull;
use Jexactyl\Http\Middleware\Api\Application\AuthenticateApplicationUser;
use Illuminate\Foundation\Http\Middleware\PreventRequestsDuringMaintenance;

class Kernel extends HttpKernel
{
    /**
     * The application's global HTTP middleware stack.
     */
    protected $middleware = [
        TrustProxies::class,
        HandleCors::class,
        PreventRequestsDuringMaintenance::class,
        ValidatePostSize::class,
        TrimStrings::class,
        ConvertEmptyStringsToNull::class,
    ];

    /**
     * The application's route middleware groups.
     */
    protected $middlewareGroups = [
        'web' => [
            EncryptCookies::class,
            AddQueuedCookiesToResponse::class,
            StartSession::class,
            ShareErrorsFromSession::class,
            VerifyCsrfToken::class,
            SubstituteBindings::class,
            LanguageMiddleware::class,
        ],
        'api' => [
            EnsureStatefulRequests::class,
            'auth:sanctum',
            IsValidJson::class,
            TrackAPIKey::class,
            RequireTwoFactorAuthentication::class,
            AuthenticateIPAccess::class,
        ],
        'application-api' => [
            SubstituteBindings::class,
            AuthenticateApplicationUser::class,
        ],
        'client-api' => [
            SubstituteClientBindings::class,
            RequireClientApiKey::class,
        ],
        'daemon' => [
            SubstituteBindings::class,
            DaemonAuthenticate::class,
        ],
    ];

    /**
     * The application's route middleware.
     */
    protected $routeMiddleware = [
        'auth' => Authenticate::class,
        'auth.basic' => AuthenticateWithBasicAuth::class,
        'auth.session' => AuthenticateSession::class,
        'guest' => RedirectIfAuthenticated::class,
        'csrf' => VerifyCsrfToken::class,
        'throttle' => ThrottleRequests::class,
        'can' => Authorize::class,
        'bindings' => SubstituteBindings::class,
        'recaptcha' => VerifyReCaptcha::class,
        'node.maintenance' => MaintenanceMiddleware::class,
    ];
}
</file>

<file path="app/Jobs/Schedule/RunTaskJob.php">
<?php

namespace Jexactyl\Jobs\Schedule;

use Exception;
use Jexactyl\Jobs\Job;
use Jexactyl\Models\Task;
use Carbon\CarbonImmutable;
use Illuminate\Queue\SerializesModels;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\DispatchesJobs;
use Jexactyl\Services\Backups\InitiateBackupService;
use Jexactyl\Repositories\Wings\DaemonPowerRepository;
use Jexactyl\Repositories\Wings\DaemonCommandRepository;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;

class RunTaskJob extends Job implements ShouldQueue
{
    use DispatchesJobs;
    use InteractsWithQueue;
    use SerializesModels;

    /**
     * RunTaskJob constructor.
     */
    public function __construct(public Task $task, public bool $manualRun = false)
    {
        $this->queue = 'standard';
    }

    /**
     * Run the job and send actions to the daemon running the server.
     *
     * @throws \Throwable
     */
    public function handle(
        DaemonCommandRepository $commandRepository,
        InitiateBackupService $backupService,
        DaemonPowerRepository $powerRepository
    ) {
        // Do not process a task that is not set to active, unless it's been manually triggered.
        if (!$this->task->schedule->is_active && !$this->manualRun) {
            $this->markTaskNotQueued();
            $this->markScheduleComplete();

            return;
        }

        $server = $this->task->server;
        // If we made it to this point and the server status is not null it means the
        // server was likely suspended or marked as reinstalling after the schedule
        // was queued up. Just end the task right now  this should be a very rare
        // condition.
        if (!is_null($server->status)) {
            $this->failed();

            return;
        }

        // Perform the provided task against the daemon.
        try {
            switch ($this->task->action) {
                case Task::ACTION_POWER:
                    $powerRepository->setServer($server)->send($this->task->payload);
                    break;
                case Task::ACTION_COMMAND:
                    $commandRepository->setServer($server)->send($this->task->payload);
                    break;
                case Task::ACTION_BACKUP:
                    $backupService->setIgnoredFiles(explode(PHP_EOL, $this->task->payload))->handle($server, null, true);
                    break;
                default:
                    throw new \InvalidArgumentException('Invalid task action provided: ' . $this->task->action);
            }
        } catch (\Exception $exception) {
            // If this isn't a DaemonConnectionException on a task that allows for failures
            // throw the exception back up the chain so that the task is stopped.
            if (!($this->task->continue_on_failure && $exception instanceof DaemonConnectionException)) {
                throw $exception;
            }
        }

        $this->markTaskNotQueued();
        $this->queueNextTask();
    }

    /**
     * Handle a failure while sending the action to the daemon or otherwise processing the job.
     */
    public function failed(\Exception $exception = null)
    {
        $this->markTaskNotQueued();
        $this->markScheduleComplete();
    }

    /**
     * Get the next task in the schedule and queue it for running after the defined period of wait time.
     */
    private function queueNextTask()
    {
        /** @var \Jexactyl\Models\Task|null $nextTask */
        $nextTask = Task::query()->where('schedule_id', $this->task->schedule_id)
            ->orderBy('sequence_id', 'asc')
            ->where('sequence_id', '>', $this->task->sequence_id)
            ->first();

        if (is_null($nextTask)) {
            $this->markScheduleComplete();

            return;
        }

        $nextTask->update(['is_queued' => true]);

        $this->dispatch((new self($nextTask, $this->manualRun))->delay($nextTask->time_offset));
    }

    /**
     * Marks the parent schedule as being complete.
     */
    private function markScheduleComplete()
    {
        $this->task->schedule()->update([
            'is_processing' => false,
            'last_run_at' => CarbonImmutable::now()->toDateTimeString(),
        ]);
    }

    /**
     * Mark a specific task as no longer being queued.
     */
    private function markTaskNotQueued()
    {
        $this->task->update(['is_queued' => false]);
    }
}
</file>

<file path="app/Jobs/Job.php">
<?php

namespace Jexactyl\Jobs;

use Illuminate\Bus\Queueable;

abstract class Job
{
    /*
    |--------------------------------------------------------------------------
    | Queueable Jobs
    |--------------------------------------------------------------------------
    |
    | This job base class provides a central location to place any logic that
    | is shared across all of your jobs. The trait included with the class
    | provides access to the "onQueue" and "delay" queue helper methods.
    |
    */

    use Queueable;
}
</file>

<file path="app/Listeners/Auth/AuthenticationListener.php">
<?php

namespace Jexactyl\Listeners\Auth;

use Jexactyl\Facades\Activity;
use Illuminate\Auth\Events\Failed;
use Jexactyl\Events\Auth\DirectLogin;
use Illuminate\Contracts\Events\Dispatcher;
use Jexactyl\Extensions\Illuminate\Events\Contracts\SubscribesToEvents;

class AuthenticationListener implements SubscribesToEvents
{
    /**
     * Handles an authentication event by logging the user and information about
     * the request.
     */
    public function handle(Failed|DirectLogin $event): void
    {
        $activity = Activity::withRequestMetadata();
        if ($event->user) {
            $activity = $activity->subject($event->user);
        }

        if ($event instanceof Failed) {
            foreach ($event->credentials as $key => $value) {
                $activity = $activity->property($key, $value);
            }
        }

        $activity->event($event instanceof Failed ? 'auth:fail' : 'auth:success')->log();
    }

    public function subscribe(Dispatcher $events): void
    {
        $events->listen(Failed::class, self::class);
        $events->listen(DirectLogin::class, self::class);
    }
}
</file>

<file path="app/Listeners/Auth/PasswordResetListener.php">
<?php

namespace Jexactyl\Listeners\Auth;

use Illuminate\Http\Request;
use Jexactyl\Facades\Activity;
use Illuminate\Auth\Events\PasswordReset;

class PasswordResetListener
{
    protected Request $request;

    public function __construct(Request $request)
    {
        $this->request = $request;
    }

    public function handle(PasswordReset $event): void
    {
        Activity::event('event:password-reset')
            ->withRequestMetadata()
            ->subject($event->user)
            ->log();
    }
}
</file>

<file path="app/Listeners/Auth/TwoFactorListener.php">
<?php

namespace Jexactyl\Listeners\Auth;

use Jexactyl\Facades\Activity;
use Jexactyl\Events\Auth\ProvidedAuthenticationToken;

class TwoFactorListener
{
    public function handle(ProvidedAuthenticationToken $event): void
    {
        Activity::event($event->recovery ? 'auth:recovery-token' : 'auth:token')
            ->withRequestMetadata()
            ->subject($event->user)
            ->log();
    }
}
</file>

<file path="app/Models/Filters/AdminServerFilter.php">
<?php

namespace Jexactyl\Models\Filters;

use Spatie\QueryBuilder\Filters\Filter;
use Illuminate\Database\Eloquent\Builder;

class AdminServerFilter implements Filter
{
    /**
     * A multi-column filter for the servers table that allows an administrative user to search
     * across UUID, name, owner username, and owner email.
     *
     * @param string $value
     */
    public function __invoke(Builder $query, $value, string $property)
    {
        if ($query->getQuery()->from !== 'servers') {
            throw new \BadMethodCallException('Cannot use the AdminServerFilter against a non-server model.');
        }
        $query
            ->select('servers.*')
            ->leftJoin('users', 'users.id', '=', 'servers.owner_id')
            ->where(function (Builder $builder) use ($value) {
                $builder->where('servers.uuid', $value)
                    ->orWhere('servers.uuid', 'LIKE', "$value%")
                    ->orWhere('servers.uuidShort', $value)
                    ->orWhere('servers.external_id', $value)
                    ->orWhereRaw('LOWER(users.username) LIKE ?', ["%$value%"])
                    ->orWhereRaw('LOWER(users.email) LIKE ?', ["$value%"])
                    ->orWhereRaw('LOWER(servers.name) LIKE ?', ["%$value%"]);
            })
            ->groupBy('servers.id');
    }
}
</file>

<file path="app/Models/Filters/MultiFieldServerFilter.php">
<?php

namespace Jexactyl\Models\Filters;

use Illuminate\Support\Str;
use Spatie\QueryBuilder\Filters\Filter;
use Illuminate\Database\Eloquent\Builder;

class MultiFieldServerFilter implements Filter
{
    /**
     * If we detect that the value matches an IPv4 address we will use a different type of filtering
     * to look at the allocations.
     */
    private const IPV4_REGEX = '/^(?:[0-9]{1,3}\.){3}[0-9]{1,3}(\:\d{1,5})?$/';

    /**
     * A multi-column filter for the servers table that allows you to pass in a single value and
     * search across multiple columns. This allows us to provide a very generic search ability for
     * the frontend.
     *
     * @param string $value
     */
    public function __invoke(Builder $query, $value, string $property)
    {
        if ($query->getQuery()->from !== 'servers') {
            throw new \BadMethodCallException('Cannot use the MultiFieldServerFilter against a non-server model.');
        }

        if (preg_match(self::IPV4_REGEX, $value) || preg_match('/^:\d{1,5}$/', $value)) {
            $query
                // Only select the server values, otherwise you'll end up merging the allocation and
                // server objects together, resulting in incorrect behavior and returned values.
                ->select('servers.*')
                ->join('allocations', 'allocations.server_id', '=', 'servers.id')
                ->where(function (Builder $builder) use ($value) {
                    $parts = explode(':', $value);

                    $builder->when(
                        !Str::startsWith($value, ':'),
                        // When the string does not start with a ":" it means we're looking for an IP or IP:Port
                        // combo, so use a query to handle that.
                        function (Builder $builder) use ($parts) {
                            $builder->orWhere('allocations.ip', $parts[0]);
                            if (!is_null($parts[1] ?? null)) {
                                $builder->where('allocations.port', 'LIKE', "{$parts[1]}%");
                            }
                        },
                        // Otherwise, just try to search for that specific port in the allocations.
                        function (Builder $builder) use ($value) {
                            $builder->orWhere('allocations.port', 'LIKE', substr($value, 1) . '%');
                        }
                    );
                })
                ->groupBy('servers.id');

            return;
        }

        $query
            ->where(function (Builder $builder) use ($value) {
                $builder->where('servers.uuid', $value)
                    ->orWhere('servers.uuid', 'LIKE', "$value%")
                    ->orWhere('servers.uuidShort', $value)
                    ->orWhere('servers.external_id', $value)
                    ->orWhereRaw('LOWER(servers.name) LIKE ?', ["%$value%"]);
            });
    }
}
</file>

<file path="app/Models/Objects/DeploymentObject.php">
<?php

namespace Jexactyl\Models\Objects;

class DeploymentObject
{
    private bool $dedicated = false;

    private array $locations = [];

    private array $ports = [];

    public function isDedicated(): bool
    {
        return $this->dedicated;
    }

    public function setDedicated(bool $dedicated): self
    {
        $this->dedicated = $dedicated;

        return $this;
    }

    public function getLocations(): array
    {
        return $this->locations;
    }

    public function setLocations(array $locations): self
    {
        $this->locations = $locations;

        return $this;
    }

    public function getPorts(): array
    {
        return $this->ports;
    }

    public function setPorts(array $ports): self
    {
        $this->ports = $ports;

        return $this;
    }
}
</file>

<file path="app/Models/Traits/HasAccessTokens.php">
<?php

namespace Jexactyl\Models\Traits;

use Illuminate\Support\Str;
use Jexactyl\Models\ApiKey;
use Laravel\Sanctum\Sanctum;
use Laravel\Sanctum\HasApiTokens;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Jexactyl\Extensions\Laravel\Sanctum\NewAccessToken;

/**
 * @mixin \Jexactyl\Models\Model
 */
trait HasAccessTokens
{
    use HasApiTokens {
        tokens as private _tokens;
        createToken as private _createToken;
    }

    public function tokens(): HasMany
    {
        return $this->hasMany(Sanctum::$personalAccessTokenModel);
    }

    public function createToken(?string $memo, ?array $ips): NewAccessToken
    {
        /** @var \Jexactyl\Models\ApiKey $token */
        $token = $this->tokens()->forceCreate([
            'user_id' => $this->id,
            'key_type' => ApiKey::TYPE_ACCOUNT,
            'identifier' => ApiKey::generateTokenIdentifier(ApiKey::TYPE_ACCOUNT),
            'token' => encrypt($plain = Str::random(ApiKey::KEY_LENGTH)),
            'memo' => $memo ?? '',
            'allowed_ips' => $ips ?? [],
        ]);

        return new NewAccessToken($token, $plain);
    }
}
</file>

<file path="app/Models/ActivityLog.php">
<?php

namespace Jexactyl\Models;

use Carbon\Carbon;
use Jexactyl\Events\ActivityLogged;
use Illuminate\Support\Facades\Event;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Eloquent\MassPrunable;
use Illuminate\Database\Eloquent\Relations\HasOne;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\Relations\MorphTo;
use Illuminate\Database\Eloquent\Model as IlluminateModel;

/**
 * \Jexactyl\Models\ActivityLog.
 *
 * @property int $id
 * @property string|null $batch
 * @property string $event
 * @property string $ip
 * @property string|null $description
 * @property string|null $actor_type
 * @property int|null $actor_id
 * @property int|null $api_key_id
 * @property \Illuminate\Support\Collection|null $properties
 * @property \Carbon\Carbon $timestamp
 * @property IlluminateModel|\Eloquent $actor
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\ActivityLogSubject[] $subjects
 * @property int|null $subjects_count
 * @property \Jexactyl\Models\ApiKey|null $apiKey
 *
 * @method static Builder|ActivityLog forActor(\Illuminate\Database\Eloquent\Model $actor)
 * @method static Builder|ActivityLog forEvent(string $action)
 * @method static Builder|ActivityLog newModelQuery()
 * @method static Builder|ActivityLog newQuery()
 * @method static Builder|ActivityLog query()
 * @method static Builder|ActivityLog whereActorId($value)
 * @method static Builder|ActivityLog whereActorType($value)
 * @method static Builder|ActivityLog whereApiKeyId($value)
 * @method static Builder|ActivityLog whereBatch($value)
 * @method static Builder|ActivityLog whereDescription($value)
 * @method static Builder|ActivityLog whereEvent($value)
 * @method static Builder|ActivityLog whereId($value)
 * @method static Builder|ActivityLog whereIp($value)
 * @method static Builder|ActivityLog whereProperties($value)
 * @method static Builder|ActivityLog whereTimestamp($value)
 *
 * @mixin \Eloquent
 */
class ActivityLog extends Model
{
    use MassPrunable;

    public const RESOURCE_NAME = 'activity_log';

    /**
     * Tracks all the events we no longer wish to display to users. These are either legacy
     * events or just events where we never ended up using the associated data.
     */
    public const DISABLED_EVENTS = ['server:file.upload'];

    public $timestamps = false;

    protected $guarded = [
        'id',
        'timestamp',
    ];

    protected $casts = [
        'properties' => 'collection',
        'timestamp' => 'datetime',
    ];

    protected $with = ['subjects'];

    public static array $validationRules = [
        'event' => ['required', 'string'],
        'batch' => ['nullable', 'uuid'],
        'ip' => ['required', 'string'],
        'description' => ['nullable', 'string'],
        'properties' => ['array'],
    ];

    public function actor(): MorphTo
    {
        $morph = $this->morphTo();
        if (method_exists($morph, 'withTrashed')) {
            return $morph->withTrashed();
        }

        return $morph;
    }

    public function subjects(): HasMany
    {
        return $this->hasMany(ActivityLogSubject::class);
    }

    public function apiKey(): HasOne
    {
        return $this->hasOne(ApiKey::class, 'id', 'api_key_id');
    }

    public function scopeForEvent(Builder $builder, string $action): Builder
    {
        return $builder->where('event', $action);
    }

    /**
     * Scopes a query to only return results where the actor is a given model.
     */
    public function scopeForActor(Builder $builder, IlluminateModel $actor): Builder
    {
        return $builder->whereMorphedTo('actor', $actor);
    }

    /**
     * Returns models to be pruned.
     *
     * @see https://laravel.com/docs/9.x/eloquent#pruning-models
     */
    public function prunable()
    {
        if (is_null(config('activity.prune_days'))) {
            throw new \LogicException('Cannot prune activity logs: no "prune_days" configuration value is set.');
        }

        return static::where('timestamp', '<=', Carbon::now()->subDays(config('activity.prune_days')));
    }

    /**
     * Boots the model event listeners. This will trigger an activity log event every
     * time a new model is inserted which can then be captured and worked with as needed.
     */
    protected static function boot()
    {
        parent::boot();

        static::created(function (self $model) {
            Event::dispatch(new ActivityLogged($model));
        });
    }
}
</file>

<file path="app/Models/ActivityLogSubject.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\Relations\Pivot;

/**
 * \Jexactyl\Models\ActivityLogSubject.
 *
 * @property int $id
 * @property int $activity_log_id
 * @property int $subject_id
 * @property string $subject_type
 * @property \Jexactyl\Models\ActivityLog|null $activityLog
 * @property \Illuminate\Database\Eloquent\Model|\Eloquent $subject
 *
 * @method static \Illuminate\Database\Eloquent\Builder|ActivityLogSubject newModelQuery()
 * @method static \Illuminate\Database\Eloquent\Builder|ActivityLogSubject newQuery()
 * @method static \Illuminate\Database\Eloquent\Builder|ActivityLogSubject query()
 *
 * @mixin \Eloquent
 */
class ActivityLogSubject extends Pivot
{
    public $incrementing = true;
    public $timestamps = false;

    protected $table = 'activity_log_subjects';

    protected $guarded = ['id'];

    public function activityLog()
    {
        return $this->belongsTo(ActivityLog::class);
    }

    public function subject()
    {
        $morph = $this->morphTo();
        if (method_exists($morph, 'withTrashed')) {
            return $morph->withTrashed();
        }

        return $morph;
    }
}
</file>

<file path="app/Models/Allocation.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\Relations\BelongsTo;

/**
 * Jexactyl\Models\Allocation.
 *
 * @property int $id
 * @property int $node_id
 * @property string $ip
 * @property string|null $ip_alias
 * @property int $port
 * @property int|null $server_id
 * @property string|null $notes
 * @property \Carbon\Carbon|null $created_at
 * @property \Carbon\Carbon|null $updated_at
 * @property string $alias
 * @property bool $has_alias
 * @property \Jexactyl\Models\Server|null $server
 * @property \Jexactyl\Models\Node $node
 * @property string $hashid
 *
 * @method static \Database\Factories\AllocationFactory factory(...$parameters)
 * @method static \Illuminate\Database\Eloquent\Builder|Allocation newModelQuery()
 * @method static \Illuminate\Database\Eloquent\Builder|Allocation newQuery()
 * @method static \Illuminate\Database\Eloquent\Builder|Allocation query()
 * @method static \Illuminate\Database\Eloquent\Builder|Allocation whereCreatedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Allocation whereId($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Allocation whereIp($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Allocation whereIpAlias($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Allocation whereNodeId($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Allocation whereNotes($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Allocation wherePort($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Allocation whereServerId($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Allocation whereUpdatedAt($value)
 *
 * @mixin \Eloquent
 */
class Allocation extends Model
{
    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'allocation';

    /**
     * The table associated with the model.
     */
    protected $table = 'allocations';

    /**
     * Fields that are not mass assignable.
     */
    protected $guarded = ['id', 'created_at', 'updated_at'];

    /**
     * Cast values to correct type.
     */
    protected $casts = [
        'node_id' => 'integer',
        'port' => 'integer',
        'server_id' => 'integer',
    ];

    public static array $validationRules = [
        'node_id' => 'required|exists:nodes,id',
        'ip' => 'required|ip',
        'port' => 'required|numeric|between:1024,65535',
        'ip_alias' => 'nullable|string',
        'server_id' => 'nullable|exists:servers,id',
        'notes' => 'nullable|string|max:256',
    ];

    /**
     * {@inheritDoc}
     */
    public function getRouteKeyName(): string
    {
        return $this->getKeyName();
    }

    /**
     * Return a hashid encoded string to represent the ID of the allocation.
     */
    public function getHashidAttribute(): string
    {
        return app()->make('hashids')->encode($this->id);
    }

    /**
     * Accessor to automatically provide the IP alias if defined.
     */
    public function getAliasAttribute(?string $value): string
    {
        return (is_null($this->ip_alias)) ? $this->ip : $this->ip_alias;
    }

    /**
     * Accessor to quickly determine if this allocation has an alias.
     */
    public function getHasAliasAttribute(?string $value): bool
    {
        return !is_null($this->ip_alias);
    }

    public function toString(): string
    {
        return sprintf('%s:%s', $this->ip, $this->port);
    }

    /**
     * Gets information for the server associated with this allocation.
     */
    public function server(): BelongsTo
    {
        return $this->belongsTo(Server::class);
    }

    /**
     * Return the Node model associated with this allocation.
     */
    public function node(): BelongsTo
    {
        return $this->belongsTo(Node::class);
    }
}
</file>

<file path="app/Models/AnalyticsData.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Support\Carbon;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Factories\HasFactory;

/**
 * @property int $id
 * @property int $server_id
 * @property int $cpu
 * @property int $memory
 * @property int $disk
 * @property Carbon|null $created_at
 * @property Carbon|null $updated_at
 */
class AnalyticsData extends Model
{
    use HasFactory;

    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'analytics_data';

    /**
     * The table associated with the model.
     */
    protected $table = 'analytics_data';

    /**
     * The attributes that should be mutated to dates.
     */
    protected $dates = [self::CREATED_AT, self::UPDATED_AT];

    /**
     * Fields that are not mass assignable.
     */
    protected $guarded = ['id', self::CREATED_AT, self::UPDATED_AT];

    /**
     * Fields that are mass-assignable.
     */
    protected $fillable = ['server_id', 'cpu', 'memory', 'disk'];

    /**
     * Rules verifying that the data being stored matches the expectations of the database.
     */
    public static array $validationRules = [
        'server_id' => 'required|int|unique:servers,id',
        'cpu' => 'required|int|min:0|max:100',
        'memory' => 'required|int|min:0|max:100',
        'disk' => 'required|int|min:0|max:100',
    ];

    public function server(): BelongsTo
    {
        return $this->belongsTo(Server::class, 'server_id');
    }
}
</file>

<file path="app/Models/AnalyticsMessage.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Support\Carbon;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Factories\HasFactory;

/**
 * @property int $id
 * @property int $server_id
 * @property string $title
 * @property string $content
 * @property string $type
 * @property Carbon|null $created_at
 * @property Carbon|null $updated_at
 */
class AnalyticsMessage extends Model
{
    use HasFactory;

    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'analytics_message';

    /**
     * The table associated with the model.
     */
    protected $table = 'analytics_messages';

    /**
     * The attributes that should be mutated to dates.
     */
    protected $dates = [self::CREATED_AT, self::UPDATED_AT];

    /**
     * Fields that are not mass assignable.
     */
    protected $guarded = ['id', self::CREATED_AT, self::UPDATED_AT];

    /**
     * Fields that are mass-assignable.
     */
    protected $fillable = ['server_id', 'title', 'content', 'type'];

    /**
     * Rules verifying that the data being stored matches the expectations of the database.
     */
    public static array $validationRules = [
        'server_id' => 'required|int|unique:servers,id',
        'title' => 'required|string|min:3|max:191',
        'content' => 'required|string|min:3|max:191',
        'type' => 'required|in:success,info,warning,danger',
    ];

    public function server(): BelongsTo
    {
        return $this->belongsTo(Server::class, 'server_id');
    }
}
</file>

<file path="app/Models/ApiKey.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Support\Str;
use Webmozart\Assert\Assert;
use Jexactyl\Services\Acl\Api\AdminAcl;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

/**
 * Jexactyl\Models\ApiKey.
 *
 * @property int $id
 * @property int $user_id
 * @property int $key_type
 * @property string $identifier
 * @property string $token
 * @property array|null $allowed_ips
 * @property string|null $memo
 * @property \Illuminate\Support\Carbon|null $last_used_at
 * @property \Illuminate\Support\Carbon|null $created_at
 * @property \Illuminate\Support\Carbon|null $updated_at
 * @property int $r_servers
 * @property int $r_nodes
 * @property int $r_allocations
 * @property int $r_users
 * @property int $r_locations
 * @property int $r_nests
 * @property int $r_eggs
 * @property int $r_database_hosts
 * @property int $r_server_databases
 * @property \Jexactyl\Models\User $tokenable
 * @property \Jexactyl\Models\User $user
 *
 * @method static \Database\Factories\ApiKeyFactory factory(...$parameters)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey newModelQuery()
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey newQuery()
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey query()
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereAllowedIps($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereCreatedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereId($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereIdentifier($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereKeyType($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereLastUsedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereMemo($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereRAllocations($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereRDatabaseHosts($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereREggs($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereRLocations($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereRNests($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereRNodes($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereRServerDatabases($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereRServers($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereRUsers($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereToken($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereUpdatedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder|ApiKey whereUserId($value)
 *
 * @mixin \Eloquent
 */
class ApiKey extends Model
{
    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'api_key';
    /**
     * Different API keys that can exist on the system.
     */
    public const TYPE_NONE = 0;
    public const TYPE_ACCOUNT = 1;
    /* @deprecated */
    public const TYPE_APPLICATION = 2;
    /* @deprecated */
    public const TYPE_DAEMON_USER = 3;
    /* @deprecated */
    public const TYPE_DAEMON_APPLICATION = 4;
    /**
     * The length of API key identifiers.
     */
    public const IDENTIFIER_LENGTH = 16;
    /**
     * The length of the actual API key that is encrypted and stored
     * in the database.
     */
    public const KEY_LENGTH = 32;

    /**
     * The table associated with the model.
     */
    protected $table = 'api_keys';

    /**
     * Cast values to correct type.
     */
    protected $casts = [
        'allowed_ips' => 'array',
        'user_id' => 'int',
        'r_' . AdminAcl::RESOURCE_USERS => 'int',
        'r_' . AdminAcl::RESOURCE_ALLOCATIONS => 'int',
        'r_' . AdminAcl::RESOURCE_DATABASE_HOSTS => 'int',
        'r_' . AdminAcl::RESOURCE_SERVER_DATABASES => 'int',
        'r_' . AdminAcl::RESOURCE_EGGS => 'int',
        'r_' . AdminAcl::RESOURCE_LOCATIONS => 'int',
        'r_' . AdminAcl::RESOURCE_NESTS => 'int',
        'r_' . AdminAcl::RESOURCE_NODES => 'int',
        'r_' . AdminAcl::RESOURCE_SERVERS => 'int',
    ];

    /**
     * Fields that are mass assignable.
     */
    protected $fillable = [
        'identifier',
        'token',
        'allowed_ips',
        'memo',
        'last_used_at',
    ];

    /**
     * Fields that should not be included when calling toArray() or toJson()
     * on this model.
     */
    protected $hidden = ['token'];

    /**
     * Rules to protect against invalid data entry to DB.
     */
    public static array $validationRules = [
        'user_id' => 'required|exists:users,id',
        'key_type' => 'present|integer|min:0|max:4',
        'identifier' => 'required|string|size:16|unique:api_keys,identifier',
        'token' => 'required|string',
        'memo' => 'required|nullable|string|max:500',
        'allowed_ips' => 'nullable|array',
        'allowed_ips.*' => 'string',
        'last_used_at' => 'nullable|date',
        'r_' . AdminAcl::RESOURCE_USERS => 'integer|min:0|max:3',
        'r_' . AdminAcl::RESOURCE_ALLOCATIONS => 'integer|min:0|max:3',
        'r_' . AdminAcl::RESOURCE_DATABASE_HOSTS => 'integer|min:0|max:3',
        'r_' . AdminAcl::RESOURCE_SERVER_DATABASES => 'integer|min:0|max:3',
        'r_' . AdminAcl::RESOURCE_EGGS => 'integer|min:0|max:3',
        'r_' . AdminAcl::RESOURCE_LOCATIONS => 'integer|min:0|max:3',
        'r_' . AdminAcl::RESOURCE_NESTS => 'integer|min:0|max:3',
        'r_' . AdminAcl::RESOURCE_NODES => 'integer|min:0|max:3',
        'r_' . AdminAcl::RESOURCE_SERVERS => 'integer|min:0|max:3',
    ];

    protected $dates = [
        self::CREATED_AT,
        self::UPDATED_AT,
        'last_used_at',
    ];

    /**
     * Returns the user this token is assigned to.
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class);
    }

    /**
     * Required for support with Laravel Sanctum.
     *
     * @see \Laravel\Sanctum\Guard::supportsTokens()
     */
    public function tokenable(): BelongsTo
    {
        return $this->user();
    }

    /**
     * Finds the model matching the provided token.
     */
    public static function findToken(string $token): ?self
    {
        $identifier = substr($token, 0, self::IDENTIFIER_LENGTH);

        $model = static::where('identifier', $identifier)->first();
        if (!is_null($model) && decrypt($model->token) === substr($token, strlen($identifier))) {
            return $model;
        }

        return null;
    }

    /**
     * Returns the standard prefix for API keys in the system.
     */
    public static function getPrefixForType(int $type): string
    {
        Assert::oneOf($type, [self::TYPE_ACCOUNT, self::TYPE_APPLICATION]);

        return $type === self::TYPE_ACCOUNT ? 'ptlc_' : 'ptla_';
    }

    /**
     * Generates a new identifier for an API key.
     */
    public static function generateTokenIdentifier(int $type): string
    {
        $prefix = self::getPrefixForType($type);

        return $prefix . Str::random(self::IDENTIFIER_LENGTH - strlen($prefix));
    }
}
</file>

<file path="app/Models/APILog.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\Model;

class APILog extends Model
{
    /**
     * The table associated with the model.
     */
    protected $table = 'api_logs';

    /**
     * The attributes excluded from the model's JSON form.
     */
    protected $hidden = [];

    /**
     * Fields that are not mass assignable.
     */
    protected $guarded = ['id', 'created_at', 'updated_at'];

    /**
     * Cast values to correct type.
     */
    protected $casts = [
        'authorized' => 'boolean',
    ];
}
</file>

<file path="app/Models/Backup.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

/**
 * @property int $id
 * @property int $server_id
 * @property string $uuid
 * @property bool $is_successful
 * @property bool $is_locked
 * @property string $name
 * @property string[] $ignored_files
 * @property string $disk
 * @property string|null $checksum
 * @property int $bytes
 * @property string|null $upload_id
 * @property \Carbon\CarbonImmutable|null $completed_at
 * @property \Carbon\CarbonImmutable $created_at
 * @property \Carbon\CarbonImmutable $updated_at
 * @property \Carbon\CarbonImmutable|null $deleted_at
 * @property \Jexactyl\Models\Server $server
 * @property \Jexactyl\Models\AuditLog[] $audits
 */
class Backup extends Model
{
    use SoftDeletes;

    public const RESOURCE_NAME = 'backup';

    public const ADAPTER_WINGS = 'wings';
    public const ADAPTER_AWS_S3 = 's3';

    protected $table = 'backups';

    protected bool $immutableDates = true;

    protected $casts = [
        'id' => 'int',
        'is_successful' => 'bool',
        'is_locked' => 'bool',
        'ignored_files' => 'array',
        'bytes' => 'int',
    ];

    protected $dates = [
        'completed_at',
    ];

    protected $attributes = [
        'is_successful' => false,
        'is_locked' => false,
        'checksum' => null,
        'bytes' => 0,
        'upload_id' => null,
    ];

    protected $guarded = ['id', 'created_at', 'updated_at', 'deleted_at'];

    public static array $validationRules = [
        'server_id' => 'bail|required|numeric|exists:servers,id',
        'uuid' => 'required|uuid',
        'is_successful' => 'boolean',
        'is_locked' => 'boolean',
        'name' => 'required|string',
        'ignored_files' => 'array',
        'disk' => 'required|string',
        'checksum' => 'nullable|string',
        'bytes' => 'numeric',
        'upload_id' => 'nullable|string',
    ];

    public function server(): BelongsTo
    {
        return $this->belongsTo(Server::class);
    }
}
</file>

<file path="app/Models/Coupon.php">
<?php

namespace Jexactyl\Models;

/**
 * @property string $code
 * @property int $uses
 * @property int $expires
 * @property int $cr_amount
 */
class Coupon extends Model
{
    public const RESOURCE_NAME = 'coupon';
    protected $table = 'coupons';

    protected $fillable = [
        'expired',
    ];

    public static array $validationRules = [
        'code' => 'required|string',
        'uses' => 'required|integer',
        'expires' => 'nullable|string',
        'expired' => 'nullable|boolean',
        'cr_amount' => 'required|integer',
    ];
}
</file>

<file path="app/Models/Database.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Container\Container;
use Jexactyl\Contracts\Extensions\HashidsInterface;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

/**
 * @property int $id
 * @property int $server_id
 * @property int $database_host_id
 * @property string $database
 * @property string $username
 * @property string $remote
 * @property string $password
 * @property int $max_connections
 * @property \Carbon\Carbon $created_at
 * @property \Carbon\Carbon $updated_at
 * @property \Jexactyl\Models\Server $server
 * @property \Jexactyl\Models\DatabaseHost $host
 */
class Database extends Model
{
    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'server_database';

    /**
     * The table associated with the model.
     */
    protected $table = 'databases';

    /**
     * The attributes excluded from the model's JSON form.
     */
    protected $hidden = ['password'];

    /**
     * Fields that are mass assignable.
     */
    protected $fillable = [
        'server_id', 'database_host_id', 'database', 'username', 'password', 'remote', 'max_connections',
    ];

    /**
     * Cast values to correct type.
     */
    protected $casts = [
        'server_id' => 'integer',
        'database_host_id' => 'integer',
        'max_connections' => 'integer',
    ];

    public static array $validationRules = [
        'server_id' => 'required|numeric|exists:servers,id',
        'database_host_id' => 'required|exists:database_hosts,id',
        'database' => 'required|string|alpha_dash|between:3,48',
        'username' => 'string|alpha_dash|between:3,100',
        'max_connections' => 'nullable|integer',
        'remote' => 'required|string|regex:/^[\w\-\/.%:]+$/',
        'password' => 'string',
    ];

    /**
     * {@inheritDoc}
     */
    public function getRouteKeyName(): string
    {
        return $this->getKeyName();
    }

    /**
     * Resolves the database using the ID by checking if the value provided is a HashID
     * string value, or just the ID to the database itself.
     *
     * @param mixed $value
     * @param string|null $field
     *
     * @throws \Illuminate\Contracts\Container\BindingResolutionException
     */
    public function resolveRouteBinding($value, $field = null): ?\Illuminate\Database\Eloquent\Model
    {
        if (is_scalar($value) && ($field ?? $this->getRouteKeyName()) === 'id') {
            $value = ctype_digit((string) $value)
                ? $value
                : Container::getInstance()->make(HashidsInterface::class)->decodeFirst($value);
        }

        return $this->where($field ?? $this->getRouteKeyName(), $value)->firstOrFail();
    }

    /**
     * Gets the host database server associated with a database.
     */
    public function host(): BelongsTo
    {
        return $this->belongsTo(DatabaseHost::class, 'database_host_id');
    }

    /**
     * Gets the server associated with a database.
     */
    public function server(): BelongsTo
    {
        return $this->belongsTo(Server::class);
    }
}
</file>

<file path="app/Models/DatabaseHost.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

/**
 * @property int $id
 * @property string $name
 * @property string $host
 * @property int $port
 * @property string $username
 * @property string $password
 * @property int|null $max_databases
 * @property int|null $node_id
 * @property \Carbon\CarbonImmutable $created_at
 * @property \Carbon\CarbonImmutable $updated_at
 */
class DatabaseHost extends Model
{
    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'database_host';

    protected bool $immutableDates = true;

    /**
     * The table associated with the model.
     */
    protected $table = 'database_hosts';

    /**
     * The attributes excluded from the model's JSON form.
     */
    protected $hidden = ['password'];

    /**
     * Fields that are mass assignable.
     */
    protected $fillable = [
        'name', 'host', 'port', 'username', 'password', 'max_databases', 'node_id',
    ];

    /**
     * Cast values to correct type.
     */
    protected $casts = [
        'id' => 'integer',
        'max_databases' => 'integer',
        'node_id' => 'integer',
    ];

    /**
     * Validation rules to assign to this model.
     */
    public static array $validationRules = [
        'name' => 'required|string|max:191',
        'host' => 'required|string',
        'port' => 'required|numeric|between:1,65535',
        'username' => 'required|string|max:32',
        'password' => 'nullable|string',
        'node_id' => 'sometimes|nullable|integer|exists:nodes,id',
    ];

    /**
     * Gets the node associated with a database host.
     */
    public function node(): BelongsTo
    {
        return $this->belongsTo(Node::class);
    }

    /**
     * Gets the databases associated with this host.
     */
    public function databases(): HasMany
    {
        return $this->hasMany(Database::class);
    }
}
</file>

<file path="app/Models/Egg.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

/**
 * @property int $id
 * @property string $uuid
 * @property int $nest_id
 * @property string $author
 * @property string $name
 * @property string|null $description
 * @property array|null $features
 * @property string $docker_image -- deprecated, use $docker_images
 * @property array<string, string> $docker_images
 * @property string $update_url
 * @property bool $force_outgoing_ip
 * @property array|null $file_denylist
 * @property string|null $config_files
 * @property string|null $config_startup
 * @property string|null $config_logs
 * @property string|null $config_stop
 * @property int|null $config_from
 * @property string|null $startup
 * @property bool $script_is_privileged
 * @property string|null $script_install
 * @property string $script_entry
 * @property string $script_container
 * @property int|null $copy_script_from
 * @property \Carbon\Carbon $created_at
 * @property \Carbon\Carbon $updated_at
 * @property string|null $copy_script_install
 * @property string $copy_script_entry
 * @property string $copy_script_container
 * @property string|null $inherit_config_files
 * @property string|null $inherit_config_startup
 * @property string|null $inherit_config_logs
 * @property string|null $inherit_config_stop
 * @property string $inherit_file_denylist
 * @property array|null $inherit_features
 * @property \Jexactyl\Models\Nest $nest
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\Server[] $servers
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\EggVariable[] $variables
 * @property \Jexactyl\Models\Egg|null $scriptFrom
 * @property \Jexactyl\Models\Egg|null $configFrom
 */
class Egg extends Model
{
    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'egg';

    /**
     * Defines the current egg export version.
     */
    public const EXPORT_VERSION = 'PTDL_v2';

    /**
     * Different features that can be enabled on any given egg. These are used internally
     * to determine which types of frontend functionality should be shown to the user. Eggs
     * will automatically inherit features from a parent egg if they are already configured
     * to copy configuration values from said egg.
     *
     * To skip copying the features, an empty array value should be passed in ("[]") rather
     * than leaving it null.
     */
    public const FEATURE_EULA_POPUP = 'eula';
    public const FEATURE_FASTDL = 'fastdl';

    /**
     * The table associated with the model.
     */
    protected $table = 'eggs';

    /**
     * Fields that are not mass assignable.
     */
    protected $fillable = [
        'name',
        'description',
        'features',
        'docker_images',
        'force_outgoing_ip',
        'file_denylist',
        'config_files',
        'config_startup',
        'config_logs',
        'config_stop',
        'config_from',
        'startup',
        'script_is_privileged',
        'script_install',
        'script_entry',
        'script_container',
        'copy_script_from',
    ];

    /**
     * Cast values to correct type.
     */
    protected $casts = [
        'nest_id' => 'integer',
        'config_from' => 'integer',
        'script_is_privileged' => 'boolean',
        'force_outgoing_ip' => 'boolean',
        'copy_script_from' => 'integer',
        'features' => 'array',
        'docker_images' => 'array',
        'file_denylist' => 'array',
    ];

    public static array $validationRules = [
        'nest_id' => 'required|bail|numeric|exists:nests,id',
        'uuid' => 'required|string|size:36',
        'name' => 'required|string|max:191',
        'description' => 'string|nullable',
        'features' => 'array|nullable',
        'author' => 'required|string|email',
        'file_denylist' => 'array|nullable',
        'file_denylist.*' => 'string',
        'docker_images' => 'required|array|min:1',
        'docker_images.*' => 'required|string',
        'startup' => 'required|nullable|string',
        'config_from' => 'sometimes|bail|nullable|numeric|exists:eggs,id',
        'config_stop' => 'required_without:config_from|nullable|string|max:191',
        'config_startup' => 'required_without:config_from|nullable|json',
        'config_logs' => 'required_without:config_from|nullable|json',
        'config_files' => 'required_without:config_from|nullable|json',
        'update_url' => 'sometimes|nullable|string',
        'force_outgoing_ip' => 'sometimes|boolean',
    ];

    protected $attributes = [
        'features' => null,
        'file_denylist' => null,
        'config_stop' => null,
        'config_startup' => null,
        'config_logs' => null,
        'config_files' => null,
        'update_url' => null,
    ];

    /**
     * Returns the install script for the egg; if egg is copying from another
     * it will return the copied script.
     */
    public function getCopyScriptInstallAttribute(): ?string
    {
        if (!is_null($this->script_install) || is_null($this->copy_script_from)) {
            return $this->script_install;
        }

        return $this->scriptFrom->script_install;
    }

    /**
     * Returns the entry command for the egg; if egg is copying from another
     * it will return the copied entry command.
     */
    public function getCopyScriptEntryAttribute(): string
    {
        if (!is_null($this->script_entry) || is_null($this->copy_script_from)) {
            return $this->script_entry;
        }

        return $this->scriptFrom->script_entry;
    }

    /**
     * Returns the install container for the egg; if egg is copying from another
     * it will return the copied install container.
     */
    public function getCopyScriptContainerAttribute(): string
    {
        if (!is_null($this->script_container) || is_null($this->copy_script_from)) {
            return $this->script_container;
        }

        return $this->scriptFrom->script_container;
    }

    /**
     * Return the file configuration for an egg.
     */
    public function getInheritConfigFilesAttribute(): ?string
    {
        if (!is_null($this->config_files) || is_null($this->config_from)) {
            return $this->config_files;
        }

        return $this->configFrom->config_files;
    }

    /**
     * Return the startup configuration for an egg.
     */
    public function getInheritConfigStartupAttribute(): ?string
    {
        if (!is_null($this->config_startup) || is_null($this->config_from)) {
            return $this->config_startup;
        }

        return $this->configFrom->config_startup;
    }

    /**
     * Return the log reading configuration for an egg.
     */
    public function getInheritConfigLogsAttribute(): ?string
    {
        if (!is_null($this->config_logs) || is_null($this->config_from)) {
            return $this->config_logs;
        }

        return $this->configFrom->config_logs;
    }

    /**
     * Return the stop command configuration for an egg.
     */
    public function getInheritConfigStopAttribute(): ?string
    {
        if (!is_null($this->config_stop) || is_null($this->config_from)) {
            return $this->config_stop;
        }

        return $this->configFrom->config_stop;
    }

    /**
     * Returns the features available to this egg from the parent configuration if there are
     * no features defined for this egg specifically and there is a parent egg configured.
     */
    public function getInheritFeaturesAttribute(): ?array
    {
        if (!is_null($this->features) || is_null($this->config_from)) {
            return $this->features;
        }

        return $this->configFrom->features;
    }

    /**
     * Returns the features available to this egg from the parent configuration if there are
     * no features defined for this egg specifically and there is a parent egg configured.
     */
    public function getInheritFileDenylistAttribute(): ?array
    {
        if (is_null($this->config_from)) {
            return $this->file_denylist;
        }

        return $this->configFrom->file_denylist;
    }

    /**
     * Gets nest associated with an egg.
     */
    public function nest(): BelongsTo
    {
        return $this->belongsTo(Nest::class);
    }

    /**
     * Gets all servers associated with this egg.
     */
    public function servers(): HasMany
    {
        return $this->hasMany(Server::class, 'egg_id');
    }

    /**
     * Gets all variables associated with this egg.
     */
    public function variables(): HasMany
    {
        return $this->hasMany(EggVariable::class, 'egg_id');
    }

    /**
     * Get the parent egg from which to copy scripts.
     */
    public function scriptFrom(): BelongsTo
    {
        return $this->belongsTo(self::class, 'copy_script_from');
    }

    /**
     * Get the parent egg from which to copy configuration settings.
     */
    public function configFrom(): BelongsTo
    {
        return $this->belongsTo(self::class, 'config_from');
    }
}
</file>

<file path="app/Models/EggMount.php">
<?php

namespace Jexactyl\Models;

class EggMount extends Model
{
    protected $table = 'egg_mount';

    protected $primaryKey = null;

    public $incrementing = false;
}
</file>

<file path="app/Models/EggVariable.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\Relations\HasOne;
use Illuminate\Database\Eloquent\Relations\HasMany;

/**
 * @property int $id
 * @property int $egg_id
 * @property string $name
 * @property string $description
 * @property string $env_variable
 * @property string $default_value
 * @property bool $user_viewable
 * @property bool $user_editable
 * @property string $rules
 * @property \Carbon\CarbonImmutable $created_at
 * @property \Carbon\CarbonImmutable $updated_at
 * @property bool $required
 * @property \Jexactyl\Models\Egg $egg
 * @property \Jexactyl\Models\ServerVariable $serverVariable
 *
 * The "server_value" variable is only present on the object if you've loaded this model
 * using the server relationship.
 * @property string|null $server_value
 */
class EggVariable extends Model
{
    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'egg_variable';

    /**
     * Reserved environment variable names.
     */
    public const RESERVED_ENV_NAMES = 'SERVER_MEMORY,SERVER_IP,SERVER_PORT,ENV,HOME,USER,STARTUP,SERVER_UUID,UUID';

    protected bool $immutableDates = true;

    /**
     * The table associated with the model.
     */
    protected $table = 'egg_variables';

    /**
     * Fields that are not mass assignable.
     */
    protected $guarded = ['id', 'created_at', 'updated_at'];

    /**
     * Cast values to correct type.
     */
    protected $casts = [
        'egg_id' => 'integer',
        'user_viewable' => 'bool',
        'user_editable' => 'bool',
    ];

    public static array $validationRules = [
        'egg_id' => 'exists:eggs,id',
        'name' => 'required|string|between:1,191',
        'description' => 'string',
        'env_variable' => 'required|regex:/^[\w]{1,191}$/|notIn:' . self::RESERVED_ENV_NAMES,
        'default_value' => 'string',
        'user_viewable' => 'boolean',
        'user_editable' => 'boolean',
        'rules' => 'required|string',
    ];

    protected $attributes = [
        'user_editable' => 0,
        'user_viewable' => 0,
    ];

    public function getRequiredAttribute(): bool
    {
        return in_array('required', explode('|', $this->rules));
    }

    public function egg(): HasOne
    {
        return $this->hasOne(Egg::class);
    }

    /**
     * Return server variables associated with this variable.
     */
    public function serverVariable(): HasMany
    {
        return $this->hasMany(ServerVariable::class, 'variable_id');
    }
}
</file>

<file path="app/Models/Location.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\Relations\HasManyThrough;

/**
 * @property int $id
 * @property string $short
 * @property string $long
 * @property \Carbon\Carbon $created_at
 * @property \Carbon\Carbon $updated_at
 * @property \Jexactyl\Models\Node[] $nodes
 * @property \Jexactyl\Models\Server[] $servers
 */
class Location extends Model
{
    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'location';

    /**
     * The table associated with the model.
     */
    protected $table = 'locations';

    /**
     * Fields that are not mass assignable.
     */
    protected $guarded = ['id', 'created_at', 'updated_at'];

    /**
     * Rules ensuring that the raw data stored in the database meets expectations.
     */
    public static array $validationRules = [
        'short' => 'required|string|between:1,60|unique:locations,short',
        'long' => 'string|nullable|between:1,191',
    ];

    /**
     * {@inheritDoc}
     */
    public function getRouteKeyName(): string
    {
        return $this->getKeyName();
    }

    /**
     * Gets the nodes in a specified location.
     */
    public function nodes(): HasMany
    {
        return $this->hasMany(Node::class);
    }

    /**
     * Gets the servers within a given location.
     */
    public function servers(): HasManyThrough
    {
        return $this->hasManyThrough(Server::class, Node::class);
    }
}
</file>

<file path="app/Models/Model.php">
<?php

namespace Jexactyl\Models;

use Carbon\CarbonImmutable;
use Illuminate\Support\Arr;
use Illuminate\Support\Str;
use Illuminate\Support\Carbon;
use Illuminate\Validation\Rule;
use Illuminate\Container\Container;
use Illuminate\Contracts\Validation\Validator;
use Illuminate\Validation\ValidationException;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Jexactyl\Exceptions\Model\DataValidationException;
use Illuminate\Database\Eloquent\Model as IlluminateModel;
use Illuminate\Contracts\Validation\Factory as ValidationFactory;

abstract class Model extends IlluminateModel
{
    use HasFactory;

    /**
     * Set to true to return immutable Carbon date instances from the model.
     */
    protected bool $immutableDates = false;

    /**
     * Determines if the model should undergo data validation before it is saved
     * to the database.
     */
    protected bool $skipValidation = false;

    protected static ValidationFactory $validatorFactory;

    public static array $validationRules = [];

    /**
     * Listen for the model saving event and fire off the validation
     * function before it is saved.
     *
     * @throws \Illuminate\Contracts\Container\BindingResolutionException
     */
    protected static function boot()
    {
        parent::boot();

        static::$validatorFactory = Container::getInstance()->make(ValidationFactory::class);

        static::saving(function (Model $model) {
            try {
                $model->validate();
            } catch (ValidationException $exception) {
                throw new DataValidationException($exception->validator, $model);
            }

            return true;
        });
    }

    /**
     * Returns the model key to use for route model binding. By default, we'll
     * assume every model uses a UUID field for this. If the model does not have
     * a UUID and is using a different key it should be specified on the model
     * itself.
     *
     * You may also optionally override this on a per-route basis by declaring
     * the key name in the URL definition, like "{user:id}".
     */
    public function getRouteKeyName(): string
    {
        return 'uuid';
    }

    /**
     * Set the model to skip validation when saving.
     */
    public function skipValidation(): self
    {
        $this->skipValidation = true;

        return $this;
    }

    /**
     * Returns the validator instance used by this model.
     */
    public function getValidator(): Validator
    {
        $rules = $this->exists ? static::getRulesForUpdate($this) : static::getRules();

        return static::$validatorFactory->make([], $rules, [], []);
    }

    /**
     * Returns the rules associated with this model.
     */
    public static function getRules(): array
    {
        $rules = static::$validationRules;
        foreach ($rules as $key => &$rule) {
            $rule = is_array($rule) ? $rule : explode('|', $rule);
        }

        return $rules;
    }

    /**
     * Returns the rules for a specific field. If the field is not found an empty
     * array is returned.
     */
    public static function getRulesForField(string $field): array
    {
        return Arr::get(static::getRules(), $field) ?? [];
    }

    /**
     * Returns the rules associated with the model, specifically for updating the given model
     * rather than just creating it.
     */
    public static function getRulesForUpdate($model, string $column = 'id'): array
    {
        if ($model instanceof Model) {
            [$id, $column] = [$model->getKey(), $model->getKeyName()];
        }

        $rules = static::getRules();
        foreach ($rules as $key => &$data) {
            // For each rule in a given field, iterate over it and confirm if the rule
            // is one for a unique field. If that is the case, append the ID of the current
            // working model, so we don't run into errors due to the way that field validation
            // works.
            foreach ($data as &$datum) {
                if (!is_string($datum) || !Str::startsWith($datum, 'unique')) {
                    continue;
                }

                [, $args] = explode(':', $datum);
                $args = explode(',', $args);

                $datum = Rule::unique($args[0], $args[1] ?? $key)->ignore($id ?? $model, $column);
            }
        }

        return $rules;
    }

    /**
     * Determines if the model is in a valid state or not.
     *
     * @throws \Illuminate\Validation\ValidationException
     */
    public function validate(): void
    {
        if ($this->skipValidation) {
            return;
        }

        $validator = $this->getValidator();
        $validator->setData(
            // Trying to do self::toArray() here will leave out keys based on the whitelist/blacklist
            // for that model. Doing this will return all the attributes in a format that can
            // properly be validated.
            $this->addCastAttributesToArray(
                $this->getAttributes(),
                $this->getMutatedAttributes()
            )
        );

        if (!$validator->passes()) {
            throw new ValidationException($validator);
        }
    }

    /**
     * Return a timestamp as DateTime object.
     *
     * @param mixed $value
     */
    protected function asDateTime($value): Carbon|CarbonImmutable
    {
        if (!$this->immutableDates) {
            return parent::asDateTime($value);
        }

        return parent::asDateTime($value)->toImmutable();
    }
}
</file>

<file path="app/Models/Mount.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Validation\Rules\NotIn;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;

/**
 * @property int $id
 * @property string $uuid
 * @property string $name
 * @property string $description
 * @property string $source
 * @property string $target
 * @property bool $read_only
 * @property bool $user_mountable
 * @property \Jexactyl\Models\Egg[]|\Illuminate\Database\Eloquent\Collection $eggs
 * @property \Jexactyl\Models\Node[]|\Illuminate\Database\Eloquent\Collection $nodes
 * @property \Jexactyl\Models\Server[]|\Illuminate\Database\Eloquent\Collection $servers
 */
class Mount extends Model
{
    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'mount';

    /**
     * The table associated with the model.
     */
    protected $table = 'mounts';

    /**
     * Fields that are not mass assignable.
     */
    protected $guarded = ['id', 'uuid'];

    /**
     * Default values for specific fields in the database.
     */
    protected $casts = [
        'id' => 'int',
        'read_only' => 'bool',
        'user_mountable' => 'bool',
    ];

    /**
     * Rules verifying that the data being stored matches the expectations of the database.
     */
    public static array $validationRules = [
        'name' => 'required|string|min:2|max:64|unique:mounts,name',
        'description' => 'nullable|string|max:191',
        'source' => 'required|string',
        'target' => 'required|string',
        'read_only' => 'sometimes|boolean',
        'user_mountable' => 'sometimes|boolean',
    ];

    /**
     * Implement language verification by overriding Eloquence's gather
     * rules function.
     */
    public static function getRules(): array
    {
        $rules = parent::getRules();

        $rules['source'][] = new NotIn(Mount::$invalidSourcePaths);
        $rules['target'][] = new NotIn(Mount::$invalidTargetPaths);

        return $rules;
    }

    /**
     * Disable timestamps on this model.
     */
    public $timestamps = false;

    /**
     * Blacklisted source paths.
     */
    public static $invalidSourcePaths = [
        '/etc/pterodactyl',
        '/var/lib/pterodactyl/volumes',
        '/srv/daemon-data',
    ];

    /**
     * Blacklisted target paths.
     */
    public static $invalidTargetPaths = [
        '/home/container',
    ];

    /**
     * Returns all eggs that have this mount assigned.
     */
    public function eggs(): BelongsToMany
    {
        return $this->belongsToMany(Egg::class);
    }

    /**
     * Returns all nodes that have this mount assigned.
     */
    public function nodes(): BelongsToMany
    {
        return $this->belongsToMany(Node::class);
    }

    /**
     * Returns all servers that have this mount assigned.
     */
    public function servers(): BelongsToMany
    {
        return $this->belongsToMany(Server::class);
    }
}
</file>

<file path="app/Models/MountNode.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\Model;

class MountNode extends Model
{
    protected $table = 'mount_node';

    protected $primaryKey = null;

    public $incrementing = false;
}
</file>

<file path="app/Models/MountServer.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\Model;

class MountServer extends Model
{
    protected $table = 'mount_server';

    public $timestamps = false;

    protected $primaryKey = null;

    public $incrementing = false;
}
</file>

<file path="app/Models/Nest.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\Relations\HasMany;

/**
 * @property int $id
 * @property bool $private
 * @property string $uuid
 * @property string $author
 * @property string $name
 * @property string|null $description
 * @property \Carbon\Carbon $created_at
 * @property \Carbon\Carbon $updated_at
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\Server[] $servers
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\Egg[] $eggs
 */
class Nest extends Model
{
    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'nest';

    /**
     * The table associated with the model.
     */
    protected $table = 'nests';

    /**
     * Fields that are mass assignable.
     */
    protected $fillable = [
        'name',
        'private',
        'description',
    ];

    public static array $validationRules = [
        'author' => 'required|string|email',
        'name' => 'required|string|max:191',
        'description' => 'nullable|string',
    ];

    /**
     * Gets all eggs associated with this service.
     */
    public function eggs(): HasMany
    {
        return $this->hasMany(Egg::class);
    }

    /**
     * Gets all servers associated with this nest.
     */
    public function servers(): HasMany
    {
        return $this->hasMany(Server::class);
    }
}
</file>

<file path="app/Models/Node.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Support\Str;
use Symfony\Component\Yaml\Yaml;
use Illuminate\Container\Container;
use Illuminate\Notifications\Notifiable;
use Illuminate\Contracts\Encryption\Encrypter;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\HasManyThrough;

/**
 * @property int $id
 * @property string $uuid
 * @property bool $public
 * @property bool $deployable
 * @property string $name
 * @property string|null $description
 * @property int $location_id
 * @property string $fqdn
 * @property string $scheme
 * @property bool $behind_proxy
 * @property bool $maintenance_mode
 * @property int $memory
 * @property int $memory_overallocate
 * @property int $disk
 * @property int $disk_overallocate
 * @property int|null $deploy_fee
 * @property int $upload_size
 * @property string $daemon_token_id
 * @property string $daemon_token
 * @property int $daemonListen
 * @property int $daemonSFTP
 * @property string $daemonBase
 * @property \Carbon\Carbon $created_at
 * @property \Carbon\Carbon $updated_at
 * @property \Jexactyl\Models\Location $location
 * @property \Jexactyl\Models\Mount[]|\Illuminate\Database\Eloquent\Collection $mounts
 * @property \Jexactyl\Models\Server[]|\Illuminate\Database\Eloquent\Collection $servers
 * @property \Jexactyl\Models\Allocation[]|\Illuminate\Database\Eloquent\Collection $allocations
 */
class Node extends Model
{
    use Notifiable;

    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'node';

    public const DAEMON_TOKEN_ID_LENGTH = 16;
    public const DAEMON_TOKEN_LENGTH = 64;

    /**
     * The table associated with the model.
     */
    protected $table = 'nodes';

    /**
     * The attributes excluded from the model's JSON form.
     */
    protected $hidden = ['daemon_token_id', 'daemon_token'];

    /**
     * Cast values to correct type.
     */
    protected $casts = [
        'location_id' => 'integer',
        'memory' => 'integer',
        'disk' => 'integer',
        'daemonListen' => 'integer',
        'daemonSFTP' => 'integer',
        'behind_proxy' => 'boolean',
        'deployable' => 'boolean',
        'public' => 'boolean',
        'maintenance_mode' => 'boolean',
    ];

    /**
     * Fields that are mass assignable.
     */
    protected $fillable = [
        'public', 'name', 'location_id',
        'fqdn', 'scheme', 'behind_proxy',
        'memory', 'memory_overallocate', 'disk',
        'disk_overallocate', 'upload_size', 'daemonBase',
        'daemonSFTP', 'daemonListen', 'deploy_fee',
        'description', 'maintenance_mode',
    ];

    public static array $validationRules = [
        'name' => 'required|regex:/^([\w .-]{1,100})$/',
        'description' => 'string|nullable',
        'location_id' => 'required|exists:locations,id',
        'deployable' => 'required|boolean',
        'public' => 'boolean',
        'fqdn' => 'required|string',
        'scheme' => 'required',
        'behind_proxy' => 'boolean',
        'memory' => 'required|numeric|min:1',
        'memory_overallocate' => 'required|numeric|min:-1',
        'disk' => 'required|numeric|min:1',
        'disk_overallocate' => 'required|numeric|min:-1',
        'deploy_fee' => 'nullable|int|min:0',
        'daemonBase' => 'sometimes|required|regex:/^([\/][\d\w.\-\/]+)$/',
        'daemonSFTP' => 'required|numeric|between:1,65535',
        'daemonListen' => 'required|numeric|between:1,65535',
        'maintenance_mode' => 'boolean',
        'upload_size' => 'int|between:1,1024',
    ];

    /**
     * Default values for specific columns that are generally not changed on base installs.
     */
    protected $attributes = [
        'deployable' => true,
        'public' => true,
        'behind_proxy' => false,
        'memory_overallocate' => 0,
        'disk_overallocate' => 0,
        'daemonBase' => '/var/lib/pterodactyl/volumes',
        'daemonSFTP' => 2022,
        'daemonListen' => 8080,
        'maintenance_mode' => false,
    ];

    /**
     * Get the connection address to use when making calls to this node.
     */
    public function getConnectionAddress(): string
    {
        return sprintf('%s://%s:%s', $this->scheme, $this->fqdn, $this->daemonListen);
    }

    /**
     * Returns the configuration as an array.
     */
    public function getConfiguration(): array
    {
        return [
            'debug' => false,
            'uuid' => $this->uuid,
            'token_id' => $this->daemon_token_id,
            'token' => Container::getInstance()->make(Encrypter::class)->decrypt($this->daemon_token),
            'api' => [
                'host' => '0.0.0.0',
                'port' => $this->daemonListen,
                'ssl' => [
                    'enabled' => (!$this->behind_proxy && $this->scheme === 'https'),
                    'cert' => '/etc/letsencrypt/live/' . Str::lower($this->fqdn) . '/fullchain.pem',
                    'key' => '/etc/letsencrypt/live/' . Str::lower($this->fqdn) . '/privkey.pem',
                ],
                'upload_limit' => $this->upload_size,
            ],
            'system' => [
                'data' => $this->daemonBase,
                'sftp' => [
                    'bind_port' => $this->daemonSFTP,
                ],
            ],
            'allowed_mounts' => $this->mounts->pluck('source')->toArray(),
            'remote' => route('index'),
        ];
    }

    /**
     * Returns the configuration in Yaml format.
     */
    public function getYamlConfiguration(): string
    {
        return Yaml::dump($this->getConfiguration(), 4, 2, Yaml::DUMP_EMPTY_ARRAY_AS_SEQUENCE);
    }

    /**
     * Returns the configuration in JSON format.
     */
    public function getJsonConfiguration(bool $pretty = false): string
    {
        return json_encode($this->getConfiguration(), $pretty ? JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT : JSON_UNESCAPED_SLASHES);
    }

    /**
     * Helper function to return the decrypted key for a node.
     */
    public function getDecryptedKey(): string
    {
        return (string) Container::getInstance()->make(Encrypter::class)->decrypt(
            $this->daemon_token
        );
    }

    public function isUnderMaintenance(): bool
    {
        return $this->maintenance_mode;
    }

    public function mounts(): HasManyThrough
    {
        return $this->hasManyThrough(Mount::class, MountNode::class, 'node_id', 'id', 'id', 'mount_id');
    }

    /**
     * Gets the location associated with a node.
     */
    public function location(): BelongsTo
    {
        return $this->belongsTo(Location::class);
    }

    /**
     * Gets the servers associated with a node.
     */
    public function servers(): HasMany
    {
        return $this->hasMany(Server::class);
    }

    /**
     * Gets the allocations associated with a node.
     */
    public function allocations(): HasMany
    {
        return $this->hasMany(Allocation::class);
    }

    /**
     * Returns a boolean if the node is viable for an additional server to be placed on it.
     */
    public function isViable(int $memory, int $disk): bool
    {
        $memoryLimit = $this->memory * (1 + ($this->memory_overallocate / 100));
        $diskLimit = $this->disk * (1 + ($this->disk_overallocate / 100));

        return ($this->sum_memory + $memory) <= $memoryLimit && ($this->sum_disk + $disk) <= $diskLimit;
    }
}
</file>

<file path="app/Models/Permission.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Support\Collection;

class Permission extends Model
{
    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'subuser_permission';

    /**
     * Constants defining different permissions available.
     */
    public const ACTION_WEBSOCKET_CONNECT = 'websocket.connect';
    public const ACTION_CONTROL_CONSOLE = 'control.console';
    public const ACTION_CONTROL_START = 'control.start';
    public const ACTION_CONTROL_STOP = 'control.stop';
    public const ACTION_CONTROL_RESTART = 'control.restart';

    public const ACTION_DATABASE_READ = 'database.read';
    public const ACTION_DATABASE_CREATE = 'database.create';
    public const ACTION_DATABASE_UPDATE = 'database.update';
    public const ACTION_DATABASE_DELETE = 'database.delete';
    public const ACTION_DATABASE_VIEW_PASSWORD = 'database.view_password';

    public const ACTION_SCHEDULE_READ = 'schedule.read';
    public const ACTION_SCHEDULE_CREATE = 'schedule.create';
    public const ACTION_SCHEDULE_UPDATE = 'schedule.update';
    public const ACTION_SCHEDULE_DELETE = 'schedule.delete';

    public const ACTION_USER_READ = 'user.read';
    public const ACTION_USER_CREATE = 'user.create';
    public const ACTION_USER_UPDATE = 'user.update';
    public const ACTION_USER_DELETE = 'user.delete';

    public const ACTION_BACKUP_READ = 'backup.read';
    public const ACTION_BACKUP_CREATE = 'backup.create';
    public const ACTION_BACKUP_DELETE = 'backup.delete';
    public const ACTION_BACKUP_DOWNLOAD = 'backup.download';
    public const ACTION_BACKUP_RESTORE = 'backup.restore';

    public const ACTION_ALLOCATION_READ = 'allocation.read';
    public const ACTION_ALLOCATION_CREATE = 'allocation.create';
    public const ACTION_ALLOCATION_UPDATE = 'allocation.update';
    public const ACTION_ALLOCATION_DELETE = 'allocation.delete';

    public const ACTION_FILE_READ = 'file.read';
    public const ACTION_FILE_READ_CONTENT = 'file.read-content';
    public const ACTION_FILE_CREATE = 'file.create';
    public const ACTION_FILE_UPDATE = 'file.update';
    public const ACTION_FILE_DELETE = 'file.delete';
    public const ACTION_FILE_ARCHIVE = 'file.archive';
    public const ACTION_FILE_SFTP = 'file.sftp';

    public const ACTION_STARTUP_READ = 'startup.read';
    public const ACTION_STARTUP_UPDATE = 'startup.update';
    public const ACTION_STARTUP_DOCKER_IMAGE = 'startup.docker-image';

    public const ACTION_SETTINGS_RENAME = 'settings.rename';
    public const ACTION_SETTINGS_REINSTALL = 'settings.reinstall';

    public const ACTION_ACTIVITY_READ = 'activity.read';

    /**
     * Should timestamps be used on this model.
     */
    public $timestamps = false;

    /**
     * The table associated with the model.
     */
    protected $table = 'permissions';

    /**
     * Fields that are not mass assignable.
     */
    protected $guarded = ['id', 'created_at', 'updated_at'];

    /**
     * Cast values to correct type.
     */
    protected $casts = [
        'subuser_id' => 'integer',
    ];

    public static array $validationRules = [
        'subuser_id' => 'required|numeric|min:1',
        'permission' => 'required|string',
    ];

    /**
     * All the permissions available on the system. You should use self::permissions()
     * to retrieve them, and not directly access this array as it is subject to change.
     *
     * @see \Jexactyl\Models\Permission::permissions()
     */
    protected static array $permissions = [
        'websocket' => [
            'description' => 'Allows the user to connect to the server websocket, giving them access to view console output and realtime server stats.',
            'keys' => [
                'connect' => 'Allows a user to connect to the websocket instance for a server to stream the console.',
            ],
        ],

        'control' => [
            'description' => 'Permissions that control a user\'s ability to control the power state of a server, or send commands.',
            'keys' => [
                'console' => 'Allows a user to send commands to the server instance via the console.',
                'start' => 'Allows a user to start the server if it is stopped.',
                'stop' => 'Allows a user to stop a server if it is running.',
                'restart' => 'Allows a user to perform a server restart. This allows them to start the server if it is offline, but not put the server in a completely stopped state.',
            ],
        ],

        'user' => [
            'description' => 'Permissions that allow a user to manage other subusers on a server. They will never be able to edit their own account, or assign permissions they do not have themselves.',
            'keys' => [
                'create' => 'Allows a user to create new subusers for the server.',
                'read' => 'Allows the user to view subusers and their permissions for the server.',
                'update' => 'Allows a user to modify other subusers.',
                'delete' => 'Allows a user to delete a subuser from the server.',
            ],
        ],

        'file' => [
            'description' => 'Permissions that control a user\'s ability to modify the filesystem for this server.',
            'keys' => [
                'create' => 'Allows a user to create additional files and folders via the Panel or direct upload.',
                'read' => 'Allows a user to view the contents of a directory, but not view the contents of or download files.',
                'read-content' => 'Allows a user to view the contents of a given file. This will also allow the user to download files.',
                'update' => 'Allows a user to update the contents of an existing file or directory.',
                'delete' => 'Allows a user to delete files or directories.',
                'archive' => 'Allows a user to archive the contents of a directory as well as decompress existing archives on the system.',
                'sftp' => 'Allows a user to connect to SFTP and manage server files using the other assigned file permissions.',
            ],
        ],

        'plugin' => [
            'description' => 'Permissions that control a user\'s ability to view and install Spigot plugins.',
            'keys' => [
                'read' => 'Allows a user to view Spigot plugins.',
                'download' => 'Allows a user to download Spigot plugins.',
            ],
        ],

        'backup' => [
            'description' => 'Permissions that control a user\'s ability to generate and manage server backups.',
            'keys' => [
                'create' => 'Allows a user to create new backups for this server.',
                'read' => 'Allows a user to view all backups that exist for this server.',
                'delete' => 'Allows a user to remove backups from the system.',
                'download' => 'Allows a user to download a backup for the server. Danger: this allows a user to access all files for the server in the backup.',
                'restore' => 'Allows a user to restore a backup for the server. Danger: this allows the user to delete all of the server files in the process.',
            ],
        ],

        // Controls permissions for editing or viewing a server's allocations.
        'allocation' => [
            'description' => 'Permissions that control a user\'s ability to modify the port allocations for this server.',
            'keys' => [
                'read' => 'Allows a user to view all allocations currently assigned to this server. Users with any level of access to this server can always view the primary allocation.',
                'create' => 'Allows a user to assign additional allocations to the server.',
                'update' => 'Allows a user to change the primary server allocation and attach notes to each allocation.',
                'delete' => 'Allows a user to delete an allocation from the server.',
            ],
        ],

        // Controls permissions for editing or viewing a server's startup parameters.
        'startup' => [
            'description' => 'Permissions that control a user\'s ability to view this server\'s startup parameters.',
            'keys' => [
                'read' => 'Allows a user to view the startup variables for a server.',
                'update' => 'Allows a user to modify the startup variables for the server.',
                'docker-image' => 'Allows a user to modify the Docker image used when running the server.',
            ],
        ],

        'database' => [
            'description' => 'Permissions that control a user\'s access to the database management for this server.',
            'keys' => [
                'create' => 'Allows a user to create a new database for this server.',
                'read' => 'Allows a user to view the database associated with this server.',
                'update' => 'Allows a user to rotate the password on a database instance. If the user does not have the view_password permission they will not see the updated password.',
                'delete' => 'Allows a user to remove a database instance from this server.',
                'view_password' => 'Allows a user to view the password associated with a database instance for this server.',
            ],
        ],

        'schedule' => [
            'description' => 'Permissions that control a user\'s access to the schedule management for this server.',
            'keys' => [
                'create' => 'Allows a user to create new schedules for this server.', // task.create-schedule
                'read' => 'Allows a user to view schedules and the tasks associated with them for this server.', // task.view-schedule, task.list-schedules
                'update' => 'Allows a user to update schedules and schedule tasks for this server.', // task.edit-schedule, task.queue-schedule, task.toggle-schedule
                'delete' => 'Allows a user to delete schedules for this server.', // task.delete-schedule
            ],
        ],

        'settings' => [
            'description' => 'Permissions that control a user\'s access to the settings for this server.',
            'keys' => [
                'rename' => 'Allows a user to rename this server and change the description of it.',
                'reinstall' => 'Allows a user to trigger a reinstall of this server.',
            ],
        ],

        'activity' => [
            'description' => 'Permissions that control a user\'s access to the server activity logs.',
            'keys' => [
                'read' => 'Allows a user to view the activity logs for the server.',
            ],
        ],
    ];

    /**
     * Returns all the permissions available on the system for a user to
     * have when controlling a server.
     */
    public static function permissions(): Collection
    {
        return Collection::make(self::$permissions);
    }
}
</file>

<file path="app/Models/RecoveryToken.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\Relations\BelongsTo;

/**
 * @property int $id
 * @property int $user_id
 * @property string $token
 * @property \Carbon\CarbonImmutable $created_at
 * @property \Jexactyl\Models\User $user
 */
class RecoveryToken extends Model
{
    /**
     * There are no updates to this model, only inserts and deletes.
     */
    public const UPDATED_AT = null;

    public $timestamps = true;

    protected bool $immutableDates = true;

    public static array $validationRules = [
        'token' => 'required|string',
    ];

    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class);
    }
}
</file>

<file path="app/Models/ReferralCode.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Support\Str;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

/**
 * Jexactyl\Models\ReferralCode.
 *
 * @property int $user_id
 * @property string $code
 * @property \Illuminate\Support\Carbon|null $created_at
 * @property \Jexactyl\Models\User $user
 */
class ReferralCode extends Model
{
    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'referral_code';

    /**
     * The length of referral codes.
     */
    public const CODE_LENGTH = 8;

    /**
     * The length of the code to store in the database.
     */
    public const KEY_LENGTH = 16;

    /**
     * The table associated with the model.
     */
    protected $table = 'referral_codes';

    /**
     * Fields that are mass assignable.
     */
    protected $fillable = [
        'code',
    ];

    /**
     * Rules to protect against invalid data entry to DB.
     */
    public static array $validationRules = [
        'user_id' => 'required|exists:users,id',
        'code' => 'present|string|size:16',
    ];

    protected $dates = [
        self::CREATED_AT,
    ];

    /**
     * Returns the user this token is assigned to.
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class);
    }

    /**
     * Generates a new code.
     */
    public static function generateCode(int $type): string
    {
        $prefix = self::getPrefixForType($type);

        return $prefix . Str::random(self::IDENTIFIER_LENGTH - strlen($prefix));
    }
}
</file>

<file path="app/Models/ReferralUses.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Factories\HasFactory;

/**
 * @property int $id
 * @property int $referrer_id
 * @property int $user_id
 * @property string $code_used
 */
class ReferralUses extends Model
{
    use HasFactory;

    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'referral_uses';

    /**
     * The attributes that aren't mass assignable.
     */
    protected $guarded = [
        'id',
        'timestamp',
    ];

    /**
     * The attributes that are mass assignable.
     */
    protected $fillable = [
        'user_id',
        'code_used',
        'referrer_id',
    ];

    /**
     * Rules to protect against invalid data entry to DB.
     */
    public static array $validationRules = [
        'user_id' => 'required|exists:users,id',
        'code_used' => 'required|string|size:16',
        'referrer_id' => 'required|exists:users,id',
    ];
}
</file>

<file path="app/Models/Schedule.php">
<?php

namespace Jexactyl\Models;

use Cron\CronExpression;
use Carbon\CarbonImmutable;
use Illuminate\Container\Container;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Jexactyl\Contracts\Extensions\HashidsInterface;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

/**
 * @property int $id
 * @property int $server_id
 * @property string $name
 * @property string $cron_day_of_week
 * @property string $cron_month
 * @property string $cron_day_of_month
 * @property string $cron_hour
 * @property string $cron_minute
 * @property bool $is_active
 * @property bool $is_processing
 * @property bool $only_when_online
 * @property \Carbon\Carbon|null $last_run_at
 * @property \Carbon\Carbon|null $next_run_at
 * @property \Carbon\Carbon $created_at
 * @property \Carbon\Carbon $updated_at
 * @property string $hashid
 * @property \Jexactyl\Models\Server $server
 * @property \Jexactyl\Models\Task[]|\Illuminate\Support\Collection $tasks
 */
class Schedule extends Model
{
    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'server_schedule';

    /**
     * The table associated with the model.
     */
    protected $table = 'schedules';

    /**
     * Always return the tasks associated with this schedule.
     */
    protected $with = ['tasks'];

    /**
     * Mass assignable attributes on this model.
     */
    protected $fillable = [
        'server_id',
        'name',
        'cron_day_of_week',
        'cron_month',
        'cron_day_of_month',
        'cron_hour',
        'cron_minute',
        'is_active',
        'is_processing',
        'only_when_online',
        'last_run_at',
        'next_run_at',
    ];

    protected $casts = [
        'id' => 'integer',
        'server_id' => 'integer',
        'is_active' => 'boolean',
        'is_processing' => 'boolean',
        'only_when_online' => 'boolean',
    ];

    /**
     * Columns to mutate to a date.
     */
    protected $dates = [
        'last_run_at',
        'next_run_at',
    ];

    protected $attributes = [
        'name' => null,
        'cron_day_of_week' => '*',
        'cron_month' => '*',
        'cron_day_of_month' => '*',
        'cron_hour' => '*',
        'cron_minute' => '*',
        'is_active' => true,
        'is_processing' => false,
        'only_when_online' => false,
    ];

    public static array $validationRules = [
        'server_id' => 'required|exists:servers,id',
        'name' => 'required|string|max:191',
        'cron_day_of_week' => 'required|string',
        'cron_month' => 'required|string',
        'cron_day_of_month' => 'required|string',
        'cron_hour' => 'required|string',
        'cron_minute' => 'required|string',
        'is_active' => 'boolean',
        'is_processing' => 'boolean',
        'only_when_online' => 'boolean',
        'last_run_at' => 'nullable|date',
        'next_run_at' => 'nullable|date',
    ];

    /**
     * {@inheritDoc}
     */
    public function getRouteKeyName(): string
    {
        return $this->getKeyName();
    }

    /**
     * Returns the schedule's execution crontab entry as a string.
     *
     * @throws \Exception
     */
    public function getNextRunDate(): CarbonImmutable
    {
        $formatted = sprintf('%s %s %s %s %s', $this->cron_minute, $this->cron_hour, $this->cron_day_of_month, $this->cron_month, $this->cron_day_of_week);

        return CarbonImmutable::createFromTimestamp(
            (new CronExpression($formatted))->getNextRunDate()->getTimestamp()
        );
    }

    /**
     * Return a hashid encoded string to represent the ID of the schedule.
     */
    public function getHashidAttribute(): string
    {
        return Container::getInstance()->make(HashidsInterface::class)->encode($this->id);
    }

    /**
     * Return tasks belonging to a schedule.
     */
    public function tasks(): HasMany
    {
        return $this->hasMany(Task::class);
    }

    /**
     * Return the server model that a schedule belongs to.
     */
    public function server(): BelongsTo
    {
        return $this->belongsTo(Server::class);
    }
}
</file>

<file path="app/Models/Server.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Notifications\Notifiable;
use Illuminate\Database\Query\JoinClause;
use Znck\Eloquent\Traits\BelongsToThrough;
use Illuminate\Database\Eloquent\Relations\HasOne;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\MorphToMany;
use Illuminate\Database\Eloquent\Relations\HasManyThrough;
use Jexactyl\Exceptions\Http\Server\ServerStateConflictException;

/**
 * \Jexactyl\Models\Server.
 *
 * @property int $id
 * @property string|null $external_id
 * @property string $uuid
 * @property string $uuidShort
 * @property int $node_id
 * @property bool $renewable
 * @property int $renewal
 * @property string|null $bg
 * @property string $name
 * @property string $description
 * @property string|null $status
 * @property bool $skip_scripts
 * @property int $owner_id
 * @property int $memory
 * @property int $swap
 * @property int $disk
 * @property int $io
 * @property int $cpu
 * @property string|null $threads
 * @property bool $oom_disabled
 * @property int $allocation_id
 * @property int $nest_id
 * @property int $egg_id
 * @property string $startup
 * @property string $image
 * @property int|null $allocation_limit
 * @property int|null $database_limit
 * @property int $backup_limit
 * @property \Illuminate\Support\Carbon|null $created_at
 * @property \Illuminate\Support\Carbon|null $updated_at
 * @property \Illuminate\Support\Carbon|null $installed_at
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\ActivityLog[] $activity
 * @property int|null $activity_count
 * @property \Jexactyl\Models\Allocation|null $allocation
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\Allocation[] $allocations
 * @property int|null $allocations_count
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\Backup[] $backups
 * @property int|null $backups_count
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\Database[] $databases
 * @property int|null $databases_count
 * @property \Jexactyl\Models\Egg|null $egg
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\Mount[] $mounts
 * @property int|null $mounts_count
 * @property \Jexactyl\Models\Nest $nest
 * @property \Jexactyl\Models\Node $node
 * @property \Illuminate\Notifications\DatabaseNotificationCollection|\Illuminate\Notifications\DatabaseNotification[] $notifications
 * @property int|null $notifications_count
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\Schedule[] $schedules
 * @property int|null $schedules_count
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\Subuser[] $subusers
 * @property int|null $subusers_count
 * @property \Jexactyl\Models\ServerTransfer|null $transfer
 * @property \Jexactyl\Models\User $user
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\EggVariable[] $variables
 * @property int|null $variables_count
 *
 * @method static \Database\Factories\ServerFactory factory(...$parameters)
 * @method static \Illuminate\Database\Eloquent\Builder|Server newModelQuery()
 * @method static \Illuminate\Database\Eloquent\Builder|Server newQuery()
 * @method static \Illuminate\Database\Eloquent\Builder|Server query()
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereAllocationId($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereAllocationLimit($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereBackupLimit($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereCpu($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereCreatedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereDatabaseLimit($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereDescription($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereDisk($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereEggId($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereExternalId($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereId($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereImage($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereIo($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereMemory($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereName($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereNestId($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereNodeId($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereOomDisabled($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereOwnerId($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereSkipScripts($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereStartup($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereStatus($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereSwap($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereThreads($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereUpdatedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereUuid($value)
 * @method static \Illuminate\Database\Eloquent\Builder|Server whereUuidShort($value)
 *
 * @mixin \Eloquent
 */
class Server extends Model
{
    use BelongsToThrough;
    use Notifiable;

    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'server';

    public const STATUS_INSTALLING = 'installing';
    public const STATUS_INSTALL_FAILED = 'install_failed';
    public const STATUS_REINSTALL_FAILED = 'reinstall_failed';
    public const STATUS_SUSPENDED = 'suspended';
    public const STATUS_RESTORING_BACKUP = 'restoring_backup';

    /**
     * The table associated with the model.
     */
    protected $table = 'servers';

    /**
     * Default values when creating the model. We want to switch to disabling OOM killer
     * on server instances unless the user specifies otherwise in the request.
     */
    protected $attributes = [
        'status' => self::STATUS_INSTALLING,
        'oom_disabled' => true,
        'installed_at' => null,
    ];

    /**
     * The default relationships to load for all server models.
     */
    protected $with = ['allocation'];

    /**
     * The attributes that should be mutated to dates.
     */
    protected $dates = [self::CREATED_AT, self::UPDATED_AT, 'deleted_at', 'installed_at'];

    /**
     * Fields that are not mass assignable.
     */
    protected $guarded = ['id', self::CREATED_AT, self::UPDATED_AT, 'deleted_at', 'installed_at'];

    public static array $validationRules = [
        'external_id' => 'sometimes|nullable|string|between:1,191|unique:servers',
        'owner_id' => 'required|integer|exists:users,id',
        'name' => 'required|string|min:1|max:191',
        'node_id' => 'required|exists:nodes,id',
        'renewable' => 'sometimes|boolean',
        'renewal' => 'sometimes|integer',
        'bg' => 'nullable|string',
        'description' => 'string',
        'status' => 'nullable|string',
        'memory' => 'required|numeric|min:0',
        'swap' => 'required|numeric|min:-1',
        'io' => 'required|numeric|between:10,1000',
        'cpu' => 'required|numeric|min:0',
        'threads' => 'nullable|regex:/^[0-9-,]+$/',
        'oom_disabled' => 'sometimes|boolean',
        'disk' => 'required|numeric|min:0',
        'allocation_id' => 'required|bail|unique:servers|exists:allocations,id',
        'nest_id' => 'required|exists:nests,id',
        'egg_id' => 'required|exists:eggs,id',
        'startup' => 'required|string',
        'skip_scripts' => 'sometimes|boolean',
        'image' => 'required|string|max:191',
        'database_limit' => 'present|nullable|integer|min:0',
        'allocation_limit' => 'sometimes|nullable|integer|min:0',
        'backup_limit' => 'present|nullable|integer|min:0',
    ];

    /**
     * Cast values to correct type.
     */
    protected $casts = [
        'node_id' => 'integer',
        'renewable' => 'boolean',
        'renewal' => 'integer',
        'bg' => 'string',
        'skip_scripts' => 'boolean',
        'owner_id' => 'integer',
        'memory' => 'integer',
        'swap' => 'integer',
        'disk' => 'integer',
        'io' => 'integer',
        'cpu' => 'integer',
        'oom_disabled' => 'boolean',
        'allocation_id' => 'integer',
        'nest_id' => 'integer',
        'egg_id' => 'integer',
        'database_limit' => 'integer',
        'allocation_limit' => 'integer',
        'backup_limit' => 'integer',
    ];

    /**
     * Returns the format for server allocations when communicating with the Daemon.
     */
    public function getAllocationMappings(): array
    {
        return $this->allocations->where('node_id', $this->node_id)->groupBy('ip')->map(function ($item) {
            return $item->pluck('port');
        })->toArray();
    }

    public function isInstalled(): bool
    {
        return $this->status !== self::STATUS_INSTALLING && $this->status !== self::STATUS_INSTALL_FAILED;
    }

    public function isSuspended(): bool
    {
        return $this->status === self::STATUS_SUSPENDED;
    }

    /**
     * Gets the user who owns the server.
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class, 'owner_id');
    }

    /**
     * Gets the subusers associated with a server.
     */
    public function subusers(): HasMany
    {
        return $this->hasMany(Subuser::class, 'server_id', 'id');
    }

    /**
     * Gets the default allocation for a server.
     */
    public function allocation(): HasOne
    {
        return $this->hasOne(Allocation::class, 'id', 'allocation_id');
    }

    /**
     * Gets all allocations associated with this server.
     */
    public function allocations(): HasMany
    {
        return $this->hasMany(Allocation::class, 'server_id');
    }

    /**
     * Gets information for the nest associated with this server.
     */
    public function nest(): BelongsTo
    {
        return $this->belongsTo(Nest::class);
    }

    /**
     * Gets information for the egg associated with this server.
     */
    public function egg(): HasOne
    {
        return $this->hasOne(Egg::class, 'id', 'egg_id');
    }

    /**
     * Gets information for the service variables associated with this server.
     */
    public function variables(): HasMany
    {
        return $this->hasMany(EggVariable::class, 'egg_id', 'egg_id')
            ->select(['egg_variables.*', 'server_variables.variable_value as server_value'])
            ->leftJoin('server_variables', function (JoinClause $join) {
                // Don't forget to join against the server ID as well since the way we're using this relationship
                // would actually return all the variables and their values for _all_ servers using that egg,
                // rather than only the server for this model.
                //
                // @see https://github.com/pterodactyl/panel/issues/2250
                $join->on('server_variables.variable_id', 'egg_variables.id')
                    ->where('server_variables.server_id', $this->id);
            });
    }

    /**
     * Gets information for the node associated with this server.
     */
    public function node(): BelongsTo
    {
        return $this->belongsTo(Node::class);
    }

    /**
     * Gets information for the tasks associated with this server.
     */
    public function schedules(): HasMany
    {
        return $this->hasMany(Schedule::class);
    }

    /**
     * Gets all databases associated with a server.
     */
    public function databases(): HasMany
    {
        return $this->hasMany(Database::class);
    }

    /**
     * Returns the location that a server belongs to.
     *
     * @throws \Exception
     */
    public function location(): \Znck\Eloquent\Relations\BelongsToThrough
    {
        return $this->belongsToThrough(Location::class, Node::class);
    }

    /**
     * Returns the associated server transfer.
     */
    public function transfer(): HasOne
    {
        return $this->hasOne(ServerTransfer::class)->whereNull('successful')->orderByDesc('id');
    }

    public function backups(): HasMany
    {
        return $this->hasMany(Backup::class);
    }

    /**
     * Returns all mounts that have this server has mounted.
     */
    public function mounts(): HasManyThrough
    {
        return $this->hasManyThrough(Mount::class, MountServer::class, 'server_id', 'id', 'id', 'mount_id');
    }

    /**
     * Returns all of the activity log entries where the server is the subject.
     */
    public function activity(): MorphToMany
    {
        return $this->morphToMany(ActivityLog::class, 'subject', 'activity_log_subjects');
    }

    /**
     * Checks if the server is currently in a user-accessible state. If not, an
     * exception is raised. This should be called whenever something needs to make
     * sure the server is not in a weird state that should block user access.
     *
     * @throws \Jexactyl\Exceptions\Http\Server\ServerStateConflictException
     */
    public function validateCurrentState()
    {
        if (
            $this->isSuspended() ||
            $this->node->isUnderMaintenance() ||
            !$this->isInstalled() ||
            $this->status === self::STATUS_RESTORING_BACKUP ||
            !is_null($this->transfer)
        ) {
            throw new ServerStateConflictException($this);
        }
    }

    /**
     * Checks if the server is currently in a transferable state. If not, an
     * exception is raised. This should be called whenever something needs to make
     * sure the server is able to be transferred and is not currently being transferred
     * or installed.
     */
    public function validateTransferState()
    {
        if (
            !$this->isInstalled() ||
            $this->status === self::STATUS_RESTORING_BACKUP ||
            !is_null($this->transfer)
        ) {
            throw new ServerStateConflictException($this);
        }
    }
}
</file>

<file path="app/Models/ServerTransfer.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\Relations\HasOne;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

/**
 * @property int $id
 * @property int $server_id
 * @property int $old_node
 * @property int $new_node
 * @property int $old_allocation
 * @property int $new_allocation
 * @property array|null $old_additional_allocations
 * @property array|null $new_additional_allocations
 * @property bool|null $successful
 * @property bool $archived
 * @property \Carbon\Carbon $created_at
 * @property \Carbon\Carbon $updated_at
 * @property \Jexactyl\Models\Server $server
 * @property \Jexactyl\Models\Node $oldNode
 * @property \Jexactyl\Models\Node $newNode
 */
class ServerTransfer extends Model
{
    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'server_transfer';

    /**
     * The table associated with the model.
     */
    protected $table = 'server_transfers';

    /**
     * Fields that are not mass assignable.
     */
    protected $guarded = ['id', 'created_at', 'updated_at'];

    /**
     * Cast values to correct type.
     */
    protected $casts = [
        'server_id' => 'int',
        'old_node' => 'int',
        'new_node' => 'int',
        'old_allocation' => 'int',
        'new_allocation' => 'int',
        'old_additional_allocations' => 'array',
        'new_additional_allocations' => 'array',
        'successful' => 'bool',
        'archived' => 'bool',
    ];

    public static array $validationRules = [
        'server_id' => 'required|numeric|exists:servers,id',
        'old_node' => 'required|numeric',
        'new_node' => 'required|numeric',
        'old_allocation' => 'required|numeric',
        'new_allocation' => 'required|numeric',
        'old_additional_allocations' => 'nullable|array',
        'old_additional_allocations.*' => 'numeric',
        'new_additional_allocations' => 'nullable|array',
        'new_additional_allocations.*' => 'numeric',
        'successful' => 'sometimes|nullable|boolean',
    ];

    /**
     * Gets the server associated with a server transfer.
     */
    public function server(): BelongsTo
    {
        return $this->belongsTo(Server::class);
    }

    /**
     * Gets the source node associated with a server transfer.
     */
    public function oldNode(): HasOne
    {
        return $this->hasOne(Node::class, 'id', 'old_node');
    }

    /**
     * Gets the target node associated with a server transfer.
     */
    public function newNode(): HasOne
    {
        return $this->hasOne(Node::class, 'id', 'new_node');
    }
}
</file>

<file path="app/Models/ServerVariable.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\Relations\BelongsTo;

/**
 * @property int $id
 * @property int $server_id
 * @property int $variable_id
 * @property string $variable_value
 * @property \Carbon\CarbonImmutable|null $created_at
 * @property \Carbon\CarbonImmutable|null $updated_at
 * @property \Jexactyl\Models\EggVariable $variable
 * @property \Jexactyl\Models\Server $server
 */
class ServerVariable extends Model
{
    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'server_variable';

    protected bool $immutableDates = true;

    protected $table = 'server_variables';

    protected $guarded = ['id', 'created_at', 'updated_at'];

    protected $casts = [
        'server_id' => 'integer',
        'variable_id' => 'integer',
    ];

    public static array $validationRules = [
        'server_id' => 'required|int',
        'variable_id' => 'required|int',
        'variable_value' => 'string',
    ];

    /**
     * Returns the server this variable is associated with.
     */
    public function server(): BelongsTo
    {
        return $this->belongsTo(Server::class);
    }

    /**
     * Returns information about a given variables parent.
     */
    public function variable(): BelongsTo
    {
        return $this->belongsTo(EggVariable::class, 'variable_id');
    }
}
</file>

<file path="app/Models/Session.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\Model;

class Session extends Model
{
    /**
     * The table associated with the model.
     */
    protected $table = 'sessions';

    /**
     * Cast values to correct type.
     */
    protected $casts = [
        'id' => 'string',
        'user_id' => 'integer',
    ];
}
</file>

<file path="app/Models/Setting.php">
<?php

namespace Jexactyl\Models;

/**
 * Jexactyl\Models\Setting.
 *
 * @property int $id
 * @property string $key
 * @property string $value
 */
class Setting extends Model
{
    /**
     * The table associated with the model.
     */
    protected $table = 'settings';

    public $timestamps = false;

    protected $fillable = ['key', 'value'];

    public static array $validationRules = [
        'key' => 'required|string|between:1,191',
        'value' => 'string',
    ];
}
</file>

<file path="app/Models/Subuser.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Notifications\Notifiable;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

/**
 * @property int $id
 * @property int $user_id
 * @property int $server_id
 * @property array $permissions
 * @property \Carbon\Carbon $created_at
 * @property \Carbon\Carbon $updated_at
 * @property \Jexactyl\Models\User $user
 * @property \Jexactyl\Models\Server $server
 */
class Subuser extends Model
{
    use Notifiable;

    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'server_subuser';

    /**
     * The table associated with the model.
     */
    protected $table = 'subusers';

    /**
     * Fields that are not mass assignable.
     */
    protected $guarded = ['id', 'created_at', 'updated_at'];

    /**
     * Cast values to correct type.
     */
    protected $casts = [
        'user_id' => 'int',
        'server_id' => 'int',
        'permissions' => 'array',
    ];

    public static array $validationRules = [
        'user_id' => 'required|numeric|exists:users,id',
        'server_id' => 'required|numeric|exists:servers,id',
        'permissions' => 'nullable|array',
        'permissions.*' => 'string',
    ];

    /**
     * Return a hashid encoded string to represent the ID of the subuser.
     */
    public function getHashidAttribute(): string
    {
        return app()->make('hashids')->encode($this->id);
    }

    /**
     * Gets the server associated with a subuser.
     */
    public function server(): BelongsTo
    {
        return $this->belongsTo(Server::class);
    }

    /**
     * Gets the user associated with a subuser.
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class);
    }

    /**
     * Gets the permissions associated with a subuser.
     */
    public function permissions(): HasMany
    {
        return $this->hasMany(Permission::class);
    }
}
</file>

<file path="app/Models/Task.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Container\Container;
use Znck\Eloquent\Traits\BelongsToThrough;
use Jexactyl\Contracts\Extensions\HashidsInterface;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

/**
 * @property int $id
 * @property int $schedule_id
 * @property int $sequence_id
 * @property string $action
 * @property string $payload
 * @property int $time_offset
 * @property bool $is_queued
 * @property bool $continue_on_failure
 * @property \Carbon\Carbon $created_at
 * @property \Carbon\Carbon $updated_at
 * @property string $hashid
 * @property \Jexactyl\Models\Schedule $schedule
 * @property \Jexactyl\Models\Server $server
 */
class Task extends Model
{
    use BelongsToThrough;

    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'schedule_task';

    /**
     * The default actions that can exist for a task in Jexactyl.
     */
    public const ACTION_POWER = 'power';
    public const ACTION_COMMAND = 'command';
    public const ACTION_BACKUP = 'backup';

    /**
     * The table associated with the model.
     */
    protected $table = 'tasks';

    /**
     * Relationships to be updated when this model is updated.
     */
    protected $touches = ['schedule'];

    /**
     * Fields that are mass assignable.
     */
    protected $fillable = [
        'schedule_id',
        'sequence_id',
        'action',
        'payload',
        'time_offset',
        'is_queued',
        'continue_on_failure',
    ];

    /**
     * Cast values to correct type.
     */
    protected $casts = [
        'id' => 'integer',
        'schedule_id' => 'integer',
        'sequence_id' => 'integer',
        'time_offset' => 'integer',
        'is_queued' => 'boolean',
        'continue_on_failure' => 'boolean',
    ];

    /**
     * Default attributes when creating a new model.
     */
    protected $attributes = [
        'time_offset' => 0,
        'is_queued' => false,
        'continue_on_failure' => false,
    ];

    public static array $validationRules = [
        'schedule_id' => 'required|numeric|exists:schedules,id',
        'sequence_id' => 'required|numeric|min:1',
        'action' => 'required|string',
        'payload' => 'required_unless:action,backup|string',
        'time_offset' => 'required|numeric|between:0,900',
        'is_queued' => 'boolean',
        'continue_on_failure' => 'boolean',
    ];

    /**
     * {@inheritDoc}
     */
    public function getRouteKeyName(): string
    {
        return $this->getKeyName();
    }

    /**
     * Return a hashid encoded string to represent the ID of the task.
     */
    public function getHashidAttribute(): string
    {
        return Container::getInstance()->make(HashidsInterface::class)->encode($this->id);
    }

    /**
     * Return the schedule that a task belongs to.
     */
    public function schedule(): BelongsTo
    {
        return $this->belongsTo(Schedule::class);
    }

    /**
     * Return the server a task is assigned to, acts as a belongsToThrough.
     */
    public function server(): \Znck\Eloquent\Relations\BelongsToThrough
    {
        return $this->belongsToThrough(Server::class, Schedule::class);
    }
}
</file>

<file path="app/Models/TaskLog.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\Model;

class TaskLog extends Model
{
    /**
     * The table associated with the model.
     */
    protected $table = 'tasks_log';

    /**
     * Fields that are not mass assignable.
     */
    protected $guarded = ['id', 'created_at', 'updated_at'];

    /**
     * Cast values to correct type.
     */
    protected $casts = [
        'id' => 'integer',
        'task_id' => 'integer',
        'run_status' => 'integer',
    ];

    /**
     * The attributes that should be mutated to dates.
     */
    protected $dates = ['run_time', 'created_at', 'updated_at'];
}
</file>

<file path="app/Models/Ticket.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Support\Carbon;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Collection;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

/**
 * Jexactyl\Models\Ticket.
 *
 * @property int $id
 * @property User $client
 * @property User|null $staff
 * @property int $client_id
 * @property int|null $staff_id
 * @property string $title
 * @property string $status
 * @property string $content
 * @property int|null $message_count
 * @property Collection|TicketMessage[] $messages
 * @property Carbon|null $created_at
 * @property Carbon|null $updated_at
 */
class Ticket extends Model
{
    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'ticket';

    public const STATUS_PENDING = 'pending';
    public const STATUS_RESOLVED = 'resolved';
    public const STATUS_UNRESOLVED = 'unresolved';
    public const STATUS_IN_PROGRESS = 'in-progress';

    /**
     * The table associated with the model.
     */
    protected $table = 'tickets';

    /**
     * Default values when creating the model.
     */
    protected $attributes = ['status' => self::STATUS_PENDING];

    /**
     * The attributes that should be mutated to dates.
     */
    protected $dates = [self::CREATED_AT, self::UPDATED_AT];

    /**
     * Fields that are not mass assignable.
     */
    protected $guarded = ['id', self::CREATED_AT, self::UPDATED_AT];

    /**
     * Fields that are mass-assignable.
     */
    protected $fillable = [
        'client_id',
        'staff_id',
        'title',
        'status',
        'content',
    ];

    /**
     * Rules verifying that the data being stored matches the expectations of the database.
     */
    public static array $validationRules = [
        'client_id' => 'required|int|unique:users,id',
        'staff_id' => 'sometimes|int|unique:users,id',
        'title' => 'required|string|min:3|max:191',
        'status' => 'required|string',
        'content' => 'required|string|min:3|max:191',
    ];

    /**
     * Gets the client who made the ticket.
     */
    public function client(): BelongsTo
    {
        return $this->belongsTo(User::class, 'client_id');
    }

    /**
     * Gets the staff member who this ticket has been assigned to.
     */
    public function staff(): BelongsTo
    {
        return $this->belongsTo(User::class, 'staff_id');
    }

    /**
     * Get whether the ticket is in 'resolved' state.
     */
    public function isResolved(): bool
    {
        return $this->status === self::STATUS_RESOLVED;
    }

    /**
     * Gets the user associated with this ticket.
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class, 'client_id');
    }

    /**
     * Gets all messages associated with this ticket.
     */
    public function messages(): HasMany
    {
        return $this->hasMany(TicketMessage::class, 'ticket_id');
    }
}
</file>

<file path="app/Models/TicketMessage.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Support\Carbon;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

/**
 * Jexactyl\Models\TicketMessage.
 *
 * @property int $id
 * @property User $user
 * @property int $user_id
 * @property Ticket $ticket
 * @property int $ticket_id
 * @property string $content
 * @property Carbon|null $created_at
 * @property Carbon|null $updated_at
 */
class TicketMessage extends Model
{
    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'ticket_messages';

    /**
     * The table associated with the model.
     */
    protected $table = 'ticket_messages';

    /**
     * The attributes that should be mutated to dates.
     */
    protected $dates = [self::CREATED_AT, self::UPDATED_AT];

    /**
     * Fields that are not mass assignable.
     */
    protected $guarded = ['id', self::CREATED_AT, self::UPDATED_AT];

    /**
     * Fields that are mass-assignable.
     */
    protected $fillable = [
        'user_id',
        'ticket_id',
        'content',
    ];

    /**
     * Rules verifying that the data being stored matches the expectations of the database.
     */
    public static array $validationRules = [
        'user_id' => 'required|int|unique:users,id',
        'ticket_id' => 'required|int',
        'content' => 'required|string|min:3|max:191',
    ];

    /**
     * Gets the ticket which this message has been assigned to.
     */
    public function ticket(): BelongsTo
    {
        return $this->belongsTo(Ticket::class, 'ticket_id');
    }

    /**
     * Gets the user associated with this ticket.
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class, 'user_id');
    }
}
</file>

<file path="app/Models/UserSSHKey.php">
<?php

namespace Jexactyl\Models;

use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

/**
 * \Jexactyl\Models\UserSSHKey.
 *
 * @property int $id
 * @property int $user_id
 * @property string $name
 * @property string $fingerprint
 * @property string $public_key
 * @property \Illuminate\Support\Carbon|null $created_at
 * @property \Illuminate\Support\Carbon|null $updated_at
 * @property \Illuminate\Support\Carbon|null $deleted_at
 * @property \Jexactyl\Models\User $user
 *
 * @method static \Illuminate\Database\Eloquent\Builder|UserSSHKey newModelQuery()
 * @method static \Illuminate\Database\Eloquent\Builder|UserSSHKey newQuery()
 * @method static \Illuminate\Database\Query\Builder|UserSSHKey onlyTrashed()
 * @method static \Illuminate\Database\Eloquent\Builder|UserSSHKey query()
 * @method static \Illuminate\Database\Eloquent\Builder|UserSSHKey whereCreatedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder|UserSSHKey whereDeletedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder|UserSSHKey whereFingerprint($value)
 * @method static \Illuminate\Database\Eloquent\Builder|UserSSHKey whereId($value)
 * @method static \Illuminate\Database\Eloquent\Builder|UserSSHKey whereName($value)
 * @method static \Illuminate\Database\Eloquent\Builder|UserSSHKey wherePublicKey($value)
 * @method static \Illuminate\Database\Eloquent\Builder|UserSSHKey whereUpdatedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder|UserSSHKey whereUserId($value)
 * @method static \Illuminate\Database\Query\Builder|UserSSHKey withTrashed()
 * @method static \Illuminate\Database\Query\Builder|UserSSHKey withoutTrashed()
 *
 * @mixin \Eloquent
 *
 * @method static \Database\Factories\UserSSHKeyFactory factory(...$parameters)
 */
class UserSSHKey extends Model
{
    use SoftDeletes;

    public const RESOURCE_NAME = 'ssh_key';

    protected $table = 'user_ssh_keys';

    protected $fillable = [
        'name',
        'public_key',
        'fingerprint',
    ];

    public static array $validationRules = [
        'name' => ['required', 'string'],
        'fingerprint' => ['required', 'string'],
        'public_key' => ['required', 'string'],
    ];

    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class);
    }
}
</file>

<file path="app/Notifications/AccountCreated.php">
<?php

namespace Jexactyl\Notifications;

use Jexactyl\Models\User;
use Illuminate\Bus\Queueable;
use Illuminate\Notifications\Notification;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Notifications\Messages\MailMessage;

class AccountCreated extends Notification implements ShouldQueue
{
    use Queueable;

    /**
     * Create a new notification instance.
     */
    public function __construct(public User $user, public ?string $token = null)
    {
    }

    /**
     * Get the notification's delivery channels.
     */
    public function via(): array
    {
        return ['mail'];
    }

    /**
     * Get the mail representation of the notification.
     */
    public function toMail(): MailMessage
    {
        $message = (new MailMessage())
            ->greeting('Hello ' . $this->user->name . '!')
            ->line('You are receiving this email because an account has been created for you on ' . config('app.name') . '.')
            ->line('Username: ' . $this->user->username)
            ->line('Email: ' . $this->user->email);

        if (!is_null($this->token)) {
            return $message->action('Setup Your Account', url('/auth/password/reset/' . $this->token . '?email=' . urlencode($this->user->email)));
        }

        return $message;
    }
}
</file>

<file path="app/Notifications/AddedToServer.php">
<?php

namespace Jexactyl\Notifications;

use Illuminate\Bus\Queueable;
use Illuminate\Notifications\Notification;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Notifications\Messages\MailMessage;

class AddedToServer extends Notification implements ShouldQueue
{
    use Queueable;

    public object $server;

    /**
     * Create a new notification instance.
     */
    public function __construct(array $server)
    {
        $this->server = (object) $server;
    }

    /**
     * Get the notification's delivery channels.
     */
    public function via(): array
    {
        return ['mail'];
    }

    /**
     * Get the mail representation of the notification.
     */
    public function toMail(): MailMessage
    {
        return (new MailMessage())
            ->greeting('Hello ' . $this->server->user . '!')
            ->line('You have been added as a subuser for the following server, allowing you certain control over the server.')
            ->line('Server Name: ' . $this->server->name)
            ->action('Visit Server', url('/server/' . $this->server->uuidShort));
    }
}
</file>

<file path="app/Notifications/MailTested.php">
<?php

namespace Jexactyl\Notifications;

use Jexactyl\Models\User;
use Illuminate\Notifications\Notification;
use Illuminate\Notifications\Messages\MailMessage;

class MailTested extends Notification
{
    public function __construct(private User $user)
    {
    }

    public function via(): array
    {
        return ['mail'];
    }

    public function toMail(): MailMessage
    {
        return (new MailMessage())
            ->subject('Jexactyl Test Message')
            ->greeting('Hello ' . $this->user->name . '!')
            ->line('This is a test of the Jexactyl mail system. You\'re good to go!');
    }
}
</file>

<file path="app/Notifications/RemovedFromServer.php">
<?php

namespace Jexactyl\Notifications;

use Illuminate\Bus\Queueable;
use Illuminate\Notifications\Notification;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Notifications\Messages\MailMessage;

class RemovedFromServer extends Notification implements ShouldQueue
{
    use Queueable;

    public object $server;

    /**
     * Create a new notification instance.
     */
    public function __construct(array $server)
    {
        $this->server = (object) $server;
    }

    /**
     * Get the notification's delivery channels.
     */
    public function via(): array
    {
        return ['mail'];
    }

    /**
     * Get the mail representation of the notification.
     */
    public function toMail(): MailMessage
    {
        return (new MailMessage())
            ->error()
            ->greeting('Hello ' . $this->server->user . '.')
            ->line('You have been removed as a subuser for the following server.')
            ->line('Server Name: ' . $this->server->name)
            ->action('Visit Panel', route('index'));
    }
}
</file>

<file path="app/Notifications/SendPasswordReset.php">
<?php

namespace Jexactyl\Notifications;

use Illuminate\Bus\Queueable;
use Illuminate\Notifications\Notification;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Notifications\Messages\MailMessage;

class SendPasswordReset extends Notification implements ShouldQueue
{
    use Queueable;

    /**
     * Create a new notification instance.
     */
    public function __construct(public string $token)
    {
    }

    /**
     * Get the notification's delivery channels.
     */
    public function via(): array
    {
        return ['mail'];
    }

    /**
     * Get the mail representation of the notification.
     */
    public function toMail(mixed $notifiable): MailMessage
    {
        return (new MailMessage())
            ->subject('Reset Password')
            ->line('You are receiving this email because we received a password reset request for your account.')
            ->action('Reset Password', url('/auth/password/reset/' . $this->token . '?email=' . urlencode($notifiable->email)))
            ->line('If you did not request a password reset, no further action is required.');
    }
}
</file>

<file path="app/Notifications/ServerInstalled.php">
<?php

namespace Jexactyl\Notifications;

use Jexactyl\Models\User;
use Jexactyl\Events\Event;
use Jexactyl\Models\Server;
use Illuminate\Bus\Queueable;
use Illuminate\Container\Container;
use Jexactyl\Events\Server\Installed;
use Illuminate\Notifications\Notification;
use Illuminate\Contracts\Queue\ShouldQueue;
use Jexactyl\Contracts\Core\ReceivesEvents;
use Illuminate\Contracts\Notifications\Dispatcher;
use Illuminate\Notifications\Messages\MailMessage;

class ServerInstalled extends Notification implements ShouldQueue, ReceivesEvents
{
    use Queueable;

    public Server $server;

    public User $user;

    /**
     * Handle a direct call to this notification from the server installed event. This is configured
     * in the event service provider.
     */
    public function handle(Event|Installed $event): void
    {
        $event->server->loadMissing('user');

        $this->server = $event->server;
        $this->user = $event->server->user;

        // Since we are calling this notification directly from an event listener we need to fire off the dispatcher
        // to send the email now. Don't use send() or you'll end up firing off two different events.
        Container::getInstance()->make(Dispatcher::class)->sendNow($this->user, $this);
    }

    /**
     * Get the notification's delivery channels.
     */
    public function via(): array
    {
        return ['mail'];
    }

    /**
     * Get the mail representation of the notification.
     */
    public function toMail(): MailMessage
    {
        return (new MailMessage())
            ->greeting('Hello ' . $this->user->username . '.')
            ->line('Your server has finished installing and is now ready for you to use.')
            ->line('Server Name: ' . $this->server->name)
            ->action('Login and Begin Using', route('index'));
    }
}
</file>

<file path="app/Notifications/VerifyEmail.php">
<?php

namespace Jexactyl\Notifications;

use Jexactyl\Models\User;
use Illuminate\Bus\Queueable;
use Illuminate\Notifications\Notification;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Notifications\Messages\MailMessage;

class VerifyEmail extends Notification implements ShouldQueue
{
    use Queueable;

    public function __construct(private User $user, private string $name, private string $token)
    {
    }

    public function via(): array
    {
        return ['mail'];
    }

    public function toMail(): MailMessage
    {
        $message = new MailMessage();
        $message->greeting('Hello ' . $this->user->username . '! Welcome to ' . $this->name . '.');
        $message->line('Please click the link below to verify your email address.');
        $message->action('Verify Email', url('/auth/verify/' . $this->token));
        $message->line('If you did not create this account please contact ' . $this->name . '.');

        return $message;
    }
}
</file>

<file path="app/Observers/EggVariableObserver.php">
<?php

namespace Jexactyl\Observers;

use Jexactyl\Models\EggVariable;

class EggVariableObserver
{
    public function creating(EggVariable $variable): void
    {
        if ($variable->field_type) {
            unset($variable->field_type);
        }
    }

    public function updating(EggVariable $variable): void
    {
        if ($variable->field_type) {
            unset($variable->field_type);
        }
    }
}
</file>

<file path="app/Observers/ServerObserver.php">
<?php

namespace Jexactyl\Observers;

use Jexactyl\Events;
use Jexactyl\Models\Server;
use Illuminate\Foundation\Bus\DispatchesJobs;

class ServerObserver
{
    use DispatchesJobs;

    /**
     * Listen to the Server creating event.
     */
    public function creating(Server $server): void
    {
        event(new Events\Server\Creating($server));
    }

    /**
     * Listen to the Server created event.
     */
    public function created(Server $server): void
    {
        event(new Events\Server\Created($server));
    }

    /**
     * Listen to the Server deleting event.
     */
    public function deleting(Server $server): void
    {
        event(new Events\Server\Deleting($server));
    }

    /**
     * Listen to the Server deleted event.
     */
    public function deleted(Server $server): void
    {
        event(new Events\Server\Deleted($server));
    }

    /**
     * Listen to the Server saving event.
     */
    public function saving(Server $server): void
    {
        event(new Events\Server\Saving($server));
    }

    /**
     * Listen to the Server saved event.
     */
    public function saved(Server $server): void
    {
        event(new Events\Server\Saved($server));
    }

    /**
     * Listen to the Server updating event.
     */
    public function updating(Server $server): void
    {
        event(new Events\Server\Updating($server));
    }

    /**
     * Listen to the Server saved event.
     */
    public function updated(Server $server): void
    {
        event(new Events\Server\Updated($server));
    }
}
</file>

<file path="app/Observers/SubuserObserver.php">
<?php

namespace Jexactyl\Observers;

use Jexactyl\Events;
use Jexactyl\Models\Subuser;
use Jexactyl\Notifications\AddedToServer;
use Jexactyl\Notifications\RemovedFromServer;

class SubuserObserver
{
    /**
     * Listen to the Subuser creating event.
     */
    public function creating(Subuser $subuser): void
    {
        event(new Events\Subuser\Creating($subuser));
    }

    /**
     * Listen to the Subuser created event.
     */
    public function created(Subuser $subuser): void
    {
        event(new Events\Subuser\Created($subuser));

        $subuser->user->notify(new AddedToServer([
            'user' => $subuser->user->name_first,
            'name' => $subuser->server->name,
            'uuidShort' => $subuser->server->uuidShort,
        ]));
    }

    /**
     * Listen to the Subuser deleting event.
     */
    public function deleting(Subuser $subuser): void
    {
        event(new Events\Subuser\Deleting($subuser));
    }

    /**
     * Listen to the Subuser deleted event.
     */
    public function deleted(Subuser $subuser): void
    {
        event(new Events\Subuser\Deleted($subuser));

        $subuser->user->notify(new RemovedFromServer([
            'user' => $subuser->user->name_first,
            'name' => $subuser->server->name,
        ]));
    }
}
</file>

<file path="app/Observers/UserObserver.php">
<?php

namespace Jexactyl\Observers;

use Jexactyl\Events;
use Jexactyl\Models\User;

class UserObserver
{
    protected string $uuid;

    /**
     * Listen to the User creating event.
     */
    public function creating(User $user): void
    {
        event(new Events\User\Creating($user));
    }

    /**
     * Listen to the User created event.
     */
    public function created(User $user): void
    {
        event(new Events\User\Created($user));
    }

    /**
     * Listen to the User deleting event.
     */
    public function deleting(User $user): void
    {
        event(new Events\User\Deleting($user));
    }

    /**
     * Listen to the User deleted event.
     */
    public function deleted(User $user): void
    {
        event(new Events\User\Deleted($user));
    }
}
</file>

<file path="app/Policies/.gitkeep">

</file>

<file path="app/Policies/ServerPolicy.php">
<?php

namespace Jexactyl\Policies;

use Jexactyl\Models\User;
use Jexactyl\Models\Server;

class ServerPolicy
{
    /**
     * Checks if the user has the given permission on/for the server.
     */
    protected function checkPermission(User $user, Server $server, string $permission): bool
    {
        $subuser = $server->subusers->where('user_id', $user->id)->first();
        if (!$subuser || empty($permission)) {
            return false;
        }

        return in_array($permission, $subuser->permissions);
    }

    /**
     * Runs before any of the functions are called. Used to determine if user is root admin, if so, ignore permissions.
     */
    public function before(User $user, string $ability, Server $server): bool
    {
        if ($user->root_admin || $server->owner_id === $user->id) {
            return true;
        }

        return $this->checkPermission($user, $server, $ability);
    }

    /**
     * This is a horrendous hack to avoid Laravel's "smart" behavior that does
     * not call the before() function if there isn't a function matching the
     * policy permission.
     */
    public function __call(string $name, mixed $arguments)
    {
        // do nothing
    }
}
</file>

<file path="app/Providers/ActivityLogServiceProvider.php">
<?php

namespace Jexactyl\Providers;

use Illuminate\Support\ServiceProvider;
use Jexactyl\Services\Activity\ActivityLogBatchService;
use Jexactyl\Services\Activity\ActivityLogTargetableService;

class ActivityLogServiceProvider extends ServiceProvider
{
    /**
     * Registers the necessary activity logger singletons scoped to the individual
     * request instances.
     */
    public function register()
    {
        $this->app->scoped(ActivityLogBatchService::class);
        $this->app->scoped(ActivityLogTargetableService::class);
    }
}
</file>

<file path="app/Providers/AppServiceProvider.php">
<?php

namespace Jexactyl\Providers;

use Jexactyl\Models;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\URL;
use Illuminate\Pagination\Paginator;
use Illuminate\Support\Facades\View;
use Illuminate\Support\Facades\Cache;
use Jexactyl\Extensions\Themes\Theme;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\ServiceProvider;
use Illuminate\Database\Eloquent\Relations\Relation;

class AppServiceProvider extends ServiceProvider
{
    /**
     * Bootstrap any application services.
     */
    public function boot()
    {
        Schema::defaultStringLength(191);

        View::share('appVersion', $this->versionData()['version'] ?? 'undefined');
        View::share('appIsGit', $this->versionData()['is_git'] ?? false);

        Paginator::useBootstrap();

        // If the APP_URL value is set with https:// make sure we force it here. Theoretically
        // this should just work with the proxy logic, but there are a lot of cases where it
        // doesn't, and it triggers a lot of support requests, so lets just head it off here.
        //
        // @see https://github.com/pterodactyl/panel/issues/3623
        if (Str::startsWith(config('app.url') ?? '', 'https://')) {
            URL::forceScheme('https');
        }

        Relation::enforceMorphMap([
            'allocation' => Models\Allocation::class,
            'api_key' => Models\ApiKey::class,
            'backup' => Models\Backup::class,
            'database' => Models\Database::class,
            'egg' => Models\Egg::class,
            'egg_variable' => Models\EggVariable::class,
            'schedule' => Models\Schedule::class,
            'server' => Models\Server::class,
            'ssh_key' => Models\UserSSHKey::class,
            'task' => Models\Task::class,
            'user' => Models\User::class,
        ]);
    }

    /**
     * Register application service providers.
     */
    public function register()
    {
        // Only load the settings service provider if the environment
        // is configured to allow it.
        if (!config('jexactyl.load_environment_only', false) && $this->app->environment() !== 'testing') {
            $this->app->register(SettingsServiceProvider::class);
        }

        $this->app->singleton('extensions.themes', function () {
            return new Theme();
        });
    }

    /**
     * Return version information for the footer.
     */
    protected function versionData(): array
    {
        return Cache::remember('git-version', 5, function () {
            if (file_exists(base_path('.git/HEAD'))) {
                $head = explode(' ', file_get_contents(base_path('.git/HEAD')));

                if (array_key_exists(1, $head)) {
                    $path = base_path('.git/' . trim($head[1]));
                }
            }

            if (isset($path) && file_exists($path)) {
                return [
                    'version' => substr(file_get_contents($path), 0, 8),
                    'is_git' => true,
                ];
            }

            return [
                'version' => config('app.version'),
                'is_git' => false,
            ];
        });
    }
}
</file>

<file path="app/Providers/AuthServiceProvider.php">
<?php

namespace Jexactyl\Providers;

use Jexactyl\Models\ApiKey;
use Jexactyl\Models\Server;
use Laravel\Sanctum\Sanctum;
use Jexactyl\Policies\ServerPolicy;
use Illuminate\Foundation\Support\Providers\AuthServiceProvider as ServiceProvider;

class AuthServiceProvider extends ServiceProvider
{
    /**
     * The model to policy mappings for the application.
     */
    protected $policies = [
        Server::class => ServerPolicy::class,
    ];

    public function boot()
    {
        Sanctum::usePersonalAccessTokenModel(ApiKey::class);

        $this->registerPolicies();
    }

    public function register()
    {
        Sanctum::ignoreMigrations();
    }
}
</file>

<file path="app/Providers/BackupsServiceProvider.php">
<?php

namespace Jexactyl\Providers;

use Illuminate\Support\ServiceProvider;
use Jexactyl\Extensions\Backups\BackupManager;
use Illuminate\Contracts\Support\DeferrableProvider;

class BackupsServiceProvider extends ServiceProvider implements DeferrableProvider
{
    /**
     * Register the S3 backup disk.
     */
    public function register()
    {
        $this->app->singleton(BackupManager::class, function ($app) {
            return new BackupManager($app);
        });
    }

    public function provides(): array
    {
        return [BackupManager::class];
    }
}
</file>

<file path="app/Providers/BladeServiceProvider.php">
<?php

namespace Jexactyl\Providers;

use Illuminate\Support\ServiceProvider;

class BladeServiceProvider extends ServiceProvider
{
    /**
     * Perform post-registration booting of services.
     */
    public function boot()
    {
        $this->app->make('blade.compiler')
            ->directive('datetimeHuman', function ($expression) {
                return "<?php echo \Carbon\CarbonImmutable::createFromFormat(\Carbon\CarbonImmutable::DEFAULT_TO_STRING_FORMAT, $expression)->setTimezone(config('app.timezone'))->toDateTimeString(); ?>";
            });
    }
}
</file>

<file path="app/Providers/BroadcastServiceProvider.php">
<?php

namespace Jexactyl\Providers;

use Illuminate\Support\ServiceProvider;
use Illuminate\Support\Facades\Broadcast;

class BroadcastServiceProvider extends ServiceProvider
{
    /**
     * Bootstrap any application services.
     */
    public function boot()
    {
        Broadcast::routes();

        /*
         * Authenticate the user's personal channel...
         */
        Broadcast::channel('App.User.*', function ($user, $userId) {
            return (int) $user->id === (int) $userId;
        });
    }
}
</file>

<file path="app/Providers/EventServiceProvider.php">
<?php

namespace Jexactyl\Providers;

use Jexactyl\Models\User;
use Jexactyl\Models\Server;
use Jexactyl\Models\Subuser;
use Jexactyl\Models\EggVariable;
use Jexactyl\Observers\UserObserver;
use Jexactyl\Observers\ServerObserver;
use Jexactyl\Observers\SubuserObserver;
use Jexactyl\Observers\EggVariableObserver;
use Jexactyl\Listeners\Auth\AuthenticationListener;
use Jexactyl\Events\Server\Installed as ServerInstalledEvent;
use Jexactyl\Notifications\ServerInstalled as ServerInstalledNotification;
use Illuminate\Foundation\Support\Providers\EventServiceProvider as ServiceProvider;

class EventServiceProvider extends ServiceProvider
{
    /**
     * The event to listener mappings for the application.
     */
    protected $listen = [
        ServerInstalledEvent::class => [ServerInstalledNotification::class],
    ];

    protected $subscribe = [
        AuthenticationListener::class,
    ];

    /**
     * Register any events for your application.
     */
    public function boot(): void
    {
        parent::boot();

        User::observe(UserObserver::class);
        Server::observe(ServerObserver::class);
        Subuser::observe(SubuserObserver::class);
        EggVariable::observe(EggVariableObserver::class);
    }
}
</file>

<file path="app/Providers/HashidsServiceProvider.php">
<?php

namespace Jexactyl\Providers;

use Jexactyl\Extensions\Hashids;
use Illuminate\Support\ServiceProvider;
use Jexactyl\Contracts\Extensions\HashidsInterface;

class HashidsServiceProvider extends ServiceProvider
{
    /**
     * Register the ability to use Hashids.
     */
    public function register()
    {
        $this->app->singleton(HashidsInterface::class, function () {
            /** @var \Illuminate\Contracts\Config\Repository $config */
            $config = $this->app['config'];

            return new Hashids(
                $config->get('hashids.salt', ''),
                $config->get('hashids.length', 0),
                $config->get('hashids.alphabet', 'abcdefghijkmlnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890')
            );
        });

        $this->app->alias(HashidsInterface::class, 'hashids');
    }
}
</file>

<file path="app/Providers/RepositoryServiceProvider.php">
<?php

namespace Jexactyl\Providers;

use Illuminate\Support\ServiceProvider;
use Jexactyl\Repositories\Eloquent\EggRepository;
use Jexactyl\Repositories\Eloquent\NestRepository;
use Jexactyl\Repositories\Eloquent\NodeRepository;
use Jexactyl\Repositories\Eloquent\TaskRepository;
use Jexactyl\Repositories\Eloquent\UserRepository;
use Jexactyl\Repositories\Eloquent\ApiKeyRepository;
use Jexactyl\Repositories\Eloquent\ServerRepository;
use Jexactyl\Repositories\Eloquent\SessionRepository;
use Jexactyl\Repositories\Eloquent\SubuserRepository;
use Jexactyl\Repositories\Eloquent\DatabaseRepository;
use Jexactyl\Repositories\Eloquent\LocationRepository;
use Jexactyl\Repositories\Eloquent\ScheduleRepository;
use Jexactyl\Repositories\Eloquent\SettingsRepository;
use Jexactyl\Repositories\Eloquent\AllocationRepository;
use Jexactyl\Contracts\Repository\EggRepositoryInterface;
use Jexactyl\Repositories\Eloquent\EggVariableRepository;
use Jexactyl\Contracts\Repository\NestRepositoryInterface;
use Jexactyl\Contracts\Repository\NodeRepositoryInterface;
use Jexactyl\Contracts\Repository\TaskRepositoryInterface;
use Jexactyl\Contracts\Repository\UserRepositoryInterface;
use Jexactyl\Repositories\Eloquent\DatabaseHostRepository;
use Jexactyl\Contracts\Repository\ApiKeyRepositoryInterface;
use Jexactyl\Contracts\Repository\ServerRepositoryInterface;
use Jexactyl\Repositories\Eloquent\ServerVariableRepository;
use Jexactyl\Contracts\Repository\SessionRepositoryInterface;
use Jexactyl\Contracts\Repository\SubuserRepositoryInterface;
use Jexactyl\Contracts\Repository\DatabaseRepositoryInterface;
use Jexactyl\Contracts\Repository\LocationRepositoryInterface;
use Jexactyl\Contracts\Repository\ScheduleRepositoryInterface;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;
use Jexactyl\Contracts\Repository\AllocationRepositoryInterface;
use Jexactyl\Contracts\Repository\EggVariableRepositoryInterface;
use Jexactyl\Contracts\Repository\DatabaseHostRepositoryInterface;
use Jexactyl\Contracts\Repository\ServerVariableRepositoryInterface;

class RepositoryServiceProvider extends ServiceProvider
{
    /**
     * Register all of the repository bindings.
     */
    public function register()
    {
        // Eloquent Repositories
        $this->app->bind(AllocationRepositoryInterface::class, AllocationRepository::class);
        $this->app->bind(ApiKeyRepositoryInterface::class, ApiKeyRepository::class);
        $this->app->bind(DatabaseRepositoryInterface::class, DatabaseRepository::class);
        $this->app->bind(DatabaseHostRepositoryInterface::class, DatabaseHostRepository::class);
        $this->app->bind(EggRepositoryInterface::class, EggRepository::class);
        $this->app->bind(EggVariableRepositoryInterface::class, EggVariableRepository::class);
        $this->app->bind(LocationRepositoryInterface::class, LocationRepository::class);
        $this->app->bind(NestRepositoryInterface::class, NestRepository::class);
        $this->app->bind(NodeRepositoryInterface::class, NodeRepository::class);
        $this->app->bind(ScheduleRepositoryInterface::class, ScheduleRepository::class);
        $this->app->bind(ServerRepositoryInterface::class, ServerRepository::class);
        $this->app->bind(ServerVariableRepositoryInterface::class, ServerVariableRepository::class);
        $this->app->bind(SessionRepositoryInterface::class, SessionRepository::class);
        $this->app->bind(SettingsRepositoryInterface::class, SettingsRepository::class);
        $this->app->bind(SubuserRepositoryInterface::class, SubuserRepository::class);
        $this->app->bind(TaskRepositoryInterface::class, TaskRepository::class);
        $this->app->bind(UserRepositoryInterface::class, UserRepository::class);
    }
}
</file>

<file path="app/Providers/SettingsServiceProvider.php">
<?php

namespace Jexactyl\Providers;

use Psr\Log\LoggerInterface as Log;
use Illuminate\Database\QueryException;
use Illuminate\Support\ServiceProvider;
use Illuminate\Contracts\Encryption\Encrypter;
use Illuminate\Contracts\Encryption\DecryptException;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;
use Illuminate\Contracts\Config\Repository as ConfigRepository;

class SettingsServiceProvider extends ServiceProvider
{
    /**
     * An array of configuration keys to override with database values
     * if they exist.
     */
    protected array $keys = [
        'app:logo',
        'app:name',
        'app:locale',
        'theme:admin',
        'recaptcha:enabled',
        'recaptcha:secret_key',
        'recaptcha:website_key',
        'theme:user:background',
        'jexactyl:guzzle:timeout',
        'jexactyl:auth:2fa_required',
        'jexactyl:guzzle:connect_timeout',
        'jexactyl:client_features:allocations:enabled',
        'jexactyl:client_features:allocations:range_end',
        'jexactyl:client_features:allocations:range_start',
    ];

    /**
     * Keys specific to the mail driver that are only grabbed from the database
     * when using the SMTP driver.
     */
    protected array $emailKeys = [
        'mail:mailers:smtp:host',
        'mail:mailers:smtp:port',
        'mail:mailers:smtp:encryption',
        'mail:mailers:smtp:username',
        'mail:mailers:smtp:password',
        'mail:from:address',
        'mail:from:name',
    ];

    /**
     * Keys that are encrypted and should be decrypted when set in the
     * configuration array.
     */
    protected static array $encrypted = [
        'mail:mailers:smtp:password',
    ];

    /**
     * Boot the service provider.
     */
    public function boot(ConfigRepository $config, Encrypter $encrypter, Log $log, SettingsRepositoryInterface $settings)
    {
        // Only set the email driver settings from the database if we
        // are configured using SMTP as the driver.
        if ($config->get('mail.default') === 'smtp') {
            $this->keys = array_merge($this->keys, $this->emailKeys);
        }

        try {
            $values = $settings->all()->mapWithKeys(function ($setting) {
                return [$setting->key => $setting->value];
            })->toArray();
        } catch (QueryException $exception) {
            $log->notice('A query exception was encountered while trying to load settings from the database: ' . $exception->getMessage());

            return;
        }

        foreach ($this->keys as $key) {
            $value = array_get($values, 'settings::' . $key, $config->get(str_replace(':', '.', $key)));
            if (in_array($key, self::$encrypted)) {
                try {
                    $value = $encrypter->decrypt($value);
                } catch (DecryptException $exception) {
                }
            }

            switch (strtolower($value)) {
                case 'true':
                case '(true)':
                    $value = true;
                    break;
                case 'false':
                case '(false)':
                    $value = false;
                    break;
                case 'empty':
                case '(empty)':
                    $value = '';
                    break;
                case 'null':
                case '(null)':
                    $value = null;
            }

            $config->set(str_replace(':', '.', $key), $value);
        }
    }

    public static function getEncryptedKeys(): array
    {
        return self::$encrypted;
    }
}
</file>

<file path="app/Providers/ViewComposerServiceProvider.php">
<?php

namespace Jexactyl\Providers;

use Illuminate\Support\ServiceProvider;
use Jexactyl\Http\ViewComposers\StoreComposer;
use Jexactyl\Http\ViewComposers\SettingComposer;

class ViewComposerServiceProvider extends ServiceProvider
{
    /**
     * Register bindings in the container.
     */
    public function boot()
    {
        $this->app->make('view')->composer('*', SettingComposer::class);
        $this->app->make('view')->composer('*', StoreComposer::class);
    }
}
</file>

<file path="app/Repositories/Eloquent/AllocationRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\Allocation;
use Illuminate\Database\Eloquent\Builder;
use Jexactyl\Contracts\Repository\AllocationRepositoryInterface;

class AllocationRepository extends EloquentRepository implements AllocationRepositoryInterface
{
    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return Allocation::class;
    }

    /**
     * Return all the allocations that exist for a node that are not currently
     * allocated.
     */
    public function getUnassignedAllocationIds(int $node): array
    {
        return Allocation::query()->select('id')
            ->whereNull('server_id')
            ->where('node_id', $node)
            ->get()
            ->pluck('id')
            ->toArray();
    }

    /**
     * Return a concatenated result set of node ips that already have at least one
     * server assigned to that IP. This allows for filtering out sets for
     * dedicated allocation IPs.
     *
     * If an array of nodes is passed the results will be limited to allocations
     * in those nodes.
     */
    protected function getDiscardableDedicatedAllocations(array $nodes = []): array
    {
        $query = Allocation::query()->selectRaw('CONCAT_WS("-", node_id, ip) as result');

        if (!empty($nodes)) {
            $query->whereIn('node_id', $nodes);
        }

        return $query->whereNotNull('server_id')
            ->groupByRaw('CONCAT(node_id, ip)')
            ->get()
            ->pluck('result')
            ->toArray();
    }

    /**
     * Return a single allocation from those meeting the requirements.
     */
    public function getRandomAllocation(array $nodes, array $ports, bool $dedicated = false): ?Allocation
    {
        $query = Allocation::query()->whereNull('server_id');

        if (!empty($nodes)) {
            $query->whereIn('node_id', $nodes);
        }

        if (!empty($ports)) {
            $query->where(function (Builder $inner) use ($ports) {
                $whereIn = [];
                foreach ($ports as $port) {
                    if (is_array($port)) {
                        $inner->orWhereBetween('port', $port);
                        continue;
                    }

                    $whereIn[] = $port;
                }

                if (!empty($whereIn)) {
                    $inner->orWhereIn('port', $whereIn);
                }
            });
        }

        // If this allocation should not be shared with any other servers get
        // the data and modify the query as necessary,
        if ($dedicated) {
            $discard = $this->getDiscardableDedicatedAllocations($nodes);

            if (!empty($discard)) {
                $query->whereNotIn(
                    $this->getBuilder()->raw('CONCAT_WS("-", node_id, ip)'),
                    $discard
                );
            }
        }

        return $query->inRandomOrder()->first();
    }
}
</file>

<file path="app/Repositories/Eloquent/ApiKeyRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\User;
use Jexactyl\Models\ApiKey;
use Illuminate\Support\Collection;
use Jexactyl\Contracts\Repository\ApiKeyRepositoryInterface;

class ApiKeyRepository extends EloquentRepository implements ApiKeyRepositoryInterface
{
    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return ApiKey::class;
    }

    /**
     * Get all the account API keys that exist for a specific user.
     */
    public function getAccountKeys(User $user): Collection
    {
        return $this->getBuilder()->where('user_id', $user->id)
            ->where('key_type', ApiKey::TYPE_ACCOUNT)
            ->get($this->getColumns());
    }

    /**
     * Get all the application API keys that exist for a specific user.
     */
    public function getApplicationKeys(User $user): Collection
    {
        return $this->getBuilder()->where('user_id', $user->id)
            ->where('key_type', ApiKey::TYPE_APPLICATION)
            ->get($this->getColumns());
    }

    /**
     * Delete an account API key from the panel for a specific user.
     */
    public function deleteAccountKey(User $user, string $identifier): int
    {
        return $this->getBuilder()->where('user_id', $user->id)
            ->where('key_type', ApiKey::TYPE_ACCOUNT)
            ->where('identifier', $identifier)
            ->delete();
    }

    /**
     * Delete an application API key from the panel for a specific user.
     */
    public function deleteApplicationKey(User $user, string $identifier): int
    {
        return $this->getBuilder()->where('user_id', $user->id)
            ->where('key_type', ApiKey::TYPE_APPLICATION)
            ->where('identifier', $identifier)
            ->delete();
    }
}
</file>

<file path="app/Repositories/Eloquent/BackupRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Carbon\Carbon;
use Jexactyl\Models\Backup;
use Jexactyl\Models\Server;
use Illuminate\Support\Collection;
use Illuminate\Database\Eloquent\Relations\HasMany;

class BackupRepository extends EloquentRepository
{
    public function model(): string
    {
        return Backup::class;
    }

    /**
     * Determines if too many backups have been generated by the server.
     */
    public function getBackupsGeneratedDuringTimespan(int $server, int $seconds = 600): array|Collection
    {
        return $this->getBuilder()
            ->withTrashed()
            ->where('server_id', $server)
            ->where(function ($query) {
                $query->whereNull('completed_at')
                    ->orWhere('is_successful', '=', true);
            })
            ->where('created_at', '>=', Carbon::now()->subSeconds($seconds)->toDateTimeString())
            ->get()
            ->toBase();
    }

    /**
     * Returns a query filtering only non-failed backups for a specific server.
     */
    public function getNonFailedBackups(Server $server): HasMany
    {
        return $server->backups()->where(function ($query) {
            $query->whereNull('completed_at')
                ->orWhere('is_successful', true);
        });
    }
}
</file>

<file path="app/Repositories/Eloquent/DatabaseHostRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\DatabaseHost;
use Illuminate\Support\Collection;
use Jexactyl\Contracts\Repository\DatabaseHostRepositoryInterface;

class DatabaseHostRepository extends EloquentRepository implements DatabaseHostRepositoryInterface
{
    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return DatabaseHost::class;
    }

    /**
     * Return database hosts with a count of databases and the node
     * information for which it is attached.
     */
    public function getWithViewDetails(): Collection
    {
        return $this->getBuilder()->withCount('databases')->with('node')->get();
    }
}
</file>

<file path="app/Repositories/Eloquent/DatabaseRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\Database;
use Illuminate\Support\Collection;
use Illuminate\Foundation\Application;
use Illuminate\Database\DatabaseManager;
use Illuminate\Contracts\Pagination\LengthAwarePaginator;
use Jexactyl\Contracts\Repository\DatabaseRepositoryInterface;

class DatabaseRepository extends EloquentRepository implements DatabaseRepositoryInterface
{
    protected string $connection = self::DEFAULT_CONNECTION_NAME;

    /**
     * DatabaseRepository constructor.
     */
    public function __construct(Application $application, private DatabaseManager $database)
    {
        parent::__construct($application);
    }

    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return Database::class;
    }

    /**
     * Return the connection to execute statements against.
     */
    public function getConnection(): string
    {
        return $this->connection;
    }

    /**
     * Set the connection name to execute statements against.
     */
    public function setConnection(string $connection): self
    {
        $this->connection = $connection;

        return $this;
    }

    /**
     * Return all the databases belonging to a server.
     */
    public function getDatabasesForServer(int $server): Collection
    {
        return $this->getBuilder()->with('host')->where('server_id', $server)->get($this->getColumns());
    }

    /**
     * Return all the databases for a given host with the server relationship loaded.
     */
    public function getDatabasesForHost(int $host, int $count = 25): LengthAwarePaginator
    {
        return $this->getBuilder()->with('server')
            ->where('database_host_id', $host)
            ->paginate($count, $this->getColumns());
    }

    /**
     * Create a new database on a given connection.
     */
    public function createDatabase(string $database): bool
    {
        return $this->run(sprintf('CREATE DATABASE IF NOT EXISTS `%s`', $database));
    }

    /**
     * Create a new database user on a given connection.
     */
    public function createUser(string $username, string $remote, string $password, ?int $max_connections): bool
    {
        $args = [$username, $remote, $password];
        $command = 'CREATE USER `%s`@`%s` IDENTIFIED BY \'%s\'';

        if (!empty($max_connections)) {
            $args[] = $max_connections;
            $command .= ' WITH MAX_USER_CONNECTIONS %s';
        }

        return $this->run(sprintf($command, ...$args));
    }

    /**
     * Give a specific user access to a given database.
     */
    public function assignUserToDatabase(string $database, string $username, string $remote): bool
    {
        return $this->run(sprintf(
            'GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, ALTER, REFERENCES, INDEX, LOCK TABLES, CREATE ROUTINE, ALTER ROUTINE, EXECUTE, CREATE TEMPORARY TABLES, CREATE VIEW, SHOW VIEW, EVENT, TRIGGER ON `%s`.* TO `%s`@`%s`',
            $database,
            $username,
            $remote
        ));
    }

    /**
     * Flush the privileges for a given connection.
     */
    public function flush(): bool
    {
        return $this->run('FLUSH PRIVILEGES');
    }

    /**
     * Drop a given database on a specific connection.
     */
    public function dropDatabase(string $database): bool
    {
        return $this->run(sprintf('DROP DATABASE IF EXISTS `%s`', $database));
    }

    /**
     * Drop a given user on a specific connection.
     */
    public function dropUser(string $username, string $remote): bool
    {
        return $this->run(sprintf('DROP USER IF EXISTS `%s`@`%s`', $username, $remote));
    }

    /**
     * Run the provided statement against the database on a given connection.
     */
    private function run(string $statement): bool
    {
        return $this->database->connection($this->getConnection())->statement($statement);
    }
}
</file>

<file path="app/Repositories/Eloquent/EggRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\Egg;
use Webmozart\Assert\Assert;
use Illuminate\Database\Eloquent\Collection;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Jexactyl\Contracts\Repository\EggRepositoryInterface;
use Jexactyl\Exceptions\Repository\RecordNotFoundException;

class EggRepository extends EloquentRepository implements EggRepositoryInterface
{
    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return Egg::class;
    }

    /**
     * Return an egg with the variables relation attached.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithVariables(int $id): Egg
    {
        try {
            return $this->getBuilder()->with('variables')->findOrFail($id, $this->getColumns());
        } catch (ModelNotFoundException) {
            throw new RecordNotFoundException();
        }
    }

    /**
     * Return all eggs and their relations to be used in the daemon API.
     */
    public function getAllWithCopyAttributes(): Collection
    {
        return $this->getBuilder()->with('scriptFrom', 'configFrom')->get($this->getColumns());
    }

    /**
     * Return an egg with the scriptFrom and configFrom relations loaded onto the model.
     *
     * @param int|string $value
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithCopyAttributes($value, string $column = 'id'): Egg
    {
        Assert::true(is_digit($value) || is_string($value), 'First argument passed to getWithCopyAttributes must be an integer or string, received %s.');

        try {
            return $this->getBuilder()->with('scriptFrom', 'configFrom')->where($column, '=', $value)->firstOrFail($this->getColumns());
        } catch (ModelNotFoundException) {
            throw new RecordNotFoundException();
        }
    }

    /**
     * Return all the data needed to export a service.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithExportAttributes(int $id): Egg
    {
        try {
            return $this->getBuilder()->with('scriptFrom', 'configFrom', 'variables')->findOrFail($id, $this->getColumns());
        } catch (ModelNotFoundException) {
            throw new RecordNotFoundException();
        }
    }

    /**
     * Confirm a copy script belongs to the same nest as the item trying to use it.
     */
    public function isCopyableScript(int $copyFromId, int $service): bool
    {
        return $this->getBuilder()->whereNull('copy_script_from')
            ->where('id', '=', $copyFromId)
            ->where('nest_id', '=', $service)
            ->exists();
    }
}
</file>

<file path="app/Repositories/Eloquent/EggVariableRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\EggVariable;
use Illuminate\Support\Collection;
use Jexactyl\Contracts\Repository\EggVariableRepositoryInterface;

class EggVariableRepository extends EloquentRepository implements EggVariableRepositoryInterface
{
    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return EggVariable::class;
    }

    /**
     * Return editable variables for a given egg. Editable variables must be set to
     * user viewable in order to be picked up by this function.
     */
    public function getEditableVariables(int $egg): Collection
    {
        return $this->getBuilder()->where([
            ['egg_id', '=', $egg],
            ['user_viewable', '=', 1],
            ['user_editable', '=', 1],
        ])->get($this->getColumns());
    }
}
</file>

<file path="app/Repositories/Eloquent/EloquentRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Illuminate\Http\Request;
use Webmozart\Assert\Assert;
use Illuminate\Support\Collection;
use Jexactyl\Repositories\Repository;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Query\Expression;
use Jexactyl\Contracts\Repository\RepositoryInterface;
use Jexactyl\Exceptions\Model\DataValidationException;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Illuminate\Contracts\Pagination\LengthAwarePaginator;
use Jexactyl\Exceptions\Repository\RecordNotFoundException;

abstract class EloquentRepository extends Repository implements RepositoryInterface
{
    protected bool $useRequestFilters = false;

    /**
     * Determines if the repository function should use filters off the request object
     * present when returning results. This allows repository methods to be called in API
     * context's such that we can pass through ?filter[name]=Dane&sort=desc for example.
     */
    public function usingRequestFilters(bool $usingFilters = true): self
    {
        $this->useRequestFilters = $usingFilters;

        return $this;
    }

    /**
     * Returns the request instance.
     */
    protected function request(): Request
    {
        return $this->app->make(Request::class);
    }

    /**
     * Paginate the response data based on the page para.
     */
    protected function paginate(Builder $instance, int $default = 50): LengthAwarePaginator
    {
        if (!$this->useRequestFilters) {
            return $instance->paginate($default);
        }

        return $instance->paginate($this->request()->query('per_page', $default));
    }

    /**
     * Return an instance of the eloquent model bound to this
     * repository instance.
     */
    public function getModel(): Model
    {
        return $this->model;
    }

    /**
     * Return an instance of the builder to use for this repository.
     */
    public function getBuilder(): Builder
    {
        return $this->getModel()->newQuery();
    }

    /**
     * Create a new record in the database and return the associated model.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function create(array $fields, bool $validate = true, bool $force = false): Model|bool
    {
        $instance = $this->getBuilder()->newModelInstance();
        ($force) ? $instance->forceFill($fields) : $instance->fill($fields);

        if (!$validate) {
            $saved = $instance->skipValidation()->save();
        } else {
            if (!$saved = $instance->save()) {
                throw new DataValidationException($instance->getValidator(), $instance);
            }
        }

        return ($this->withFresh) ? $instance->fresh() : $saved;
    }

    /**
     * Find a model that has the specific ID passed.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function find(int $id): Model
    {
        try {
            return $this->getBuilder()->findOrFail($id, $this->getColumns());
        } catch (ModelNotFoundException) {
            throw new RecordNotFoundException();
        }
    }

    /**
     * Find a model matching an array of where clauses.
     */
    public function findWhere(array $fields): Collection
    {
        return $this->getBuilder()->where($fields)->get($this->getColumns());
    }

    /**
     * Find and return the first matching instance for the given fields.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function findFirstWhere(array $fields): Model
    {
        try {
            return $this->getBuilder()->where($fields)->firstOrFail($this->getColumns());
        } catch (ModelNotFoundException) {
            throw new RecordNotFoundException();
        }
    }

    /**
     * Return a count of records matching the passed arguments.
     */
    public function findCountWhere(array $fields): int
    {
        return $this->getBuilder()->where($fields)->count($this->getColumns());
    }

    /**
     * Delete a given record from the database.
     */
    public function delete(int $id, bool $destroy = false): int
    {
        return $this->deleteWhere(['id' => $id], $destroy);
    }

    /**
     * Delete records matching the given attributes.
     */
    public function deleteWhere(array $attributes, bool $force = false): int
    {
        $instance = $this->getBuilder()->where($attributes);

        return ($force) ? $instance->forceDelete() : $instance->delete();
    }

    /**
     * Update a given ID with the passed array of fields.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(int $id, array $fields, bool $validate = true, bool $force = false): Model|bool
    {
        try {
            $instance = $this->getBuilder()->where('id', $id)->firstOrFail();
        } catch (ModelNotFoundException) {
            throw new RecordNotFoundException();
        }

        ($force) ? $instance->forceFill($fields) : $instance->fill($fields);

        if (!$validate) {
            $saved = $instance->skipValidation()->save();
        } else {
            if (!$saved = $instance->save()) {
                throw new DataValidationException($instance->getValidator(), $instance);
            }
        }

        return ($this->withFresh) ? $instance->fresh() : $saved;
    }

    /**
     * Update a model using the attributes passed.
     */
    public function updateWhere(array $attributes, array $values): int
    {
        return $this->getBuilder()->where($attributes)->update($values);
    }

    /**
     * Perform a mass update where matching records are updated using whereIn.
     * This does not perform any model data validation.
     */
    public function updateWhereIn(string $column, array $values, array $fields): int
    {
        Assert::notEmpty($column, 'First argument passed to updateWhereIn must be a non-empty string.');

        return $this->getBuilder()->whereIn($column, $values)->update($fields);
    }

    /**
     * Update a record if it exists in the database, otherwise create it.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function updateOrCreate(array $where, array $fields, bool $validate = true, bool $force = false): Model|bool
    {
        foreach ($where as $item) {
            Assert::true(is_scalar($item) || is_null($item), 'First argument passed to updateOrCreate should be an array of scalar or null values, received an array value of %s.');
        }

        try {
            $instance = $this->setColumns('id')->findFirstWhere($where);
        } catch (RecordNotFoundException) {
            return $this->create(array_merge($where, $fields), $validate, $force);
        }

        return $this->update($instance->id, $fields, $validate, $force);
    }

    /**
     * Return all records associated with the given model.
     *
     * @deprecated Just use the model
     */
    public function all(): Collection
    {
        return $this->getBuilder()->get($this->getColumns());
    }

    /**
     * Return a paginated result set using a search term if set on the repository.
     */
    public function paginated(int $perPage): LengthAwarePaginator
    {
        return $this->getBuilder()->paginate($perPage, $this->getColumns());
    }

    /**
     * Insert a single or multiple records into the database at once skipping
     * validation and mass assignment checking.
     */
    public function insert(array $data): bool
    {
        return $this->getBuilder()->insert($data);
    }

    /**
     * Insert multiple records into the database and ignore duplicates.
     */
    public function insertIgnore(array $values): bool
    {
        if (empty($values)) {
            return true;
        }

        foreach ($values as $key => $value) {
            ksort($value);
            $values[$key] = $value;
        }

        $bindings = array_values(array_filter(array_flatten($values, 1), function ($binding) {
            return !$binding instanceof Expression;
        }));

        $grammar = $this->getBuilder()->toBase()->getGrammar();
        $table = $grammar->wrapTable($this->getModel()->getTable());
        $columns = $grammar->columnize(array_keys(reset($values)));

        $parameters = collect($values)->map(function ($record) use ($grammar) {
            return sprintf('(%s)', $grammar->parameterize($record));
        })->implode(', ');

        $statement = "insert ignore into $table ($columns) values $parameters";

        return $this->getBuilder()->getConnection()->statement($statement, $bindings);
    }

    /**
     * Get the amount of entries in the database.
     *
     * @deprecated just use the count method off a model
     */
    public function count(): int
    {
        return $this->getBuilder()->count();
    }
}
</file>

<file path="app/Repositories/Eloquent/LocationRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\Location;
use Illuminate\Support\Collection;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Jexactyl\Exceptions\Repository\RecordNotFoundException;
use Jexactyl\Contracts\Repository\LocationRepositoryInterface;

class LocationRepository extends EloquentRepository implements LocationRepositoryInterface
{
    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return Location::class;
    }

    /**
     * Return locations with a count of nodes and servers attached to it.
     */
    public function getAllWithDetails(): Collection
    {
        return $this->getBuilder()->withCount('nodes', 'servers')->get($this->getColumns());
    }

    /**
     * Return all the available locations with the nodes as a relationship.
     */
    public function getAllWithNodes(): Collection
    {
        return $this->getBuilder()->with('nodes')->get($this->getColumns());
    }

    /**
     * Return all the nodes and their respective count of servers for a location.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithNodes(int $id): Location
    {
        try {
            return $this->getBuilder()->with('nodes.servers')->findOrFail($id, $this->getColumns());
        } catch (ModelNotFoundException) {
            throw new RecordNotFoundException();
        }
    }

    /**
     * Return a location and the count of nodes in that location.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithNodeCount(int $id): Location
    {
        try {
            return $this->getBuilder()->withCount('nodes')->findOrFail($id, $this->getColumns());
        } catch (ModelNotFoundException) {
            throw new RecordNotFoundException();
        }
    }
}
</file>

<file path="app/Repositories/Eloquent/MountRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\Mount;
use Jexactyl\Models\Server;
use Illuminate\Support\Collection;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Jexactyl\Exceptions\Repository\RecordNotFoundException;

class MountRepository extends EloquentRepository
{
    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return Mount::class;
    }

    /**
     * Return mounts with a count of eggs, nodes, and servers attached to it.
     */
    public function getAllWithDetails(): Collection
    {
        return $this->getBuilder()->withCount('eggs', 'nodes')->get($this->getColumns());
    }

    /**
     * Return all the mounts and their respective relations.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithRelations(string $id): Mount
    {
        try {
            return $this->getBuilder()->with('eggs', 'nodes')->findOrFail($id, $this->getColumns());
        } catch (ModelNotFoundException $exception) {
            throw new RecordNotFoundException();
        }
    }

    /**
     * Return mounts available to a server (ignoring if they are or are not mounted).
     */
    public function getMountListForServer(Server $server): Collection
    {
        return $this->getBuilder()
            ->whereHas('eggs', function ($q) use ($server) {
                $q->where('id', '=', $server->egg_id);
            })
            ->whereHas('nodes', function ($q) use ($server) {
                $q->where('id', '=', $server->node_id);
            })
            ->get($this->getColumns());
    }
}
</file>

<file path="app/Repositories/Eloquent/NestRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\Nest;
use Illuminate\Database\Eloquent\Collection;
use Jexactyl\Contracts\Repository\NestRepositoryInterface;
use Jexactyl\Exceptions\Repository\RecordNotFoundException;

class NestRepository extends EloquentRepository implements NestRepositoryInterface
{
    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return Nest::class;
    }

    /**
     * Return a nest or all nests with their associated eggs and variables.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithEggs(int $id = null): Collection|Nest
    {
        $instance = $this->getBuilder()->with('eggs', 'eggs.variables');

        if (!is_null($id)) {
            $instance = $instance->find($id, $this->getColumns());
            if (!$instance) {
                throw new RecordNotFoundException();
            }

            return $instance;
        }

        return $instance->get($this->getColumns());
    }

    /**
     * Return a nest or all nests and the count of eggs and servers for that nest.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithCounts(int $id = null): Collection|Nest
    {
        $instance = $this->getBuilder()->withCount(['eggs', 'servers']);

        if (!is_null($id)) {
            $instance = $instance->find($id, $this->getColumns());
            if (!$instance) {
                throw new RecordNotFoundException();
            }

            return $instance;
        }

        return $instance->get($this->getColumns());
    }

    /**
     * Return a nest along with its associated eggs and the servers relation on those eggs.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithEggServers(int $id): Nest
    {
        $instance = $this->getBuilder()->with('eggs.servers')->find($id, $this->getColumns());
        if (!$instance) {
            throw new RecordNotFoundException();
        }

        /* @var Nest $instance */
        return $instance;
    }
}
</file>

<file path="app/Repositories/Eloquent/NodeRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\Node;
use Illuminate\Support\Collection;
use Jexactyl\Contracts\Repository\NodeRepositoryInterface;

class NodeRepository extends EloquentRepository implements NodeRepositoryInterface
{
    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return Node::class;
    }

    /**
     * Return the usage stats for a single node.
     */
    public function getUsageStats(Node $node): array
    {
        $stats = $this->getBuilder()
            ->selectRaw('IFNULL(SUM(servers.memory), 0) as sum_memory, IFNULL(SUM(servers.disk), 0) as sum_disk')
            ->join('servers', 'servers.node_id', '=', 'nodes.id')
            ->where('node_id', '=', $node->id)
            ->first();

        return Collection::make(['disk' => $stats->sum_disk, 'memory' => $stats->sum_memory])
            ->mapWithKeys(function ($value, $key) use ($node) {
                $maxUsage = $node->{$key};
                if ($node->{$key . '_overallocate'} > 0) {
                    $maxUsage = $node->{$key} * (1 + ($node->{$key . '_overallocate'} / 100));
                }

                $percent = ($value / $maxUsage) * 100;

                return [
                    $key => [
                        'value' => number_format($value),
                        'max' => number_format($maxUsage),
                        'percent' => $percent,
                        'css' => ($percent <= self::THRESHOLD_PERCENTAGE_LOW) ? 'green' : (($percent > self::THRESHOLD_PERCENTAGE_MEDIUM) ? 'red' : 'yellow'),
                    ],
                ];
            })
            ->toArray();
    }

    /**
     * Return the usage stats for a single node.
     */
    public function getUsageStatsRaw(Node $node): array
    {
        $stats = $this->getBuilder()->select(
            $this->getBuilder()->raw('IFNULL(SUM(servers.memory), 0) as sum_memory, IFNULL(SUM(servers.disk), 0) as sum_disk')
        )->join('servers', 'servers.node_id', '=', 'nodes.id')->where('node_id', $node->id)->first();

        return collect(['disk' => $stats->sum_disk, 'memory' => $stats->sum_memory])->mapWithKeys(function ($value, $key) use ($node) {
            $maxUsage = $node->{$key};
            if ($node->{$key . '_overallocate'} > 0) {
                $maxUsage = $node->{$key} * (1 + ($node->{$key . '_overallocate'} / 100));
            }

            return [
                $key => [
                    'value' => $value,
                    'max' => $maxUsage,
                ],
            ];
        })->toArray();
    }

    /**
     * Return a single node with location and server information.
     */
    public function loadLocationAndServerCount(Node $node, bool $refresh = false): Node
    {
        if (!$node->relationLoaded('location') || $refresh) {
            $node->load('location');
        }

        // This is quite ugly and can probably be improved down the road.
        // And by probably, I mean it should.
        if (is_null($node->servers_count) || $refresh) {
            $node->load('servers');
            $node->setRelation('servers_count', count($node->getRelation('servers')));
            unset($node->servers);
        }

        return $node;
    }

    /**
     * Attach a paginated set of allocations to a node mode including
     * any servers that are also attached to those allocations.
     */
    public function loadNodeAllocations(Node $node, bool $refresh = false): Node
    {
        $node->setRelation(
            'allocations',
            $node->allocations()
                ->orderByRaw('server_id IS NOT NULL DESC, server_id IS NULL')
                ->orderByRaw('INET_ATON(ip) ASC')
                ->orderBy('port')
                ->with('server:id,name')
                ->paginate(50)
        );

        return $node;
    }

    /**
     * Return a collection of nodes for all locations to use in server creation UI.
     */
    public function getNodesForServerCreation(): Collection
    {
        return $this->getBuilder()->with('allocations')->get()->map(function (Node $item) {
            $filtered = $item->getRelation('allocations')->where('server_id', null)->map(function ($map) {
                return collect($map)->only(['id', 'ip', 'port']);
            });

            $item->ports = $filtered->map(function ($map) {
                return [
                    'id' => $map['id'],
                    'text' => sprintf('%s:%s', $map['ip'], $map['port']),
                ];
            })->values();

            return [
                'id' => $item->id,
                'text' => $item->name,
                'allocations' => $item->ports,
            ];
        })->values();
    }

    /**
     * Returns a node with the given id with the Node's resource usage.
     */
    public function getNodeWithResourceUsage(int $node_id): Node
    {
        $instance = $this->getBuilder()
            ->select(['nodes.id', 'nodes.fqdn', 'nodes.scheme', 'nodes.daemon_token', 'nodes.daemonListen', 'nodes.memory', 'nodes.disk', 'nodes.memory_overallocate', 'nodes.disk_overallocate'])
            ->selectRaw('IFNULL(SUM(servers.memory), 0) as sum_memory, IFNULL(SUM(servers.disk), 0) as sum_disk')
            ->leftJoin('servers', 'servers.node_id', '=', 'nodes.id')
            ->where('nodes.id', $node_id);

        return $instance->first();
    }
}
</file>

<file path="app/Repositories/Eloquent/PermissionRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Contracts\Repository\PermissionRepositoryInterface;

class PermissionRepository extends EloquentRepository implements PermissionRepositoryInterface
{
    /**
     * Return the model backing this repository.
     *
     * @throws \Exception
     */
    public function model(): string
    {
        throw new \Exception('This functionality is not implemented.');
    }
}
</file>

<file path="app/Repositories/Eloquent/RecoveryTokenRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\RecoveryToken;

class RecoveryTokenRepository extends EloquentRepository
{
    public function model(): string
    {
        return RecoveryToken::class;
    }
}
</file>

<file path="app/Repositories/Eloquent/ScheduleRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\Schedule;
use Illuminate\Support\Collection;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Jexactyl\Exceptions\Repository\RecordNotFoundException;
use Jexactyl\Contracts\Repository\ScheduleRepositoryInterface;

class ScheduleRepository extends EloquentRepository implements ScheduleRepositoryInterface
{
    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return Schedule::class;
    }

    /**
     * Return all the schedules for a given server.
     */
    public function findServerSchedules(int $server): Collection
    {
        return $this->getBuilder()->withCount('tasks')->where('server_id', '=', $server)->get($this->getColumns());
    }

    /**
     * Return a schedule model with all the associated tasks as a relationship.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getScheduleWithTasks(int $schedule): Schedule
    {
        try {
            return $this->getBuilder()->with('tasks')->findOrFail($schedule, $this->getColumns());
        } catch (ModelNotFoundException) {
            throw new RecordNotFoundException();
        }
    }
}
</file>

<file path="app/Repositories/Eloquent/ServerRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\Server;
use Illuminate\Support\Collection;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Illuminate\Contracts\Pagination\LengthAwarePaginator;
use Jexactyl\Exceptions\Repository\RecordNotFoundException;
use Jexactyl\Contracts\Repository\ServerRepositoryInterface;

class ServerRepository extends EloquentRepository implements ServerRepositoryInterface
{
    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return Server::class;
    }

    /**
     * Load the egg relations onto the server model.
     */
    public function loadEggRelations(Server $server, bool $refresh = false): Server
    {
        if (!$server->relationLoaded('egg') || $refresh) {
            $server->load('egg.scriptFrom');
        }

        return $server;
    }

    /**
     * Return a collection of servers with their associated data for rebuild operations.
     */
    public function getDataForRebuild(int $server = null, int $node = null): Collection
    {
        $instance = $this->getBuilder()->with(['allocation', 'allocations', 'egg', 'node']);

        if (!is_null($server) && is_null($node)) {
            $instance = $instance->where('id', '=', $server);
        } elseif (is_null($server) && !is_null($node)) {
            $instance = $instance->where('node_id', '=', $node);
        }

        return $instance->get($this->getColumns());
    }

    /**
     * Return a collection of servers with their associated data for reinstall operations.
     */
    public function getDataForReinstall(int $server = null, int $node = null): Collection
    {
        $instance = $this->getBuilder()->with(['allocation', 'allocations', 'egg', 'node']);

        if (!is_null($server) && is_null($node)) {
            $instance = $instance->where('id', '=', $server);
        } elseif (is_null($server) && !is_null($node)) {
            $instance = $instance->where('node_id', '=', $node);
        }

        return $instance->get($this->getColumns());
    }

    /**
     * Return a server model and all variables associated with the server.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function findWithVariables(int $id): Server
    {
        try {
            return $this->getBuilder()->with('egg.variables', 'variables')
                ->where($this->getModel()->getKeyName(), '=', $id)
                ->firstOrFail($this->getColumns());
        } catch (ModelNotFoundException) {
            throw new RecordNotFoundException();
        }
    }

    /**
     * Get the primary allocation for a given server. If a model is passed into
     * the function, load the allocation relationship onto it. Otherwise, find and
     * return the server from the database.
     */
    public function getPrimaryAllocation(Server $server, bool $refresh = false): Server
    {
        if (!$server->relationLoaded('allocation') || $refresh) {
            $server->load('allocation');
        }

        return $server;
    }

    /**
     * Return enough data to be used for the creation of a server via the daemon.
     */
    public function getDataForCreation(Server $server, bool $refresh = false): Server
    {
        foreach (['allocation', 'allocations', 'egg'] as $relation) {
            if (!$server->relationLoaded($relation) || $refresh) {
                $server->load($relation);
            }
        }

        return $server;
    }

    /**
     * Load associated databases onto the server model.
     */
    public function loadDatabaseRelations(Server $server, bool $refresh = false): Server
    {
        if (!$server->relationLoaded('databases') || $refresh) {
            $server->load('databases.host');
        }

        return $server;
    }

    /**
     * Get data for use when updating a server on the Daemon. Returns an array of
     * the egg which is used for build and rebuild. Only loads relations
     * if they are missing, or refresh is set to true.
     */
    public function getDaemonServiceData(Server $server, bool $refresh = false): array
    {
        if (!$server->relationLoaded('egg') || $refresh) {
            $server->load('egg');
        }

        return [
            'egg' => $server->getRelation('egg')->uuid,
        ];
    }

    /**
     * Return a server by UUID.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getByUuid(string $uuid): Server
    {
        try {
            /** @var \Jexactyl\Models\Server $model */
            $model = $this->getBuilder()
                ->with('nest', 'node')
                ->where(function (Builder $query) use ($uuid) {
                    $query->where('uuidShort', $uuid)->orWhere('uuid', $uuid);
                })
                ->firstOrFail($this->getColumns());

            return $model;
        } catch (ModelNotFoundException) {
            throw new RecordNotFoundException();
        }
    }

    /**
     * Check if a given UUID and UUID-Short string are unique to a server.
     */
    public function isUniqueUuidCombo(string $uuid, string $short): bool
    {
        return !$this->getBuilder()->where('uuid', '=', $uuid)->orWhere('uuidShort', '=', $short)->exists();
    }

    /**
     * Returns all the servers that exist for a given node in a paginated response.
     */
    public function loadAllServersForNode(int $node, int $limit): LengthAwarePaginator
    {
        return $this->getBuilder()
            ->with(['user', 'nest', 'egg'])
            ->where('node_id', '=', $node)
            ->paginate($limit);
    }
}
</file>

<file path="app/Repositories/Eloquent/ServerVariableRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\ServerVariable;
use Jexactyl\Contracts\Repository\ServerVariableRepositoryInterface;

class ServerVariableRepository extends EloquentRepository implements ServerVariableRepositoryInterface
{
    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return ServerVariable::class;
    }
}
</file>

<file path="app/Repositories/Eloquent/SessionRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\Session;
use Illuminate\Support\Collection;
use Jexactyl\Contracts\Repository\SessionRepositoryInterface;

class SessionRepository extends EloquentRepository implements SessionRepositoryInterface
{
    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return Session::class;
    }

    /**
     * Return all the active sessions for a user.
     */
    public function getUserSessions(int $user): Collection
    {
        return $this->getBuilder()->where('user_id', $user)->get($this->getColumns());
    }

    /**
     * Delete a session for a given user.
     */
    public function deleteUserSession(int $user, string $session): ?int
    {
        return $this->getBuilder()->where('user_id', $user)->where('id', $session)->delete();
    }
}
</file>

<file path="app/Repositories/Eloquent/SettingsRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\Setting;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;

class SettingsRepository extends EloquentRepository implements SettingsRepositoryInterface
{
    private static array $cache = [];

    private static array $databaseMiss = [];

    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return Setting::class;
    }

    /**
     * Store a new persistent setting in the database.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function set(string $key, string $value = null)
    {
        // Clear item from the cache.
        $this->clearCache($key);
        $this->withoutFreshModel()->updateOrCreate(['key' => $key], ['value' => $value ?? '']);

        self::$cache[$key] = $value;
    }

    /**
     * Retrieve a persistent setting from the database.
     */
    public function get(string $key, mixed $default = null): mixed
    {
        // If item has already been requested return it from the cache. If
        // we already know it is missing, immediately return the default value.
        if (array_key_exists($key, self::$cache)) {
            return self::$cache[$key];
        } elseif (array_key_exists($key, self::$databaseMiss)) {
            return value($default);
        }

        $instance = $this->getBuilder()->where('key', $key)->first();
        if (is_null($instance)) {
            self::$databaseMiss[$key] = true;

            return value($default);
        }

        return self::$cache[$key] = $instance->value;
    }

    /**
     * Remove a key from the database cache.
     */
    public function forget(string $key)
    {
        $this->clearCache($key);
        $this->deleteWhere(['key' => $key]);
    }

    /**
     * Remove a key from the cache.
     */
    private function clearCache(string $key)
    {
        unset(self::$cache[$key], self::$databaseMiss[$key]);
    }
}
</file>

<file path="app/Repositories/Eloquent/SubuserRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\Subuser;
use Jexactyl\Exceptions\Repository\RecordNotFoundException;
use Jexactyl\Contracts\Repository\SubuserRepositoryInterface;

class SubuserRepository extends EloquentRepository implements SubuserRepositoryInterface
{
    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return Subuser::class;
    }

    /**
     * Return a subuser with the associated server relationship.
     */
    public function loadServerAndUserRelations(Subuser $subuser, bool $refresh = false): Subuser
    {
        if (!$subuser->relationLoaded('server') || $refresh) {
            $subuser->load('server');
        }

        if (!$subuser->relationLoaded('user') || $refresh) {
            $subuser->load('user');
        }

        return $subuser;
    }

    /**
     * Return a subuser with the associated permissions relationship.
     */
    public function getWithPermissions(Subuser $subuser, bool $refresh = false): Subuser
    {
        if (!$subuser->relationLoaded('permissions') || $refresh) {
            $subuser->load('permissions');
        }

        if (!$subuser->relationLoaded('user') || $refresh) {
            $subuser->load('user');
        }

        return $subuser;
    }

    /**
     * Return a subuser and associated permissions given a user_id and server_id.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getWithPermissionsUsingUserAndServer(int $user, int $server): Subuser
    {
        $instance = $this->getBuilder()->with('permissions')->where([
            ['user_id', '=', $user],
            ['server_id', '=', $server],
        ])->first();

        if (is_null($instance)) {
            throw new RecordNotFoundException();
        }

        return $instance;
    }
}
</file>

<file path="app/Repositories/Eloquent/TaskRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\Task;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Jexactyl\Contracts\Repository\TaskRepositoryInterface;
use Jexactyl\Exceptions\Repository\RecordNotFoundException;

class TaskRepository extends EloquentRepository implements TaskRepositoryInterface
{
    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return Task::class;
    }

    /**
     * Get a task and the server relationship for that task.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function getTaskForJobProcess(int $id): Task
    {
        try {
            return $this->getBuilder()->with('server.user', 'schedule')->findOrFail($id, $this->getColumns());
        } catch (ModelNotFoundException) {
            throw new RecordNotFoundException();
        }
    }

    /**
     * Returns the next task in a schedule.
     */
    public function getNextTask(int $schedule, int $index): ?Task
    {
        return $this->getBuilder()->where('schedule_id', '=', $schedule)
            ->orderBy('sequence_id')
            ->where('sequence_id', '>', $index)
            ->first($this->getColumns());
    }
}
</file>

<file path="app/Repositories/Eloquent/UserRepository.php">
<?php

namespace Jexactyl\Repositories\Eloquent;

use Jexactyl\Models\User;
use Jexactyl\Contracts\Repository\UserRepositoryInterface;

class UserRepository extends EloquentRepository implements UserRepositoryInterface
{
    /**
     * Return the model backing this repository.
     */
    public function model(): string
    {
        return User::class;
    }
}
</file>

<file path="app/Repositories/Wings/DaemonBackupRepository.php">
<?php

namespace Jexactyl\Repositories\Wings;

use Jexactyl\Models\Backup;
use Jexactyl\Models\Server;
use Webmozart\Assert\Assert;
use Psr\Http\Message\ResponseInterface;
use GuzzleHttp\Exception\TransferException;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;

class DaemonBackupRepository extends DaemonRepository
{
    protected ?string $adapter;

    /**
     * Sets the backup adapter for this execution instance.
     */
    public function setBackupAdapter(string $adapter): self
    {
        $this->adapter = $adapter;

        return $this;
    }

    /**
     * Tells the remote Daemon to begin generating a backup for the server.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function backup(Backup $backup): ResponseInterface
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            return $this->getHttpClient()->post(
                sprintf('/api/servers/%s/backup', $this->server->uuid),
                [
                    'json' => [
                        'adapter' => $this->adapter ?? config('backups.default'),
                        'uuid' => $backup->uuid,
                        'ignore' => implode("\n", $backup->ignored_files),
                    ],
                ]
            );
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }

    /**
     * Sends a request to Wings to begin restoring a backup for a server.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function restore(Backup $backup, string $url = null, bool $truncate = false): ResponseInterface
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            return $this->getHttpClient()->post(
                sprintf('/api/servers/%s/backup/%s/restore', $this->server->uuid, $backup->uuid),
                [
                    'json' => [
                        'adapter' => $backup->disk,
                        'truncate_directory' => $truncate,
                        'download_url' => $url ?? '',
                    ],
                ]
            );
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }

    /**
     * Deletes a backup from the daemon.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function delete(Backup $backup): ResponseInterface
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            return $this->getHttpClient()->delete(
                sprintf('/api/servers/%s/backup/%s', $this->server->uuid, $backup->uuid)
            );
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }
}
</file>

<file path="app/Repositories/Wings/DaemonCommandRepository.php">
<?php

namespace Jexactyl\Repositories\Wings;

use Jexactyl\Models\Server;
use Webmozart\Assert\Assert;
use Psr\Http\Message\ResponseInterface;
use GuzzleHttp\Exception\TransferException;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;

class DaemonCommandRepository extends DaemonRepository
{
    /**
     * Sends a command or multiple commands to a running server instance.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function send(array|string $command): ResponseInterface
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            return $this->getHttpClient()->post(
                sprintf('/api/servers/%s/commands', $this->server->uuid),
                [
                    'json' => ['commands' => is_array($command) ? $command : [$command]],
                ]
            );
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }
}
</file>

<file path="app/Repositories/Wings/DaemonConfigurationRepository.php">
<?php

namespace Jexactyl\Repositories\Wings;

use Jexactyl\Models\Node;
use Psr\Http\Message\ResponseInterface;
use GuzzleHttp\Exception\TransferException;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;

class DaemonConfigurationRepository extends DaemonRepository
{
    /**
     * Returns system information from the wings instance.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function getSystemInformation(?int $version = null): array
    {
        try {
            $response = $this->getHttpClient()->get('/api/system' . (!is_null($version) ? '?v=' . $version : ''));
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }

        return json_decode($response->getBody()->__toString(), true);
    }

    /**
     * Updates the configuration information for a daemon. Updates the information for
     * this instance using a passed-in model. This allows us to change plenty of information
     * in the model, and still use the old, pre-update model to actually make the HTTP request.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function update(Node $node): ResponseInterface
    {
        try {
            return $this->getHttpClient()->post(
                '/api/update',
                ['json' => $node->getConfiguration()]
            );
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }
}
</file>

<file path="app/Repositories/Wings/DaemonFileRepository.php">
<?php

namespace Jexactyl\Repositories\Wings;

use Illuminate\Support\Arr;
use Jexactyl\Models\Server;
use Webmozart\Assert\Assert;
use Psr\Http\Message\ResponseInterface;
use GuzzleHttp\Exception\ClientException;
use GuzzleHttp\Exception\TransferException;
use Jexactyl\Exceptions\Http\Server\FileSizeTooLargeException;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;

class DaemonFileRepository extends DaemonRepository
{
    /**
     * Return the contents of a given file.
     *
     * @param int|null $notLargerThan the maximum content length in bytes
     *
     * @throws \GuzzleHttp\Exception\TransferException
     * @throws \Jexactyl\Exceptions\Http\Server\FileSizeTooLargeException
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function getContent(string $path, int $notLargerThan = null): string
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            $response = $this->getHttpClient()->get(
                sprintf('/api/servers/%s/files/contents', $this->server->uuid),
                [
                    'query' => ['file' => $path],
                ]
            );
        } catch (ClientException|TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }

        $length = (int) Arr::get($response->getHeader('Content-Length'), 0, 0);
        if ($notLargerThan && $length > $notLargerThan) {
            throw new FileSizeTooLargeException();
        }

        return $response->getBody()->__toString();
    }

    /**
     * Save new contents to a given file. This works for both creating and updating
     * a file.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function putContent(string $path, string $content): ResponseInterface
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            return $this->getHttpClient()->post(
                sprintf('/api/servers/%s/files/write', $this->server->uuid),
                [
                    'query' => ['file' => $path],
                    'body' => $content,
                ]
            );
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }

    /**
     * Return a directory listing for a given path.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function getDirectory(string $path): array
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            $response = $this->getHttpClient()->get(
                sprintf('/api/servers/%s/files/list-directory', $this->server->uuid),
                [
                    'query' => ['directory' => $path],
                ]
            );
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }

        return json_decode($response->getBody(), true);
    }

    /**
     * Creates a new directory for the server in the given $path.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function createDirectory(string $name, string $path): ResponseInterface
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            return $this->getHttpClient()->post(
                sprintf('/api/servers/%s/files/create-directory', $this->server->uuid),
                [
                    'json' => [
                        'name' => $name,
                        'path' => $path,
                    ],
                ]
            );
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }

    /**
     * Renames or moves a file on the remote machine.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function renameFiles(?string $root, array $files): ResponseInterface
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            return $this->getHttpClient()->put(
                sprintf('/api/servers/%s/files/rename', $this->server->uuid),
                [
                    'json' => [
                        'root' => $root ?? '/',
                        'files' => $files,
                    ],
                ]
            );
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }

    /**
     * Copy a given file and give it a unique name.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function copyFile(string $location): ResponseInterface
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            return $this->getHttpClient()->post(
                sprintf('/api/servers/%s/files/copy', $this->server->uuid),
                [
                    'json' => [
                        'location' => $location,
                    ],
                ]
            );
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }

    /**
     * Delete a file or folder for the server.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function deleteFiles(?string $root, array $files): ResponseInterface
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            return $this->getHttpClient()->post(
                sprintf('/api/servers/%s/files/delete', $this->server->uuid),
                [
                    'json' => [
                        'root' => $root ?? '/',
                        'files' => $files,
                    ],
                ]
            );
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }

    /**
     * Compress the given files or folders in the given root.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function compressFiles(?string $root, array $files): array
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            $response = $this->getHttpClient()->post(
                sprintf('/api/servers/%s/files/compress', $this->server->uuid),
                [
                    'json' => [
                        'root' => $root ?? '/',
                        'files' => $files,
                    ],
                    // Wait for up to 15 minutes for the archive to be completed when calling this endpoint
                    // since it will likely take quite awhile for large directories.
                    'timeout' => 60 * 15,
                ]
            );
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }

        return json_decode($response->getBody(), true);
    }

    /**
     * Decompresses a given archive file.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function decompressFile(?string $root, string $file): ResponseInterface
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            return $this->getHttpClient()->post(
                sprintf('/api/servers/%s/files/decompress', $this->server->uuid),
                [
                    'json' => [
                        'root' => $root ?? '/',
                        'file' => $file,
                    ],
                    // Wait for up to 15 minutes for the decompress to be completed when calling this endpoint
                    // since it will likely take quite awhile for large directories.
                    'timeout' => 60 * 15,
                ]
            );
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }

    /**
     * Chmods the given files.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function chmodFiles(?string $root, array $files): ResponseInterface
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            return $this->getHttpClient()->post(
                sprintf('/api/servers/%s/files/chmod', $this->server->uuid),
                [
                    'json' => [
                        'root' => $root ?? '/',
                        'files' => $files,
                    ],
                ]
            );
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }

    /**
     * Pulls a file from the given URL and saves it to the disk.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function pull(string $url, ?string $directory, array $params = []): ResponseInterface
    {
        Assert::isInstanceOf($this->server, Server::class);

        $attributes = [
            'url' => $url,
            'root' => $directory ?? '/',
            'file_name' => $params['filename'] ?? null,
            'use_header' => $params['use_header'] ?? null,
            'foreground' => $params['foreground'] ?? null,
        ];

        try {
            return $this->getHttpClient()->post(
                sprintf('/api/servers/%s/files/pull', $this->server->uuid),
                [
                    'json' => array_filter($attributes, fn ($value) => !is_null($value)),
                ]
            );
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }
}
</file>

<file path="app/Repositories/Wings/DaemonPowerRepository.php">
<?php

namespace Jexactyl\Repositories\Wings;

use Jexactyl\Models\Server;
use Webmozart\Assert\Assert;
use Psr\Http\Message\ResponseInterface;
use GuzzleHttp\Exception\TransferException;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;

class DaemonPowerRepository extends DaemonRepository
{
    /**
     * Sends a power action to the server instance.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function send(string $action): ResponseInterface
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            return $this->getHttpClient()->post(
                sprintf('/api/servers/%s/power', $this->server->uuid),
                ['json' => ['action' => $action]]
            );
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }
}
</file>

<file path="app/Repositories/Wings/DaemonRepository.php">
<?php

namespace Jexactyl\Repositories\Wings;

use GuzzleHttp\Client;
use Jexactyl\Models\Node;
use Jexactyl\Models\Server;
use Webmozart\Assert\Assert;
use Illuminate\Contracts\Foundation\Application;

abstract class DaemonRepository
{
    protected ?Server $server;

    protected ?Node $node;

    /**
     * DaemonRepository constructor.
     */
    public function __construct(protected Application $app)
    {
    }

    /**
     * Set the server model this request is stemming from.
     */
    public function setServer(Server $server): self
    {
        $this->server = $server;

        $this->setNode($this->server->node);

        return $this;
    }

    /**
     * Set the node model this request is stemming from.
     */
    public function setNode(Node $node): self
    {
        $this->node = $node;

        return $this;
    }

    /**
     * Return an instance of the Guzzle HTTP Client to be used for requests.
     */
    public function getHttpClient(array $headers = []): Client
    {
        Assert::isInstanceOf($this->node, Node::class);

        return new Client([
            'verify' => $this->app->environment('production'),
            'base_uri' => $this->node->getConnectionAddress(),
            'timeout' => config('jexactyl.guzzle.timeout'),
            'connect_timeout' => config('jexactyl.guzzle.connect_timeout'),
            'headers' => array_merge($headers, [
                'Authorization' => 'Bearer ' . $this->node->getDecryptedKey(),
                'Accept' => 'application/json',
                'Content-Type' => 'application/json',
            ]),
        ]);
    }
}
</file>

<file path="app/Repositories/Wings/DaemonServerRepository.php">
<?php

namespace Jexactyl\Repositories\Wings;

use Jexactyl\Models\Server;
use Webmozart\Assert\Assert;
use GuzzleHttp\Exception\GuzzleException;
use GuzzleHttp\Exception\TransferException;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;

class DaemonServerRepository extends DaemonRepository
{
    /**
     * Returns details about a server from the Daemon instance.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function getDetails(): array
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            $response = $this->getHttpClient()->get(
                sprintf('/api/servers/%s', $this->server->uuid)
            );
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception, false);
        }

        return json_decode($response->getBody()->__toString(), true);
    }

    /**
     * Creates a new server on the Wings daemon.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function create(bool $startOnCompletion = true): void
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            $this->getHttpClient()->post('/api/servers', [
                'json' => [
                    'uuid' => $this->server->uuid,
                    'start_on_completion' => $startOnCompletion,
                ],
            ]);
        } catch (GuzzleException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }

    /**
     * Triggers a server sync on Wings.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function sync(): void
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            $this->getHttpClient()->post("/api/servers/{$this->server->uuid}/sync");
        } catch (GuzzleException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }

    /**
     * Delete a server from the daemon, forcibly if passed.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function delete(): void
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            $this->getHttpClient()->delete('/api/servers/' . $this->server->uuid);
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }

    /**
     * Reinstall a server on the daemon.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function reinstall(): void
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            $this->getHttpClient()->post(sprintf(
                '/api/servers/%s/reinstall',
                $this->server->uuid
            ));
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }

    /**
     * Requests the daemon to create a full archive of the server. Once the daemon is finished
     * they will send a POST request to "/api/remote/servers/{uuid}/archive" with a boolean.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function requestArchive(): void
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            $this->getHttpClient()->post(sprintf(
                '/api/servers/%s/archive',
                $this->server->uuid
            ));
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }

    /**
     * Revokes a single user's JTI by using their ID. This is simply a helper function to
     * make it easier to revoke tokens on the fly. This ensures that the JTI key is formatted
     * correctly and avoids any costly mistakes in the codebase.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function revokeUserJTI(int $id): void
    {
        Assert::isInstanceOf($this->server, Server::class);

        $this->revokeJTIs([md5($id . $this->server->uuid)]);
    }

    /**
     * Revokes an array of JWT JTI's by marking any token generated before the current time on
     * the Wings instance as being invalid.
     *
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    protected function revokeJTIs(array $jtis): void
    {
        Assert::isInstanceOf($this->server, Server::class);

        try {
            $this->getHttpClient()
                ->post(sprintf('/api/servers/%s/ws/deny', $this->server->uuid), [
                    'json' => ['jtis' => $jtis],
                ]);
        } catch (TransferException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }
}
</file>

<file path="app/Repositories/Wings/DaemonTransferRepository.php">
<?php

namespace Jexactyl\Repositories\Wings;

use Jexactyl\Models\Node;
use Lcobucci\JWT\Token\Plain;
use GuzzleHttp\Exception\GuzzleException;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;

class DaemonTransferRepository extends DaemonRepository
{
    /**
     * @throws \Jexactyl\Exceptions\Http\Connection\DaemonConnectionException
     */
    public function notify(Node $targetNode, Plain $token): void
    {
        try {
            $this->getHttpClient()->post(sprintf('/api/servers/%s/transfer', $this->server->uuid), [
                'json' => [
                    'server_id' => $this->server->uuid,
                    'url' => $targetNode->getConnectionAddress() . '/api/transfers',
                    'token' => 'Bearer ' . $token->toString(),
                    'server' => [
                        'uuid' => $this->server->uuid,
                        'start_on_completion' => false,
                    ],
                ],
            ]);
        } catch (GuzzleException $exception) {
            throw new DaemonConnectionException($exception);
        }
    }
}
</file>

<file path="app/Repositories/Repository.php">
<?php

namespace Jexactyl\Repositories;

use Illuminate\Foundation\Application;
use Illuminate\Database\Eloquent\Model;
use Jexactyl\Contracts\Repository\RepositoryInterface;

abstract class Repository implements RepositoryInterface
{
    protected array $columns = ['*'];

    protected Model $model;

    protected bool $withFresh = true;

    /**
     * Repository constructor.
     */
    public function __construct(protected Application $app)
    {
        $this->initializeModel($this->model());
    }

    /**
     * Return the model backing this repository.
     */
    abstract public function model(): string;

    /**
     * Return the model being used for this repository.
     */
    public function getModel(): Model
    {
        return $this->model;
    }

    /**
     * Setup column selection functionality.
     *
     * @param array|string $columns
     */
    public function setColumns($columns = ['*']): self
    {
        $clone = clone $this;
        $clone->columns = is_array($columns) ? $columns : func_get_args();

        return $clone;
    }

    /**
     * Return the columns to be selected in the repository call.
     */
    public function getColumns(): array
    {
        return $this->columns;
    }

    /**
     * Stop repository update functions from returning a fresh
     * model when changes are committed.
     */
    public function withoutFreshModel(): self
    {
        return $this->setFreshModel(false);
    }

    /**
     * Return a fresh model with a repository updates a model.
     */
    public function withFreshModel(): self
    {
        return $this->setFreshModel();
    }

    /**
     * Set whether the repository should return a fresh model
     * when changes are committed.
     */
    public function setFreshModel(bool $fresh = true): self
    {
        $clone = clone $this;
        $clone->withFresh = $fresh;

        return $clone;
    }

    /**
     * Take the provided model and make it accessible to the rest of the repository.
     */
    protected function initializeModel(string ...$model): mixed
    {
        switch (count($model)) {
            case 1:
                return $this->model = $this->app->make($model[0]);
            case 2:
                return $this->model = call_user_func([$this->app->make($model[0]), $model[1]]);
            default:
                throw new \InvalidArgumentException('Model must be a FQDN or an array with a count of two.');
        }
    }
}
</file>

<file path="app/Rules/Fqdn.php">
<?php

namespace Jexactyl\Rules;

use Illuminate\Support\Arr;
use Illuminate\Contracts\Validation\Rule;
use Illuminate\Contracts\Validation\DataAwareRule;

class Fqdn implements Rule, DataAwareRule
{
    protected array $data = [];
    protected string $message = '';
    protected ?string $schemeField = null;

    /**
     * @param array $data
     */
    public function setData($data): self
    {
        $this->data = $data;

        return $this;
    }

    /**
     * Validates that the value provided resolves to an IP address. If a scheme is
     * specified when this rule is created additional checks will be applied.
     *
     * @param string $attribute
     * @param mixed $value
     */
    public function passes($attribute, $value): bool
    {
        if (filter_var($value, FILTER_VALIDATE_IP)) {
            // Check if the scheme is set to HTTPS.
            //
            // Unless someone owns their IP blocks and decides to pay who knows how much for a
            // custom SSL cert, IPs will not be able to use HTTPS.  This should prevent most
            // home users from making this mistake and wondering why their node is not working.
            if ($this->schemeField && Arr::get($this->data, $this->schemeField) === 'https') {
                $this->message = 'The :attribute must not be an IP address when HTTPS is enabled.';

                return false;
            }

            return true;
        }

        // Lookup A and AAAA DNS records for the FQDN. Note, this function will also resolve CNAMEs
        // for us automatically, there is no need to manually resolve them here.
        //
        // The error suppression is intentional, see https://bugs.php.net/bug.php?id=73149
        $records = @dns_get_record($value, DNS_A + DNS_AAAA);
        // If no records were returned fall back to trying to resolve the value using the hosts DNS
        // resolution. This will not work for IPv6 which is why we prefer to use `dns_get_record`
        // first.
        if (!empty($records) || filter_var(gethostbyname($value), FILTER_VALIDATE_IP)) {
            return true;
        }

        $this->message = 'The :attribute could not be resolved to a valid IP address.';

        return false;
    }

    public function message(): string
    {
        return $this->message;
    }

    /**
     * Returns a new instance of the rule with a defined scheme set.
     */
    public static function make(string $schemeField = null): self
    {
        return tap(new static(), function ($fqdn) use ($schemeField) {
            $fqdn->schemeField = $schemeField;
        });
    }
}
</file>

<file path="app/Rules/Username.php">
<?php

namespace Jexactyl\Rules;

use Illuminate\Contracts\Validation\Rule;

class Username implements Rule
{
    /**
     * Regex to use when validating usernames.
     */
    public const VALIDATION_REGEX = '/^[a-z0-9]([\w\.-]+)[a-z0-9]$/';

    /**
     * Validate that a username contains only the allowed characters and starts/ends
     * with alphanumeric characters.
     *
     * Allowed characters: a-z0-9_-.
     *
     * @param string $attribute
     * @param mixed $value
     */
    public function passes($attribute, $value): bool
    {
        return preg_match(self::VALIDATION_REGEX, mb_strtolower($value));
    }

    /**
     * Return a validation message for use when this rule fails.
     */
    public function message(): string
    {
        return 'The :attribute must start and end with alpha-numeric characters and
                contain only letters, numbers, dashes, underscores, and periods.';
    }

    /**
     * Convert the rule to a validation string. This is necessary to avoid
     * issues with Eloquence which tries to use this rule as a string.
     */
    public function __toString(): string
    {
        return 'p_username';
    }
}
</file>

<file path="app/Services/Acl/Api/AdminAcl.php">
<?php

namespace Jexactyl\Services\Acl\Api;

use Jexactyl\Models\ApiKey;

class AdminAcl
{
    /**
     * Resource permission columns in the api_keys table begin
     * with this identifier.
     */
    public const COLUMN_IDENTIFIER = 'r_';

    /**
     * The different types of permissions available for API keys. This
     * implements a read/write/none permissions scheme for all endpoints.
     */
    public const NONE = 0;
    public const READ = 1;
    public const WRITE = 2;

    /**
     * Resources that are available on the API and can contain a permissions
     * set for each key. These are stored in the database as r_{resource}.
     */
    public const RESOURCE_SERVERS = 'servers';
    public const RESOURCE_NODES = 'nodes';
    public const RESOURCE_ALLOCATIONS = 'allocations';
    public const RESOURCE_USERS = 'users';
    public const RESOURCE_LOCATIONS = 'locations';
    public const RESOURCE_NESTS = 'nests';
    public const RESOURCE_EGGS = 'eggs';
    public const RESOURCE_DATABASE_HOSTS = 'database_hosts';
    public const RESOURCE_SERVER_DATABASES = 'server_databases';

    /**
     * Determine if an API key has permission to perform a specific read/write operation.
     */
    public static function can(int $permission, int $action = self::READ): bool
    {
        if ($permission & $action) {
            return true;
        }

        return false;
    }

    /**
     * Determine if an API Key model has permission to access a given resource
     * at a specific action level.
     */
    public static function check(ApiKey $key, string $resource, int $action = self::READ): bool
    {
        return self::can(data_get($key, self::COLUMN_IDENTIFIER . $resource, self::NONE), $action);
    }

    /**
     * Return a list of all resource constants defined in this ACL.
     *
     * @throws \ReflectionException
     */
    public static function getResourceList(): array
    {
        $reflect = new \ReflectionClass(__CLASS__);

        return collect($reflect->getConstants())->filter(function ($value, $key) {
            return substr($key, 0, 9) === 'RESOURCE_';
        })->values()->toArray();
    }
}
</file>

<file path="app/Services/Activity/ActivityLogBatchService.php">
<?php

namespace Jexactyl\Services\Activity;

use Ramsey\Uuid\Uuid;

class ActivityLogBatchService
{
    protected int $transaction = 0;
    protected ?string $uuid = null;

    /**
     * Returns the UUID of the batch, or null if there is not a batch currently
     * being executed.
     */
    public function uuid(): ?string
    {
        return $this->uuid;
    }

    /**
     * Starts a new batch transaction. If there is already a transaction present
     * this will be nested.
     */
    public function start(): void
    {
        if ($this->transaction === 0) {
            $this->uuid = Uuid::uuid4()->toString();
        }

        ++$this->transaction;
    }

    /**
     * Ends a batch transaction, if this is the last transaction in the stack
     * the UUID will be cleared out.
     */
    public function end(): void
    {
        $this->transaction = max(0, $this->transaction - 1);

        if ($this->transaction === 0) {
            $this->uuid = null;
        }
    }

    /**
     * Executes the logic provided within the callback in the scope of an activity
     * log batch transaction.
     */
    public function transaction(\Closure $callback): mixed
    {
        $this->start();
        $result = $callback($this->uuid());
        $this->end();

        return $result;
    }
}
</file>

<file path="app/Services/Activity/ActivityLogService.php">
<?php

namespace Jexactyl\Services\Activity;

use Illuminate\Support\Arr;
use Webmozart\Assert\Assert;
use Jexactyl\Models\ActivityLog;
use Illuminate\Support\Collection;
use Illuminate\Support\Facades\Log;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\Request;
use Jexactyl\Models\ActivityLogSubject;
use Illuminate\Database\ConnectionInterface;
use Illuminate\Contracts\Auth\Factory as AuthFactory;

class ActivityLogService
{
    protected ?ActivityLog $activity = null;

    protected array $subjects = [];

    public function __construct(
        protected AuthFactory $manager,
        protected ActivityLogBatchService $batch,
        protected ActivityLogTargetableService $targetable,
        protected ConnectionInterface $connection
    ) {
    }

    /**
     * Sets the activity logger as having been caused by an anonymous
     * user type.
     */
    public function anonymous(): self
    {
        $this->getActivity()->actor_id = null;
        $this->getActivity()->actor_type = null;
        $this->getActivity()->setRelation('actor', null);

        return $this;
    }

    /**
     * Sets the action for this activity log.
     */
    public function event(string $action): self
    {
        $this->getActivity()->event = $action;

        return $this;
    }

    /**
     * Set the description for this activity.
     */
    public function description(?string $description): self
    {
        $this->getActivity()->description = $description;

        return $this;
    }

    /**
     * Sets the subject model instance.
     *
     * @template T extends \Illuminate\Database\Eloquent\Model|\Illuminate\Contracts\Auth\Authenticatable
     *
     * @param T|T[]|null $subjects
     */
    public function subject(...$subjects): self
    {
        foreach (Arr::wrap($subjects) as $subject) {
            if (is_null($subject)) {
                continue;
            }

            foreach ($this->subjects as $entry) {
                // If this subject is already tracked in our array of subjects just skip over
                // it and move on to the next one in the list.
                if ($entry->is($subject)) {
                    continue 2;
                }
            }

            $this->subjects[] = $subject;
        }

        return $this;
    }

    /**
     * Sets the actor model instance.
     */
    public function actor(Model $actor): self
    {
        $this->getActivity()->actor()->associate($actor);

        return $this;
    }

    /**
     * Sets a custom property on the activity log instance.
     *
     * @param string|array $key
     * @param mixed $value
     */
    public function property($key, $value = null): self
    {
        $properties = $this->getActivity()->properties;
        $this->activity->properties = is_array($key)
            ? $properties->merge($key)
            : $properties->put($key, $value);

        return $this;
    }

    /**
     * Attaches the instance request metadata to the activity log event.
     */
    public function withRequestMetadata(): self
    {
        return $this->property([
            'ip' => Request::getClientIp(),
            'useragent' => Request::userAgent(),
        ]);
    }

    /**
     * Logs an activity log entry with the set values and then returns the
     * model instance to the caller. If there is an exception encountered while
     * performing this action it will be logged to the disk but will not interrupt
     * the code flow.
     */
    public function log(string $description = null): ActivityLog
    {
        $activity = $this->getActivity();

        if (!is_null($description)) {
            $activity->description = $description;
        }

        try {
            return $this->save();
        } catch (\Throwable|\Exception $exception) {
            if (config('app.env') !== 'production') {
                /* @noinspection PhpUnhandledExceptionInspection */
                throw $exception;
            }

            Log::error($exception);
        }

        return $activity;
    }

    /**
     * Returns a cloned instance of the service allowing for the creation of a base
     * activity log with the ability to change values on the fly without impact.
     */
    public function clone(): self
    {
        return clone $this;
    }

    /**
     * Executes the provided callback within the scope of a database transaction
     * and will only save the activity log entry if everything else successfully
     * settles.
     *
     * @throws \Throwable
     */
    public function transaction(\Closure $callback)
    {
        return $this->connection->transaction(function () use ($callback) {
            $response = $callback($this);

            $this->save();

            return $response;
        });
    }

    /**
     * Resets the instance and clears out the log.
     */
    public function reset(): void
    {
        $this->activity = null;
        $this->subjects = [];
    }

    /**
     * Returns the current activity log instance.
     */
    protected function getActivity(): ActivityLog
    {
        if ($this->activity) {
            return $this->activity;
        }

        $this->activity = new ActivityLog([
            'ip' => Request::ip(),
            'batch_uuid' => $this->batch->uuid(),
            'properties' => Collection::make([]),
            'api_key_id' => $this->targetable->apiKeyId(),
        ]);

        if ($subject = $this->targetable->subject()) {
            $this->subject($subject);
        }

        if ($actor = $this->targetable->actor()) {
            $this->actor($actor);
        } elseif ($user = $this->manager->guard()->user()) {
            if ($user instanceof Model) {
                $this->actor($user);
            }
        }

        return $this->activity;
    }

    /**
     * Saves the activity log instance and attaches all of the subject models.
     *
     * @throws \Throwable
     */
    protected function save(): ActivityLog
    {
        Assert::notNull($this->activity);

        $response = $this->connection->transaction(function () {
            $this->activity->save();

            $subjects = Collection::make($this->subjects)
                ->map(fn (Model $subject) => [
                    'activity_log_id' => $this->activity->id,
                    'subject_id' => $subject->getKey(),
                    'subject_type' => $subject->getMorphClass(),
                ])
                ->values()
                ->toArray();

            ActivityLogSubject::insert($subjects);

            return $this->activity;
        });

        $this->activity = null;
        $this->subjects = [];

        return $response;
    }
}
</file>

<file path="app/Services/Activity/ActivityLogTargetableService.php">
<?php

namespace Jexactyl\Services\Activity;

use Illuminate\Database\Eloquent\Model;

class ActivityLogTargetableService
{
    protected ?Model $actor = null;

    protected ?Model $subject = null;

    protected ?int $apiKeyId = null;

    public function setActor(Model $actor): void
    {
        $this->actor = $actor;
    }

    public function setSubject(Model $subject): void
    {
        $this->subject = $subject;
    }

    public function setApiKeyId(?int $apiKeyId): void
    {
        $this->apiKeyId = $apiKeyId;
    }

    public function actor(): ?Model
    {
        return $this->actor;
    }

    public function subject(): ?Model
    {
        return $this->subject;
    }

    public function apiKeyId(): ?int
    {
        return $this->apiKeyId;
    }

    public function reset(): void
    {
        $this->actor = null;
        $this->subject = null;
        $this->apiKeyId = null;
    }
}
</file>

<file path="app/Services/Allocations/AllocationDeletionService.php">
<?php

namespace Jexactyl\Services\Allocations;

use Jexactyl\Models\Allocation;
use Jexactyl\Contracts\Repository\AllocationRepositoryInterface;
use Jexactyl\Exceptions\Service\Allocation\ServerUsingAllocationException;

class AllocationDeletionService
{
    /**
     * AllocationDeletionService constructor.
     */
    public function __construct(private AllocationRepositoryInterface $repository)
    {
    }

    /**
     * Delete an allocation from the database only if it does not have a server
     * that is actively attached to it.
     *
     * @throws \Jexactyl\Exceptions\Service\Allocation\ServerUsingAllocationException
     */
    public function handle(Allocation $allocation): int
    {
        if (!is_null($allocation->server_id)) {
            throw new ServerUsingAllocationException(trans('exceptions.allocations.server_using'));
        }

        return $this->repository->delete($allocation->id);
    }
}
</file>

<file path="app/Services/Allocations/AssignmentService.php">
<?php

namespace Jexactyl\Services\Allocations;

use IPTools\Network;
use Jexactyl\Models\Node;
use Jexactyl\Exceptions\DisplayException;
use Illuminate\Database\ConnectionInterface;
use Jexactyl\Contracts\Repository\AllocationRepositoryInterface;
use Jexactyl\Exceptions\Service\Allocation\CidrOutOfRangeException;
use Jexactyl\Exceptions\Service\Allocation\PortOutOfRangeException;
use Jexactyl\Exceptions\Service\Allocation\InvalidPortMappingException;
use Jexactyl\Exceptions\Service\Allocation\TooManyPortsInRangeException;

class AssignmentService
{
    public const CIDR_MAX_BITS = 27;
    public const CIDR_MIN_BITS = 32;
    public const PORT_FLOOR = 1024;
    public const PORT_CEIL = 65535;
    public const PORT_RANGE_LIMIT = 1000;
    public const PORT_RANGE_REGEX = '/^(\d{4,5})-(\d{4,5})$/';

    /**
     * AssignmentService constructor.
     */
    public function __construct(protected AllocationRepositoryInterface $repository, protected ConnectionInterface $connection)
    {
    }

    /**
     * Insert allocations into the database and link them to a specific node.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Service\Allocation\CidrOutOfRangeException
     * @throws \Jexactyl\Exceptions\Service\Allocation\InvalidPortMappingException
     * @throws \Jexactyl\Exceptions\Service\Allocation\PortOutOfRangeException
     * @throws \Jexactyl\Exceptions\Service\Allocation\TooManyPortsInRangeException
     */
    public function handle(Node $node, array $data): void
    {
        $explode = explode('/', $data['allocation_ip']);
        if (count($explode) !== 1) {
            if (!ctype_digit($explode[1]) || ($explode[1] > self::CIDR_MIN_BITS || $explode[1] < self::CIDR_MAX_BITS)) {
                throw new CidrOutOfRangeException();
            }
        }

        try {
            // TODO: how should we approach supporting IPv6 with this?
            // gethostbyname only supports IPv4, but the alternative (dns_get_record) returns
            // an array of records, which is not ideal for this use case, we need a SINGLE
            // IP to use, not multiple.
            $underlying = gethostbyname($data['allocation_ip']);
            $parsed = Network::parse($underlying);
        } catch (\Exception $exception) {
            /* @noinspection PhpUndefinedVariableInspection */
            throw new DisplayException("Could not parse provided allocation IP address ({$underlying}): {$exception->getMessage()}", $exception);
        }

        $this->connection->beginTransaction();
        foreach ($parsed as $ip) {
            foreach ($data['allocation_ports'] as $port) {
                if (!is_digit($port) && !preg_match(self::PORT_RANGE_REGEX, $port)) {
                    throw new InvalidPortMappingException($port);
                }

                $insertData = [];
                if (preg_match(self::PORT_RANGE_REGEX, $port, $matches)) {
                    $block = range($matches[1], $matches[2]);

                    if (count($block) > self::PORT_RANGE_LIMIT) {
                        throw new TooManyPortsInRangeException();
                    }

                    if ((int) $matches[1] <= self::PORT_FLOOR || (int) $matches[2] > self::PORT_CEIL) {
                        throw new PortOutOfRangeException();
                    }

                    foreach ($block as $unit) {
                        $insertData[] = [
                            'node_id' => $node->id,
                            'ip' => $ip->__toString(),
                            'port' => (int) $unit,
                            'ip_alias' => array_get($data, 'allocation_alias'),
                            'server_id' => null,
                        ];
                    }
                } else {
                    if ((int) $port <= self::PORT_FLOOR || (int) $port > self::PORT_CEIL) {
                        throw new PortOutOfRangeException();
                    }

                    $insertData[] = [
                        'node_id' => $node->id,
                        'ip' => $ip->__toString(),
                        'port' => (int) $port,
                        'ip_alias' => array_get($data, 'allocation_alias'),
                        'server_id' => null,
                    ];
                }

                $this->repository->insertIgnore($insertData);
            }
        }

        $this->connection->commit();
    }
}
</file>

<file path="app/Services/Allocations/FindAssignableAllocationService.php">
<?php

namespace Jexactyl\Services\Allocations;

use Jexactyl\Models\Server;
use Webmozart\Assert\Assert;
use Jexactyl\Models\Allocation;
use Jexactyl\Exceptions\Service\Allocation\AutoAllocationNotEnabledException;
use Jexactyl\Exceptions\Service\Allocation\NoAutoAllocationSpaceAvailableException;

class FindAssignableAllocationService
{
    /**
     * FindAssignableAllocationService constructor.
     */
    public function __construct(private AssignmentService $service)
    {
    }

    /**
     * Finds an existing unassigned allocation and attempts to assign it to the given server. If
     * no allocation can be found, a new one will be created with a random port between the defined
     * range from the configuration.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Service\Allocation\CidrOutOfRangeException
     * @throws \Jexactyl\Exceptions\Service\Allocation\InvalidPortMappingException
     * @throws \Jexactyl\Exceptions\Service\Allocation\PortOutOfRangeException
     * @throws \Jexactyl\Exceptions\Service\Allocation\TooManyPortsInRangeException
     */
    public function handle(Server $server): Allocation
    {
        if (!config('jexactyl.client_features.allocations.enabled')) {
            throw new AutoAllocationNotEnabledException();
        }

        // Attempt to find a given available allocation for a server. If one cannot be found
        // we will fall back to attempting to create a new allocation that can be used for the
        // server.
        /** @var \Jexactyl\Models\Allocation|null $allocation */
        $allocation = $server->node->allocations()
            ->where('ip', $server->allocation->ip)
            ->whereNull('server_id')
            ->inRandomOrder()
            ->first();

        $allocation = $allocation ?? $this->createNewAllocation($server);

        $allocation->update(['server_id' => $server->id]);

        return $allocation->refresh();
    }

    /**
     * Create a new allocation on the server's node with a random port from the defined range
     * in the settings. If there are no matches in that range, or something is wrong with the
     * range information provided an exception will be raised.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Service\Allocation\CidrOutOfRangeException
     * @throws \Jexactyl\Exceptions\Service\Allocation\InvalidPortMappingException
     * @throws \Jexactyl\Exceptions\Service\Allocation\PortOutOfRangeException
     * @throws \Jexactyl\Exceptions\Service\Allocation\TooManyPortsInRangeException
     */
    protected function createNewAllocation(Server $server): Allocation
    {
        $start = config('jexactyl.client_features.allocations.range_start', null);
        $end = config('jexactyl.client_features.allocations.range_end', null);

        if (!$start || !$end) {
            throw new NoAutoAllocationSpaceAvailableException();
        }

        Assert::integerish($start);
        Assert::integerish($end);

        // Get all of the currently allocated ports for the node so that we can figure out
        // which port might be available.
        $ports = $server->node->allocations()
            ->where('ip', $server->allocation->ip)
            ->whereBetween('port', [$start, $end])
            ->pluck('port');

        // Compute the difference of the range and the currently created ports, finding
        // any port that does not already exist in the database. We will then use this
        // array of ports to create a new allocation to assign to the server.
        $available = array_diff(range($start, $end), $ports->toArray());

        // If we've already allocated all of the ports, just abort.
        if (empty($available)) {
            throw new NoAutoAllocationSpaceAvailableException();
        }

        // Pick a random port out of the remaining available ports.
        /** @var int $port */
        $port = $available[array_rand($available)];

        $this->service->handle($server->node, [
            'allocation_ip' => $server->allocation->ip,
            'allocation_ports' => [$port],
        ]);

        /** @var \Jexactyl\Models\Allocation $allocation */
        $allocation = $server->node->allocations()
            ->where('ip', $server->allocation->ip)
            ->where('port', $port)
            ->firstOrFail();

        return $allocation;
    }
}
</file>

<file path="app/Services/Analytics/AnalyticsReviewService.php">
<?php

namespace Jexactyl\Services\Analytics;

use Jexactyl\Models\Server;
use Jexactyl\Models\AnalyticsData;
use Jexactyl\Models\AnalyticsMessage;

class AnalyticsReviewService
{
    /**
     * Reviews analytics data for a server and sends
     * messages to the UI containing recommendations and information.
     */
    public function handle(Server $server)
    {
        $total = ['cpu' => 0, 'memory' => 0, 'disk' => 0];
        $analytics = AnalyticsData::where('server_id', $server->id)->select('cpu', 'memory', 'disk')->get();
        $size = count($analytics);

        if ($size <= 1) return;

        foreach ($analytics as $data) {
            $total['cpu'] += $data->cpu;
            $total['memory'] += $data->memory;
            $total['disk'] += $data->disk;
        }

        $total['cpu'] /= $size;
        $total['memory'] /= $size;
        $total['disk'] /= $size;

        $this->calculate($server->id, $total);
    }

    /**
     * Calculates the average usage per resource and sends notifications
     * when a conditional statement is true.
     */
    public function calculate(int $id, array $values): void
    {
        $min = 25;
        $max = 50;
        $size = count($values);

        foreach ($values as $key => $value) {
            if ($value <= 25) {
                $this->message($id, $size, $key, $value, false);
            }

            if ($value >= 50) {
                $this->message($id, $size, $key, $value, true);
            }
        }
    }

    /**
     * Sends a message to the server analytics UI.
     */
    public function message(int $id, int $size, string $key, int $value, bool $warning): void
    {
        $suffix = '% usage over past ' . $size . ' checks';

        AnalyticsMessage::create([
            'server_id' => $id,
            'title' => $key . ' usage was ' . ($warning ? 'over 75' : 'under 25') . '%',
            'content' => 'Measured ' . $value . $suffix,
            'type' => ($warning ? 'warning' : 'success'),
        ]);
    }
}
</file>

<file path="app/Services/Api/KeyCreationService.php">
<?php

namespace Jexactyl\Services\Api;

use Jexactyl\Models\ApiKey;
use Illuminate\Contracts\Encryption\Encrypter;
use Jexactyl\Contracts\Repository\ApiKeyRepositoryInterface;

class KeyCreationService
{
    private int $keyType = ApiKey::TYPE_NONE;

    /**
     * ApiKeyService constructor.
     */
    public function __construct(private ApiKeyRepositoryInterface $repository, private Encrypter $encrypter)
    {
    }

    /**
     * Set the type of key that should be created. By default an orphaned key will be
     * created. These keys cannot be used for anything, and will not render in the UI.
     */
    public function setKeyType(int $type): self
    {
        $this->keyType = $type;

        return $this;
    }

    /**
     * Create a new API key for the Panel using the permissions passed in the data request.
     * This will automatically generate an identifier and an encrypted token that are
     * stored in the database.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function handle(array $data, array $permissions = []): ApiKey
    {
        $data = array_merge($data, [
            'key_type' => $this->keyType,
            'identifier' => ApiKey::generateTokenIdentifier($this->keyType),
            'token' => $this->encrypter->encrypt(str_random(ApiKey::KEY_LENGTH)),
        ]);

        if ($this->keyType === ApiKey::TYPE_APPLICATION) {
            $data = array_merge($data, $permissions);
        }

        return $this->repository->create($data, true, true);
    }
}
</file>

<file path="app/Services/Backups/DeleteBackupService.php">
<?php

namespace Jexactyl\Services\Backups;

use Jexactyl\Models\Backup;
use Illuminate\Http\Response;
use GuzzleHttp\Exception\ClientException;
use Illuminate\Database\ConnectionInterface;
use Jexactyl\Extensions\Backups\BackupManager;
use Jexactyl\Repositories\Wings\DaemonBackupRepository;
use Jexactyl\Exceptions\Service\Backup\BackupLockedException;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;

class DeleteBackupService
{
    public function __construct(
        private ConnectionInterface $connection,
        private BackupManager $manager,
        private DaemonBackupRepository $daemonBackupRepository
    ) {
    }

    /**
     * Deletes a backup from the system. If the backup is stored in S3 a request
     * will be made to delete that backup from the disk as well.
     *
     * @throws \Throwable
     */
    public function handle(Backup $backup): void
    {
        // If the backup is marked as failed it can still be deleted, even if locked
        // since the UI doesn't allow you to unlock a failed backup in the first place.
        //
        // I also don't really see any reason you'd have a locked, failed backup to keep
        // around. The logic that updates the backup to the failed state will also remove
        // the lock, so this condition should really never happen.
        if ($backup->is_locked && ($backup->is_successful && !is_null($backup->completed_at))) {
            throw new BackupLockedException();
        }

        if ($backup->disk === Backup::ADAPTER_AWS_S3) {
            $this->deleteFromS3($backup);

            return;
        }

        $this->connection->transaction(function () use ($backup) {
            try {
                $this->daemonBackupRepository->setServer($backup->server)->delete($backup);
            } catch (DaemonConnectionException $exception) {
                $previous = $exception->getPrevious();
                // Don't fail the request if the Daemon responds with a 404, just assume the backup
                // doesn't actually exist and remove its reference from the Panel as well.
                if (!$previous instanceof ClientException || $previous->getResponse()->getStatusCode() !== Response::HTTP_NOT_FOUND) {
                    throw $exception;
                }
            }

            $backup->delete();
        });
    }

    /**
     * Deletes a backup from an S3 disk.
     *
     * @throws \Throwable
     */
    protected function deleteFromS3(Backup $backup): void
    {
        $this->connection->transaction(function () use ($backup) {
            $backup->delete();

            /** @var \Jexactyl\Extensions\Filesystem\S3Filesystem $adapter */
            $adapter = $this->manager->adapter(Backup::ADAPTER_AWS_S3);

            $adapter->getClient()->deleteObject([
                'Bucket' => $adapter->getBucket(),
                'Key' => sprintf('%s/%s.tar.gz', $backup->server->uuid, $backup->uuid),
            ]);
        });
    }
}
</file>

<file path="app/Services/Backups/DownloadLinkService.php">
<?php

namespace Jexactyl\Services\Backups;

use Jexactyl\Models\User;
use Carbon\CarbonImmutable;
use Jexactyl\Models\Backup;
use Jexactyl\Services\Nodes\NodeJWTService;
use Jexactyl\Extensions\Backups\BackupManager;

class DownloadLinkService
{
    /**
     * DownloadLinkService constructor.
     */
    public function __construct(private BackupManager $backupManager, private NodeJWTService $jwtService)
    {
    }

    /**
     * Returns the URL that allows for a backup to be downloaded by an individual
     * user, or by the Wings control software.
     */
    public function handle(Backup $backup, User $user): string
    {
        if ($backup->disk === Backup::ADAPTER_AWS_S3) {
            return $this->getS3BackupUrl($backup);
        }

        $token = $this->jwtService
            ->setExpiresAt(CarbonImmutable::now()->addMinutes(15))
            ->setUser($user)
            ->setClaims([
                'backup_uuid' => $backup->uuid,
                'server_uuid' => $backup->server->uuid,
            ])
            ->handle($backup->server->node, $user->id . $backup->server->uuid);

        return sprintf('%s/download/backup?token=%s', $backup->server->node->getConnectionAddress(), $token->toString());
    }

    /**
     * Returns a signed URL that allows us to download a file directly out of a non-public
     * S3 bucket by using a signed URL.
     */
    protected function getS3BackupUrl(Backup $backup): string
    {
        /** @var \Jexactyl\Extensions\Filesystem\S3Filesystem $adapter */
        $adapter = $this->backupManager->adapter(Backup::ADAPTER_AWS_S3);

        $request = $adapter->getClient()->createPresignedRequest(
            $adapter->getClient()->getCommand('GetObject', [
                'Bucket' => $adapter->getBucket(),
                'Key' => sprintf('%s/%s.tar.gz', $backup->server->uuid, $backup->uuid),
                'ContentType' => 'application/x-gzip',
            ]),
            CarbonImmutable::now()->addMinutes(5)
        );

        return $request->getUri()->__toString();
    }
}
</file>

<file path="app/Services/Backups/InitiateBackupService.php">
<?php

namespace Jexactyl\Services\Backups;

use Ramsey\Uuid\Uuid;
use Carbon\CarbonImmutable;
use Jexactyl\Models\Backup;
use Jexactyl\Models\Server;
use Webmozart\Assert\Assert;
use Illuminate\Database\ConnectionInterface;
use Jexactyl\Extensions\Backups\BackupManager;
use Jexactyl\Repositories\Eloquent\BackupRepository;
use Jexactyl\Repositories\Wings\DaemonBackupRepository;
use Jexactyl\Exceptions\Service\Backup\TooManyBackupsException;
use Symfony\Component\HttpKernel\Exception\TooManyRequestsHttpException;

class InitiateBackupService
{
    private ?array $ignoredFiles;

    private bool $isLocked = false;

    /**
     * InitiateBackupService constructor.
     */
    public function __construct(
        private BackupRepository $repository,
        private ConnectionInterface $connection,
        private DaemonBackupRepository $daemonBackupRepository,
        private DeleteBackupService $deleteBackupService,
        private BackupManager $backupManager
    ) {
    }

    /**
     * Set if the backup should be locked once it is created which will prevent
     * its deletion by users or automated system processes.
     */
    public function setIsLocked(bool $isLocked): self
    {
        $this->isLocked = $isLocked;

        return $this;
    }

    /**
     * Sets the files to be ignored by this backup.
     *
     * @param string[]|null $ignored
     */
    public function setIgnoredFiles(?array $ignored): self
    {
        if (is_array($ignored)) {
            foreach ($ignored as $value) {
                Assert::string($value);
            }
        }

        // Set the ignored files to be any values that are not empty in the array. Don't use
        // the PHP empty function here incase anything that is "empty" by default (0, false, etc.)
        // were passed as a file or folder name.
        $this->ignoredFiles = is_null($ignored) ? [] : array_filter($ignored, function ($value) {
            return strlen($value) > 0;
        });

        return $this;
    }

    /**
     * Initiates the backup process for a server on Wings.
     *
     * @throws \Throwable
     * @throws \Jexactyl\Exceptions\Service\Backup\TooManyBackupsException
     * @throws \Symfony\Component\HttpKernel\Exception\TooManyRequestsHttpException
     */
    public function handle(Server $server, string $name = null, bool $override = false): Backup
    {
        $limit = config('backups.throttles.limit');
        $period = config('backups.throttles.period');
        if ($period > 0) {
            $previous = $this->repository->getBackupsGeneratedDuringTimespan($server->id, $period);
            if ($previous->count() >= $limit) {
                $message = sprintf('Only %d backups may be generated within a %d second span of time.', $limit, $period);

                throw new TooManyRequestsHttpException(CarbonImmutable::now()->diffInSeconds($previous->last()->created_at->addSeconds($period)), $message);
            }
        }

        // Check if the server has reached or exceeded its backup limit.
        // completed_at == null will cover any ongoing backups, while is_successful == true will cover any completed backups.
        $successful = $this->repository->getNonFailedBackups($server);
        if (!$server->backup_limit || $successful->count() >= $server->backup_limit) {
            // Do not allow the user to continue if this server is already at its limit and can't override.
            if (!$override || $server->backup_limit <= 0) {
                throw new TooManyBackupsException($server->backup_limit);
            }

            // Get the oldest backup the server has that is not "locked" (indicating a backup that should
            // never be automatically purged). If we find a backup we will delete it and then continue with
            // this process. If no backup is found that can be used an exception is thrown.
            /** @var \Jexactyl\Models\Backup $oldest */
            $oldest = $successful->where('is_locked', false)->orderBy('created_at')->first();
            if (!$oldest) {
                throw new TooManyBackupsException($server->backup_limit);
            }

            $this->deleteBackupService->handle($oldest);
        }

        return $this->connection->transaction(function () use ($server, $name) {
            /** @var \Jexactyl\Models\Backup $backup */
            $backup = $this->repository->create([
                'server_id' => $server->id,
                'uuid' => Uuid::uuid4()->toString(),
                'name' => trim($name) ?: sprintf('Backup at %s', CarbonImmutable::now()->toDateTimeString()),
                'ignored_files' => array_values($this->ignoredFiles ?? []),
                'disk' => $this->backupManager->getDefaultAdapter(),
                'is_locked' => $this->isLocked,
            ], true, true);

            $this->daemonBackupRepository->setServer($server)
                ->setBackupAdapter($this->backupManager->getDefaultAdapter())
                ->backup($backup);

            return $backup;
        });
    }
}
</file>

<file path="app/Services/Databases/Hosts/HostCreationService.php">
<?php

namespace Jexactyl\Services\Databases\Hosts;

use Jexactyl\Models\DatabaseHost;
use Illuminate\Database\DatabaseManager;
use Illuminate\Database\ConnectionInterface;
use Illuminate\Contracts\Encryption\Encrypter;
use Jexactyl\Extensions\DynamicDatabaseConnection;
use Jexactyl\Contracts\Repository\DatabaseHostRepositoryInterface;

class HostCreationService
{
    /**
     * HostCreationService constructor.
     */
    public function __construct(
        private ConnectionInterface $connection,
        private DatabaseManager $databaseManager,
        private DynamicDatabaseConnection $dynamic,
        private Encrypter $encrypter,
        private DatabaseHostRepositoryInterface $repository
    ) {
    }

    /**
     * Create a new database host on the Panel.
     *
     * @throws \Throwable
     */
    public function handle(array $data): DatabaseHost
    {
        return $this->connection->transaction(function () use ($data) {
            $host = $this->repository->create([
                'password' => $this->encrypter->encrypt(array_get($data, 'password')),
                'name' => array_get($data, 'name'),
                'host' => array_get($data, 'host'),
                'port' => array_get($data, 'port'),
                'username' => array_get($data, 'username'),
                'max_databases' => null,
                'node_id' => array_get($data, 'node_id'),
            ]);

            // Confirm access using the provided credentials before saving data.
            $this->dynamic->set('dynamic', $host);
            $this->databaseManager->connection('dynamic')->select('SELECT 1 FROM dual');

            return $host;
        });
    }
}
</file>

<file path="app/Services/Databases/Hosts/HostDeletionService.php">
<?php

namespace Jexactyl\Services\Databases\Hosts;

use Jexactyl\Exceptions\Service\HasActiveServersException;
use Jexactyl\Contracts\Repository\DatabaseRepositoryInterface;
use Jexactyl\Contracts\Repository\DatabaseHostRepositoryInterface;

class HostDeletionService
{
    /**
     * HostDeletionService constructor.
     */
    public function __construct(
        private DatabaseRepositoryInterface $databaseRepository,
        private DatabaseHostRepositoryInterface $repository
    ) {
    }

    /**
     * Delete a specified host from the Panel if no databases are
     * attached to it.
     *
     * @throws \Jexactyl\Exceptions\Service\HasActiveServersException
     */
    public function handle(int $host): int
    {
        $count = $this->databaseRepository->findCountWhere([['database_host_id', '=', $host]]);
        if ($count > 0) {
            throw new HasActiveServersException(trans('exceptions.databases.delete_has_databases'));
        }

        return $this->repository->delete($host);
    }
}
</file>

<file path="app/Services/Databases/Hosts/HostUpdateService.php">
<?php

namespace Jexactyl\Services\Databases\Hosts;

use Jexactyl\Models\DatabaseHost;
use Illuminate\Database\DatabaseManager;
use Illuminate\Database\ConnectionInterface;
use Illuminate\Contracts\Encryption\Encrypter;
use Jexactyl\Extensions\DynamicDatabaseConnection;
use Jexactyl\Contracts\Repository\DatabaseHostRepositoryInterface;

class HostUpdateService
{
    /**
     * HostUpdateService constructor.
     */
    public function __construct(
        private ConnectionInterface $connection,
        private DatabaseManager $databaseManager,
        private DynamicDatabaseConnection $dynamic,
        private Encrypter $encrypter,
        private DatabaseHostRepositoryInterface $repository
    ) {
    }

    /**
     * Update a database host and persist to the database.
     *
     * @throws \Throwable
     */
    public function handle(int $hostId, array $data): DatabaseHost
    {
        if (!empty(array_get($data, 'password'))) {
            $data['password'] = $this->encrypter->encrypt($data['password']);
        } else {
            unset($data['password']);
        }

        return $this->connection->transaction(function () use ($data, $hostId) {
            $host = $this->repository->update($hostId, $data);
            $this->dynamic->set('dynamic', $host);
            $this->databaseManager->connection('dynamic')->select('SELECT 1 FROM dual');

            return $host;
        });
    }
}
</file>

<file path="app/Services/Databases/DatabaseManagementService.php">
<?php

namespace Jexactyl\Services\Databases;

use Exception;
use Jexactyl\Models\Server;
use Jexactyl\Models\Database;
use Jexactyl\Helpers\Utilities;
use Illuminate\Database\ConnectionInterface;
use Illuminate\Contracts\Encryption\Encrypter;
use Jexactyl\Extensions\DynamicDatabaseConnection;
use Jexactyl\Repositories\Eloquent\DatabaseRepository;
use Jexactyl\Exceptions\Repository\DuplicateDatabaseNameException;
use Jexactyl\Exceptions\Service\Database\TooManyDatabasesException;
use Jexactyl\Exceptions\Service\Database\DatabaseClientFeatureNotEnabledException;

class DatabaseManagementService
{
    /**
     * The regex used to validate that the database name passed through to the function is
     * in the expected format.
     *
     * @see \Jexactyl\Services\Databases\DatabaseManagementService::generateUniqueDatabaseName()
     */
    private const MATCH_NAME_REGEX = '/^(s[\d]+_)(.*)$/';

    /**
     * Determines if the service should validate the user's ability to create an additional
     * database for this server. In almost all cases this should be true, but to keep things
     * flexible you can also set it to false and create more databases than the server is
     * allocated.
     */
    protected bool $validateDatabaseLimit = true;

    public function __construct(
        protected ConnectionInterface $connection,
        protected DynamicDatabaseConnection $dynamic,
        protected Encrypter $encrypter,
        protected DatabaseRepository $repository
    ) {
    }

    /**
     * Generates a unique database name for the given server. This name should be passed through when
     * calling this handle function for this service, otherwise the database will be created with
     * whatever name is provided.
     */
    public static function generateUniqueDatabaseName(string $name, int $serverId): string
    {
        // Max of 48 characters, including the s123_ that we append to the front.
        return sprintf('s%d_%s', $serverId, substr($name, 0, 48 - strlen("s{$serverId}_")));
    }

    /**
     * Set whether this class should validate that the server has enough slots
     * left before creating the new database.
     */
    public function setValidateDatabaseLimit(bool $validate): self
    {
        $this->validateDatabaseLimit = $validate;

        return $this;
    }

    /**
     * Create a new database that is linked to a specific host.
     *
     * @throws \Throwable
     * @throws \Jexactyl\Exceptions\Service\Database\TooManyDatabasesException
     * @throws \Jexactyl\Exceptions\Service\Database\DatabaseClientFeatureNotEnabledException
     */
    public function create(Server $server, array $data): Database
    {
        if (!config('jexactyl.client_features.databases.enabled')) {
            throw new DatabaseClientFeatureNotEnabledException();
        }

        if ($this->validateDatabaseLimit) {
            // If the server has a limit assigned and we've already reached that limit, throw back
            // an exception and kill the process.
            if (!is_null($server->database_limit) && $server->databases()->count() >= $server->database_limit) {
                throw new TooManyDatabasesException();
            }
        }

        // Protect against developer mistakes...
        if (empty($data['database']) || !preg_match(self::MATCH_NAME_REGEX, $data['database'])) {
            throw new \InvalidArgumentException('The database name passed to DatabaseManagementService::handle MUST be prefixed with "s{server_id}_".');
        }

        $data = array_merge($data, [
            'server_id' => $server->id,
            'username' => sprintf('u%d_%s', $server->id, str_random(10)),
            'password' => $this->encrypter->encrypt(
                Utilities::randomStringWithSpecialCharacters(24)
            ),
        ]);

        $database = null;

        try {
            return $this->connection->transaction(function () use ($data, &$database) {
                $database = $this->createModel($data);

                $this->dynamic->set('dynamic', $data['database_host_id']);

                $this->repository->createDatabase($database->database);
                $this->repository->createUser(
                    $database->username,
                    $database->remote,
                    $this->encrypter->decrypt($database->password),
                    $database->max_connections
                );
                $this->repository->assignUserToDatabase($database->database, $database->username, $database->remote);
                $this->repository->flush();

                return $database;
            });
        } catch (\Exception $exception) {
            try {
                if ($database instanceof Database) {
                    $this->repository->dropDatabase($database->database);
                    $this->repository->dropUser($database->username, $database->remote);
                    $this->repository->flush();
                }
            } catch (\Exception $deletionException) {
                // Do nothing here. We've already encountered an issue before this point so no
                // reason to prioritize this error over the initial one.
            }

            throw $exception;
        }
    }

    /**
     * Delete a database from the given host server.
     *
     * @throws \Exception
     */
    public function delete(Database $database): ?bool
    {
        $this->dynamic->set('dynamic', $database->database_host_id);

        $this->repository->dropDatabase($database->database);
        $this->repository->dropUser($database->username, $database->remote);
        $this->repository->flush();

        return $database->delete();
    }

    /**
     * Create the database if there is not an identical match in the DB. While you can technically
     * have the same name across multiple hosts, for the sake of keeping this logic easy to understand
     * and avoiding user confusion we will ignore the specific host and just look across all hosts.
     *
     * @throws \Jexactyl\Exceptions\Repository\DuplicateDatabaseNameException
     * @throws \Throwable
     */
    protected function createModel(array $data): Database
    {
        $exists = Database::query()->where('server_id', $data['server_id'])
            ->where('database', $data['database'])
            ->exists();

        if ($exists) {
            throw new DuplicateDatabaseNameException('A database with that name already exists for this server.');
        }

        $database = (new Database())->forceFill($data);
        $database->saveOrFail();

        return $database;
    }
}
</file>

<file path="app/Services/Databases/DatabasePasswordService.php">
<?php

namespace Jexactyl\Services\Databases;

use Jexactyl\Models\Database;
use Jexactyl\Helpers\Utilities;
use Illuminate\Database\ConnectionInterface;
use Illuminate\Contracts\Encryption\Encrypter;
use Jexactyl\Extensions\DynamicDatabaseConnection;
use Jexactyl\Contracts\Repository\DatabaseRepositoryInterface;

class DatabasePasswordService
{
    /**
     * DatabasePasswordService constructor.
     */
    public function __construct(
        private ConnectionInterface $connection,
        private DynamicDatabaseConnection $dynamic,
        private Encrypter $encrypter,
        private DatabaseRepositoryInterface $repository
    ) {
    }

    /**
     * Updates a password for a given database.
     *
     * @throws \Throwable
     */
    public function handle(Database|int $database): string
    {
        $password = Utilities::randomStringWithSpecialCharacters(24);

        $this->connection->transaction(function () use ($database, $password) {
            $this->dynamic->set('dynamic', $database->database_host_id);

            $this->repository->withoutFreshModel()->update($database->id, [
                'password' => $this->encrypter->encrypt($password),
            ]);

            $this->repository->dropUser($database->username, $database->remote);
            $this->repository->createUser($database->username, $database->remote, $password, $database->max_connections);
            $this->repository->assignUserToDatabase($database->database, $database->username, $database->remote);
            $this->repository->flush();
        });

        return $password;
    }
}
</file>

<file path="app/Services/Databases/DeployServerDatabaseService.php">
<?php

namespace Jexactyl\Services\Databases;

use Jexactyl\Models\Server;
use Webmozart\Assert\Assert;
use Jexactyl\Models\Database;
use Jexactyl\Models\DatabaseHost;
use Jexactyl\Exceptions\Service\Database\NoSuitableDatabaseHostException;

class DeployServerDatabaseService
{
    /**
     * DeployServerDatabaseService constructor.
     */
    public function __construct(private DatabaseManagementService $managementService)
    {
    }

    /**
     * @throws \Throwable
     * @throws \Jexactyl\Exceptions\Service\Database\TooManyDatabasesException
     * @throws \Jexactyl\Exceptions\Service\Database\DatabaseClientFeatureNotEnabledException
     */
    public function handle(Server $server, array $data): Database
    {
        Assert::notEmpty($data['database'] ?? null);
        Assert::notEmpty($data['remote'] ?? null);

        $hosts = DatabaseHost::query()->get()->toBase();
        if ($hosts->isEmpty()) {
            throw new NoSuitableDatabaseHostException();
        } else {
            $nodeHosts = $hosts->where('node_id', $server->node_id)->toBase();

            if ($nodeHosts->isEmpty() && !config('jexactyl.client_features.databases.allow_random')) {
                throw new NoSuitableDatabaseHostException();
            }
        }

        return $this->managementService->create($server, [
            'database_host_id' => $nodeHosts->isEmpty()
                ? $hosts->random()->id
                : $nodeHosts->random()->id,
            'database' => DatabaseManagementService::generateUniqueDatabaseName($data['database'], $server->id),
            'remote' => $data['remote'],
        ]);
    }
}
</file>

<file path="app/Services/Deployment/AllocationSelectionService.php">
<?php

namespace Jexactyl\Services\Deployment;

use Jexactyl\Models\Allocation;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Services\Allocations\AssignmentService;
use Jexactyl\Contracts\Repository\AllocationRepositoryInterface;
use Jexactyl\Exceptions\Service\Deployment\NoViableAllocationException;

class AllocationSelectionService
{
    protected bool $dedicated = false;

    protected array $nodes = [];

    protected array $ports = [];

    /**
     * AllocationSelectionService constructor.
     */
    public function __construct(private AllocationRepositoryInterface $repository)
    {
    }

    /**
     * Toggle if the selected allocation should be the only allocation belonging
     * to the given IP address. If true an allocation will not be selected if an IP
     * already has another server set to use on if its allocations.
     */
    public function setDedicated(bool $dedicated): self
    {
        $this->dedicated = $dedicated;

        return $this;
    }

    /**
     * A list of node IDs that should be used when selecting an allocation. If empty, all
     * nodes will be used to filter with.
     */
    public function setNodes(array $nodes): self
    {
        $this->nodes = $nodes;

        return $this;
    }

    /**
     * An array of individual ports or port ranges to use when selecting an allocation. If
     * empty, all ports will be considered when finding an allocation. If set, only ports appearing
     * in the array or range will be used.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    public function setPorts(array $ports): self
    {
        $stored = [];
        foreach ($ports as $port) {
            if (is_digit($port)) {
                $stored[] = $port;
            }

            // Ranges are stored in the ports array as an array which can be
            // better processed in the repository.
            if (preg_match(AssignmentService::PORT_RANGE_REGEX, $port, $matches)) {
                if (abs($matches[2] - $matches[1]) > AssignmentService::PORT_RANGE_LIMIT) {
                    throw new DisplayException(trans('exceptions.allocations.too_many_ports'));
                }

                $stored[] = [$matches[1], $matches[2]];
            }
        }

        $this->ports = $stored;

        return $this;
    }

    /**
     * Return a single allocation that should be used as the default allocation for a server.
     *
     * @throws \Jexactyl\Exceptions\Service\Deployment\NoViableAllocationException
     */
    public function handle(): Allocation
    {
        $allocation = $this->repository->getRandomAllocation($this->nodes, $this->ports, $this->dedicated);

        if (is_null($allocation)) {
            throw new NoViableAllocationException(trans('exceptions.deployment.no_viable_allocations'));
        }

        return $allocation;
    }
}
</file>

<file path="app/Services/Deployment/FindViableNodesService.php">
<?php

namespace Jexactyl\Services\Deployment;

use Jexactyl\Models\Node;
use Webmozart\Assert\Assert;
use Illuminate\Support\Collection;
use Illuminate\Contracts\Pagination\LengthAwarePaginator;
use Jexactyl\Exceptions\Service\Deployment\NoViableNodeException;

class FindViableNodesService
{
    protected array $locations = [];
    protected ?int $disk = null;
    protected ?int $memory = null;

    /**
     * Set the locations that should be searched through to locate available nodes.
     */
    public function setLocations(array $locations): self
    {
        Assert::allIntegerish($locations, 'An array of location IDs should be provided when calling setLocations.');

        $this->locations = $locations;

        return $this;
    }

    /**
     * Set the amount of disk that will be used by the server being created. Nodes will be
     * filtered out if they do not have enough available free disk space for this server
     * to be placed on.
     */
    public function setDisk(int $disk): self
    {
        $this->disk = $disk;

        return $this;
    }

    /**
     * Set the amount of memory that this server will be using. As with disk space, nodes that
     * do not have enough free memory will be filtered out.
     */
    public function setMemory(int $memory): self
    {
        $this->memory = $memory;

        return $this;
    }

    /**
     * Returns an array of nodes that meet the provided requirements and can then
     * be passed to the AllocationSelectionService to return a single allocation.
     *
     * This functionality is used for automatic deployments of servers and will
     * attempt to find all nodes in the defined locations that meet the disk and
     * memory availability requirements. Any nodes not meeting those requirements
     * are tossed out, as are any nodes marked as non-public, meaning automatic
     * deployments should not be done against them.
     *
     * @param int|null $page If provided the results will be paginated by returning
     *                       up to 50 nodes at a time starting at the provided page.
     *                       If "null" is provided as the value no pagination will
     *                       be used.
     *
     * @throws \Jexactyl\Exceptions\Service\Deployment\NoViableNodeException
     */
    public function handle(int $perPage = null, int $page = null): LengthAwarePaginator|Collection
    {
        Assert::integer($this->disk, 'Disk space must be an int, got %s');
        Assert::integer($this->memory, 'Memory usage must be an int, got %s');

        $query = Node::query()->select('nodes.*')
            ->selectRaw('IFNULL(SUM(servers.memory), 0) as sum_memory')
            ->selectRaw('IFNULL(SUM(servers.disk), 0) as sum_disk')
            ->leftJoin('servers', 'servers.node_id', '=', 'nodes.id')
            ->where('nodes.public', 1);

        if (!empty($this->locations)) {
            $query = $query->whereIn('nodes.location_id', $this->locations);
        }

        $results = $query->groupBy('nodes.id')
            ->havingRaw('(IFNULL(SUM(servers.memory), 0) + ?) <= (nodes.memory * (1 + (nodes.memory_overallocate / 100)))', [$this->memory])
            ->havingRaw('(IFNULL(SUM(servers.disk), 0) + ?) <= (nodes.disk * (1 + (nodes.disk_overallocate / 100)))', [$this->disk]);

        if (!is_null($page)) {
            $results = $results->paginate($perPage ?? 50, ['*'], 'page', $page);
        } else {
            $results = $results->get()->toBase();
        }

        if ($results->isEmpty()) {
            throw new NoViableNodeException(trans('exceptions.deployment.no_viable_nodes'));
        }

        return $results;
    }
}
</file>

<file path="app/Services/Eggs/Scripts/InstallScriptService.php">
<?php

namespace Jexactyl\Services\Eggs\Scripts;

use Jexactyl\Models\Egg;
use Jexactyl\Contracts\Repository\EggRepositoryInterface;
use Jexactyl\Exceptions\Service\Egg\InvalidCopyFromException;

class InstallScriptService
{
    /**
     * InstallScriptService constructor.
     */
    public function __construct(protected EggRepositoryInterface $repository)
    {
    }

    /**
     * Modify the install script for a given Egg.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     * @throws \Jexactyl\Exceptions\Service\Egg\InvalidCopyFromException
     */
    public function handle(Egg $egg, array $data): void
    {
        if (!is_null(array_get($data, 'copy_script_from'))) {
            if (!$this->repository->isCopyableScript(array_get($data, 'copy_script_from'), $egg->nest_id)) {
                throw new InvalidCopyFromException(trans('exceptions.nest.egg.invalid_copy_id'));
            }
        }

        $this->repository->withoutFreshModel()->update($egg->id, [
            'script_install' => array_get($data, 'script_install'),
            'script_is_privileged' => array_get($data, 'script_is_privileged', 1),
            'script_entry' => array_get($data, 'script_entry'),
            'script_container' => array_get($data, 'script_container'),
            'copy_script_from' => array_get($data, 'copy_script_from'),
        ]);
    }
}
</file>

<file path="app/Services/Eggs/Sharing/EggExporterService.php">
<?php

namespace Jexactyl\Services\Eggs\Sharing;

use Carbon\Carbon;
use Jexactyl\Models\Egg;
use Jexactyl\Models\EggVariable;
use Illuminate\Support\Collection;
use Jexactyl\Contracts\Repository\EggRepositoryInterface;

class EggExporterService
{
    /**
     * EggExporterService constructor.
     */
    public function __construct(protected EggRepositoryInterface $repository)
    {
    }

    /**
     * Return a JSON representation of an egg and its variables.
     *
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function handle(int $egg): string
    {
        $egg = $this->repository->getWithExportAttributes($egg);

        $struct = [
            '_comment' => 'DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY Jexactyl PANEL - jexactyl.com',
            'meta' => [
                'version' => Egg::EXPORT_VERSION,
                'update_url' => $egg->update_url,
            ],
            'exported_at' => Carbon::now()->toAtomString(),
            'name' => $egg->name,
            'author' => $egg->author,
            'description' => $egg->description,
            'features' => $egg->features,
            'docker_images' => $egg->docker_images,
            'file_denylist' => Collection::make($egg->inherit_file_denylist)->filter(function ($value) {
                return !empty($value);
            }),
            'startup' => $egg->startup,
            'config' => [
                'files' => $egg->inherit_config_files,
                'startup' => $egg->inherit_config_startup,
                'logs' => $egg->inherit_config_logs,
                'stop' => $egg->inherit_config_stop,
            ],
            'scripts' => [
                'installation' => [
                    'script' => $egg->copy_script_install,
                    'container' => $egg->copy_script_container,
                    'entrypoint' => $egg->copy_script_entry,
                ],
            ],
            'variables' => $egg->variables->transform(function (EggVariable $item) {
                return Collection::make($item->toArray())
                    ->except(['id', 'egg_id', 'created_at', 'updated_at'])
                    ->merge(['field_type' => 'text'])
                    ->toArray();
            }),
        ];

        return json_encode($struct, JSON_PRETTY_PRINT);
    }
}
</file>

<file path="app/Services/Eggs/Sharing/EggImporterService.php">
<?php

namespace Jexactyl\Services\Eggs\Sharing;

use Ramsey\Uuid\Uuid;
use Jexactyl\Models\Egg;
use Jexactyl\Models\Nest;
use Illuminate\Support\Arr;
use Jexactyl\Models\EggVariable;
use Illuminate\Http\UploadedFile;
use Illuminate\Database\ConnectionInterface;
use Jexactyl\Services\Eggs\EggParserService;

class EggImporterService
{
    public function __construct(protected ConnectionInterface $connection, protected EggParserService $parser)
    {
    }

    /**
     * Take an uploaded JSON file and parse it into a new egg.
     *
     * @throws \Jexactyl\Exceptions\Service\InvalidFileUploadException|\Throwable
     */
    public function handle(UploadedFile $file, int $nest): Egg
    {
        $parsed = $this->parser->handle($file);

        /** @var \Jexactyl\Models\Nest $nest */
        $nest = Nest::query()->with('eggs', 'eggs.variables')->findOrFail($nest);

        return $this->connection->transaction(function () use ($nest, $parsed) {
            $egg = (new Egg())->forceFill([
                'uuid' => Uuid::uuid4()->toString(),
                'nest_id' => $nest->id,
                'author' => Arr::get($parsed, 'author'),
                'copy_script_from' => null,
            ]);

            $egg = $this->parser->fillFromParsed($egg, $parsed);
            $egg->save();

            foreach ($parsed['variables'] ?? [] as $variable) {
                EggVariable::query()->forceCreate(array_merge($variable, ['egg_id' => $egg->id]));
            }

            return $egg;
        });
    }
}
</file>

<file path="app/Services/Eggs/Sharing/EggUpdateImporterService.php">
<?php

namespace Jexactyl\Services\Eggs\Sharing;

use Jexactyl\Models\Egg;
use Jexactyl\Models\EggVariable;
use Illuminate\Http\UploadedFile;
use Illuminate\Support\Collection;
use Illuminate\Database\ConnectionInterface;
use Jexactyl\Services\Eggs\EggParserService;

class EggUpdateImporterService
{
    /**
     * EggUpdateImporterService constructor.
     */
    public function __construct(protected ConnectionInterface $connection, protected EggParserService $parser)
    {
    }

    /**
     * Update an existing Egg using an uploaded JSON file.
     *
     * @throws \Jexactyl\Exceptions\Service\InvalidFileUploadException|\Throwable
     */
    public function handle(Egg $egg, UploadedFile $file): Egg
    {
        $parsed = $this->parser->handle($file);

        return $this->connection->transaction(function () use ($egg, $parsed) {
            $egg = $this->parser->fillFromParsed($egg, $parsed);
            $egg->save();

            // Update existing variables or create new ones.
            foreach ($parsed['variables'] ?? [] as $variable) {
                EggVariable::unguarded(function () use ($egg, $variable) {
                    $egg->variables()->updateOrCreate([
                        'env_variable' => $variable['env_variable'],
                    ], Collection::make($variable)->except('egg_id', 'env_variable')->toArray());
                });
            }

            $imported = array_map(fn ($value) => $value['env_variable'], $parsed['variables'] ?? []);

            $egg->variables()->whereNotIn('env_variable', $imported)->delete();

            return $egg->refresh();
        });
    }
}
</file>

<file path="app/Services/Eggs/Variables/VariableCreationService.php">
<?php

namespace Jexactyl\Services\Eggs\Variables;

use Jexactyl\Models\EggVariable;
use Jexactyl\Traits\Services\ValidatesValidationRules;
use Illuminate\Contracts\Validation\Factory as ValidationFactory;
use Jexactyl\Contracts\Repository\EggVariableRepositoryInterface;
use Jexactyl\Exceptions\Service\Egg\Variable\ReservedVariableNameException;

class VariableCreationService
{
    use ValidatesValidationRules;

    /**
     * VariableCreationService constructor.
     */
    public function __construct(private EggVariableRepositoryInterface $repository, private ValidationFactory $validator)
    {
    }

    /**
     * Return the validation factory instance to be used by rule validation
     * checking in the trait.
     */
    protected function getValidator(): ValidationFactory
    {
        return $this->validator;
    }

    /**
     * Create a new variable for a given Egg.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Service\Egg\Variable\BadValidationRuleException
     * @throws \Jexactyl\Exceptions\Service\Egg\Variable\ReservedVariableNameException
     */
    public function handle(int $egg, array $data): EggVariable
    {
        if (in_array(strtoupper(array_get($data, 'env_variable')), explode(',', EggVariable::RESERVED_ENV_NAMES))) {
            throw new ReservedVariableNameException(sprintf('Cannot use the protected name %s for this environment variable.', array_get($data, 'env_variable')));
        }

        if (!empty($data['rules'] ?? '')) {
            $this->validateRules($data['rules']);
        }

        $options = array_get($data, 'options') ?? [];

        return $this->repository->create([
            'egg_id' => $egg,
            'name' => $data['name'] ?? '',
            'description' => $data['description'] ?? '',
            'env_variable' => $data['env_variable'] ?? '',
            'default_value' => $data['default_value'] ?? '',
            'user_viewable' => in_array('user_viewable', $options),
            'user_editable' => in_array('user_editable', $options),
            'rules' => $data['rules'] ?? '',
        ]);
    }
}
</file>

<file path="app/Services/Eggs/Variables/VariableUpdateService.php">
<?php

namespace Jexactyl\Services\Eggs\Variables;

use Illuminate\Support\Str;
use Jexactyl\Models\EggVariable;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Traits\Services\ValidatesValidationRules;
use Illuminate\Contracts\Validation\Factory as ValidationFactory;
use Jexactyl\Contracts\Repository\EggVariableRepositoryInterface;
use Jexactyl\Exceptions\Service\Egg\Variable\ReservedVariableNameException;

class VariableUpdateService
{
    use ValidatesValidationRules;

    /**
     * VariableUpdateService constructor.
     */
    public function __construct(private EggVariableRepositoryInterface $repository, private ValidationFactory $validator)
    {
    }

    /**
     * Return the validation factory instance to be used by rule validation
     * checking in the trait.
     */
    protected function getValidator(): ValidationFactory
    {
        return $this->validator;
    }

    /**
     * Update a specific egg variable.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     * @throws \Jexactyl\Exceptions\Service\Egg\Variable\ReservedVariableNameException
     */
    public function handle(EggVariable $variable, array $data): mixed
    {
        if (!is_null(array_get($data, 'env_variable'))) {
            if (in_array(strtoupper(array_get($data, 'env_variable')), explode(',', EggVariable::RESERVED_ENV_NAMES))) {
                throw new ReservedVariableNameException(trans('exceptions.service.variables.reserved_name', ['name' => array_get($data, 'env_variable')]));
            }

            $search = $this->repository->setColumns('id')->findCountWhere([
                ['env_variable', '=', $data['env_variable']],
                ['egg_id', '=', $variable->egg_id],
                ['id', '!=', $variable->id],
            ]);

            if ($search > 0) {
                throw new DisplayException(trans('exceptions.service.variables.env_not_unique', ['name' => array_get($data, 'env_variable')]));
            }
        }

        if (!empty($data['rules'] ?? '')) {
            $this->validateRules(
                (is_string($data['rules']) && Str::contains($data['rules'], ';;'))
                    ? explode(';;', $data['rules'])
                    : $data['rules']
            );
        }

        $options = array_get($data, 'options') ?? [];

        return $this->repository->withoutFreshModel()->update($variable->id, [
            'name' => $data['name'] ?? '',
            'description' => $data['description'] ?? '',
            'env_variable' => $data['env_variable'] ?? '',
            'default_value' => $data['default_value'] ?? '',
            'user_viewable' => in_array('user_viewable', $options),
            'user_editable' => in_array('user_editable', $options),
            'rules' => $data['rules'] ?? '',
        ]);
    }
}
</file>

<file path="app/Services/Eggs/EggConfigurationService.php">
<?php

namespace Jexactyl\Services\Eggs;

use Illuminate\Support\Arr;
use Illuminate\Support\Str;
use Jexactyl\Models\Server;
use Jexactyl\Services\Servers\ServerConfigurationStructureService;

class EggConfigurationService
{
    /**
     * EggConfigurationService constructor.
     */
    public function __construct(private ServerConfigurationStructureService $configurationStructureService)
    {
    }

    /**
     * Return an Egg file to be used by the Daemon.
     */
    public function handle(Server $server): array
    {
        $configs = $this->replacePlaceholders(
            $server,
            json_decode($server->egg->inherit_config_files)
        );

        return [
            'startup' => $this->convertStartupToNewFormat(json_decode($server->egg->inherit_config_startup, true)),
            'stop' => $this->convertStopToNewFormat($server->egg->inherit_config_stop),
            'configs' => $configs,
        ];
    }

    /**
     * Convert the "done" variable into an array if it is not currently one.
     */
    protected function convertStartupToNewFormat(array $startup): array
    {
        $done = Arr::get($startup, 'done');

        return [
            'done' => is_string($done) ? [$done] : $done,
            'user_interaction' => [],
            'strip_ansi' => Arr::get($startup, 'strip_ansi') ?? false,
        ];
    }

    /**
     * Converts a legacy stop string into a new generation stop option for a server.
     *
     * For most eggs, this ends up just being a command sent to the server console, but
     * if the stop command is something starting with a caret (^), it will be converted
     * into the associated kill signal for the instance.
     */
    protected function convertStopToNewFormat(string $stop): array
    {
        if (!Str::startsWith($stop, '^')) {
            return [
                'type' => 'command',
                'value' => $stop,
            ];
        }

        $signal = substr($stop, 1);
        if (strtoupper($signal) === 'C') {
            return [
                'type' => 'stop',
                'value' => null,
            ];
        }

        return [
            'type' => 'signal',
            'value' => strtoupper($signal),
        ];
    }

    protected function replacePlaceholders(Server $server, object $configs): array
    {
        // Get the legacy configuration structure for the server so that we
        // can property map the egg placeholders to values.
        $structure = $this->configurationStructureService->handle($server, [], true);

        $response = [];
        // Normalize the output of the configuration for the new Wings Daemon to more
        // easily ingest, as well as make things more flexible down the road.
        foreach ($configs as $file => $data) {
            // Try to head off any errors relating to parsing a set of configuration files
            // or other JSON data for the egg. This should probably be blocked at the time
            // of egg creation/update, but it isn't so this check will at least prevent a
            // 500 error which would crash the entire Wings boot process.
            //
            // @see https://github.com/pterodactyl/panel/issues/3055
            if (!is_object($data) || !isset($data->find)) {
                continue;
            }

            $append = array_merge((array) $data, ['file' => $file, 'replace' => []]);

            foreach ($this->iterate($data->find, $structure) as $find => $replace) {
                if (is_object($replace)) {
                    foreach ($replace as $match => $replaceWith) {
                        $append['replace'][] = [
                            'match' => $find,
                            'if_value' => $match,
                            'replace_with' => $replaceWith,
                        ];
                    }

                    continue;
                }

                $append['replace'][] = [
                    'match' => $find,
                    'replace_with' => $replace,
                ];
            }

            unset($append['find']);

            $response[] = $append;
        }

        return $response;
    }

    /**
     * Replaces the legacy modifies from eggs with their new counterpart. The legacy Daemon would
     * set SERVER_MEMORY, SERVER_IP, and SERVER_PORT with their respective values on the Daemon
     * side. Ensure that anything referencing those properly replaces them with the matching config
     * value.
     */
    protected function replaceLegacyModifiers(string $key, string $value): string
    {
        switch ($key) {
            case 'config.docker.interface':
                $replace = 'config.docker.network.interface';
                break;
            case 'server.build.env.SERVER_MEMORY':
            case 'env.SERVER_MEMORY':
                $replace = 'server.build.memory';
                break;
            case 'server.build.env.SERVER_IP':
            case 'env.SERVER_IP':
                $replace = 'server.build.default.ip';
                break;
            case 'server.build.env.SERVER_PORT':
            case 'env.SERVER_PORT':
                $replace = 'server.build.default.port';
                break;
            default:
                // By default, we don't need to change anything, only if we ended up matching a specific legacy item.
                $replace = $key;
        }

        return str_replace("{{{$key}}}", "{{{$replace}}}", $value);
    }

    protected function matchAndReplaceKeys(mixed $value, array $structure): mixed
    {
        preg_match_all('/{{(?<key>[\w.-]*)}}/', $value, $matches);

        foreach ($matches['key'] as $key) {
            // Matched something in {{server.X}} format, now replace that with the actual
            // value from the server properties.
            //
            // The Daemon supports server.X, env.X, and config.X placeholders.
            if (!Str::startsWith($key, ['server.', 'env.', 'config.'])) {
                continue;
            }

            // Don't do a replacement on anything that is not a string, we don't want to unintentionally
            // modify the resulting output.
            if (!is_string($value)) {
                continue;
            }

            $value = $this->replaceLegacyModifiers($key, $value);

            // We don't want to do anything with config keys since the Daemon will need to handle
            // that. For example, the Spigot egg uses "config.docker.interface" to identify the Docker
            // interface to proxy through, but the Panel would be unaware of that.
            if (Str::startsWith($key, 'config.')) {
                continue;
            }

            // Replace anything starting with "server." with the value out of the server configuration
            // array that used to be created for the old daemon.
            if (Str::startsWith($key, 'server.')) {
                $plucked = Arr::get($structure, preg_replace('/^server\./', '', $key), '');

                $value = str_replace("{{{$key}}}", $plucked, $value);
                continue;
            }

            // Finally, replace anything starting with env. with the expected environment
            // variable from the server configuration.
            $plucked = Arr::get(
                $structure,
                preg_replace('/^env\./', 'build.env.', $key),
                ''
            );

            $value = str_replace("{{{$key}}}", $plucked, $value);
        }

        return $value;
    }

    /**
     * Iterates over a set of "find" values for a given file in the parser configuration. If
     * the value of the line match is something iterable, continue iterating, otherwise perform
     * a match & replace.
     */
    private function iterate(mixed $data, array $structure): mixed
    {
        if (!is_iterable($data) && !is_object($data)) {
            return $data;
        }

        // Remember, in PHP objects are always passed by reference, so if we do not clone this object
        // instance we'll end up making modifications to the object outside the scope of this function
        // which leads to some fun behavior in the parser.
        if (is_array($data)) {
            // Copy the array.
            // NOTE: if the array contains any objects, they will be passed by reference.
            $clone = $data;
        } else {
            $clone = clone $data;
        }
        foreach ($clone as $key => &$value) {
            if (is_iterable($value) || is_object($value)) {
                $value = $this->iterate($value, $structure);

                continue;
            }

            $value = $this->matchAndReplaceKeys($value, $structure);
        }

        return $clone;
    }
}
</file>

<file path="app/Services/Eggs/EggCreationService.php">
<?php

namespace Jexactyl\Services\Eggs;

use Ramsey\Uuid\Uuid;
use Jexactyl\Models\Egg;
use Jexactyl\Contracts\Repository\EggRepositoryInterface;
use Illuminate\Contracts\Config\Repository as ConfigRepository;
use Jexactyl\Exceptions\Service\Egg\NoParentConfigurationFoundException;

// When a mommy and a daddy Jexactyl really like each other...
class EggCreationService
{
    /**
     * EggCreationService constructor.
     */
    public function __construct(private ConfigRepository $config, private EggRepositoryInterface $repository)
    {
    }

    /**
     * Create a new service option and assign it to the given service.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Service\Egg\NoParentConfigurationFoundException
     */
    public function handle(array $data): Egg
    {
        $data['config_from'] = array_get($data, 'config_from');
        if (!is_null($data['config_from'])) {
            $results = $this->repository->findCountWhere([
                ['nest_id', '=', array_get($data, 'nest_id')],
                ['id', '=', array_get($data, 'config_from')],
            ]);

            if ($results !== 1) {
                throw new NoParentConfigurationFoundException(trans('exceptions.nest.egg.must_be_child'));
            }
        }

        return $this->repository->create(array_merge($data, [
            'uuid' => Uuid::uuid4()->toString(),
            'author' => $this->config->get('jexactyl.service.author'),
        ]), true, true);
    }
}
</file>

<file path="app/Services/Eggs/EggDeletionService.php">
<?php

namespace Jexactyl\Services\Eggs;

use Jexactyl\Contracts\Repository\EggRepositoryInterface;
use Jexactyl\Exceptions\Service\Egg\HasChildrenException;
use Jexactyl\Exceptions\Service\HasActiveServersException;
use Jexactyl\Contracts\Repository\ServerRepositoryInterface;

class EggDeletionService
{
    /**
     * EggDeletionService constructor.
     */
    public function __construct(
        protected ServerRepositoryInterface $serverRepository,
        protected EggRepositoryInterface $repository
    ) {
    }

    /**
     * Delete an Egg from the database if it has no active servers attached to it.
     *
     * @throws \Jexactyl\Exceptions\Service\HasActiveServersException
     * @throws \Jexactyl\Exceptions\Service\Egg\HasChildrenException
     */
    public function handle(int $egg): int
    {
        $servers = $this->serverRepository->findCountWhere([['egg_id', '=', $egg]]);
        if ($servers > 0) {
            throw new HasActiveServersException(trans('exceptions.nest.egg.delete_has_servers'));
        }

        $children = $this->repository->findCountWhere([['config_from', '=', $egg]]);
        if ($children > 0) {
            throw new HasChildrenException(trans('exceptions.nest.egg.has_children'));
        }

        return $this->repository->delete($egg);
    }
}
</file>

<file path="app/Services/Eggs/EggParserService.php">
<?php

namespace Jexactyl\Services\Eggs;

use Jexactyl\Models\Egg;
use Illuminate\Support\Arr;
use Illuminate\Http\UploadedFile;
use Illuminate\Support\Collection;
use Jexactyl\Exceptions\Service\InvalidFileUploadException;

class EggParserService
{
    /**
     * Takes an uploaded file and parses out the egg configuration from within.
     *
     * @throws \JsonException
     * @throws \Jexactyl\Exceptions\Service\InvalidFileUploadException
     */
    public function handle(UploadedFile $file): array
    {
        if ($file->getError() !== UPLOAD_ERR_OK || !$file->isFile()) {
            throw new InvalidFileUploadException('The selected file is not valid and cannot be imported.');
        }

        /** @var array $parsed */
        $parsed = json_decode($file->openFile()->fread($file->getSize()), true, 512, JSON_THROW_ON_ERROR);
        if (!in_array(Arr::get($parsed, 'meta.version') ?? '', ['PTDL_v1', 'PTDL_v2'])) {
            throw new InvalidFileUploadException('The JSON file provided is not in a format that can be recognized.');
        }

        return $this->convertToV2($parsed);
    }

    /**
     * Fills the provided model with the parsed JSON data.
     */
    public function fillFromParsed(Egg $model, array $parsed): Egg
    {
        return $model->forceFill([
            'name' => Arr::get($parsed, 'name'),
            'description' => Arr::get($parsed, 'description'),
            'features' => Arr::get($parsed, 'features'),
            'docker_images' => Arr::get($parsed, 'docker_images'),
            'file_denylist' => Collection::make(Arr::get($parsed, 'file_denylist'))
                ->filter(fn ($value) => !empty($value)),
            'update_url' => Arr::get($parsed, 'meta.update_url'),
            'config_files' => Arr::get($parsed, 'config.files'),
            'config_startup' => Arr::get($parsed, 'config.startup'),
            'config_logs' => Arr::get($parsed, 'config.logs'),
            'config_stop' => Arr::get($parsed, 'config.stop'),
            'startup' => Arr::get($parsed, 'startup'),
            'script_install' => Arr::get($parsed, 'scripts.installation.script'),
            'script_entry' => Arr::get($parsed, 'scripts.installation.entrypoint'),
            'script_container' => Arr::get($parsed, 'scripts.installation.container'),
        ]);
    }

    /**
     * Converts a PTDL_V1 egg into the expected PTDL_V2 egg format. This just handles
     * the "docker_images" field potentially not being present, and not being in the
     * expected "key => value" format.
     */
    protected function convertToV2(array $parsed): array
    {
        if (Arr::get($parsed, 'meta.version') === Egg::EXPORT_VERSION) {
            return $parsed;
        }

        // Maintain backwards compatability for eggs that are still using the old single image
        // string format. New eggs can provide an array of Docker images that can be used.
        if (!isset($parsed['images'])) {
            $images = [Arr::get($parsed, 'image') ?? 'nil'];
        } else {
            $images = $parsed['images'];
        }

        unset($parsed['images'], $parsed['image']);

        $parsed['docker_images'] = [];
        foreach ($images as $image) {
            $parsed['docker_images'][$image] = $image;
        }

        $parsed['variables'] = array_map(function ($value) {
            return array_merge($value, ['field_type' => 'text']);
        }, $parsed['variables']);

        return $parsed;
    }
}
</file>

<file path="app/Services/Eggs/EggUpdateService.php">
<?php

namespace Jexactyl\Services\Eggs;

use Jexactyl\Models\Egg;
use Jexactyl\Contracts\Repository\EggRepositoryInterface;
use Jexactyl\Exceptions\Service\Egg\NoParentConfigurationFoundException;

class EggUpdateService
{
    /**
     * EggUpdateService constructor.
     */
    public function __construct(protected EggRepositoryInterface $repository)
    {
    }

    /**
     * Update a service option.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     * @throws \Jexactyl\Exceptions\Service\Egg\NoParentConfigurationFoundException
     */
    public function handle(Egg $egg, array $data): void
    {
        if (!is_null(array_get($data, 'config_from'))) {
            $results = $this->repository->findCountWhere([
                ['nest_id', '=', $egg->nest_id],
                ['id', '=', array_get($data, 'config_from')],
            ]);

            if ($results !== 1) {
                throw new NoParentConfigurationFoundException(trans('exceptions.nest.egg.must_be_child'));
            }
        }

        // TODO(dane): Once the admin UI is done being reworked and this is exposed
        //  in said UI, remove this so that you can actually update the denylist.
        unset($data['file_denylist']);

        $this->repository->withoutFreshModel()->update($egg->id, $data);
    }
}
</file>

<file path="app/Services/Helpers/AssetHashService.php">
<?php

namespace Jexactyl\Services\Helpers;

use Illuminate\Support\Arr;
use Illuminate\Filesystem\FilesystemManager;
use Illuminate\Contracts\Filesystem\Filesystem;
use Jexactyl\Exceptions\ManifestDoesNotExistException;

class AssetHashService
{
    /**
     * Location of the manifest file generated by gulp.
     */
    public const MANIFEST_PATH = './assets/manifest.json';

    private Filesystem $filesystem;

    protected static mixed $manifest = null;

    /**
     * AssetHashService constructor.
     */
    public function __construct(FilesystemManager $filesystem)
    {
        $this->filesystem = $filesystem->createLocalDriver(['root' => public_path()]);
    }

    /**
     * Modify a URL to append the asset hash.
     */
    public function url(string $resource): string
    {
        $file = last(explode('/', $resource));
        $data = Arr::get($this->manifest(), $file) ?? $file;

        return str_replace($file, Arr::get($data, 'src') ?? $file, $resource);
    }

    /**
     * Return the data integrity hash for a resource.
     */
    public function integrity(string $resource): string
    {
        $file = last(explode('/', $resource));
        $data = array_get($this->manifest(), $file, $file);

        return Arr::get($data, 'integrity') ?? '';
    }

    /**
     * Return a built CSS import using the provided URL.
     */
    public function css(string $resource): string
    {
        $attributes = [
            'href' => $this->url($resource),
            'rel' => 'stylesheet preload',
            'as' => 'style',
            'crossorigin' => 'anonymous',
            'referrerpolicy' => 'no-referrer',
        ];

        if (config('jexactyl.assets.use_hash')) {
            $attributes['integrity'] = $this->integrity($resource);
        }

        $output = '<link';
        foreach ($attributes as $key => $value) {
            $output .= " $key=\"$value\"";
        }

        return $output . '>';
    }

    /**
     * Return a built JS import using the provided URL.
     */
    public function js(string $resource): string
    {
        $attributes = [
            'src' => $this->url($resource),
            'crossorigin' => 'anonymous',
        ];

        if (config('jexactyl.assets.use_hash')) {
            $attributes['integrity'] = $this->integrity($resource);
        }

        $output = '<script';
        foreach ($attributes as $key => $value) {
            $output .= " $key=\"$value\"";
        }

        return $output . '></script>';
    }

    /**
     * Get the asset manifest and store it in the cache for quicker lookups.
     */
    protected function manifest(): array
    {
        if (static::$manifest === null) {
            self::$manifest = json_decode(
                $this->filesystem->get(self::MANIFEST_PATH),
                true
            );
        }

        $manifest = static::$manifest;
        if ($manifest === null) {
            throw new ManifestDoesNotExistException();
        }

        return $manifest;
    }
}
</file>

<file path="app/Services/Helpers/SoftwareVersionService.php">
<?php

namespace Jexactyl\Services\Helpers;

use Exception;
use GuzzleHttp\Client;
use Carbon\CarbonImmutable;
use Illuminate\Support\Arr;
use Illuminate\Contracts\Cache\Repository as CacheRepository;
use Jexactyl\Exceptions\Service\Helper\CdnVersionFetchingException;

class SoftwareVersionService
{
    public const VERSION_CACHE_KEY = 'jexactyl:versioning_data';

    private static array $result;

    /**
     * SoftwareVersionService constructor.
     */
    public function __construct(
        protected CacheRepository $cache,
        protected Client $client
    ) {
        self::$result = $this->cacheVersionData();
    }

    /**
     * Get the latest version of the panel from the CDN servers.
     */
    public function getPanel(): string
    {
        return Arr::get(self::$result, 'panel') ?? 'error';
    }

    /**
     * Get the latest version of the daemon from the CDN servers.
     */
    public function getDaemon(): string
    {
        return Arr::get(self::$result, 'wings') ?? 'error';
    }

    /**
     * Get the URL to the discord server.
     */
    public function getDiscord(): string
    {
        return Arr::get(self::$result, 'discord') ?? 'https://discord.gg/qttGR4Z5Pk';
    }

    /**
     * Get the URL for donations.
     */
    public function getDonations(): string
    {
        return Arr::get(self::$result, 'donations') ?? 'https://github.com/sponsors/matthewpi';
    }

    /**
     * Determine if the current version of the panel is the latest.
     */
    public function isLatestPanel(): bool
    {
        if (config('app.version') === 'canary') {
            return true;
        }

        return version_compare(config('app.version'), $this->getPanel()) >= 0;
    }

    /**
     * Determine if a passed daemon version string is the latest.
     */
    public function isLatestDaemon(string $version): bool
    {
        if ($version === 'develop') {
            return true;
        }

        return version_compare($version, $this->getDaemon()) >= 0;
    }

    /**
     * Keeps the versioning cache up-to-date with the latest results from the CDN.
     */
    protected function cacheVersionData(): array
    {
        return $this->cache->remember(self::VERSION_CACHE_KEY, CarbonImmutable::now()->addMinutes(config('jexactyl.cdn.cache_time', 60)), function () {
            try {
                $response = $this->client->request('GET', config('jexactyl.cdn.url'));

                if ($response->getStatusCode() === 200) {
                    return json_decode($response->getBody(), true);
                }

                throw new CdnVersionFetchingException();
            } catch (Exception) {
                return [];
            }
        });
    }
}
</file>

<file path="app/Services/Locations/LocationCreationService.php">
<?php

namespace Jexactyl\Services\Locations;

use Jexactyl\Models\Location;
use Jexactyl\Contracts\Repository\LocationRepositoryInterface;

class LocationCreationService
{
    /**
     * LocationCreationService constructor.
     */
    public function __construct(protected LocationRepositoryInterface $repository)
    {
    }

    /**
     * Create a new location.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function handle(array $data): Location
    {
        return $this->repository->create($data);
    }
}
</file>

<file path="app/Services/Locations/LocationDeletionService.php">
<?php

namespace Jexactyl\Services\Locations;

use Webmozart\Assert\Assert;
use Jexactyl\Models\Location;
use Jexactyl\Contracts\Repository\NodeRepositoryInterface;
use Jexactyl\Contracts\Repository\LocationRepositoryInterface;
use Jexactyl\Exceptions\Service\Location\HasActiveNodesException;

class LocationDeletionService
{
    /**
     * LocationDeletionService constructor.
     */
    public function __construct(
        protected LocationRepositoryInterface $repository,
        protected NodeRepositoryInterface $nodeRepository
    ) {
    }

    /**
     * Delete an existing location.
     *
     * @throws \Jexactyl\Exceptions\Service\Location\HasActiveNodesException
     */
    public function handle(Location|int $location): ?int
    {
        $location = ($location instanceof Location) ? $location->id : $location;

        Assert::integerish($location, 'First argument passed to handle must be numeric or an instance of ' . Location::class . ', received %s.');

        $count = $this->nodeRepository->findCountWhere([['location_id', '=', $location]]);
        if ($count > 0) {
            throw new HasActiveNodesException(trans('exceptions.locations.has_nodes'));
        }

        return $this->repository->delete($location);
    }
}
</file>

<file path="app/Services/Locations/LocationUpdateService.php">
<?php

namespace Jexactyl\Services\Locations;

use Jexactyl\Models\Location;
use Jexactyl\Contracts\Repository\LocationRepositoryInterface;

class LocationUpdateService
{
    /**
     * LocationUpdateService constructor.
     */
    public function __construct(protected LocationRepositoryInterface $repository)
    {
    }

    /**
     * Update an existing location.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function handle(Location|int $location, array $data): Location
    {
        $location = ($location instanceof Location) ? $location->id : $location;

        return $this->repository->update($location, $data);
    }
}
</file>

<file path="app/Services/Nests/NestCreationService.php">
<?php

namespace Jexactyl\Services\Nests;

use Ramsey\Uuid\Uuid;
use Jexactyl\Models\Nest;
use Jexactyl\Contracts\Repository\NestRepositoryInterface;
use Illuminate\Contracts\Config\Repository as ConfigRepository;

class NestCreationService
{
    /**
     * NestCreationService constructor.
     */
    public function __construct(private ConfigRepository $config, private NestRepositoryInterface $repository)
    {
    }

    /**
     * Create a new nest on the system.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function handle(array $data, string $author = null): Nest
    {
        return $this->repository->create([
            'uuid' => Uuid::uuid4()->toString(),
            'author' => $author ?? $this->config->get('jexactyl.service.author'),
            'name' => array_get($data, 'name'),
            'description' => array_get($data, 'description'),
            'private' => array_get($data, 'private'),
        ], true, true);
    }
}
</file>

<file path="app/Services/Nests/NestDeletionService.php">
<?php

namespace Jexactyl\Services\Nests;

use Jexactyl\Contracts\Repository\NestRepositoryInterface;
use Jexactyl\Exceptions\Service\HasActiveServersException;
use Jexactyl\Contracts\Repository\ServerRepositoryInterface;

class NestDeletionService
{
    /**
     * NestDeletionService constructor.
     */
    public function __construct(
        protected ServerRepositoryInterface $serverRepository,
        protected NestRepositoryInterface $repository
    ) {
    }

    /**
     * Delete a nest from the system only if there are no servers attached to it.
     *
     * @throws \Jexactyl\Exceptions\Service\HasActiveServersException
     */
    public function handle(int $nest): int
    {
        $count = $this->serverRepository->findCountWhere([['nest_id', '=', $nest]]);
        if ($count > 0) {
            throw new HasActiveServersException(trans('exceptions.nest.delete_has_servers'));
        }

        return $this->repository->delete($nest);
    }
}
</file>

<file path="app/Services/Nests/NestUpdateService.php">
<?php

namespace Jexactyl\Services\Nests;

use Jexactyl\Contracts\Repository\NestRepositoryInterface;

class NestUpdateService
{
    /**
     * NestUpdateService constructor.
     */
    public function __construct(protected NestRepositoryInterface $repository)
    {
    }

    /**
     * Update a nest and prevent changing the author once it is set.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function handle(int $nest, array $data): void
    {
        if (!is_null(array_get($data, 'author'))) {
            unset($data['author']);
        }

        $this->repository->withoutFreshModel()->update($nest, $data);
    }
}
</file>

<file path="app/Services/Nodes/NodeCreationService.php">
<?php

namespace Jexactyl\Services\Nodes;

use Ramsey\Uuid\Uuid;
use Jexactyl\Models\Node;
use Illuminate\Support\Str;
use Illuminate\Contracts\Encryption\Encrypter;
use Jexactyl\Contracts\Repository\NodeRepositoryInterface;

class NodeCreationService
{
    /**
     * NodeCreationService constructor.
     */
    public function __construct(protected NodeRepositoryInterface $repository)
    {
    }

    /**
     * Create a new node on the panel.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function handle(array $data): Node
    {
        $data['uuid'] = Uuid::uuid4()->toString();
        $data['daemon_token'] = app(Encrypter::class)->encrypt(Str::random(Node::DAEMON_TOKEN_LENGTH));
        $data['daemon_token_id'] = Str::random(Node::DAEMON_TOKEN_ID_LENGTH);

        return $this->repository->create($data, true, true);
    }
}
</file>

<file path="app/Services/Nodes/NodeDeletionService.php">
<?php

namespace Jexactyl\Services\Nodes;

use Jexactyl\Models\Node;
use Illuminate\Contracts\Translation\Translator;
use Jexactyl\Contracts\Repository\NodeRepositoryInterface;
use Jexactyl\Exceptions\Service\HasActiveServersException;
use Jexactyl\Contracts\Repository\ServerRepositoryInterface;

class NodeDeletionService
{
    /**
     * NodeDeletionService constructor.
     */
    public function __construct(
        protected NodeRepositoryInterface $repository,
        protected ServerRepositoryInterface $serverRepository,
        protected Translator $translator
    ) {
    }

    /**
     * Delete a node from the panel if no servers are attached to it.
     *
     * @throws \Jexactyl\Exceptions\Service\HasActiveServersException
     */
    public function handle(int|Node $node): int
    {
        if ($node instanceof Node) {
            $node = $node->id;
        }

        $servers = $this->serverRepository->setColumns('id')->findCountWhere([['node_id', '=', $node]]);
        if ($servers > 0) {
            throw new HasActiveServersException($this->translator->get('exceptions.node.servers_attached'));
        }

        return $this->repository->delete($node);
    }
}
</file>

<file path="app/Services/Nodes/NodeJWTService.php">
<?php

namespace Jexactyl\Services\Nodes;

use Jexactyl\Models\Node;
use Jexactyl\Models\User;
use Carbon\CarbonImmutable;
use Illuminate\Support\Str;
use Lcobucci\JWT\Token\Plain;
use Lcobucci\JWT\Configuration;
use Lcobucci\JWT\Signer\Hmac\Sha256;
use Lcobucci\JWT\Signer\Key\InMemory;
use Jexactyl\Extensions\Lcobucci\JWT\Encoding\TimestampDates;

class NodeJWTService
{
    private array $claims = [];

    private ?User $user = null;

    private ?\DateTimeImmutable $expiresAt;

    private ?string $subject = null;

    /**
     * Set the claims to include in this JWT.
     */
    public function setClaims(array $claims): self
    {
        $this->claims = $claims;

        return $this;
    }

    /**
     * Attaches a user to the JWT being created and will automatically inject the
     * "user_uuid" key into the final claims array with the user's UUID.
     */
    public function setUser(User $user): self
    {
        $this->user = $user;

        return $this;
    }

    public function setExpiresAt(\DateTimeImmutable $date): self
    {
        $this->expiresAt = $date;

        return $this;
    }

    public function setSubject(string $subject): self
    {
        $this->subject = $subject;

        return $this;
    }

    /**
     * Generate a new JWT for a given node.
     */
    public function handle(Node $node, ?string $identifiedBy, string $algo = 'md5'): Plain
    {
        $identifier = hash($algo, $identifiedBy);
        $config = Configuration::forSymmetricSigner(new Sha256(), InMemory::plainText($node->getDecryptedKey()));

        $builder = $config->builder(new TimestampDates())
            ->issuedBy(config('app.url'))
            ->permittedFor($node->getConnectionAddress())
            ->identifiedBy($identifier)
            ->withHeader('jti', $identifier)
            ->issuedAt(CarbonImmutable::now())
            ->canOnlyBeUsedAfter(CarbonImmutable::now()->subMinutes(5));

        if ($this->expiresAt) {
            $builder = $builder->expiresAt($this->expiresAt);
        }

        if (!empty($this->subject)) {
            $builder = $builder->relatedTo($this->subject)->withHeader('sub', $this->subject);
        }

        foreach ($this->claims as $key => $value) {
            $builder = $builder->withClaim($key, $value);
        }

        if (!is_null($this->user)) {
            $builder = $builder
                ->withClaim('user_uuid', $this->user->uuid)
                // The "user_id" claim is deprecated and should not be referenced  it remains
                // here solely to ensure older versions of Wings are unaffected when the Panel
                // is updated.
                //
                // This claim will be removed in Panel@1.11 or later.
                ->withClaim('user_id', $this->user->id);
        }

        return $builder
            ->withClaim('unique_id', Str::random())
            ->getToken($config->signer(), $config->signingKey());
    }
}
</file>

<file path="app/Services/Nodes/NodeUpdateService.php">
<?php

namespace Jexactyl\Services\Nodes;

use Jexactyl\Models\Node;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Log;
use Illuminate\Database\ConnectionInterface;
use Illuminate\Contracts\Encryption\Encrypter;
use Jexactyl\Repositories\Eloquent\NodeRepository;
use Jexactyl\Repositories\Wings\DaemonConfigurationRepository;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;
use Jexactyl\Exceptions\Service\Node\ConfigurationNotPersistedException;

class NodeUpdateService
{
    /**
     * NodeUpdateService constructor.
     */
    public function __construct(
        private ConnectionInterface $connection,
        private DaemonConfigurationRepository $configurationRepository,
        private Encrypter $encrypter,
        private NodeRepository $repository
    ) {
    }

    /**
     * Update the configuration values for a given node on the machine.
     *
     * @throws \Throwable
     */
    public function handle(Node $node, array $data, bool $resetToken = false): Node
    {
        if ($resetToken) {
            $data['daemon_token'] = $this->encrypter->encrypt(Str::random(Node::DAEMON_TOKEN_LENGTH));
            $data['daemon_token_id'] = Str::random(Node::DAEMON_TOKEN_ID_LENGTH);
        }

        [$updated, $exception] = $this->connection->transaction(function () use ($data, $node) {
            /** @var \Jexactyl\Models\Node $updated */
            $updated = $this->repository->withFreshModel()->update($node->id, $data, true, true);

            try {
                // If we're changing the FQDN for the node, use the newly provided FQDN for the connection
                // address. This should alleviate issues where the node gets pointed to a "valid" FQDN that
                // isn't actually running the daemon software, and therefore you can't actually change it
                // back.
                //
                // This makes more sense anyways, because only the Panel uses the FQDN for connecting, the
                // node doesn't actually care about this.
                //
                // @see https://github.com/pterodactyl/panel/issues/1931
                $node->fqdn = $updated->fqdn;

                $this->configurationRepository->setNode($node)->update($updated);
            } catch (DaemonConnectionException $exception) {
                Log::warning($exception, ['node_id' => $node->id]);

                // Never actually throw these exceptions up the stack. If we were able to change the settings
                // but something went wrong with Wings we just want to store the update and let the user manually
                // make changes as needed.
                //
                // This avoids issues with proxies such as Cloudflare which will see Wings as offline and then
                // inject their own response pages, causing this logic to get fucked up.
                //
                // @see https://github.com/pterodactyl/panel/issues/2712
                return [$updated, true];
            }

            return [$updated, false];
        });

        if ($exception) {
            throw new ConfigurationNotPersistedException(trans('exceptions.node.daemon_off_config_updated'));
        }

        return $updated;
    }
}
</file>

<file path="app/Services/Referrals/UseReferralService.php">
<?php

namespace Jexactyl\Services\Referrals;

use Jexactyl\Models\User;
use Jexactyl\Models\ReferralCode;
use Jexactyl\Models\ReferralUses;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;

class UseReferralService
{
    public function __construct(private SettingsRepositoryInterface $settings)
    {
    }

    /**
     * Process to handle a user using a referral code on
     * their account.
     *
     * @throws DisplayException
     */
    public function handle(ClientApiRequest $request): void
    {
        $user = $request->user();
        $code = $request->input('code');
        $reward = $this->settings->get('jexactyl::referrals:reward', 0);

        $id = ReferralCode::where('code', $code)->first()->user_id;
        $referrer = User::where('id', $id)->first();

        if ($id == $user->id) {
            throw new DisplayException('You can\'t use your own referral code.');
        }

        $user->update([
            'referral_code' => $code,
            'store_balance' => $request->user()->store_balance + $reward,
        ]);

        $referrer->update(['store_balance' => $referrer->store_balance + $reward]);

        ReferralUses::create([
            'user_id' => $user->id,
            'code_used' => $code,
            'referrer_id' => $id,
        ]);
    }
}
</file>

<file path="app/Services/Schedules/ProcessScheduleService.php">
<?php

namespace Jexactyl\Services\Schedules;

use Exception;
use Jexactyl\Models\Schedule;
use Jexactyl\Jobs\Schedule\RunTaskJob;
use Illuminate\Contracts\Bus\Dispatcher;
use Jexactyl\Exceptions\DisplayException;
use Illuminate\Database\ConnectionInterface;
use Jexactyl\Repositories\Wings\DaemonServerRepository;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;

class ProcessScheduleService
{
    /**
     * ProcessScheduleService constructor.
     */
    public function __construct(private ConnectionInterface $connection, private Dispatcher $dispatcher, private DaemonServerRepository $serverRepository)
    {
    }

    /**
     * Process a schedule and push the first task onto the queue worker.
     *
     * @throws \Throwable
     */
    public function handle(Schedule $schedule, bool $now = false): void
    {
        /** @var \Jexactyl\Models\Task $task */
        $task = $schedule->tasks()->orderBy('sequence_id')->first();

        if (is_null($task)) {
            throw new DisplayException('Cannot process schedule for task execution: no tasks are registered.');
        }

        $this->connection->transaction(function () use ($schedule, $task) {
            $schedule->forceFill([
                'is_processing' => true,
                'next_run_at' => $schedule->getNextRunDate(),
            ])->saveOrFail();

            $task->update(['is_queued' => true]);
        });

        $job = new RunTaskJob($task, $now);
        if ($schedule->only_when_online) {
            // Check that the server is currently in a starting or running state before executing
            // this schedule if this option has been set.
            try {
                $details = $this->serverRepository->setServer($schedule->server)->getDetails();
                $state = $details['state'] ?? 'offline';
                // If the server is stopping or offline just do nothing with this task.
                if (in_array($state, ['offline', 'stopping'])) {
                    $job->failed();

                    return;
                }
            } catch (\Exception $exception) {
                if (!$exception instanceof DaemonConnectionException) {
                    // If we encountered some exception during this process that wasn't just an
                    // issue connecting to Wings run the failed sequence for a job. Otherwise we
                    // can just quietly mark the task as completed without actually running anything.
                    $job->failed($exception);
                }
                $job->failed();

                return;
            }
        }

        if (!$now) {
            $this->dispatcher->dispatch($job->delay($task->time_offset));
        } else {
            // When using dispatchNow the RunTaskJob::failed() function is not called automatically
            // so we need to manually trigger it and then continue with the exception throw.
            //
            // @see https://github.com/pterodactyl/panel/issues/2550
            try {
                $this->dispatcher->dispatchNow($job);
            } catch (\Exception $exception) {
                $job->failed($exception);

                throw $exception;
            }
        }
    }
}
</file>

<file path="app/Services/Servers/BuildModificationService.php">
<?php

namespace Jexactyl\Services\Servers;

use Illuminate\Support\Arr;
use Jexactyl\Models\Server;
use Jexactyl\Models\Allocation;
use Illuminate\Support\Facades\Log;
use Jexactyl\Exceptions\DisplayException;
use Illuminate\Database\ConnectionInterface;
use Jexactyl\Repositories\Wings\DaemonServerRepository;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;

class BuildModificationService
{
    /**
     * BuildModificationService constructor.
     */
    public function __construct(
        private ConnectionInterface $connection,
        private DaemonServerRepository $daemonServerRepository,
        private ServerConfigurationStructureService $structureService
    ) {
    }

    /**
     * Change the build details for a specified server.
     *
     * @throws \Throwable
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    public function handle(Server $server, array $data): Server
    {
        /** @var \Jexactyl\Models\Server $server */
        $server = $this->connection->transaction(function () use ($server, $data) {
            $this->processAllocations($server, $data);

            if (isset($data['allocation_id']) && $data['allocation_id'] != $server->allocation_id) {
                try {
                    Allocation::query()->where('id', $data['allocation_id'])->where('server_id', $server->id)->firstOrFail();
                } catch (ModelNotFoundException) {
                    throw new DisplayException('The requested default allocation is not currently assigned to this server.');
                }
            }

            // If any of these values are passed through in the data array go ahead and set
            // them correctly on the server model.
            $merge = Arr::only($data, ['oom_disabled', 'memory', 'swap', 'io', 'cpu', 'threads', 'disk', 'allocation_id']);

            $server->forceFill(array_merge($merge, [
                'database_limit' => Arr::get($data, 'database_limit', 0) ?? null,
                'allocation_limit' => Arr::get($data, 'allocation_limit', 0) ?? null,
                'backup_limit' => Arr::get($data, 'backup_limit', 0) ?? 0,
            ]))->saveOrFail();

            return $server->refresh();
        });

        $updateData = $this->structureService->handle($server);

        // Because Wings always fetches an updated configuration from the Panel when booting
        // a server this type of exception can be safely "ignored" and just written to the logs.
        // Ideally this request succeeds, so we can apply resource modifications on the fly, but
        // if it fails we can just continue on as normal.
        if (!empty($updateData['build'])) {
            try {
                $this->daemonServerRepository->setServer($server)->sync();
            } catch (DaemonConnectionException $exception) {
                Log::warning($exception, ['server_id' => $server->id]);
            }
        }

        return $server;
    }

    /**
     * Process the allocations being assigned in the data and ensure they are available for a server.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    private function processAllocations(Server $server, array &$data): void
    {
        if (empty($data['add_allocations']) && empty($data['remove_allocations'])) {
            return;
        }

        // Handle the addition of allocations to this server. Only assign allocations that are not currently
        // assigned to a different server, and only allocations on the same node as the server.
        if (!empty($data['add_allocations'])) {
            $query = Allocation::query()
                ->where('node_id', $server->node_id)
                ->whereIn('id', $data['add_allocations'])
                ->whereNull('server_id');

            // Keep track of all the allocations we're just now adding so that we can use the first
            // one to reset the default allocation to.
            $freshlyAllocated = $query->pluck('id')->first();

            $query->update(['server_id' => $server->id, 'notes' => null]);
        }

        if (!empty($data['remove_allocations'])) {
            foreach ($data['remove_allocations'] as $allocation) {
                // If we are attempting to remove the default allocation for the server, see if we can reassign
                // to the first provided value in add_allocations. If there is no new first allocation then we
                // will throw an exception back.
                if ($allocation === ($data['allocation_id'] ?? $server->allocation_id)) {
                    if (empty($freshlyAllocated)) {
                        throw new DisplayException('You are attempting to delete the default allocation for this server but there is no fallback allocation to use.');
                    }

                    // Update the default allocation to be the first allocation that we are creating.
                    $data['allocation_id'] = $freshlyAllocated;
                }
            }

            // Remove any of the allocations we got that are currently assigned to this server on
            // this node. Also set the notes to null, otherwise when re-allocated to a new server those
            // notes will be carried over.
            Allocation::query()->where('node_id', $server->node_id)
                ->where('server_id', $server->id)
                // Only remove the allocations that we didn't also attempt to add to the server...
                ->whereIn('id', array_diff($data['remove_allocations'], $data['add_allocations'] ?? []))
                ->update([
                    'notes' => null,
                    'server_id' => null,
                ]);
        }
    }
}
</file>

<file path="app/Services/Servers/DetailsModificationService.php">
<?php

namespace Jexactyl\Services\Servers;

use Illuminate\Support\Arr;
use Jexactyl\Models\Server;
use Illuminate\Database\ConnectionInterface;
use Jexactyl\Traits\Services\ReturnsUpdatedModels;
use Jexactyl\Repositories\Wings\DaemonServerRepository;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;

class DetailsModificationService
{
    use ReturnsUpdatedModels;

    /**
     * DetailsModificationService constructor.
     */
    public function __construct(private ConnectionInterface $connection, private DaemonServerRepository $serverRepository)
    {
    }

    /**
     * Update the details for a single server instance.
     *
     * @throws \Throwable
     */
    public function handle(Server $server, array $data): Server
    {
        return $this->connection->transaction(function () use ($data, $server) {
            $owner = $server->owner_id;

            $server->forceFill([
                'external_id' => Arr::get($data, 'external_id'),
                'owner_id' => Arr::get($data, 'owner_id'),
                'name' => Arr::get($data, 'name'),
                'description' => Arr::get($data, 'description') ?? '',
                'renewable' => Arr::get($data, 'renewable') ?? false,
                'renewal' => Arr::get($data, 'renewal') ?? 0,
            ])->saveOrFail();

            // If the owner_id value is changed we need to revoke any tokens that exist for the server
            // on the Wings instance so that the old owner no longer has any permission to access the
            // websockets.
            if ($server->owner_id !== $owner) {
                try {
                    $this->serverRepository->setServer($server)->revokeUserJTI($owner);
                } catch (DaemonConnectionException $exception) {
                    // Do nothing. A failure here is not ideal, but it is likely to be caused by Wings
                    // being offline, or in an entirely broken state. Remember, these tokens reset every
                    // few minutes by default, we're just trying to help it along a little quicker.
                }
            }

            return $server;
        });
    }
}
</file>

<file path="app/Services/Servers/EnvironmentService.php">
<?php

namespace Jexactyl\Services\Servers;

use Jexactyl\Models\Server;
use Jexactyl\Models\EggVariable;

class EnvironmentService
{
    private array $additional = [];

    /**
     * Dynamically configure additional environment variables to be assigned
     * with a specific server.
     */
    public function setEnvironmentKey(string $key, callable $closure): void
    {
        $this->additional[$key] = $closure;
    }

    /**
     * Return the dynamically added additional keys.
     */
    public function getEnvironmentKeys(): array
    {
        return $this->additional;
    }

    /**
     * Take all of the environment variables configured for this server and return
     * them in an easy to process format.
     */
    public function handle(Server $server): array
    {
        $variables = $server->variables->toBase()->mapWithKeys(function (EggVariable $variable) {
            return [$variable->env_variable => $variable->server_value ?? $variable->default_value];
        });

        // Process environment variables defined in this file. This is done first
        // in order to allow run-time and config defined variables to take
        // priority over built-in values.
        foreach ($this->getEnvironmentMappings() as $key => $object) {
            $variables->put($key, object_get($server, $object));
        }

        // Process variables set in the configuration file.
        foreach (config('jexactyl.environment_variables', []) as $key => $object) {
            $variables->put(
                $key,
                is_callable($object) ? call_user_func($object, $server) : object_get($server, $object)
            );
        }

        // Process dynamically included environment variables.
        foreach ($this->additional as $key => $closure) {
            $variables->put($key, call_user_func($closure, $server));
        }

        return $variables->toArray();
    }

    /**
     * Return a mapping of Panel default environment variables.
     */
    private function getEnvironmentMappings(): array
    {
        return [
            'STARTUP' => 'startup',
            'P_SERVER_LOCATION' => 'location.short',
            'P_SERVER_UUID' => 'uuid',
        ];
    }
}
</file>

<file path="app/Services/Servers/GetUserPermissionsService.php">
<?php

namespace Jexactyl\Services\Servers;

use Jexactyl\Models\User;
use Jexactyl\Models\Server;

class GetUserPermissionsService
{
    /**
     * Returns the server specific permissions that a user has. This checks
     * if they are an admin or a subuser for the server. If no permissions are
     * found, an empty array is returned.
     */
    public function handle(Server $server, User $user): array
    {
        if ($user->root_admin || $user->id === $server->owner_id) {
            $permissions = ['*'];

            if ($user->root_admin) {
                $permissions[] = 'admin.websocket.errors';
                $permissions[] = 'admin.websocket.install';
                $permissions[] = 'admin.websocket.transfer';
            }

            return $permissions;
        }

        /** @var \Jexactyl\Models\Subuser|null $subuserPermissions */
        $subuserPermissions = $server->subusers()->where('user_id', $user->id)->first();

        return $subuserPermissions ? $subuserPermissions->permissions : [];
    }
}
</file>

<file path="app/Services/Servers/ReinstallServerService.php">
<?php

namespace Jexactyl\Services\Servers;

use Jexactyl\Models\Server;
use Illuminate\Database\ConnectionInterface;
use Jexactyl\Repositories\Wings\DaemonServerRepository;

class ReinstallServerService
{
    /**
     * ReinstallService constructor.
     */
    public function __construct(
        private ConnectionInterface $connection,
        private DaemonServerRepository $daemonServerRepository
    ) {
    }

    /**
     * Reinstall a server on the remote daemon.
     *
     * @throws \Throwable
     */
    public function handle(Server $server): Server
    {
        return $this->connection->transaction(function () use ($server) {
            $server->fill(['status' => Server::STATUS_INSTALLING])->save();

            $this->daemonServerRepository->setServer($server)->reinstall();

            return $server->refresh();
        });
    }
}
</file>

<file path="app/Services/Servers/ServerConfigurationStructureService.php">
<?php

namespace Jexactyl\Services\Servers;

use Jexactyl\Models\Mount;
use Jexactyl\Models\Server;

class ServerConfigurationStructureService
{
    /**
     * ServerConfigurationStructureService constructor.
     */
    public function __construct(private EnvironmentService $environment)
    {
    }

    /**
     * Return a configuration array for a specific server when passed a server model.
     *
     * DO NOT MODIFY THIS FUNCTION. This powers legacy code handling for the new Wings
     * daemon, if you modify the structure eggs will break unexpectedly.
     */
    public function handle(Server $server, array $override = [], bool $legacy = false): array
    {
        $clone = $server;
        // If any overrides have been set on this call make sure to update them on the
        // cloned instance so that the configuration generated uses them.
        if (!empty($override)) {
            $clone = $server->fresh();
            foreach ($override as $key => $value) {
                $clone->setAttribute($key, $value);
            }
        }

        return $legacy
            ? $this->returnLegacyFormat($clone)
            : $this->returnCurrentFormat($clone);
    }

    /**
     * Returns the new data format used for the Wings daemon.
     */
    protected function returnCurrentFormat(Server $server): array
    {
        return [
            'uuid' => $server->uuid,
            'meta' => [
                'name' => $server->name,
                'description' => $server->description,
            ],
            'suspended' => $server->isSuspended(),
            'environment' => $this->environment->handle($server),
            'invocation' => $server->startup,
            'skip_egg_scripts' => $server->skip_scripts,
            'build' => [
                'memory_limit' => $server->memory,
                'swap' => $server->swap,
                'io_weight' => $server->io,
                'cpu_limit' => $server->cpu,
                'threads' => $server->threads,
                'disk_space' => $server->disk,
                'oom_disabled' => $server->oom_disabled,
            ],
            'container' => [
                'image' => $server->image,
                // This field is deprecated  use the value in the "build" block.
                //
                // TODO: remove this key in V2.
                'oom_disabled' => $server->oom_disabled,
                'requires_rebuild' => false,
            ],
            'allocations' => [
                'force_outgoing_ip' => $server->egg->force_outgoing_ip,
                'default' => [
                    'ip' => $server->allocation->ip,
                    'port' => $server->allocation->port,
                ],
                'mappings' => $server->getAllocationMappings(),
            ],
            'mounts' => $server->mounts->map(function (Mount $mount) {
                return [
                    'source' => $mount->source,
                    'target' => $mount->target,
                    'read_only' => $mount->read_only,
                ];
            }),
            'egg' => [
                'id' => $server->egg->uuid,
                'file_denylist' => $server->egg->inherit_file_denylist,
            ],
        ];
    }

    /**
     * Returns the legacy server data format to continue support for old egg configurations
     * that have not yet been updated.
     *
     * @deprecated
     */
    protected function returnLegacyFormat(Server $server): array
    {
        return [
            'uuid' => $server->uuid,
            'build' => [
                'default' => [
                    'ip' => $server->allocation->ip,
                    'port' => $server->allocation->port,
                ],
                'ports' => $server->allocations->groupBy('ip')->map(function ($item) {
                    return $item->pluck('port');
                })->toArray(),
                'env' => $this->environment->handle($server),
                'oom_disabled' => $server->oom_disabled,
                'memory' => (int) $server->memory,
                'swap' => (int) $server->swap,
                'io' => (int) $server->io,
                'cpu' => (int) $server->cpu,
                'threads' => $server->threads,
                'disk' => (int) $server->disk,
                'image' => $server->image,
            ],
            'service' => [
                'egg' => $server->egg->uuid,
                'skip_scripts' => $server->skip_scripts,
            ],
            'rebuild' => false,
            'suspended' => $server->isSuspended() ? 1 : 0,
        ];
    }
}
</file>

<file path="app/Services/Servers/ServerCreationService.php">
<?php

namespace Jexactyl\Services\Servers;

use Ramsey\Uuid\Uuid;
use Jexactyl\Models\Egg;
use Jexactyl\Models\User;
use Illuminate\Support\Arr;
use Jexactyl\Models\Server;
use Webmozart\Assert\Assert;
use Jexactyl\Models\Allocation;
use Illuminate\Support\Collection;
use Illuminate\Database\ConnectionInterface;
use Jexactyl\Models\Objects\DeploymentObject;
use Jexactyl\Repositories\Eloquent\ServerRepository;
use Jexactyl\Repositories\Wings\DaemonServerRepository;
use Jexactyl\Services\Deployment\FindViableNodesService;
use Jexactyl\Repositories\Eloquent\ServerVariableRepository;
use Jexactyl\Services\Deployment\AllocationSelectionService;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;

class ServerCreationService
{
    /**
     * ServerCreationService constructor.
     */
    public function __construct(
        private AllocationSelectionService $allocationSelectionService,
        private ConnectionInterface $connection,
        private DaemonServerRepository $daemonServerRepository,
        private FindViableNodesService $findViableNodesService,
        private ServerRepository $repository,
        private ServerDeletionService $serverDeletionService,
        private ServerVariableRepository $serverVariableRepository,
        private VariableValidatorService $validatorService
    ) {
    }

    /**
     * Create a server on the Panel and trigger a request to the Daemon to begin the server
     * creation process. This function will attempt to set as many additional values
     * as possible given the input data. For example, if an allocation_id is passed with
     * no node_id the node_is will be picked from the allocation.
     *
     * @throws \Throwable
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Illuminate\Validation\ValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     * @throws \Jexactyl\Exceptions\Service\Deployment\NoViableNodeException
     * @throws \Jexactyl\Exceptions\Service\Deployment\NoViableAllocationException
     */
    public function handle(array $data, DeploymentObject $deployment = null): Server
    {
        // If a deployment object has been passed we need to get the allocation
        // that the server should use, and assign the node from that allocation.
        if ($deployment instanceof DeploymentObject) {
            $allocation = $this->configureDeployment($data, $deployment);
            $data['allocation_id'] = $allocation->id;
            $data['node_id'] = $allocation->node_id;
        }

        // Auto-configure the node based on the selected allocation
        // if no node was defined.
        if (empty($data['node_id'])) {
            Assert::false(empty($data['allocation_id']), 'Expected a non-empty allocation_id in server creation data.');

            $data['node_id'] = Allocation::query()->findOrFail($data['allocation_id'])->node_id;
        }

        if (empty($data['nest_id'])) {
            Assert::false(empty($data['egg_id']), 'Expected a non-empty egg_id in server creation data.');

            $data['nest_id'] = Egg::query()->findOrFail($data['egg_id'])->nest_id;
        }

        $eggVariableData = $this->validatorService
            ->setUserLevel(User::USER_LEVEL_ADMIN)
            ->handle(Arr::get($data, 'egg_id'), Arr::get($data, 'environment', []));

        // Due to the design of the Daemon, we need to persist this server to the disk
        // before we can actually create it on the Daemon.
        //
        // If that connection fails out we will attempt to perform a cleanup by just
        // deleting the server itself from the system.
        /** @var \Jexactyl\Models\Server $server */
        $server = $this->connection->transaction(function () use ($data, $eggVariableData) {
            // Create the server and assign any additional allocations to it.
            $server = $this->createModel($data);

            $this->storeAssignedAllocations($server, $data);
            $this->storeEggVariables($server, $eggVariableData);

            return $server;
        }, 5);

        try {
            $this->daemonServerRepository->setServer($server)->create(
                Arr::get($data, 'start_on_completion', false) ?? false
            );
        } catch (DaemonConnectionException $exception) {
            $this->serverDeletionService->withForce()->handle($server);

            throw $exception;
        }

        return $server;
    }

    /**
     * Gets an allocation to use for automatic deployment.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     * @throws \Jexactyl\Exceptions\Service\Deployment\NoViableAllocationException
     * @throws \Jexactyl\Exceptions\Service\Deployment\NoViableNodeException
     */
    private function configureDeployment(array $data, DeploymentObject $deployment): Allocation
    {
        /** @var \Illuminate\Support\Collection $nodes */
        $nodes = $this->findViableNodesService->setLocations($deployment->getLocations())
            ->setDisk(Arr::get($data, 'disk'))
            ->setMemory(Arr::get($data, 'memory'))
            ->handle();

        return $this->allocationSelectionService->setDedicated($deployment->isDedicated())
            ->setNodes($nodes->pluck('id')->toArray())
            ->setPorts($deployment->getPorts())
            ->handle();
    }

    /**
     * Store the server in the database and return the model.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    private function createModel(array $data): Server
    {
        $uuid = $this->generateUniqueUuidCombo();

        /** @var \Jexactyl\Models\Server $model */
        $model = $this->repository->create([
            'external_id' => Arr::get($data, 'external_id'),
            'uuid' => $uuid,
            'uuidShort' => substr($uuid, 0, 8),
            'node_id' => Arr::get($data, 'node_id'),
            'name' => Arr::get($data, 'name'),
            'description' => Arr::get($data, 'description') ?? '',
            'status' => Server::STATUS_INSTALLING,
            'skip_scripts' => Arr::get($data, 'skip_scripts') ?? isset($data['skip_scripts']),
            'owner_id' => Arr::get($data, 'owner_id'),
            'memory' => Arr::get($data, 'memory'),
            'swap' => Arr::get($data, 'swap'),
            'disk' => Arr::get($data, 'disk'),
            'io' => Arr::get($data, 'io'),
            'cpu' => Arr::get($data, 'cpu'),
            'threads' => Arr::get($data, 'threads'),
            'oom_disabled' => Arr::get($data, 'oom_disabled') ?? true,
            'allocation_id' => Arr::get($data, 'allocation_id'),
            'nest_id' => Arr::get($data, 'nest_id'),
            'egg_id' => Arr::get($data, 'egg_id'),
            'startup' => Arr::get($data, 'startup'),
            'image' => Arr::get($data, 'image'),
            'database_limit' => Arr::get($data, 'database_limit') ?? 0,
            'allocation_limit' => Arr::get($data, 'allocation_limit') ?? 0,
            'backup_limit' => Arr::get($data, 'backup_limit') ?? 0,
            'renewable' => Arr::get($data, 'renewable') ?? false,
            'renewal' => Arr::get($data, 'renewal') ?? 0,
        ]);

        return $model;
    }

    /**
     * Configure the allocations assigned to this server.
     */
    private function storeAssignedAllocations(Server $server, array $data): void
    {
        $records = [$data['allocation_id']];
        if (isset($data['allocation_additional']) && is_array($data['allocation_additional'])) {
            $records = array_merge($records, $data['allocation_additional']);
        }

        Allocation::query()->whereIn('id', $records)->update([
            'server_id' => $server->id,
        ]);
    }

    /**
     * Process environment variables passed for this server and store them in the database.
     */
    private function storeEggVariables(Server $server, Collection $variables): void
    {
        $records = $variables->map(function ($result) use ($server) {
            return [
                'server_id' => $server->id,
                'variable_id' => $result->id,
                'variable_value' => $result->value ?? '',
            ];
        })->toArray();

        if (!empty($records)) {
            $this->serverVariableRepository->insert($records);
        }
    }

    /**
     * Create a unique UUID and UUID-Short combo for a server.
     */
    private function generateUniqueUuidCombo(): string
    {
        $uuid = Uuid::uuid4()->toString();

        if (!$this->repository->isUniqueUuidCombo($uuid, substr($uuid, 0, 8))) {
            return $this->generateUniqueUuidCombo();
        }

        return $uuid;
    }
}
</file>

<file path="app/Services/Servers/ServerDeletionService.php">
<?php

namespace Jexactyl\Services\Servers;

use Jexactyl\Models\User;
use Jexactyl\Models\Server;
use Illuminate\Http\Response;
use Illuminate\Support\Facades\Log;
use Illuminate\Database\ConnectionInterface;
use Jexactyl\Repositories\Wings\DaemonServerRepository;
use Jexactyl\Services\Databases\DatabaseManagementService;
use Jexactyl\Exceptions\Http\Connection\DaemonConnectionException;

class ServerDeletionService
{
    protected bool $force = false;
    protected bool $return_resources = false;

    /**
     * ServerDeletionService constructor.
     */
    public function __construct(
        private ConnectionInterface $connection,
        private DaemonServerRepository $daemonServerRepository,
        private DatabaseManagementService $databaseManagementService
    ) {
    }

    /**
     * Set if the server should be forcibly deleted from the panel (ignoring daemon errors) or not.
     */
    public function withForce(bool $bool = true): self
    {
        $this->force = $bool;

        return $this;
    }

    /**
     * Set if the server's owner should recieve the resources upon server deletion.
     *
     * @return $this
     */
    public function returnResources(bool $bool = true): self
    {
        $this->return_resources = $bool;

        return $this;
    }

    /**
     * Delete a server from the panel and remove any associated databases from hosts.
     *
     * @throws \Throwable
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    public function handle(Server $server): void
    {
        try {
            $this->daemonServerRepository->setServer($server)->delete();
        } catch (DaemonConnectionException $exception) {
            // If there is an error not caused a 404 error and this isn't a forced delete,
            // go ahead and bail out. We specifically ignore a 404 since that can be assumed
            // to be a safe error, meaning the server doesn't exist at all on Wings so there
            // is no reason we need to bail out from that.
            if (!$this->force && $exception->getStatusCode() !== Response::HTTP_NOT_FOUND) {
                throw $exception;
            }

            Log::warning($exception);
        }

        $this->connection->transaction(function () use ($server) {
            foreach ($server->databases as $database) {
                try {
                    $this->databaseManagementService->delete($database);
                } catch (\Exception $exception) {
                    if (!$this->force) {
                        throw $exception;
                    }

                    // Oh well, just try to delete the database entry we have from the database
                    // so that the server itself can be deleted. This will leave it dangling on
                    // the host instance, but we couldn't delete it anyways so not sure how we would
                    // handle this better anyways.
                    //
                    // @see https://github.com/pterodactyl/panel/issues/2085
                    $database->delete();

                    Log::warning($exception);
                }
            }

            $server->delete();
        });

        if (!$this->return_resources) {
            return;
        }

        try {
            $user = User::findOrFail($server->owner_id);
        } catch (\Exception $exception) {
            throw $exception;
        }

        $user->update([
            'store_cpu' => $user->store_cpu + $server->cpu,
            'store_memory' => $user->store_memory + $server->memory,
            'store_disk' => $user->store_disk + $server->disk,
            'store_slots' => $user->store_slots + 1, // Always one slot.
            'store_ports' => $user->store_ports + $server->allocation_limit,
            'store_backups' => $user->store_backups + $server->backup_limit,
            'store_databases' => $user->store_databases + $server->database_limit,
        ]);
    }
}
</file>

<file path="app/Services/Servers/ServerEditService.php">
<?php

namespace Jexactyl\Services\Servers;

use Jexactyl\Models\User;
use Jexactyl\Models\Server;
use Illuminate\Http\Response;
use Illuminate\Http\JsonResponse;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;
use Jexactyl\Http\Requests\Api\Client\Servers\EditServerRequest;

class ServerEditService
{
    public function __construct(private SettingsRepositoryInterface $settings)
    {
    }

    /**
     * Updates the requested instance with new limits.
     *
     * @throws DisplayException
     */
    public function handle(EditServerRequest $request, Server $server)
    {
        $user = $request->user();
        $amount = $request->input('amount');
        $resource = $request->input('resource');

        if ($user->id != $server->owner_id) {
            throw new DisplayException('You do not own this server, therefore you cannot make changes.');
        }

        $this->verify($request, $server, $user);

        $server->update([$resource => $this->toServer($resource, $server) + $amount]);
        $user->update(['store_' . $resource => $this->toUser($resource, $user) - $amount]);

        return new JsonResponse([], Response::HTTP_NO_CONTENT);
    }

    /**
     * Ensure that the server is not going past the limits
     * for minimum resources per-container.
     *
     * @throws DisplayException
     */
    protected function verify(EditServerRequest $request, Server $server, User $user)
    {
        $amount = $request->input('amount');
        $resource = $request->input('resource');
        $limit = $this->settings->get('jexactyl::store:limit:' . $resource);

        // Check if the amount requested goes over defined limits.
        if (($amount + $this->toServer($resource, $server)) > $limit) {
            throw new DisplayException('You cannot add this resource because an administrator has set a maximum limit.');
        }

        // Prevent resource from going below minimum
        if (($this->toServer($resource, $server) + $amount) < $this->toMin($resource)) {
            throw new DisplayException('You cannot go below the minimum amount of ' . $this->toMin($resource) . '.');
        }

        // Verify that the user has the resource in their account.
        if ($this->toUser($resource, $user) < $amount) {
            throw new DisplayException('You do not have the resources available to make this change.');
        }
    }

     /**
      * Gets the minimum value for a specific resource.
      *
      * @throws DisplayException
      */
     protected function toMin(string $resource): int
     {
         return match ($resource) {
             'cpu' => 50,
             'allocation_limit' => 1,
             'disk', 'memory' => 1024,
             'backup_limit', 'database_limit' => 0,
             default => throw new DisplayException('Unable to parse resource type')
         };
     }

     /**
      * Get the requested resource type and transform it
      * so it can be used in a database statement.
      *
      * @throws DisplayException
      */
     protected function toUser(string $resource, User $user): int
     {
         return match ($resource) {
             'cpu' => $user->store_cpu,
             'disk' => $user->store_disk,
             'memory' => $user->store_memory,
             'backup_limit' => $user->store_backups,
             'allocation_limit' => $user->store_ports,
             'database_limit' => $user->store_databases,
             default => throw new DisplayException('Unable to parse resource type')
         };
     }

    /**
     * Get the requested resource type and transform it
     * so it can be used in a database statement.
     *
     * @throws DisplayException
     */
    protected function toServer(string $resource, Server $server): int
    {
        return match ($resource) {
            'cpu' => $server->cpu,
            'disk' => $server->disk,
            'memory' => $server->memory,
            'backup_limit' => $server->backup_limit,
            'database_limit' => $server->database_limit,
            'allocation_limit' => $server->allocation_limit,
            default => throw new DisplayException('Unable to parse resource type')
        };
    }
}
</file>

<file path="app/Services/Servers/ServerRenewalService.php">
<?php

namespace Jexactyl\Services\Servers;

use Jexactyl\Models\Server;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Http\Requests\Api\Client\ClientApiRequest;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;

class ServerRenewalService
{
    private SuspensionService $suspensionService;
    private SettingsRepositoryInterface $settings;

    /**
     * ServerRenewalService constructor.
     */
    public function __construct(
        SuspensionService $suspensionService,
        SettingsRepositoryInterface $settings
    ) {
        $this->settings = $settings;
        $this->suspensionService = $suspensionService;
    }

    /**
     * Renews a server.
     *
     * @throws DisplayException
     */
    public function handle(ClientApiRequest $request, Server $server): Server
    {
        $user = $request->user();
        $cost = $this->settings->get('jexactyl::renewal:cost', 200);

        if ($user->store_balance < $cost) {
            throw new DisplayException('You do not have enough credits to renew your server.');
        }

        try {
            $user->update(['store_balance' => $user->store_balance - $cost]);
            $server->update(['renewal' => $server->renewal + $this->settings->get('jexactyl::renewal:default', 7)]);
        } catch (DisplayException $ex) {
            throw new DisplayException('An unexpected error occured while trying to renew your server.');
        }

        if ($server->status == 'suspended' && $server->renewal >= 0) {
            $this->suspensionService->toggle($server, 'unsuspend');
        }

        return $server->refresh();
    }
}
</file>

<file path="app/Services/Servers/StartupCommandService.php">
<?php

namespace Jexactyl\Services\Servers;

use Jexactyl\Models\Server;

class StartupCommandService
{
    /**
     * Generates a startup command for a given server instance.
     */
    public function handle(Server $server, bool $hideAllValues = false): string
    {
        $find = ['{{SERVER_MEMORY}}', '{{SERVER_IP}}', '{{SERVER_PORT}}'];
        $replace = [$server->memory, $server->allocation->ip, $server->allocation->port];

        foreach ($server->variables as $variable) {
            $find[] = '{{' . $variable->env_variable . '}}';
            $replace[] = ($variable->user_viewable && !$hideAllValues) ? ($variable->server_value ?? $variable->default_value) : '[hidden]';
        }

        return str_replace($find, $replace, $server->startup);
    }
}
</file>

<file path="app/Services/Servers/StartupModificationService.php">
<?php

namespace Jexactyl\Services\Servers;

use Jexactyl\Models\Egg;
use Jexactyl\Models\User;
use Illuminate\Support\Arr;
use Jexactyl\Models\Server;
use Jexactyl\Models\ServerVariable;
use Jexactyl\Traits\Services\HasUserLevels;
use Illuminate\Database\ConnectionInterface;

class StartupModificationService
{
    use HasUserLevels;

    /**
     * StartupModificationService constructor.
     */
    public function __construct(private ConnectionInterface $connection, private VariableValidatorService $validatorService)
    {
    }

    /**
     * Process startup modification for a server.
     *
     * @throws \Throwable
     */
    public function handle(Server $server, array $data): Server
    {
        return $this->connection->transaction(function () use ($server, $data) {
            if (!empty($data['environment'])) {
                $egg = $this->isUserLevel(User::USER_LEVEL_ADMIN) ? ($data['egg_id'] ?? $server->egg_id) : $server->egg_id;

                $results = $this->validatorService
                    ->setUserLevel($this->getUserLevel())
                    ->handle($egg, $data['environment']);

                foreach ($results as $result) {
                    ServerVariable::query()->updateOrCreate(
                        [
                            'server_id' => $server->id,
                            'variable_id' => $result->id,
                        ],
                        ['variable_value' => $result->value ?? '']
                    );
                }
            }

            if ($this->isUserLevel(User::USER_LEVEL_ADMIN)) {
                $this->updateAdministrativeSettings($data, $server);
            }

            // Calling ->refresh() rather than ->fresh() here causes it to return the
            // variables as triplicates for some reason? Not entirely sure, should dig
            // in more to figure it out, but luckily we have a test case covering this
            // specific call so we can be assured we're not breaking it _here_ at least.
            //
            // TODO(dane): this seems like a red-flag for the code powering the relationship
            //  that should be looked into more.
            return $server->fresh();
        });
    }

    /**
     * Update certain administrative settings for a server in the DB.
     */
    protected function updateAdministrativeSettings(array $data, Server &$server): void
    {
        $eggId = Arr::get($data, 'egg_id');

        if (is_digit($eggId) && $server->egg_id !== (int) $eggId) {
            /** @var \Jexactyl\Models\Egg $egg */
            $egg = Egg::query()->findOrFail($data['egg_id']);

            $server = $server->forceFill([
                'egg_id' => $egg->id,
                'nest_id' => $egg->nest_id,
            ]);
        }

        $server->fill([
            'startup' => $data['startup'] ?? $server->startup,
            'skip_scripts' => $data['skip_scripts'] ?? isset($data['skip_scripts']),
            'image' => $data['docker_image'] ?? $server->image,
        ])->save();
    }
}
</file>

<file path="app/Services/Servers/SuspensionService.php">
<?php

namespace Jexactyl\Services\Servers;

use Jexactyl\Models\Server;
use Webmozart\Assert\Assert;
use Jexactyl\Repositories\Wings\DaemonServerRepository;
use Symfony\Component\HttpKernel\Exception\ConflictHttpException;

class SuspensionService
{
    public const ACTION_SUSPEND = 'suspend';
    public const ACTION_UNSUSPEND = 'unsuspend';

    /**
     * SuspensionService constructor.
     */
    public function __construct(
        private DaemonServerRepository $daemonServerRepository
    ) {
    }

    /**
     * Suspends a server on the system.
     *
     * @throws \Throwable
     */
    public function toggle(Server $server, string $action = self::ACTION_SUSPEND): void
    {
        Assert::oneOf($action, [self::ACTION_SUSPEND, self::ACTION_UNSUSPEND]);

        $isSuspending = $action === self::ACTION_SUSPEND;
        // Nothing needs to happen if we're suspending the server, and it is already
        // suspended in the database. Additionally, nothing needs to happen if the server
        // is not suspended, and we try to un-suspend the instance.
        if ($isSuspending === $server->isSuspended()) {
            return;
        }

        // Check if the server is currently being transferred.
        if (!is_null($server->transfer)) {
            throw new ConflictHttpException('Cannot toggle suspension status on a server that is currently being transferred.');
        }

        // Update the server's suspension status.
        $server->update([
            'status' => $isSuspending ? Server::STATUS_SUSPENDED : null,
        ]);

        try {
            // Tell wings to re-sync the server state.
            $this->daemonServerRepository->setServer($server)->sync();
        } catch (\Exception $exception) {
            // Rollback the server's suspension status if wings fails to sync the server.
            $server->update([
                'status' => $isSuspending ? null : Server::STATUS_SUSPENDED,
            ]);
            throw $exception;
        }
    }
}
</file>

<file path="app/Services/Servers/VariableValidatorService.php">
<?php

namespace Jexactyl\Services\Servers;

use Jexactyl\Models\User;
use Jexactyl\Models\EggVariable;
use Illuminate\Support\Collection;
use Jexactyl\Traits\Services\HasUserLevels;
use Illuminate\Validation\ValidationException;
use Illuminate\Contracts\Validation\Factory as ValidationFactory;

class VariableValidatorService
{
    use HasUserLevels;

    /**
     * VariableValidatorService constructor.
     */
    public function __construct(private ValidationFactory $validator)
    {
    }

    /**
     * Validate all of the passed data against the given service option variables.
     *
     * @throws \Illuminate\Validation\ValidationException
     */
    public function handle(int $egg, array $fields = []): Collection
    {
        $query = EggVariable::query()->where('egg_id', $egg);
        if (!$this->isUserLevel(User::USER_LEVEL_ADMIN)) {
            // Don't attempt to validate variables if they aren't user editable,
            // and we're not running this at an admin level.
            $query = $query->where('user_editable', true)->where('user_viewable', true);
        }

        /** @var \Jexactyl\Models\EggVariable[] $variables */
        $variables = $query->get();

        $data = $rules = $customAttributes = [];
        foreach ($variables as $variable) {
            $data['environment'][$variable->env_variable] = array_get($fields, $variable->env_variable);
            $rules['environment.' . $variable->env_variable] = $variable->rules;
            $customAttributes['environment.' . $variable->env_variable] = trans('validation.internal.variable_value', ['env' => $variable->name]);
        }

        $validator = $this->validator->make($data, $rules, [], $customAttributes);
        if ($validator->fails()) {
            throw new ValidationException($validator);
        }

        return Collection::make($variables)->map(function ($item) use ($fields) {
            return (object) [
                'id' => $item->id,
                'key' => $item->env_variable,
                'value' => $fields[$item->env_variable] ?? null,
            ];
        });
    }
}
</file>

<file path="app/Services/Store/ResourcePurchaseService.php">
<?php

namespace Jexactyl\Services\Store;

use Illuminate\Support\Facades\DB;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;
use Jexactyl\Http\Requests\Api\Client\Store\PurchaseResourceRequest;

class ResourcePurchaseService
{
    /**
     * ResourcePurchaseService constructor.
     */
    public function __construct(private SettingsRepositoryInterface $settings)
    {
    }

    /**
     * This service processes the purchase of resources
     * via the Jexactyl Storefront.
     *
     * @throws DisplayException
     */
    public function handle(PurchaseResourceRequest $request)
    {
        $user = $request->user();
        $balance = $user->store_balance;
        $resource = $request->input('resource');
        $cost = $this->get($resource);
        $current = DB::table('users')
            ->where('id', $user->id)
            ->pluck('store_' . $resource)
            ->first();

        if ($balance < $cost) {
            throw new DisplayException('You do not have enough credits.');
        }

        $user->update([
            'store_balance' => $balance - $cost,
            'store_' . $resource => $current + $this->amount($resource),
        ]);
    }

    /**
     * Returns how much of the resource to assign.
     *
     * @throws DisplayException
     */
    protected function amount(string $resource): int
    {
        return match ($resource) {
            'cpu' => 50,
            'disk', 'memory' => 1024,
            'slots', 'ports', 'backups', 'databases' => 1,
            default => throw new DisplayException('Unable to parse resource type')
        };
    }

    /**
     * Shortcut method to get data from the database.
     */
    protected function get(string $resource): mixed
    {
        if (in_array($resource, ['slots', 'ports', 'backups', 'databases'])) {
            $resource = rtrim($resource, 's');
        }

        return $this->settings->get('jexactyl::store:cost:' . $resource);
    }
}
</file>

<file path="app/Services/Store/StoreCreationService.php">
<?php

namespace Jexactyl\Services\Store;

use Jexactyl\Models\Egg;
use Jexactyl\Models\Nest;
use Jexactyl\Models\Node;
use Jexactyl\Models\Server;
use Jexactyl\Models\Allocation;
use Jexactyl\Models\EggVariable;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Services\Servers\ServerCreationService;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;
use Jexactyl\Http\Requests\Api\Client\Store\CreateServerRequest;
use Jexactyl\Exceptions\Service\Deployment\NoViableAllocationException;

class StoreCreationService
{
    public function __construct(
        private SettingsRepositoryInterface $settings,
        private ServerCreationService $creationService,
        private StoreVerificationService $verifyService
    ) {
    }

    /**
     * Creates a server on Jexactyl using the Storefront.
     *
     * @throws DisplayException
     */
    public function handle(CreateServerRequest $request): Server
    {
        $egg = Egg::find($request->input('egg'));
        $nest = Nest::find($request->input('nest'))->id;
        $node = Node::find($request->input('node'))->id;

        $this->verifyService->handle($request);

        $data = [
            'name' => $request->input('name'),
            'description' => $request->input('description'),
            'owner_id' => $request->user()->id,
            'egg_id' => $egg->id,
            'nest_id' => $nest,
            'node_id' => $node,
            'allocation_id' => $this->getAllocation($node),
            'allocation_limit' => $request->input('ports'),
            'backup_limit' => $request->input('backups'),
            'database_limit' => $request->input('databases'),
            'environment' => [],
            'memory' => $request->input('memory'),
            'disk' => $request->input('disk'),
            'cpu' => $request->input('cpu'),
            'swap' => 0,
            'io' => 500,
            'image' => array_values($egg->docker_images)[0],
            'startup' => $egg->startup,
            'start_on_completion' => false,
            // Settings for the renewal system. Even if the renewal system is disabled,
            // mark this server as enabled - so that if the renewal system is enabled again,
            // it'll be part of the renewable servers.
            'renewable' => true,
            'renewal' => $this->settings->get('jexactyl::renewal:default'),
        ];

        foreach (EggVariable::where('egg_id', $egg->id)->get() as $var) {
            $key = "v1-{$egg->id}-{$var->env_variable}";
            $data['environment'][$var->env_variable] = $request->get($key, $var->default_value);
        }

        return $this->creationService->handle($data);
    }

    /**
     * Gets an allocation for server deployment.
     *
     * @throws NoViableAllocationException
     */
    protected function getAllocation(int $node): int
    {
        $allocation = Allocation::where('node_id', $node)->where('server_id', null)->first();

        if (!$allocation) {
            throw new NoViableAllocationException('No allocations are available for deployment.');
        }

        return $allocation->id;
    }
}
</file>

<file path="app/Services/Store/StoreVerificationService.php">
<?php

namespace Jexactyl\Services\Store;

use Jexactyl\Models\Node;
use Illuminate\Support\Facades\DB;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;
use Jexactyl\Http\Requests\Api\Client\Store\CreateServerRequest;

class StoreVerificationService
{
    public function __construct(private SettingsRepositoryInterface $settings)
    {
    }

    /**
     * This service ensures that users cannot create servers, gift
     * resources or edit a servers resource limits if they do not
     * have sufficient resources in their account - or if the requested
     * amount goes over admin-defined limits.
     */
    public function handle(CreateServerRequest $request)
    {
        $this->checkUserResources($request);
        $this->checkResourceLimits($request);

        $this->checkDeploymentCost($request);
    }

    private function checkUserResources(CreateServerRequest $request)
    {
        $types = ['cpu', 'memory', 'disk', 'slots', 'ports', 'backups', 'databases'];

        foreach ($types as $type) {
            $value = DB::table('users')->where('id', $request->user()->id)->pluck('store_' . $type)->first();

            if ($value < $request->input($type)) {
                throw new DisplayException('You only have' . $value . ' ' . $type . ', so you cannot deploy this server.');
            }
        }
    }

    private function checkResourceLimits(CreateServerRequest $request)
    {
        $prefix = 'jexactyl::store:limit:';
        $types = ['cpu', 'memory', 'disk', 'slot', 'port', 'backup', 'database'];

        foreach ($types as $type) {
            $suffix = '';
            $limit = $this->settings->get($prefix . $type);

            if (in_array($type, ['slot', 'port', 'backup', 'database'])) {
                $suffix = 's';
            }

            $amount = $request->input($type .= $suffix);

            if ($limit < $amount) {
                throw new DisplayException('You cannot deploy with ' . $amount . ' ' . $type . ', as an admin has set a limit of ' . $limit);
            }
        }
    }

    /**
     * Ensures the user has enough credits in order to deploy to a given node.
     */
    private function checkDeploymentCost(CreateServerRequest $request)
    {
        $fee = Node::find($request->input('node'))->deploy_fee;

        if ($fee > $request->user()->store_balance) {
            throw new DisplayException('You do not have enough credits to deploy to this node, as it has a deployment fee of ' . $fee . ' credits.');
        }
    }
}
</file>

<file path="app/Services/Subusers/SubuserCreationService.php">
<?php

namespace Jexactyl\Services\Subusers;

use Illuminate\Support\Str;
use Jexactyl\Models\Server;
use Jexactyl\Models\Subuser;
use Illuminate\Database\ConnectionInterface;
use Jexactyl\Services\Users\UserCreationService;
use Jexactyl\Repositories\Eloquent\SubuserRepository;
use Jexactyl\Contracts\Repository\UserRepositoryInterface;
use Jexactyl\Exceptions\Repository\RecordNotFoundException;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;
use Jexactyl\Exceptions\Service\Subuser\UserIsServerOwnerException;
use Jexactyl\Exceptions\Service\Subuser\ServerSubuserExistsException;

class SubuserCreationService
{
    /**
     * SubuserCreationService constructor.
     */
    public function __construct(
        private ConnectionInterface $connection,
        private SubuserRepository $subuserRepository,
        private UserCreationService $userCreationService,
        private UserRepositoryInterface $userRepository,
        private SettingsRepositoryInterface $settings
    ) {
    }

    /**
     * Creates a new user on the system and assigns them access to the provided server.
     * If the email address already belongs to a user on the system a new user will not
     * be created.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Service\Subuser\ServerSubuserExistsException
     * @throws \Jexactyl\Exceptions\Service\Subuser\UserIsServerOwnerException
     * @throws \Throwable
     */
    public function handle(Server $server, string $email, array $permissions): Subuser
    {
        return $this->connection->transaction(function () use ($server, $email, $permissions) {
            try {
                $user = $this->userRepository->findFirstWhere([['email', '=', $email]]);

                if ($server->owner_id === $user->id) {
                    throw new UserIsServerOwnerException(trans('exceptions.subusers.user_is_owner'));
                }

                $subuserCount = $this->subuserRepository->findCountWhere([['user_id', '=', $user->id], ['server_id', '=', $server->id]]);
                if ($subuserCount !== 0) {
                    throw new ServerSubuserExistsException(trans('exceptions.subusers.subuser_exists'));
                }
            } catch (RecordNotFoundException) {
                // Just cap the username generated at 64 characters at most and then append a random string
                // to the end to make it "unique"...
                $username = substr(preg_replace('/([^\w\.-]+)/', '', strtok($email, '@')), 0, 64) . Str::random(3);

                $appr = true;
                if ($this->settings->get('jexactyl::approvals:enabled') == 'true') {
                    $appr = false;
                }

                $user = $this->userCreationService->handle([
                    'email' => $email,
                    'username' => $username,
                    'name_first' => 'Server',
                    'name_last' => 'Subuser',
                    'root_admin' => false,
                    'approved' => $appr,
                ]);
            }

            return $this->subuserRepository->create([
                'user_id' => $user->id,
                'server_id' => $server->id,
                'permissions' => array_unique($permissions),
            ]);
        });
    }
}
</file>

<file path="app/Services/Users/ToggleTwoFactorService.php">
<?php

namespace Jexactyl\Services\Users;

use Carbon\Carbon;
use Jexactyl\Models\User;
use Illuminate\Support\Str;
use PragmaRX\Google2FA\Google2FA;
use Illuminate\Database\ConnectionInterface;
use Illuminate\Contracts\Encryption\Encrypter;
use Jexactyl\Contracts\Repository\UserRepositoryInterface;
use Jexactyl\Repositories\Eloquent\RecoveryTokenRepository;
use Jexactyl\Exceptions\Service\User\TwoFactorAuthenticationTokenInvalid;

class ToggleTwoFactorService
{
    /**
     * ToggleTwoFactorService constructor.
     */
    public function __construct(
        private ConnectionInterface $connection,
        private Encrypter $encrypter,
        private Google2FA $google2FA,
        private RecoveryTokenRepository $recoveryTokenRepository,
        private UserRepositoryInterface $repository
    ) {
    }

    /**
     * Toggle 2FA on an account only if the token provided is valid.
     *
     * @throws \Throwable
     * @throws \PragmaRX\Google2FA\Exceptions\IncompatibleWithGoogleAuthenticatorException
     * @throws \PragmaRX\Google2FA\Exceptions\InvalidCharactersException
     * @throws \PragmaRX\Google2FA\Exceptions\SecretKeyTooShortException
     * @throws \Jexactyl\Exceptions\Service\User\TwoFactorAuthenticationTokenInvalid
     */
    public function handle(User $user, string $token, bool $toggleState = null): array
    {
        $secret = $this->encrypter->decrypt($user->totp_secret);

        $isValidToken = $this->google2FA->verifyKey($secret, $token, config()->get('jexactyl.auth.2fa.window'));

        if (!$isValidToken) {
            throw new TwoFactorAuthenticationTokenInvalid();
        }

        return $this->connection->transaction(function () use ($user, $toggleState) {
            // Now that we're enabling 2FA on the account, generate 10 recovery tokens for the account
            // and store them hashed in the database. We'll return them to the caller so that the user
            // can see and save them.
            //
            // If a user is unable to login with a 2FA token they can provide one of these backup codes
            // which will then be marked as deleted from the database and will also bypass 2FA protections
            // on their account.
            $tokens = [];
            if ((!$toggleState && !$user->use_totp) || $toggleState) {
                $inserts = [];
                for ($i = 0; $i < 10; ++$i) {
                    $token = Str::random(10);

                    $inserts[] = [
                        'user_id' => $user->id,
                        'token' => password_hash($token, PASSWORD_DEFAULT),
                        // insert() won't actually set the time on the models, so make sure we do this
                        // manually here.
                        'created_at' => Carbon::now(),
                    ];

                    $tokens[] = $token;
                }

                // Before inserting any new records make sure all of the old ones are deleted to avoid
                // any issues or storing an unnecessary number of tokens in the database.
                $this->recoveryTokenRepository->deleteWhere(['user_id' => $user->id]);

                // Bulk insert the hashed tokens.
                $this->recoveryTokenRepository->insert($inserts);
            }

            $this->repository->withoutFreshModel()->update($user->id, [
                'totp_authenticated_at' => Carbon::now(),
                'use_totp' => (is_null($toggleState) ? !$user->use_totp : $toggleState),
            ]);

            return $tokens;
        });
    }
}
</file>

<file path="app/Services/Users/TwoFactorSetupService.php">
<?php

namespace Jexactyl\Services\Users;

use Jexactyl\Models\User;
use Illuminate\Contracts\Encryption\Encrypter;
use Jexactyl\Contracts\Repository\UserRepositoryInterface;
use Illuminate\Contracts\Config\Repository as ConfigRepository;

class TwoFactorSetupService
{
    public const VALID_BASE32_CHARACTERS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';

    /**
     * TwoFactorSetupService constructor.
     */
    public function __construct(
        private ConfigRepository $config,
        private Encrypter $encrypter,
        private UserRepositoryInterface $repository
    ) {
    }

    /**
     * Generate a 2FA token and store it in the database before returning the
     * QR code URL. This URL will need to be attached to a QR generating service in
     * order to function.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     * @throws \Jexactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function handle(User $user): array
    {
        $secret = '';
        try {
            for ($i = 0; $i < $this->config->get('jexactyl.auth.2fa.bytes', 16); ++$i) {
                $secret .= substr(self::VALID_BASE32_CHARACTERS, random_int(0, 31), 1);
            }
        } catch (\Exception $exception) {
            throw new \RuntimeException($exception->getMessage(), 0, $exception);
        }

        $this->repository->withoutFreshModel()->update($user->id, [
            'totp_secret' => $this->encrypter->encrypt($secret),
        ]);

        $company = urlencode(preg_replace('/\s/', '', $this->config->get('app.name')));

        return [
            'image_url_data' => sprintf(
                'otpauth://totp/%1$s:%2$s?secret=%3$s&issuer=%1$s',
                rawurlencode($company),
                rawurlencode($user->email),
                rawurlencode($secret),
            ),
            'secret' => $secret,
        ];
    }
}
</file>

<file path="app/Services/Users/UserCreationService.php">
<?php

namespace Jexactyl\Services\Users;

use Ramsey\Uuid\Uuid;
use Jexactyl\Models\User;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Http;
use Jexactyl\Notifications\VerifyEmail;
use Illuminate\Contracts\Hashing\Hasher;
use Jexactyl\Notifications\AccountCreated;
use Illuminate\Database\ConnectionInterface;
use Illuminate\Contracts\Auth\PasswordBroker;
use Jexactyl\Contracts\Repository\UserRepositoryInterface;
use Jexactyl\Contracts\Repository\SettingsRepositoryInterface;

class UserCreationService
{
    /**
     * UserCreationService constructor.
     */
    public function __construct(
        private ConnectionInterface $connection,
        private Hasher $hasher,
        private PasswordBroker $passwordBroker,
        private UserRepositoryInterface $repository,
        private SettingsRepositoryInterface $settings
    ) {
    }

    /**
     * Create a new user on the system.
     *
     * @throws \Exception
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function handle(array $data): User
    {
        $name = $this->settings->get('settings::app:name', 'Jexactyl');

        if (array_key_exists('password', $data) && !empty($data['password'])) {
            $data['password'] = $this->hasher->make($data['password']);
        }

        $this->connection->beginTransaction();
        if (!isset($data['password']) || empty($data['password'])) {
            $generateResetToken = true;
            $data['password'] = $this->hasher->make(str_random(30));
        }

        /** @var \Jexactyl\Models\User $user */
        $user = $this->repository->create(array_merge($data, [
            'uuid' => Uuid::uuid4()->toString(),
        ]), true, true);

        if (isset($generateResetToken)) {
            $token = $this->passwordBroker->createToken($user);
        }

        if ($this->settings->get('jexactyl::approvals:enabled') === 'true' && $this->settings->get('jexactyl::approvals:webhook')) {
            $icon = $this->settings->get('settings::app:logo', 'https://avatars.githubusercontent.com/u/91636558');
            $webhook_data = [
                'username' => $name,
                'avatar_url' => $icon,
                'embeds' => [
                    [
                        'title' => $name . ' - Registration Request',
                        'color' => 2718223,
                        'description' => 'A new account has been created.',
                        'fields' => [
                            [
                                'name' => 'Username:',
                                'value' => $data['username'],
                            ],
                            [
                                'name' => 'Email:',
                                'value' => $data['email'],
                            ],
                            [
                                'name' => 'Approve:',
                                'value' => env('APP_URL') . '/admin/approvals',
                            ],
                        ],
                        'footer' => ['text' => $name, 'icon_url' => $icon],
                        'timestamp' => date('c'),
                    ],
                ],
            ];

            try {
                Http::withBody(json_encode($webhook_data), 'application/json')->post($this->settings->get('jexactyl::approvals:webhook'));
            } catch (\Exception $e) {
            }
        }

        if (array_has($data, 'verified') && !$data['verified']) {
            $token = $this->genStr();
            DB::table('verification_tokens')->insert(['user' => $user->id, 'token' => $token]);
            $user->notify(new VerifyEmail($user, $name, $token));
        }

        $this->connection->commit();

        try {
            $user->notify(new AccountCreated($user, $token ?? null));
        } catch (\Exception $e) {
            // If the email system isn't active, still let users create accounts.
        }

        return $user;
    }

    private function genStr(): string
    {
        $chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        $pieces = [];
        $max = mb_strlen($chars, '8bit') - 1;
        for ($i = 0; $i < 32; ++$i) {
            $pieces[] = $chars[mt_rand(0, $max)];
        }

        return implode('', $pieces);
    }
}
</file>

<file path="app/Services/Users/UserDeletionService.php">
<?php

namespace Jexactyl\Services\Users;

use Jexactyl\Models\User;
use Jexactyl\Exceptions\DisplayException;
use Illuminate\Contracts\Translation\Translator;
use Jexactyl\Contracts\Repository\UserRepositoryInterface;
use Jexactyl\Contracts\Repository\ServerRepositoryInterface;

class UserDeletionService
{
    /**
     * UserDeletionService constructor.
     */
    public function __construct(
        protected UserRepositoryInterface $repository,
        protected ServerRepositoryInterface $serverRepository,
        protected Translator $translator
    ) {
    }

    /**
     * Delete a user from the panel only if they have no servers attached to their account.
     *
     * @throws \Jexactyl\Exceptions\DisplayException
     */
    public function handle(int|User $user): ?bool
    {
        if ($user instanceof User) {
            $user = $user->id;
        }

        $servers = $this->serverRepository->setColumns('id')->findCountWhere([['owner_id', '=', $user]]);
        if ($servers > 0) {
            throw new DisplayException($this->translator->get('admin/user.exceptions.user_has_servers'));
        }

        return $this->repository->delete($user);
    }
}
</file>

<file path="app/Services/Users/UserUpdateService.php">
<?php

namespace Jexactyl\Services\Users;

use Jexactyl\Models\User;
use Illuminate\Contracts\Hashing\Hasher;
use Jexactyl\Traits\Services\HasUserLevels;

class UserUpdateService
{
    use HasUserLevels;

    /**
     * UserUpdateService constructor.
     */
    public function __construct(private Hasher $hasher)
    {
    }

    /**
     * Update the user model instance and return the updated model.
     *
     * @throws \Throwable
     */
    public function handle(User $user, array $data): User
    {
        if (!empty(array_get($data, 'password'))) {
            $data['password'] = $this->hasher->make($data['password']);
        } else {
            unset($data['password']);
        }

        $user->forceFill($data)->saveOrFail();

        return $user->refresh();
    }
}
</file>

<file path="app/Traits/Commands/EnvironmentWriterTrait.php">
<?php

namespace Jexactyl\Traits\Commands;

use Jexactyl\Exceptions\JexactylException;

trait EnvironmentWriterTrait
{
    /**
     * Escapes an environment value by looking for any characters that could
     * reasonably cause environment parsing issues. Those values are then wrapped
     * in quotes before being returned.
     */
    public function escapeEnvironmentValue(string $value): string
    {
        if (!preg_match('/^\"(.*)\"$/', $value) && preg_match('/([^\w.\-+\/])+/', $value)) {
            return sprintf('"%s"', addslashes($value));
        }

        return $value;
    }

    /**
     * Update the .env file for the application using the passed in values.
     *
     * @throws \Jexactyl\Exceptions\JexactylException
     */
    public function writeToEnvironment(array $values = []): void
    {
        $path = base_path('.env');
        if (!file_exists($path)) {
            throw new JexactylException('Cannot locate .env file, was this software installed correctly?');
        }

        $saveContents = file_get_contents($path);
        collect($values)->each(function ($value, $key) use (&$saveContents) {
            $key = strtoupper($key);
            $saveValue = sprintf('%s=%s', $key, $this->escapeEnvironmentValue($value));

            if (preg_match_all('/^' . $key . '=(.*)$/m', $saveContents) < 1) {
                $saveContents = $saveContents . PHP_EOL . $saveValue;
            } else {
                $saveContents = preg_replace('/^' . $key . '=(.*)$/m', $saveValue, $saveContents);
            }
        });

        file_put_contents($path, $saveContents);
    }
}
</file>

<file path="app/Traits/Controllers/JavascriptInjection.php">
<?php

namespace Jexactyl\Traits\Controllers;

use Illuminate\Http\Request;

trait JavascriptInjection
{
    private Request $request;

    /**
     * Set the request object to use when injecting JS.
     */
    public function setRequest(Request $request): self
    {
        $this->request = $request;

        return $this;
    }

    /**
     * Injects the exact array passed in, nothing more.
     */
    public function plainInject(array $args = []): string
    {
        return \JavaScript::put($args);
    }
}
</file>

<file path="app/Traits/Controllers/PlainJavascriptInjection.php">
<?php

namespace Jexactyl\Traits\Controllers;

use JavaScript;

trait PlainJavascriptInjection
{
    /**
     * Injects statistics into javascript.
     */
    public function injectJavascript($data)
    {
        \JavaScript::put($data);
    }
}
</file>

<file path="app/Traits/Helpers/AvailableLanguages.php">
<?php

namespace Jexactyl\Traits\Helpers;

use Matriphe\ISO639\ISO639;
use Illuminate\Filesystem\Filesystem;

trait AvailableLanguages
{
    private ?ISO639 $iso639 = null;

    private ?Filesystem $filesystem = null;

    /**
     * Return all the available languages on the Panel based on those
     * that are present in the language folder.
     */
    public function getAvailableLanguages(bool $localize = false): array
    {
        return collect($this->getFilesystemInstance()->directories(resource_path('lang')))->mapWithKeys(function ($path) use ($localize) {
            $code = basename($path);
            $value = $localize ? $this->getIsoInstance()->nativeByCode1($code) : $this->getIsoInstance()->languageByCode1($code);

            return [$code => title_case($value)];
        })->toArray();
    }

    /**
     * Return an instance of the filesystem for getting a folder listing.
     */
    private function getFilesystemInstance(): Filesystem
    {
        return $this->filesystem = $this->filesystem ?: app()->make(Filesystem::class);
    }

    /**
     * Return an instance of the ISO639 class for generating names.
     */
    private function getIsoInstance(): ISO639
    {
        return $this->iso639 = $this->iso639 ?: app()->make(ISO639::class);
    }
}
</file>

<file path="app/Traits/Services/HasUserLevels.php">
<?php

namespace Jexactyl\Traits\Services;

use Jexactyl\Models\User;

trait HasUserLevels
{
    private int $userLevel = User::USER_LEVEL_USER;

    /**
     * Set the access level for running this function.
     */
    public function setUserLevel(int $level): self
    {
        $this->userLevel = $level;

        return $this;
    }

    /**
     * Determine which level this function is running at.
     */
    public function getUserLevel(): int
    {
        return $this->userLevel;
    }

    /**
     * Determine if the current user level is set to a specific level.
     */
    public function isUserLevel(int $level): bool
    {
        return $this->getUserLevel() === $level;
    }
}
</file>

<file path="app/Traits/Services/ReturnsUpdatedModels.php">
<?php

namespace Jexactyl\Traits\Services;

trait ReturnsUpdatedModels
{
    private bool $updatedModel = false;

    public function getUpdatedModel(): bool
    {
        return $this->updatedModel;
    }

    /**
     * If called a fresh model will be returned from the database. This is used
     * for API calls, but is unnecessary for UI based updates where the page is
     * being reloaded and a fresh model will be pulled anyways.
     */
    public function returnUpdatedModel(bool $toggle = true): self
    {
        $this->updatedModel = $toggle;

        return $this;
    }
}
</file>

<file path="app/Traits/Services/ValidatesValidationRules.php">
<?php

namespace Jexactyl\Traits\Services;

use Illuminate\Support\Str;
use Illuminate\Contracts\Validation\Factory as ValidationFactory;
use Jexactyl\Exceptions\Service\Egg\Variable\BadValidationRuleException;

trait ValidatesValidationRules
{
    abstract protected function getValidator(): ValidationFactory;

    /**
     * Validate that the rules being provided are valid for Laravel and can
     * be resolved.
     *
     * @throws \Jexactyl\Exceptions\Service\Egg\Variable\BadValidationRuleException
     */
    public function validateRules(array|string $rules): void
    {
        try {
            $this->getValidator()->make(['__TEST' => 'test'], ['__TEST' => $rules])->fails();
        } catch (\BadMethodCallException $exception) {
            $matches = [];
            if (preg_match('/Method \[(.+)\] does not exist\./', $exception->getMessage(), $matches)) {
                throw new BadValidationRuleException(trans('exceptions.nest.variables.bad_validation_rule', ['rule' => Str::snake(str_replace('validate', '', array_get($matches, 1, 'unknownRule')))]), $exception);
            }

            throw $exception;
        }
    }
}
</file>

<file path="app/Transformers/Api/Application/AllocationTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Application;

use Jexactyl\Models\Node;
use Jexactyl\Models\Server;
use Jexactyl\Models\Allocation;
use League\Fractal\Resource\Item;
use Jexactyl\Services\Acl\Api\AdminAcl;
use League\Fractal\Resource\NullResource;

class AllocationTransformer extends BaseTransformer
{
    /**
     * Relationships that can be loaded onto allocation transformations.
     */
    protected array $availableIncludes = ['node', 'server'];

    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return Allocation::RESOURCE_NAME;
    }

    /**
     * Return a generic transformed allocation array.
     */
    public function transform(Allocation $allocation): array
    {
        return [
            'id' => $allocation->id,
            'ip' => $allocation->ip,
            'alias' => $allocation->ip_alias,
            'port' => $allocation->port,
            'notes' => $allocation->notes,
            'assigned' => !is_null($allocation->server_id),
        ];
    }

    /**
     * Load the node relationship onto a given transformation.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeNode(Allocation $allocation): Item|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_NODES)) {
            return $this->null();
        }

        return $this->item(
            $allocation->node,
            $this->makeTransformer(NodeTransformer::class),
            Node::RESOURCE_NAME
        );
    }

    /**
     * Load the server relationship onto a given transformation.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeServer(Allocation $allocation): Item|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_SERVERS) || !$allocation->server) {
            return $this->null();
        }

        return $this->item(
            $allocation->server,
            $this->makeTransformer(ServerTransformer::class),
            Server::RESOURCE_NAME
        );
    }
}
</file>

<file path="app/Transformers/Api/Application/BaseTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Application;

use Carbon\CarbonImmutable;
use Carbon\CarbonInterface;
use Jexactyl\Models\ApiKey;
use Illuminate\Http\Request;
use Webmozart\Assert\Assert;
use Illuminate\Container\Container;
use Illuminate\Database\Eloquent\Model;
use Jexactyl\Services\Acl\Api\AdminAcl;
use League\Fractal\TransformerAbstract;

/**
 * @method array transform(Model $model)
 */
abstract class BaseTransformer extends TransformerAbstract
{
    public const RESPONSE_TIMEZONE = 'UTC';

    protected Request $request;

    /**
     * BaseTransformer constructor.
     */
    public function __construct()
    {
        // Transformers allow for dependency injection on the handle method.
        if (method_exists($this, 'handle')) {
            Container::getInstance()->call([$this, 'handle']);
        }
    }

    /**
     * Return the resource name for the JSONAPI output.
     */
    abstract public function getResourceName(): string;

    /**
     * Sets the request on the instance.
     */
    public function setRequest(Request $request): self
    {
        $this->request = $request;

        return $this;
    }

    /**
     * Returns a new transformer instance with the request set on the instance.
     */
    public static function fromRequest(Request $request): BaseTransformer
    {
        return app(static::class)->setRequest($request);
    }

    /**
     * Determine if the API key loaded onto the transformer has permission
     * to access a different resource. This is used when including other
     * models on a transformation request.
     *
     * @deprecated  prefer $user->can/cannot methods
     */
    protected function authorize(string $resource): bool
    {
        $allowed = [ApiKey::TYPE_ACCOUNT, ApiKey::TYPE_APPLICATION];

        $token = $this->request->user()->currentAccessToken();
        if (!$token instanceof ApiKey || !in_array($token->key_type, $allowed)) {
            return false;
        }

        // If this is not a deprecated application token type we can only check that
        // the user is a root admin at the moment. In a future release we'll be rolling
        // out more specific permissions for keys.
        if ($token->key_type === ApiKey::TYPE_ACCOUNT) {
            return $this->request->user()->root_admin;
        }

        return AdminAcl::check($token, $resource);
    }

    /**
     * Create a new instance of the transformer and pass along the currently
     * set API key.
     *
     * @template T of \Jexactyl\Transformers\Api\Application\BaseTransformer
     *
     * @param class-string<T> $abstract
     *
     * @return T
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     *
     * @noinspection PhpDocSignatureInspection
     */
    protected function makeTransformer(string $abstract)
    {
        Assert::subclassOf($abstract, self::class);

        return $abstract::fromRequest($this->request);
    }

    /**
     * Return an ISO-8601 formatted timestamp to use in the API response.
     */
    protected function formatTimestamp(string $timestamp): string
    {
        return CarbonImmutable::createFromFormat(CarbonInterface::DEFAULT_TO_STRING_FORMAT, $timestamp)
            ->setTimezone(self::RESPONSE_TIMEZONE)
            ->toAtomString();
    }
}
</file>

<file path="app/Transformers/Api/Application/DatabaseHostTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Application;

use Jexactyl\Models\Database;
use Jexactyl\Models\DatabaseHost;
use Jexactyl\Services\Acl\Api\AdminAcl;
use League\Fractal\Resource\Collection;
use League\Fractal\Resource\NullResource;

class DatabaseHostTransformer extends BaseTransformer
{
    protected array $availableIncludes = [
        'databases',
    ];

    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return DatabaseHost::RESOURCE_NAME;
    }

    /**
     * Transform database host into a representation for the application API.
     */
    public function transform(DatabaseHost $model): array
    {
        return [
            'id' => $model->id,
            'name' => $model->name,
            'host' => $model->host,
            'port' => $model->port,
            'username' => $model->username,
            'node' => $model->node_id,
            'created_at' => $model->created_at->toAtomString(),
            'updated_at' => $model->updated_at->toAtomString(),
        ];
    }

    /**
     * Include the databases associated with this host.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeDatabases(DatabaseHost $model): Collection|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_SERVER_DATABASES)) {
            return $this->null();
        }

        $model->loadMissing('databases');

        return $this->collection($model->getRelation('databases'), $this->makeTransformer(ServerDatabaseTransformer::class), Database::RESOURCE_NAME);
    }
}
</file>

<file path="app/Transformers/Api/Application/EggTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Application;

use Jexactyl\Models\Egg;
use Jexactyl\Models\Nest;
use Illuminate\Support\Arr;
use Jexactyl\Models\Server;
use Jexactyl\Models\EggVariable;
use League\Fractal\Resource\Item;
use Jexactyl\Services\Acl\Api\AdminAcl;
use League\Fractal\Resource\Collection;
use League\Fractal\Resource\NullResource;

class EggTransformer extends BaseTransformer
{
    /**
     * Relationships that can be loaded onto this transformation.
     */
    protected array $availableIncludes = [
        'nest',
        'servers',
        'config',
        'script',
        'variables',
    ];

    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return Egg::RESOURCE_NAME;
    }

    /**
     * Transform an Egg model into a representation that can be consumed by
     * the application api.
     *
     * @throws \JsonException
     */
    public function transform(Egg $model): array
    {
        $files = json_decode($model->config_files, true, 512, JSON_THROW_ON_ERROR);
        if (empty($files)) {
            $files = new \stdClass();
        }

        return [
            'id' => $model->id,
            'uuid' => $model->uuid,
            'name' => $model->name,
            'nest' => $model->nest_id,
            'author' => $model->author,
            'description' => $model->description,
            // "docker_image" is deprecated, but left here to avoid breaking too many things at once
            // in external software. We'll remove it down the road once things have gotten the chance
            // to upgrade to using "docker_images".
            'docker_image' => count($model->docker_images) > 0 ? Arr::first($model->docker_images) : '',
            'docker_images' => $model->docker_images,
            'config' => [
                'files' => $files,
                'startup' => json_decode($model->config_startup, true),
                'stop' => $model->config_stop,
                'logs' => json_decode($model->config_logs, true),
                'file_denylist' => $model->file_denylist,
                'extends' => $model->config_from,
            ],
            'startup' => $model->startup,
            'script' => [
                'privileged' => $model->script_is_privileged,
                'install' => $model->script_install,
                'entry' => $model->script_entry,
                'container' => $model->script_container,
                'extends' => $model->copy_script_from,
            ],
            $model->getCreatedAtColumn() => $this->formatTimestamp($model->created_at),
            $model->getUpdatedAtColumn() => $this->formatTimestamp($model->updated_at),
        ];
    }

    /**
     * Include the Nest relationship for the given Egg in the transformation.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeNest(Egg $model): Item|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_NESTS)) {
            return $this->null();
        }

        $model->loadMissing('nest');

        return $this->item($model->getRelation('nest'), $this->makeTransformer(NestTransformer::class), Nest::RESOURCE_NAME);
    }

    /**
     * Include the Servers relationship for the given Egg in the transformation.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeServers(Egg $model): Collection|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_SERVERS)) {
            return $this->null();
        }

        $model->loadMissing('servers');

        return $this->collection($model->getRelation('servers'), $this->makeTransformer(ServerTransformer::class), Server::RESOURCE_NAME);
    }

    /**
     * Include more detailed information about the configuration if this Egg is
     * extending another.
     */
    public function includeConfig(Egg $model): Item|NullResource
    {
        if (is_null($model->config_from)) {
            return $this->null();
        }

        $model->loadMissing('configFrom');

        return $this->item($model, function (Egg $model) {
            return [
                'files' => json_decode($model->inherit_config_files),
                'startup' => json_decode($model->inherit_config_startup),
                'stop' => $model->inherit_config_stop,
                'logs' => json_decode($model->inherit_config_logs),
            ];
        });
    }

    /**
     * Include more detailed information about the script configuration if the
     * Egg is extending another.
     */
    public function includeScript(Egg $model): Item|NullResource
    {
        if (is_null($model->copy_script_from)) {
            return $this->null();
        }

        $model->loadMissing('scriptFrom');

        return $this->item($model, function (Egg $model) {
            return [
                'privileged' => $model->script_is_privileged,
                'install' => $model->copy_script_install,
                'entry' => $model->copy_script_entry,
                'container' => $model->copy_script_container,
            ];
        });
    }

    /**
     * Include the variables that are defined for this Egg.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeVariables(Egg $model): Collection|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_EGGS)) {
            return $this->null();
        }

        $model->loadMissing('variables');

        return $this->collection(
            $model->getRelation('variables'),
            $this->makeTransformer(EggVariableTransformer::class),
            EggVariable::RESOURCE_NAME
        );
    }
}
</file>

<file path="app/Transformers/Api/Application/EggVariableTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Application;

use Jexactyl\Models\Egg;
use Jexactyl\Models\EggVariable;

class EggVariableTransformer extends BaseTransformer
{
    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return Egg::RESOURCE_NAME;
    }

    public function transform(EggVariable $model)
    {
        return $model->toArray();
    }
}
</file>

<file path="app/Transformers/Api/Application/LocationTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Application;

use Jexactyl\Models\Location;
use Jexactyl\Services\Acl\Api\AdminAcl;
use League\Fractal\Resource\Collection;
use League\Fractal\Resource\NullResource;

class LocationTransformer extends BaseTransformer
{
    /**
     * List of resources that can be included.
     */
    protected array $availableIncludes = ['nodes', 'servers'];

    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return Location::RESOURCE_NAME;
    }

    /**
     * Return a generic transformed location array.
     */
    public function transform(Location $location): array
    {
        return [
            'id' => $location->id,
            'short' => $location->short,
            'long' => $location->long,
            $location->getUpdatedAtColumn() => $this->formatTimestamp($location->updated_at),
            $location->getCreatedAtColumn() => $this->formatTimestamp($location->created_at),
        ];
    }

    /**
     * Return the nodes associated with this location.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeServers(Location $location): Collection|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_SERVERS)) {
            return $this->null();
        }

        $location->loadMissing('servers');

        return $this->collection($location->getRelation('servers'), $this->makeTransformer(ServerTransformer::class), 'server');
    }

    /**
     * Return the nodes associated with this location.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeNodes(Location $location): Collection|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_NODES)) {
            return $this->null();
        }

        $location->loadMissing('nodes');

        return $this->collection($location->getRelation('nodes'), $this->makeTransformer(NodeTransformer::class), 'node');
    }
}
</file>

<file path="app/Transformers/Api/Application/NestTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Application;

use Jexactyl\Models\Egg;
use Jexactyl\Models\Nest;
use Jexactyl\Models\Server;
use Jexactyl\Services\Acl\Api\AdminAcl;
use League\Fractal\Resource\Collection;
use League\Fractal\Resource\NullResource;

class NestTransformer extends BaseTransformer
{
    /**
     * Relationships that can be loaded onto this transformation.
     */
    protected array $availableIncludes = [
        'eggs', 'servers',
    ];

    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return Nest::RESOURCE_NAME;
    }

    /**
     * Transform a Nest model into a representation that can be consumed by the
     * application API.
     */
    public function transform(Nest $model): array
    {
        $response = $model->toArray();

        $response[$model->getUpdatedAtColumn()] = $this->formatTimestamp($model->updated_at);
        $response[$model->getCreatedAtColumn()] = $this->formatTimestamp($model->created_at);

        return $response;
    }

    /**
     * Include the Eggs relationship on the given Nest model transformation.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeEggs(Nest $model): Collection|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_EGGS)) {
            return $this->null();
        }

        $model->loadMissing('eggs');

        return $this->collection($model->getRelation('eggs'), $this->makeTransformer(EggTransformer::class), Egg::RESOURCE_NAME);
    }

    /**
     * Include the servers relationship on the given Nest model.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeServers(Nest $model): Collection|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_SERVERS)) {
            return $this->null();
        }

        $model->loadMissing('servers');

        return $this->collection($model->getRelation('servers'), $this->makeTransformer(ServerTransformer::class), Server::RESOURCE_NAME);
    }
}
</file>

<file path="app/Transformers/Api/Application/NodeTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Application;

use Jexactyl\Models\Node;
use League\Fractal\Resource\Item;
use Jexactyl\Services\Acl\Api\AdminAcl;
use League\Fractal\Resource\Collection;
use League\Fractal\Resource\NullResource;

class NodeTransformer extends BaseTransformer
{
    /**
     * List of resources that can be included.
     */
    protected array $availableIncludes = ['allocations', 'location', 'servers'];

    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return Node::RESOURCE_NAME;
    }

    /**
     * Return a node transformed into a format that can be consumed by the
     * external administrative API.
     */
    public function transform(Node $node): array
    {
        $response = collect($node->toArray())->mapWithKeys(function ($value, $key) {
            // I messed up early in 2016 when I named this column as poorly
            // as I did. This is the tragic result of my mistakes.
            $key = ($key === 'daemonSFTP') ? 'daemonSftp' : $key;

            return [snake_case($key) => $value];
        })->toArray();

        $response[$node->getUpdatedAtColumn()] = $this->formatTimestamp($node->updated_at);
        $response[$node->getCreatedAtColumn()] = $this->formatTimestamp($node->created_at);

        $resources = $node->servers()->select(['memory', 'disk'])->get();

        $response['allocated_resources'] = [
            'memory' => $resources->sum('memory'),
            'disk' => $resources->sum('disk'),
        ];

        return $response;
    }

    /**
     * Return the nodes associated with this location.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeAllocations(Node $node): Collection|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_ALLOCATIONS)) {
            return $this->null();
        }

        $node->loadMissing('allocations');

        return $this->collection(
            $node->getRelation('allocations'),
            $this->makeTransformer(AllocationTransformer::class),
            'allocation'
        );
    }

    /**
     * Return the nodes associated with this location.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeLocation(Node $node): Item|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_LOCATIONS)) {
            return $this->null();
        }

        $node->loadMissing('location');

        return $this->item(
            $node->getRelation('location'),
            $this->makeTransformer(LocationTransformer::class),
            'location'
        );
    }

    /**
     * Return the nodes associated with this location.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeServers(Node $node): Collection|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_SERVERS)) {
            return $this->null();
        }

        $node->loadMissing('servers');

        return $this->collection(
            $node->getRelation('servers'),
            $this->makeTransformer(ServerTransformer::class),
            'server'
        );
    }
}
</file>

<file path="app/Transformers/Api/Application/ServerDatabaseTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Application;

use Jexactyl\Models\Database;
use Jexactyl\Models\DatabaseHost;
use League\Fractal\Resource\Item;
use Jexactyl\Services\Acl\Api\AdminAcl;
use League\Fractal\Resource\NullResource;
use Illuminate\Contracts\Encryption\Encrypter;

class ServerDatabaseTransformer extends BaseTransformer
{
    protected array $availableIncludes = ['password', 'host'];

    private Encrypter $encrypter;

    /**
     * Perform dependency injection.
     */
    public function handle(Encrypter $encrypter)
    {
        $this->encrypter = $encrypter;
    }

    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return Database::RESOURCE_NAME;
    }

    /**
     * Transform a database model in a representation for the application API.
     */
    public function transform(Database $model): array
    {
        return [
            'id' => $model->id,
            'server' => $model->server_id,
            'host' => $model->database_host_id,
            'database' => $model->database,
            'username' => $model->username,
            'remote' => $model->remote,
            'max_connections' => $model->max_connections,
            'created_at' => $model->created_at->toAtomString(),
            'updated_at' => $model->updated_at->toAtomString(),
        ];
    }

    /**
     * Include the database password in the request.
     */
    public function includePassword(Database $model): Item
    {
        return $this->item($model, function (Database $model) {
            return [
                'password' => $this->encrypter->decrypt($model->password),
            ];
        }, 'database_password');
    }

    /**
     * Return the database host relationship for this server database.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeHost(Database $model): Item|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_DATABASE_HOSTS)) {
            return $this->null();
        }

        $model->loadMissing('host');

        return $this->item(
            $model->getRelation('host'),
            $this->makeTransformer(DatabaseHostTransformer::class),
            DatabaseHost::RESOURCE_NAME
        );
    }
}
</file>

<file path="app/Transformers/Api/Application/ServerTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Application;

use Jexactyl\Models\Server;
use League\Fractal\Resource\Item;
use Jexactyl\Services\Acl\Api\AdminAcl;
use League\Fractal\Resource\Collection;
use League\Fractal\Resource\NullResource;
use Jexactyl\Services\Servers\EnvironmentService;

class ServerTransformer extends BaseTransformer
{
    private EnvironmentService $environmentService;

    /**
     * List of resources that can be included.
     */
    protected array $availableIncludes = [
        'allocations',
        'user',
        'subusers',
        'nest',
        'egg',
        'variables',
        'location',
        'node',
        'databases',
        'transfer',
    ];

    /**
     * Perform dependency injection.
     */
    public function handle(EnvironmentService $environmentService)
    {
        $this->environmentService = $environmentService;
    }

    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return Server::RESOURCE_NAME;
    }

    /**
     * Return a generic transformed server array.
     */
    public function transform(Server $server): array
    {
        return [
            'id' => $server->getKey(),
            'external_id' => $server->external_id,
            'uuid' => $server->uuid,
            'identifier' => $server->uuidShort,
            'name' => $server->name,
            'description' => $server->description,
            'status' => $server->status,
            // This field is deprecated, please use "status".
            'suspended' => $server->isSuspended(),
            'limits' => [
                'memory' => $server->memory,
                'swap' => $server->swap,
                'disk' => $server->disk,
                'io' => $server->io,
                'cpu' => $server->cpu,
                'threads' => $server->threads,
                'oom_disabled' => $server->oom_disabled,
            ],
            'feature_limits' => [
                'databases' => $server->database_limit,
                'allocations' => $server->allocation_limit,
                'backups' => $server->backup_limit,
            ],
            'user' => $server->owner_id,
            'node' => $server->node_id,
            'allocation' => $server->allocation_id,
            'nest' => $server->nest_id,
            'egg' => $server->egg_id,
            'container' => [
                'startup_command' => $server->startup,
                'image' => $server->image,
                // This field is deprecated, please use "status".
                'installed' => $server->isInstalled() ? 1 : 0,
                'environment' => $this->environmentService->handle($server),
            ],
            $server->getUpdatedAtColumn() => $this->formatTimestamp($server->updated_at),
            $server->getCreatedAtColumn() => $this->formatTimestamp($server->created_at),
        ];
    }

    /**
     * Return a generic array of allocations for this server.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeAllocations(Server $server): Collection|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_ALLOCATIONS)) {
            return $this->null();
        }

        $server->loadMissing('allocations');

        return $this->collection($server->getRelation('allocations'), $this->makeTransformer(AllocationTransformer::class), 'allocation');
    }

    /**
     * Return a generic array of data about subusers for this server.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeSubusers(Server $server): Collection|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_USERS)) {
            return $this->null();
        }

        $server->loadMissing('subusers');

        return $this->collection($server->getRelation('subusers'), $this->makeTransformer(SubuserTransformer::class), 'subuser');
    }

    /**
     * Return a generic array of data about subusers for this server.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeUser(Server $server): Item|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_USERS)) {
            return $this->null();
        }

        $server->loadMissing('user');

        return $this->item($server->getRelation('user'), $this->makeTransformer(UserTransformer::class), 'user');
    }

    /**
     * Return a generic array with nest information for this server.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeNest(Server $server): Item|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_NESTS)) {
            return $this->null();
        }

        $server->loadMissing('nest');

        return $this->item($server->getRelation('nest'), $this->makeTransformer(NestTransformer::class), 'nest');
    }

    /**
     * Return a generic array with egg information for this server.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeEgg(Server $server): Item|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_EGGS)) {
            return $this->null();
        }

        $server->loadMissing('egg');

        return $this->item($server->getRelation('egg'), $this->makeTransformer(EggTransformer::class), 'egg');
    }

    /**
     * Return a generic array of data about subusers for this server.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeVariables(Server $server): Collection|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_SERVERS)) {
            return $this->null();
        }

        $server->loadMissing('variables');

        return $this->collection($server->getRelation('variables'), $this->makeTransformer(ServerVariableTransformer::class), 'server_variable');
    }

    /**
     * Return a generic array with location information for this server.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeLocation(Server $server): Item|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_LOCATIONS)) {
            return $this->null();
        }

        $server->loadMissing('location');

        return $this->item($server->getRelation('location'), $this->makeTransformer(LocationTransformer::class), 'location');
    }

    /**
     * Return a generic array with node information for this server.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeNode(Server $server): Item|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_NODES)) {
            return $this->null();
        }

        $server->loadMissing('node');

        return $this->item($server->getRelation('node'), $this->makeTransformer(NodeTransformer::class), 'node');
    }

    /**
     * Return a generic array with database information for this server.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeDatabases(Server $server): Collection|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_SERVER_DATABASES)) {
            return $this->null();
        }

        $server->loadMissing('databases');

        return $this->collection($server->getRelation('databases'), $this->makeTransformer(ServerDatabaseTransformer::class), 'databases');
    }
}
</file>

<file path="app/Transformers/Api/Application/ServerVariableTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Application;

use Jexactyl\Models\EggVariable;
use League\Fractal\Resource\Item;
use Jexactyl\Services\Acl\Api\AdminAcl;
use League\Fractal\Resource\NullResource;

class ServerVariableTransformer extends BaseTransformer
{
    /**
     * List of resources that can be included.
     */
    protected array $availableIncludes = ['parent'];

    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return ServerVariable::RESOURCE_NAME;
    }

    /**
     * Return a generic transformed server variable array.
     */
    public function transform(EggVariable $variable): array
    {
        return $variable->toArray();
    }

    /**
     * Return the parent service variable data.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeParent(EggVariable $variable): Item|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_EGGS)) {
            return $this->null();
        }

        $variable->loadMissing('variable');

        return $this->item($variable->getRelation('variable'), $this->makeTransformer(EggVariableTransformer::class), 'variable');
    }
}
</file>

<file path="app/Transformers/Api/Application/SubuserTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Application;

use Jexactyl\Models\Subuser;
use League\Fractal\Resource\Item;
use Jexactyl\Services\Acl\Api\AdminAcl;
use League\Fractal\Resource\NullResource;

class SubuserTransformer extends BaseTransformer
{
    /**
     * List of resources that can be included.
     */
    protected array $availableIncludes = ['user', 'server'];

    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return Subuser::RESOURCE_NAME;
    }

    /**
     * Return a transformed Subuser model that can be consumed by external services.
     */
    public function transform(Subuser $subuser): array
    {
        return [
            'id' => $subuser->id,
            'user_id' => $subuser->user_id,
            'server_id' => $subuser->server_id,
            'permissions' => $subuser->permissions,
            'created_at' => $this->formatTimestamp($subuser->created_at),
            'updated_at' => $this->formatTimestamp($subuser->updated_at),
        ];
    }

    /**
     * Return a generic item of user for this subuser.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeUser(Subuser $subuser): Item|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_USERS)) {
            return $this->null();
        }

        $subuser->loadMissing('user');

        return $this->item($subuser->getRelation('user'), $this->makeTransformer(UserTransformer::class), 'user');
    }

    /**
     * Return a generic item of server for this subuser.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeServer(Subuser $subuser): Item|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_SERVERS)) {
            return $this->null();
        }

        $subuser->loadMissing('server');

        return $this->item($subuser->getRelation('server'), $this->makeTransformer(ServerTransformer::class), 'server');
    }
}
</file>

<file path="app/Transformers/Api/Application/UserResourcesTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Application;

use Jexactyl\Models\User;

class UserResourcesTransformer extends BaseTransformer
{
    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return User::RESOURCE_NAME;
    }

    /**
     * Return a transformed User model that can be consumed by external services.
     */
    public function transform(User $user): array
    {
        return [
            'balance' => $user->store_balance,
            'slots' => $user->store_slots,
            'cpu' => $user->store_cpu,
            'memory' => $user->store_memory,
            'disk' => $user->store_disk,
            'ports' => $user->store_ports,
            'backups' => $user->store_backups,
            'databases' => $user->store_databases,
        ];
    }
}
</file>

<file path="app/Transformers/Api/Application/UserTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Application;

use Jexactyl\Models\User;
use Jexactyl\Services\Acl\Api\AdminAcl;
use League\Fractal\Resource\Collection;
use League\Fractal\Resource\NullResource;

class UserTransformer extends BaseTransformer
{
    /**
     * List of resources that can be included.
     */
    protected array $availableIncludes = ['servers'];

    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return User::RESOURCE_NAME;
    }

    /**
     * Return a transformed User model that can be consumed by external services.
     */
    public function transform(User $user): array
    {
        return [
            'id' => $user->id,
            'external_id' => $user->external_id,
            'discord_id' => $user->discord_id,
            'uuid' => $user->uuid,
            'username' => $user->username,
            'email' => $user->email,
            'first_name' => $user->name_first,
            'last_name' => $user->name_last,
            'language' => $user->language,
            'root_admin' => (bool) $user->root_admin,
            '2fa' => (bool) $user->use_totp,
            'created_at' => $this->formatTimestamp($user->created_at),
            'updated_at' => $this->formatTimestamp($user->updated_at),
        ];
    }

    /**
     * Return the servers associated with this user.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeServers(User $user): Collection|NullResource
    {
        if (!$this->authorize(AdminAcl::RESOURCE_SERVERS)) {
            return $this->null();
        }

        $user->loadMissing('servers');

        return $this->collection($user->getRelation('servers'), $this->makeTransformer(ServerTransformer::class), 'server');
    }
}
</file>

<file path="app/Transformers/Api/Client/Analytics/DataTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client\Analytics;

use Jexactyl\Models\AnalyticsData;
use Jexactyl\Transformers\Api\Client\BaseClientTransformer;

class DataTransformer extends BaseClientTransformer
{
    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return AnalyticsData::RESOURCE_NAME;
    }

    /**
     * Return basic information about the currently logged-in user.
     */
    public function transform(AnalyticsData $model): array
    {
        return [
            'id' => $model->id,
            'cpu' => $model->cpu,
            'memory' => $model->memory,
            'disk' => $model->disk,
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/Analytics/MessageTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client\Analytics;

use Jexactyl\Models\AnalyticsMessage;
use Jexactyl\Transformers\Api\Client\BaseClientTransformer;

class MessageTransformer extends BaseClientTransformer
{
    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return AnalyticsMessage::RESOURCE_NAME;
    }

    /**
     * Return basic information about the currently logged-in user.
     */
    public function transform(AnalyticsMessage $model): array
    {
        return [
            'id' => $model->id,
            'title' => $model->title,
            'content' => $model->content,
            'type' => $model->type,
            'created_at' => $model->created_at->diffForHumans(),
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/Referrals/ReferralActivityTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client\Referrals;

use Jexactyl\Models\User;
use Jexactyl\Models\ReferralUses;
use Jexactyl\Transformers\Api\Client\BaseClientTransformer;

class ReferralActivityTransformer extends BaseClientTransformer
{
    /**
     * {@inheritdoc}
     */
    public function getResourceName(): string
    {
        return ReferralUses::RESOURCE_NAME;
    }

    /**
     * Transform this model into a representation that can be consumed by a client.
     *
     * @return array
     */
    public function transform(ReferralUses $model)
    {
        return [
            'code' => $model->code_used,
            'user_id' => $model->user_id,
            'created_at' => $model->created_at->toIso8601String(),
            'user_email' => User::where('id', $model->user_id)->first()->email,
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/Referrals/ReferralCodeTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client\Referrals;

use Jexactyl\Models\ReferralCode;
use Jexactyl\Transformers\Api\Client\BaseClientTransformer;

class ReferralCodeTransformer extends BaseClientTransformer
{
    /**
     * {@inheritdoc}
     */
    public function getResourceName(): string
    {
        return ReferralCode::RESOURCE_NAME;
    }

    /**
     * Transform this model into a representation that can be consumed by a client.
     *
     * @return array
     */
    public function transform(ReferralCode $model)
    {
        return [
            'code' => $model->code,
            'created_at' => $model->created_at->toIso8601String(),
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/Store/CostTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client\Store;

use Jexactyl\Transformers\Api\Client\BaseClientTransformer;

class CostTransformer extends BaseClientTransformer
{
    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return 'cost';
    }

    /**
     * Transforms a User model into a representation that can be shown to regular
     * users of the API.
     */
    public function transform(array $model): array
    {
        return [
            'cpu' => $model[0],
            'memory' => $model[1],
            'disk' => $model[2],
            'slots' => $model[3],
            'ports' => $model[4],
            'backups' => $model[5],
            'databases' => $model[6],
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/Store/EggTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client\Store;

use Jexactyl\Models\Egg;
use Jexactyl\Transformers\Api\Client\BaseClientTransformer;

class EggTransformer extends BaseClientTransformer
{
    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return Egg::RESOURCE_NAME;
    }

    /**
     * Transforms the Egg model into a representation that can be consumed by
     * the application api.
     */
    public function transform(Egg $model): array
    {
        return [
            'id' => $model->id,
            'name' => $model->name,
            'docker_images' => $model->docker_images,
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/Store/NestTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client\Store;

use Jexactyl\Models\Nest;
use Jexactyl\Transformers\Api\Client\BaseClientTransformer;

class NestTransformer extends BaseClientTransformer
{
    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return Nest::RESOURCE_NAME;
    }

    /**
     * Transforms the Nest model into a representation that can be consumed by
     * the application api.
     */
    public function transform(Nest $model): array
    {
        return [
            'id' => $model->id,
            'name' => $model->name,
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/Store/NodeTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client\Store;

use Jexactyl\Models\Node;
use Jexactyl\Models\Allocation;
use Jexactyl\Transformers\Api\Client\BaseClientTransformer;

class NodeTransformer extends BaseClientTransformer
{
    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return Node::RESOURCE_NAME;
    }

    /**
     * Transforms the Node model into a representation that can be consumed by
     * the application api.
     */
    public function transform(Node $model): array
    {
        $total = Allocation::where('node_id', $model->id)->count();
        $used = Allocation::where('node_id', $model->id)->where('server_id', '!=', null)->count();

        return [
            'id' => $model->id,
            'name' => $model->name,
            'deploy_fee' => $model->deploy_fee,
            'location' => $model->location->short,
            'total' => $total,
            'used' => $used,
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/Store/UserTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client\Store;

use Jexactyl\Models\User;
use Jexactyl\Transformers\Api\Client\BaseClientTransformer;

class UserTransformer extends BaseClientTransformer
{
    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return User::RESOURCE_NAME;
    }

    /**
     * Transforms a User model into a representation that can be shown to regular
     * users of the API.
     */
    public function transform(User $model): array
    {
        return [
            'balance' => $model->store_balance,
            'cpu' => $model->store_cpu,
            'memory' => $model->store_memory,
            'disk' => $model->store_disk,
            'slots' => $model->store_slots,
            'ports' => $model->store_ports,
            'backups' => $model->store_backups,
            'databases' => $model->store_databases,
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/Tickets/TicketMessageTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client\Tickets;

use Jexactyl\Models\User;
use Jexactyl\Models\TicketMessage;
use Jexactyl\Transformers\Api\Client\BaseClientTransformer;

class TicketMessageTransformer extends BaseClientTransformer
{
    public function getResourceName(): string
    {
        return TicketMessage::RESOURCE_NAME;
    }

    /**
     * Transform a ticket model into a representation that can be returned
     * to a client.
     */
    public function transform(TicketMessage $model): array
    {
        return [
            'id' => $model->id,
            'user_email' => User::where('id', $model->user_id)->first()->email ?? 'system',
            'content' => $model->content,
            'created_at' => $model->created_at->toAtomString(),
            'updated_at' => $model->updated_at->toAtomString(),
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/Tickets/TicketTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client\Tickets;

use Jexactyl\Models\User;
use Jexactyl\Models\Ticket;
use Jexactyl\Transformers\Api\Client\BaseClientTransformer;

class TicketTransformer extends BaseClientTransformer
{
    public function getResourceName(): string
    {
        return Ticket::RESOURCE_NAME;
    }

    /**
     * Transform a ticket model into a representation that can be returned
     * to a client.
     */
    public function transform(Ticket $model): array
    {
        return [
            'id' => $model->id,
            'staff_email' => User::where('id', $model->staff_id)->first()->email ?? 'system',
            'title' => $model->title,
            'status' => $model->status,
            'content' => $model->content,
            'created_at' => $model->created_at->toAtomString(),
            'updated_at' => $model->updated_at->toAtomString(),
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/AccountTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client;

use Jexactyl\Models\User;

class AccountTransformer extends BaseClientTransformer
{
    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return 'user';
    }

    /**
     * Return basic information about the currently logged-in user.
     */
    public function transform(User $model): array
    {
        return [
            'id' => $model->id,
            'admin' => $model->root_admin,
            'username' => $model->username,
            'email' => $model->email,
            'first_name' => $model->name_first,
            'last_name' => $model->name_last,
            'language' => $model->language,
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/ActivityLogTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client;

use Jexactyl\Models\User;
use Illuminate\Support\Str;
use Jexactyl\Models\ActivityLog;
use Illuminate\Database\Eloquent\Model;

class ActivityLogTransformer extends BaseClientTransformer
{
    protected array $availableIncludes = ['actor'];

    public function getResourceName(): string
    {
        return ActivityLog::RESOURCE_NAME;
    }

    public function transform(ActivityLog $model): array
    {
        return [
            // This is not for security, it is only to provide a unique identifier to
            // the front-end for each entry to improve rendering performance since there
            // is nothing else sufficiently unique to key off at this point.
            'id' => sha1($model->id),
            'batch' => $model->batch,
            'event' => $model->event,
            'is_api' => !is_null($model->api_key_id),
            'ip' => $this->canViewIP($model->actor) ? $model->ip : null,
            'description' => $model->description,
            'properties' => $this->properties($model),
            'has_additional_metadata' => $this->hasAdditionalMetadata($model),
            'timestamp' => $model->timestamp->toAtomString(),
        ];
    }

    public function includeActor(ActivityLog $model)
    {
        if (!$model->actor instanceof User) {
            return $this->null();
        }

        return $this->item($model->actor, $this->makeTransformer(UserTransformer::class), User::RESOURCE_NAME);
    }

    /**
     * Transforms any array values in the properties into a countable field for easier
     * use within the translation outputs.
     */
    protected function properties(ActivityLog $model): object
    {
        if (!$model->properties || $model->properties->isEmpty()) {
            return (object) [];
        }

        $properties = $model->properties
            ->mapWithKeys(function ($value, $key) use ($model) {
                if ($key === 'ip' && !optional($model->actor)->is($this->request->user())) {
                    return [$key => '[hidden]'];
                }

                if (!is_array($value)) {
                    // Perform some directory normalization at this point.
                    if ($key === 'directory') {
                        $value = str_replace('//', '/', '/' . trim($value, '/') . '/');
                    }

                    return [$key => $value];
                }

                return [$key => $value, "{$key}_count" => count($value)];
            });

        $keys = $properties->keys()->filter(fn ($key) => Str::endsWith($key, '_count'))->values();
        if ($keys->containsOneItem()) {
            $properties = $properties->merge(['count' => $properties->get($keys[0])])->except($keys[0]);
        }

        return (object) $properties->toArray();
    }

    /**
     * Determines if there are any log properties that we've not already exposed
     * in the response language string and that are not just the IP address or
     * the browser useragent.
     *
     * This is used by the front-end to selectively display an "additional metadata"
     * button that is pointless if there is nothing the user can't already see from
     * the event description.
     */
    protected function hasAdditionalMetadata(ActivityLog $model): bool
    {
        if (is_null($model->properties) || $model->properties->isEmpty()) {
            return false;
        }

        $str = trans('activity.' . str_replace(':', '.', $model->event));
        preg_match_all('/:(?<key>[\w.-]+\w)(?:[^\w:]?|$)/', $str, $matches);

        $exclude = array_merge($matches['key'], ['ip', 'useragent', 'using_sftp']);
        foreach ($model->properties->keys() as $key) {
            if (!in_array($key, $exclude, true)) {
                return true;
            }
        }

        return false;
    }

    /**
     * Determines if the user can view the IP address in the output either because they are the
     * actor that performed the action, or because they are an administrator on the Panel.
     */
    protected function canViewIP(Model $actor = null): bool
    {
        return optional($actor)->is($this->request->user()) || $this->request->user()->root_admin;
    }
}
</file>

<file path="app/Transformers/Api/Client/AllocationTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client;

use Jexactyl\Models\Allocation;

class AllocationTransformer extends BaseClientTransformer
{
    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return 'allocation';
    }

    public function transform(Allocation $model): array
    {
        return [
            'id' => $model->id,
            'ip' => $model->ip,
            'ip_alias' => $model->ip_alias,
            'port' => $model->port,
            'notes' => $model->notes,
            'is_default' => $model->server->allocation_id === $model->id,
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/ApiKeyTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client;

use Jexactyl\Models\ApiKey;

class ApiKeyTransformer extends BaseClientTransformer
{
    /**
     * {@inheritdoc}
     */
    public function getResourceName(): string
    {
        return ApiKey::RESOURCE_NAME;
    }

    /**
     * Transform this model into a representation that can be consumed by a client.
     */
    public function transform(ApiKey $model): array
    {
        return [
            'identifier' => $model->identifier,
            'description' => $model->memo,
            'allowed_ips' => $model->allowed_ips,
            'last_used_at' => $model->last_used_at ? $model->last_used_at->toAtomString() : null,
            'created_at' => $model->created_at->toAtomString(),
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/BackupTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client;

use Jexactyl\Models\Backup;

class BackupTransformer extends BaseClientTransformer
{
    public function getResourceName(): string
    {
        return Backup::RESOURCE_NAME;
    }

    public function transform(Backup $backup): array
    {
        return [
            'uuid' => $backup->uuid,
            'is_successful' => $backup->is_successful,
            'is_locked' => $backup->is_locked,
            'name' => $backup->name,
            'ignored_files' => $backup->ignored_files,
            'checksum' => $backup->checksum,
            'bytes' => $backup->bytes,
            'created_at' => $backup->created_at->toAtomString(),
            'completed_at' => $backup->completed_at ? $backup->completed_at->toAtomString() : null,
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/BaseClientTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client;

use Jexactyl\Models\User;
use Jexactyl\Models\Server;
use Webmozart\Assert\Assert;
use Jexactyl\Transformers\Api\Application\BaseTransformer as BaseApplicationTransformer;

abstract class BaseClientTransformer extends BaseApplicationTransformer
{
    /**
     * Return the user model of the user requesting this transformation.
     */
    public function getUser(): User
    {
        return $this->request->user();
    }

    /**
     * Determine if the API key loaded onto the transformer has permission
     * to access a different resource. This is used when including other
     * models on a transformation request.
     *
     * @noinspection PhpParameterNameChangedDuringInheritanceInspection
     */
    protected function authorize(string $ability, Server $server = null): bool
    {
        Assert::isInstanceOf($server, Server::class);

        return $this->request->user()->can($ability, [$server]);
    }

    /**
     * {@inheritDoc}
     */
    protected function makeTransformer(string $abstract)
    {
        Assert::subclassOf($abstract, self::class);

        return parent::makeTransformer($abstract);
    }
}
</file>

<file path="app/Transformers/Api/Client/DatabaseTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client;

use Jexactyl\Models\Database;
use Jexactyl\Models\Permission;
use League\Fractal\Resource\Item;
use League\Fractal\Resource\NullResource;
use Illuminate\Contracts\Encryption\Encrypter;
use Jexactyl\Contracts\Extensions\HashidsInterface;

class DatabaseTransformer extends BaseClientTransformer
{
    protected array $availableIncludes = ['password'];

    private Encrypter $encrypter;

    private HashidsInterface $hashids;

    /**
     * Handle dependency injection.
     */
    public function handle(Encrypter $encrypter, HashidsInterface $hashids)
    {
        $this->encrypter = $encrypter;
        $this->hashids = $hashids;
    }

    public function getResourceName(): string
    {
        return Database::RESOURCE_NAME;
    }

    public function transform(Database $model): array
    {
        $model->loadMissing('host');

        return [
            'id' => $this->hashids->encode($model->id),
            'host' => [
                'address' => $model->getRelation('host')->host,
                'port' => $model->getRelation('host')->port,
            ],
            'name' => $model->database,
            'username' => $model->username,
            'connections_from' => $model->remote,
            'max_connections' => $model->max_connections,
        ];
    }

    /**
     * Include the database password in the request.
     */
    public function includePassword(Database $database): Item|NullResource
    {
        if (!$this->request->user()->can(Permission::ACTION_DATABASE_VIEW_PASSWORD, $database->server)) {
            return $this->null();
        }

        return $this->item($database, function (Database $model) {
            return [
                'password' => $this->encrypter->decrypt($model->password),
            ];
        }, 'database_password');
    }
}
</file>

<file path="app/Transformers/Api/Client/EggTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client;

use Jexactyl\Models\Egg;

class EggTransformer extends BaseClientTransformer
{
    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return Egg::RESOURCE_NAME;
    }

    public function transform(Egg $egg): array
    {
        return [
            'name' => $egg->name,
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/EggVariableTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client;

use Jexactyl\Models\EggVariable;

class EggVariableTransformer extends BaseClientTransformer
{
    public function getResourceName(): string
    {
        return EggVariable::RESOURCE_NAME;
    }

    public function transform(EggVariable $variable): array
    {
        // This guards against someone incorrectly retrieving variables (haha, me) and then passing
        // them into the transformer and along to the user. Just throw an exception and break the entire
        // pathway since you should never be exposing these types of variables to a client.
        if (!$variable->user_viewable) {
            throw new \BadMethodCallException('Cannot transform a hidden egg variable in a client transformer.');
        }

        return [
            'name' => $variable->name,
            'description' => $variable->description,
            'env_variable' => $variable->env_variable,
            'default_value' => $variable->default_value,
            'server_value' => $variable->server_value,
            'is_editable' => $variable->user_editable,
            'rules' => $variable->rules,
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/FileObjectTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client;

use Carbon\Carbon;
use Illuminate\Support\Arr;

class FileObjectTransformer extends BaseClientTransformer
{
    /**
     * Transform a file object response from the daemon into a standardized response.
     */
    public function transform(array $item): array
    {
        return [
            'name' => Arr::get($item, 'name'),
            'mode' => Arr::get($item, 'mode'),
            'mode_bits' => Arr::get($item, 'mode_bits'),
            'size' => Arr::get($item, 'size'),
            'is_file' => Arr::get($item, 'file', true),
            'is_symlink' => Arr::get($item, 'symlink', false),
            'mimetype' => Arr::get($item, 'mime', 'application/octet-stream'),
            'created_at' => Carbon::parse(Arr::get($item, 'created', ''))->toAtomString(),
            'modified_at' => Carbon::parse(Arr::get($item, 'modified', ''))->toAtomString(),
        ];
    }

    public function getResourceName(): string
    {
        return 'file_object';
    }
}
</file>

<file path="app/Transformers/Api/Client/ScheduleTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client;

use Jexactyl\Models\Task;
use Jexactyl\Models\Schedule;
use League\Fractal\Resource\Collection;

class ScheduleTransformer extends BaseClientTransformer
{
    protected array $availableIncludes = ['tasks'];

    protected array $defaultIncludes = ['tasks'];

    /**
     * {@inheritdoc}
     */
    public function getResourceName(): string
    {
        return Schedule::RESOURCE_NAME;
    }

    /**
     * Returns a transformed schedule model such that a client can view the information.
     */
    public function transform(Schedule $model): array
    {
        return [
            'id' => $model->id,
            'name' => $model->name,
            'cron' => [
                'day_of_week' => $model->cron_day_of_week,
                'day_of_month' => $model->cron_day_of_month,
                'month' => $model->cron_month,
                'hour' => $model->cron_hour,
                'minute' => $model->cron_minute,
            ],
            'is_active' => $model->is_active,
            'is_processing' => $model->is_processing,
            'only_when_online' => $model->only_when_online,
            'last_run_at' => $model->last_run_at?->toAtomString(),
            'next_run_at' => $model->next_run_at?->toAtomString(),
            'created_at' => $model->created_at->toAtomString(),
            'updated_at' => $model->updated_at->toAtomString(),
        ];
    }

    /**
     * Allows attaching the tasks specific to the schedule in the response.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeTasks(Schedule $model): Collection
    {
        return $this->collection(
            $model->tasks,
            $this->makeTransformer(TaskTransformer::class),
            Task::RESOURCE_NAME
        );
    }
}
</file>

<file path="app/Transformers/Api/Client/ServerTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client;

use Jexactyl\Models\Egg;
use Jexactyl\Models\Server;
use Jexactyl\Models\Subuser;
use Jexactyl\Models\Allocation;
use Jexactyl\Models\Permission;
use Jexactyl\Models\EggVariable;
use League\Fractal\Resource\Item;
use Illuminate\Container\Container;
use League\Fractal\Resource\Collection;
use League\Fractal\Resource\NullResource;
use Jexactyl\Services\Servers\StartupCommandService;

class ServerTransformer extends BaseClientTransformer
{
    protected array $defaultIncludes = ['allocations', 'variables'];

    protected array $availableIncludes = ['egg', 'subusers'];

    public function getResourceName(): string
    {
        return Server::RESOURCE_NAME;
    }

    /**
     * Transform a server model into a representation that can be returned
     * to a client.
     */
    public function transform(Server $server): array
    {
        /** @var \Jexactyl\Services\Servers\StartupCommandService $service */
        $service = Container::getInstance()->make(StartupCommandService::class);

        $user = $this->request->user();

        return [
            'server_owner' => $user->id === $server->owner_id,
            'identifier' => $server->uuidShort,
            'internal_id' => $server->id,
            'uuid' => $server->uuid,
            'name' => $server->name,
            'node' => $server->node->name,
            'is_node_under_maintenance' => $server->node->isUnderMaintenance(),
            'sftp_details' => [
                'ip' => $server->node->fqdn,
                'port' => $server->node->daemonSFTP,
            ],
            'description' => $server->description,
            'limits' => [
                'memory' => $server->memory,
                'swap' => $server->swap,
                'disk' => $server->disk,
                'io' => $server->io,
                'cpu' => $server->cpu,
                'threads' => $server->threads,
                'oom_disabled' => $server->oom_disabled,
            ],
            'invocation' => $service->handle($server, !$user->can(Permission::ACTION_STARTUP_READ, $server)),
            'docker_image' => $server->image,
            'egg_features' => $server->egg->inherit_features,
            'feature_limits' => [
                'databases' => $server->database_limit,
                'allocations' => $server->allocation_limit,
                'backups' => $server->backup_limit,
            ],
            'status' => $server->status,
            // This field is deprecated, please use "status".
            'is_suspended' => $server->isSuspended(),
            // This field is deprecated, please use "status".
            'is_installing' => !$server->isInstalled(),
            'is_transferring' => !is_null($server->transfer),
            'renewable' => $server->renewable,
            'renewal' => $server->renewal,
            'bg' => $server->bg,
        ];
    }

    /**
     * Returns the allocations associated with this server.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeAllocations(Server $server): Collection
    {
        $transformer = $this->makeTransformer(AllocationTransformer::class);

        $user = $this->request->user();
        // While we include this permission, we do need to actually handle it slightly different here
        // for the purpose of keeping things functionally working. If the user doesn't have read permissions
        // for the allocations we'll only return the primary server allocation, and any notes associated
        // with it will be hidden.
        //
        // This allows us to avoid too much permission regression, without also hiding information that
        // is generally needed for the frontend to make sense when browsing or searching results.
        if (!$user->can(Permission::ACTION_ALLOCATION_READ, $server)) {
            $primary = clone $server->allocation;
            $primary->notes = null;

            return $this->collection([$primary], $transformer, Allocation::RESOURCE_NAME);
        }

        return $this->collection($server->allocations, $transformer, Allocation::RESOURCE_NAME);
    }

    /**
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeVariables(Server $server): Collection|NullResource
    {
        if (!$this->request->user()->can(Permission::ACTION_STARTUP_READ, $server)) {
            return $this->null();
        }

        return $this->collection(
            $server->variables->where('user_viewable', true),
            $this->makeTransformer(EggVariableTransformer::class),
            EggVariable::RESOURCE_NAME
        );
    }

    /**
     * Returns the egg associated with this server.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeEgg(Server $server): Item
    {
        return $this->item($server->egg, $this->makeTransformer(EggTransformer::class), Egg::RESOURCE_NAME);
    }

    /**
     * Returns the subusers associated with this server.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function includeSubusers(Server $server): Collection|NullResource
    {
        if (!$this->request->user()->can(Permission::ACTION_USER_READ, $server)) {
            return $this->null();
        }

        return $this->collection($server->subusers, $this->makeTransformer(SubuserTransformer::class), Subuser::RESOURCE_NAME);
    }
}
</file>

<file path="app/Transformers/Api/Client/StatsTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client;

use Illuminate\Support\Arr;

class StatsTransformer extends BaseClientTransformer
{
    public function getResourceName(): string
    {
        return 'stats';
    }

    /**
     * Transform stats from the daemon into a result set that can be used in
     * the client API.
     */
    public function transform(array $data): array
    {
        return [
            'current_state' => Arr::get($data, 'state', 'stopped'),
            'is_suspended' => Arr::get($data, 'is_suspended', false),
            'resources' => [
                'memory_bytes' => Arr::get($data, 'utilization.memory_bytes', 0),
                'cpu_absolute' => Arr::get($data, 'utilization.cpu_absolute', 0),
                'disk_bytes' => Arr::get($data, 'utilization.disk_bytes', 0),
                'network_rx_bytes' => Arr::get($data, 'utilization.network.rx_bytes', 0),
                'network_tx_bytes' => Arr::get($data, 'utilization.network.tx_bytes', 0),
                'uptime' => Arr::get($data, 'utilization.uptime', 0),
            ],
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/SubuserTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client;

use Jexactyl\Models\Subuser;

class SubuserTransformer extends BaseClientTransformer
{
    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return Subuser::RESOURCE_NAME;
    }

    /**
     * Transforms a subuser into a model that can be shown to a front-end user.
     *
     * @throws \Jexactyl\Exceptions\Transformer\InvalidTransformerLevelException
     */
    public function transform(Subuser $model): array
    {
        return array_merge(
            $this->makeTransformer(UserTransformer::class)->transform($model->user),
            ['permissions' => $model->permissions]
        );
    }
}
</file>

<file path="app/Transformers/Api/Client/TaskTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client;

use Jexactyl\Models\Task;

class TaskTransformer extends BaseClientTransformer
{
    /**
     * {@inheritdoc}
     */
    public function getResourceName(): string
    {
        return Task::RESOURCE_NAME;
    }

    /**
     * Transforms a schedule's task into a client viewable format.
     */
    public function transform(Task $model): array
    {
        return [
            'id' => $model->id,
            'sequence_id' => $model->sequence_id,
            'action' => $model->action,
            'payload' => $model->payload,
            'time_offset' => $model->time_offset,
            'is_queued' => $model->is_queued,
            'continue_on_failure' => $model->continue_on_failure,
            'created_at' => $model->created_at->toAtomString(),
            'updated_at' => $model->updated_at->toAtomString(),
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/UserSSHKeyTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client;

use Jexactyl\Models\UserSSHKey;

class UserSSHKeyTransformer extends BaseClientTransformer
{
    public function getResourceName(): string
    {
        return UserSSHKey::RESOURCE_NAME;
    }

    /**
     * Return's a user's SSH key in an API response format.
     */
    public function transform(UserSSHKey $model): array
    {
        return [
            'name' => $model->name,
            'fingerprint' => $model->fingerprint,
            'public_key' => $model->public_key,
            'created_at' => $model->created_at->toAtomString(),
        ];
    }
}
</file>

<file path="app/Transformers/Api/Client/UserTransformer.php">
<?php

namespace Jexactyl\Transformers\Api\Client;

use Jexactyl\Models\User;
use Illuminate\Support\Str;

class UserTransformer extends BaseClientTransformer
{
    /**
     * Return the resource name for the JSONAPI output.
     */
    public function getResourceName(): string
    {
        return User::RESOURCE_NAME;
    }

    /**
     * Transforms a User model into a representation that can be shown to regular
     * users of the API.
     */
    public function transform(User $model): array
    {
        return [
            'uuid' => $model->uuid,
            'username' => $model->username,
            'email' => $model->email,
            'image' => 'https://gravatar.com/avatar/' . md5(Str::lower($model->email)),
            '2fa_enabled' => $model->use_totp,
            'created_at' => $model->created_at->toAtomString(),
        ];
    }
}
</file>

<file path="app/helpers.php">
<?php

if (!function_exists('is_digit')) {
    /**
     * Deal with normal (and irritating) PHP behavior to determine if
     * a value is a non-float positive integer.
     */
    function is_digit(mixed $value): bool
    {
        return !is_bool($value) && ctype_digit(strval($value));
    }
}

if (!function_exists('object_get_strict')) {
    /**
     * Get an object using dot notation. An object key with a value of null is still considered valid
     * and will not trigger the response of a default value (unlike object_get).
     */
    function object_get_strict(object $object, ?string $key, $default = null): mixed
    {
        if (is_null($key) || trim($key) == '') {
            return $object;
        }

        foreach (explode('.', $key) as $segment) {
            if (!is_object($object) || !property_exists($object, $segment)) {
                return value($default);
            }

            $object = $object->{$segment};
        }

        return $object;
    }
}
</file>

<file path="bootstrap/app.php">
<?php

/*
|--------------------------------------------------------------------------
| Create The Application
|--------------------------------------------------------------------------
|
| The first thing we will do is create a new Laravel application instance
| which serves as the "glue" for all the components of Laravel, and is
| the IoC container for the system binding all of the various parts.
|
*/

$app = new Illuminate\Foundation\Application(
    $_ENV['APP_BASE_PATH'] ?? dirname(__DIR__)
);

/*
|--------------------------------------------------------------------------
| Bind Important Interfaces
|--------------------------------------------------------------------------
|
| Next, we need to bind some important interfaces into the container so
| we will be able to resolve them when needed. The kernels serve the
| incoming requests to this application from both the web and CLI.
|
*/

$app->singleton(
    Illuminate\Contracts\Http\Kernel::class,
    Jexactyl\Http\Kernel::class
);

$app->singleton(
    Illuminate\Contracts\Console\Kernel::class,
    Jexactyl\Console\Kernel::class
);

$app->singleton(
    Illuminate\Contracts\Debug\ExceptionHandler::class,
    Jexactyl\Exceptions\Handler::class
);

/*
|--------------------------------------------------------------------------
| Return The Application
|--------------------------------------------------------------------------
|
| This script returns the application instance. The instance is given to
| the calling script so we can separate the building of the instances
| from the actual running of the application and sending responses.
|
*/

return $app;
</file>

<file path="bootstrap/tests.php">
<?php

use Illuminate\Support\Str;
use NunoMaduro\Collision\Provider;
use Illuminate\Contracts\Console\Kernel;
use Symfony\Component\Console\Output\ConsoleOutput;

require __DIR__ . '/../vendor/autoload.php';

$app = require __DIR__ . '/app.php';

/** @var \Jexactyl\Console\Kernel $kernel */
$kernel = $app->make(Kernel::class);

/*
 * Bootstrap the kernel and prepare application for testing.
 */
$kernel->bootstrap();

// Register the collision service provider so that errors during the test
// setup process are output nicely.
(new Provider())->register();

$output = new ConsoleOutput();

$prefix = 'database.connections.' . config('database.default');
if (!Str::contains(config("$prefix.database"), 'test')) {
    $output->writeln(PHP_EOL . '<error>Cannot run test process against non-testing database.</error>');
    $output->writeln(PHP_EOL . '<error>Environment is currently pointed at: "' . config("$prefix.database") . '".</error>');
    exit(1);
}

/*
 * Perform database migrations and reseeding before continuing with
 * running the tests.
 */
if (!env('SKIP_MIGRATIONS')) {
    $output->writeln(PHP_EOL . '<info>Refreshing database for Integration tests...</info>');
    $kernel->call('migrate:fresh');

    $output->writeln('<info>Seeding database for Integration tests...</info>' . PHP_EOL);
    $kernel->call('db:seed');
} else {
    $output->writeln(PHP_EOL . '<comment>Skipping database migrations...</comment>' . PHP_EOL);
}
</file>

<file path="config/egg_features/eula.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Egg Feature: EULA Popup
    |--------------------------------------------------------------------------
    |
    | This popup is enabled for Minecraft eggs and allows a custom frontend
    | hook to run that monitors the console output of the server and pops up
    | a modal asking the user to accept it if necessary.
    |
    | There is no additional configuration necessary.
    |
    */
];
</file>

<file path="config/prologue/alerts.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Alert Levels
    |--------------------------------------------------------------------------
    |
    | The default sort of alert levels which can be called as functions on the
    | AlertsMessageBag class. This gives a convenient way to add certain type's
    | of messages.
    |
    | For example:
    |
    |     Alerts::info($message);
    |
    */

    'levels' => [
        'info',
        'warning',
        'danger',
        'success',
    ],

    /*
    |--------------------------------------------------------------------------
    | Session Key
    |--------------------------------------------------------------------------
    |
    | The session key which is used to store flashed messages into the current
    | session. This can be changed if it conflicts with another key.
    |
    */

    'session_key' => 'alert_messages',
];
</file>

<file path="config/activity.php">
<?php

return [
    // The number of days elapsed before old activity log entries are deleted.
    'prune_days' => env('APP_ACTIVITY_PRUNE_DAYS', 90),

    // If set to true activity log entries generated by an admin user that is not also
    // a part of the server in question will be hidden from the activity logs API response.
    //
    // Activity will still be properly tracked, just not displayed.
    'hide_admin_activity' => env('APP_ACTIVITY_HIDE_ADMIN', false),
];
</file>

<file path="config/app.php">
<?php

use Illuminate\Support\Facades\Facade;

return [
    /*
    |--------------------------------------------------------------------------
    | Application Version
    |--------------------------------------------------------------------------
    | This value is set when creating a Jexactyl release. You should not
    | change this value if you are not maintaining your own internal versions.
    */

    'version' => '3.7.4',

    /*
    |--------------------------------------------------------------------------
    | Application Name
    |--------------------------------------------------------------------------
    |
    | This value is the name of your application. This value is used when the
    | framework needs to place the application's name in a notification or
    | any other location as required by the application or its packages.
    */

    'name' => env('APP_NAME', 'Jexactyl'),

    /*
    |--------------------------------------------------------------------------
    | Application Environment
    |--------------------------------------------------------------------------
    |
    | This value determines the "environment" your application is currently
    | running in. This may determine how you prefer to configure various
    | services your application utilizes. Set this in your ".env" file.
    |
    */

    'env' => env('APP_ENV', 'production'),

    /*
    |--------------------------------------------------------------------------
    | Application Debug Mode
    |--------------------------------------------------------------------------
    |
    | When your application is in debug mode, detailed error messages with
    | stack traces will be shown on every error that occurs within your
    | application. If disabled, a simple generic error page is shown.
    |
    */

    'debug' => env('APP_DEBUG', false),

    /*
    |--------------------------------------------------------------------------
    | Application URL
    |--------------------------------------------------------------------------
    |
    | This URL is used by the console to properly generate URLs when using
    | the Artisan command line tool. You should set this to the root of
    | your application so that it is used when running Artisan tasks.
    |
    */

    'url' => env('APP_URL', 'http://localhost'),

    /*
    |--------------------------------------------------------------------------
    | Application Timezone
    |--------------------------------------------------------------------------
    |
    | Here you may specify the default timezone for your application, which
    | will be used by the PHP date and date-time functions. We have gone
    | ahead and set this to a sensible default for you out of the box.
    |
    */

    'timezone' => env('APP_TIMEZONE', 'UTC'),

    /*
    |--------------------------------------------------------------------------
    | Application Locale Configuration
    |--------------------------------------------------------------------------
    |
    | The application locale determines the default locale that will be used
    | by the translation service provider. You are free to set this value
    | to any of the locales which will be supported by the application.
    |
    */

    'locale' => env('APP_LOCALE', 'en'),

    /*
    |--------------------------------------------------------------------------
    | Application Fallback Locale
    |--------------------------------------------------------------------------
    |
    | The fallback locale determines the locale to use when the current one
    | is not available. You may change the value to correspond to any of
    | the language folders that are provided through your application.
    |
    */

    'fallback_locale' => 'en',

    /*
    |--------------------------------------------------------------------------
    | Application Logo
    |--------------------------------------------------------------------------
    |
    | Used as the Panel logo and branding which is displayed via the frontend.
    |
    */

    'logo' => '',

    /*
    |--------------------------------------------------------------------------
    | Encryption Key
    |--------------------------------------------------------------------------
    |
    | This key is used by the Illuminate encrypter service and should be set
    | to a random, 32 character string, otherwise these encrypted strings
    | will not be safe. Please do this before deploying an application!
    |
    */

    'key' => env('APP_KEY'),

    'cipher' => 'AES-256-CBC',

    /*
    |--------------------------------------------------------------------------
    | Exception Reporter Configuration
    |--------------------------------------------------------------------------
    |
    | If you're encountering weird behavior with the Panel and no exceptions
    | are being logged try changing the environment variable below to be true.
    | This will override the default "don't report" behavior of the Panel and log
    | all exceptions. This will be quite noisy.
    |
    */

    'exceptions' => [
        'report_all' => env('APP_REPORT_ALL_EXCEPTIONS', false),
    ],

    /*
    |--------------------------------------------------------------------------
    | Maintenance Mode Driver
    |--------------------------------------------------------------------------
    |
    | These configuration options determine the driver used to determine and
    | manage Laravel's "maintenance mode" status. The "cache" driver will
    | allow maintenance mode to be controlled across multiple machines.
    |
    | Supported drivers: "file", "cache"
    |
    */

    'maintenance' => [
        'driver' => 'file',
    ],

    /*
    |--------------------------------------------------------------------------
    | Autoloaded Service Providers
    |--------------------------------------------------------------------------
    |
    | The service providers listed here will be automatically loaded on the
    | request to your application. Feel free to add your own services to
    | this array to grant expanded functionality to your applications.
    |
    */

    'providers' => [
        /*
         * Laravel Framework Service Providers...
         */
        Illuminate\Auth\AuthServiceProvider::class,
        Illuminate\Broadcasting\BroadcastServiceProvider::class,
        Illuminate\Bus\BusServiceProvider::class,
        Illuminate\Cache\CacheServiceProvider::class,
        Illuminate\Foundation\Providers\ConsoleSupportServiceProvider::class,
        Illuminate\Cookie\CookieServiceProvider::class,
        Illuminate\Database\DatabaseServiceProvider::class,
        Illuminate\Encryption\EncryptionServiceProvider::class,
        Illuminate\Filesystem\FilesystemServiceProvider::class,
        Illuminate\Foundation\Providers\FoundationServiceProvider::class,
        Illuminate\Hashing\HashServiceProvider::class,
        Illuminate\Mail\MailServiceProvider::class,
        Illuminate\Notifications\NotificationServiceProvider::class,
        Illuminate\Pagination\PaginationServiceProvider::class,
        Illuminate\Pipeline\PipelineServiceProvider::class,
        Illuminate\Queue\QueueServiceProvider::class,
        Illuminate\Redis\RedisServiceProvider::class,
        Illuminate\Auth\Passwords\PasswordResetServiceProvider::class,
        Illuminate\Session\SessionServiceProvider::class,
        Illuminate\Translation\TranslationServiceProvider::class,
        Illuminate\Validation\ValidationServiceProvider::class,
        Illuminate\View\ViewServiceProvider::class,

        /*
         * Application Service Providers...
         */
        Jexactyl\Providers\ActivityLogServiceProvider::class,
        Jexactyl\Providers\AppServiceProvider::class,
        Jexactyl\Providers\AuthServiceProvider::class,
        Jexactyl\Providers\BackupsServiceProvider::class,
        Jexactyl\Providers\BladeServiceProvider::class,
        Jexactyl\Providers\EventServiceProvider::class,
        Jexactyl\Providers\HashidsServiceProvider::class,
        Jexactyl\Providers\RouteServiceProvider::class,
        Jexactyl\Providers\RepositoryServiceProvider::class,
        Jexactyl\Providers\ViewComposerServiceProvider::class,

        /*
         * Additional Dependencies
         */
        Prologue\Alerts\AlertsServiceProvider::class,
    ],

    /*
    |--------------------------------------------------------------------------
    | Class Aliases
    |--------------------------------------------------------------------------
    |
    | This array of class aliases will be registered when this application
    | is started. However, feel free to register as many as you wish as
    | the aliases are "lazy" loaded, so they don't hinder performance.
    |
    */

    'aliases' => Facade::defaultAliases()->merge([
        'Alert' => Prologue\Alerts\Facades\Alert::class,
        'Carbon' => Carbon\Carbon::class,
        'JavaScript' => Laracasts\Utilities\JavaScript\JavaScriptFacade::class,
        'Theme' => Jexactyl\Extensions\Facades\Theme::class,

        // Custom Facades
        'Activity' => Jexactyl\Facades\Activity::class,
        'LogBatch' => Jexactyl\Facades\LogBatch::class,
        'LogTarget' => Jexactyl\Facades\LogTarget::class,
    ])->toArray(),
];
</file>

<file path="config/auth.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Lockout Configuration
    |--------------------------------------------------------------------------
    |
    | These options are Jexactyl specific and allow you to configure how
    | long a user should be locked out for if they input a username or
    | password incorrectly.
    |
    */
    'lockout' => [
        'time' => 2,
        'attempts' => 3,
    ],

    /*
    |--------------------------------------------------------------------------
    | Authentication Defaults
    |--------------------------------------------------------------------------
    |
    | This option controls the default authentication "guard" and password
    | reset options for your application. You may change these defaults
    | as required, but they're a perfect start for most applications.
    |
    */

    'defaults' => [
        'guard' => 'web',
        'passwords' => 'users',
    ],

    /*
    |--------------------------------------------------------------------------
    | Authentication Guards
    |--------------------------------------------------------------------------
    |
    | Next, you may define every authentication guard for your application.
    | Of course, a great default configuration has been defined for you
    | here which uses session storage and the Eloquent user provider.
    |
    | All authentication drivers have a user provider. This defines how the
    | users are actually retrieved out of your database or other storage
    | mechanisms used by this application to persist your user's data.
    |
    | Supported: "session", "token"
    |
    */

    'guards' => [
        'web' => [
            'driver' => 'session',
            'provider' => 'users',
        ],

        'api' => [
            'driver' => 'token',
            'provider' => 'users',
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | User Providers
    |--------------------------------------------------------------------------
    |
    | All authentication drivers have a user provider. This defines how the
    | users are actually retrieved out of your database or other storage
    | mechanisms used by this application to persist your user's data.
    |
    | If you have multiple user tables or models you may configure multiple
    | sources which represent each model / table. These sources may then
    | be assigned to any extra authentication guards you have defined.
    |
    | Supported: "database", "eloquent"
    |
    */

    'providers' => [
        'users' => [
            'driver' => 'eloquent',
            'model' => Jexactyl\Models\User::class,
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Resetting Passwords
    |--------------------------------------------------------------------------
    |
    | Here you may set the options for resetting passwords including the view
    | that is your password reset e-mail. You may also set the name of the
    | table that maintains all of the reset tokens for your application.
    |
    | You may specify multiple password reset configurations if you have more
    | than one user table or model in the application and you want to have
    | separate password reset settings based on the specific user types.
    |
    | The expire time is the number of minutes that the reset token should be
    | considered valid. This security feature keeps tokens short-lived so
    | they have less time to be guessed. You may change this as needed.
    |
    */

    'passwords' => [
        'users' => [
            'provider' => 'users',
            'table' => 'password_resets',
            'expire' => 60,
            'throttle' => 60,
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Password Confirmation Timeout
    |--------------------------------------------------------------------------
    |
    | Here you may define the amount of seconds before a password confirmation
    | times out and the user is prompted to re-enter their password via the
    | confirmation screen. By default, the timeout lasts for three hours.
    |
    */

    'password_timeout' => 10800,
];
</file>

<file path="config/backups.php">
<?php

use Jexactyl\Models\Backup;

return [
    // The backup driver to use for this Panel instance. All client generated server backups
    // will be stored in this location by default. It is possible to change this once backups
    // have been made, without losing data.
    'default' => env('APP_BACKUP_DRIVER', Backup::ADAPTER_WINGS),

    // This value is used to determine the lifespan of UploadPart presigned urls that wings
    // uses to upload backups to S3 storage.  Value is in minutes, so this would default to an hour.
    'presigned_url_lifespan' => env('BACKUP_PRESIGNED_URL_LIFESPAN', 60),

    // This value defines the maximal size of a single part for the S3 multipart upload during backups
    // The maximal part size must be given in bytes. The default value is 5GB.
    // Note that 5GB is the maximum for a single part when using AWS S3.
    'max_part_size' => env('BACKUP_MAX_PART_SIZE', 5 * 1024 * 1024 * 1024),

    // The time to wait before automatically failing a backup, time is in minutes and defaults
    // to 6 hours.  To disable this feature, set the value to `0`.
    'prune_age' => env('BACKUP_PRUNE_AGE', 360),

    // Defines the backup creation throttle limits for users. In this default example, we allow
    // a user to create two (successful or pending) backups per 10 minutes. Even if they delete
    // a backup it will be included in the throttle count.
    //
    // Set the period to "0" to disable this throttle. The period is defined in seconds.
    'throttles' => [
        'limit' => env('BACKUP_THROTTLE_LIMIT', 2),
        'period' => env('BACKUP_THROTTLE_PERIOD', 600),
    ],

    'disks' => [
        // There is no configuration for the local disk for Wings. That configuration
        // is determined by the Daemon configuration, and not the Panel.
        'wings' => [
            'adapter' => Backup::ADAPTER_WINGS,
        ],

        // Configuration for storing backups in Amazon S3. This uses the same credentials
        // specified in filesystems.php but does include some more specific settings for
        // backups, notably bucket, location, and use_accelerate_endpoint.
        's3' => [
            'adapter' => Backup::ADAPTER_AWS_S3,

            'region' => env('AWS_DEFAULT_REGION'),
            'key' => env('AWS_ACCESS_KEY_ID'),
            'secret' => env('AWS_SECRET_ACCESS_KEY'),

            // The S3 bucket to use for backups.
            'bucket' => env('AWS_BACKUPS_BUCKET'),

            // The location within the S3 bucket where backups will be stored. Backups
            // are stored within a folder using the server's UUID as the name. Each
            // backup for that server lives within that folder.
            'prefix' => env('AWS_BACKUPS_BUCKET') ?? '',

            'endpoint' => env('AWS_ENDPOINT'),
            'use_path_style_endpoint' => env('AWS_USE_PATH_STYLE_ENDPOINT', false),
            'use_accelerate_endpoint' => env('AWS_BACKUPS_USE_ACCELERATE', false),

            'storage_class' => env('AWS_BACKUPS_STORAGE_CLASS'),
        ],
    ],
];
</file>

<file path="config/broadcasting.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Default Broadcaster
    |--------------------------------------------------------------------------
    |
    | This option controls the default broadcaster that will be used by the
    | framework when an event needs to be broadcast. You may set this to
    | any of the connections defined in the "connections" array below.
    |
    | Supported: "pusher", "ably", "redis", "log", "null"
    |
    */

    'default' => env('BROADCAST_DRIVER', 'null'),

    /*
    |--------------------------------------------------------------------------
    | Broadcast Connections
    |--------------------------------------------------------------------------
    |
    | Here you may define all of the broadcast connections that will be used
    | to broadcast events to other systems or over websockets. Samples of
    | each available type of connection are provided inside this array.
    |
    */

    'connections' => [
        'pusher' => [
            'driver' => 'pusher',
            'key' => env('PUSHER_APP_KEY'),
            'secret' => env('PUSHER_APP_SECRET'),
            'app_id' => env('PUSHER_APP_ID'),
            'options' => [
                'host' => env('PUSHER_HOST', 'api-' . env('PUSHER_APP_CLUSTER', 'mt1') . '.pusher.com') ?: 'api-' . env('PUSHER_APP_CLUSTER', 'mt1') . '.pusher.com',
                'port' => env('PUSHER_PORT', 443),
                'scheme' => env('PUSHER_SCHEME', 'https'),
                'encrypted' => true,
                'useTLS' => env('PUSHER_SCHEME', 'https') === 'https',
            ],
            'client_options' => [
                // Guzzle client options: https://docs.guzzlephp.org/en/stable/request-options.html
            ],
        ],

        'ably' => [
            'driver' => 'ably',
            'key' => env('ABLY_KEY'),
        ],

        'redis' => [
            'driver' => 'redis',
            'connection' => 'default',
        ],

        'log' => [
            'driver' => 'log',
        ],

        'null' => [
            'driver' => 'null',
        ],
    ],
];
</file>

<file path="config/cache.php">
<?php

use Illuminate\Support\Str;

return [
    /*
    |--------------------------------------------------------------------------
    | Default Cache Store
    |--------------------------------------------------------------------------
    |
    | This option controls the default cache connection that gets used while
    | using this caching library. This connection is used when another is
    | not explicitly specified when executing a given caching function.
    |
    */

    'default' => env('CACHE_DRIVER', 'redis'),

    /*
    |--------------------------------------------------------------------------
    | Cache Stores
    |--------------------------------------------------------------------------
    |
    | Here you may define all of the cache "stores" for your application as
    | well as their drivers. You may even define multiple stores for the
    | same cache driver to group types of items stored in your caches.
    |
    | Supported drivers: "apc", "array", "database", "file",
    |         "memcached", "redis", "dynamodb", "octane", "null"
    |
    */

    'stores' => [
        'apc' => [
            'driver' => 'apc',
        ],

        'array' => [
            'driver' => 'array',
            'serialize' => false,
        ],

        'database' => [
            'driver' => 'database',
            'table' => 'cache',
            'connection' => null,
            'lock_connection' => null,
        ],

        'file' => [
            'driver' => 'file',
            'path' => storage_path('framework/cache/data'),
        ],

        'memcached' => [
            'driver' => 'memcached',
            'persistent_id' => env('MEMCACHED_PERSISTENT_ID'),
            'sasl' => [
                env('MEMCACHED_USERNAME'),
                env('MEMCACHED_PASSWORD'),
            ],
            'options' => [
                // Memcached::OPT_CONNECT_TIMEOUT  => 2000,
            ],
            'servers' => [
                [
                    'host' => env('MEMCACHED_HOST', '127.0.0.1'),
                    'port' => env('MEMCACHED_PORT', 11211),
                    'weight' => 100,
                ],
            ],
        ],

        'redis' => [
            'driver' => 'redis',
            'connection' => 'default',
            'lock_connection' => 'default',
        ],

        'sessions' => [
            'driver' => env('SESSION_DRIVER', 'database'),
            'table' => 'sessions',
            'connection' => env('SESSION_DRIVER') === 'redis' ? 'sessions' : null,
        ],

        'octane' => [
            'driver' => 'octane',
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Cache Key Prefix
    |--------------------------------------------------------------------------
    |
    | When utilizing the APC, database, memcached, Redis, or DynamoDB cache
    | stores there might be other applications using the same cache. For
    | that reason, you may prefix every cache key to avoid collisions.
    |
    */

    'prefix' => env('CACHE_PREFIX', Str::slug(env('APP_NAME', 'jexactyl'), '_') . '_cache_'),
];
</file>

<file path="config/compile.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Additional Compiled Classes
    |--------------------------------------------------------------------------
    |
    | Here you may specify additional classes to include in the compiled file
    | generated by the `artisan optimize` command. These should be classes
    | that are included on basically every request into the application.
    |
    */

    'files' => [
    ],

    /*
    |--------------------------------------------------------------------------
    | Compiled File Providers
    |--------------------------------------------------------------------------
    |
    | Here you may list service providers which define a "compiles" function
    | that returns additional files that should be compiled, providing an
    | easy way to get common files from any packages you are utilizing.
    |
    */

    'providers' => [
    ],
];
</file>

<file path="config/cors.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Cross-Origin Resource Sharing (CORS) Configuration
    |--------------------------------------------------------------------------
    |
    | Here you may configure your settings for cross-origin resource sharing
    | or "CORS". This determines what cross-origin operations may execute
    | in web browsers. You are free to adjust these settings as needed.
    |
    | To learn more: https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS
    |
    */

    /*
     * You can enable CORS for 1 or multiple paths.
     * Example: ['api/*']
     */
    'paths' => ['/api/client', '/api/application', '/api/client/*', '/api/application/*'],

    /*
     * Matches the request method. `['*']` allows all methods.
     */
    'allowed_methods' => ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'HEAD'],

    /*
     * Matches the request origin. `['*']` allows all origins. Wildcards can be used, eg `*.mydomain.com`
     */
    'allowed_origins' => explode(',', env('APP_CORS_ALLOWED_ORIGINS') ?? ''),

    /*
     * Patterns that can be used with `preg_match` to match the origin.
     */
    'allowed_origins_patterns' => [],

    /*
     * Sets the Access-Control-Allow-Headers response header. `['*']` allows all headers.
     */
    'allowed_headers' => ['*'],

    /*
     * Sets the Access-Control-Expose-Headers response header with these headers.
     */
    'exposed_headers' => [],

    /*
     * Sets the Access-Control-Max-Age response header when > 0.
     */
    'max_age' => 0,

    /*
     * Sets the Access-Control-Allow-Credentials header.
     */
    'supports_credentials' => true,
];
</file>

<file path="config/database.php">
<?php

use Jexactyl\Helpers\Time;
use Illuminate\Support\Str;

return [
    /*
    |--------------------------------------------------------------------------
    | Default Database Connection Name
    |--------------------------------------------------------------------------
    |
    | Here you may specify which of the database connections below you wish
    | to use as your default connection for all database work. Of course
    | you may use many connections at once using the Database library.
    |
    */

    'default' => env('DB_CONNECTION', 'mysql'),

    /*
    |--------------------------------------------------------------------------
    | Database Connections
    |--------------------------------------------------------------------------
    |
    | Here are each of the database connections setup for your application.
    | Of course, examples of configuring each database platform that is
    | supported by Laravel is shown below to make development simple.
    |
    |
    | All database work in Laravel is done through the PHP PDO facilities
    | so make sure you have the driver for your particular database of
    | choice installed on your machine before you begin development.
    |
    */

    'connections' => [
        'mysql' => [
            'driver' => 'mysql',
            'url' => env('DATABASE_URL'),
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '3306'),
            'database' => env('DB_DATABASE', 'panel'),
            'username' => env('DB_USERNAME', 'jexactyl'),
            'password' => env('DB_PASSWORD', ''),
            'unix_socket' => env('DB_SOCKET', ''),
            'charset' => 'utf8mb4',
            'collation' => 'utf8mb4_unicode_ci',
            'prefix' => env('DB_PREFIX', ''),
            'prefix_indexes' => true,
            'strict' => env('DB_STRICT_MODE', false),
            'timezone' => env('DB_TIMEZONE', Time::getMySQLTimezoneOffset(env('APP_TIMEZONE', 'UTC'))),
            'sslmode' => env('DB_SSLMODE', 'prefer'),
            'options' => extension_loaded('pdo_mysql') ? array_filter([
                PDO::MYSQL_ATTR_SSL_CA => env('MYSQL_ATTR_SSL_CA'),
                PDO::MYSQL_ATTR_SSL_CERT => env('MYSQL_ATTR_SSL_CERT'),
                PDO::MYSQL_ATTR_SSL_KEY => env('MYSQL_ATTR_SSL_KEY'),
                PDO::MYSQL_ATTR_SSL_VERIFY_SERVER_CERT => env('MYSQL_ATTR_SSL_VERIFY_SERVER_CERT', true),
            ]) : [],
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Migration Repository Table
    |--------------------------------------------------------------------------
    |
    | This table keeps track of all the migrations that have already run for
    | your application. Using this information, we can determine which of
    | the migrations on disk haven't actually been run in the database.
    |
    */

    'migrations' => 'migrations',

    /*
    |--------------------------------------------------------------------------
    | Redis Databases
    |--------------------------------------------------------------------------
    |
    | Redis is an open source, fast, and advanced key-value store that also
    | provides a richer set of commands than a typical key-value systems
    | such as APC or Memcached. Laravel makes it easy to dig right in.
    |
    */

    'redis' => [
        'client' => env('REDIS_CLIENT', 'predis'),

        'options' => [
            'cluster' => env('REDIS_CLUSTER', 'redis'),
            'prefix' => env('REDIS_PREFIX', Str::slug(env('APP_NAME', 'jexactyl'), '_') . '_database_'),
        ],

        'default' => [
            'scheme' => env('REDIS_SCHEME', 'tcp'),
            'path' => env('REDIS_PATH', '/run/redis/redis.sock'),
            'host' => env('REDIS_HOST', 'localhost'),
            'username' => env('REDIS_USERNAME'),
            'password' => env('REDIS_PASSWORD'),
            'port' => env('REDIS_PORT', 6379),
            'database' => env('REDIS_DATABASE', 0),
            'context' => extension_loaded('redis') && env('REDIS_CLIENT') === 'phpredis' ? [
                'stream' => array_filter([
                    'verify_peer' => env('REDIS_VERIFY_PEER', true),
                    'verify_peer_name' => env('REDIS_VERIFY_PEER_NAME', true),
                    'cafile' => env('REDIS_CAFILE'),
                    'local_cert' => env('REDIS_LOCAL_CERT'),
                    'local_pk' => env('REDIS_LOCAL_PK'),
                ]),
            ] : [],
        ],

        'sessions' => [
            'scheme' => env('REDIS_SCHEME', 'tcp'),
            'path' => env('REDIS_PATH', '/run/redis/redis.sock'),
            'host' => env('REDIS_HOST', 'localhost'),
            'username' => env('REDIS_USERNAME'),
            'password' => env('REDIS_PASSWORD'),
            'port' => env('REDIS_PORT', 6379),
            'database' => env('REDIS_DATABASE_SESSIONS', 1),
            'context' => extension_loaded('redis') && env('REDIS_CLIENT') === 'phpredis' ? [
                'stream' => array_filter([
                    'verify_peer' => env('REDIS_VERIFY_PEER', true),
                    'verify_peer_name' => env('REDIS_VERIFY_PEER_NAME', true),
                    'cafile' => env('REDIS_CAFILE'),
                    'local_cert' => env('REDIS_LOCAL_CERT'),
                    'local_pk' => env('REDIS_LOCAL_PK'),
                ]),
            ] : [],
        ],
    ],
];
</file>

<file path="config/filesystems.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Default Filesystem Disk
    |--------------------------------------------------------------------------
    |
    | Here you may specify the default filesystem disk that should be used
    | by the framework. The "local" disk, as well as a variety of cloud
    | based disks are available to your application. Just store away!
    |
    */

    'default' => env('FILESYSTEM_DISK', 'local'),

    /*
    |--------------------------------------------------------------------------
    | Filesystem Disks
    |--------------------------------------------------------------------------
    |
    | Here you may configure as many filesystem "disks" as you wish, and you
    | may even configure multiple disks of the same driver. Defaults have
    | been set up for each driver as an example of the required values.
    |
    | Supported Drivers: "local", "ftp", "sftp", "s3"
    |
    */

    'disks' => [
        'local' => [
            'driver' => 'local',
            'root' => storage_path('app'),
            'throw' => false,
        ],

        'public' => [
            'driver' => 'local',
            'root' => storage_path('app/public'),
            'url' => env('APP_URL') . '/storage',
            'visibility' => 'public',
            'throw' => false,
        ],

        's3' => [
            'driver' => 's3',
            'key' => env('AWS_ACCESS_KEY_ID'),
            'secret' => env('AWS_SECRET_ACCESS_KEY'),
            'region' => env('AWS_DEFAULT_REGION'),
            'bucket' => env('AWS_BUCKET'),
            'url' => env('AWS_URL'),
            'endpoint' => env('AWS_ENDPOINT'),
            'use_path_style_endpoint' => env('AWS_USE_PATH_STYLE_ENDPOINT', false),
            'throw' => false,
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Symbolic Links
    |--------------------------------------------------------------------------
    |
    | Here you may configure the symbolic links that will be created when the
    | `storage:link` Artisan command is executed. The array keys should be
    | the locations of the links and the values should be their targets.
    |
    */

    'links' => [
        public_path('storage') => storage_path('app/public'),
    ],
];
</file>

<file path="config/fractal.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Default Serializer
    |--------------------------------------------------------------------------
    |
    | The default serializer to be used when performing a transformation. It
    | may be left empty to use Fractal's default one. This can either be a
    | string or a League\Fractal\Serializer\SerializerAbstract subclass.
    |
    */

    'default_serializer' => League\Fractal\Serializer\JsonApiSerializer::class,

    /*
    |--------------------------------------------------------------------------
    | Auto Includes
    |--------------------------------------------------------------------------
    |
    | If enabled Fractal will automatically add the includes who's
    | names are present in the `include` request parameter.
    |
    */

    'auto_includes' => [
        'enabled' => true,
        'request_key' => 'include',
    ],
];
</file>

<file path="config/gateways.php">
<?php

/*
|--------------------------------------------------------------------------
| Jexactyl Gateways
|--------------------------------------------------------------------------
| This configuration file is used to determine the settings for Jexactyl's
| payment gateways (Stripe and PayPal by default).
*/

return [
    /*
    |--------------------------------------------------------------------------
    | Preferred Currency
    |--------------------------------------------------------------------------
    | This value determines what currency to process orders in.
    |
    */
    'currency' => env('STORE_CURRENCY', 'USD'),

    /*
    |--------------------------------------------------------------------------
    | Cost per 100 credits
    |--------------------------------------------------------------------------
    | This value determines how much 100 credits costs. Defaults to $1 USD.
    |
    */
    'cost' => env('STORE_COST', 1.00),

    /*
    |--------------------------------------------------------------------------
    | PayPal Configuration
    |--------------------------------------------------------------------------
    | These values determine the configuration for the PayPal purchase system.
    |
    */
    'paypal' => [
        'client_id' => env('PAYPAL_CLIENT_ID', ''),
        'client_secret' => env('PAYPAL_CLIENT_SECRET', ''),
    ],

    /*
    |--------------------------------------------------------------------------
    | Stripe Configuration
    |--------------------------------------------------------------------------
    | These values determine the configuration for the Stripe purchase system.
    |
    */
    'stripe' => [
        'secret' => env('STRIPE_CLIENT_SECRET', ''),
        'webhook_secret' => env('STRIPE_WEBHOOK_SECRET', ''),
    ],
];
</file>

<file path="config/hashids.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Hashids Configuration
    |--------------------------------------------------------------------------
    |
    | Here are the settings that control the Hashids setup and usage in the panel.
    |
    */
    'salt' => env('HASHIDS_SALT'),
    'length' => env('HASHIDS_LENGTH', 8),
    'alphabet' => env('HASHIDS_ALPHABET', 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890'),
];
</file>

<file path="config/hashing.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Default Hash Driver
    |--------------------------------------------------------------------------
    |
    | This option controls the default hash driver that will be used to hash
    | passwords for your application. By default, the bcrypt algorithm is
    | used; however, you remain free to modify this option if you wish.
    |
    | Supported: "bcrypt", "argon", "argon2id"
    |
    */

    'driver' => 'bcrypt',

    /*
    |--------------------------------------------------------------------------
    | Bcrypt Options
    |--------------------------------------------------------------------------
    |
    | Here you may specify the configuration options that should be used when
    | passwords are hashed using the Bcrypt algorithm. This will allow you
    | to control the amount of time it takes to hash the given password.
    |
    */

    'bcrypt' => [
        'rounds' => env('BCRYPT_ROUNDS', 10),
    ],

    /*
    |--------------------------------------------------------------------------
    | Argon Options
    |--------------------------------------------------------------------------
    |
    | Here you may specify the configuration options that should be used when
    | passwords are hashed using the Argon algorithm. These will allow you
    | to control the amount of time it takes to hash the given password.
    |
    */

    'argon' => [
        'memory' => 65536,
        'threads' => 1,
        'time' => 4,
    ],
];
</file>

<file path="config/http.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | API Rate Limits
    |--------------------------------------------------------------------------
    |
    | Defines the rate limit for the number of requests per minute that can be
    | executed against both the client and internal (application) APIs over the
    | defined period (by default, 1 minute).
    |
    */
    'rate_limit' => [
        'client_period' => 1,
        'client' => env('APP_API_CLIENT_RATELIMIT', 720),

        'application_period' => 1,
        'application' => env('APP_API_APPLICATION_RATELIMIT', 240),
    ],
];
</file>

<file path="config/javascript.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | View to Bind JavaScript Vars To
    |--------------------------------------------------------------------------
    |
    | Set this value to the name of the view (or partial) that
    | you want to prepend all JavaScript variables to.
    | This can be a single view, or an array of views.
    | Example: 'footer' or ['footer', 'bottom']
    |
    */
    'bind_js_vars_to_this_view' => [
        'layouts.scripts',
    ],

    /*
    |--------------------------------------------------------------------------
    | JavaScript Namespace
    |--------------------------------------------------------------------------
    |
    | By default, we'll add variables to the global window object. However,
    | it's recommended that you change this to some namespace - anything.
    | That way, you can access vars, like "SomeNamespace.someVariable."
    |
    */
    'js_namespace' => 'Jexactyl',
];
</file>

<file path="config/jexactyl.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Restricted Environment
    |--------------------------------------------------------------------------
    |
    | Set this environment variable to true to enable a restricted configuration
    | setup on the panel. When set to true, configurations stored in the
    | database will not be applied.
    */

    'load_environment_only' => (bool) env('APP_ENVIRONMENT_ONLY', false),

    /*
    |--------------------------------------------------------------------------
    | Service Author
    |--------------------------------------------------------------------------
    |
    | Each panel installation is assigned a unique UUID to identify the
    | author of custom services, and make upgrades easier by identifying
    | standard Jexactyl shipped services.
    */

    'service' => [
        'author' => env('APP_SERVICE_AUTHOR', 'unknown@unknown.com'),
    ],

    /*
    |--------------------------------------------------------------------------
    | Authentication
    |--------------------------------------------------------------------------
    |
    | Should login success and failure events trigger an email to the user?
    */

    'auth' => [
        '2fa_required' => env('APP_2FA_REQUIRED', 0),
        '2fa' => [
            'bytes' => 32,
            'window' => env('APP_2FA_WINDOW', 4),
            'verify_newer' => true,
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Pagination
    |--------------------------------------------------------------------------
    |
    | Certain pagination result counts can be configured here and will take
    | effect globally.
    */

    'paginate' => [
        'frontend' => [
            'servers' => env('APP_PAGINATE_FRONT_SERVERS', 15),
        ],
        'admin' => [
            'servers' => env('APP_PAGINATE_ADMIN_SERVERS', 25),
            'users' => env('APP_PAGINATE_ADMIN_USERS', 25),
        ],
        'api' => [
            'nodes' => env('APP_PAGINATE_API_NODES', 25),
            'servers' => env('APP_PAGINATE_API_SERVERS', 25),
            'users' => env('APP_PAGINATE_API_USERS', 25),
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Guzzle Connections
    |--------------------------------------------------------------------------
    |
    | Configure the timeout to be used for Guzzle connections here.
    */

    'guzzle' => [
        'timeout' => env('GUZZLE_TIMEOUT', 60),
        'connect_timeout' => env('GUZZLE_CONNECT_TIMEOUT', 30),
    ],

    /*
    |--------------------------------------------------------------------------
    | CDN
    |--------------------------------------------------------------------------
    |
    | Information for the panel to use when contacting the CDN to confirm
    | if panel is up to date.
    */

    'cdn' => [
        'cache_time' => 60,
        'url' => 'https://versions.jexactyl.com',
    ],

    /*
    |--------------------------------------------------------------------------
    | Client Features
    |--------------------------------------------------------------------------
    |
    | Allow clients to create their own databases.
    */

    'client_features' => [
        'databases' => [
            'enabled' => env('JEXACTYL_CLIENT_DATABASES_ENABLED', true),
            'allow_random' => env('JEXACTYL_CLIENT_DATABASES_ALLOW_RANDOM', true),
        ],

        'schedules' => [
            // The total number of tasks that can exist for any given schedule at once.
            'per_schedule_task_limit' => env('JEXACTYL_PER_SCHEDULE_TASK_LIMIT', 10),
        ],

        'allocations' => [
            'enabled' => env('JEXACTYL_CLIENT_ALLOCATIONS_ENABLED', true),
            'range_start' => env('JEXACTYL_CLIENT_ALLOCATIONS_RANGE_START'),
            'range_end' => env('JEXACTYL_CLIENT_ALLOCATIONS_RANGE_END'),
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | File Editor
    |--------------------------------------------------------------------------
    |
    | This array includes the MIME filetypes that can be edited via the web.
    */

    'files' => [
        'max_edit_size' => env('JEXACTYL_FILES_MAX_EDIT_SIZE', 1024 * 1024 * 4),
    ],

    /*
    |--------------------------------------------------------------------------
    | Dynamic Environment Variables
    |--------------------------------------------------------------------------
    |
    | Place dynamic environment variables here that should be auto-appended
    | to server environment fields when the server is created or updated.
    |
    | Items should be in 'key' => 'value' format, where key is the environment
    | variable name, and value is the server-object key. For example:
    |
    | 'P_SERVER_CREATED_AT' => 'created_at'
    */

    'environment_variables' => [
        'P_SERVER_ALLOCATION_LIMIT' => 'allocation_limit',
    ],

    /*
    |--------------------------------------------------------------------------
    | Asset Verification
    |--------------------------------------------------------------------------
    |
    | This section controls the output format for JS & CSS assets.
    */

    'assets' => [
        'use_hash' => env('JEXACTYL_USE_ASSET_HASH', false),
    ],

    /*
    |--------------------------------------------------------------------------
    | Email Notification Settings
    |--------------------------------------------------------------------------
    |
    | This section controls what notifications are sent to users.
    */

    'email' => [
        // Should an email be sent to a server owner once their server has completed it's first install process?
        'send_install_notification' => env('JEXACTYL_SEND_INSTALL_NOTIFICATION', true),
        // Should an email be sent to a server owner whenever their server is reinstalled?
        'send_reinstall_notification' => env('JEXACTYL_SEND_REINSTALL_NOTIFICATION', true),
    ],
];
</file>

<file path="config/mail.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Default Mailer
    |--------------------------------------------------------------------------
    |
    | This option controls the default mailer that is used to send any email
    | messages sent by your application. Alternative mailers may be setup
    | and used as needed; however, this mailer will be used by default.
    |
    */

    'default' => env('MAIL_MAILER', env('MAIL_DRIVER', 'smtp')),

    /*
    |--------------------------------------------------------------------------
    | Mailer Configurations
    |--------------------------------------------------------------------------
    |
    | Here you may configure all of the mailers used by your application plus
    | their respective settings. Several examples have been configured for
    | you and you are free to add your own as your application requires.
    |
    | Laravel supports a variety of mail "transport" drivers to be used while
    | sending an e-mail. You will specify which one you are using for your
    | mailers below. You are free to add additional mailers as required.
    |
    | Supported: "smtp", "sendmail", "mailgun", "ses",
    |            "postmark", "log", "array", "failover"
    |
    */

    'mailers' => [
        'smtp' => [
            'transport' => 'smtp',
            'host' => env('MAIL_HOST', 'smtp.mailgun.org'),
            'port' => env('MAIL_PORT', 587),
            'encryption' => env('MAIL_ENCRYPTION', 'tls'),
            'username' => env('MAIL_USERNAME'),
            'password' => env('MAIL_PASSWORD'),
            'timeout' => null,
            'local_domain' => env('MAIL_EHLO_DOMAIN', env('SERVER_NAME')),
        ],

        'ses' => [
            'transport' => 'ses',
        ],

        'mailgun' => [
            'transport' => 'mailgun',
        ],

        'postmark' => [
            'transport' => 'postmark',
        ],

        'sendmail' => [
            'transport' => 'sendmail',
            'path' => env('MAIL_SENDMAIL_PATH', '/usr/sbin/sendmail -bs -i'),
        ],

        'log' => [
            'transport' => 'log',
            'channel' => env('MAIL_LOG_CHANNEL'),
        ],

        'array' => [
            'transport' => 'array',
        ],

        'failover' => [
            'transport' => 'failover',
            'mailers' => [
                'smtp',
                'log',
            ],
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Global "From" Address
    |--------------------------------------------------------------------------
    |
    | You may wish for all e-mails sent by your application to be sent from
    | the same address. Here, you may specify a name and address that is
    | used globally for all e-mails that are sent by your application.
    |
    */

    'from' => [
        'address' => env('MAIL_FROM_ADDRESS', env('MAIL_FROM', 'hello@example.com')),
        'name' => env('MAIL_FROM_NAME', 'Jexactyl Panel'),
    ],

    /*
    |--------------------------------------------------------------------------
    | Markdown Mail Settings
    |--------------------------------------------------------------------------
    |
    | If you are using Markdown based email rendering, you may configure your
    | theme and component paths here, allowing you to customize the design
    | of the emails. Or, you may simply stick with the Laravel defaults!
    |
    */

    'markdown' => [
        'theme' => 'default',

        'paths' => [
            resource_path('views/vendor/mail'),
        ],
    ],
];
</file>

<file path="config/queue.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Default Queue Connection Name
    |--------------------------------------------------------------------------
    |
    | Laravel's queue API supports an assortment of back-ends via a single
    | API, giving you convenient access to each back-end using the same
    | syntax for every one. Here you may define a default connection.
    |
    */

    'default' => env('QUEUE_CONNECTION', env('QUEUE_DRIVER', 'redis')),

    /*
    |--------------------------------------------------------------------------
    | Queue Connections
    |--------------------------------------------------------------------------
    |
    | Here you may configure the connection information for each server that
    | is used by your application. A default configuration has been added
    | for each back-end shipped with Laravel. You are free to add more.
    |
    */

    'connections' => [
        'sync' => [
            'driver' => 'sync',
        ],

        'database' => [
            'driver' => 'database',
            'table' => 'jobs',
            'queue' => env('QUEUE_STANDARD', 'standard'),
            'retry_after' => 90,
            'after_commit' => false,
        ],

        'sqs' => [
            'driver' => 'sqs',
            'key' => env('AWS_ACCESS_KEY_ID'),
            'secret' => env('AWS_SECRET_ACCESS_KEY'),
            'prefix' => env('SQS_PREFIX', 'https://sqs.us-east-1.amazonaws.com/your-account-id'),
            'queue' => env('SQS_QUEUE', env('QUEUE_STANDARD', 'standard')),
            'suffix' => env('SQS_SUFFIX'),
            'region' => env('AWS_DEFAULT_REGION', 'us-east-1'),
            'after_commit' => false,
        ],

        'redis' => [
            'driver' => 'redis',
            'connection' => 'default',
            'queue' => env('REDIS_QUEUE', env('QUEUE_STANDARD', 'standard')),
            'retry_after' => 90,
            'block_for' => null,
            'after_commit' => false,
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Failed Queue Jobs
    |--------------------------------------------------------------------------
    |
    | These options configure the behavior of failed queue job logging so you
    | can control which database and table are used to store the jobs that
    | have failed. You may change them to any database / table you wish.
    |
    */

    'failed' => [
        'driver' => env('QUEUE_FAILED_DRIVER', 'database-uuids'),
        'database' => env('DB_CONNECTION', 'mysql'),
        'table' => 'failed_jobs',
    ],
];
</file>

<file path="config/recaptcha.php">
<?php

return [
    /*
     * Enable or disable captchas
     */
    'enabled' => env('RECAPTCHA_ENABLED', true),

    /*
     * API endpoint for recaptcha checks. You should not edit this.
     */
    'domain' => env('RECAPTCHA_DOMAIN', 'https://www.google.com/recaptcha/api/siteverify'),

    /*
     * Use a custom secret key, we use our public one by default
     */
    'secret_key' => env('RECAPTCHA_SECRET_KEY', '6LcJcjwUAAAAALOcDJqAEYKTDhwELCkzUkNDQ0J5'),
    '_shipped_secret_key' => '6LcJcjwUAAAAALOcDJqAEYKTDhwELCkzUkNDQ0J5',

    /*
     * Use a custom website key, we use our public one by default
     */
    'website_key' => env('RECAPTCHA_WEBSITE_KEY', '6LcJcjwUAAAAAO_Xqjrtj9wWufUpYRnK6BW8lnfn'),
    '_shipped_website_key' => '6LcJcjwUAAAAAO_Xqjrtj9wWufUpYRnK6BW8lnfn',

    /*
     * Domain verification is enabled by default and compares the domain used when solving the captcha
     * as public keys can't have domain verification on google's side enabled (obviously).
     */
    'verify_domain' => true,
];
</file>

<file path="config/sanctum.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Stateful Domains
    |--------------------------------------------------------------------------
    |
    | Requests from the following domains / hosts will receive stateful API
    | authentication cookies. Typically, these should include your local
    | and production domains which access your API via a frontend SPA.
    |
    */

    'stateful' => explode(',', env('SANCTUM_STATEFUL_DOMAINS', sprintf(
        '%s%s',
        'localhost,localhost:3000,127.0.0.1,127.0.0.1:8000,::1',
        Laravel\Sanctum\Sanctum::currentApplicationUrlWithPort()
    ))),

    /*
    |--------------------------------------------------------------------------
    | Sanctum Guards
    |--------------------------------------------------------------------------
    |
    | This array contains the authentication guards that will be checked when
    | Sanctum is trying to authenticate a request. If none of these guards
    | are able to authenticate the request, Sanctum will use the bearer
    | token that's present on an incoming request for authentication.
    |
    */

    'guard' => ['web'],

    /*
    |--------------------------------------------------------------------------
    | Expiration Minutes
    |--------------------------------------------------------------------------
    |
    | This value controls the number of minutes until an issued token will be
    | considered expired. If this value is null, personal access tokens do
    | not expire. This won't tweak the lifetime of first-party sessions.
    |
    */

    'expiration' => null,

    /*
    |--------------------------------------------------------------------------
    | Sanctum Middleware
    |--------------------------------------------------------------------------
    |
    | When authenticating your first-party SPA with Sanctum you may need to
    | customize some of the middleware Sanctum uses while processing the
    | request. You may change the middleware listed below as required.
    |
    */

    'middleware' => [
        'verify_csrf_token' => Jexactyl\Http\Middleware\VerifyCsrfToken::class,
        'encrypt_cookies' => Jexactyl\Http\Middleware\EncryptCookies::class,
    ],
];
</file>

<file path="config/session.php">
<?php

use Illuminate\Support\Str;

return [
    /*
    |--------------------------------------------------------------------------
    | Default Session Driver
    |--------------------------------------------------------------------------
    |
    | This option controls the default session "driver" that will be used on
    | requests. By default, we will use the lightweight native driver but
    | you may specify any of the other wonderful drivers provided here.
    |
    | Supported: "file", "cookie", "database", "apc",
    |            "memcached", "redis", "dynamodb", "array"
    |
    */

    'driver' => env('SESSION_DRIVER', 'redis'),

    /*
    |--------------------------------------------------------------------------
    | Session Lifetime
    |--------------------------------------------------------------------------
    |
    | Here you may specify the number of minutes that you wish the session
    | to be allowed to remain idle before it expires. If you want them
    | to immediately expire on the browser closing, set that option.
    |
    */

    'lifetime' => env('SESSION_LIFETIME', 720),

    'expire_on_close' => false,

    /*
    |--------------------------------------------------------------------------
    | Session Encryption
    |--------------------------------------------------------------------------
    |
    | This option allows you to easily specify that all of your session data
    | should be encrypted before it is stored. All encryption will be run
    | automatically by Laravel and you can use the Session like normal.
    |
    */

    'encrypt' => true,

    /*
    |--------------------------------------------------------------------------
    | Session File Location
    |--------------------------------------------------------------------------
    |
    | When using the native session driver, we need a location where session
    | files may be stored. A default has been set for you but a different
    | location may be specified. This is only needed for file sessions.
    |
    */

    'files' => storage_path('framework/sessions'),

    /*
    |--------------------------------------------------------------------------
    | Session Database Connection
    |--------------------------------------------------------------------------
    |
    | When using the "database" or "redis" session drivers, you may specify a
    | connection that should be used to manage these sessions. This should
    | correspond to a connection in your database configuration options.
    |
    */

    'connection' => env('SESSION_CONNECTION'),

    /*
    |--------------------------------------------------------------------------
    | Session Database Table
    |--------------------------------------------------------------------------
    |
    | When using the "database" session driver, you may specify the table we
    | should use to manage the sessions. Of course, a sensible default is
    | provided for you; however, you are free to change this as needed.
    |
    */

    'table' => 'sessions',

    /*
    |--------------------------------------------------------------------------
    | Session Cache Store
    |--------------------------------------------------------------------------
    |
    | While using one of the framework's cache driven session backends you may
    | list a cache store that should be used for these sessions. This value
    | must match with one of the application's configured cache "stores".
    |
    | Affects: "apc", "dynamodb", "memcached", "redis"
    |
    */

    'store' => env('SESSION_STORE'),

    /*
    |--------------------------------------------------------------------------
    | Session Sweeping Lottery
    |--------------------------------------------------------------------------
    |
    | Some session drivers must manually sweep their storage location to get
    | rid of old sessions from storage. Here are the chances that it will
    | happen on a given request. By default, the odds are 2 out of 100.
    |
    */

    'lottery' => [2, 100],

    /*
    |--------------------------------------------------------------------------
    | Session Cookie Name
    |--------------------------------------------------------------------------
    |
    | Here you may change the name of the cookie used to identify a session
    | instance by ID. The name specified here will get used every time a
    | new session cookie is created by the framework for every driver.
    |
    */

    'cookie' => env(
        'SESSION_COOKIE',
        Str::slug(env('APP_NAME', 'jexactyl'), '_') . '_session'
    ),

    /*
    |--------------------------------------------------------------------------
    | Session Cookie Path
    |--------------------------------------------------------------------------
    |
    | The session cookie path determines the path for which the cookie will
    | be regarded as available. Typically, this will be the root path of
    | your application but you are free to change this when necessary.
    |
    */

    'path' => '/',

    /*
    |--------------------------------------------------------------------------
    | Session Cookie Domain
    |--------------------------------------------------------------------------
    |
    | Here you may change the domain of the cookie used to identify a session
    | in your application. This will determine which domains the cookie is
    | available to in your application. A sensible default has been set.
    |
    */

    'domain' => env('SESSION_DOMAIN'),

    /*
    |--------------------------------------------------------------------------
    | HTTPS Only Cookies
    |--------------------------------------------------------------------------
    |
    | By setting this option to true, session cookies will only be sent back
    | to the server if the browser has a HTTPS connection. This will keep
    | the cookie from being sent to you when it can't be done securely.
    |
    */

    'secure' => env('SESSION_SECURE_COOKIE'),

    /*
    |--------------------------------------------------------------------------
    | HTTP Access Only
    |--------------------------------------------------------------------------
    |
    | Setting this value to true will prevent JavaScript from accessing the
    | value of the cookie and the cookie will only be accessible through
    | the HTTP protocol. You are free to modify this option if needed.
    |
    */

    'http_only' => true,

    /*
    |--------------------------------------------------------------------------
    | Same-Site Cookies
    |--------------------------------------------------------------------------
    |
    | This option determines how your cookies behave when cross-site requests
    | take place, and can be used to mitigate CSRF attacks. By default, we
    | will set this value to "lax" since this is a secure default value.
    |
    | Supported: "lax", "strict", "none", null
    |
    */

    'same_site' => env('SESSION_SAMESITE_COOKIE', 'lax'),
];
</file>

<file path="config/store.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Jexactyl Storefront Settings
    |--------------------------------------------------------------------------
    |
    | This configuration file is used to interact with the app in order to
    | get and set configurations for the Jexactyl Storefront.
    |
    */

    'currencies' => [
        'EUR' => 'Euro',
        'USD' => 'US Dollar',
        'JPY' => 'Japanese Yen',
        'GBP' => 'Pound Sterling',
        'CAD' => 'Canadian Dollar',
        'AUD' => 'Australian Dollar',
    ],
];
</file>

<file path="config/theme.php">
<?php

return [
    'admin' => 'dark',

    'user' => [
        'background' => '',
    ],
];
</file>

<file path="config/trustedproxy.php">
<?php

return [
    /*
     * Set trusted proxy IP addresses.
     *
     * Both IPv4 and IPv6 addresses are
     * supported, along with CIDR notation.
     *
     * The "*" character is syntactic sugar
     * within TrustedProxy to trust any proxy
     * that connects directly to your server,
     * a requirement when you cannot know the address
     * of your proxy (e.g. if using Rackspace balancers).
     *
     * The "**" character is syntactic sugar within
     * TrustedProxy to trust not just any proxy that
     * connects directly to your server, but also
     * proxies that connect to those proxies, and all
     * the way back until you reach the original source
     * IP. It will mean that $request->getClientIp()
     * always gets the originating client IP, no matter
     * how many proxies that client's request has
     * subsequently passed through.
     */
    'proxies' => in_array(env('TRUSTED_PROXIES', []), ['*', '**']) ?
        env('TRUSTED_PROXIES') : explode(',', env('TRUSTED_PROXIES') ?? ''),
];
</file>

<file path="config/view.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | View Storage Paths
    |--------------------------------------------------------------------------
    |
    | Most templating systems load templates from disk. Here you may specify
    | an array of paths that should be checked for your views. Of course
    | the usual Laravel view path has already been registered for you.
    |
    */

    'paths' => [
        resource_path('views'),
    ],

    /*
    |--------------------------------------------------------------------------
    | Compiled View Path
    |--------------------------------------------------------------------------
    |
    | This option determines where all the compiled Blade templates will be
    | stored for your application. Typically, this is within the storage
    | directory. However, as usual, you are free to change this value.
    |
    */

    'compiled' => env(
        'VIEW_COMPILED_PATH',
        realpath(storage_path('framework/views'))
    ),
];
</file>

<file path="database/Factories/AllocationFactory.php">
<?php

namespace Database\Factories;

use Jexactyl\Models\Server;
use Jexactyl\Models\Allocation;
use Illuminate\Database\Eloquent\Factories\Factory;

class AllocationFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = Allocation::class;

    /**
     * Define the model's default state.
     */
    public function definition(): array
    {
        return [
            'ip' => $this->faker->unique()->ipv4,
            'port' => $this->faker->unique()->numberBetween(1024, 65535),
        ];
    }

    /**
     * Attaches the allocation to a specific server model.
     */
    public function forServer(Server $server): self
    {
        return $this->for($server)->for($server->node);
    }
}
</file>

<file path="database/Factories/ApiKeyFactory.php">
<?php

namespace Database\Factories;

use Carbon\Carbon;
use Illuminate\Support\Str;
use Jexactyl\Models\ApiKey;
use Illuminate\Database\Eloquent\Factories\Factory;

class ApiKeyFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = ApiKey::class;

    /**
     * Define the model's default state.
     */
    public function definition(): array
    {
        static $token;

        return [
            'key_type' => ApiKey::TYPE_APPLICATION,
            'identifier' => ApiKey::generateTokenIdentifier(ApiKey::TYPE_APPLICATION),
            'token' => $token ?: $token = encrypt(Str::random(ApiKey::KEY_LENGTH)),
            'allowed_ips' => null,
            'memo' => 'Test Function Key',
            'created_at' => Carbon::now(),
            'updated_at' => Carbon::now(),
        ];
    }
}
</file>

<file path="database/Factories/BackupFactory.php">
<?php

namespace Database\Factories;

use Ramsey\Uuid\Uuid;
use Carbon\CarbonImmutable;
use Jexactyl\Models\Backup;
use Illuminate\Database\Eloquent\Factories\Factory;

class BackupFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = Backup::class;

    /**
     * Define the model's default state.
     */
    public function definition(): array
    {
        return [
            'uuid' => Uuid::uuid4()->toString(),
            'name' => $this->faker->sentence,
            'disk' => Backup::ADAPTER_WINGS,
            'is_successful' => true,
            'created_at' => CarbonImmutable::now(),
            'completed_at' => CarbonImmutable::now(),
        ];
    }
}
</file>

<file path="database/Factories/DatabaseFactory.php">
<?php

namespace Database\Factories;

use Carbon\Carbon;
use Illuminate\Support\Str;
use Jexactyl\Models\Database;
use Illuminate\Database\Eloquent\Factories\Factory;

class DatabaseFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = Database::class;

    /**
     * Define the model's default state.
     */
    public function definition(): array
    {
        static $password;

        return [
            'database' => Str::random(10),
            'username' => Str::random(10),
            'remote' => '%',
            'password' => $password ?: encrypt('test123'),
            'created_at' => Carbon::now(),
            'updated_at' => Carbon::now(),
        ];
    }
}
</file>

<file path="database/Factories/DatabaseHostFactory.php">
<?php

namespace Database\Factories;

use Jexactyl\Models\DatabaseHost;
use Illuminate\Support\Facades\Crypt;
use Illuminate\Database\Eloquent\Factories\Factory;

class DatabaseHostFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = DatabaseHost::class;

    /**
     * Define the model's default state.
     */
    public function definition(): array
    {
        return [
            'name' => $this->faker->colorName,
            'host' => $this->faker->unique()->ipv4,
            'port' => 3306,
            'username' => $this->faker->colorName,
            'password' => Crypt::encrypt($this->faker->word),
        ];
    }
}
</file>

<file path="database/Factories/EggFactory.php">
<?php

namespace Database\Factories;

use Ramsey\Uuid\Uuid;
use Jexactyl\Models\Egg;
use Illuminate\Database\Eloquent\Factories\Factory;

class EggFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = Egg::class;

    /**
     * Define the model's default state.
     */
    public function definition(): array
    {
        return [
            'uuid' => Uuid::uuid4()->toString(),
            'name' => $this->faker->name,
            'description' => implode(' ', $this->faker->sentences()),
            'startup' => 'java -jar test.jar',
        ];
    }
}
</file>

<file path="database/Factories/EggVariableFactory.php">
<?php

namespace Database\Factories;

use Illuminate\Support\Str;
use Jexactyl\Models\EggVariable;
use Illuminate\Database\Eloquent\Factories\Factory;

class EggVariableFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = EggVariable::class;

    /**
     * Define the model's default state.
     */
    public function definition(): array
    {
        return [
            'name' => $this->faker->unique()->firstName,
            'description' => $this->faker->sentence(),
            'env_variable' => Str::upper(Str::replaceArray(' ', ['_'], $this->faker->words(2, true))),
            'default_value' => $this->faker->colorName,
            'user_viewable' => 0,
            'user_editable' => 0,
            'rules' => 'required|string',
        ];
    }

    /**
     * Indicate that the egg variable is viewable.
     */
    public function viewable(): Factory
    {
        return $this->state(function (array $attributes) {
            return [
                'user_viewable' => 1,
            ];
        });
    }

    /**
     * Indicate that the egg variable is editable.
     */
    public function editable(): Factory
    {
        return $this->state(function (array $attributes) {
            return [
                'user_editable' => 1,
            ];
        });
    }
}
</file>

<file path="database/Factories/LocationFactory.php">
<?php

namespace Database\Factories;

use Illuminate\Support\Str;
use Jexactyl\Models\Location;
use Illuminate\Database\Eloquent\Factories\Factory;

class LocationFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = Location::class;

    /**
     * Define the model's default state.
     */
    public function definition(): array
    {
        return [
            'short' => Str::random(8),
            'long' => Str::random(32),
        ];
    }
}
</file>

<file path="database/Factories/NestFactory.php">
<?php

namespace Database\Factories;

use Ramsey\Uuid\Uuid;
use Jexactyl\Models\Nest;
use Illuminate\Database\Eloquent\Factories\Factory;

class NestFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = Nest::class;

    /**
     * Define the model's default state.
     */
    public function definition(): array
    {
        return [
            'uuid' => Uuid::uuid4()->toString(),
            'author' => 'testauthor@example.com',
            'name' => $this->faker->word,
            'description' => null,
        ];
    }
}
</file>

<file path="database/Factories/NodeFactory.php">
<?php

namespace Database\Factories;

use Ramsey\Uuid\Uuid;
use Jexactyl\Models\Node;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Crypt;
use Illuminate\Database\Eloquent\Factories\Factory;

class NodeFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = Node::class;

    /**
     * Define the model's default state.
     */
    public function definition(): array
    {
        return [
            'uuid' => Uuid::uuid4()->toString(),
            'public' => true,
            'name' => 'FactoryNode_' . Str::random(10),
            'fqdn' => $this->faker->unique()->ipv4,
            'scheme' => 'http',
            'behind_proxy' => false,
            'memory' => 1024,
            'memory_overallocate' => 0,
            'disk' => 10240,
            'disk_overallocate' => 0,
            'upload_size' => 100,
            'daemon_token_id' => Str::random(Node::DAEMON_TOKEN_ID_LENGTH),
            'daemon_token' => Crypt::encrypt(Str::random(Node::DAEMON_TOKEN_LENGTH)),
            'daemonListen' => 8080,
            'daemonSFTP' => 2022,
            'daemonBase' => '/var/lib/Jexactyl/volumes',
        ];
    }
}
</file>

<file path="database/Factories/ScheduleFactory.php">
<?php

namespace Database\Factories;

use Jexactyl\Models\Schedule;
use Illuminate\Database\Eloquent\Factories\Factory;

class ScheduleFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = Schedule::class;

    /**
     * Define the model's default state.
     */
    public function definition(): array
    {
        return [
            'name' => $this->faker->firstName(),
        ];
    }
}
</file>

<file path="database/Factories/ServerFactory.php">
<?php

namespace Database\Factories;

use Carbon\Carbon;
use Ramsey\Uuid\Uuid;
use Illuminate\Support\Str;
use Jexactyl\Models\Server;
use Illuminate\Database\Eloquent\Factories\Factory;

class ServerFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = Server::class;

    /**
     * Define the model's default state.
     *
     * @return array
     */
    public function definition()
    {
        return [
            'uuid' => Uuid::uuid4()->toString(),
            'uuidShort' => Str::lower(Str::random(8)),
            'name' => $this->faker->firstName,
            'description' => implode(' ', $this->faker->sentences()),
            'skip_scripts' => 0,
            'status' => null,
            'memory' => 512,
            'swap' => 0,
            'disk' => 512,
            'io' => 500,
            'cpu' => 0,
            'threads' => null,
            'oom_disabled' => 0,
            'startup' => '/bin/bash echo "hello world"',
            'image' => 'foo/bar:latest',
            'allocation_limit' => null,
            'database_limit' => null,
            'backup_limit' => 0,
            'created_at' => Carbon::now(),
            'updated_at' => Carbon::now(),
        ];
    }
}
</file>

<file path="database/Factories/SubuserFactory.php">
<?php

namespace Database\Factories;

use Jexactyl\Models\Subuser;
use Jexactyl\Models\Permission;
use Illuminate\Database\Eloquent\Factories\Factory;

class SubuserFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = Subuser::class;

    /**
     * Define the model's default state.
     */
    public function definition(): array
    {
        return [
            'permissions' => [
                Permission::ACTION_WEBSOCKET_CONNECT,
            ],
        ];
    }
}
</file>

<file path="database/Factories/TaskFactory.php">
<?php

namespace Database\Factories;

use Illuminate\Database\Eloquent\Factories\Factory;

class TaskFactory extends Factory
{
    /**
     * Define the model's default state.
     */
    public function definition(): array
    {
        return [
            'sequence_id' => $this->faker->numberBetween(1, 10),
            'action' => 'command',
            'payload' => 'test command',
            'time_offset' => 120,
            'is_queued' => false,
        ];
    }
}
</file>

<file path="database/Factories/UserFactory.php">
<?php

namespace Database\Factories;

use Carbon\Carbon;
use Ramsey\Uuid\Uuid;
use Jexactyl\Models\User;
use Illuminate\Support\Str;
use Illuminate\Database\Eloquent\Factories\Factory;

class UserFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = User::class;

    /**
     * Define the model's default state.
     */
    public function definition(): array
    {
        static $password;

        return [
            'external_id' => null,
            'uuid' => Uuid::uuid4()->toString(),
            'username' => $this->faker->userName . '_' . Str::random(10),
            'email' => Str::random(32) . '@example.com',
            'name_first' => $this->faker->firstName,
            'name_last' => $this->faker->lastName,
            'password' => $password ?: $password = bcrypt('password'),
            'language' => 'en',
            'root_admin' => false,
            'use_totp' => false,
            'created_at' => Carbon::now(),
            'updated_at' => Carbon::now(),
        ];
    }

    /**
     * Indicate that the user is an admin.
     */
    public function admin(): Factory
    {
        return $this->state(['root_admin' => true]);
    }
}
</file>

<file path="database/Factories/UserSSHKeyFactory.php">
<?php

namespace Database\Factories;

use phpseclib3\Crypt\PublicKeyLoader;
use Illuminate\Database\Eloquent\Factories\Factory;

class UserSSHKeyFactory extends Factory
{
    /**
     * Some fake public keys generated for test purposes.
     *
     * @var string[]
     */
    protected static array $keys = [
        'dsa' => 'ssh-dss AAAAB3NzaC1kc3MAAACBAPfiWwEFvBOafdUmHDPjXsUttt+65FHSZSCVVeEFOTaL7Y3d0CJyrtck8KS1vmXHSb8QFBY2B1yVSb/reaQvNreWZN3KDYfLbF57/zimBn+IrHrJR+ZglhOxDRHoGPWK7q9jYIrOLwoOjkNKXxz1eOHKUgufFfSNtIRLycEXczLrAAAAFQC6LnBErezotG52jN4JostfC/TfEwAAAIACuTxRzYFDXHAxFICeqqY9w+y+v2yQfdeQ1BgCq2GMagUYfOdqnjizTO9M614r/nXZK1SV10TqhUcQtkJzDQIUtBqzBF5cIC/1cIFKzXi5rNHs8Y4bz/PBD+EbQJdiy+1so1oi790r710bqnkzTravAOJ5rGyfuQRLt+f+kuS9NAAAAIEA7tjGtJuXGUtPIXfnrMYS1iOWryO4irqnvaWfel002/DaGaNjRghNe/cUBYlAsjPhGJ1F7BQlLAY1koliTY6l0svs7ZPBM5QOumrr8OaNXGGVIq/RkkxuZHmRoUL2qH3DGYaktPUn4vFPliiAmGWOHAEu1K6B4g4vG/SKgMRpIvc=',
        'rsa_2048' => 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAAgQC4VVsHFO5MxvCtAPyoKGANWyuwZ4fvllvFog5RJbfpDpw8etDFVGEXl+uRR8p79g9oV7MscoFo6HiWrJc4/4vlP665msjosILdIcbnuzMhvXnKisaGh9zflkpyR3KhUxoHxqYp2q8XtffjKKAHz1a8o7OUG6fwaKIqu+d0PoICZQ==',
        'rsa_4096' => 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCo/YLm2SPSlOIG7AagBSmEe5c0b2PLPzUGFp3gARhD6n6ydBS40TlWzeg2qV95lh6fWBd8LsNgPOFmmuKuNZdBjAGeTY4gxKfHY1vK5/zOI4jPPqAMcCMNfd82aM97kx6dO8Hw1R79OyVpOZylpXLHayVPGHUK37Tpih4W7TeVSMrOqQF9F72lzhwgEtkdjm4gLBL6RpdNXrdnjIaNVnuade0Sb3w384vecZPe+S/997WirOMNy2JU4NdMHEnSjd1/i463RpN96AsXFAu1zl9nrXVhA7DVfSHoigXAqbs/xav8PRpLgAKjYpPohxQ9Nu6tP5jRUhfWdYwNFFp/aWloD/0JdP9LqcBBc9sO9TLkz3fBiUf11VM/QT1UhO84G+ahMxVn95jA472VPUe8uKff69lzbvSavEE6qcQX2TzVKOSi1E26Fzc6IZ/tHEuGEbGFxTsiQ1GysVZ0wr1p6ftd1SVqH5F/oaEK7UO8+xn/syEqaPf6A0eJWRNc0+lHA1sIRjmo9MOBvbkKExkx5JLHgGG81DYDFdZUuHY1BgSxJJcmNWV5BKRm350EbgRngoYI5tB3tCiZVW1PI8qyff9mBae11LY5GPlUeDnPrMvSdCKMIWrg7nC8SbndBCO3Fx4z7G2dTQy4ZmY7Ae9jR4pyg7tTOI3qgl8Z462GZi/jzw==',
        'ed25519' => 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOaXIq09NH4a93EVdrvHYiZ67Wj+GBEBQ9ou4W0qSYm2',
    ];

    /**
     * Returns a fake public key for use on the system.
     *
     * @return array
     */
    public function definition()
    {
        $key = PublicKeyLoader::loadPublicKey(static::$keys['ed25519']);

        return [
            'name' => $this->faker->name(),
            'public_key' => $key->toString('PKCS8'),
            'fingerprint' => $key->getFingerprint('sha256'),
        ];
    }

    /**
     * Returns a DSA public key.
     */
    public function dsa(): self
    {
        $key = PublicKeyLoader::loadPublicKey(static::$keys['dsa']);

        return $this->state([
            'public_key' => $key->toString('PKCS8'),
            'fingerprint' => $key->getFingerprint('sha256'),
        ]);
    }

    /**
     * Returns an RSA public key, if "weak" is specified a 1024-bit RSA key is returned
     * which should fail validation when being stored.
     */
    public function rsa(bool $weak = false): self
    {
        $key = PublicKeyLoader::loadPublicKey(static::$keys[$weak ? 'rsa_2048' : 'rsa_4096']);

        return $this->state([
            'public_key' => $key->toString('PKCS8'),
            'fingerprint' => $key->getFingerprint('sha256'),
        ]);
    }
}
</file>

<file path="database/migrations/2016_01_23_195641_add_allocations_table.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddAllocationsTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('allocations', function (Blueprint $table) {
            $table->increments('id');
            $table->mediumInteger('node')->unsigned();
            $table->string('ip');
            $table->mediumInteger('port')->unsigned();
            $table->mediumInteger('assigned_to')->unsigned()->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('allocations');
    }
}
</file>

<file path="database/migrations/2016_01_23_195851_add_api_keys.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddApiKeys extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('api_keys', function (Blueprint $table) {
            $table->increments('id');
            $table->char('public', 16);
            $table->text('secret');
            $table->text('allowed_ips')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('api_keys');
    }
}
</file>

<file path="database/migrations/2016_01_23_200044_add_api_permissions.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddApiPermissions extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('api_permissions', function (Blueprint $table) {
            $table->increments('id');
            $table->mediumInteger('key_id')->unsigned();
            $table->string('permission');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('api_permissions');
    }
}
</file>

<file path="database/migrations/2016_01_23_200159_add_downloads.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddDownloads extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('downloads', function (Blueprint $table) {
            $table->increments('id');
            $table->char('token', 36)->unique();
            $table->char('server', 36);
            $table->text('path');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('downloads');
    }
}
</file>

<file path="database/migrations/2016_01_23_200421_create_failed_jobs_table.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateFailedJobsTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('failed_jobs', function (Blueprint $table) {
            $table->increments('id');
            $table->text('connection');
            $table->text('queue');
            $table->longText('payload');
            $table->timestamp('failed_at');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('failed_jobs');
    }
}
</file>

<file path="database/migrations/2016_01_23_200440_create_jobs_table.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateJobsTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('jobs', function (Blueprint $table) {
            $table->bigIncrements('id');
            $table->string('queue');
            $table->longText('payload');
            $table->tinyInteger('attempts')->unsigned();
            $table->tinyInteger('reserved')->unsigned();
            $table->unsignedInteger('reserved_at')->nullable();
            $table->unsignedInteger('available_at');
            $table->unsignedInteger('created_at');
            $table->index(['queue', 'reserved', 'reserved_at']);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('jobs');
    }
}
</file>

<file path="database/migrations/2016_01_23_200528_add_locations.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddLocations extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('locations', function (Blueprint $table) {
            $table->increments('id');
            $table->string('short')->unique();
            $table->string('long');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('locations');
    }
}
</file>

<file path="database/migrations/2016_01_23_200648_add_nodes.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddNodes extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('nodes', function (Blueprint $table) {
            $table->increments('id');
            $table->smallInteger('public')->unsigned();
            $table->string('name');
            $table->mediumInteger('location')->unsigned();
            $table->string('fqdn');
            $table->string('scheme')->default('https');
            $table->integer('memory')->unsigned();
            $table->mediumInteger('memory_overallocate')->unsigned()->nullable();
            $table->integer('disk')->unsigned();
            $table->mediumInteger('disk_overallocate')->unsigned()->nullable();
            $table->char('daemonSecret', 36)->unique();
            $table->smallInteger('daemonListen')->unsigned()->default(8080);
            $table->smallInteger('daemonSFTP')->unsgined()->default(2022);
            $table->string('daemonBase')->default('/home/daemon-files');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('nodes');
    }
}
</file>

<file path="database/migrations/2016_01_23_201433_add_password_resets.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddPasswordResets extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('password_resets', function (Blueprint $table) {
            $table->string('email')->index();
            $table->string('token')->index();
            $table->timestamp('created_at');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('password_resets');
    }
}
</file>

<file path="database/migrations/2016_01_23_201531_add_permissions.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddPermissions extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('permissions', function (Blueprint $table) {
            $table->increments('id');
            $table->integer('user_id')->unsigned();
            $table->integer('server_id')->unsigned();
            $table->string('permissions');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('permissions');
    }
}
</file>

<file path="database/migrations/2016_01_23_201649_add_server_variables.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddServerVariables extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('server_variables', function (Blueprint $table) {
            $table->increments('id');
            $table->mediumInteger('server_id')->unsigned();
            $table->mediumInteger('variable_id')->unsigned();
            $table->string('variable_value');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('server_variables');
    }
}
</file>

<file path="database/migrations/2016_01_23_201748_add_servers.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddServers extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('servers', function (Blueprint $table) {
            $table->increments('id');
            $table->char('uuid', 36)->unique();
            $table->char('uuidShort', 8)->unique();
            $table->mediumInteger('node')->unsigned();
            $table->string('name');
            $table->tinyInteger('active')->unsigned();
            $table->mediumInteger('owner')->unsigned();
            $table->integer('memory')->unsigned();
            $table->integer('swap')->unsigned();
            $table->integer('disk')->unsigned();
            $table->integer('io')->unsigned();
            $table->integer('cpu')->unsigned();
            $table->tinyInteger('oom_disabled')->unsigned()->default(0);
            $table->string('ip');
            $table->integer('port')->unsigned();
            $table->mediumInteger('service')->unsigned();
            $table->mediumInteger('option')->unsigned();
            $table->text('startup');
            $table->char('daemonSecret', 36)->unique();
            $table->string('username')->unique();
            $table->tinyInteger('installed')->unsigned()->default(0);
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('servers');
    }
}
</file>

<file path="database/migrations/2016_01_23_202544_add_service_options.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddServiceOptions extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('service_options', function (Blueprint $table) {
            $table->increments('id');
            $table->mediumInteger('parent_service')->unsigned();
            $table->string('name');
            $table->text('description');
            $table->string('tag');
            $table->text('docker_image');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('service_options');
    }
}
</file>

<file path="database/migrations/2016_01_23_202731_add_service_varibles.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddServiceVaribles extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('service_variables', function (Blueprint $table) {
            $table->increments('id');
            $table->mediumInteger('option_id')->unsigned();
            $table->string('name');
            $table->text('description');
            $table->string('env_variable');
            $table->string('default_value');
            $table->tinyInteger('user_viewable')->unsigned();
            $table->tinyInteger('user_editable')->unsigned();
            $table->tinyInteger('required')->unsigned();
            $table->string('regex')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('service_variables');
    }
}
</file>

<file path="database/migrations/2016_01_23_202943_add_services.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddServices extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('services', function (Blueprint $table) {
            $table->increments('id');
            $table->string('name');
            $table->text('description');
            $table->string('file');
            $table->string('executable');
            $table->text('startup');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('services');
    }
}
</file>

<file path="database/migrations/2016_01_23_203119_create_settings_table.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateSettingsTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('settings', function (Blueprint $table) {
            $table->string('key')->unique();
            $table->text('value');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('settings');
    }
}
</file>

<file path="database/migrations/2016_01_23_203150_add_subusers.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddSubusers extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('subusers', function (Blueprint $table) {
            $table->increments('id');
            $table->integer('user_id')->unsigned();
            $table->integer('server_id')->unsigned();
            $table->char('daemonSecret', 36)->unique();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('subusers');
    }
}
</file>

<file path="database/migrations/2016_01_23_203159_add_users.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddUsers extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('users', function (Blueprint $table) {
            $table->increments('id');
            $table->char('uuid', 36)->unique();
            $table->string('email')->unique();
            $table->text('password');
            $table->string('remember_token')->nullable();
            $table->char('language', 5)->default('en');
            $table->tinyInteger('root_admin')->unsigned()->default(0);
            $table->tinyInteger('use_totp')->unsigned();
            $table->char('totp_secret', 16)->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('users');
    }
}
</file>

<file path="database/migrations/2016_01_23_203947_create_sessions_table.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateSessionsTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('sessions', function (Blueprint $table) {
            $table->string('id')->unique();
            $table->integer('user_id')->nullable();
            $table->string('ip_address', 45)->nullable();
            $table->text('user_agent')->nullable();
            $table->text('payload');
            $table->integer('last_activity');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::drop('sessions');
    }
}
</file>

<file path="database/migrations/2016_01_25_234418_rename_permissions_column.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class RenamePermissionsColumn extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('permissions', function (Blueprint $table) {
            $table->renameColumn('permissions', 'permission');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('permissions', function (Blueprint $table) {
        });
    }
}
</file>

<file path="database/migrations/2016_02_07_172148_add_databases_tables.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddDatabasesTables extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('databases', function (Blueprint $table) {
            $table->increments('id');
            $table->integer('server')->unsigned();
            $table->integer('db_server')->unsigned();
            $table->string('database')->unique();
            $table->string('username')->unique();
            $table->string('remote')->default('%');
            $table->text('password');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::drop('databases');
    }
}
</file>

<file path="database/migrations/2016_02_07_181319_add_database_servers_table.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddDatabaseServersTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('database_servers', function (Blueprint $table) {
            $table->increments('id');
            $table->string('name');
            $table->string('host');
            $table->integer('port')->unsigned();
            $table->string('username');
            $table->text('password');
            $table->integer('max_databases')->unsigned()->nullable();
            $table->integer('linked_node')->unsigned()->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::drop('database_servers');
    }
}
</file>

<file path="database/migrations/2016_02_13_154306_add_service_option_default_startup.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddServiceOptionDefaultStartup extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('service_options', function (Blueprint $table) {
            $table->text('executable')->after('docker_image')->nullable()->default(null);
            $table->text('startup')->after('executable')->nullable()->default(null);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('service_options', function (Blueprint $table) {
            $table->dropColumn('executable');
            $table->dropColumn('startup');
        });
    }
}
</file>

<file path="database/migrations/2016_02_20_155318_add_unique_service_field.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddUniqueServiceField extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('services', function (Blueprint $table) {
            $table->string('file')->unique()->change();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('services', function (Blueprint $table) {
            $table->dropUnique('services_file_unique');
        });
    }
}
</file>

<file path="database/migrations/2016_02_27_163411_add_tasks_table.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddTasksTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('tasks', function (Blueprint $table) {
            $table->increments('id');
            $table->integer('server')->unsigned();
            $table->tinyInteger('active')->default(1);
            $table->string('action');
            $table->text('data');
            $table->tinyInteger('queued')->unsigned()->default(0);
            $table->string('year')->default('*');
            $table->string('day_of_week')->default('*');
            $table->string('month')->default('*');
            $table->string('day_of_month')->default('*');
            $table->string('hour')->default('*');
            $table->string('minute')->default('*');
            $table->timestamp('last_run')->nullable();
            $table->timestamp('next_run')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::drop('tasks');
    }
}
</file>

<file path="database/migrations/2016_02_27_163447_add_tasks_log_table.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddTasksLogTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('tasks_log', function (Blueprint $table) {
            $table->increments('id');
            $table->integer('task_id')->unsigned();
            $table->timestamp('run_time');
            $table->integer('run_status')->unsigned();
            $table->text('response');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::drop('tasks_log');
    }
}
</file>

<file path="database/migrations/2016_03_18_155649_add_nullable_field_lastrun.php">
<?php

use Illuminate\Database\Migrations\Migration;

class AddNullableFieldLastrun extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        $table = DB::getQueryGrammar()->wrapTable('tasks');
        DB::statement('ALTER TABLE ' . $table . ' CHANGE `last_run` `last_run` TIMESTAMP NULL;');
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        $table = DB::getQueryGrammar()->wrapTable('tasks');
        DB::statement('ALTER TABLE ' . $table . ' CHANGE `last_run` `last_run` TIMESTAMP;');
    }
}
</file>

<file path="database/migrations/2016_08_30_212718_add_ip_alias.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddIpAlias extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('allocations', function (Blueprint $table) {
            $table->text('ip_alias')->nullable()->after('ip');
        });

        $allocations = DB::select('SELECT id, ip FROM allocations');
        foreach ($allocations as $allocation) {
            DB::update(
                'UPDATE allocations SET ip_alias = :ip WHERE id = :id',
                [
                    'ip' => $allocation->ip,
                    'id' => $allocation->id,
                ]
            );
        }
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('allocations', function (Blueprint $table) {
            $table->dropColumn('ip_alias');
        });
    }
}
</file>

<file path="database/migrations/2016_08_30_213301_modify_ip_storage_method.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class ModifyIpStorageMethod extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->mediumInteger('allocation')->unsigned()->after('oom_disabled');
        });

        // Parse All Servers
        $servers = DB::select('SELECT id, ip, port, node FROM servers');
        foreach ($servers as $server) {
            $allocation = DB::select(
                'SELECT id FROM allocations WHERE ip = :ip AND port = :port AND node = :node',
                [
                    'ip' => $server->ip,
                    'port' => $server->port,
                    'node' => $server->node,
                ]
            );

            if (isset($allocation[0])) {
                DB::update(
                    'UPDATE servers SET allocation = :alocid WHERE id = :id',
                    [
                        'alocid' => $allocation[0]->id,
                        'id' => $server->id,
                    ]
                );
            }
        }

        // Updated the server allocations, remove old fields
        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn('ip');
            $table->dropColumn('port');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->text('ip')->after('allocation');
            $table->integer('port')->unsigned()->after('ip');
        });

        // Find the allocations and reset the servers...
        $servers = DB::select('SELECT id, allocation FROM servers');
        foreach ($servers as $server) {
            $allocation = DB::select('SELECT * FROM allocations WHERE id = :alocid', ['alocid' => $server->allocation]);

            if (isset($allocation[0])) {
                DB::update(
                    'UPDATE servers SET ip = :ip, port = :port WHERE id = :id',
                    [
                        'ip' => $allocation[0]->ip,
                        'port' => $allocation[0]->port,
                        'id' => $server->id,
                    ]
                );
            }
        }

        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn('allocation');
        });
    }
}
</file>

<file path="database/migrations/2016_09_01_193520_add_suspension_for_servers.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddSuspensionForServers extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->tinyInteger('suspended')->unsigned()->default(0)->after('active');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn('suspended');
        });
    }
}
</file>

<file path="database/migrations/2016_09_01_211924_remove_active_column.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class RemoveActiveColumn extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn('active');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->tinyInteger('active')->after('name')->unsigned()->default(0);
        });
    }
}
</file>

<file path="database/migrations/2016_09_02_190647_add_sftp_password_storage.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddSftpPasswordStorage extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->text('sftp_password')->after('username')->nullable();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn('sftp_password');
        });
    }
}
</file>

<file path="database/migrations/2016_09_04_171338_update_jobs_tables.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class UpdateJobsTables extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('jobs', function (Blueprint $table) {
            $table->dropIndex('jobs_queue_reserved_reserved_at_index');
            $table->dropColumn('reserved');
            $table->index(['queue', 'reserved_at']);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('jobs', function (Blueprint $table) {
            $table->dropIndex('jobs_queue_reserved_at_index');
            $table->tinyInteger('reserved')->unsigned();
            $table->index(['queue', 'reserved', 'reserved_at']);
        });
    }
}
</file>

<file path="database/migrations/2016_09_04_172028_update_failed_jobs_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class UpdateFailedJobsTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('failed_jobs', function (Blueprint $table) {
            $table->text('exception');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('failed_jobs', function (Blueprint $table) {
            $table->dropColumn('exception');
        });
    }
}
</file>

<file path="database/migrations/2016_09_04_182835_create_notifications_table.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateNotificationsTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('notifications', function (Blueprint $table) {
            $table->string('id')->primary();
            $table->string('type');
            $table->morphs('notifiable');
            $table->text('data');
            $table->timestamp('read_at')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::drop('notifications');
    }
}
</file>

<file path="database/migrations/2016_09_07_163017_add_unique_identifier.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddUniqueIdentifier extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('services', function (Blueprint $table) {
            $table->char('author', 36)->after('id');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('services', function (Blueprint $table) {
            $table->dropColumn('author');
        });
    }
}
</file>

<file path="database/migrations/2016_09_14_145945_allow_longer_regex_field.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AllowLongerRegexField extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('service_variables', function (Blueprint $table) {
            $table->text('regex')->change();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('service_variables', function (Blueprint $table) {
            $table->string('regex')->change();
        });
    }
}
</file>

<file path="database/migrations/2016_09_17_194246_add_docker_image_column.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddDockerImageColumn extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->string('image')->after('daemonSecret');
        });

        // Populate the column
        DB::transaction(function () {
            $servers = DB::table('servers')->select(
                'servers.id',
                'service_options.docker_image as s_optionImage'
            )->join('service_options', 'service_options.id', '=', 'servers.option')->get();

            foreach ($servers as $server) {
                $server->image = $server->s_optionImage;
                $server->save();
            }
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn('image');
        });
    }
}
</file>

<file path="database/migrations/2016_09_21_165554_update_servers_column_name.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class UpdateServersColumnName extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('databases', function (Blueprint $table) {
            $table->renameColumn('server', 'server_id');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('databases', function (Blueprint $table) {
            $table->renameColumn('server_id', 'server');
        });
    }
}
</file>

<file path="database/migrations/2016_09_29_213518_rename_double_insurgency.php">
<?php

use Illuminate\Database\Migrations\Migration;

class RenameDoubleInsurgency extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        DB::transaction(function () {
            $model = DB::table('service_options')->where('parent_service', 2)->where('id', 3)->where('name', 'Insurgency')->first();
            if ($model) {
                $model->name = 'Team Fortress 2';
                $model->save();
            }
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
    }
}
</file>

<file path="database/migrations/2016_10_07_152117_build_api_log_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class BuildApiLogTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('api_logs', function (Blueprint $table) {
            $table->increments('id');
            $table->boolean('authorized');
            $table->text('error')->nullable();
            $table->char('key', 16)->nullable();
            $table->char('method', 6);
            $table->text('route');
            $table->text('content')->nullable();
            $table->text('user_agent');
            $table->ipAddress('request_ip');
            $table->timestampsTz();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::drop('api_logs');
    }
}
</file>

<file path="database/migrations/2016_10_14_164802_update_api_keys.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class UpdateApiKeys extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('api_keys', function (Blueprint $table) {
            $table->unsignedInteger('user')->after('id');
            $table->text('memo')->after('allowed_ips')->nullable();
            $table->timestamp('expires_at')->after('memo')->nullable();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('api_keys', function (Blueprint $table) {
            $table->dropColumn('user');
            $table->dropColumn('memo');
            $table->dropColumn('expires_at');
        });
    }
}
</file>

<file path="database/migrations/2016_10_23_181719_update_misnamed_bungee.php">
<?php

use Illuminate\Database\Migrations\Migration;

class UpdateMisnamedBungee extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        DB::table('service_variables')->select('env_variable')->where('env_variable', 'BUNGE_VERSION')->update([
            'env_variable' => 'BUNGEE_VERSION',
        ]);
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
    }
}
</file>

<file path="database/migrations/2016_10_23_193810_add_foreign_keys_servers.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForeignKeysServers extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        DB::statement('ALTER TABLE servers
            MODIFY COLUMN node INT(10) UNSIGNED NOT NULL,
            MODIFY COLUMN owner INT(10) UNSIGNED NOT NULL,
            MODIFY COLUMN allocation INT(10) UNSIGNED NOT NULL,
            MODIFY COLUMN service INT(10) UNSIGNED NOT NULL,
            MODIFY COLUMN `option` INT(10) UNSIGNED NOT NULL
        ');

        Schema::table('servers', function (Blueprint $table) {
            $table->foreign('node')->references('id')->on('nodes');
            $table->foreign('owner')->references('id')->on('users');
            $table->foreign('allocation')->references('id')->on('allocations');
            $table->foreign('service')->references('id')->on('services');
            $table->foreign('option')->references('id')->on('service_options');
            $table->softDeletes();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropForeign('servers_node_foreign');
            $table->dropForeign('servers_owner_foreign');
            $table->dropForeign('servers_allocation_foreign');
            $table->dropForeign('servers_service_foreign');
            $table->dropForeign('servers_option_foreign');

            $table->dropIndex('servers_node_foreign');
            $table->dropIndex('servers_owner_foreign');
            $table->dropIndex('servers_allocation_foreign');
            $table->dropIndex('servers_service_foreign');
            $table->dropIndex('servers_option_foreign');

            $table->dropColumn('deleted_at');
        });

        DB::statement('ALTER TABLE servers
            MODIFY COLUMN node MEDIUMINT(8) UNSIGNED NOT NULL,
            MODIFY COLUMN owner MEDIUMINT(8) UNSIGNED NOT NULL,
            MODIFY COLUMN allocation MEDIUMINT(8) UNSIGNED NOT NULL,
            MODIFY COLUMN service MEDIUMINT(8) UNSIGNED NOT NULL,
            MODIFY COLUMN `option` MEDIUMINT(8) UNSIGNED NOT NULL
        ');
    }
}
</file>

<file path="database/migrations/2016_10_23_201624_add_foreign_allocations.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForeignAllocations extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        DB::statement('ALTER TABLE allocations
             MODIFY COLUMN assigned_to INT(10) UNSIGNED NULL,
             MODIFY COLUMN node INT(10) UNSIGNED NOT NULL
         ');

        Schema::table('allocations', function (Blueprint $table) {
            $table->foreign('assigned_to')->references('id')->on('servers');
            $table->foreign('node')->references('id')->on('nodes');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('allocations', function (Blueprint $table) {
            $table->dropForeign('allocations_assigned_to_foreign');
            $table->dropForeign('allocations_node_foreign');

            $table->dropIndex('allocations_assigned_to_foreign');
            $table->dropIndex('allocations_node_foreign');
        });

        DB::statement('ALTER TABLE allocations
             MODIFY COLUMN assigned_to MEDIUMINT(8) UNSIGNED NULL,
             MODIFY COLUMN node MEDIUMINT(8) UNSIGNED NOT NULL
         ');
    }
}
</file>

<file path="database/migrations/2016_10_23_202222_add_foreign_api_keys.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForeignApiKeys extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('api_keys', function (Blueprint $table) {
            $table->foreign('user')->references('id')->on('users');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('api_keys', function (Blueprint $table) {
            $table->dropForeign('api_keys_user_foreign');
            $table->dropIndex('api_keys_user_foreign');
        });
    }
}
</file>

<file path="database/migrations/2016_10_23_202703_add_foreign_api_permissions.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForeignApiPermissions extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        DB::statement('ALTER TABLE api_permissions MODIFY key_id INT(10) UNSIGNED NOT NULL');

        Schema::table('api_permissions', function (Blueprint $table) {
            $table->foreign('key_id')->references('id')->on('api_keys');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('api_permissions', function (Blueprint $table) {
            $table->dropForeign('api_permissions_key_id_foreign');
            $table->dropIndex('api_permissions_key_id_foreign');
        });

        DB::statement('ALTER TABLE api_permissions MODIFY key_id MEDIUMINT(8) UNSIGNED NOT NULL');
    }
}
</file>

<file path="database/migrations/2016_10_23_202953_add_foreign_database_servers.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForeignDatabaseServers extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('database_servers', function (Blueprint $table) {
            $table->foreign('linked_node')->references('id')->on('nodes');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('database_servers', function (Blueprint $table) {
            $table->dropForeign('database_servers_linked_node_foreign');
            $table->dropIndex('database_servers_linked_node_foreign');
        });
    }
}
</file>

<file path="database/migrations/2016_10_23_203105_add_foreign_databases.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForeignDatabases extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('databases', function (Blueprint $table) {
            $table->foreign('server_id')->references('id')->on('servers');
            $table->foreign('db_server')->references('id')->on('database_servers');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('databases', function (Blueprint $table) {
            $table->dropForeign('databases_server_id_foreign');
            $table->dropForeign('databases_db_server_foreign');

            $table->dropIndex('databases_server_id_foreign');
            $table->dropIndex('databases_db_server_foreign');
        });
    }
}
</file>

<file path="database/migrations/2016_10_23_203335_add_foreign_nodes.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForeignNodes extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        DB::statement('ALTER TABLE nodes MODIFY location INT(10) UNSIGNED NOT NULL');

        Schema::table('nodes', function (Blueprint $table) {
            $table->foreign('location')->references('id')->on('locations');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->dropForeign('nodes_location_foreign');
            $table->dropIndex('nodes_location_foreign');
        });

        DB::statement('ALTER TABLE nodes MODIFY location MEDIUMINT(10) UNSIGNED NOT NULL');
    }
}
</file>

<file path="database/migrations/2016_10_23_203522_add_foreign_permissions.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForeignPermissions extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('permissions', function (Blueprint $table) {
            $table->foreign('user_id')->references('id')->on('users');
            $table->foreign('server_id')->references('id')->on('servers');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('permissions', function (Blueprint $table) {
            $table->dropForeign('permissions_user_id_foreign');
            $table->dropForeign('permissions_server_id_foreign');

            $table->dropIndex('permissions_user_id_foreign');
            $table->dropIndex('permissions_server_id_foreign');
        });
    }
}
</file>

<file path="database/migrations/2016_10_23_203857_add_foreign_server_variables.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForeignServerVariables extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        DB::statement('ALTER TABLE server_variables
            MODIFY COLUMN server_id INT(10) UNSIGNED NULL,
            MODIFY COLUMN variable_id INT(10) UNSIGNED NOT NULL
        ');

        Schema::table('server_variables', function (Blueprint $table) {
            $table->foreign('server_id')->references('id')->on('servers');
            $table->foreign('variable_id')->references('id')->on('service_variables');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('server_variables', function (Blueprint $table) {
            $table->dropForeign(['server_id']);
            $table->dropForeign(['variable_id']);
        });

        DB::statement('ALTER TABLE server_variables
              MODIFY COLUMN server_id MEDIUMINT(8) UNSIGNED NULL,
              MODIFY COLUMN variable_id MEDIUMINT(8) UNSIGNED NOT NULL
          ');
    }
}
</file>

<file path="database/migrations/2016_10_23_204157_add_foreign_service_options.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForeignServiceOptions extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        DB::statement('ALTER TABLE service_options MODIFY parent_service INT(10) UNSIGNED NOT NULL');

        Schema::table('service_options', function (Blueprint $table) {
            $table->foreign('parent_service')->references('id')->on('services');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('service_options', function (Blueprint $table) {
            $table->dropForeign('service_options_parent_service_foreign');
            $table->dropIndex('service_options_parent_service_foreign');
        });

        DB::statement('ALTER TABLE service_options MODIFY parent_service MEDIUMINT(8) UNSIGNED NOT NULL');
    }
}
</file>

<file path="database/migrations/2016_10_23_204321_add_foreign_service_variables.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForeignServiceVariables extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        DB::statement('ALTER TABLE service_variables MODIFY option_id INT(10) UNSIGNED NOT NULL');

        Schema::table('service_variables', function (Blueprint $table) {
            $table->foreign('option_id')->references('id')->on('service_options');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('service_variables', function (Blueprint $table) {
            $table->dropForeign('service_variables_option_id_foreign');
            $table->dropIndex('service_variables_option_id_foreign');
        });

        DB::statement('ALTER TABLE service_variables MODIFY option_id MEDIUMINT(8) UNSIGNED NOT NULL');
    }
}
</file>

<file path="database/migrations/2016_10_23_204454_add_foreign_subusers.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForeignSubusers extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('subusers', function (Blueprint $table) {
            $table->foreign('user_id')->references('id')->on('users');
            $table->foreign('server_id')->references('id')->on('servers');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('subusers', function (Blueprint $table) {
            $table->dropForeign('subusers_user_id_foreign');
            $table->dropForeign('subusers_server_id_foreign');

            $table->dropIndex('subusers_user_id_foreign');
            $table->dropIndex('subusers_server_id_foreign');
        });
    }
}
</file>

<file path="database/migrations/2016_10_23_204610_add_foreign_tasks.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForeignTasks extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('tasks', function (Blueprint $table) {
            $table->foreign('server')->references('id')->on('servers');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('tasks', function (Blueprint $table) {
            $table->dropForeign(['server']);
        });
    }
}
</file>

<file path="database/migrations/2016_11_04_000949_add_ark_service_option_fixed.php">
<?php

use Illuminate\Database\Migrations\Migration;

class AddArkServiceOptionFixed extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        DB::transaction(function () {
            $service = DB::table('services')->select('id')->where('author', 'ptrdctyl-v040-11e6-8b77-86f30ca893d3')->where('name', 'Source Engine')->first();

            // No SRCDS Service, Skipping
            if (!$service) {
                return;
            }

            // Already have this service option installed.
            if (DB::table('service_options')->select('id')->where('name', 'Ark: Survival Evolved')->where('parent_service', $service->id)->first()) {
                return;
            }

            $oid = DB::table('service_options')->insertGetId([
                'parent_service' => $service->id,
                'name' => 'Ark: Survival Evolved',
                'description' => 'As a man or woman stranded, naked, freezing, and starving on the unforgiving shores of a mysterious island called ARK, use your skill and cunning to kill or tame and ride the plethora of leviathan dinosaurs and other primeval creatures roaming the land. Hunt, harvest resources, craft items, grow crops, research technologies, and build shelters to withstand the elements and store valuables, all while teaming up with (or preying upon) hundreds of other players to survive, dominate... and escape!  Gamepedia: ARK',
                'tag' => 'ark',
                'docker_image' => 'quay.io/Jexactyl/srcds:ark',
                'executable' => './ShooterGameServer',
                'startup' => 'TheIsland?listen?ServerPassword={{ARK_PASSWORD}}?ServerAdminPassword={{ARK_ADMIN_PASSWORD}}?Port={{SERVER_PORT}}?MaxPlayers={{SERVER_MAX_PLAYERS}}',
            ]);

            DB::table('service_variables')->insert([
                'option_id' => $oid,
                'name' => 'Server Password',
                'description' => 'If specified, players must provide this password to join the server.',
                'env_variable' => 'ARK_PASSWORD',
                'default_value' => '',
                'user_viewable' => 1,
                'user_editable' => 1,
                'required' => 0,
                'regex' => '/^(\w\.*)$/',
            ]);

            DB::table('service_variables')->insert([
                'option_id' => $oid,
                'name' => 'Admin Password',
                'description' => 'If specified, players must provide this password (via the in-game console) to gain access to administrator commands on the server.',
                'env_variable' => 'ARK_ADMIN_PASSWORD',
                'default_value' => '',
                'user_viewable' => 1,
                'user_editable' => 1,
                'required' => 0,
                'regex' => '/^(\w\.*)$/',
            ]);

            DB::table('service_variables')->insert([
                'option_id' => $oid,
                'name' => 'Maximum Players',
                'description' => 'Specifies the maximum number of players that can play on the server simultaneously.',
                'env_variable' => 'SERVER_MAX_PLAYERS',
                'default_value' => 20,
                'user_viewable' => 1,
                'user_editable' => 1,
                'required' => 1,
                'regex' => '/^(\d{1,4})$/',
            ]);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        DB::transaction(function () {
            $service = DB::table('services')->select('id')->where('author', 'ptrdctyl-v040-11e6-8b77-86f30ca893d3')->where('name', 'Source Engine')->first();

            if ($service) {
                $option = DB::table('service_options')->where('parent_service', $service->id)->where('tag', 'ark')->first();

                if ($option) {
                    $variables = DB::table('service_variables')->where('option_id', $option->id)->delete();
                }
            }
        });
    }
}
</file>

<file path="database/migrations/2016_11_11_220649_add_pack_support.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddPackSupport extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('service_packs', function (Blueprint $table) {
            $table->increments('id');
            $table->unsignedInteger('option');
            $table->char('uuid', 36)->unique();
            $table->string('name');
            $table->string('version');
            $table->text('description')->nullable();
            $table->boolean('selectable')->default(true);
            $table->boolean('visible')->default(true);
            $table->timestamps();

            $table->foreign('option')->references('id')->on('service_options');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::drop('service_packs');
    }
}
</file>

<file path="database/migrations/2016_11_11_231731_set_service_name_unique.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class SetServiceNameUnique extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('services', function (Blueprint $table) {
            $table->unique('name');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('services', function (Blueprint $table) {
            $table->dropUnique('services_name_unique');
        });
    }
}
</file>

<file path="database/migrations/2016_11_27_142519_add_pack_column.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddPackColumn extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->unsignedInteger('pack')->nullable()->after('option');

            $table->foreign('pack')->references('id')->on('service_packs');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropForeign(['pack']);
            $table->dropColumn('pack');
        });
    }
}
</file>

<file path="database/migrations/2016_12_01_173018_add_configurable_upload_limit.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddConfigurableUploadLimit extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->unsignedInteger('upload_size')->after('disk_overallocate')->default(100);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->dropColumn('upload_size');
        });
    }
}
</file>

<file path="database/migrations/2016_12_02_185206_correct_service_variables.php">
<?php

use Illuminate\Database\Migrations\Migration;

class CorrectServiceVariables extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        DB::transaction(function () {
            // Modify Default Spigot Startup Line
            DB::table('service_options')->where([
                ['name', 'Spigot'],
                ['tag', 'spigot'],
                ['startup', '-Xms128M -Xmx{{SERVER_MEMORY}}M -Djline.terminal=jline.UnsupportedTerminal -jar {{SERVER_JARFILE}}'],
            ])->update([
                'startup' => null,
            ]);

            // Correct Spigot Version Checking
            DB::table('service_variables')->where([
                ['name', 'Spigot Version'],
                ['env_variable', 'DL_VERSION'],
                ['default_value', 'latest'],
                ['regex', '/^(latest|[a-zA-Z0-9_\.-]{5,6})$/'],
            ])->update([
                'regex' => '/^(latest|[a-zA-Z0-9_\.-]{3,7})$/',
            ]);

            // Correct Vanilla Version Checking (as well as naming)
            DB::table('service_variables')->where([
                ['name', 'Server Jar File'],
                ['env_variable', 'VANILLA_VERSION'],
                ['default_value', 'latest'],
                ['regex', '/^(latest|[a-zA-Z0-9_\.-]{5,6})$/'],
            ])->update([
                'name' => 'Server Version',
                'regex' => '/^(latest|[a-zA-Z0-9_\.-]{3,7})$/',
            ]);

            // Update Sponge Version Checking and Update Default Version
            DB::table('service_variables')->where([
                ['name', 'Sponge Version'],
                ['env_variable', 'SPONGE_VERSION'],
                ['default_value', '1.8.9-4.2.0-BETA-351'],
                ['regex', '/^(.*)$/'],
            ])->update([
                'default_value' => '1.10.2-5.1.0-BETA-359',
                'regex' => '/^([a-zA-Z0-9.\-_]+)$/',
            ]);

            // Update Bungeecord Version Checking
            DB::table('service_variables')->where([
                ['name', 'Bungeecord Version'],
                ['env_variable', 'BUNGEE_VERSION'],
                ['default_value', 'latest'],
                ['regex', '/^(latest|[\d]{3,5})$/'],
            ])->update([
                'regex' => '/^(latest|[\d]{1,6})$/',
            ]);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        // do nothing
    }
}
</file>

<file path="database/migrations/2017_01_03_150436_fix_misnamed_option_tag.php">
<?php

use Illuminate\Database\Migrations\Migration;

class FixMisnamedOptionTag extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        DB::transaction(function () {
            DB::table('service_options')->where([
                ['name', 'Sponge (SpongeVanilla)'],
                ['tag', 'spigot'],
                ['docker_image', 'quay.io/Jexactyl/minecraft:sponge'],
            ])->update([
                'tag' => 'sponge',
            ]);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        DB::table('service_options')->where([
            ['name', 'Sponge (SpongeVanilla)'],
            ['tag', 'sponge'],
            ['docker_image', 'quay.io/Jexactyl/minecraft:sponge'],
        ])->update([
            'tag' => 'spigot',
        ]);
    }
}
</file>

<file path="database/migrations/2017_01_07_154228_create_node_configuration_tokens_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateNodeConfigurationTokensTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('node_configuration_tokens', function (Blueprint $table) {
            $table->increments('id');
            $table->char('token', 32);
            $table->timestamp('expires_at');
            $table->integer('node')->unsigned();
            $table->foreign('node')->references('id')->on('nodes');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('node_configuration_tokens');
    }
}
</file>

<file path="database/migrations/2017_01_12_135449_add_more_user_data.php">
<?php

use Jexactyl\Models\User;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddMoreUserData extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->string('name_first')->after('email')->nullable();
            $table->string('name_last')->after('name_first')->nullable();
            $table->string('username')->after('uuid');
            $table->boolean('gravatar')->after('totp_secret')->default(true);
        });

        DB::transaction(function () {
            foreach (User::all() as &$user) {
                $user->username = $user->email;
                $user->save();
            }
        });

        Schema::table('users', function (Blueprint $table) {
            $table->string('username')->unique()->change();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn('name_first');
            $table->dropColumn('name_last');
            $table->dropColumn('username');
            $table->dropColumn('gravatar');
        });
    }
}
</file>

<file path="database/migrations/2017_02_02_175548_UpdateColumnNames.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class UpdateColumnNames extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropForeign('servers_node_foreign');
            $table->dropForeign('servers_owner_foreign');
            $table->dropForeign('servers_allocation_foreign');
            $table->dropForeign('servers_service_foreign');
            $table->dropForeign('servers_option_foreign');
            $table->dropForeign('servers_pack_foreign');

            $table->dropIndex('servers_node_foreign');
            $table->dropIndex('servers_owner_foreign');
            $table->dropIndex('servers_allocation_foreign');
            $table->dropIndex('servers_service_foreign');
            $table->dropIndex('servers_option_foreign');
            $table->dropIndex('servers_pack_foreign');

            $table->renameColumn('node', 'node_id');
            $table->renameColumn('owner', 'owner_id');
            $table->renameColumn('allocation', 'allocation_id');
            $table->renameColumn('service', 'service_id');
            $table->renameColumn('option', 'option_id');
            $table->renameColumn('pack', 'pack_id');

            $table->foreign('node_id')->references('id')->on('nodes');
            $table->foreign('owner_id')->references('id')->on('users');
            $table->foreign('allocation_id')->references('id')->on('allocations');
            $table->foreign('service_id')->references('id')->on('services');
            $table->foreign('option_id')->references('id')->on('service_options');

            // Pack ID was forgotten until multiple releases later, therefore it is
            // contained in '2017_03_18_204953_AddForeignKeyToPacks'
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropForeign(['node_id']);
            $table->dropForeign(['owner_id']);
            $table->dropForeign(['allocation_id']);
            $table->dropForeign(['service_id']);
            $table->dropForeign(['option_id']);

            $table->renameColumn('node_id', 'node');
            $table->renameColumn('owner_id', 'owner');
            $table->renameColumn('allocation_id', 'allocation');
            $table->renameColumn('service_id', 'service');
            $table->renameColumn('option_id', 'option');
            $table->renameColumn('pack_id', 'pack');

            $table->foreign('node')->references('id')->on('nodes');
            $table->foreign('owner')->references('id')->on('users');
            $table->foreign('allocation')->references('id')->on('allocations');
            $table->foreign('service')->references('id')->on('services');
            $table->foreign('option')->references('id')->on('service_options');
            $table->foreign('pack')->references('id')->on('service_packs');
        });
    }
}
</file>

<file path="database/migrations/2017_02_03_140948_UpdateNodesTable.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class UpdateNodesTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->dropForeign('nodes_location_foreign');
            $table->dropIndex('nodes_location_foreign');

            $table->renameColumn('location', 'location_id');
            $table->foreign('location_id')->references('id')->on('locations');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->dropForeign('nodes_location_id_foreign');
            $table->dropIndex('nodes_location_id_foreign');

            $table->renameColumn('location_id', 'location');
            $table->foreign('location')->references('id')->on('locations');
        });
    }
}
</file>

<file path="database/migrations/2017_02_03_155554_RenameColumns.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class RenameColumns extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('allocations', function (Blueprint $table) {
            $table->dropForeign('allocations_node_foreign');
            $table->dropForeign('allocations_assigned_to_foreign');
            $table->dropIndex('allocations_node_foreign');
            $table->dropIndex('allocations_assigned_to_foreign');

            $table->renameColumn('node', 'node_id');
            $table->renameColumn('assigned_to', 'server_id');
            $table->foreign('node_id')->references('id')->on('nodes');
            $table->foreign('server_id')->references('id')->on('servers');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('allocations', function (Blueprint $table) {
            $table->dropForeign('allocations_node_id_foreign');
            $table->dropForeign('allocations_server_id_foreign');
            $table->dropIndex('allocations_node_id_foreign');
            $table->dropIndex('allocations_server_id_foreign');

            $table->renameColumn('node_id', 'node');
            $table->renameColumn('server_id', 'assigned_to');
            $table->foreign('node')->references('id')->on('nodes');
            $table->foreign('assigned_to')->references('id')->on('servers');
        });
    }
}
</file>

<file path="database/migrations/2017_02_05_164123_AdjustColumnNames.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AdjustColumnNames extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('service_options', function (Blueprint $table) {
            $table->dropForeign('service_options_parent_service_foreign');
            $table->dropIndex('service_options_parent_service_foreign');

            $table->renameColumn('parent_service', 'service_id');
            $table->foreign('service_id')->references('id')->on('services');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('service_options', function (Blueprint $table) {
            $table->dropForeign('service_options_service_id_foreign');
            $table->dropIndex('service_options_service_id_foreign');

            $table->renameColumn('service_id', 'parent_service');
            $table->foreign('parent_service')->references('id')->on('services');
        });
    }
}
</file>

<file path="database/migrations/2017_02_05_164516_AdjustColumnNamesForServicePacks.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AdjustColumnNamesForServicePacks extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('service_packs', function (Blueprint $table) {
            $table->dropForeign('service_packs_option_foreign');
            $table->dropIndex('service_packs_option_foreign');

            $table->renameColumn('option', 'option_id');
            $table->foreign('option_id')->references('id')->on('service_options');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('service_packs', function (Blueprint $table) {
            $table->dropForeign('service_packs_option_id_foreign');
            $table->dropIndex('service_packs_option_id_foreign');

            $table->renameColumn('option_id', 'option');
            $table->foreign('option')->references('id')->on('service_options');
        });
    }
}
</file>

<file path="database/migrations/2017_02_09_174834_SetupPermissionsPivotTable.php">
<?php

use Jexactyl\Models\Subuser;
use Jexactyl\Models\Permission;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class SetupPermissionsPivotTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('permissions', function (Blueprint $table) {
            $table->unsignedInteger('subuser_id')->after('id');
        });

        DB::transaction(function () {
            foreach (Subuser::all() as &$subuser) {
                Permission::where('user_id', $subuser->user_id)->where('server_id', $subuser->server_id)->update([
                    'subuser_id' => $subuser->id,
                ]);
            }
        });

        Schema::table('permissions', function (Blueprint $table) {
            $table->dropForeign('permissions_server_id_foreign');
            $table->dropIndex('permissions_server_id_foreign');
            $table->dropForeign('permissions_user_id_foreign');
            $table->dropIndex('permissions_user_id_foreign');

            $table->dropColumn('server_id');
            $table->dropColumn('user_id');
            $table->dropColumn('created_at');
            $table->dropColumn('updated_at');
            $table->foreign('subuser_id')->references('id')->on('subusers');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('permissions', function (Blueprint $table) {
            $table->unsignedInteger('server_id')->after('subuser_id');
            $table->unsignedInteger('user_id')->after('server_id');
            $table->timestamps();
        });

        DB::transaction(function () {
            foreach (Subuser::all() as &$subuser) {
                Permission::where('subuser_id', $subuser->id)->update([
                    'user_id' => $subuser->user_id,
                    'server_id' => $subuser->server_id,
                ]);
            }
        });

        Schema::table('permissions', function (Blueprint $table) {
            $table->dropForeign('permissions_subuser_id_foreign');
            $table->dropIndex('permissions_subuser_id_foreign');
            $table->dropColumn('subuser_id');

            $table->foreign('server_id')->references('id')->on('servers');
            $table->foreign('user_id')->references('id')->on('users');
        });
    }
}
</file>

<file path="database/migrations/2017_02_10_171858_UpdateAPIKeyColumnNames.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class UpdateAPIKeyColumnNames extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('api_keys', function (Blueprint $table) {
            $table->dropForeign('api_keys_user_foreign')->dropIndex('api_keys_user_foreign');

            $table->renameColumn('user', 'user_id');
            $table->foreign('user_id')->references('id')->on('users');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('api_keys', function (Blueprint $table) {
            $table->dropForeign('api_keys_user_id_foreign')->dropIndex('api_keys_user_id_foreign');

            $table->renameColumn('user_id', 'user');
            $table->foreign('user')->references('id')->on('users');
        });
    }
}
</file>

<file path="database/migrations/2017_03_03_224254_UpdateNodeConfigTokensColumns.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class UpdateNodeConfigTokensColumns extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('node_configuration_tokens', function (Blueprint $table) {
            $table->dropForeign(['node']);
            $table->dropColumn('expires_at');
            $table->renameColumn('node', 'node_id');

            $table->foreign('node_id')->references('id')->on('nodes');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('node_configuration_tokens', function (Blueprint $table) {
            $table->dropForeign(['node_id']);
            $table->renameColumn('node_id', 'node');
            $table->timestamp('expires_at')->after('token');

            $table->foreign('node')->references('id')->on('nodes');
        });
    }
}
</file>

<file path="database/migrations/2017_03_05_212803_DeleteServiceExecutableOption.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class DeleteServiceExecutableOption extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('services', function (Blueprint $table) {
            $table->renameColumn('file', 'folder');
            $table->dropColumn('executable');
            $table->text('description')->nullable()->change();
            $table->text('startup')->nullable()->change();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('services', function (Blueprint $table) {
            $table->string('executable')->after('folder');
            $table->renameColumn('folder', 'file');
            $table->text('description')->nullable(false)->change();
            $table->text('startup')->nullable(false)->change();
        });
    }
}
</file>

<file path="database/migrations/2017_03_10_162934_AddNewServiceOptionsColumns.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddNewServiceOptionsColumns extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('service_options', function (Blueprint $table) {
            $table->dropColumn('executable');

            $table->unsignedInteger('config_from')->nullable()->after('docker_image');
            $table->string('config_stop')->nullable()->after('docker_image');
            $table->text('config_logs')->nullable()->after('docker_image');
            $table->text('config_startup')->nullable()->after('docker_image');
            $table->text('config_files')->nullable()->after('docker_image');

            $table->foreign('config_from')->references('id')->on('service_options');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('service_options', function (Blueprint $table) {
            $table->dropForeign(['config_from']);

            $table->dropColumn('config_from');
            $table->dropColumn('config_stop');
            $table->dropColumn('config_logs');
            $table->dropColumn('config_startup');
            $table->dropColumn('config_files');

            $table->string('executable')->after('docker_image')->nullable();
        });
    }
}
</file>

<file path="database/migrations/2017_03_10_173607_MigrateToNewServiceSystem.php">
<?php

use Illuminate\Database\Migrations\Migration;

class MigrateToNewServiceSystem extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        DB::transaction(function () {
            $service = DB::table('services')->where('author', config('jexactyl.service.core'))->where('folder', 'srcds')->first();
            if (!$service) {
                return;
            }

            $options = DB::table('service_options')->where('service_id', $service->id)->get();
            $options->each(function ($item) {
                if ($item->tag === 'srcds' && $item->name === 'Insurgency') {
                    $item->tag = 'insurgency';
                } elseif ($item->tag === 'srcds' && $item->name === 'Team Fortress 2') {
                    $item->tag = 'tf2';
                } elseif ($item->tag === 'srcds' && $item->name === 'Custom Source Engine Game') {
                    $item->tag = 'source';
                }
                $item->save();
            });
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        // Not doing reversals right now...
    }
}
</file>

<file path="database/migrations/2017_03_11_215455_ChangeServiceVariablesValidationRules.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class ChangeServiceVariablesValidationRules extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('service_variables', function (Blueprint $table) {
            $table->renameColumn('regex', 'rules');
        });

        DB::transaction(function () {
            foreach (DB::table('service_variables')->get() as $variable) {
                $variable->rules = ($variable->required) ? 'required|regex:' . $variable->rules : 'regex:' . $variable->rules;
                $variable->save();
            }
        });

        Schema::table('service_variables', function (Blueprint $table) {
            $table->dropColumn('required');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('service_variables', function (Blueprint $table) {
            $table->renameColumn('rules', 'regex');
            $table->boolean('required')->default(true)->before('regex');
        });

        DB::transaction(function () {
            foreach (DB::table('service_variables')->get() as $variable) {
                $variable->regex = str_replace(['required|regex:', 'regex:'], '', $variable->regex);
                $variable->save();
            }
        });
    }
}
</file>

<file path="database/migrations/2017_03_12_150648_MoveFunctionsFromFileToDatabase.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class MoveFunctionsFromFileToDatabase extends Migration
{
    private $default = <<<'EOF'
'use strict';

/**
 * Jexactyl - Daemon
 * Copyright (c) 2015 - 2017 Dane Everitt <dane@daneeveritt.com>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
const rfr = require('rfr');
const _ = require('lodash');

const Core = rfr('src/services/index.js');

class Service extends Core {}

module.exports = Service;
EOF;

    private $default_mc = <<<'EOF'
'use strict';

/**
 * Jexactyl - Daemon
 * Copyright (c) 2015 - 2017 Dane Everitt <dane@daneeveritt.com>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
const rfr = require('rfr');
const _ = require('lodash');

const Core = rfr('src/services/index.js');

class Service extends Core {
    onConsole(data) {
        // Hide the output spam from Bungeecord getting pinged.
        if (_.endsWith(data, '<-> InitialHandler has connected')) return;
        return super.onConsole(data);
    }
}

module.exports = Service;
EOF;

    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('services', function (Blueprint $table) {
            $table->text('index_file')->after('startup');
        });

        DB::transaction(function () {
            DB::table('services')->where('author', 'ptrdctyl-v040-11e6-8b77-86f30ca893d3')->where('folder', '!=', 'minecraft')->update([
                'index_file' => $this->default,
            ]);

            DB::table('services')->where('author', 'ptrdctyl-v040-11e6-8b77-86f30ca893d3')->where('folder', 'minecraft')->update([
                'index_file' => $this->default_mc,
            ]);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('services', function (Blueprint $table) {
            $table->dropColumn('index_file');
        });
    }
}
</file>

<file path="database/migrations/2017_03_14_175631_RenameServicePacksToSingluarPacks.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class RenameServicePacksToSingluarPacks extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('service_packs', function (Blueprint $table) {
            $table->dropForeign(['option_id']);
        });

        Schema::rename('service_packs', 'packs');

        Schema::table('packs', function (Blueprint $table) {
            $table->foreign('option_id')->references('id')->on('service_options');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('packs', function (Blueprint $table) {
            $table->dropForeign(['option_id']);
        });

        Schema::rename('packs', 'service_packs');

        Schema::table('service_packs', function (Blueprint $table) {
            $table->foreign('option_id')->references('id')->on('service_options');
        });
    }
}
</file>

<file path="database/migrations/2017_03_14_200326_AddLockedStatusToTable.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddLockedStatusToTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('packs', function (Blueprint $table) {
            $table->boolean('locked')->default(false)->after('visible');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('packs', function (Blueprint $table) {
            $table->dropColumn('locked');
        });
    }
}
</file>

<file path="database/migrations/2017_03_16_181109_ReOrganizeDatabaseServersToDatabaseHost.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class ReOrganizeDatabaseServersToDatabaseHost extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('database_servers', function (Blueprint $table) {
            $table->dropForeign(['linked_node']);
        });

        Schema::rename('database_servers', 'database_hosts');

        Schema::table('database_hosts', function (Blueprint $table) {
            $table->renameColumn('linked_node', 'node_id');

            $table->foreign('node_id')->references('id')->on('nodes');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('database_hosts', function (Blueprint $table) {
            $table->dropForeign(['node_id']);
        });

        Schema::rename('database_hosts', 'database_servers');

        Schema::table('database_servers', function (Blueprint $table) {
            $table->renameColumn('node_id', 'linked_node');

            $table->foreign('linked_node')->references('id')->on('nodes');
        });
    }
}
</file>

<file path="database/migrations/2017_03_16_181515_CleanupDatabasesDatabase.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CleanupDatabasesDatabase extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('databases', function (Blueprint $table) {
            $table->dropForeign(['db_server']);

            $table->renameColumn('db_server', 'database_host_id');

            $table->foreign('database_host_id')->references('id')->on('database_hosts');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('databases', function (Blueprint $table) {
            $table->dropForeign(['database_host_id']);

            $table->renameColumn('database_host_id', 'db_server');

            $table->foreign('db_server')->references('id')->on('database_hosts');
        });
    }
}
</file>

<file path="database/migrations/2017_03_18_204953_AddForeignKeyToPacks.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForeignKeyToPacks extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->foreign('pack_id')->references('id')->on('packs');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropForeign(['pack_id']);
        });
    }
}
</file>

<file path="database/migrations/2017_03_31_221948_AddServerDescriptionColumn.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddServerDescriptionColumn extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->text('description')->after('name');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn('description');
        });
    }
}
</file>

<file path="database/migrations/2017_04_02_163232_DropDeletedAtColumnFromServers.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class DropDeletedAtColumnFromServers extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn('deleted_at');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->timestamp('deleted_at')->nullable();
        });
    }
}
</file>

<file path="database/migrations/2017_04_15_125021_UpgradeTaskSystem.php">
<?php

use Jexactyl\Models\Task;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class UpgradeTaskSystem extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('tasks', function (Blueprint $table) {
            $table->dropForeign(['server']);

            $table->renameColumn('server', 'server_id');
            $table->unsignedInteger('user_id')->nullable()->after('id');

            $table->foreign('server_id')->references('id')->on('servers');
            $table->foreign('user_id')->references('id')->on('users');
        });

        DB::transaction(function () {
            foreach (Task::all() as $task) {
                $task->user_id = $task->server->owner_id;
                $task->save();
            }
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('tasks', function (Blueprint $table) {
//            $table->dropForeign(['server_id']);
//            $table->dropForeign(['user_id']);

            $table->renameColumn('server_id', 'server');
            $table->dropColumn('user_id');

            $table->foreign('server')->references('id')->on('servers');
        });
    }
}
</file>

<file path="database/migrations/2017_04_20_171943_AddScriptsToServiceOptions.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddScriptsToServiceOptions extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('service_options', function (Blueprint $table) {
            $table->text('script_install')->after('startup')->nullable();
            $table->boolean('script_is_privileged')->default(true)->after('startup');
            $table->string('script_entry')->default('ash')->after('startup');
            $table->string('script_container')->default('alpine:3.4')->after('startup');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('service_options', function (Blueprint $table) {
            $table->dropColumn('script_install');
            $table->dropColumn('script_is_privileged');
            $table->dropColumn('script_entry');
            $table->dropColumn('script_container');
        });
    }
}
</file>

<file path="database/migrations/2017_04_21_151432_AddServiceScriptTrackingToServers.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddServiceScriptTrackingToServers extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->boolean('skip_scripts')->default(false)->after('description');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn('skip_scripts');
        });
    }
}
</file>

<file path="database/migrations/2017_04_27_145300_AddCopyScriptFromColumn.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddCopyScriptFromColumn extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('service_options', function (Blueprint $table) {
            $table->unsignedInteger('copy_script_from')->nullable()->after('script_container');

            $table->foreign('copy_script_from')->references('id')->on('service_options');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('service_options', function (Blueprint $table) {
            $table->dropForeign(['copy_script_from']);
            $table->dropColumn('copy_script_from');
        });
    }
}
</file>

<file path="database/migrations/2017_04_27_223629_AddAbilityToDefineConnectionOverSSLWithDaemonBehindProxy.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddAbilityToDefineConnectionOverSSLWithDaemonBehindProxy extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->boolean('behind_proxy')->after('scheme')->default(false);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->dropColumn('behind_proxy');
        });
    }
}
</file>

<file path="database/migrations/2017_05_01_141528_DeleteDownloadTable.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class DeleteDownloadTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::dropIfExists('downloads');
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::create('downloads', function (Blueprint $table) {
            $table->increments('id');
            $table->char('token', 36)->unique();
            $table->char('server', 36);
            $table->text('path');
            $table->timestamps();
        });
    }
}
</file>

<file path="database/migrations/2017_05_01_141559_DeleteNodeConfigurationTable.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class DeleteNodeConfigurationTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::dropIfExists('node_configuration_tokens');
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::create('node_configuration_tokens', function (Blueprint $table) {
            $table->increments('id');
            $table->char('token', 32);
            $table->unsignedInteger('node_id');
            $table->timestamps();
        });

        Schema::table('node_configuration_tokens', function (Blueprint $table) {
            $table->foreign('node_id')->references('id')->on('nodes');
        });
    }
}
</file>

<file path="database/migrations/2017_06_10_152951_add_external_id_to_users.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddExternalIdToUsers extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->unsignedInteger('external_id')->after('id')->nullable()->unique();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn('external_id');
        });
    }
}
</file>

<file path="database/migrations/2017_06_25_133923_ChangeForeignKeyToBeOnCascadeDelete.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class ChangeForeignKeyToBeOnCascadeDelete extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('api_permissions', function (Blueprint $table) {
            $table->dropForeign(['key_id']);

            $table->foreign('key_id')->references('id')->on('api_keys')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('api_permissions', function (Blueprint $table) {
            $table->dropForeign(['key_id']);

            $table->foreign('key_id')->references('id')->on('api_keys');
        });
    }
}
</file>

<file path="database/migrations/2017_07_08_152806_ChangeUserPermissionsToDeleteOnUserDeletion.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class ChangeUserPermissionsToDeleteOnUserDeletion extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('permissions', function (Blueprint $table) {
            $table->dropForeign(['subuser_id']);

            $table->foreign('subuser_id')->references('id')->on('subusers')->onDelete('cascade');
        });

        Schema::table('subusers', function (Blueprint $table) {
            $table->dropForeign(['user_id']);
            $table->dropForeign(['server_id']);

            $table->foreign('user_id')->references('id')->on('users')->onDelete('cascade');
            $table->foreign('server_id')->references('id')->on('servers')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('subusers', function (Blueprint $table) {
            $table->dropForeign(['user_id']);
            $table->dropForeign(['server_id']);

            $table->foreign('user_id')->references('id')->on('users');
            $table->foreign('server_id')->references('id')->on('servers');
        });

        Schema::table('permissions', function (Blueprint $table) {
            $table->dropForeign(['subuser_id']);

            $table->foreign('subuser_id')->references('id')->on('subusers');
        });
    }
}
</file>

<file path="database/migrations/2017_07_08_154416_SetAllocationToReferenceNullOnServerDelete.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class SetAllocationToReferenceNullOnServerDelete extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('allocations', function (Blueprint $table) {
            $table->dropForeign(['server_id']);

            $table->foreign('server_id')->references('id')->on('servers')->onDelete('set null');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('allocations', function (Blueprint $table) {
            $table->dropForeign(['server_id']);

            $table->foreign('server_id')->references('id')->on('servers');
        });
    }
}
</file>

<file path="database/migrations/2017_07_08_154650_CascadeDeletionWhenAServerOrVariableIsDeleted.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CascadeDeletionWhenAServerOrVariableIsDeleted extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('server_variables', function (Blueprint $table) {
            $table->dropForeign(['server_id']);
            $table->dropForeign(['variable_id']);

            $table->foreign('server_id')->references('id')->on('servers')->onDelete('cascade');
            $table->foreign('variable_id')->references('id')->on('service_variables')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('server_variables', function (Blueprint $table) {
            $table->dropForeign(['server_id']);
            $table->dropForeign(['variable_id']);

            $table->foreign('server_id')->references('id')->on('servers');
            $table->foreign('variable_id')->references('id')->on('service_variables');
        });
    }
}
</file>

<file path="database/migrations/2017_07_24_194433_DeleteTaskWhenParentServerIsDeleted.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class DeleteTaskWhenParentServerIsDeleted extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('tasks', function (Blueprint $table) {
            $table->dropForeign(['server_id']);

            $table->foreign('server_id')->references('id')->on('servers')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
    }
}
</file>

<file path="database/migrations/2017_08_05_115800_CascadeNullValuesForDatabaseHostWhenNodeIsDeleted.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CascadeNullValuesForDatabaseHostWhenNodeIsDeleted extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('database_hosts', function (Blueprint $table) {
            $table->dropForeign(['node_id']);
            $table->foreign('node_id')->references('id')->on('nodes')->onDelete('set null');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('database_hosts', function (Blueprint $table) {
            $table->dropForeign(['node_id']);
            $table->foreign('node_id')->references('id')->on('nodes');
        });
    }
}
</file>

<file path="database/migrations/2017_08_05_144104_AllowNegativeValuesForOverallocation.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AllowNegativeValuesForOverallocation extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->integer('disk_overallocate')->default(0)->nullable(false)->change();
            $table->integer('memory_overallocate')->default(0)->nullable(false)->change();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('nodes', function (Blueprint $table) {
            DB::statement('ALTER TABLE nodes MODIFY disk_overallocate MEDIUMINT UNSIGNED NULL, 
                                             MODIFY memory_overallocate MEDIUMINT UNSIGNED NULL');
        });
    }
}
</file>

<file path="database/migrations/2017_08_05_174811_SetAllocationUnqiueUsingMultipleFields.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class SetAllocationUnqiueUsingMultipleFields extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('allocations', function (Blueprint $table) {
            $table->unique(['node_id', 'ip', 'port']);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('allocations', function (Blueprint $table) {
            $table->dropForeign(['node_id']);
            $table->dropUnique(['node_id', 'ip', 'port']);
            $table->foreign('node_id')->references('id')->on('nodes');
        });
    }
}
</file>

<file path="database/migrations/2017_08_15_214555_CascadeDeletionWhenAParentServiceIsDeleted.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CascadeDeletionWhenAParentServiceIsDeleted extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('service_options', function (Blueprint $table) {
            $table->dropForeign(['service_id']);

            $table->foreign('service_id')->references('id')->on('services')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('service_options', function (Blueprint $table) {
            $table->dropForeign(['service_id']);

            $table->foreign('service_id')->references('id')->on('services');
        });
    }
}
</file>

<file path="database/migrations/2017_08_18_215428_RemovePackWhenParentServiceOptionIsDeleted.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class RemovePackWhenParentServiceOptionIsDeleted extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('packs', function (Blueprint $table) {
            $table->dropForeign(['option_id']);

            $table->foreign('option_id')->references('id')->on('service_options')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('packs', function (Blueprint $table) {
            $table->dropForeign(['option_id']);

            $table->foreign('option_id')->references('id')->on('service_options');
        });
    }
}
</file>

<file path="database/migrations/2017_09_10_225749_RenameTasksTableForStructureRefactor.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Migrations\Migration;

class RenameTasksTableForStructureRefactor extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::rename('tasks', 'tasks_old');
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::rename('tasks_old', 'tasks');
    }
}
</file>

<file path="database/migrations/2017_09_10_225941_CreateSchedulesTable.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateSchedulesTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('schedules', function (Blueprint $table) {
            $table->increments('id');
            $table->unsignedInteger('server_id');
            $table->string('name')->nullable();
            $table->string('cron_day_of_week');
            $table->string('cron_day_of_month');
            $table->string('cron_hour');
            $table->string('cron_minute');
            $table->boolean('is_active');
            $table->boolean('is_processing');
            $table->timestamp('last_run_at')->nullable();
            $table->timestamp('next_run_at')->nullable();
            $table->timestamps();

            $table->foreign('server_id')->references('id')->on('servers')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('schedules');
    }
}
</file>

<file path="database/migrations/2017_09_10_230309_CreateNewTasksTableForSchedules.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateNewTasksTableForSchedules extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('tasks', function (Blueprint $table) {
            $table->increments('id');
            $table->unsignedInteger('schedule_id');
            $table->unsignedInteger('sequence_id');
            $table->string('action');
            $table->text('payload');
            $table->unsignedInteger('time_offset');
            $table->boolean('is_queued');
            $table->timestamps();

            $table->index(['schedule_id', 'sequence_id']);
            $table->foreign('schedule_id')->references('id')->on('schedules')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('tasks');
    }
}
</file>

<file path="database/migrations/2017_09_11_002938_TransferOldTasksToNewScheduler.php">
<?php

use Carbon\Carbon;
use Illuminate\Support\Facades\DB;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class TransferOldTasksToNewScheduler extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        $tasks = DB::table('tasks_old')->get();

        DB::beginTransaction();
        $tasks->each(function ($task) {
            $schedule = DB::table('schedules')->insertGetId([
                'server_id' => $task->server_id,
                'name' => null,
                'cron_day_of_week' => $task->day_of_week,
                'cron_day_of_month' => $task->day_of_month,
                'cron_hour' => $task->hour,
                'cron_minute' => $task->minute,
                'is_active' => (bool) $task->active,
                'is_processing' => false,
                'last_run_at' => $task->last_run,
                'next_run_at' => $task->next_run,
                'created_at' => $task->created_at,
                'updated_at' => Carbon::now()->toDateTimeString(),
            ]);

            DB::table('tasks')->insert([
                'schedule_id' => $schedule,
                'sequence_id' => 1,
                'action' => $task->action,
                'payload' => $task->data,
                'time_offset' => 0,
                'is_queued' => false,
                'updated_at' => Carbon::now()->toDateTimeString(),
                'created_at' => Carbon::now()->toDateTimeString(),
            ]);

            DB::table('tasks_old')->delete($task->id);
            DB::commit();
        });

        Schema::dropIfExists('tasks_old');
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::create('tasks_old', function (Blueprint $table) {
            $table->increments('id');
            $table->unsignedInteger('user_id')->nullable();
            $table->unsignedInteger('server_id');
            $table->tinyInteger('active')->default(1);
            $table->string('action');
            $table->text('data');
            $table->unsignedTinyInteger('queued')->default(0);
            $table->string('year')->default('*');
            $table->string('month')->default('*');
            $table->string('day_of_week')->default('*');
            $table->string('day_of_month')->default('*');
            $table->string('minute')->default('*');
            $table->timestamp('last_run')->nullable();
            $table->timestamp('next_run');
            $table->timestamps();
        });
    }
}
</file>

<file path="database/migrations/2017_09_13_211810_UpdateOldPermissionsToPointToNewScheduleSystem.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Database\Migrations\Migration;

class UpdateOldPermissionsToPointToNewScheduleSystem extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        $permissions = DB::table('permissions')->where('permission', 'like', '%-task%')->get();
        foreach ($permissions as $record) {
            $parts = explode('-', $record->permission);
            if (!in_array(array_get($parts, 1), ['tasks', 'task']) || count($parts) !== 2) {
                continue;
            }

            $newPermission = $parts[0] . '-' . str_replace('task', 'schedule', $parts[1]);

            DB::table('permissions')->where('id', '=', $record->id)->update(['permission' => $newPermission]);
        }
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        $permissions = DB::table('permissions')->where('permission', 'like', '%-schedule%')->get();
        foreach ($permissions as $record) {
            $parts = explode('-', $record->permission);
            if (!in_array(array_get($parts, 1), ['schedules', 'schedule']) || count($parts) !== 2) {
                continue;
            }

            $newPermission = $parts[0] . '-' . str_replace('schedule', 'task', $parts[1]);

            DB::table('permissions')->where('id', '=', $record->id)->update(['permission' => $newPermission]);
        }
    }
}
</file>

<file path="database/migrations/2017_09_23_170933_CreateDaemonKeysTable.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateDaemonKeysTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('daemon_keys', function (Blueprint $table) {
            $table->increments('id');
            $table->unsignedInteger('server_id');
            $table->unsignedInteger('user_id');
            $table->string('secret')->unique();
            $table->timestamp('expires_at');
            $table->timestamps();

            $table->index(['server_id', 'user_id']);
            $table->foreign('server_id')->references('id')->on('servers')->onDelete('cascade');
            $table->foreign('user_id')->references('id')->on('users')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('daemon_keys');
    }
}
</file>

<file path="database/migrations/2017_09_23_173628_RemoveDaemonSecretFromServersTable.php">
<?php

use Carbon\Carbon;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;
use Jexactyl\Contracts\Repository\DaemonKeyRepositoryInterface;

class RemoveDaemonSecretFromServersTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        $inserts = [];

        $servers = DB::table('servers')->select('id', 'owner_id')->get();
        $servers->each(function ($server) use (&$inserts) {
            $inserts[] = [
                'user_id' => $server->owner_id,
                'server_id' => $server->id,
                'secret' => DaemonKeyRepositoryInterface::INTERNAL_KEY_IDENTIFIER . str_random(40),
                'expires_at' => Carbon::now()->addMinutes(config('jexactyl.api.key_expire_time', 720))->toDateTimeString(),
                'created_at' => Carbon::now()->toDateTimeString(),
                'updated_at' => Carbon::now()->toDateTimeString(),
            ];
        });

        DB::transaction(function () use ($inserts) {
            DB::table('daemon_keys')->insert($inserts);
        });

        Schema::table('servers', function (Blueprint $table) {
            $table->dropUnique(['daemonSecret']);
            $table->dropColumn('daemonSecret');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->char('daemonSecret', 36)->after('startup')->unique();
        });

        DB::table('daemon_keys')->truncate();
    }
}
</file>

<file path="database/migrations/2017_09_23_185022_RemoveDaemonSecretFromSubusersTable.php">
<?php

use Carbon\Carbon;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;
use Jexactyl\Contracts\Repository\DaemonKeyRepositoryInterface;

class RemoveDaemonSecretFromSubusersTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        $inserts = [];
        $subusers = DB::table('subusers')->get();
        $subusers->each(function ($subuser) use (&$inserts) {
            $inserts[] = [
                'user_id' => $subuser->user_id,
                'server_id' => $subuser->server_id,
                'secret' => DaemonKeyRepositoryInterface::INTERNAL_KEY_IDENTIFIER . str_random(40),
                'expires_at' => Carbon::now()->addMinutes(config('jexactyl.api.key_expire_time', 720))->toDateTimeString(),
                'created_at' => Carbon::now()->toDateTimeString(),
                'updated_at' => Carbon::now()->toDateTimeString(),
            ];
        });

        DB::transaction(function () use ($inserts) {
            DB::table('daemon_keys')->insert($inserts);
        });

        Schema::table('subusers', function (Blueprint $table) {
            $table->dropUnique(['daemonSecret']);
            $table->dropColumn('daemonSecret');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('subusers', function (Blueprint $table) {
            $table->char('daemonSecret', 36)->after('server_id');
        });

        $subusers = DB::table('subusers')->get();
        $subusers->each(function ($subuser) {
            DB::table('daemon_keys')->where('user_id', $subuser->user_id)->where('server_id', $subuser->server_id)->delete();
        });

        Schema::table('subusers', function (Blueprint $table) {
            $table->unique('daemonSecret');
        });
    }
}
</file>

<file path="database/migrations/2017_10_02_202000_ChangeServicesToUseAMoreUniqueIdentifier.php">
<?php

use Ramsey\Uuid\Uuid;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class ChangeServicesToUseAMoreUniqueIdentifier extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('services', function (Blueprint $table) {
            $table->dropUnique(['name']);
            $table->dropUnique(['file']);

            $table->string('author')->change();
            $table->char('uuid', 36)->after('id');
            $table->dropColumn('folder');
            $table->dropColumn('startup');
            $table->dropColumn('index_file');
        });

        DB::table('services')->get(['id', 'author', 'uuid'])->each(function ($service) {
            DB::table('services')->where('id', $service->id)->update([
                'author' => ($service->author === 'ptrdctyl-v040-11e6-8b77-86f30ca893d3') ? 'support@Jexactyl.io' : 'unknown@unknown-author.com',
                'uuid' => Uuid::uuid4()->toString(),
            ]);
        });

        Schema::table('services', function (Blueprint $table) {
            $table->unique('uuid');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('services', function (Blueprint $table) {
            $table->dropColumn('uuid');
            $table->string('folder')->nullable();
            $table->text('startup')->nullable();
            $table->text('index_file');
            $table->string('author', 36)->change();

            $table->unique('name');
            $table->unique('folder', 'services_file_unique');
        });
    }
}
</file>

<file path="database/migrations/2017_10_02_202007_ChangeToABetterUniqueServiceConfiguration.php">
<?php

use Ramsey\Uuid\Uuid;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class ChangeToABetterUniqueServiceConfiguration extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('service_options', function (Blueprint $table) {
            $table->char('uuid', 36)->after('id');
            $table->string('author')->after('service_id');
            $table->dropColumn('tag');
        });

        DB::transaction(function () {
            DB::table('service_options')->select([
                'service_options.id',
                'service_options.uuid',
                'services.author AS service_author',
            ])->join('services', 'services.id', '=', 'service_options.service_id')->get()->each(function ($option) {
                DB::table('service_options')->where('id', $option->id)->update([
                    'author' => $option->service_author,
                    'uuid' => Uuid::uuid4()->toString(),
                ]);
            });
        });

        Schema::table('service_options', function (Blueprint $table) {
            $table->unique('uuid');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('service_options', function (Blueprint $table) {
            $table->dropColumn('uuid');
            $table->dropColumn('author');
            $table->string('tag');
        });

        DB::transaction(function () {
            DB::table('service_options')->select(['id', 'tag'])->get()->each(function ($option) {
                DB::table('service_options')->where('id', $option->id)->update([
                    'tag' => str_random(10),
                ]);
            });
        });
    }
}
</file>

<file path="database/migrations/2017_10_03_233202_CascadeDeletionWhenServiceOptionIsDeleted.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CascadeDeletionWhenServiceOptionIsDeleted extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('service_variables', function (Blueprint $table) {
            $table->dropForeign(['option_id']);

            $table->foreign('option_id')->references('id')->on('service_options')->onDelete('CASCADE');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('service_variables', function (Blueprint $table) {
            $table->dropForeign(['option_id']);

            $table->foreign('option_id')->references('id')->on('service_options');
        });
    }
}
</file>

<file path="database/migrations/2017_10_06_214026_ServicesToNestsConversion.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class ServicesToNestsConversion extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::disableForeignKeyConstraints();

        Schema::rename('services', 'nests');

        Schema::table('servers', function (Blueprint $table) {
            $table->dropForeign(['service_id']);
            $table->renameColumn('service_id', 'nest_id');

            $table->foreign('nest_id')->references('id')->on('nests');
        });

        Schema::table('service_options', function (Blueprint $table) {
            $table->dropForeign(['service_id']);
            $table->renameColumn('service_id', 'nest_id');

            $table->foreign('nest_id')->references('id')->on('nests')->onDelete('CASCADE');
        });

        Schema::enableForeignKeyConstraints();
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::disableForeignKeyConstraints();

        Schema::rename('nests', 'services');

        Schema::table('servers', function (Blueprint $table) {
            $table->dropForeign(['nest_id']);
            $table->renameColumn('nest_id', 'service_id');

            $table->foreign('service_id')->references('id')->on('services');
        });

        Schema::table('service_options', function (Blueprint $table) {
            $table->dropForeign(['nest_id']);
            $table->renameColumn('nest_id', 'service_id');

            $table->foreign('service_id')->references('id')->on('services')->onDelete('CASCADE');
        });

        Schema::enableForeignKeyConstraints();
    }
}
</file>

<file path="database/migrations/2017_10_06_214053_ServiceOptionsToEggsConversion.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class ServiceOptionsToEggsConversion extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::disableForeignKeyConstraints();

        Schema::table('service_options', function (Blueprint $table) {
            $table->dropForeign(['config_from']);
            $table->dropForeign(['copy_script_from']);
        });

        Schema::rename('service_options', 'eggs');

        Schema::table('packs', function (Blueprint $table) {
            $table->dropForeign(['option_id']);
            $table->renameColumn('option_id', 'egg_id');

            $table->foreign('egg_id')->references('id')->on('eggs')->onDelete('CASCADE');
        });

        Schema::table('servers', function (Blueprint $table) {
            $table->dropForeign(['option_id']);
            $table->renameColumn('option_id', 'egg_id');

            $table->foreign('egg_id')->references('id')->on('eggs');
        });

        Schema::table('eggs', function (Blueprint $table) {
            $table->foreign('config_from')->references('id')->on('eggs')->onDelete('SET NULL');
            $table->foreign('copy_script_from')->references('id')->on('eggs')->onDelete('SET NULL');
        });

        Schema::table('service_variables', function (Blueprint $table) {
            $table->dropForeign(['option_id']);
            $table->renameColumn('option_id', 'egg_id');

            $table->foreign('egg_id')->references('id')->on('eggs')->onDelete('CASCADE');
        });

        Schema::enableForeignKeyConstraints();
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::disableForeignKeyConstraints();

        Schema::table('eggs', function (Blueprint $table) {
            $table->dropForeign(['config_from']);
            $table->dropForeign(['copy_script_from']);
        });

        Schema::rename('eggs', 'service_options');

        Schema::table('packs', function (Blueprint $table) {
            $table->dropForeign(['egg_id']);
            $table->renameColumn('egg_id', 'option_id');

            $table->foreign('option_id')->references('id')->on('service_options')->onDelete('CASCADE');
        });

        Schema::table('servers', function (Blueprint $table) {
            $table->dropForeign(['egg_id']);
            $table->renameColumn('egg_id', 'option_id');

            $table->foreign('option_id')->references('id')->on('service_options');
        });

        Schema::table('service_options', function (Blueprint $table) {
            $table->foreign('config_from')->references('id')->on('service_options')->onDelete('SET NULL');
            $table->foreign('copy_script_from')->references('id')->on('service_options')->onDelete('SET NULL');
        });

        Schema::table('service_variables', function (Blueprint $table) {
            $table->dropForeign(['egg_id']);
            $table->renameColumn('egg_id', 'option_id');

            $table->foreign('option_id')->references('id')->on('options')->onDelete('CASCADE');
        });

        Schema::enableForeignKeyConstraints();
    }
}
</file>

<file path="database/migrations/2017_10_06_215741_ServiceVariablesToEggVariablesConversion.php">
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class ServiceVariablesToEggVariablesConversion extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::disableForeignKeyConstraints();

        Schema::rename('service_variables', 'egg_variables');

        Schema::table('server_variables', function (Blueprint $table) {
            $table->dropForeign(['variable_id']);

            $table->foreign('variable_id')->references('id')->on('egg_variables')->onDelete('CASCADE');
        });

        Schema::enableForeignKeyConstraints();
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::disableForeignKeyConstraints();

        Schema::rename('egg_variables', 'service_variables');

        Schema::table('server_variables', function (Blueprint $table) {
            $table->dropForeign(['variable_id']);

            $table->foreign('variable_id')->references('id')->on('service_variables')->onDelete('CASCADE');
        });

        Schema::enableForeignKeyConstraints();
    }
}
</file>

<file path="database/migrations/2017_10_24_222238_RemoveLegacySFTPInformation.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class RemoveLegacySFTPInformation extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropUnique(['username']);

            $table->dropColumn('username');
            $table->dropColumn('sftp_password');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->string('username')->nullable()->after('image')->unique();
            $table->text('sftp_password')->after('image');
        });
    }
}
</file>

<file path="database/migrations/2017_11_11_161922_Add2FaLastAuthorizationTimeColumn.php">
<?php

use Carbon\Carbon;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Crypt;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class Add2FaLastAuthorizationTimeColumn extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->text('totp_secret')->nullable()->change();
            $table->timestampTz('totp_authenticated_at')->after('totp_secret')->nullable();
        });

        DB::transaction(function () {
            DB::table('users')->get()->each(function ($user) {
                if (is_null($user->totp_secret)) {
                    return;
                }

                DB::table('users')->where('id', $user->id)->update([
                    'totp_secret' => Crypt::encrypt($user->totp_secret),
                    'updated_at' => Carbon::now()->toAtomString(),
                ]);
            });
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        DB::transaction(function () {
            DB::table('users')->get()->each(function ($user) {
                if (is_null($user->totp_secret)) {
                    return;
                }

                DB::table('users')->where('id', $user->id)->update([
                    'totp_secret' => Crypt::decrypt($user->totp_secret),
                    'updated_at' => Carbon::now()->toAtomString(),
                ]);
            });
        });

        DB::statement('ALTER TABLE users MODIFY totp_secret CHAR(16) DEFAULT NULL');

        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn('totp_authenticated_at');
        });
    }
}
</file>

<file path="database/migrations/2017_11_19_122708_MigratePubPrivFormatToSingleKey.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Crypt;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;
use Illuminate\Contracts\Encryption\DecryptException;

class MigratePubPrivFormatToSingleKey extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        DB::transaction(function () {
            DB::table('api_keys')->get()->each(function ($item) {
                try {
                    $decrypted = Crypt::decrypt($item->secret);
                } catch (DecryptException $exception) {
                    $decrypted = str_random(32);
                } finally {
                    DB::table('api_keys')->where('id', $item->id)->update([
                        'secret' => $decrypted,
                    ]);
                }
            });
        });

        Schema::table('api_keys', function (Blueprint $table) {
            $table->dropColumn('public');
            $table->string('secret', 32)->change();
        });

        DB::statement('ALTER TABLE `api_keys` CHANGE `secret` `token` CHAR(32) NOT NULL, ADD UNIQUE INDEX `api_keys_token_unique` (`token`(32))');
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        DB::statement('ALTER TABLE `api_keys` CHANGE `token` `secret` TEXT, DROP INDEX `api_keys_token_unique`');

        Schema::table('api_keys', function (Blueprint $table) {
            $table->char('public', 16)->after('user_id');
        });

        DB::transaction(function () {
            DB::table('api_keys')->get()->each(function ($item) {
                DB::table('api_keys')->where('id', $item->id)->update([
                    'public' => str_random(16),
                    'secret' => Crypt::encrypt($item->secret),
                ]);
            });
        });
    }
}
</file>

<file path="database/migrations/2017_12_04_184012_DropAllocationsWhenNodeIsDeleted.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class DropAllocationsWhenNodeIsDeleted extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::table('allocations', function (Blueprint $table) {
            $table->dropForeign(['node_id']);

            $table->foreign('node_id')->references('id')->on('nodes')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('allocations', function (Blueprint $table) {
            $table->dropForeign(['node_id']);

            $table->foreign('node_id')->references('id')->on('nodes');
        });
    }
}
</file>

<file path="database/migrations/2017_12_12_220426_MigrateSettingsTableToNewFormat.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class MigrateSettingsTableToNewFormat extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        DB::table('settings')->truncate();
        Schema::table('settings', function (Blueprint $table) {
            $table->increments('id')->first();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::table('settings', function (Blueprint $table) {
            $table->dropColumn('id');
        });
    }
}
</file>

<file path="database/migrations/2018_01_01_122821_AllowNegativeValuesForServerSwap.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AllowNegativeValuesForServerSwap extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->integer('swap')->change();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->unsignedInteger('swap')->change();
        });
    }
}
</file>

<file path="database/migrations/2018_01_11_213943_AddApiKeyPermissionColumns.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddApiKeyPermissionColumns extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::dropIfExists('api_permissions');

        Schema::table('api_keys', function (Blueprint $table) {
            $table->unsignedTinyInteger('r_servers')->default(0);
            $table->unsignedTinyInteger('r_nodes')->default(0);
            $table->unsignedTinyInteger('r_allocations')->default(0);
            $table->unsignedTinyInteger('r_users')->default(0);
            $table->unsignedTinyInteger('r_locations')->default(0);
            $table->unsignedTinyInteger('r_nests')->default(0);
            $table->unsignedTinyInteger('r_eggs')->default(0);
            $table->unsignedTinyInteger('r_database_hosts')->default(0);
            $table->unsignedTinyInteger('r_server_databases')->default(0);
            $table->unsignedTinyInteger('r_packs')->default(0);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::create('api_permissions', function (Blueprint $table) {
            $table->increments('id');
            $table->unsignedInteger('key_id');
            $table->string('permission');

            $table->foreign('key_id')->references('id')->on('api_keys')->onDelete('cascade');
        });

        Schema::table('api_keys', function (Blueprint $table) {
            $table->dropColumn([
                'r_servers',
                'r_nodes',
                'r_allocations',
                'r_users',
                'r_locations',
                'r_nests',
                'r_eggs',
                'r_database_hosts',
                'r_server_databases',
                'r_packs',
            ]);
        });
    }
}
</file>

<file path="database/migrations/2018_01_13_142012_SetupTableForKeyEncryption.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class SetupTableForKeyEncryption extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     *
     * @throws \Exception
     * @throws \Throwable
     */
    public function up()
    {
        Schema::table('api_keys', function (Blueprint $table) {
            $table->char('identifier', 16)->nullable()->unique()->after('user_id');
            $table->dropUnique(['token']);
        });

        Schema::table('api_keys', function (Blueprint $table) {
            $table->text('token')->change();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     *
     * @throws \Exception
     * @throws \Throwable
     */
    public function down()
    {
        Schema::table('api_keys', function (Blueprint $table) {
            $table->dropColumn('identifier');
            $table->string('token', 32)->unique()->change();
        });
    }
}
</file>

<file path="database/migrations/2018_01_13_145209_AddLastUsedAtColumn.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddLastUsedAtColumn extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('api_keys', function (Blueprint $table) {
            $table->unsignedTinyInteger('key_type')->after('user_id')->default(0);
            $table->timestamp('last_used_at')->after('memo')->nullable();
            $table->dropColumn('expires_at');

            $table->dropForeign(['user_id']);
        });

        Schema::table('api_keys', function (Blueprint $table) {
            $table->foreign('user_id')->references('id')->on('users')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('api_keys', function (Blueprint $table) {
            $table->timestamp('expires_at')->after('memo')->nullable();
            $table->dropColumn('last_used_at', 'key_type');
            $table->dropForeign(['user_id']);
        });

        Schema::table('api_keys', function (Blueprint $table) {
            $table->foreign('user_id')->references('id')->on('users');
        });
    }
}
</file>

<file path="database/migrations/2018_02_04_145617_AllowTextInUserExternalId.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AllowTextInUserExternalId extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->string('external_id')->nullable()->change();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->unsignedInteger('external_id')->change();
        });
    }
}
</file>

<file path="database/migrations/2018_02_10_151150_remove_unique_index_on_external_id_column.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class RemoveUniqueIndexOnExternalIdColumn extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropUnique(['external_id']);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->unique(['external_id']);
        });
    }
}
</file>

<file path="database/migrations/2018_02_17_134254_ensure_unique_allocation_id_on_servers_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class EnsureUniqueAllocationIdOnServersTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->unique(['allocation_id']);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropForeign(['allocation_id']);
            $table->dropUnique(['allocation_id']);

            $table->foreign('allocation_id')->references('id')->on('allocations');
        });
    }
}
</file>

<file path="database/migrations/2018_02_24_112356_add_external_id_column_to_servers_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddExternalIdColumnToServersTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->string('external_id')->after('id')->nullable()->unique();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn('external_id');
        });
    }
}
</file>

<file path="database/migrations/2018_02_25_160152_remove_default_null_value_on_table.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class RemoveDefaultNullValueOnTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @throws \Exception
     * @throws \Throwable
     */
    public function up()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->string('external_id')->default(null)->change();
        });

        DB::transaction(function () {
            DB::table('users')->where('external_id', '=', 'NULL')->update([
                'external_id' => null,
            ]);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        // This should not be rolled back.
    }
}
</file>

<file path="database/migrations/2018_02_25_160604_define_unique_index_on_users_external_id.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class DefineUniqueIndexOnUsersExternalId extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->index(['external_id']);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropIndex(['external_id']);
        });
    }
}
</file>

<file path="database/migrations/2018_03_01_192831_add_database_and_port_limit_columns_to_servers_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddDatabaseAndPortLimitColumnsToServersTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->unsignedInteger('database_limit')->after('installed')->nullable()->default(0);
            $table->unsignedInteger('allocation_limit')->after('installed')->nullable()->default(0);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn(['database_limit', 'allocation_limit']);
        });
    }
}
</file>

<file path="database/migrations/2018_03_15_124536_add_description_to_nodes.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddDescriptionToNodes extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->text('description')->after('name');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->dropColumn('description');
        });
    }
}
</file>

<file path="database/migrations/2018_05_04_123826_add_maintenance_to_nodes.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddMaintenanceToNodes extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->boolean('maintenance_mode')->after('behind_proxy')->default(false);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->dropColumn('maintenance_mode');
        });
    }
}
</file>

<file path="database/migrations/2018_09_03_143756_allow_egg_variables_to_have_longer_values.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AllowEggVariablesToHaveLongerValues extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('egg_variables', function (Blueprint $table) {
            $table->text('default_value')->change();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('egg_variables', function (Blueprint $table) {
            $table->string('default_value')->change();
        });
    }
}
</file>

<file path="database/migrations/2018_09_03_144005_allow_server_variables_to_have_longer_values.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AllowServerVariablesToHaveLongerValues extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('server_variables', function (Blueprint $table) {
            $table->text('variable_value')->change();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('server_variables', function (Blueprint $table) {
            $table->string('variable_value')->change();
        });
    }
}
</file>

<file path="database/migrations/2019_03_02_142328_set_allocation_limit_default_null.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class SetAllocationLimitDefaultNull extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->unsignedInteger('allocation_limit')->nullable()->default(null)->change();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->unsignedInteger('allocation_limit')->nullable()->default(0)->change();
        });
    }
}
</file>

<file path="database/migrations/2019_03_02_151321_fix_unique_index_to_account_for_host.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class FixUniqueIndexToAccountForHost extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('databases', function (Blueprint $table) {
            $table->dropUnique(['database']);
            $table->dropUnique(['username']);

            $table->unique(['database_host_id', 'database']);
            $table->unique(['database_host_id', 'username']);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('databases', function (Blueprint $table) {
            $table->dropForeign(['database_host_id']);

            $table->dropUnique(['database_host_id', 'database']);
            $table->dropUnique(['database_host_id', 'username']);

            $table->unique(['database']);
            $table->unique(['username']);
        });
    }
}
</file>

<file path="database/migrations/2020_03_22_163911_merge_permissions_table_into_subusers.php">
<?php

use Jexactyl\Models\Permission;
use Illuminate\Support\Collection;
use Illuminate\Support\Facades\DB;
use Jexactyl\Models\Permission as P;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class MergePermissionsTableIntoSubusers extends Migration
{
    /**
     * A list of all pre-1.0 permissions available to a user and their associated
     * casting for the new permissions system.
     *
     * @var array
     */
    protected static $permissionsMap = [
        'power-start' => P::ACTION_CONTROL_START,
        'power-stop' => P::ACTION_CONTROL_STOP,
        'power-restart' => P::ACTION_CONTROL_RESTART,
        'power-kill' => P::ACTION_CONTROL_STOP,
        'send-command' => P::ACTION_CONTROL_CONSOLE,
        'list-subusers' => P::ACTION_USER_READ,
        'view-subuser' => P::ACTION_USER_READ,
        'edit-subuser' => P::ACTION_USER_UPDATE,
        'create-subuser' => P::ACTION_USER_CREATE,
        'delete-subuser' => P::ACTION_USER_DELETE,
        'view-allocations' => P::ACTION_ALLOCATION_READ,
        'edit-allocation' => P::ACTION_ALLOCATION_UPDATE,
        'view-startup' => P::ACTION_STARTUP_READ,
        'edit-startup' => P::ACTION_STARTUP_UPDATE,
        'view-databases' => P::ACTION_DATABASE_READ,
        // Better to just break this flow a bit than accidentally grant a dangerous permission.
        'reset-db-password' => P::ACTION_DATABASE_UPDATE,
        'delete-database' => P::ACTION_DATABASE_DELETE,
        'create-database' => P::ACTION_DATABASE_CREATE,
        'access-sftp' => P::ACTION_FILE_SFTP,
        'list-files' => P::ACTION_FILE_READ,
        'edit-files' => P::ACTION_FILE_READ_CONTENT,
        'save-files' => P::ACTION_FILE_UPDATE,
        'create-files' => P::ACTION_FILE_CREATE,
        'delete-files' => P::ACTION_FILE_DELETE,
        'compress-files' => P::ACTION_FILE_ARCHIVE,
        'list-schedules' => P::ACTION_SCHEDULE_READ,
        'view-schedule' => P::ACTION_SCHEDULE_READ,
        'edit-schedule' => P::ACTION_SCHEDULE_UPDATE,
        'create-schedule' => P::ACTION_SCHEDULE_CREATE,
        'delete-schedule' => P::ACTION_SCHEDULE_DELETE,
        // Skipping these permissions as they are granted if you have more specific read/write permissions.
        'move-files' => null,
        'copy-files' => null,
        'decompress-files' => null,
        'upload-files' => null,
        'download-files' => null,
        // These permissions do not exist in 1.0
        'toggle-schedule' => null,
        'queue-schedule' => null,
    ];

    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('subusers', function (Blueprint $table) {
            $table->json('permissions')->nullable()->after('server_id');
        });

        $cursor = DB::table('permissions')
            ->select(['subuser_id'])
            ->selectRaw('GROUP_CONCAT(permission) as permissions')
            ->from('permissions')
            ->groupBy(['subuser_id'])
            ->cursor();

        DB::transaction(function () use (&$cursor) {
            $cursor->each(function ($datum) {
                $updated = Collection::make(explode(',', $datum->permissions))
                    ->map(function ($value) {
                        return self::$permissionsMap[$value] ?? null;
                    })->filter(function ($value) {
                        return !is_null($value) && $value !== Permission::ACTION_WEBSOCKET_CONNECT;
                    })
                    // All subusers get this permission, so make sure it gets pushed into the array.
                    ->merge([Permission::ACTION_WEBSOCKET_CONNECT])
                    ->unique()
                    ->values()
                    ->toJson();

                DB::update('UPDATE subusers SET permissions = ? WHERE id = ?', [$updated, $datum->subuser_id]);
            });
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        $flipped = array_flip(array_filter(self::$permissionsMap));

        foreach (DB::select('SELECT id, permissions FROM subusers') as $datum) {
            $values = [];
            foreach (json_decode($datum->permissions, true) as $permission) {
                $v = $flipped[$permission] ?? null;
                if (!empty($v)) {
                    $values[] = $datum->id;
                    $values[] = $v;
                }
            }

            if (!empty($values)) {
                $string = 'VALUES ' . implode(', ', array_fill(0, count($values) / 2, '(?, ?)'));

                DB::insert('INSERT INTO permissions(`subuser_id`, `permission`) ' . $string, $values);
            }
        }

        Schema::table('subusers', function (Blueprint $table) {
            $table->dropColumn('permissions');
        });
    }
}
</file>

<file path="database/migrations/2020_03_22_164814_drop_permissions_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class DropPermissionsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::dropIfExists('permissions');
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::create('permissions', function (Blueprint $table) {
            $table->increments('id');
            $table->unsignedInteger('subuser_id');
            $table->string('permission');

            $table->foreign('subuser_id')->references('id')->on('subusers')->onDelete('cascade');
        });
    }
}
</file>

<file path="database/migrations/2020_04_03_203624_add_threads_column_to_servers_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddThreadsColumnToServersTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->string('threads')->nullable()->after('cpu');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn('threads');
        });
    }
}
</file>

<file path="database/migrations/2020_04_03_230614_create_backups_table.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateBackupsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        $db = config('database.default');
        // There exists a backups plugin for the 0.7 version of the Panel. However, it didn't properly
        // namespace itself so now we have to deal with these tables being in the way of tables we're trying
        // to use. For now, just rename them to maintain the data.
        $results = DB::select('SELECT TABLE_NAME FROM information_schema.tables WHERE table_schema = ? AND table_name LIKE ? AND table_name NOT LIKE \'%_plugin_bak\'', [
            config("database.connections.{$db}.database"),
            'backup%',
        ]);

        // Take any of the results, most likely "backups" and "backup_logs" and rename them to have a
        // suffix so data isn't completely lost, but they're no longer in the way of this migration...
        foreach ($results as $result) {
            Schema::rename($result->TABLE_NAME, $result->TABLE_NAME . '_plugin_bak');
        }

        Schema::create('backups', function (Blueprint $table) {
            $table->bigIncrements('id');
            $table->unsignedInteger('server_id');
            $table->char('uuid', 36);
            $table->string('name');
            $table->text('ignored_files');
            $table->string('disk');
            $table->string('sha256_hash')->nullable();
            $table->integer('bytes')->default(0);
            $table->timestamp('completed_at')->nullable();
            $table->timestamps();
            $table->softDeletes();

            $table->unique('uuid');
            $table->foreign('server_id')->references('id')->on('servers')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('backups');
    }
}
</file>

<file path="database/migrations/2020_04_04_131016_add_table_server_transfers.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddTableServerTransfers extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        // Nuclear approach to whatever plugins are out there and not properly namespacing their own tables
        // leading to constant support requests from people...
        Schema::dropIfExists('server_transfers');

        Schema::create('server_transfers', function (Blueprint $table) {
            $table->increments('id');
            $table->integer('server_id')->unsigned();
            $table->tinyInteger('successful')->unsigned()->default(0);
            $table->integer('old_node')->unsigned();
            $table->integer('new_node')->unsigned();
            $table->integer('old_allocation')->unsigned();
            $table->integer('new_allocation')->unsigned();
            $table->string('old_additional_allocations')->nullable();
            $table->string('new_additional_allocations')->nullable();
            $table->timestamps();

            $table->foreign('server_id')->references('id')->on('servers')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('server_transfers');
    }
}
</file>

<file path="database/migrations/2020_04_10_141024_store_node_tokens_as_encrypted_value.php">
<?php

use Ramsey\Uuid\Uuid;
use Illuminate\Support\Facades\DB;
use Illuminate\Container\Container;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;
use Illuminate\Contracts\Encryption\Encrypter;

class StoreNodeTokensAsEncryptedValue extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     *
     * @throws \Exception
     */
    public function up()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->dropUnique(['daemonSecret']);
        });

        Schema::table('nodes', function (Blueprint $table) {
            $table->char('uuid', 36)->after('id');
            $table->char('daemon_token_id', 16)->after('upload_size');
            $table->renameColumn('daemonSecret', 'daemon_token');
        });

        Schema::table('nodes', function (Blueprint $table) {
            $table->text('daemon_token')->change();
        });

        /** @var \Illuminate\Contracts\Encryption\Encrypter $encrypter */
        $encrypter = Container::getInstance()->make(Encrypter::class);

        foreach (DB::select('SELECT id, daemon_token FROM nodes') as $datum) {
            DB::update('UPDATE nodes SET uuid = ?, daemon_token_id = ?, daemon_token = ? WHERE id = ?', [
                Uuid::uuid4()->toString(),
                substr($datum->daemon_token, 0, 16),
                $encrypter->encrypt(substr($datum->daemon_token, 16)),
                $datum->id,
            ]);
        }

        Schema::table('nodes', function (Blueprint $table) {
            $table->unique(['uuid']);
            $table->unique(['daemon_token_id']);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        DB::transaction(function () {
            /** @var \Illuminate\Contracts\Encryption\Encrypter $encrypter */
            $encrypter = Container::getInstance()->make(Encrypter::class);

            foreach (DB::select('SELECT id, daemon_token_id, daemon_token FROM nodes') as $datum) {
                DB::update('UPDATE nodes SET daemon_token = ? WHERE id = ?', [
                    $datum->daemon_token_id . $encrypter->decrypt($datum->daemon_token),
                    $datum->id,
                ]);
            }
        });

        Schema::table('nodes', function (Blueprint $table) {
            $table->dropUnique(['uuid']);
            $table->dropUnique(['daemon_token_id']);
        });

        Schema::table('nodes', function (Blueprint $table) {
            $table->dropColumn(['uuid', 'daemon_token_id']);
            $table->renameColumn('daemon_token', 'daemonSecret');
        });

        Schema::table('nodes', function (Blueprint $table) {
            $table->string('daemonSecret', 36)->change();
            $table->unique(['daemonSecret']);
        });
    }
}
</file>

<file path="database/migrations/2020_04_17_203438_allow_nullable_descriptions.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AllowNullableDescriptions extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('eggs', function (Blueprint $table) {
            $table->text('description')->nullable()->change();
        });

        Schema::table('nests', function (Blueprint $table) {
            $table->text('description')->nullable()->change();
        });

        Schema::table('nodes', function (Blueprint $table) {
            $table->text('description')->nullable()->change();
        });

        Schema::table('locations', function (Blueprint $table) {
            $table->text('long')->nullable()->change();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('eggs', function (Blueprint $table) {
            $table->text('description')->nullable(false)->change();
        });

        Schema::table('nests', function (Blueprint $table) {
            $table->text('description')->nullable(false)->change();
        });

        Schema::table('nodes', function (Blueprint $table) {
            $table->text('description')->nullable(false)->change();
        });

        Schema::table('locations', function (Blueprint $table) {
            $table->text('long')->nullable(false)->change();
        });
    }
}
</file>

<file path="database/migrations/2020_04_22_055500_add_max_connections_column.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddMaxConnectionsColumn extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('databases', function (Blueprint $table) {
            $table->integer('max_connections')->nullable()->default(0)->after('password');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('databases', function (Blueprint $table) {
            $table->dropColumn('max_connections');
        });
    }
}
</file>

<file path="database/migrations/2020_04_26_111208_add_backup_limit_to_servers.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddBackupLimitToServers extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        $db = config('database.default');
        // Same as in the backups migration, we need to handle that plugin messing with the data structure
        // here. If we find a result we'll actually keep the column around since we can maintain that backup
        // limit, but we need to correct the column definition a bit.
        $results = DB::select('SELECT * FROM information_schema.COLUMNS WHERE TABLE_SCHEMA = ? AND TABLE_NAME = \'servers\' AND COLUMN_NAME = \'backup_limit\'', [
            config("database.connections.{$db}.database"),
        ]);

        if (count($results) === 1) {
            Schema::table('servers', function (Blueprint $table) {
                $table->unsignedInteger('backup_limit')->default(0)->change();
            });
        } else {
            Schema::table('servers', function (Blueprint $table) {
                $table->unsignedInteger('backup_limit')->default(0)->after('database_limit');
            });
        }
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn('backup_limit');
        });
    }
}
</file>

<file path="database/migrations/2020_05_20_234655_add_mounts_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddMountsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('mounts', function (Blueprint $table) {
            $table->increments('id')->unique();
            $table->char('uuid', 36)->unique();
            $table->string('name')->unique();
            $table->text('description')->nullable();
            $table->string('source');
            $table->string('target');
            $table->tinyInteger('read_only')->unsigned();
            $table->tinyInteger('user_mountable')->unsigned();
        });

        Schema::create('egg_mount', function (Blueprint $table) {
            $table->integer('egg_id');
            $table->integer('mount_id');

            $table->unique(['egg_id', 'mount_id']);
        });

        Schema::create('mount_node', function (Blueprint $table) {
            $table->integer('node_id');
            $table->integer('mount_id');

            $table->unique(['node_id', 'mount_id']);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('mount_node');
        Schema::dropIfExists('egg_mount');
        Schema::dropIfExists('mounts');
    }
}
</file>

<file path="database/migrations/2020_05_21_192756_add_mount_server_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddMountServerTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('mount_server', function (Blueprint $table) {
            $table->integer('server_id');
            $table->integer('mount_id');

            $table->unique(['server_id', 'mount_id']);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('mount_server');
    }
}
</file>

<file path="database/migrations/2020_07_02_213612_create_user_recovery_tokens_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateUserRecoveryTokensTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('recovery_tokens', function (Blueprint $table) {
            $table->id();
            $table->unsignedInteger('user_id');
            $table->string('token');
            $table->timestamp('created_at')->nullable();

            $table->foreign('user_id')->references('id')->on('users')->cascadeOnDelete();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('recovery_tokens');
    }
}
</file>

<file path="database/migrations/2020_07_09_201845_add_notes_column_for_allocations.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddNotesColumnForAllocations extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('allocations', function (Blueprint $table) {
            $table->string('notes')->nullable()->after('server_id');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('allocations', function (Blueprint $table) {
            $table->dropColumn('notes');
        });
    }
}
</file>

<file path="database/migrations/2020_08_20_205533_add_backup_state_column_to_backups.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddBackupStateColumnToBackups extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('backups', function (Blueprint $table) {
            $table->boolean('is_successful')->after('uuid')->default(true);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('backups', function (Blueprint $table) {
            $table->dropColumn('is_successful');
        });
    }
}
</file>

<file path="database/migrations/2020_08_22_132500_update_bytes_to_unsigned_bigint.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class UpdateBytesToUnsignedBigint extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('backups', function (Blueprint $table) {
            $table->unsignedBigInteger('bytes')->default(0)->change();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('backups', function (Blueprint $table) {
            $table->integer('bytes')->default(0)->change();
        });
    }
}
</file>

<file path="database/migrations/2020_08_23_175331_modify_checksums_column_for_backups.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class ModifyChecksumsColumnForBackups extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('backups', function (Blueprint $table) {
            $table->renameColumn('sha256_hash', 'checksum');
        });

        Schema::table('backups', function (Blueprint $table) {
            DB::update('UPDATE backups SET checksum = CONCAT(\'sha256:\', checksum)');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('backups', function (Blueprint $table) {
            $table->renameColumn('checksum', 'sha256_hash');
        });

        Schema::table('backups', function (Blueprint $table) {
            DB::update('UPDATE backups SET sha256_hash = SUBSTRING(sha256_hash, 8)');
        });
    }
}
</file>

<file path="database/migrations/2020_09_13_110007_drop_packs_from_servers.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class DropPacksFromServers extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropForeign(['pack_id']);
            $table->dropColumn('pack_id');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->unsignedInteger('pack_id')->after('egg_id')->nullable();
            $table->foreign('pack_id')->references('id')->on('packs');
        });
    }
}
</file>

<file path="database/migrations/2020_09_13_110021_drop_packs_from_api_key_permissions.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class DropPacksFromApiKeyPermissions extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('api_keys', function (Blueprint $table) {
            $table->dropColumn('r_packs');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('api_keys', function (Blueprint $table) {
            $table->unsignedTinyInteger('r_packs')->default(0);
        });
    }
}
</file>

<file path="database/migrations/2020_09_13_110047_drop_packs_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class DropPacksTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::dropIfExists('packs');
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::create('packs', function (Blueprint $table) {
            $table->increments('id');
            $table->unsignedInteger('egg_id');
            $table->char('uuid', 36)->unique();
            $table->string('name');
            $table->string('version');
            $table->text('description')->nullable();
            $table->tinyInteger('selectable')->default(1);
            $table->tinyInteger('visible')->default(1);
            $table->tinyInteger('locked')->default(0);
            $table->timestamps();
        });

        Schema::table('packs', function (Blueprint $table) {
            $table->foreign('egg_id')->references('id')->on('eggs')->cascadeOnDelete();
        });
    }
}
</file>

<file path="database/migrations/2020_09_13_113503_drop_daemon_key_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class DropDaemonKeyTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::dropIfExists('daemon_keys');
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::create('daemon_keys', function (Blueprint $table) {
            $table->increments('id');
            $table->unsignedInteger('server_id');
            $table->unsignedInteger('user_id');
            $table->string('secret')->unique();
            $table->timestamp('expires_at');
            $table->timestamps();
        });

        Schema::table('daemon_keys', function (Blueprint $table) {
            $table->foreign('server_id')->references('id')->on('servers')->cascadeOnDelete();
            $table->foreign('user_id')->references('id')->on('users')->cascadeOnDelete();
        });
    }
}
</file>

<file path="database/migrations/2020_10_10_165437_change_unique_database_name_to_account_for_server.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class ChangeUniqueDatabaseNameToAccountForServer extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('databases', function (Blueprint $table) {
            $table->dropUnique(['database_host_id', 'database']);
        });

        Schema::table('databases', function (Blueprint $table) {
            $table->unique(['database_host_id', 'server_id', 'database']);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('databases', function (Blueprint $table) {
            $table->dropUnique(['database_host_id', 'server_id', 'database']);
        });

        Schema::table('databases', function (Blueprint $table) {
            $table->unique(['database_host_id', 'database']);
        });
    }
}
</file>

<file path="database/migrations/2020_10_26_194904_remove_nullable_from_schedule_name_field.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class RemoveNullableFromScheduleNameField extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        DB::update("UPDATE schedules SET name = 'Schedule' WHERE name IS NULL OR name = ''");

        Schema::table('schedules', function (Blueprint $table) {
            $table->string('name')->nullable(false)->change();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('schedules', function (Blueprint $table) {
            $table->string('name')->nullable()->change();
        });
    }
}
</file>

<file path="database/migrations/2020_11_02_201014_add_features_column_to_eggs.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddFeaturesColumnToEggs extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('eggs', function (Blueprint $table) {
            $table->json('features')->after('description')->nullable();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('eggs', function (Blueprint $table) {
            $table->dropColumn('features');
        });
    }
}
</file>

<file path="database/migrations/2020_12_12_102435_support_multiple_docker_images_and_updates.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class SupportMultipleDockerImagesAndUpdates extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('eggs', function (Blueprint $table) {
            $table->json('docker_images')->after('docker_image')->nullable();
            $table->text('update_url')->after('docker_images')->nullable();
        });

        Schema::table('eggs', function (Blueprint $table) {
            DB::statement('UPDATE `eggs` SET `docker_images` = JSON_ARRAY(docker_image)');
        });

        Schema::table('eggs', function (Blueprint $table) {
            $table->dropColumn('docker_image');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('eggs', function (Blueprint $table) {
            $table->text('docker_image')->after('docker_images');
        });

        Schema::table('eggs', function (Blueprint $table) {
            DB::statement('UPDATE `eggs` SET `docker_image` = JSON_UNQUOTE(JSON_EXTRACT(docker_images, "$[0]"))');
        });

        Schema::table('eggs', function (Blueprint $table) {
            $table->dropColumn('docker_images');
            $table->dropColumn('update_url');
        });
    }
}
</file>

<file path="database/migrations/2020_12_14_013707_make_successful_nullable_in_server_transfers.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class MakeSuccessfulNullableInServerTransfers extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('server_transfers', function (Blueprint $table) {
            $table->boolean('successful')->nullable()->default(null)->change();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('server_transfers', function (Blueprint $table) {
            $table->boolean('successful')->default(0)->change();
        });
    }
}
</file>

<file path="database/migrations/2020_12_17_014330_add_archived_field_to_server_transfers_table.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddArchivedFieldToServerTransfersTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('server_transfers', function (Blueprint $table) {
            $table->boolean('archived')->default(0)->after('new_additional_allocations');
        });

        // Update archived to all be true on existing transfers.
        Schema::table('server_transfers', function (Blueprint $table) {
            DB::statement('UPDATE `server_transfers` SET `archived` = 1 WHERE `successful` = 1');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('server_transfers', function (Blueprint $table) {
            $table->dropColumn('archived');
        });
    }
}
</file>

<file path="database/migrations/2020_12_24_092449_make_allocation_fields_json.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class MakeAllocationFieldsJson extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('server_transfers', function (Blueprint $table) {
            $table->json('old_additional_allocations')->nullable()->change();
            $table->json('new_additional_allocations')->nullable()->change();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('server_transfers', function (Blueprint $table) {
            $table->string('old_additional_allocations')->nullable()->change();
            $table->string('new_additional_allocations')->nullable()->change();
        });
    }
}
</file>

<file path="database/migrations/2020_12_26_184914_add_upload_id_column_to_backups_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddUploadIdColumnToBackupsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('backups', function (Blueprint $table) {
            $table->text('upload_id')->nullable()->after('uuid');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('backups', function (Blueprint $table) {
            $table->dropColumn('upload_id');
        });
    }
}
</file>

<file path="database/migrations/2021_01_10_153937_add_file_denylist_to_egg_configs.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddFileDenylistToEggConfigs extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('eggs', function (Blueprint $table) {
            $table->text('file_denylist')->after('docker_images');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('eggs', function (Blueprint $table) {
            $table->dropColumn('file_denylist');
        });
    }
}
</file>

<file path="database/migrations/2021_01_13_013420_add_cron_month.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddCronMonth extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('schedules', function (Blueprint $table) {
            $table->string('cron_month')->after('cron_day_of_week');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('schedules', function (Blueprint $table) {
            $table->dropColumn('cron_month');
        });
    }
}
</file>

<file path="database/migrations/2021_01_17_102401_create_audit_logs_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateAuditLogsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('audit_logs', function (Blueprint $table) {
            $table->id();
            $table->char('uuid', 36);
            $table->boolean('is_system')->default(false);
            $table->unsignedInteger('user_id')->nullable();
            $table->unsignedInteger('server_id')->nullable();
            $table->string('action');
            $table->string('subaction')->nullable();
            $table->json('device');
            $table->json('metadata');
            $table->timestamp('created_at', 0);

            $table->foreign('user_id')->references('id')->on('users')->onDelete('set null');
            $table->foreign('server_id')->references('id')->on('servers')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('audit_logs');
    }
}
</file>

<file path="database/migrations/2021_01_17_152623_add_generic_server_status_column.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddGenericServerStatusColumn extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->string('status')->nullable()->after('description');
        });

        DB::transaction(function () {
            DB::update('UPDATE servers SET `status` = \'suspended\' WHERE `suspended` = 1');
            DB::update('UPDATE servers SET `status` = \'installing\' WHERE `installed` = 0');
            DB::update('UPDATE servers SET `status` = \'install_failed\' WHERE `installed` = 2');
        });

        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn('suspended');
            $table->dropColumn('installed');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->unsignedTinyInteger('suspended')->default(0);
            $table->unsignedTinyInteger('installed')->default(0);
        });

        DB::transaction(function () {
            DB::update('UPDATE servers SET `suspended` = 1 WHERE `status` = \'suspended\'');
            DB::update('UPDATE servers SET `installed` = 1 WHERE `status` IS NULL');
            DB::update('UPDATE servers SET `installed` = 2 WHERE `status` = \'install_failed\'');
        });

        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn('status');
        });
    }
}
</file>

<file path="database/migrations/2021_01_26_210502_update_file_denylist_to_json.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class UpdateFileDenylistToJson extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('eggs', function (Blueprint $table) {
            $table->dropColumn('file_denylist');
        });

        Schema::table('eggs', function (Blueprint $table) {
            $table->json('file_denylist')->nullable()->after('docker_images');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('eggs', function (Blueprint $table) {
            $table->dropColumn('file_denylist');
        });

        Schema::table('eggs', function (Blueprint $table) {
            $table->text('file_denylist')->after('docker_images');
        });
    }
}
</file>

<file path="database/migrations/2021_02_23_205021_add_index_for_server_and_action.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddIndexForServerAndAction extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('audit_logs', function (Blueprint $table) {
            // Doing the index in this order lets me use the action alone without the server
            // or I can later include the server to also filter down at an even more specific
            // level.
            //
            // Ordering the other way around would require a second index for only "action" in
            // order to query a specific action type for any server. Remeber, indexes run left
            // to right in MySQL.
            $table->index(['action', 'server_id']);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('audit_logs', function (Blueprint $table) {
            $table->dropIndex(['action', 'server_id']);
        });
    }
}
</file>

<file path="database/migrations/2021_02_23_212657_make_sftp_port_unsigned_int.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class MakeSftpPortUnsignedInt extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->unsignedSmallInteger('daemonSFTP')->default(2022)->change();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->smallInteger('daemonSFTP')->default(2022)->change();
        });
    }
}
</file>

<file path="database/migrations/2021_03_21_104718_force_cron_month_field_to_have_value_if_missing.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class ForceCronMonthFieldToHaveValueIfMissing extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('schedules', function (Blueprint $table) {
            DB::update("UPDATE `schedules` SET `cron_month` = '*' WHERE `cron_month` = ''");
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        // No down function.
    }
}
</file>

<file path="database/migrations/2021_05_01_092457_add_continue_on_failure_option_to_tasks.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddContinueOnFailureOptionToTasks extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('tasks', function (Blueprint $table) {
            $table->unsignedTinyInteger('continue_on_failure')->after('is_queued')->default(0);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('tasks', function (Blueprint $table) {
            $table->dropColumn('continue_on_failure');
        });
    }
}
</file>

<file path="database/migrations/2021_05_01_092523_add_only_run_when_server_online_option_to_schedules.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddOnlyRunWhenServerOnlineOptionToSchedules extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('schedules', function (Blueprint $table) {
            $table->unsignedTinyInteger('only_when_online')->after('is_processing')->default(0);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('schedules', function (Blueprint $table) {
            $table->dropColumn('only_when_online');
        });
    }
}
</file>

<file path="database/migrations/2021_05_03_201016_add_support_for_locking_a_backup.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddSupportForLockingABackup extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('backups', function (Blueprint $table) {
            $table->unsignedTinyInteger('is_locked')->after('is_successful')->default(0);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('backups', function (Blueprint $table) {
            $table->dropColumn('is_locked');
        });
    }
}
</file>

<file path="database/migrations/2021_07_12_013420_remove_userinteraction.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Database\Migrations\Migration;

class RemoveUserInteraction extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        // Remove User Interaction from startup config
        DB::table('eggs')->update([
            'config_startup' => DB::raw('JSON_REMOVE(config_startup, \'$.userInteraction\')'),
        ]);
    }

    public function down()
    {
        // Add blank User Interaction array back to startup config
        DB::table('eggs')->update([
            'config_startup' => DB::raw('JSON_SET(config_startup, \'$.userInteraction\', JSON_ARRAY())'),
        ]);
    }
}
</file>

<file path="database/migrations/2021_07_17_211512_create_user_ssh_keys_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateUserSshKeysTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up()
    {
        Schema::create('user_ssh_keys', function (Blueprint $table) {
            $table->increments('id');
            $table->unsignedInteger('user_id');
            $table->string('name');
            $table->string('fingerprint');
            $table->text('public_key');
            $table->timestamps();
            $table->softDeletes();

            $table->foreign('user_id')->references('id')->on('users')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down()
    {
        Schema::dropIfExists('user_ssh_keys');
    }
}
</file>

<file path="database/migrations/2021_08_03_210600_change_successful_field_to_default_to_false_on_backups_table.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class ChangeSuccessfulFieldToDefaultToFalseOnBackupsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('backups', function (Blueprint $table) {
            $table->boolean('is_successful')->after('uuid')->default(false)->change();
        });

        // Convert currently processing backups to the new format so things don't break.
        DB::table('backups')->select('id')->where('is_successful', 1)->whereNull('completed_at')->update([
            'is_successful' => 0,
        ]);
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('backups', function (Blueprint $table) {
            $table->boolean('is_successful')->after('uuid')->default(true)->change();
        });
    }
}
</file>

<file path="database/migrations/2021_08_21_175111_add_foreign_keys_to_mount_node_table.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForeignKeysToMountNodeTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        // Fix the columns having a different type than their relations.
        Schema::table('mount_node', function (Blueprint $table) {
            $table->unsignedInteger('node_id')->change();
            $table->unsignedInteger('mount_id')->change();
        });

        // Fetch an array of node and mount ids to check relations against.
        $nodes = DB::table('nodes')->select('id')->pluck('id')->toArray();
        $mounts = DB::table('mounts')->select('id')->pluck('id')->toArray();

        // Drop any relations that are missing a node or mount.
        DB::table('mount_node')
            ->select('node_id', 'mount_id')
            ->whereNotIn('node_id', $nodes)
            ->orWhereNotIn('mount_id', $mounts)
            ->delete();

        Schema::table('mount_node', function (Blueprint $table) {
            $table->foreign('node_id')
                ->references('id')
                ->on('nodes')
                ->cascadeOnDelete()
                ->cascadeOnUpdate();
            $table->foreign('mount_id')->references('id')
                ->on('mounts')
                ->cascadeOnDelete()
                ->cascadeOnUpdate();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('mount_node', function (Blueprint $table) {
            $table->dropForeign(['node_id']);
            $table->dropForeign(['mount_id']);
        });
    }
}
</file>

<file path="database/migrations/2021_08_21_175118_add_foreign_keys_to_mount_server_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForeignKeysToMountServerTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        // Fix the columns having a different type than their relations.
        Schema::table('mount_server', function (Blueprint $table) {
            $table->unsignedInteger('server_id')->change();
            $table->unsignedInteger('mount_id')->change();
        });

        // Fetch an array of node and mount ids to check relations against.
        $servers = DB::table('servers')->select('id')->pluck('id')->toArray();
        $mounts = DB::table('mounts')->select('id')->pluck('id')->toArray();

        // Drop any relations that are missing a server or mount.
        DB::table('mount_server')
            ->select('server_id', 'mount_id')
            ->whereNotIn('server_id', $servers)
            ->orWhereNotIn('mount_id', $mounts)
            ->delete();

        Schema::table('mount_server', function (Blueprint $table) {
            $table->foreign('server_id')
                ->references('id')
                ->on('servers')
                ->cascadeOnDelete()
                ->cascadeOnUpdate();
            $table->foreign('mount_id')->references('id')
                ->on('mounts')
                ->cascadeOnDelete()
                ->cascadeOnUpdate();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('mount_server', function (Blueprint $table) {
            $table->dropForeign(['server_id']);
            $table->dropForeign(['mount_id']);
        });
    }
}
</file>

<file path="database/migrations/2021_08_21_180921_add_foreign_keys_to_egg_mount_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForeignKeysToEggMountTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        // Fix the columns having a different type than their relations.
        Schema::table('egg_mount', function (Blueprint $table) {
            $table->unsignedInteger('egg_id')->change();
            $table->unsignedInteger('mount_id')->change();
        });

        // Fetch an array of node and mount ids to check relations against.
        $eggs = DB::table('eggs')->select('id')->pluck('id')->toArray();
        $mounts = DB::table('mounts')->select('id')->pluck('id')->toArray();

        // Drop any relations that are missing an egg or mount.
        DB::table('egg_mount')
            ->select('egg_id', 'mount_id')
            ->whereNotIn('egg_id', $eggs)
            ->orWhereNotIn('mount_id', $mounts)
            ->delete();

        Schema::table('egg_mount', function (Blueprint $table) {
            $table->foreign('egg_id')
                ->references('id')
                ->on('eggs')
                ->cascadeOnDelete()
                ->cascadeOnUpdate();
            $table->foreign('mount_id')->references('id')
                ->on('mounts')
                ->cascadeOnDelete()
                ->cascadeOnUpdate();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('egg_mount', function (Blueprint $table) {
            $table->dropForeign(['egg_id']);
            $table->dropForeign(['mount_id']);
        });
    }
}
</file>

<file path="database/migrations/2022_01_25_030847_drop_google_analytics.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Database\Migrations\Migration;

class DropGoogleAnalytics extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        DB::table('settings')->where('key', 'settings::app:analytics')->delete();
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        DB::table('settings')->insert(
            [
            'key' => 'settings::app:analytics',
            ]
        );
    }
}
</file>

<file path="database/migrations/2022_05_07_165334_migrate_egg_images_array_to_new_format.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Database\Migrations\Migration;

class MigrateEggImagesArrayToNewFormat extends Migration
{
    /**
     * Run the migrations. This will loop over every egg on the system and update the
     * images array to both exist, and have key => value pairings to support naming the
     * images provided.
     */
    public function up()
    {
        DB::table('eggs')->select(['id', 'docker_images'])->cursor()->each(function ($egg) {
            $images = is_null($egg->docker_images) ? [] : json_decode($egg->docker_images, true, 512, JSON_THROW_ON_ERROR);

            $results = [];
            foreach ($images as $key => $value) {
                $results[is_int($key) ? $value : $key] = $value;
            }

            DB::table('eggs')->where('id', $egg->id)->update(['docker_images' => $results]);
        });
    }

    /**
     * Reverse the migrations. This just keeps the values from the docker images array.
     *
     * @return void
     */
    public function down()
    {
        DB::table('eggs')->select(['id', 'docker_images'])->cursor()->each(function ($egg) {
            DB::table('eggs')->where('id', $egg->id)->update([
                'docker_images' => array_values(json_decode($egg->docker_images, true, 512, JSON_THROW_ON_ERROR)),
            ]);
        });
    }
}
</file>

<file path="database/migrations/2022_05_22_113825_add_account_logs_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddAccountLogsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('account_logs', function (Blueprint $table) {
            $table->id();

            $table->unsignedInteger('user_id');
            $table->string('ip_address');
            $table->string('action');

            $table->timestamp('created_at', 0);
            $table->timestamp('updated_at', 0);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('account_logs');
    }
}
</file>

<file path="database/migrations/2022_05_25_162614_add_store_columns_to_users_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddStoreColumnsToUsersTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->unsignedInteger('store_balance');
            $table->unsignedInteger('store_slot');
            $table->unsignedInteger('store_cpu');
            $table->unsignedInteger('store_memory');
            $table->unsignedInteger('store_disk');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn('store_balance');
            $table->dropColumn('store_slot');
            $table->dropColumn('store_cpu');
            $table->dropColumn('store_memory');
            $table->dropColumn('store_disk');
        });
    }
}
</file>

<file path="database/migrations/2022_05_28_135717_create_activity_logs_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateActivityLogsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('activity_logs', function (Blueprint $table) {
            $table->id();
            $table->uuid('batch')->nullable();
            $table->string('event')->index();
            $table->string('ip');
            $table->text('description')->nullable();
            $table->nullableNumericMorphs('actor');
            $table->json('properties');
            $table->timestamp('timestamp')->useCurrent()->onUpdate(null);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('activity_logs');
    }
}
</file>

<file path="database/migrations/2022_05_29_140349_create_activity_log_actors_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateActivityLogActorsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('activity_log_subjects', function (Blueprint $table) {
            $table->id();
            $table->foreignId('activity_log_id')->references('id')->on('activity_logs')->cascadeOnDelete();
            $table->numericMorphs('subject');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('activity_log_subjects');
    }
}
</file>

<file path="database/migrations/2022_06_04_173523_add_all_resources_to_users_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddAllResourcesToUsersTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn('store_slot');

            $table->unsignedInteger('store_slots');
            $table->unsignedInteger('store_ports');
            $table->unsignedInteger('store_backups');
            $table->unsignedInteger('store_databases');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->unsignedInteger('store_slot');

            $table->dropColumn('store_slots');
            $table->dropColumn('store_ports');
            $table->dropColumn('store_backups');
            $table->dropColumn('store_databases');
        });
    }
}
</file>

<file path="database/migrations/2022_06_12_144516_add_renew_columns_to_servers_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddRenewColumnsToServersTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->boolean('renewable')->default(false);
            $table->unsignedInteger('renewal')->default(0);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn('renewal');
            $table->dropColumn('renewable');
        });
    }
}
</file>

<file path="database/migrations/2022_06_17_223301_add_theme_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddThemeTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('theme', function (Blueprint $table) {
            $table->string('background');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('theme', function (Blueprint $table) {
            $table->dropColumn('background');
        });
    }
}
</file>

<file path="database/migrations/2022_06_18_112822_track_api_key_usage_for_activity_events.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

return new class () extends Migration {
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('activity_logs', function (Blueprint $table) {
            $table->unsignedInteger('api_key_id')->nullable()->after('actor_id');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('activity_logs', function (Blueprint $table) {
            $table->dropColumn('api_key_id');
        });
    }
};
</file>

<file path="database/migrations/2022_06_18_224647_add_paypal_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddPaypalTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('paypal', function (Blueprint $table) {
            $table->unsignedInteger('user_id');
            $table->unsignedInteger('amount');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('paypal', function (Blueprint $table) {
            $table->dropColumn('user_id');
            $table->dropColumn('amount');
        });
    }
}
</file>

<file path="database/migrations/2022_06_20_123938_add_ip_to_users_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddIpToUsersTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->ipAddress('ip');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn('ip');
        });
    }
}
</file>

<file path="database/migrations/2022_06_20_130855_drop_account_logs_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class DropAccountLogsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::dropIfExists('account_logs');
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::create('account_logs', function (Blueprint $table) {
            $table->id();

            $table->unsignedInteger('user_id');
            $table->string('ip_address');
            $table->string('action');

            $table->timestamp('created_at', 0);
            $table->timestamp('updated_at', 0);
        });
    }
}
</file>

<file path="database/migrations/2022_06_20_131128_drop_audit_logs_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class DropAuditLogsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::dropIfExists('audit_logs');
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::create('audit_logs', function (Blueprint $table) {
            $table->id();
            $table->char('uuid', 36);
            $table->boolean('is_system')->default(false);
            $table->unsignedInteger('user_id')->nullable();
            $table->unsignedInteger('server_id')->nullable();
            $table->string('action');
            $table->string('subaction')->nullable();
            $table->json('device');
            $table->json('metadata');
            $table->timestamp('created_at', 0);

            $table->foreign('user_id')->references('id')->on('users')->onDelete('set null');
            $table->foreign('server_id')->references('id')->on('servers')->onDelete('cascade');
        });
    }
}
</file>

<file path="database/migrations/2022_07_11_230950_add_referral_codes_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddReferralCodesTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('referral_codes', function (Blueprint $table) {
            $table->id();
            $table->unsignedInteger('user_id');
            $table->string('code')->unique();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('referral_codes');
    }
}
</file>

<file path="database/migrations/2022_07_12_165032_add_referral_code_to_users_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddReferralCodeToUsersTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->text('referral_code');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn('referral_code');
        });
    }
}
</file>

<file path="database/migrations/2022_07_23_190604_add_discord_id_to_users.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddDiscordIdToUsers extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->string('discord_id')->nullable();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn('discord_id');
        });
    }
}
</file>

<file path="database/migrations/2022_08_07_001901_add_bg_to_servers_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddBgToServersTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->string('bg')->nullable();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn('bg');
        });
    }
}
</file>

<file path="database/migrations/2022_08_10_134436_add_deployable_column_to_nodes_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddDeployableColumnToNodesTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->boolean('deployable')->default(true);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->dropColumn('deployable');
        });
    }
}
</file>

<file path="database/migrations/2022_08_10_145812_add_approved_to_users_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddApprovedToUsersTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->boolean('approved')->default(true);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn('approved');
        });
    }
}
</file>

<file path="database/migrations/2022_08_16_214400_add_force_outgoing_ip_column_to_eggs_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddForceOutgoingIpColumnToEggsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('eggs', function (Blueprint $table) {
            $table->boolean('force_outgoing_ip')->default(false);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('eggs', function (Blueprint $table) {
            $table->dropColumn('force_outgoing_ip');
        });
    }
}
</file>

<file path="database/migrations/2022_08_16_230204_add_installed_at_column_to_servers_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddInstalledAtColumnToServersTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->timestamp('installed_at')->nullable();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('servers', function (Blueprint $table) {
            $table->dropColumn('installed_at');
        });
    }
}
</file>

<file path="database/migrations/2022_09_04_051735_add_verified_to_users_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddVerifiedToUsersTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->boolean('verified')->default(true);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn('verified');
        });
    }
}
</file>

<file path="database/migrations/2022_09_05_010352_add_verification_tokens_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddVerificationTokensTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('verification_tokens', function (Blueprint $table) {
            $table->id();
            $table->integer('user');
            $table->string('token');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('verification_tokens');
    }
}
</file>

<file path="database/migrations/2022_09_13_173359_add_default_server_deletion_key_to_settings_table.php">
<?php

use Illuminate\Database\Migrations\Migration;

class AddDefaultServerDeletionKeyToSettingsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        DB::table('settings')->insertOrIgnore(
            [
                'key' => 'jexactyl::renewal:deletion',
                'value' => 'true',
            ],
        );
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        DB::table('settings')
            ->where('key', 'jexactyl::renewal:deletion')
            ->delete();
    }
}
</file>

<file path="database/migrations/2022_10_25_212742_add_private_column_to_nests_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

return new class () extends Migration {
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('nests', function (Blueprint $table) {
            $table->boolean('private')->nullable()->default(false);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('nests', function (Blueprint $table) {
            $table->dropColumn('private');
        });
    }
};
</file>

<file path="database/migrations/2022_11_08_215353_make_nest_visibility_required_to_nests_table.php">
<?php

use Jexactyl\Models\Nest;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

return new class () extends Migration {
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('nests', function (Blueprint $table) {
            $table->boolean('private')->default(false)->change();

            $nests = Nest::where('private', null)->get();
            foreach ($nests as $nest) {
                $nest->update(['private', false]);
            }
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('nests', function (Blueprint $table) {
            $table->boolean('private')->nullable()->default(false)->change();
        });
    }
};
</file>

<file path="database/migrations/2022_11_10_131338_create_referral_uses_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

return new class () extends Migration {
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('referral_uses', function (Blueprint $table) {
            $table->id();
            $table->text('code_used');
            $table->integer('user_id');
            $table->integer('referrer_id');
            $table->integer('credit_given');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('referral_uses');
    }
};
</file>

<file path="database/migrations/2022_11_27_231907_create_coupons_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

return new class () extends Migration {
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('coupons', function (Blueprint $table) {
            $table->id();
            $table->string('code');
            $table->integer('uses');
            $table->integer('cr_amount');
            $table->dateTime('expires')->nullable();
            $table->boolean('expired')->default(false);
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('coupons');
    }
};
</file>

<file path="database/migrations/2022_12_12_213937_update_mail_settings_to_new_format.php">
<?php

use Jexactyl\Models\Setting;
use Illuminate\Support\Facades\DB;
use Illuminate\Database\Migrations\Migration;

return new class () extends Migration {
    private array $keys = [
        ['mail:host', 'mail:mailers:smtp:host'],
        ['mail:port', 'mail:mailers:smtp:port'],
        ['mail:encryption', 'mail:mailers:smtp:encryption'],
        ['mail:username', 'mail:mailers:smtp:username'],
        ['mail:password', 'mail:mailers:smtp:password'],
    ];

    /**
     * Run the migrations.
     */
    public function up(): void
    {
        $settings = Setting::all();

        // Gets the first column in our key table and gets all matching settings.
        $oldKeys = array_column($this->keys, 0);
        $oldSettings = $settings->filter(fn (Setting $setting) => in_array($setting->key, $oldKeys));

        // Gets the second column in our key table and gets all matching settings.
        $newKeys = array_column($this->keys, 1);
        $newSettings = $settings->filter(fn (Setting $setting) => in_array($setting->key, $newKeys));

        // Map all the old settings to their new key.
        $oldSettings->map(function (Setting $setting) use ($oldKeys) {
            $row = array_search($setting->key, $oldKeys, true);
            $setting->key = $this->keys[$row][1];

            return $setting;
            // Check if any settings with the new key already exist.
        })->filter(function (Setting $setting) use ($newSettings) {
            if ($newSettings->contains('key', $setting->key)) {
                return false;
            }

            return true;
            // Update the settings to use their new keys if they don't already exist.
        })->each(fn (Setting $setting) => $setting->save());
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        DB::transaction(function () {
            $settings = Setting::all();

            // Gets the second column in our key table and gets all matching settings.
            $newKeys = array_column($this->keys, 0);
            $newSettings = $settings->filter(fn (Setting $setting) => in_array($setting->key, $newKeys));

            // Delete all settings that already have the new key.
            $newSettings->each(fn (Setting $setting) => $setting->delete());

            // Gets the first column in our key table and gets all matching settings.
            $oldKeys = array_column($this->keys, 1);
            $oldSettings = $settings->filter(fn (Setting $setting) => in_array($setting->key, $oldKeys));

            // Map all the old settings to their new key.
            $oldSettings->map(function (Setting $setting) use ($oldKeys) {
                $row = array_search($setting->key, $oldKeys, true);
                $setting->key = $this->keys[$row][0];

                return $setting;
                // Update the settings to use their new keys if they don't already exist.
            })->each(fn (Setting $setting) => $setting->save());
        });
    }
};
</file>

<file path="database/migrations/2022_12_13_190432_create_tickets_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

return new class () extends Migration {
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('tickets', function (Blueprint $table) {
            $table->id();
            $table->unsignedInteger('staff_id')->nullable();
            $table->unsignedInteger('client_id');
            $table->string('title');
            $table->string('status');
            $table->text('content');
            $table->mediumInteger('message_count');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('tickets');
    }
};
</file>

<file path="database/migrations/2022_12_13_192408_create_ticket_messages_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

return new class () extends Migration {
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('ticket_messages', function (Blueprint $table) {
            $table->id();
            $table->unsignedInteger('user_id')->nullable();
            $table->unsignedInteger('ticket_id');
            $table->text('content');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('ticket_messages');
    }
};
</file>

<file path="database/migrations/2023_01_09_163835_create_analytics_messages_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

return new class () extends Migration {
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('analytics_messages', function (Blueprint $table) {
            $table->id();
            $table->unsignedInteger('server_id');
            $table->string('title');
            $table->string('content');
            $table->string('type');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('analytics_messages');
    }
};
</file>

<file path="database/migrations/2023_01_09_163856_create_analytics_data_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

return new class () extends Migration {
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('analytics_data', function (Blueprint $table) {
            $table->id();
            $table->unsignedInteger('server_id');
            $table->unsignedInteger('cpu');
            $table->unsignedInteger('memory');
            $table->unsignedInteger('disk');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('analytics_data');
    }
};
</file>

<file path="database/migrations/2023_01_23_183911_add_deploy_fee_to_nodes_table.php">
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

return new class () extends Migration {
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->unsignedInteger('deploy_fee')->nullable()->default(0);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('nodes', function (Blueprint $table) {
            $table->dropColumn('deploy_fee');
        });
    }
};
</file>

<file path="database/migrations/2023_01_24_210051_add_uuid_column_to_failed_jobs_table.php">
<?php

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

return new class () extends Migration {
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('failed_jobs', function (Blueprint $table) {
            $table->string('uuid')->after('id')->nullable()->unique();
        });

        DB::table('failed_jobs')->whereNull('uuid')->cursor()->each(function ($job) {
            DB::table('failed_jobs')
                ->where('id', $job->id)
                ->update(['uuid' => (string) Illuminate\Support\Str::uuid()]);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('failed_jobs', function (Blueprint $table) {
            $table->dropColumn('uuid');
        });
    }
};
</file>

<file path="database/Seeders/eggs/minecraft/egg-bungeecord.json">
{
    "_comment": "DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY Jexactyl PANEL - jexactyl.com",
    "meta": {
        "version": "PTDL_v2",
        "update_url": null
    },
    "exported_at": "2022-06-17T08:10:44+03:00",
    "name": "Bungeecord",
    "author": "support@jexactyl.com",
    "description": "For a long time, Minecraft server owners have had a dream that encompasses a free, easy, and reliable way to connect multiple Minecraft servers together. BungeeCord is the answer to said dream. Whether you are a small server wishing to string multiple game-modes together, or the owner of the ShotBow Network, BungeeCord is the ideal solution for you. With the help of BungeeCord, you will be able to unlock your community's full potential.",
    "features": ["eula", "java_version", "pid_limit"],
    "docker_images": {
        "Java 17": "ghcr.io/pterodactyl/yolks:java_17",
        "Java 16": "ghcr.io/pterodactyl/yolks:java_16",
        "Java 11": "ghcr.io/pterodactyl/yolks:java_11",
        "Java 8": "ghcr.io/pterodactyl/yolks:java_8"
    },
    "file_denylist": [],
    "startup": "java -Xms128M -XX:MaxRAMPercentage=95.0 -jar {{SERVER_JARFILE}}",
    "config": {
        "files": "{\r\n    \"config.yml\": {\r\n        \"parser\": \"yaml\",\r\n        \"find\": {\r\n            \"listeners[0].query_port\": \"{{server.build.default.port}}\",\r\n            \"listeners[0].host\": \"0.0.0.0:{{server.build.default.port}}\",\r\n            \"servers.*.address\": {\r\n                \"regex:^(127\\\\.0\\\\.0\\\\.1|localhost)(:\\\\d{1,5})?$\": \"{{config.docker.interface}}$2\"\r\n            }\r\n        }\r\n    }\r\n}",
        "startup": "{\r\n    \"done\": \"Listening on \"\r\n}",
        "logs": "{}",
        "stop": "end"
    },
    "scripts": {
        "installation": {
            "script": "#!/bin/ash\r\n# Bungeecord Installation Script\r\n#\r\n# Server Files: /mnt/server\r\n\r\ncd /mnt/server\r\n\r\nif [ -z \"${BUNGEE_VERSION}\" ] || [ \"${BUNGEE_VERSION}\" == \"latest\" ]; then\r\n    BUNGEE_VERSION=\"lastStableBuild\"\r\nfi\r\n\r\ncurl -o ${SERVER_JARFILE} https://ci.md-5.net/job/BungeeCord/${BUNGEE_VERSION}/artifact/bootstrap/target/BungeeCord.jar",
            "container": "ghcr.io/pterodactyl/installers:alpine",
            "entrypoint": "ash"
        }
    },
    "variables": [
        {
            "name": "Bungeecord Version",
            "description": "The version of Bungeecord to download and use.",
            "env_variable": "BUNGEE_VERSION",
            "default_value": "latest",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|alpha_num|between:1,6",
            "field_type": "text"
        },
        {
            "name": "Bungeecord Jar File",
            "description": "The name of the Jarfile to use when running Bungeecord.",
            "env_variable": "SERVER_JARFILE",
            "default_value": "bungeecord.jar",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|regex:/^([\\w\\d._-]+)(\\.jar)$/",
            "field_type": "text"
        }
    ]
}
</file>

<file path="database/Seeders/eggs/minecraft/egg-forge-minecraft.json">
{
    "_comment": "DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY Jexactyl PANEL - jexactyl.com",
    "meta": {
        "version": "PTDL_v2",
        "update_url": null
    },
    "exported_at": "2022-11-06T06:33:01-05:00",
    "name": "Forge Minecraft",
    "author": "support@jexactyl.com",
    "description": "Minecraft Forge Server. Minecraft Forge is a modding API (Application Programming Interface), which makes it easier to create mods, and also make sure mods are compatible with each other.",
    "features": ["eula", "java_version", "pid_limit"],
    "docker_images": {
        "Java 17": "ghcr.io/pterodactyl/yolks:java_17",
        "Java 16": "ghcr.io/pterodactyl/yolks:java_16",
        "Java 11": "ghcr.io/pterodactyl/yolks:java_11",
        "Java 8": "ghcr.io/pterodactyl/yolks:java_8"
    },
    "file_denylist": [],
    "startup": "java -Xms128M -XX:MaxRAMPercentage=95.0 -Dterminal.jline=false -Dterminal.ansi=true $( [[  ! -f unix_args.txt ]] && printf %s \"-jar {{SERVER_JARFILE}}\" || printf %s \"@unix_args.txt\" )",
    "config": {
        "files": "{\r\n    \"server.properties\": {\r\n        \"parser\": \"properties\",\r\n        \"find\": {\r\n            \"server-ip\": \"0.0.0.0\",\r\n            \"server-port\": \"{{server.build.default.port}}\",\r\n            \"query.port\": \"{{server.build.default.port}}\"\r\n        }\r\n    }\r\n}",
        "startup": "{\r\n    \"done\": \")! For help, type \"\r\n}",
        "logs": "{}",
        "stop": "stop"
    },
    "scripts": {
        "installation": {
            "script": "#!/bin/bash\r\n# Forge Installation Script\r\n#\r\n# Server Files: /mnt/server\r\napt update\r\napt install -y curl jq\r\n\r\nif [[ ! -d /mnt/server ]]; then\r\n  mkdir /mnt/server\r\nfi\r\n\r\ncd /mnt/server\r\n\r\n# Remove spaces from the version number to avoid issues with curl\r\nFORGE_VERSION=\"$(echo \"$FORGE_VERSION\" | tr -d ' ')\"\r\nMC_VERSION=\"$(echo \"$MC_VERSION\" | tr -d ' ')\"\r\n\r\nif [[ ! -z ${FORGE_VERSION} ]]; then\r\n  DOWNLOAD_LINK=https://maven.minecraftforge.net/net/minecraftforge/forge/${FORGE_VERSION}/forge-${FORGE_VERSION}\r\n  FORGE_JAR=forge-${FORGE_VERSION}*.jar\r\nelse\r\n  JSON_DATA=$(curl -sSL https://files.minecraftforge.net/maven/net/minecraftforge/forge/promotions_slim.json)\r\n\r\n  if [[ \"${MC_VERSION}\" == \"latest\" ]] || [[ \"${MC_VERSION}\" == \"\" ]]; then\r\n    echo -e \"getting latest version of forge.\"\r\n    MC_VERSION=$(echo -e ${JSON_DATA} | jq -r '.promos | del(.\"latest-1.7.10\") | del(.\"1.7.10-latest-1.7.10\") | to_entries[] | .key | select(contains(\"latest\")) | split(\"-\")[0]' | sort -t. -k 1,1n -k 2,2n -k 3,3n -k 4,4n | tail -1)\r\n    BUILD_TYPE=latest\r\n  fi\r\n\r\n  if [[ \"${BUILD_TYPE}\" != \"recommended\" ]] && [[ \"${BUILD_TYPE}\" != \"latest\" ]]; then\r\n    BUILD_TYPE=recommended\r\n  fi\r\n\r\n  echo -e \"minecraft version: ${MC_VERSION}\"\r\n  echo -e \"build type: ${BUILD_TYPE}\"\r\n\r\n  ## some variables for getting versions and things\r\n  FILE_SITE=https://maven.minecraftforge.net/net/minecraftforge/forge/\r\n  VERSION_KEY=$(echo -e ${JSON_DATA} | jq -r --arg MC_VERSION \"${MC_VERSION}\" --arg BUILD_TYPE \"${BUILD_TYPE}\" '.promos | del(.\"latest-1.7.10\") | del(.\"1.7.10-latest-1.7.10\") | to_entries[] | .key | select(contains($MC_VERSION)) | select(contains($BUILD_TYPE))')\r\n\r\n  ## locating the forge version\r\n  if [[ \"${VERSION_KEY}\" == \"\" ]] && [[ \"${BUILD_TYPE}\" == \"recommended\" ]]; then\r\n    echo -e \"dropping back to latest from recommended due to there not being a recommended version of forge for the mc version requested.\"\r\n    VERSION_KEY=$(echo -e ${JSON_DATA} | jq -r --arg MC_VERSION \"${MC_VERSION}\" '.promos | del(.\"latest-1.7.10\") | del(.\"1.7.10-latest-1.7.10\") | to_entries[] | .key | select(contains($MC_VERSION)) | select(contains(\"latest\"))')\r\n  fi\r\n\r\n  ## Error if the mc version set wasn't valid.\r\n  if [ \"${VERSION_KEY}\" == \"\" ] || [ \"${VERSION_KEY}\" == \"null\" ]; then\r\n    echo -e \"The install failed because there is no valid version of forge for the version of minecraft selected.\"\r\n    exit 1\r\n  fi\r\n\r\n  FORGE_VERSION=$(echo -e ${JSON_DATA} | jq -r --arg VERSION_KEY \"$VERSION_KEY\" '.promos | .[$VERSION_KEY]')\r\n\r\n  if [[ \"${MC_VERSION}\" == \"1.7.10\" ]] || [[ \"${MC_VERSION}\" == \"1.8.9\" ]]; then\r\n    DOWNLOAD_LINK=${FILE_SITE}${MC_VERSION}-${FORGE_VERSION}-${MC_VERSION}/forge-${MC_VERSION}-${FORGE_VERSION}-${MC_VERSION}\r\n    FORGE_JAR=forge-${MC_VERSION}-${FORGE_VERSION}-${MC_VERSION}.jar\r\n    if [[ \"${MC_VERSION}\" == \"1.7.10\" ]]; then\r\n      FORGE_JAR=forge-${MC_VERSION}-${FORGE_VERSION}-${MC_VERSION}-universal.jar\r\n    fi\r\n  else\r\n    DOWNLOAD_LINK=${FILE_SITE}${MC_VERSION}-${FORGE_VERSION}/forge-${MC_VERSION}-${FORGE_VERSION}\r\n    FORGE_JAR=forge-${MC_VERSION}-${FORGE_VERSION}.jar\r\n  fi\r\nfi\r\n\r\n#Adding .jar when not eding by SERVER_JARFILE\r\nif [[ ! $SERVER_JARFILE = *\\.jar ]]; then\r\n  SERVER_JARFILE=\"$SERVER_JARFILE.jar\"\r\nfi\r\n\r\n#Downloading jars\r\necho -e \"Downloading forge version ${FORGE_VERSION}\"\r\necho -e \"Download link is ${DOWNLOAD_LINK}\"\r\n\r\nif [[ ! -z \"${DOWNLOAD_LINK}\" ]]; then\r\n  if curl --output /dev/null --silent --head --fail ${DOWNLOAD_LINK}-installer.jar; then\r\n    echo -e \"installer jar download link is valid.\"\r\n  else\r\n    echo -e \"link is invalid. Exiting now\"\r\n    exit 2\r\n  fi\r\nelse\r\n  echo -e \"no download link provided. Exiting now\"\r\n  exit 3\r\nfi\r\n\r\ncurl -s -o installer.jar -sS ${DOWNLOAD_LINK}-installer.jar\r\n\r\n#Checking if downloaded jars exist\r\nif [[ ! -f ./installer.jar ]]; then\r\n  echo \"!!! Error downloading forge version ${FORGE_VERSION} !!!\"\r\n  exit\r\nfi\r\n\r\nfunction  unix_args {\r\n  echo -e \"Detected Forge 1.17 or newer version. Setting up forge unix args.\"\r\n  ln -sf libraries/net/minecraftforge/forge/*/unix_args.txt unix_args.txt\r\n}\r\n\r\n# Delete args to support downgrading/upgrading\r\nrm -rf libraries/net/minecraftforge/forge\r\nrm unix_args.txt\r\n\r\n#Installing server\r\necho -e \"Installing forge server.\\n\"\r\njava -jar installer.jar --installServer || { echo -e \"\\nInstall failed using Forge version ${FORGE_VERSION} and Minecraft version ${MINECRAFT_VERSION}.\\nShould you be using unlimited memory value of 0, make sure to increase the default install resource limits in the Wings config or specify exact allocated memory in the server Build Configuration instead of 0! \\nOtherwise, the Forge installer will not have enough memory.\"; exit 4; }\r\n\r\n# Check if we need a symlink for 1.17+ Forge JPMS args\r\nif [[ $MC_VERSION =~ ^1\\.(17|18|19|20|21|22|23) || $FORGE_VERSION =~ ^1\\.(17|18|19|20|21|22|23) ]]; then\r\n  unix_args\r\n\r\n# Check if someone has set MC to latest but overwrote it with older Forge version, otherwise we would have false positives\r\nelif [[ $MC_VERSION == \"latest\" && $FORGE_VERSION =~ ^1\\.(17|18|19|20|21|22|23) ]]; then\r\n  unix_args\r\nelse\r\n  # For versions below 1.17 that ship with jar\r\n  mv $FORGE_JAR $SERVER_JARFILE\r\nfi\r\n\r\necho -e \"Deleting installer.jar file.\\n\"\r\nrm -rf installer.jar\r\necho -e \"Installation process is completed\"",
            "container": "openjdk:8-jdk-slim",
            "entrypoint": "bash"
        }
    },
    "variables": [
        {
            "name": "Server Jar File",
            "description": "The name of the Jarfile to use when running Forge version below 1.17.",
            "env_variable": "SERVER_JARFILE",
            "default_value": "server.jar",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|regex:/^([\\w\\d._-]+)(\\.jar)$/",
            "field_type": "text"
        },
        {
            "name": "Minecraft Version",
            "description": "The version of minecraft you want to install for.\r\n\r\nLeaving latest will install the latest recommended version.",
            "env_variable": "MC_VERSION",
            "default_value": "latest",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|string|max:9",
            "field_type": "text"
        },
        {
            "name": "Build Type",
            "description": "The type of server jar to download from forge.\r\n\r\nValid types are \"recommended\" and \"latest\".",
            "env_variable": "BUILD_TYPE",
            "default_value": "recommended",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|string|in:recommended,latest",
            "field_type": "text"
        },
        {
            "name": "Forge Version",
            "description": "The full exact version.\r\n\r\nEx. 1.15.2-31.2.4\r\n\r\nOverrides MC_VERSION and BUILD_TYPE. If it fails to download the server files it will fail to install.",
            "env_variable": "FORGE_VERSION",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "nullable|regex:/^[0-9\\.\\-]+$/",
            "field_type": "text"
        }
    ]
}
</file>

<file path="database/Seeders/eggs/minecraft/egg-paper.json">
{
    "_comment": "DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY Jexactyl PANEL - jexactyl.com",
    "meta": {
        "version": "PTDL_v2",
        "update_url": null
    },
    "exported_at": "2022-06-17T08:11:30+03:00",
    "name": "Paper",
    "author": "parker@jexactyl.com",
    "description": "High performance Spigot fork that aims to fix gameplay and mechanics inconsistencies.",
    "features": ["eula", "java_version", "pid_limit"],
    "docker_images": {
        "Java 17": "ghcr.io/pterodactyl/yolks:java_17",
        "Java 16": "ghcr.io/pterodactyl/yolks:java_16",
        "Java 11": "ghcr.io/pterodactyl/yolks:java_11",
        "Java 8": "ghcr.io/pterodactyl/yolks:java_8"
    },
    "file_denylist": [],
    "startup": "java -Xms128M -XX:MaxRAMPercentage=95.0 -Dterminal.jline=false -Dterminal.ansi=true -jar {{SERVER_JARFILE}}",
    "config": {
        "files": "{\r\n    \"server.properties\": {\r\n        \"parser\": \"properties\",\r\n        \"find\": {\r\n            \"server-ip\": \"0.0.0.0\",\r\n            \"server-port\": \"{{server.build.default.port}}\",\r\n            \"query.port\": \"{{server.build.default.port}}\"\r\n        }\r\n    }\r\n}",
        "startup": "{\r\n    \"done\": \")! For help, type \"\r\n}",
        "logs": "{}",
        "stop": "stop"
    },
    "scripts": {
        "installation": {
            "script": "#!/bin/ash\r\n# Paper Installation Script\r\n#\r\n# Server Files: /mnt/server\r\nPROJECT=paper\r\n\r\nif [ -n \"${DL_PATH}\" ]; then\r\n\techo -e \"Using supplied download url: ${DL_PATH}\"\r\n\tDOWNLOAD_URL=`eval echo $(echo ${DL_PATH} | sed -e 's/{{/${/g' -e 's/}}/}/g')`\r\nelse\r\n\tVER_EXISTS=`curl -s https://api.papermc.io/v2/projects/${PROJECT} | jq -r --arg VERSION $MINECRAFT_VERSION '.versions[] | contains($VERSION)' | grep -m1 true`\r\n\tLATEST_VERSION=`curl -s https://api.papermc.io/v2/projects/${PROJECT} | jq -r '.versions' | jq -r '.[-1]'`\r\n\r\n\tif [ \"${VER_EXISTS}\" == \"true\" ]; then\r\n\t\techo -e \"Version is valid. Using version ${MINECRAFT_VERSION}\"\r\n\telse\r\n\t\techo -e \"Specified version not found. Defaulting to the latest ${PROJECT} version\"\r\n\t\tMINECRAFT_VERSION=${LATEST_VERSION}\r\n\tfi\r\n\r\n\tBUILD_EXISTS=`curl -s https://api.papermc.io/v2/projects/${PROJECT}/versions/${MINECRAFT_VERSION} | jq -r --arg BUILD ${BUILD_NUMBER} '.builds[] | tostring | contains($BUILD)' | grep -m1 true`\r\n\tLATEST_BUILD=`curl -s https://api.papermc.io/v2/projects/${PROJECT}/versions/${MINECRAFT_VERSION} | jq -r '.builds' | jq -r '.[-1]'`\r\n\r\n\tif [ \"${BUILD_EXISTS}\" == \"true\" ]; then\r\n\t\techo -e \"Build is valid for version ${MINECRAFT_VERSION}. Using build ${BUILD_NUMBER}\"\r\n\telse\r\n\t\techo -e \"Using the latest ${PROJECT} build for version ${MINECRAFT_VERSION}\"\r\n\t\tBUILD_NUMBER=${LATEST_BUILD}\r\n\tfi\r\n\r\n\tJAR_NAME=${PROJECT}-${MINECRAFT_VERSION}-${BUILD_NUMBER}.jar\r\n\r\n\techo \"Version being downloaded\"\r\n\techo -e \"MC Version: ${MINECRAFT_VERSION}\"\r\n\techo -e \"Build: ${BUILD_NUMBER}\"\r\n\techo -e \"JAR Name of Build: ${JAR_NAME}\"\r\n\tDOWNLOAD_URL=https://api.papermc.io/v2/projects/${PROJECT}/versions/${MINECRAFT_VERSION}/builds/${BUILD_NUMBER}/downloads/${JAR_NAME}\r\nfi\r\n\r\ncd /mnt/server\r\n\r\necho -e \"Running curl -o ${SERVER_JARFILE} ${DOWNLOAD_URL}\"\r\n\r\nif [ -f ${SERVER_JARFILE} ]; then\r\n\tmv ${SERVER_JARFILE} ${SERVER_JARFILE}.old\r\nfi\r\n\r\ncurl -o ${SERVER_JARFILE} ${DOWNLOAD_URL}\r\n\r\nif [ ! -f server.properties ]; then\r\n    echo -e \"Downloading MC server.properties\"\r\n    curl -o server.properties https://raw.githubusercontent.com/parkervcp/eggs/master/minecraft/java/server.properties\r\nfi",
            "container": "ghcr.io/pterodactyl/installers:alpine",
            "entrypoint": "ash"
        }
    },
    "variables": [
        {
            "name": "Minecraft Version",
            "description": "The version of minecraft to download. \r\n\r\nLeave at latest to always get the latest version. Invalid versions will default to latest.",
            "env_variable": "MINECRAFT_VERSION",
            "default_value": "latest",
            "user_viewable": true,
            "user_editable": true,
            "rules": "nullable|string|max:20",
            "field_type": "text"
        },
        {
            "name": "Server Jar File",
            "description": "The name of the server jarfile to run the server with.",
            "env_variable": "SERVER_JARFILE",
            "default_value": "server.jar",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|regex:/^([\\w\\d._-]+)(\\.jar)$/",
            "field_type": "text"
        },
        {
            "name": "Download Path",
            "description": "A URL to use to download a server.jar rather than the ones in the install script. This is not user viewable.",
            "env_variable": "DL_PATH",
            "default_value": "",
            "user_viewable": false,
            "user_editable": false,
            "rules": "nullable|string",
            "field_type": "text"
        },
        {
            "name": "Build Number",
            "description": "The build number for the paper release.\r\n\r\nLeave at latest to always get the latest version. Invalid versions will default to latest.",
            "env_variable": "BUILD_NUMBER",
            "default_value": "latest",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|string|max:20",
            "field_type": "text"
        }
    ]
}
</file>

<file path="database/Seeders/eggs/minecraft/egg-sponge--sponge-vanilla.json">
{
    "_comment": "DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY Jexactyl PANEL - jexactyl.com",
    "meta": {
        "version": "PTDL_v2",
        "update_url": null
    },
    "exported_at": "2022-06-17T08:11:42+03:00",
    "name": "Sponge (SpongeVanilla)",
    "author": "support@jexactyl.com",
    "description": "SpongeVanilla is the SpongeAPI implementation for Vanilla Minecraft.",
    "features": ["eula", "java_version", "pid_limit"],
    "docker_images": {
        "Java 16": "ghcr.io/pterodactyl/yolks:java_16",
        "Java 11": "ghcr.io/pterodactyl/yolks:java_11",
        "Java 8": "ghcr.io/pterodactyl/yolks:java_8"
    },
    "file_denylist": [],
    "startup": "java -Xms128M -XX:MaxRAMPercentage=95.0 -jar {{SERVER_JARFILE}}",
    "config": {
        "files": "{\r\n    \"server.properties\": {\r\n        \"parser\": \"properties\",\r\n        \"find\": {\r\n            \"server-ip\": \"0.0.0.0\",\r\n            \"server-port\": \"{{server.build.default.port}}\",\r\n            \"query.port\": \"{{server.build.default.port}}\"\r\n        }\r\n    }\r\n}",
        "startup": "{\r\n    \"done\": \")! For help, type \"\r\n}",
        "logs": "{}",
        "stop": "stop"
    },
    "scripts": {
        "installation": {
            "script": "#!/bin/ash\r\n# Sponge Installation Script\r\n#\r\n# Server Files: /mnt/server\r\n\r\ncd /mnt/server\r\n\r\ncurl -sSL \"https://repo.spongepowered.org/maven/org/spongepowered/spongevanilla/${SPONGE_VERSION}/spongevanilla-${SPONGE_VERSION}.jar\" -o ${SERVER_JARFILE}",
            "container": "ghcr.io/pterodactyl/installers:alpine",
            "entrypoint": "ash"
        }
    },
    "variables": [
        {
            "name": "Sponge Version",
            "description": "The version of SpongeVanilla to download and use.",
            "env_variable": "SPONGE_VERSION",
            "default_value": "1.12.2-7.3.0",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|regex:/^([a-zA-Z0-9.\\-_]+)$/",
            "field_type": "text"
        },
        {
            "name": "Server Jar File",
            "description": "The name of the Jarfile to use when running SpongeVanilla.",
            "env_variable": "SERVER_JARFILE",
            "default_value": "server.jar",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|regex:/^([\\w\\d._-]+)(\\.jar)$/",
            "field_type": "text"
        }
    ]
}
</file>

<file path="database/Seeders/eggs/minecraft/egg-vanilla-minecraft.json">
{
    "_comment": "DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY Jexactyl PANEL - jexactyl.com",
    "meta": {
        "version": "PTDL_v2",
        "update_url": null
    },
    "exported_at": "2022-06-17T08:11:58+03:00",
    "name": "Vanilla Minecraft",
    "author": "support@jexactyl.com",
    "description": "Minecraft is a game about placing blocks and going on adventures. Explore randomly generated worlds and build amazing things from the simplest of homes to the grandest of castles. Play in Creative Mode with unlimited resources or mine deep in Survival Mode, crafting weapons and armor to fend off dangerous mobs. Do all this alone or with friends.",
    "features": ["eula", "java_version", "pid_limit"],
    "docker_images": {
        "Java 17": "ghcr.io/pterodactyl/yolks:java_17",
        "Java 16": "ghcr.io/pterodactyl/yolks:java_16",
        "Java 11": "ghcr.io/pterodactyl/yolks:java_11",
        "Java 8": "ghcr.io/pterodactyl/yolks:java_8"
    },
    "file_denylist": [],
    "startup": "java -Xms128M -XX:MaxRAMPercentage=95.0 -jar {{SERVER_JARFILE}}",
    "config": {
        "files": "{\r\n    \"server.properties\": {\r\n        \"parser\": \"properties\",\r\n        \"find\": {\r\n            \"server-ip\": \"0.0.0.0\",\r\n            \"server-port\": \"{{server.build.default.port}}\",\r\n            \"query.port\": \"{{server.build.default.port}}\"\r\n        }\r\n    }\r\n}",
        "startup": "{\r\n    \"done\": \")! For help, type \"\r\n}",
        "logs": "{}",
        "stop": "stop"
    },
    "scripts": {
        "installation": {
            "script": "#!/bin/ash\r\n# Vanilla MC Installation Script\r\n#\r\n# Server Files: /mnt/server\r\nmkdir -p /mnt/server\r\ncd /mnt/server\r\n\r\nLATEST_VERSION=`curl https://launchermeta.mojang.com/mc/game/version_manifest.json | jq -r '.latest.release'`\r\nLATEST_SNAPSHOT_VERSION=`curl https://launchermeta.mojang.com/mc/game/version_manifest.json | jq -r '.latest.snapshot'`\r\n\r\necho -e \"latest version is $LATEST_VERSION\"\r\necho -e \"latest snapshot is $LATEST_SNAPSHOT_VERSION\"\r\n\r\nif [ -z \"$VANILLA_VERSION\" ] || [ \"$VANILLA_VERSION\" == \"latest\" ]; then\r\n  MANIFEST_URL=$(curl -sSL https://launchermeta.mojang.com/mc/game/version_manifest.json | jq --arg VERSION $LATEST_VERSION -r '.versions | .[] | select(.id== $VERSION )|.url')\r\nelif [ \"$VANILLA_VERSION\" == \"snapshot\" ]; then\r\n  MANIFEST_URL=$(curl -sSL https://launchermeta.mojang.com/mc/game/version_manifest.json | jq --arg VERSION $LATEST_SNAPSHOT_VERSION -r '.versions | .[] | select(.id== $VERSION )|.url')\r\nelse\r\n  MANIFEST_URL=$(curl -sSL https://launchermeta.mojang.com/mc/game/version_manifest.json | jq --arg VERSION $VANILLA_VERSION -r '.versions | .[] | select(.id== $VERSION )|.url')\r\nfi\r\n\r\nDOWNLOAD_URL=$(curl ${MANIFEST_URL} | jq .downloads.server | jq -r '. | .url')\r\n\r\necho -e \"running: curl -o ${SERVER_JARFILE} $DOWNLOAD_URL\"\r\ncurl -o ${SERVER_JARFILE} $DOWNLOAD_URL\r\n\r\necho -e \"Install Complete\"",
            "container": "ghcr.io/pterodactyl/installers:alpine",
            "entrypoint": "ash"
        }
    },
    "variables": [
        {
            "name": "Server Jar File",
            "description": "The name of the server jarfile to run the server with.",
            "env_variable": "SERVER_JARFILE",
            "default_value": "server.jar",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|regex:/^([\\w\\d._-]+)(\\.jar)$/",
            "field_type": "text"
        },
        {
            "name": "Server Version",
            "description": "The version of Minecraft Vanilla to install. Use \"latest\" to install the latest version, or use \"snapshot\" to install the latest snapshot. Go to Settings > Reinstall Server to apply.",
            "env_variable": "VANILLA_VERSION",
            "default_value": "latest",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|string|between:3,15",
            "field_type": "text"
        }
    ]
}
</file>

<file path="database/Seeders/eggs/rust/egg-rust.json">
{
    "_comment": "DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY Jexactyl PANEL - jexactyl.com",
    "meta": {
        "version": "PTDL_v2",
        "update_url": null
    },
    "exported_at": "2023-02-04T14:45:12-05:00",
    "name": "Rust",
    "author": "support@jexactyl.com",
    "description": "The only aim in Rust is to survive. To do this you will need to overcome struggles such as hunger, thirst and cold. Build a fire. Build a shelter. Kill animals for meat. Protect yourself from other players, and kill them for meat. Create alliances with other players and form a town. Do whatever it takes to survive.",
    "features": ["steam_disk_space"],
    "docker_images": {
        "quay.io/pterodactyl/core:rust": "quay.io/pterodactyl/core:rust"
    },
    "file_denylist": [],
    "startup": "./RustDedicated -batchmode +server.port {{SERVER_PORT}} +server.queryport {{QUERY_PORT}} +server.identity \"rust\" +rcon.port {{RCON_PORT}} +rcon.web true +server.hostname \\\"{{HOSTNAME}}\\\" +server.level \\\"{{LEVEL}}\\\" +server.description \\\"{{DESCRIPTION}}\\\" +server.url \\\"{{SERVER_URL}}\\\" +server.headerimage \\\"{{SERVER_IMG}}\\\" +server.logoimage \\\"{{SERVER_LOGO}}\\\" +server.maxplayers {{MAX_PLAYERS}} +rcon.password \\\"{{RCON_PASS}}\\\" +server.saveinterval {{SAVEINTERVAL}} +app.port {{APP_PORT}}  $( [ -z ${MAP_URL} ] && printf %s \"+server.worldsize \\\"{{WORLD_SIZE}}\\\" +server.seed \\\"{{WORLD_SEED}}\\\"\" || printf %s \"+server.levelurl {{MAP_URL}}\" ) {{ADDITIONAL_ARGS}}",
    "config": {
        "files": "{}",
        "startup": "{\r\n    \"done\": \"Server startup complete\"\r\n}",
        "logs": "{}",
        "stop": "quit"
    },
    "scripts": {
        "installation": {
            "script": "#!/bin/bash\r\n# steamcmd Base Installation Script\r\n#\r\n# Server Files: /mnt/server\r\n\r\nSRCDS_APPID=258550\r\n\r\n## just in case someone removed the defaults.\r\nif [ \"${STEAM_USER}\" == \"\" ]; then\r\n    echo -e \"steam user is not set.\\n\"\r\n    echo -e \"Using anonymous user.\\n\"\r\n    STEAM_USER=anonymous\r\n    STEAM_PASS=\"\"\r\n    STEAM_AUTH=\"\"\r\nelse\r\n    echo -e \"user set to ${STEAM_USER}\"\r\nfi\r\n\r\n## download and install steamcmd\r\ncd /tmp\r\nmkdir -p /mnt/server/steamcmd\r\ncurl -sSL -o steamcmd.tar.gz https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz\r\ntar -xzvf steamcmd.tar.gz -C /mnt/server/steamcmd\r\nmkdir -p /mnt/server/steamapps # Fix steamcmd disk write error when this folder is missing\r\ncd /mnt/server/steamcmd\r\n\r\n# SteamCMD fails otherwise for some reason, even running as root.\r\n# This is changed at the end of the install process anyways.\r\nchown -R root:root /mnt\r\nexport HOME=/mnt/server\r\n\r\n## install game using steamcmd\r\n./steamcmd.sh +force_install_dir /mnt/server +login ${STEAM_USER} ${STEAM_PASS} ${STEAM_AUTH} +app_update ${SRCDS_APPID} ${EXTRA_FLAGS} validate +quit ## other flags may be needed depending on install. looking at you cs 1.6\r\n\r\n## set up 32 bit libraries\r\nmkdir -p /mnt/server/.steam/sdk32\r\ncp -v linux32/steamclient.so ../.steam/sdk32/steamclient.so\r\n\r\n## set up 64 bit libraries\r\nmkdir -p /mnt/server/.steam/sdk64\r\ncp -v linux64/steamclient.so ../.steam/sdk64/steamclient.so",
            "container": "ghcr.io/pterodactyl/installers:debian",
            "entrypoint": "bash"
        }
    },
    "variables": [
        {
            "name": "Server Name",
            "description": "The name of your server in the public server list.",
            "env_variable": "HOSTNAME",
            "default_value": "A Rust Server",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|string|max:60",
            "field_type": "text"
        },
        {
            "name": "OxideMod",
            "description": "Set whether you want the server to use and auto update OxideMod or not. Valid options are \"1\" for true and \"0\" for false.",
            "env_variable": "OXIDE",
            "default_value": "0",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|boolean",
            "field_type": "text"
        },
        {
            "name": "Level",
            "description": "The world file for Rust to use.",
            "env_variable": "LEVEL",
            "default_value": "Procedural Map",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|string|max:20",
            "field_type": "text"
        },
        {
            "name": "Description",
            "description": "The description under your server title. Commonly used for rules & info. Use \\n for newlines.",
            "env_variable": "DESCRIPTION",
            "default_value": "Powered by Jexactyl",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|string",
            "field_type": "text"
        },
        {
            "name": "URL",
            "description": "The URL for your server. This is what comes up when clicking the \"Visit Website\" button.",
            "env_variable": "SERVER_URL",
            "default_value": "http://jexactyl.com",
            "user_viewable": true,
            "user_editable": true,
            "rules": "nullable|url",
            "field_type": "text"
        },
        {
            "name": "World Size",
            "description": "The world size for a procedural map.",
            "env_variable": "WORLD_SIZE",
            "default_value": "3000",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|integer",
            "field_type": "text"
        },
        {
            "name": "World Seed",
            "description": "The seed for a procedural map.",
            "env_variable": "WORLD_SEED",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "nullable|string",
            "field_type": "text"
        },
        {
            "name": "Max Players",
            "description": "The maximum amount of players allowed in the server at once.",
            "env_variable": "MAX_PLAYERS",
            "default_value": "40",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|integer",
            "field_type": "text"
        },
        {
            "name": "Server Image",
            "description": "The header image for the top of your server listing.",
            "env_variable": "SERVER_IMG",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "nullable|url",
            "field_type": "text"
        },
        {
            "name": "RCON Port",
            "description": "Port for RCON connections.",
            "env_variable": "RCON_PORT",
            "default_value": "28016",
            "user_viewable": true,
            "user_editable": false,
            "rules": "required|integer",
            "field_type": "text"
        },
        {
            "name": "RCON Password",
            "description": "RCON access password.",
            "env_variable": "RCON_PASS",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|regex:/^[\\w.-]*$/|max:64",
            "field_type": "text"
        },
        {
            "name": "Save Interval",
            "description": "Sets the server\u2019s auto-save interval in seconds.",
            "env_variable": "SAVEINTERVAL",
            "default_value": "60",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|integer",
            "field_type": "text"
        },
        {
            "name": "Additional Arguments",
            "description": "Add additional startup parameters to the server.",
            "env_variable": "ADDITIONAL_ARGS",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "nullable|string",
            "field_type": "text"
        },
        {
            "name": "App Port",
            "description": "Port for the Rust+ App. -1 to disable.",
            "env_variable": "APP_PORT",
            "default_value": "28082",
            "user_viewable": true,
            "user_editable": false,
            "rules": "required|integer",
            "field_type": "text"
        },
        {
            "name": "Server Logo",
            "description": "The circular server logo for the Rust+ app.",
            "env_variable": "SERVER_LOGO",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "nullable|url",
            "field_type": "text"
        },
        {
            "name": "Custom Map URL",
            "description": "Overwrites the map with the one from the direct download URL. Invalid URLs will cause the server to crash.",
            "env_variable": "MAP_URL",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "nullable|url",
            "field_type": "text"
        },
        {
            "name": "Query Port",
            "description": "Server Query Port. Can't be the same as Game's primary port.",
            "env_variable": "QUERY_PORT",
            "default_value": "27017",
            "user_viewable": true,
            "user_editable": false,
            "rules": "required|integer",
            "field_type": "text"
        }
    ]
}
</file>

<file path="database/Seeders/eggs/source-engine/egg-ark--survival-evolved.json">
{
    "_comment": "DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY Jexactyl PANEL - jexactyl.com",
    "meta": {
        "version": "PTDL_v1",
        "update_url": null
    },
    "exported_at": "2022-01-18T07:01:38-05:00",
    "name": "Ark: Survival Evolved",
    "author": "dev@shepper.fr",
    "description": "As a man or woman stranded, naked, freezing, and starving on the unforgiving shores of a mysterious island called ARK, use your skill and cunning to kill or tame and ride the plethora of leviathan dinosaurs and other primeval creatures roaming the land. Hunt, harvest resources, craft items, grow crops, research technologies, and build shelters to withstand the elements and store valuables, all while teaming up with (or preying upon) hundreds of other players to survive, dominate... and escape! \u2014 Gamepedia: ARK",
    "features": ["steam_disk_space"],
    "images": ["quay.io/parkervcp/pterodactyl-images:debian_source"],
    "file_denylist": [],
    "startup": "rmv() { echo -e \"stopping server\"; rcon -t rcon -a 127.0.0.1:${RCON_PORT} -p ${ARK_ADMIN_PASSWORD} -c saveworld && rcon -a 127.0.0.1:${RCON_PORT} -p ${ARK_ADMIN_PASSWORD} -c DoExit; }; trap rmv 15; cd ShooterGame/Binaries/Linux && ./ShooterGameServer {{SERVER_MAP}}?listen?SessionName=\"{{SESSION_NAME}}\"?ServerPassword={{ARK_PASSWORD}}?ServerAdminPassword={{ARK_ADMIN_PASSWORD}}?Port={{SERVER_PORT}}?RCONPort={{RCON_PORT}}?QueryPort={{QUERY_PORT}}?RCONEnabled=True$( [ \"$BATTLE_EYE\" == \"1\" ] || printf %s ' -NoBattlEye' ) -server {{ARGS}} -log & until echo \"waiting for rcon connection...\"; rcon -t rcon -a 127.0.0.1:${RCON_PORT} -p ${ARK_ADMIN_PASSWORD}; do sleep 5; done",
    "config": {
        "files": "{}",
        "startup": "{\r\n    \"done\": \"Waiting commands for 127.0.0.1:\"\r\n}",
        "logs": "{}",
        "stop": "^C"
    },
    "scripts": {
        "installation": {
            "script": "#!/bin/bash\r\n# steamcmd Base Installation Script\r\n#\r\n# Server Files: /mnt/server\r\n# Image to install with is 'ubuntu:18.04'\r\n\r\n## just in case someone removed the defaults.\r\nif [ \"${STEAM_USER}\" == \"\" ]; then\r\n    STEAM_USER=anonymous\r\n    STEAM_PASS=\"\"\r\n    STEAM_AUTH=\"\"\r\nfi\r\n\r\n## download and install steamcmd\r\ncd /tmp\r\nmkdir -p /mnt/server/steamcmd\r\ncurl -sSL -o steamcmd.tar.gz https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz\r\ntar -xzvf steamcmd.tar.gz -C /mnt/server/steamcmd\r\n\r\nmkdir -p /mnt/server/Engine/Binaries/ThirdParty/SteamCMD/Linux\r\ntar -xzvf steamcmd.tar.gz -C /mnt/server/Engine/Binaries/ThirdParty/SteamCMD/Linux\r\nmkdir -p /mnt/server/steamapps # Fix steamcmd disk write error when this folder is missing\r\ncd /mnt/server/steamcmd\r\n\r\n# SteamCMD fails otherwise for some reason, even running as root.\r\n# This is changed at the end of the install process anyways.\r\nchown -R root:root /mnt\r\nexport HOME=/mnt/server\r\n\r\n## install game using steamcmd\r\n./steamcmd.sh +force_install_dir /mnt/server +login ${STEAM_USER} ${STEAM_PASS} ${STEAM_AUTH} +app_update ${SRCDS_APPID} ${EXTRA_FLAGS} +quit ## other flags may be needed depending on install. looking at you cs 1.6\r\n\r\n## set up 32 bit libraries\r\nmkdir -p /mnt/server/.steam/sdk32\r\ncp -v linux32/steamclient.so ../.steam/sdk32/steamclient.so\r\n\r\n## set up 64 bit libraries\r\nmkdir -p /mnt/server/.steam/sdk64\r\ncp -v linux64/steamclient.so ../.steam/sdk64/steamclient.so\r\n\r\n## create a symbolic link for loading mods\r\ncd /mnt/server/Engine/Binaries/ThirdParty/SteamCMD/Linux\r\nln -sf ../../../../../Steam/steamapps steamapps\r\ncd /mnt/server",
            "container": "ghcr.io/pterodactyl/installers:debian",
            "entrypoint": "bash"
        }
    },
    "variables": [
        {
            "name": "Server Password",
            "description": "If specified, players must provide this password to join the server.",
            "env_variable": "ARK_PASSWORD",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "nullable|alpha_dash|between:1,100"
        },
        {
            "name": "Admin Password",
            "description": "If specified, players must provide this password (via the in-game console) to gain access to administrator commands on the server.",
            "env_variable": "ARK_ADMIN_PASSWORD",
            "default_value": "PleaseChangeMe",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|alpha_dash|between:1,100"
        },
        {
            "name": "Server Map",
            "description": "Available Maps: TheIsland, TheCenter, Ragnarok, ScorchedEarth_P, Aberration_P, Extinction, Valguero_P, Genesis, CrystalIsles, Gen2, LostIsland, Fjordur",
            "env_variable": "SERVER_MAP",
            "default_value": "TheIsland",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|string|max:20"
        },
        {
            "name": "Server Name",
            "description": "ARK server name",
            "env_variable": "SESSION_NAME",
            "default_value": "A Jexactyl Hosted ARK Server",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|string|max:128"
        },
        {
            "name": "Rcon Port",
            "description": "ARK rcon port used by rcon tools.",
            "env_variable": "RCON_PORT",
            "default_value": "27020",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|numeric"
        },
        {
            "name": "Query Port",
            "description": "ARK query port used by steam server browser and ark client server browser.",
            "env_variable": "QUERY_PORT",
            "default_value": "27015",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|numeric"
        },
        {
            "name": "Auto-update server",
            "description": "This is to enable auto-updating for servers.\r\n\r\nDefault is 0. Set to 1 to update",
            "env_variable": "AUTO_UPDATE",
            "default_value": "0",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|boolean"
        },
        {
            "name": "Battle Eye",
            "description": "Enable BattleEye\r\n\r\n0 to disable\r\n1 to enable\r\n\r\ndefault=\"1\"",
            "env_variable": "BATTLE_EYE",
            "default_value": "1",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|boolean"
        },
        {
            "name": "App ID",
            "description": "ARK steam app id for auto updates. Leave blank to avoid auto update.",
            "env_variable": "SRCDS_APPID",
            "default_value": "376030",
            "user_viewable": true,
            "user_editable": false,
            "rules": "nullable|numeric"
        },
        {
            "name": "Additional Arguments",
            "description": "Specify additional launch parameters such as -crossplay. You must include a dash - and separate each parameter with space: -crossplay -exclusivejoin",
            "env_variable": "ARGS",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "nullable|string"
        }
    ]
}
</file>

<file path="database/Seeders/eggs/source-engine/egg-counter--strike--global-offensive.json">
{
    "_comment": "DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY Jexactyl PANEL - jexactyl.com",
    "meta": {
        "version": "PTDL_v1",
        "update_url": null
    },
    "exported_at": "2022-01-18T07:01:54-05:00",
    "name": "Counter-Strike: Global Offensive",
    "author": "support@jexactyl.com",
    "description": "Counter-Strike: Global Offensive is a multiplayer first-person shooter video game developed by Hidden Path Entertainment and Valve Corporation.",
    "features": ["gsl_token", "steam_disk_space"],
    "images": ["ghcr.io/pterodactyl/games:source"],
    "file_denylist": [],
    "startup": "./srcds_run -game csgo -console -port {{SERVER_PORT}} +ip 0.0.0.0 +map {{SRCDS_MAP}} -strictportbind -norestart +sv_setsteamaccount {{STEAM_ACC}}",
    "config": {
        "files": "{}",
        "startup": "{\r\n    \"done\": \"Connection to Steam servers successful\"\r\n}",
        "logs": "{}",
        "stop": "quit"
    },
    "scripts": {
        "installation": {
            "script": "#!/bin/bash\r\n# steamcmd Base Installation Script\r\n#\r\n# Server Files: /mnt/server\r\n\r\n## just in case someone removed the defaults.\r\nif [ \"${STEAM_USER}\" == \"\" ]; then\r\n    STEAM_USER=anonymous\r\n    STEAM_PASS=\"\"\r\n    STEAM_AUTH=\"\"\r\nfi\r\n\r\n## download and install steamcmd\r\ncd /tmp\r\nmkdir -p /mnt/server/steamcmd\r\ncurl -sSL -o steamcmd.tar.gz https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz\r\ntar -xzvf steamcmd.tar.gz -C /mnt/server/steamcmd\r\nmkdir -p /mnt/server/steamapps # Fix steamcmd disk write error when this folder is missing\r\ncd /mnt/server/steamcmd\r\n\r\n# SteamCMD fails otherwise for some reason, even running as root.\r\n# This is changed at the end of the install process anyways.\r\nchown -R root:root /mnt\r\nexport HOME=/mnt/server\r\n\r\n## install game using steamcmd\r\n./steamcmd.sh +force_install_dir /mnt/server +login ${STEAM_USER} ${STEAM_PASS} ${STEAM_AUTH} +app_update ${SRCDS_APPID} ${EXTRA_FLAGS} +quit ## other flags may be needed depending on install. looking at you cs 1.6\r\n\r\n## set up 32 bit libraries\r\nmkdir -p /mnt/server/.steam/sdk32\r\ncp -v linux32/steamclient.so ../.steam/sdk32/steamclient.so\r\n\r\n## set up 64 bit libraries\r\nmkdir -p /mnt/server/.steam/sdk64\r\ncp -v linux64/steamclient.so ../.steam/sdk64/steamclient.so",
            "container": "ghcr.io/pterodactyl/installers:debian",
            "entrypoint": "bash"
        }
    },
    "variables": [
        {
            "name": "Map",
            "description": "The default map for the server.",
            "env_variable": "SRCDS_MAP",
            "default_value": "de_dust2",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|string|alpha_dash"
        },
        {
            "name": "Steam Account Token",
            "description": "The Steam Account Token required for the server to be displayed publicly.",
            "env_variable": "STEAM_ACC",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|string|alpha_num|size:32"
        },
        {
            "name": "Source AppID",
            "description": "Required for game to update on server restart. Do not modify this.",
            "env_variable": "SRCDS_APPID",
            "default_value": "740",
            "user_viewable": false,
            "user_editable": false,
            "rules": "required|string|max:20"
        }
    ]
}
</file>

<file path="database/Seeders/eggs/source-engine/egg-custom-source-engine-game.json">
{
    "_comment": "DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY Jexactyl PANEL - jexactyl.com",
    "meta": {
        "version": "PTDL_v1",
        "update_url": null
    },
    "exported_at": "2022-01-18T07:03:08-05:00",
    "name": "Custom Source Engine Game",
    "author": "support@jexactyl.com",
    "description": "This option allows modifying the startup arguments and other details to run a custom SRCDS based game on the panel.",
    "features": ["steam_disk_space"],
    "images": ["ghcr.io/pterodactyl/games:source"],
    "file_denylist": [],
    "startup": "./srcds_run -game {{SRCDS_GAME}} -console -port {{SERVER_PORT}} +map {{SRCDS_MAP}} +ip 0.0.0.0 -strictportbind -norestart",
    "config": {
        "files": "{}",
        "startup": "{\r\n    \"done\": \"gameserver Steam ID\"\r\n}",
        "logs": "{}",
        "stop": "quit"
    },
    "scripts": {
        "installation": {
            "script": "#!/bin/bash\r\n# steamcmd Base Installation Script\r\n#\r\n# Server Files: /mnt/server\r\n\r\n##\r\n#\r\n# Variables\r\n# STEAM_USER, STEAM_PASS, STEAM_AUTH - Steam user setup. If a user has 2fa enabled it will most likely fail due to timeout. Leave blank for anon install.\r\n# WINDOWS_INSTALL - if it's a windows server you want to install set to 1\r\n# SRCDS_APPID - steam app id ffound here - https://developer.valvesoftware.com/wiki/Dedicated_Servers_List\r\n# EXTRA_FLAGS - when a server has extra glas for things like beta installs or updates.\r\n#\r\n##\r\n\r\n\r\n## just in case someone removed the defaults.\r\nif [ \"${STEAM_USER}\" == \"\" ]; then\r\n    echo -e \"steam user is not set.\\n\"\r\n    echo -e \"Using anonymous user.\\n\"\r\n    STEAM_USER=anonymous\r\n    STEAM_PASS=\"\"\r\n    STEAM_AUTH=\"\"\r\nelse\r\n    echo -e \"user set to ${STEAM_USER}\"\r\nfi\r\n\r\n## download and install steamcmd\r\ncd /tmp\r\nmkdir -p /mnt/server/steamcmd\r\ncurl -sSL -o steamcmd.tar.gz https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz\r\ntar -xzvf steamcmd.tar.gz -C /mnt/server/steamcmd\r\nmkdir -p /mnt/server/steamapps # Fix steamcmd disk write error when this folder is missing\r\ncd /mnt/server/steamcmd\r\n\r\n# SteamCMD fails otherwise for some reason, even running as root.\r\n# This is changed at the end of the install process anyways.\r\nchown -R root:root /mnt\r\nexport HOME=/mnt/server\r\n\r\n## install game using steamcmd\r\n./steamcmd.sh +force_install_dir /mnt/server +login ${STEAM_USER} ${STEAM_PASS} ${STEAM_AUTH} $( [[ \"${WINDOWS_INSTALL}\" == \"1\" ]] && printf %s '+@sSteamCmdForcePlatformType windows' ) +app_update ${SRCDS_APPID} ${EXTRA_FLAGS} validate +quit ## other flags may be needed depending on install. looking at you cs 1.6\r\n\r\n## set up 32 bit libraries\r\nmkdir -p /mnt/server/.steam/sdk32\r\ncp -v linux32/steamclient.so ../.steam/sdk32/steamclient.so\r\n\r\n## set up 64 bit libraries\r\nmkdir -p /mnt/server/.steam/sdk64\r\ncp -v linux64/steamclient.so ../.steam/sdk64/steamclient.so",
            "container": "ghcr.io/pterodactyl/installers:debian",
            "entrypoint": "bash"
        }
    },
    "variables": [
        {
            "name": "Game ID",
            "description": "The ID corresponding to the game to download and run using SRCDS.",
            "env_variable": "SRCDS_APPID",
            "default_value": "",
            "user_viewable": true,
            "user_editable": false,
            "rules": "required|numeric|digits_between:1,6"
        },
        {
            "name": "Game Name",
            "description": "The name corresponding to the game to download and run using SRCDS.",
            "env_variable": "SRCDS_GAME",
            "default_value": "",
            "user_viewable": true,
            "user_editable": false,
            "rules": "required|alpha_dash|between:1,100"
        },
        {
            "name": "Map",
            "description": "The default map for the server.",
            "env_variable": "SRCDS_MAP",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|string|alpha_dash"
        },
        {
            "name": "Steam Username",
            "description": "",
            "env_variable": "STEAM_USER",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "nullable|string"
        },
        {
            "name": "Steam Password",
            "description": "",
            "env_variable": "STEAM_PASS",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "nullable|string"
        },
        {
            "name": "Steam Auth",
            "description": "",
            "env_variable": "STEAM_AUTH",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "nullable|string"
        }
    ]
}
</file>

<file path="database/Seeders/eggs/source-engine/egg-garrys-mod.json">
{
    "_comment": "DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY Jexactyl PANEL - jexactyl.com",
    "meta": {
        "version": "PTDL_v1",
        "update_url": null
    },
    "exported_at": "2022-01-18T07:04:20-05:00",
    "name": "Garrys Mod",
    "author": "support@jexactyl.com",
    "description": "Garrys Mod, is a sandbox physics game created by Garry Newman, and developed by his company, Facepunch Studios.",
    "features": ["gsl_token", "steam_disk_space"],
    "images": ["ghcr.io/pterodactyl/games:source"],
    "file_denylist": [],
    "startup": "./srcds_run -game garrysmod -console -port {{SERVER_PORT}} +ip 0.0.0.0 +host_workshop_collection {{WORKSHOP_ID}} +map {{SRCDS_MAP}} +gamemode {{GAMEMODE}} -strictportbind -norestart +sv_setsteamaccount {{STEAM_ACC}} +maxplayers {{MAX_PLAYERS}}  -tickrate {{TICKRATE}}  $( [ \"$LUA_REFRESH\" == \"1\" ] || printf %s '-disableluarefresh' )",
    "config": {
        "files": "{}",
        "startup": "{\r\n    \"done\": \"gameserver Steam ID\"\r\n}",
        "logs": "{}",
        "stop": "quit"
    },
    "scripts": {
        "installation": {
            "script": "#!/bin/bash\r\n# steamcmd Base Installation Script\r\n#\r\n# Server Files: /mnt/server\r\n\r\n## just in case someone removed the defaults.\r\nif [ \"${STEAM_USER}\" == \"\" ]; then\r\n    echo -e \"steam user is not set.\\n\"\r\n    echo -e \"Using anonymous user.\\n\"\r\n    STEAM_USER=anonymous\r\n    STEAM_PASS=\"\"\r\n    STEAM_AUTH=\"\"\r\nelse\r\n    echo -e \"user set to ${STEAM_USER}\"\r\nfi\r\n\r\n## download and install steamcmd\r\ncd /tmp\r\nmkdir -p /mnt/server/steamcmd\r\ncurl -sSL -o steamcmd.tar.gz https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz\r\ntar -xzvf steamcmd.tar.gz -C /mnt/server/steamcmd\r\nmkdir -p /mnt/server/steamapps # Fix steamcmd disk write error when this folder is missing\r\ncd /mnt/server/steamcmd\r\n\r\n# SteamCMD fails otherwise for some reason, even running as root.\r\n# This is changed at the end of the install process anyways.\r\nchown -R root:root /mnt\r\nexport HOME=/mnt/server\r\n\r\n## install game using steamcmd\r\n./steamcmd.sh +force_install_dir /mnt/server +login ${STEAM_USER} ${STEAM_PASS} ${STEAM_AUTH} $( [[ \"${WINDOWS_INSTALL}\" == \"1\" ]] && printf %s '+@sSteamCmdForcePlatformType windows' ) +app_update ${SRCDS_APPID} ${EXTRA_FLAGS} validate +quit ## other flags may be needed depending on install. looking at you cs 1.6\r\n\r\n## set up 32 bit libraries\r\nmkdir -p /mnt/server/.steam/sdk32\r\ncp -v linux32/steamclient.so ../.steam/sdk32/steamclient.so\r\n\r\n## set up 64 bit libraries\r\nmkdir -p /mnt/server/.steam/sdk64\r\ncp -v linux64/steamclient.so ../.steam/sdk64/steamclient.so\r\n\r\n# Creating needed default files for the game\r\ncd /mnt/server/garrysmod/lua/autorun/server\r\necho '\r\n-- Docs: https://wiki.garrysmod.com/page/resource/AddWorkshop\r\n-- Place the ID of the workshop addon you want to be downloaded to people who join your server, not the collection ID\r\n-- Use https://beta.configcreator.com/create/gmod/resources.lua to easily create a list based on your collection ID\r\n\r\nresource.AddWorkshop( \"\" )\r\n' > workshop.lua\r\n\r\ncd /mnt/server/garrysmod/cfg\r\necho '\r\n// Please do not set RCon in here, use the startup parameters.\r\n\r\nhostname\t\t\"New Gmod Server\"\r\nsv_password\t\t\"\"\r\nsv_loadingurl   \"\"\r\nsv_downloadurl  \"\"\r\n\r\n// Steam Server List Settings\r\n// sv_location \"eu\"\r\nsv_region \"255\"\r\nsv_lan \"0\"\r\nsv_max_queries_sec_global \"30000\"\r\nsv_max_queries_window \"45\"\r\nsv_max_queries_sec \"5\"\r\n\r\n// Server Limits\r\nsbox_maxprops\t\t100\r\nsbox_maxragdolls\t5\r\nsbox_maxnpcs\t\t10\r\nsbox_maxballoons\t10\r\nsbox_maxeffects\t\t10\r\nsbox_maxdynamite\t10\r\nsbox_maxlamps\t\t10\r\nsbox_maxthrusters\t10\r\nsbox_maxwheels\t\t10\r\nsbox_maxhoverballs\t10\r\nsbox_maxvehicles\t20\r\nsbox_maxbuttons\t\t10\r\nsbox_maxsents\t\t20\r\nsbox_maxemitters\t5\r\nsbox_godmode\t\t0\r\nsbox_noclip\t\t    0\r\n\r\n// Network Settings - Please keep these set to default.\r\n\r\nsv_minrate\t\t75000\r\nsv_maxrate\t\t0\r\ngmod_physiterations\t2\r\nnet_splitpacket_maxrate\t45000\r\ndecalfrequency\t\t12 \r\n\r\n// Execute Ban Files - Please do not edit\r\nexec banned_ip.cfg \r\nexec banned_user.cfg \r\n\r\n// Add custom lines under here\r\n' > server.cfg",
            "container": "ghcr.io/pterodactyl/installers:debian",
            "entrypoint": "bash"
        }
    },
    "variables": [
        {
            "name": "Map",
            "description": "The default map for the server.",
            "env_variable": "SRCDS_MAP",
            "default_value": "gm_flatgrass",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|string|alpha_dash"
        },
        {
            "name": "Steam Account Token",
            "description": "The Steam Account Token required for the server to be displayed publicly.",
            "env_variable": "STEAM_ACC",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "nullable|string|alpha_num|size:32"
        },
        {
            "name": "Source AppID",
            "description": "Required for game to update on server restart. Do not modify this.",
            "env_variable": "SRCDS_APPID",
            "default_value": "4020",
            "user_viewable": false,
            "user_editable": false,
            "rules": "required|string|max:20"
        },
        {
            "name": "Workshop ID",
            "description": "The ID of your workshop collection (the numbers at the end of the URL)",
            "env_variable": "WORKSHOP_ID",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "nullable|integer"
        },
        {
            "name": "Gamemode",
            "description": "The gamemode of your server.",
            "env_variable": "GAMEMODE",
            "default_value": "sandbox",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|string"
        },
        {
            "name": "Max Players",
            "description": "The maximum amount of players allowed on your game server.",
            "env_variable": "MAX_PLAYERS",
            "default_value": "32",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|integer|max:128"
        },
        {
            "name": "Tickrate",
            "description": "The tickrate defines how fast the server will update each entity's location.",
            "env_variable": "TICKRATE",
            "default_value": "22",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|integer|max:100"
        },
        {
            "name": "Lua Refresh",
            "description": "0 = disable Lua refresh,\r\n1 = enable Lua refresh",
            "env_variable": "LUA_REFRESH",
            "default_value": "0",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|boolean"
        }
    ]
}
</file>

<file path="database/Seeders/eggs/source-engine/egg-insurgency.json">
{
    "_comment": "DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY Jexactyl PANEL - jexactyl.com",
    "meta": {
        "version": "PTDL_v1",
        "update_url": null
    },
    "exported_at": "2022-01-18T07:07:27-05:00",
    "name": "Insurgency",
    "author": "support@jexactyl.com",
    "description": "Take to the streets for intense close quarters combat, where a team's survival depends upon securing crucial strongholds and destroying enemy supply in this multiplayer and cooperative Source Engine based experience.",
    "features": ["steam_disk_space"],
    "images": ["ghcr.io/pterodactyl/games:source"],
    "file_denylist": [],
    "startup": "./srcds_run -game insurgency -console -port {{SERVER_PORT}} +map {{SRCDS_MAP}} +ip 0.0.0.0 -strictportbind -norestart",
    "config": {
        "files": "{}",
        "startup": "{\r\n    \"done\": \"gameserver Steam ID\"\r\n}",
        "logs": "{}",
        "stop": "quit"
    },
    "scripts": {
        "installation": {
            "script": "#!/bin/bash\r\n# steamcmd Base Installation Script\r\n#\r\n# Server Files: /mnt/server\r\n\r\n## download and install steamcmd\r\ncd /tmp\r\nmkdir -p /mnt/server/steamcmd\r\ncurl -sSL -o steamcmd.tar.gz https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz\r\ntar -xzvf steamcmd.tar.gz -C /mnt/server/steamcmd\r\ncd /mnt/server/steamcmd\r\n\r\n# SteamCMD fails otherwise for some reason, even running as root.\r\n# This is changed at the end of the install process anyways.\r\nchown -R root:root /mnt\r\nexport HOME=/mnt/server\r\n\r\n## install game using steamcmd\r\n./steamcmd.sh +force_install_dir /mnt/server +login anonymous +app_update ${SRCDS_APPID} ${EXTRA_FLAGS} +quit\r\n\r\n## set up 32 bit libraries\r\nmkdir -p /mnt/server/.steam/sdk32\r\ncp -v linux32/steamclient.so ../.steam/sdk32/steamclient.so\r\n\r\n## set up 64 bit libraries\r\nmkdir -p /mnt/server/.steam/sdk64\r\ncp -v linux64/steamclient.so ../.steam/sdk64/steamclient.so",
            "container": "ghcr.io/pterodactyl/installers:debian",
            "entrypoint": "bash"
        }
    },
    "variables": [
        {
            "name": "Game ID",
            "description": "The ID corresponding to the game to download and run using SRCDS.",
            "env_variable": "SRCDS_APPID",
            "default_value": "237410",
            "user_viewable": true,
            "user_editable": false,
            "rules": "required|regex:/^(237410)$/"
        },
        {
            "name": "Default Map",
            "description": "The default map to use when starting the server.",
            "env_variable": "SRCDS_MAP",
            "default_value": "sinjar",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|regex:/^(\\w{1,20})$/"
        }
    ]
}
</file>

<file path="database/Seeders/eggs/source-engine/egg-team-fortress2.json">
{
    "_comment": "DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY Jexactyl PANEL - jexactyl.com",
    "meta": {
        "version": "PTDL_v1",
        "update_url": null
    },
    "exported_at": "2022-01-30T14:09:22-05:00",
    "name": "Team Fortress 2",
    "author": "support@jexactyl.com",
    "description": "Team Fortress 2 is a team-based first-person shooter multiplayer video game developed and published by Valve Corporation. It is the sequel to the 1996 mod Team Fortress for Quake and its 1999 remake.",
    "features": ["gsl_token", "steam_disk_space"],
    "images": ["ghcr.io/pterodactyl/games:source"],
    "file_denylist": [],
    "startup": "./srcds_run -game tf -console -port {{SERVER_PORT}} +map {{SRCDS_MAP}} +ip 0.0.0.0 -strictportbind -norestart +sv_setsteamaccount {{STEAM_ACC}}",
    "config": {
        "files": "{}",
        "startup": "{\r\n    \"done\": \"gameserver Steam ID\"\r\n}",
        "logs": "{}",
        "stop": "quit"
    },
    "scripts": {
        "installation": {
            "script": "#!/bin/bash\r\n# steamcmd Base Installation Script\r\n#\r\n# Server Files: /mnt/server\r\n# Image to install with is 'debian:buster-slim'\r\n\r\n##\r\n#\r\n# Variables\r\n# STEAM_USER, STEAM_PASS, STEAM_AUTH - Steam user setup. If a user has 2fa enabled it will most likely fail due to timeout. Leave blank for anon install.\r\n# WINDOWS_INSTALL - if it's a windows server you want to install set to 1\r\n# SRCDS_APPID - steam app id ffound here - https://developer.valvesoftware.com/wiki/Dedicated_Servers_List\r\n# EXTRA_FLAGS - when a server has extra glas for things like beta installs or updates.\r\n#\r\n##\r\n\r\n## just in case someone removed the defaults.\r\nif [ \"${STEAM_USER}\" == \"\" ]; then\r\n    echo -e \"steam user is not set.\\n\"\r\n    echo -e \"Using anonymous user.\\n\"\r\n    STEAM_USER=anonymous\r\n    STEAM_PASS=\"\"\r\n    STEAM_AUTH=\"\"\r\nelse\r\n    echo -e \"user set to ${STEAM_USER}\"\r\nfi\r\n\r\n## download and install steamcmd\r\ncd /tmp\r\nmkdir -p /mnt/server/steamcmd\r\ncurl -sSL -o steamcmd.tar.gz https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz\r\ntar -xzvf steamcmd.tar.gz -C /mnt/server/steamcmd\r\nmkdir -p /mnt/server/steamapps # Fix steamcmd disk write error when this folder is missing\r\ncd /mnt/server/steamcmd\r\n\r\n# SteamCMD fails otherwise for some reason, even running as root.\r\n# This is changed at the end of the install process anyways.\r\nchown -R root:root /mnt\r\nexport HOME=/mnt/server\r\n\r\n## install game using steamcmd\r\n./steamcmd.sh +force_install_dir /mnt/server +login ${STEAM_USER} ${STEAM_PASS} ${STEAM_AUTH} $( [[ \"${WINDOWS_INSTALL}\" == \"1\" ]] && printf %s '+@sSteamCmdForcePlatformType windows' ) +app_update ${SRCDS_APPID} ${EXTRA_FLAGS} validate +quit ## other flags may be needed depending on install. looking at you cs 1.6\r\n\r\n## set up 32 bit libraries\r\nmkdir -p /mnt/server/.steam/sdk32\r\ncp -v linux32/steamclient.so ../.steam/sdk32/steamclient.so\r\n\r\n## set up 64 bit libraries\r\nmkdir -p /mnt/server/.steam/sdk64\r\ncp -v linux64/steamclient.so ../.steam/sdk64/steamclient.so",
            "container": "ghcr.io/pterodactyl/installers:debian",
            "entrypoint": "bash"
        }
    },
    "variables": [
        {
            "name": "Game ID",
            "description": "The ID corresponding to the game to download and run using SRCDS.",
            "env_variable": "SRCDS_APPID",
            "default_value": "232250",
            "user_viewable": true,
            "user_editable": false,
            "rules": "required|regex:/^(232250)$/"
        },
        {
            "name": "Default Map",
            "description": "The default map to use when starting the server.",
            "env_variable": "SRCDS_MAP",
            "default_value": "cp_dustbowl",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|regex:/^(\\w{1,20})$/"
        },
        {
            "name": "Steam",
            "description": "The Steam Game Server Login Token to display servers publicly. Generate one at https://steamcommunity.com/dev/managegameservers",
            "env_variable": "STEAM_ACC",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|string|alpha_num|size:32"
        }
    ]
}
</file>

<file path="database/Seeders/eggs/voice-servers/egg-mumble-server.json">
{
    "_comment": "DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY Jexactyl PANEL - jexactyl.com",
    "meta": {
        "version": "PTDL_v2",
        "update_url": null
    },
    "exported_at": "2022-10-15T12:38:18+02:00",
    "name": "Mumble Server",
    "author": "support@jexactyl.com",
    "description": "Mumble is an open source, low-latency, high quality voice chat software primarily intended for use while gaming.",
    "features": null,
    "docker_images": {
        "Mumble": "ghcr.io/parkervcp/yolks:voice_mumble"
    },
    "file_denylist": [],
    "startup": "mumble-server -fg -ini murmur.ini",
    "config": {
        "files": "{\r\n    \"murmur.ini\": {\r\n        \"parser\": \"ini\",\r\n        \"find\": {\r\n            \"database\": \"/home/container/murmur.sqlite\",\r\n            \"logfile\": \"/home/container/murmur.log\",\r\n            \"port\": \"{{server.build.default.port}}\",\r\n            \"host\": \"0.0.0.0\",\r\n            \"users\": \"{{server.build.env.MAX_USERS}}\"\r\n        }\r\n    }\r\n}",
        "startup": "{\r\n    \"done\": \"Server listening on\"\r\n}",
        "logs": "{}",
        "stop": "^C"
    },
    "scripts": {
        "installation": {
            "script": "#!/bin/ash\r\n\r\nif [ ! -d /mnt/server/ ]; then\r\n    mkdir /mnt/server/\r\nfi\r\n\r\ncd /mnt/server\r\n\r\nFILE=/mnt/server/murmur.ini\r\nif [ -f \"$FILE\" ]; then\r\n    echo \"Config file already exists.\"\r\nelse \r\n    echo \"Downloading the config file.\"\r\n    apk add --no-cache murmur\r\n    cp /etc/murmur.ini /mnt/server/murmur.ini\r\n    apk del murmur\r\nfi\r\necho \"done\"",
            "container": "ghcr.io/pterodactyl/installers:alpine",
            "entrypoint": "ash"
        }
    },
    "variables": [
        {
            "name": "Maximum Users",
            "description": "Maximum concurrent users on the mumble server.",
            "env_variable": "MAX_USERS",
            "default_value": "100",
            "user_viewable": true,
            "user_editable": false,
            "rules": "required|numeric|digits_between:1,5",
            "field_type": "text"
        }
    ]
}
</file>

<file path="database/Seeders/eggs/voice-servers/egg-teamspeak3-server.json">
{
    "_comment": "DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY Jexactyl PANEL - jexactyl.com",
    "meta": {
        "version": "PTDL_v1",
        "update_url": null
    },
    "exported_at": "2021-06-15T17:24:18-04:00",
    "name": "Teamspeak3 Server",
    "author": "support@jexactyl.com",
    "description": "VoIP software designed with security in mind, featuring crystal clear voice quality, endless customization options, and scalabilty up to thousands of simultaneous users.",
    "features": null,
    "images": ["ghcr.io/pterodactyl/yolks:debian"],
    "file_denylist": [],
    "startup": "./ts3server default_voice_port={{SERVER_PORT}} query_port={{QUERY_PORT}} filetransfer_ip=0.0.0.0 filetransfer_port={{FILE_TRANSFER}} query_http_port={{QUERY_HTTP}} query_ssh_port={{QUERY_SSH}} query_protocols={{QUERY_PROTOCOLS_VAR}} license_accepted=1",
    "config": {
        "files": "{}",
        "startup": "{\r\n    \"done\": \"listening on 0.0.0.0:\"\r\n}",
        "logs": "{\r\n    \"custom\": true,\r\n    \"location\": \"logs/ts3.log\"\r\n}",
        "stop": "^C"
    },
    "scripts": {
        "installation": {
            "script": "#!/bin/ash\r\n# TS3 Installation Script\r\n#\r\n# Server Files: /mnt/server\r\n\r\nif [ -z ${TS_VERSION} ] || [ ${TS_VERSION} == latest ]; then\r\n    TS_VERSION=$(curl -sSL https://teamspeak.com/versions/server.json | jq -r '.linux.x86_64.version')\r\nfi\r\n\r\ncd /mnt/server\r\n\r\necho -e \"getting files from http://files.teamspeak-services.com/releases/server/${TS_VERSION}/teamspeak3-server_linux_amd64-${TS_VERSION}.tar.bz2\" \r\ncurl -L http://files.teamspeak-services.com/releases/server/${TS_VERSION}/teamspeak3-server_linux_amd64-${TS_VERSION}.tar.bz2 | tar -xvj --strip-components=1\r\ncp ./redist/libmariadb.so.2 ./",
            "container": "ghcr.io/pterodactyl/installers:alpine",
            "entrypoint": "ash"
        }
    },
    "variables": [
        {
            "name": "Server Version",
            "description": "The version of Teamspeak 3 to use when running the server.",
            "env_variable": "TS_VERSION",
            "default_value": "latest",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|string|max:6",
            "field_type": "text"
        },
        {
            "name": "File Transfer Port",
            "description": "The Teamspeak file transfer port",
            "env_variable": "FILE_TRANSFER",
            "default_value": "30033",
            "user_viewable": true,
            "user_editable": false,
            "rules": "required|integer|between:1025,65535",
            "field_type": "text"
        },
        {
            "name": "Query Port",
            "description": "The Teamspeak Query Port",
            "env_variable": "QUERY_PORT",
            "default_value": "10011",
            "user_viewable": true,
            "user_editable": false,
            "rules": "required|integer|between:1025,65535",
            "field_type": "text"
        },
        {
            "name": "Query Protocols",
            "description": "Comma separated list of protocols that can be used to connect to the ServerQuery | \r\nPossible values are raw, ssh and http | \r\nE.g.: raw,ssh,http",
            "env_variable": "QUERY_PROTOCOLS_VAR",
            "default_value": "raw,http,ssh",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|string|max:12",
            "field_type": "text"
        },
        {
            "name": "Query SSH Port",
            "description": "TCP Port opened for ServerQuery connections using SSH",
            "env_variable": "QUERY_SSH",
            "default_value": "10022",
            "user_viewable": true,
            "user_editable": false,
            "rules": "required|integer|between:1025,65535",
            "field_type": "text"
        },
        {
            "name": "Query HTTP Port",
            "description": "TCP Port opened for ServerQuery connections using http",
            "env_variable": "QUERY_HTTP",
            "default_value": "10080",
            "user_viewable": true,
            "user_editable": false,
            "rules": "required|integer|between:1025,65535",
            "field_type": "text"
        }
    ]
}
</file>

<file path="database/Seeders/.gitkeep">

</file>

<file path="database/Seeders/DatabaseSeeder.php">
<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;

class DatabaseSeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run()
    {
        $this->call(NestSeeder::class);
        $this->call(EggSeeder::class);
    }
}
</file>

<file path="database/Seeders/EggSeeder.php">
<?php

namespace Database\Seeders;

use Jexactyl\Models\Egg;
use Jexactyl\Models\Nest;
use Illuminate\Database\Seeder;
use Illuminate\Http\UploadedFile;
use Jexactyl\Services\Eggs\Sharing\EggImporterService;
use Jexactyl\Services\Eggs\Sharing\EggUpdateImporterService;

class EggSeeder extends Seeder
{
    protected EggImporterService $importerService;

    protected EggUpdateImporterService $updateImporterService;

    /**
     * @var string[]
     */
    public static array $import = [
        'Minecraft',
        'Source Engine',
        'Voice Servers',
        'Rust',
    ];

    /**
     * EggSeeder constructor.
     */
    public function __construct(
        EggImporterService $importerService,
        EggUpdateImporterService $updateImporterService
    ) {
        $this->importerService = $importerService;
        $this->updateImporterService = $updateImporterService;
    }

    /**
     * Run the egg seeder.
     */
    public function run()
    {
        foreach (static::$import as $nest) {
            /* @noinspection PhpParamsInspection */
            $this->parseEggFiles(
                Nest::query()->where('author', 'support@jexactyl.com')->where('name', $nest)->firstOrFail()
            );
        }
    }

    /**
     * Loop through the list of egg files and import them.
     */
    protected function parseEggFiles(Nest $nest)
    {
        $files = new \DirectoryIterator(database_path('Seeders/eggs/' . kebab_case($nest->name)));

        $this->command->alert('Updating Eggs for Nest: ' . $nest->name);
        /** @var \DirectoryIterator $file */
        foreach ($files as $file) {
            if (!$file->isFile() || !$file->isReadable()) {
                continue;
            }

            $decoded = json_decode(file_get_contents($file->getRealPath()), true, 512, JSON_THROW_ON_ERROR);
            $file = new UploadedFile($file->getPathname(), $file->getFilename(), 'application/json');

            $egg = $nest->eggs()
                ->where('author', $decoded['author'])
                ->where('name', $decoded['name'])
                ->first();

            if ($egg instanceof Egg) {
                $this->updateImporterService->handle($egg, $file);
                $this->command->info('Updated ' . $decoded['name']);
            } else {
                $this->importerService->handle($file, $nest->id);
                $this->command->comment('Created ' . $decoded['name']);
            }
        }

        $this->command->line('');
    }
}
</file>

<file path="database/Seeders/NestSeeder.php">
<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Jexactyl\Services\Nests\NestCreationService;
use Jexactyl\Contracts\Repository\NestRepositoryInterface;

class NestSeeder extends Seeder
{
    /**
     * @var \Jexactyl\Services\Nests\NestCreationService
     */
    private $creationService;

    /**
     * @var \Jexactyl\Contracts\Repository\NestRepositoryInterface
     */
    private $repository;

    /**
     * NestSeeder constructor.
     */
    public function __construct(
        NestCreationService $creationService,
        NestRepositoryInterface $repository
    ) {
        $this->creationService = $creationService;
        $this->repository = $repository;
    }

    /**
     * Run the seeder to add missing nests to the Panel.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    public function run()
    {
        $items = $this->repository->findWhere([
            'author' => 'support@jexactyl.com',
        ])->keyBy('name')->toArray();

        $this->createMinecraftNest(array_get($items, 'Minecraft'));
        $this->createSourceEngineNest(array_get($items, 'Source Engine'));
        $this->createVoiceServersNest(array_get($items, 'Voice Servers'));
        $this->createRustNest(array_get($items, 'Rust'));
    }

    /**
     * Create the Minecraft nest to be used later on.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    private function createMinecraftNest(array $nest = null)
    {
        if (is_null($nest)) {
            $this->creationService->handle([
                'private' => false,
                'name' => 'Minecraft',
                'description' => 'Minecraft - the classic game from Mojang. With support for Vanilla MC, Spigot, and many others',
            ], 'support@jexactyl.com');
        }
    }

    /**
     * Create the Source Engine Games nest to be used later on.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    private function createSourceEngineNest(array $nest = null)
    {
        if (is_null($nest)) {
            $this->creationService->handle([
                'private' => false,
                'name' => 'Source Engine',
                'description' => 'Includes support for most Source Dedicated Server games',
            ], 'support@jexactyl.com');
        }
    }

    /**
     * Create the Voice Servers nest to be used later on.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    private function createVoiceServersNest(array $nest = null)
    {
        if (is_null($nest)) {
            $this->creationService->handle([
                'private' => false,
                'name' => 'Voice Servers',
                'description' => 'Voice servers such as Mumble and Teamspeak 3',
            ], 'support@jexactyl.com');
        }
    }

    /**
     * Create the Rust nest to be used later on.
     *
     * @throws \Jexactyl\Exceptions\Model\DataValidationException
     */
    private function createRustNest(array $nest = null)
    {
        if (is_null($nest)) {
            $this->creationService->handle([
                'private' => false,
                'name' => 'Rust',
                'description' => 'Rust - A game where you must fight to survive',
            ], 'support@jexactyl.com');
        }
    }
}
</file>

<file path="database/.gitignore">
*.sqlite
</file>

<file path="public/favicons/browserconfig.xml">
<?xml version="1.0" encoding="utf-8"?>
<browserconfig><msapplication><tile><square70x70logo src="/ms-icon-70x70.png"/><square150x150logo src="/ms-icon-150x150.png"/><square310x310logo src="/ms-icon-310x310.png"/><TileColor>#ffffff</TileColor></tile></msapplication></browserconfig>
</file>

<file path="public/favicons/manifest.json">
{
    "name": "App",
    "icons": [
        {
            "src": "/android-icon-36x36.png",
            "sizes": "36x36",
            "type": "image/png",
            "density": "0.75"
        },
        {
            "src": "/android-icon-48x48.png",
            "sizes": "48x48",
            "type": "image/png",
            "density": "1.0"
        },
        {
            "src": "/android-icon-72x72.png",
            "sizes": "72x72",
            "type": "image/png",
            "density": "1.5"
        },
        {
            "src": "/android-icon-96x96.png",
            "sizes": "96x96",
            "type": "image/png",
            "density": "2.0"
        },
        {
            "src": "/android-icon-144x144.png",
            "sizes": "144x144",
            "type": "image/png",
            "density": "3.0"
        },
        {
            "src": "/android-icon-192x192.png",
            "sizes": "192x192",
            "type": "image/png",
            "density": "4.0"
        }
    ]
}
</file>

<file path="public/js/autocomplete.js">
// Hacky fix for browsers ignoring autocomplete="off"
$(document).ready(function () {
    $('.form-autocomplete-stop').on('click', function () {
        $(this).removeAttr('readonly').blur().focus();
    });
});
</file>

<file path="public/js/keyboard.polyfill.js">
/* global define, KeyboardEvent, module */

(function () {
    var keyboardeventKeyPolyfill = {
        polyfill: polyfill,
        keys: {
            3: 'Cancel',
            6: 'Help',
            8: 'Backspace',
            9: 'Tab',
            12: 'Clear',
            13: 'Enter',
            16: 'Shift',
            17: 'Control',
            18: 'Alt',
            19: 'Pause',
            20: 'CapsLock',
            27: 'Escape',
            28: 'Convert',
            29: 'NonConvert',
            30: 'Accept',
            31: 'ModeChange',
            32: ' ',
            33: 'PageUp',
            34: 'PageDown',
            35: 'End',
            36: 'Home',
            37: 'ArrowLeft',
            38: 'ArrowUp',
            39: 'ArrowRight',
            40: 'ArrowDown',
            41: 'Select',
            42: 'Print',
            43: 'Execute',
            44: 'PrintScreen',
            45: 'Insert',
            46: 'Delete',
            48: ['0', ')'],
            49: ['1', '!'],
            50: ['2', '@'],
            51: ['3', '#'],
            52: ['4', '$'],
            53: ['5', '%'],
            54: ['6', '^'],
            55: ['7', '&'],
            56: ['8', '*'],
            57: ['9', '('],
            91: 'OS',
            93: 'ContextMenu',
            144: 'NumLock',
            145: 'ScrollLock',
            181: 'VolumeMute',
            182: 'VolumeDown',
            183: 'VolumeUp',
            186: [';', ':'],
            187: ['=', '+'],
            188: [',', '<'],
            189: ['-', '_'],
            190: ['.', '>'],
            191: ['/', '?'],
            192: ['`', '~'],
            219: ['[', '{'],
            220: ['\\', '|'],
            221: [']', '}'],
            222: ["'", '"'],
            224: 'Meta',
            225: 'AltGraph',
            246: 'Attn',
            247: 'CrSel',
            248: 'ExSel',
            249: 'EraseEof',
            250: 'Play',
            251: 'ZoomOut',
        },
    };

    // Function keys (F1-24).
    var i;
    for (i = 1; i < 25; i++) {
        keyboardeventKeyPolyfill.keys[111 + i] = 'F' + i;
    }

    // Printable ASCII characters.
    var letter = '';
    for (i = 65; i < 91; i++) {
        letter = String.fromCharCode(i);
        keyboardeventKeyPolyfill.keys[i] = [letter.toLowerCase(), letter.toUpperCase()];
    }

    function polyfill() {
        if (!('KeyboardEvent' in window) || 'key' in KeyboardEvent.prototype) {
            return false;
        }

        // Polyfill `key` on `KeyboardEvent`.
        var proto = {
            get: function (x) {
                var key = keyboardeventKeyPolyfill.keys[this.which || this.keyCode];

                if (Array.isArray(key)) {
                    key = key[+this.shiftKey];
                }

                return key;
            },
        };
        Object.defineProperty(KeyboardEvent.prototype, 'key', proto);
        return proto;
    }

    if (typeof define === 'function' && define.amd) {
        define('keyboardevent-key-polyfill', keyboardeventKeyPolyfill);
    } else if (typeof exports !== 'undefined' && typeof module !== 'undefined') {
        module.exports = keyboardeventKeyPolyfill;
    } else if (window) {
        window.keyboardeventKeyPolyfill = keyboardeventKeyPolyfill;
    }
})();
</file>

<file path="public/js/laroute.js">
(function () {
    var laroute = function () {
        var routes = {
            absolute: false,
            rootUrl: 'http://pterodactyl.local',
            routes: [
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: '_debugbar/open',
                    name: 'debugbar.openhandler',
                    action: 'BarryvdhDebugbarControllersOpenHandlerController@handle',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: '_debugbar/clockwork/{id}',
                    name: 'debugbar.clockwork',
                    action: 'BarryvdhDebugbarControllersOpenHandlerController@clockwork',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: '_debugbar/assets/stylesheets',
                    name: 'debugbar.assets.css',
                    action: 'BarryvdhDebugbarControllersAssetController@css',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: '_debugbar/assets/javascript',
                    name: 'debugbar.assets.js',
                    action: 'BarryvdhDebugbarControllersAssetController@js',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: '_debugbar/cache/{key}/{tags?}',
                    name: 'debugbar.cache.delete',
                    action: 'BarryvdhDebugbarControllersCacheController@delete',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: '/',
                    name: 'index',
                    action: 'PterodactylHttpControllersBaseIndexController@getIndex',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'status/{server}',
                    name: 'index.status',
                    action: 'PterodactylHttpControllersBaseIndexController@status',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'account',
                    name: 'account',
                    action: 'PterodactylHttpControllersBaseAccountController@index',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'account',
                    name: null,
                    action: 'PterodactylHttpControllersBaseAccountController@update',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'account/api',
                    name: 'account.api',
                    action: 'PterodactylHttpControllersBaseClientApiController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'account/api/new',
                    name: 'account.api.new',
                    action: 'PterodactylHttpControllersBaseClientApiController@create',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'account/api/new',
                    name: null,
                    action: 'PterodactylHttpControllersBaseClientApiController@store',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'account/api/revoke/{identifier}',
                    name: 'account.api.revoke',
                    action: 'PterodactylHttpControllersBaseClientApiController@delete',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'account/security',
                    name: 'account.security',
                    action: 'PterodactylHttpControllersBaseSecurityController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'account/security/revoke/{id}',
                    name: 'account.security.revoke',
                    action: 'PterodactylHttpControllersBaseSecurityController@revoke',
                },
                {
                    host: null,
                    methods: ['PUT'],
                    uri: 'account/security/totp',
                    name: 'account.security.totp',
                    action: 'PterodactylHttpControllersBaseSecurityController@generateTotp',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'account/security/totp',
                    name: 'account.security.totp.set',
                    action: 'PterodactylHttpControllersBaseSecurityController@setTotp',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'account/security/totp',
                    name: 'account.security.totp.disable',
                    action: 'PterodactylHttpControllersBaseSecurityController@disableTotp',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin',
                    name: 'admin.index',
                    action: 'PterodactylHttpControllersAdminBaseController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/statistics',
                    name: 'admin.statistics',
                    action: 'PterodactylHttpControllersAdminStatisticsController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/api',
                    name: 'admin.api.index',
                    action: 'PterodactylHttpControllersAdminApiController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/api/new',
                    name: 'admin.api.new',
                    action: 'PterodactylHttpControllersAdminApiController@create',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/api/new',
                    name: null,
                    action: 'PterodactylHttpControllersAdminApiController@store',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'admin/api/revoke/{identifier}',
                    name: 'admin.api.delete',
                    action: 'PterodactylHttpControllersAdminApiController@delete',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/locations',
                    name: 'admin.locations',
                    action: 'PterodactylHttpControllersAdminLocationController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/locations/view/{location}',
                    name: 'admin.locations.view',
                    action: 'PterodactylHttpControllersAdminLocationController@view',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/locations',
                    name: null,
                    action: 'PterodactylHttpControllersAdminLocationController@create',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'admin/locations/view/{location}',
                    name: null,
                    action: 'PterodactylHttpControllersAdminLocationController@update',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/databases',
                    name: 'admin.databases',
                    action: 'PterodactylHttpControllersAdminDatabaseController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/databases/view/{host}',
                    name: 'admin.databases.view',
                    action: 'PterodactylHttpControllersAdminDatabaseController@view',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/databases',
                    name: null,
                    action: 'PterodactylHttpControllersAdminDatabaseController@create',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'admin/databases/view/{host}',
                    name: null,
                    action: 'PterodactylHttpControllersAdminDatabaseController@update',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'admin/databases/view/{host}',
                    name: null,
                    action: 'PterodactylHttpControllersAdminDatabaseController@delete',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/settings',
                    name: 'admin.settings',
                    action: 'PterodactylHttpControllersAdminSettingsIndexController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/settings/mail',
                    name: 'admin.settings.mail',
                    action: 'PterodactylHttpControllersAdminSettingsMailController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/settings/mail/test',
                    name: 'admin.settings.mail.test',
                    action: 'PterodactylHttpControllersAdminSettingsMailController@test',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/settings/advanced',
                    name: 'admin.settings.advanced',
                    action: 'PterodactylHttpControllersAdminSettingsAdvancedController@index',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'admin/settings',
                    name: null,
                    action: 'PterodactylHttpControllersAdminSettingsIndexController@update',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'admin/settings/mail',
                    name: null,
                    action: 'PterodactylHttpControllersAdminSettingsMailController@update',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'admin/settings/advanced',
                    name: null,
                    action: 'PterodactylHttpControllersAdminSettingsAdvancedController@update',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/users',
                    name: 'admin.users',
                    action: 'PterodactylHttpControllersAdminUserController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/users/accounts.json',
                    name: 'admin.users.json',
                    action: 'PterodactylHttpControllersAdminUserController@json',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/users/new',
                    name: 'admin.users.new',
                    action: 'PterodactylHttpControllersAdminUserController@create',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/users/view/{user}',
                    name: 'admin.users.view',
                    action: 'PterodactylHttpControllersAdminUserController@view',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/users/new',
                    name: null,
                    action: 'PterodactylHttpControllersAdminUserController@store',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'admin/users/view/{user}',
                    name: null,
                    action: 'PterodactylHttpControllersAdminUserController@update',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'admin/users/view/{user}',
                    name: null,
                    action: 'PterodactylHttpControllersAdminUserController@delete',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/servers',
                    name: 'admin.servers',
                    action: 'PterodactylHttpControllersAdminServersController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/servers/new',
                    name: 'admin.servers.new',
                    action: 'PterodactylHttpControllersAdminServersController@create',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/servers/view/{server}',
                    name: 'admin.servers.view',
                    action: 'PterodactylHttpControllersAdminServersController@viewIndex',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/servers/view/{server}/details',
                    name: 'admin.servers.view.details',
                    action: 'PterodactylHttpControllersAdminServersController@viewDetails',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/servers/view/{server}/build',
                    name: 'admin.servers.view.build',
                    action: 'PterodactylHttpControllersAdminServersController@viewBuild',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/servers/view/{server}/startup',
                    name: 'admin.servers.view.startup',
                    action: 'PterodactylHttpControllersAdminServersController@viewStartup',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/servers/view/{server}/database',
                    name: 'admin.servers.view.database',
                    action: 'PterodactylHttpControllersAdminServersController@viewDatabase',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/servers/view/{server}/manage',
                    name: 'admin.servers.view.manage',
                    action: 'PterodactylHttpControllersAdminServersController@viewManage',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/servers/view/{server}/delete',
                    name: 'admin.servers.view.delete',
                    action: 'PterodactylHttpControllersAdminServersController@viewDelete',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/servers/new',
                    name: null,
                    action: 'PterodactylHttpControllersAdminServersController@store',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/servers/view/{server}/build',
                    name: null,
                    action: 'PterodactylHttpControllersAdminServersController@updateBuild',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/servers/view/{server}/startup',
                    name: null,
                    action: 'PterodactylHttpControllersAdminServersController@saveStartup',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/servers/view/{server}/database',
                    name: null,
                    action: 'PterodactylHttpControllersAdminServersController@newDatabase',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/servers/view/{server}/manage/toggle',
                    name: 'admin.servers.view.manage.toggle',
                    action: 'PterodactylHttpControllersAdminServersController@toggleInstall',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/servers/view/{server}/manage/rebuild',
                    name: 'admin.servers.view.manage.rebuild',
                    action: 'PterodactylHttpControllersAdminServersController@rebuildContainer',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/servers/view/{server}/manage/suspension',
                    name: 'admin.servers.view.manage.suspension',
                    action: 'PterodactylHttpControllersAdminServersController@manageSuspension',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/servers/view/{server}/manage/reinstall',
                    name: 'admin.servers.view.manage.reinstall',
                    action: 'PterodactylHttpControllersAdminServersController@reinstallServer',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/servers/view/{server}/delete',
                    name: null,
                    action: 'PterodactylHttpControllersAdminServersController@delete',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'admin/servers/view/{server}/details',
                    name: null,
                    action: 'PterodactylHttpControllersAdminServersController@setDetails',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'admin/servers/view/{server}/database',
                    name: null,
                    action: 'PterodactylHttpControllersAdminServersController@resetDatabasePassword',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'admin/servers/view/{server}/database/{database}/delete',
                    name: 'admin.servers.view.database.delete',
                    action: 'PterodactylHttpControllersAdminServersController@deleteDatabase',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/nodes',
                    name: 'admin.nodes',
                    action: 'PterodactylHttpControllersAdminNodesController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/nodes/new',
                    name: 'admin.nodes.new',
                    action: 'PterodactylHttpControllersAdminNodesController@create',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/nodes/view/{node}',
                    name: 'admin.nodes.view',
                    action: 'PterodactylHttpControllersAdminNodesController@viewIndex',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/nodes/view/{node}/settings',
                    name: 'admin.nodes.view.settings',
                    action: 'PterodactylHttpControllersAdminNodesController@viewSettings',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/nodes/view/{node}/configuration',
                    name: 'admin.nodes.view.configuration',
                    action: 'PterodactylHttpControllersAdminNodesController@viewConfiguration',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/nodes/view/{node}/allocation',
                    name: 'admin.nodes.view.allocation',
                    action: 'PterodactylHttpControllersAdminNodesController@viewAllocation',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/nodes/view/{node}/servers',
                    name: 'admin.nodes.view.servers',
                    action: 'PterodactylHttpControllersAdminNodesController@viewServers',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/nodes/view/{node}/settings/token',
                    name: 'admin.nodes.view.configuration.token',
                    action: 'PterodactylHttpControllersAdminNodesController@setToken',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/nodes/new',
                    name: null,
                    action: 'PterodactylHttpControllersAdminNodesController@store',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/nodes/view/{node}/allocation',
                    name: null,
                    action: 'PterodactylHttpControllersAdminNodesController@createAllocation',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/nodes/view/{node}/allocation/remove',
                    name: 'admin.nodes.view.allocation.removeBlock',
                    action: 'PterodactylHttpControllersAdminNodesController@allocationRemoveBlock',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/nodes/view/{node}/allocation/alias',
                    name: 'admin.nodes.view.allocation.setAlias',
                    action: 'PterodactylHttpControllersAdminNodesController@allocationSetAlias',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'admin/nodes/view/{node}/settings',
                    name: null,
                    action: 'PterodactylHttpControllersAdminNodesController@updateSettings',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'admin/nodes/view/{node}/delete',
                    name: 'admin.nodes.view.delete',
                    action: 'PterodactylHttpControllersAdminNodesController@delete',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'admin/nodes/view/{node}/allocation/remove/{allocation}',
                    name: 'admin.nodes.view.allocation.removeSingle',
                    action: 'PterodactylHttpControllersAdminNodesController@allocationRemoveSingle',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'admin/nodes/view/{node}/allocations',
                    name: 'admin.nodes.view.allocation.removeMultiple',
                    action: 'PterodactylHttpControllersAdminNodesController@allocationRemoveMultiple',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/nests',
                    name: 'admin.nests',
                    action: 'PterodactylHttpControllersAdminNestsNestController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/nests/new',
                    name: 'admin.nests.new',
                    action: 'PterodactylHttpControllersAdminNestsNestController@create',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/nests/view/{nest}',
                    name: 'admin.nests.view',
                    action: 'PterodactylHttpControllersAdminNestsNestController@view',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/nests/egg/new',
                    name: 'admin.nests.egg.new',
                    action: 'PterodactylHttpControllersAdminNestsEggController@create',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/nests/egg/{egg}',
                    name: 'admin.nests.egg.view',
                    action: 'PterodactylHttpControllersAdminNestsEggController@view',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/nests/egg/{egg}/export',
                    name: 'admin.nests.egg.export',
                    action: 'PterodactylHttpControllersAdminNestsEggShareController@export',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/nests/egg/{egg}/variables',
                    name: 'admin.nests.egg.variables',
                    action: 'PterodactylHttpControllersAdminNestsEggVariableController@view',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/nests/egg/{egg}/scripts',
                    name: 'admin.nests.egg.scripts',
                    action: 'PterodactylHttpControllersAdminNestsEggScriptController@index',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/nests/new',
                    name: null,
                    action: 'PterodactylHttpControllersAdminNestsNestController@store',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/nests/import',
                    name: 'admin.nests.egg.import',
                    action: 'PterodactylHttpControllersAdminNestsEggShareController@import',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/nests/egg/new',
                    name: null,
                    action: 'PterodactylHttpControllersAdminNestsEggController@store',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/nests/egg/{egg}/variables',
                    name: null,
                    action: 'PterodactylHttpControllersAdminNestsEggVariableController@store',
                },
                {
                    host: null,
                    methods: ['PUT'],
                    uri: 'admin/nests/egg/{egg}',
                    name: null,
                    action: 'PterodactylHttpControllersAdminNestsEggShareController@update',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'admin/nests/view/{nest}',
                    name: null,
                    action: 'PterodactylHttpControllersAdminNestsNestController@update',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'admin/nests/egg/{egg}',
                    name: null,
                    action: 'PterodactylHttpControllersAdminNestsEggController@update',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'admin/nests/egg/{egg}/scripts',
                    name: null,
                    action: 'PterodactylHttpControllersAdminNestsEggScriptController@update',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'admin/nests/egg/{egg}/variables/{variable}',
                    name: 'admin.nests.egg.variables.edit',
                    action: 'PterodactylHttpControllersAdminNestsEggVariableController@update',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'admin/nests/view/{nest}',
                    name: null,
                    action: 'PterodactylHttpControllersAdminNestsNestController@destroy',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'admin/nests/egg/{egg}',
                    name: null,
                    action: 'PterodactylHttpControllersAdminNestsEggController@destroy',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'admin/nests/egg/{egg}/variables/{variable}',
                    name: null,
                    action: 'PterodactylHttpControllersAdminNestsEggVariableController@destroy',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/packs',
                    name: 'admin.packs',
                    action: 'PterodactylHttpControllersAdminPackController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/packs/new',
                    name: 'admin.packs.new',
                    action: 'PterodactylHttpControllersAdminPackController@create',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/packs/new/template',
                    name: 'admin.packs.new.template',
                    action: 'PterodactylHttpControllersAdminPackController@newTemplate',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'admin/packs/view/{pack}',
                    name: 'admin.packs.view',
                    action: 'PterodactylHttpControllersAdminPackController@view',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/packs/new',
                    name: null,
                    action: 'PterodactylHttpControllersAdminPackController@store',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'admin/packs/view/{pack}/export/{files?}',
                    name: 'admin.packs.view.export',
                    action: 'PterodactylHttpControllersAdminPackController@export',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'admin/packs/view/{pack}',
                    name: null,
                    action: 'PterodactylHttpControllersAdminPackController@update',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'admin/packs/view/{pack}',
                    name: null,
                    action: 'PterodactylHttpControllersAdminPackController@destroy',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'auth/login',
                    name: 'auth.login',
                    action: 'PterodactylHttpControllersAuthLoginController@showLoginForm',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'auth/login/totp',
                    name: 'auth.totp',
                    action: 'PterodactylHttpControllersAuthLoginController@totp',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'auth/password',
                    name: 'auth.password',
                    action: 'PterodactylHttpControllersAuthForgotPasswordController@showLinkRequestForm',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'auth/password/reset/{token}',
                    name: 'auth.reset',
                    action: 'PterodactylHttpControllersAuthResetPasswordController@showResetForm',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'auth/login',
                    name: null,
                    action: 'PterodactylHttpControllersAuthLoginController@login',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'auth/login/totp',
                    name: null,
                    action: 'PterodactylHttpControllersAuthLoginController@loginUsingTotp',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'auth/password',
                    name: null,
                    action: 'PterodactylHttpControllersAuthForgotPasswordController@sendResetLinkEmail',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'auth/password/reset',
                    name: 'auth.reset.post',
                    action: 'PterodactylHttpControllersAuthResetPasswordController@reset',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'auth/password/reset/{token}',
                    name: null,
                    action: 'PterodactylHttpControllersAuthForgotPasswordController@sendResetLinkEmail',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'auth/logout',
                    name: 'auth.logout',
                    action: 'PterodactylHttpControllersAuthLoginController@logout',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'server/{server}',
                    name: 'server.index',
                    action: 'PterodactylHttpControllersServerConsoleController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'server/{server}/console',
                    name: 'server.console',
                    action: 'PterodactylHttpControllersServerConsoleController@console',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'server/{server}/settings/allocation',
                    name: 'server.settings.allocation',
                    action: 'PterodactylHttpControllersServerSettingsAllocationController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'server/{server}/settings/name',
                    name: 'server.settings.name',
                    action: 'PterodactylHttpControllersServerSettingsNameController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'server/{server}/settings/sftp',
                    name: 'server.settings.sftp',
                    action: 'PterodactylHttpControllersServerSettingsSftpController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'server/{server}/settings/startup',
                    name: 'server.settings.startup',
                    action: 'PterodactylHttpControllersServerSettingsStartupController@index',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'server/{server}/settings/allocation',
                    name: null,
                    action: 'PterodactylHttpControllersServerSettingsAllocationController@update',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'server/{server}/settings/name',
                    name: null,
                    action: 'PterodactylHttpControllersServerSettingsNameController@update',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'server/{server}/settings/startup',
                    name: null,
                    action: 'PterodactylHttpControllersServerSettingsStartupController@update',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'server/{server}/databases',
                    name: 'server.databases.index',
                    action: 'PterodactylHttpControllersServerDatabaseController@index',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'server/{server}/databases/new',
                    name: 'server.databases.new',
                    action: 'PterodactylHttpControllersServerDatabaseController@store',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'server/{server}/databases/password',
                    name: 'server.databases.password',
                    action: 'PterodactylHttpControllersServerDatabaseController@update',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'server/{server}/databases/delete/{database}',
                    name: 'server.databases.delete',
                    action: 'PterodactylHttpControllersServerDatabaseController@delete',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'server/{server}/files',
                    name: 'server.files.index',
                    action: 'PterodactylHttpControllersServerFilesFileActionsController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'server/{server}/files/add',
                    name: 'server.files.add',
                    action: 'PterodactylHttpControllersServerFilesFileActionsController@create',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'server/{server}/files/edit/{file}',
                    name: 'server.files.edit',
                    action: 'PterodactylHttpControllersServerFilesFileActionsController@view',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'server/{server}/files/download/{file}',
                    name: 'server.files.edit',
                    action: 'PterodactylHttpControllersServerFilesDownloadController@index',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'server/{server}/files/directory-list',
                    name: 'server.files.directory-list',
                    action: 'PterodactylHttpControllersServerFilesRemoteRequestController@directory',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'server/{server}/files/save',
                    name: 'server.files.save',
                    action: 'PterodactylHttpControllersServerFilesRemoteRequestController@store',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'server/{server}/users',
                    name: 'server.subusers',
                    action: 'PterodactylHttpControllersServerSubuserController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'server/{server}/users/new',
                    name: 'server.subusers.new',
                    action: 'PterodactylHttpControllersServerSubuserController@create',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'server/{server}/users/new',
                    name: null,
                    action: 'PterodactylHttpControllersServerSubuserController@store',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'server/{server}/users/view/{subuser}',
                    name: 'server.subusers.view',
                    action: 'PterodactylHttpControllersServerSubuserController@view',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'server/{server}/users/view/{subuser}',
                    name: null,
                    action: 'PterodactylHttpControllersServerSubuserController@update',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'server/{server}/users/view/{subuser}',
                    name: null,
                    action: 'PterodactylHttpControllersServerSubuserController@delete',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'server/{server}/schedules',
                    name: 'server.schedules',
                    action: 'PterodactylHttpControllersServerTasksTaskManagementController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'server/{server}/schedules/new',
                    name: 'server.schedules.new',
                    action: 'PterodactylHttpControllersServerTasksTaskManagementController@create',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'server/{server}/schedules/new',
                    name: null,
                    action: 'PterodactylHttpControllersServerTasksTaskManagementController@store',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'server/{server}/schedules/view/{schedule}',
                    name: 'server.schedules.view',
                    action: 'PterodactylHttpControllersServerTasksTaskManagementController@view',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'server/{server}/schedules/view/{schedule}',
                    name: null,
                    action: 'PterodactylHttpControllersServerTasksTaskManagementController@update',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'server/{server}/schedules/view/{schedule}/toggle',
                    name: 'server.schedules.toggle',
                    action: 'PterodactylHttpControllersServerTasksActionController@toggle',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'server/{server}/schedules/view/{schedule}/trigger',
                    name: 'server.schedules.trigger',
                    action: 'PterodactylHttpControllersServerTasksActionController@trigger',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'server/{server}/schedules/view/{schedule}',
                    name: null,
                    action: 'PterodactylHttpControllersServerTasksTaskManagementController@delete',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/application/users',
                    name: 'api.application.users',
                    action: 'PterodactylHttpControllersApiApplicationUsersUserController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/application/users/{user}',
                    name: 'api.application.users.view',
                    action: 'PterodactylHttpControllersApiApplicationUsersUserController@view',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/application/users/external/{external_id}',
                    name: 'api.application.users.external',
                    action: 'PterodactylHttpControllersApiApplicationUsersExternalUserController@index',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'api/application/users',
                    name: null,
                    action: 'PterodactylHttpControllersApiApplicationUsersUserController@store',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'api/application/users/{user}',
                    name: null,
                    action: 'PterodactylHttpControllersApiApplicationUsersUserController@update',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'api/application/users/{user}',
                    name: null,
                    action: 'PterodactylHttpControllersApiApplicationUsersUserController@delete',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/application/nodes',
                    name: 'api.application.nodes',
                    action: 'PterodactylHttpControllersApiApplicationNodesNodeController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/application/nodes/{node}',
                    name: 'api.application.nodes.view',
                    action: 'PterodactylHttpControllersApiApplicationNodesNodeController@view',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'api/application/nodes',
                    name: null,
                    action: 'PterodactylHttpControllersApiApplicationNodesNodeController@store',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'api/application/nodes/{node}',
                    name: null,
                    action: 'PterodactylHttpControllersApiApplicationNodesNodeController@update',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'api/application/nodes/{node}',
                    name: null,
                    action: 'PterodactylHttpControllersApiApplicationNodesNodeController@delete',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/application/nodes/{node}/allocations',
                    name: 'api.application.allocations',
                    action: 'PterodactylHttpControllersApiApplicationNodesAllocationController@index',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'api/application/nodes/{node}/allocations',
                    name: null,
                    action: 'PterodactylHttpControllersApiApplicationNodesAllocationController@store',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'api/application/nodes/{node}/allocations/{allocation}',
                    name: 'api.application.allocations.view',
                    action: 'PterodactylHttpControllersApiApplicationNodesAllocationController@delete',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/application/locations',
                    name: 'api.applications.locations',
                    action: 'PterodactylHttpControllersApiApplicationLocationsLocationController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/application/locations/{location}',
                    name: 'api.application.locations.view',
                    action: 'PterodactylHttpControllersApiApplicationLocationsLocationController@view',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'api/application/locations',
                    name: null,
                    action: 'PterodactylHttpControllersApiApplicationLocationsLocationController@store',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'api/application/locations/{location}',
                    name: null,
                    action: 'PterodactylHttpControllersApiApplicationLocationsLocationController@update',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'api/application/locations/{location}',
                    name: null,
                    action: 'PterodactylHttpControllersApiApplicationLocationsLocationController@delete',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/application/servers',
                    name: 'api.application.servers',
                    action: 'PterodactylHttpControllersApiApplicationServersServerController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/application/servers/{server}',
                    name: 'api.application.servers.view',
                    action: 'PterodactylHttpControllersApiApplicationServersServerController@view',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/application/servers/external/{external_id}',
                    name: 'api.application.servers.external',
                    action: 'PterodactylHttpControllersApiApplicationServersExternalServerController@index',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'api/application/servers/{server}/details',
                    name: 'api.application.servers.details',
                    action: 'PterodactylHttpControllersApiApplicationServersServerDetailsController@details',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'api/application/servers/{server}/build',
                    name: 'api.application.servers.build',
                    action: 'PterodactylHttpControllersApiApplicationServersServerDetailsController@build',
                },
                {
                    host: null,
                    methods: ['PATCH'],
                    uri: 'api/application/servers/{server}/startup',
                    name: 'api.application.servers.startup',
                    action: 'PterodactylHttpControllersApiApplicationServersStartupController@index',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'api/application/servers',
                    name: null,
                    action: 'PterodactylHttpControllersApiApplicationServersServerController@store',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'api/application/servers/{server}/suspend',
                    name: 'api.application.servers.suspend',
                    action: 'PterodactylHttpControllersApiApplicationServersServerManagementController@suspend',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'api/application/servers/{server}/unsuspend',
                    name: 'api.application.servers.unsuspend',
                    action: 'PterodactylHttpControllersApiApplicationServersServerManagementController@unsuspend',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'api/application/servers/{server}/reinstall',
                    name: 'api.application.servers.reinstall',
                    action: 'PterodactylHttpControllersApiApplicationServersServerManagementController@reinstall',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'api/application/servers/{server}/rebuild',
                    name: 'api.application.servers.rebuild',
                    action: 'PterodactylHttpControllersApiApplicationServersServerManagementController@rebuild',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'api/application/servers/{server}',
                    name: null,
                    action: 'PterodactylHttpControllersApiApplicationServersServerController@delete',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'api/application/servers/{server}/{force?}',
                    name: null,
                    action: 'PterodactylHttpControllersApiApplicationServersServerController@delete',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/application/servers/{server}/databases',
                    name: 'api.application.servers.databases',
                    action: 'PterodactylHttpControllersApiApplicationServersDatabaseController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/application/servers/{server}/databases/{database}',
                    name: 'api.application.servers.databases.view',
                    action: 'PterodactylHttpControllersApiApplicationServersDatabaseController@view',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'api/application/servers/{server}/databases',
                    name: null,
                    action: 'PterodactylHttpControllersApiApplicationServersDatabaseController@store',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'api/application/servers/{server}/databases/{database}/reset-password',
                    name: null,
                    action: 'PterodactylHttpControllersApiApplicationServersDatabaseController@resetPassword',
                },
                {
                    host: null,
                    methods: ['DELETE'],
                    uri: 'api/application/servers/{server}/databases/{database}',
                    name: null,
                    action: 'PterodactylHttpControllersApiApplicationServersDatabaseController@delete',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/application/nests',
                    name: 'api.application.nests',
                    action: 'PterodactylHttpControllersApiApplicationNestsNestController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/application/nests/{nest}',
                    name: 'api.application.nests.view',
                    action: 'PterodactylHttpControllersApiApplicationNestsNestController@view',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/application/nests/{nest}/eggs',
                    name: 'api.application.nests.eggs',
                    action: 'PterodactylHttpControllersApiApplicationNestsEggController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/application/nests/{nest}/eggs/{egg}',
                    name: 'api.application.nests.eggs.view',
                    action: 'PterodactylHttpControllersApiApplicationNestsEggController@view',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/client',
                    name: 'api.client.index',
                    action: 'PterodactylHttpControllersApiClientClientController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/client/servers/{server}',
                    name: 'api.client.servers.view',
                    action: 'PterodactylHttpControllersApiClientServersServerController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/client/servers/{server}/utilization',
                    name: 'api.client.servers.resources',
                    action: 'PterodactylHttpControllersApiClientServersResourceUtilizationController@index',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'api/client/servers/{server}/command',
                    name: 'api.client.servers.command',
                    action: 'PterodactylHttpControllersApiClientServersCommandController@index',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'api/client/servers/{server}/power',
                    name: 'api.client.servers.power',
                    action: 'PterodactylHttpControllersApiClientServersPowerController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/remote/authenticate/{token}',
                    name: 'api.remote.authenticate',
                    action: 'PterodactylHttpControllersApiRemoteValidateKeyController@index',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'api/remote/download-file',
                    name: 'api.remote.download_file',
                    action: 'PterodactylHttpControllersApiRemoteFileDownloadController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/remote/eggs',
                    name: 'api.remote.eggs',
                    action: 'PterodactylHttpControllersApiRemoteEggRetrievalController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/remote/eggs/{uuid}',
                    name: 'api.remote.eggs.download',
                    action: 'PterodactylHttpControllersApiRemoteEggRetrievalController@download',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'api/remote/scripts/{uuid}',
                    name: 'api.remote.scripts',
                    action: 'PterodactylHttpControllersApiRemoteEggInstallController@index',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'api/remote/sftp',
                    name: 'api.remote.sftp',
                    action: 'PterodactylHttpControllersApiRemoteSftpController@index',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'daemon/packs/pull/{uuid}',
                    name: 'daemon.pack.pull',
                    action: 'PterodactylHttpControllersDaemonPackController@pull',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'daemon/packs/pull/{uuid}/hash',
                    name: 'daemon.pack.hash',
                    action: 'PterodactylHttpControllersDaemonPackController@hash',
                },
                {
                    host: null,
                    methods: ['GET', 'HEAD'],
                    uri: 'daemon/configure/{token}',
                    name: 'daemon.configuration',
                    action: 'PterodactylHttpControllersDaemonActionController@configuration',
                },
                {
                    host: null,
                    methods: ['POST'],
                    uri: 'daemon/install',
                    name: 'daemon.install',
                    action: 'PterodactylHttpControllersDaemonActionController@markInstall',
                },
            ],
            prefix: '',

            route: function (name, parameters, route) {
                route = route || this.getByName(name);

                if (!route) {
                    return undefined;
                }

                return this.toRoute(route, parameters);
            },

            url: function (url, parameters) {
                parameters = parameters || [];

                var uri = url + '/' + parameters.join('/');

                return this.getCorrectUrl(uri);
            },

            toRoute: function (route, parameters) {
                var uri = this.replaceNamedParameters(route.uri, parameters);
                var qs = this.getRouteQueryString(parameters);

                if (this.absolute && this.isOtherHost(route)) {
                    return '//' + route.host + '/' + uri + qs;
                }

                return this.getCorrectUrl(uri + qs);
            },

            isOtherHost: function (route) {
                return route.host && route.host != window.location.hostname;
            },

            replaceNamedParameters: function (uri, parameters) {
                uri = uri.replace(/\{(.*?)\??\}/g, function (match, key) {
                    if (parameters.hasOwnProperty(key)) {
                        var value = parameters[key];
                        delete parameters[key];
                        return value;
                    } else {
                        return match;
                    }
                });

                // Strip out any optional parameters that were not given
                uri = uri.replace(/\/\{.*?\?\}/g, '');

                return uri;
            },

            getRouteQueryString: function (parameters) {
                var qs = [];
                for (var key in parameters) {
                    if (parameters.hasOwnProperty(key)) {
                        qs.push(key + '=' + parameters[key]);
                    }
                }

                if (qs.length < 1) {
                    return '';
                }

                return '?' + qs.join('&');
            },

            getByName: function (name) {
                for (var key in this.routes) {
                    if (this.routes.hasOwnProperty(key) && this.routes[key].name === name) {
                        return this.routes[key];
                    }
                }
            },

            getByAction: function (action) {
                for (var key in this.routes) {
                    if (this.routes.hasOwnProperty(key) && this.routes[key].action === action) {
                        return this.routes[key];
                    }
                }
            },

            getCorrectUrl: function (uri) {
                var url = this.prefix + '/' + uri.replace(/^\/?/, '');

                if (!this.absolute) {
                    return url;
                }

                return this.rootUrl.replace('//?$/', '') + url;
            },
        };

        var getLinkAttributes = function (attributes) {
            if (!attributes) {
                return '';
            }

            var attrs = [];
            for (var key in attributes) {
                if (attributes.hasOwnProperty(key)) {
                    attrs.push(key + '="' + attributes[key] + '"');
                }
            }

            return attrs.join(' ');
        };

        var getHtmlLink = function (url, title, attributes) {
            title = title || url;
            attributes = getLinkAttributes(attributes);

            return '<a href="' + url + '" ' + attributes + '>' + title + '</a>';
        };

        return {
            // Generate a url for a given controller action.
            // Router.action('HomeController@getIndex', [params = {}])
            action: function (name, parameters) {
                parameters = parameters || {};

                return routes.route(name, parameters, routes.getByAction(name));
            },

            // Generate a url for a given named route.
            // Router.route('routeName', [params = {}])
            route: function (route, parameters) {
                parameters = parameters || {};

                return routes.route(route, parameters);
            },

            // Generate a fully qualified URL to the given path.
            // Router.route('url', [params = {}])
            url: function (route, parameters) {
                parameters = parameters || {};

                return routes.url(route, parameters);
            },

            // Generate a html link to the given url.
            // Router.link_to('foo/bar', [title = url], [attributes = {}])
            link_to: function (url, title, attributes) {
                url = this.url(url);

                return getHtmlLink(url, title, attributes);
            },

            // Generate a html link to the given route.
            // Router.link_to_route('route.name', [title=url], [parameters = {}], [attributes = {}])
            link_to_route: function (route, title, parameters, attributes) {
                var url = this.route(route, parameters);

                return getHtmlLink(url, title, attributes);
            },

            // Generate a html link to the given controller action.
            // Router.link_to_action('HomeController@getIndex', [title=url], [parameters = {}], [attributes = {}])
            link_to_action: function (action, title, parameters, attributes) {
                var url = this.action(action, parameters);

                return getHtmlLink(url, title, attributes);
            },
        };
    }.call(this);

    /**
     * Expose the class either via AMD, CommonJS or the global object
     */
    if (typeof define === 'function' && define.amd) {
        define(function () {
            return laroute;
        });
    } else if (typeof module === 'object' && module.exports) {
        module.exports = laroute;
    } else {
        window.Router = laroute;
    }
}.call(this));
</file>

<file path="public/themes/blue/css/blue.css">
/**
 * Jexactyl - Panel
 * Copyright (c) 2015 - 2017 Dane Everitt <dane@daneeveritt.com>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
@import 'checkbox.css';

body {
    color: #cad1d8;
}

.skin-blue .wrapper,
.skin-blue .main-sidebar,
.skin-blue .left-side {
    background-color: #202b4a;
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.12), 0 2px 4px 0 rgba(0, 0, 0, 0.08);
}

.skin-blue .main-header .logo {
    background-color: #202b4a;
    color: #9aa5b1;
}

.skin-blue .main-header .navbar .sidebar-toggle {
    color: #9aa5b1;
}

.skin-blue .main-header .navbar .nav > li > a {
    color: #9aa5b1;
}

.skin-blue .sidebar-menu > li.header {
    color: #797979;
    background: #0e111582;
}

.skin-blue .main-header .navbar {
    background-color: #202b4a;
}

.skin-blue .main-header .navbar .sidebar-toggle:hover {
    background-color: #1c252e;
}

.skin-blue .main-header .logo:hover {
    background-color: #202b4a;
    color: #f0f0f0;
}

.main-footer {
    background: #1f2933;
    color: #9aa5b1;
    border-top: 1px solid #1f2933;
}

.skin-blue .sidebar-menu > li.active > a {
    border-left-color: #099aa5;
}

.text-gray {
    color: #9aa5b1 !important;
}

.text-green {
    color: #00a65a !important;
}

.text-muted {
    color: #9aa5b1 !important;
}

.text-danger {
    color: #ff1c00;
}

.content-wrapper {
    background-color: #121a30;
}

.btn-success {
    background-color: #8757ed;
    border-color: #8757ed;
}

.btn.btn-green:hover {
    background-color: #8757ed;
    border-color: #8757ed;
}

.btn-primary {
    background-color: #8757ed;
    border-color: #8757ed;
}

.btn.btn-primary:hover {
    background-color: #8757ed;
    border-color: #8757ed;
}

.box {
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.12), 0 2px 4px 0 rgba(0, 0, 0, 0.08) !important;
    background: #202b4a;
    border-top: 3px solid #1f2933;
}

.box-header {
    color: #cad1d8;
    background: #202b4a;
}

.box-header.with-border {
    border-bottom: 1px solid #1f2933;
}

.box.box-default {
    border-top-color: #1f2933;
}

.box-footer {
    border-top: 1px solid hsl(210, 23%, 18%);
    background-color: #202b4a;
}

.content-header > .breadcrumb > li > a {
    color: #cad1d8;
}

.breadcrumb > .active {
    color: #cad1d8;
}

.h1 .small,
.h1 small,
.h2 .small,
.h2 small,
.h3 .small,
.h3 small,
.h4 .small,
.h4 small,
.h5 .small,
.h5 small,
.h6 .small,
.h6 small,
h1 .small,
h1 small,
h2 .small,
h2 small,
h3 .small,
h3 small,
h4 .small,
h4 small,
h5 .small,
h5 small,
h6 .small,
h6 small {
    color: #cad1d8;
}

.table > thead > tr > th,
.table > tbody > tr > th,
.table > tfoot > tr > th,
.table > thead > tr > td,
.table > tbody > tr > td,
.table > tfoot > tr > td {
    border-top: 1px solid #4d5b69;
}

.table > thead > tr > th {
    border-bottom: 2px solid #4d5b69;
}

.table-hover > tbody > tr:hover {
    background-color: #33404d;
}

a {
    color: #007eff;
}

.nav-tabs-custom {
    background: #202b4a;
}

.nav-tabs-custom > .nav-tabs > li.active {
    border-top-color: #8757ed;
}

.nav-tabs-custom > .nav-tabs > li.active > a {
    border-right-color: hsl(210, 23%, 18%);
    border-left-color: hsl(210, 23%, 18%);
    background: hsl(210, 24%, 16%);
}

.nav-tabs-custom > .nav-tabs > li > a {
    color: #9aa5b1;
}

.nav-tabs-custom > .nav-tabs > li.active > a,
.nav-tabs-custom > .nav-tabs > li.active:hover > a {
    color: #9aa5b1;
}

input.form-control {
    padding: 0.75rem;
    background-color: hsl(210, 23%, 18%);
    border-width: 1px;
    border-color: hsl(209, 20%, 25%);
    border-radius: 0.25rem;
    color: #cad1d8;
    box-shadow: none;
    -webkit-transition: border 0.15s linear, box-shaodw 0.15s ease-in;
    transition: border 0.15s linear, box-shaodw 0.15s ease-in;
}

textarea.form-control {
    padding: 0.75rem;
    background-color: hsl(210, 23%, 18%);
    border-width: 1px;
    border-color: hsl(209, 20%, 25%);
    border-radius: 0.25rem;
    color: #cad1d8;
    box-shadow: none;
    -webkit-transition: border 0.15s linear, box-shaodw 0.15s ease-in;
    transition: border 0.15s linear, box-shaodw 0.15s ease-in;
}

.input-group .input-group-addon {
    border-color: #606d7b;
    background-color: #515f6cbb;
    color: #cad1d8;
}

.select2-container--default .select2-selection--single,
.select2-selection .select2-selection--single {
    border: 1px solid #606d7b;
}

.select2-container--default .select2-selection--single {
    background-color: #515f6cbb;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #cad1d8;
}

.select2-container--default .select2-selection--multiple {
    background-color: #515f6cbb;
}

.select2-container--default .select2-selection--multiple {
    border: 1px solid #606d7b;
    border-radius: 0;
}

code {
    background-color: #515f6cbb;
    color: #c3c3c3;
    border: 1px solid rgba(0, 0, 0, 0.25);
}

.btn-default {
    background-color: hsl(210, 23%, 18%);
    color: #cad1d8;
    border-color: #606d7b;
}

.select2-results__option {
    background-color: #b5bcc1;
    color: #444;
}

.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #3c8dbc;
}

.modal-body {
    background: #3f4d5a;
}

.modal-header {
    background: #3f4d5a;
    border-bottom-color: #4d5b69;
}

.modal-footer {
    background: #3f4d5a;
    border-top-color: #4d5b69;
}

@media (max-width: 991px) {
    .content-header > .breadcrumb {
        background: #1f2933 !important;
    }
}

.nav-tabs-custom > .nav-tabs > li.active > a,
.nav-tabs-custom > .nav-tabs > li.active:hover > a {
    background-color: hsl(210, 23%, 18%);
}

.select2-container--default .select2-results__option[aria-selected='true'],
.select2-container--default .select2-results__option[aria-selected='true']:hover {
    color: #fff;
}

.select2-dropdown {
    background-color: #515f6cbb;
    border: 1px solid #606d7b;
}
.select2-container--default.select2-container--focus .select2-selection--multiple,
.select2-container--default .select2-search--dropdown .select2-search__field {
    border-color: #d2d6de !important;
    background-color: #515f6cbb;
}

.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #099aa5;
}

a {
    color: #288afb;
}

a:hover {
    color: #206ec7;
}

.form-control {
    border-color: hsl(209, 20%, 25%);
    background-color: hsl(210, 23%, 18%);
    color: #cad1d8;
}

.form-control[disabled],
.form-control[readonly],
fieldset[disabled] .form-control {
    background-color: #1f2933;
    color: #cad1d8;
    cursor: not-allowed;
}

.well {
    min-height: 20px;
    padding: 19px;
    margin-bottom: 20px;
    background-color: #515f6cbb;
    border: 1px solid #606d7b;
}

.well-lg {
    padding: 24px;
}

.well-sm {
    padding: 9px;
}

.small-box h3,
.small-box p {
    color: #c3c3c3;
}

.small-box-footer {
    color: #288afb;
}

.small-box .icon {
    color: #cad1d8;
}

.bg-gray {
    background-color: #33404d !important;
}

pre {
    color: #cad1d8;
    background-color: hsl(210, 23%, 18%);
    border-color: hsl(209, 20%, 25%);
}
</file>

<file path="public/themes/dark/css/dark.css">
/**
 * Jexactyl - Panel
 * Copyright (c) 2015 - 2017 Dane Everitt <dane@daneeveritt.com>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
@import 'checkbox.css';

body {
    color: #cad1d8;
}

.skin-blue .wrapper,
.skin-blue .main-sidebar,
.skin-blue .left-side {
    background-color: #000;
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.12), 0 2px 4px 0 rgba(0, 0, 0, 0.08);
}

.skin-blue .main-header .logo {
    background-color: #000;
    color: #9aa5b1;
}

.skin-blue .main-header .navbar .sidebar-toggle {
    color: #9aa5b1;
}

.skin-blue .main-header .navbar .nav > li > a {
    color: #9aa5b1;
}

.skin-blue .sidebar-menu > li.header {
    color: #797979;
    background: #0e111582;
}

.skin-blue .main-header .navbar {
    background-color: #333;
}

.skin-blue .main-header .navbar .sidebar-toggle:hover {
    background-color: #1c252e;
}

.skin-blue .main-header .logo:hover {
    background-color: hsl(210, 23%, 18%);
    color: #f0f0f0;
}

.main-footer {
    background: #1f2933;
    color: #9aa5b1;
    border-top: 1px solid #1f2933;
}

.skin-blue .sidebar-menu > li.active > a {
    border-left-color: #00a65a;
}

.text-gray {
    color: #9aa5b1 !important;
}

.text-green {
    color: #00a65a !important;
}

.text-muted {
    color: #9aa5b1 !important;
}

.text-danger {
    color: #ff1c00;
}

.content-wrapper {
    background-color: #111;
}

.btn-success {
    background-color: #189a1c;
    border-color: #0f8513;
}

.btn.btn-green:hover {
    background-color: #0f8513;
    border-color: #0e7717;
}

.btn-primary {
    background-color: #0967d3;
    border-color: #0550b3;
}

.btn.btn-primary:hover {
    background-color: #0550b3;
    border-color: #0345a0;
}

.box {
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.12), 0 2px 4px 0 rgba(0, 0, 0, 0.08) !important;
    background: #222;
    border-top: 3px solid #1f2933;
}

.box-header {
    color: #cad1d8;
}

.box-header.with-border {
    border-bottom: 1px solid #1f2933;
}

.box.box-default {
    border-top-color: #1f2933;
}

.box-footer {
    border-top: 1px solid hsl(210, 23%, 18%);
    background-color: #222;
}

.content-header > .breadcrumb > li > a {
    color: #cad1d8;
}

.breadcrumb > .active {
    color: #cad1d8;
}

.h1 .small,
.h1 small,
.h2 .small,
.h2 small,
.h3 .small,
.h3 small,
.h4 .small,
.h4 small,
.h5 .small,
.h5 small,
.h6 .small,
.h6 small,
h1 .small,
h1 small,
h2 .small,
h2 small,
h3 .small,
h3 small,
h4 .small,
h4 small,
h5 .small,
h5 small,
h6 .small,
h6 small {
    color: #cad1d8;
}

.table > thead > tr > th,
.table > tbody > tr > th,
.table > tfoot > tr > th,
.table > thead > tr > td,
.table > tbody > tr > td,
.table > tfoot > tr > td {
    border-top: 1px solid #4d5b69;
}

.table > thead > tr > th {
    border-bottom: 2px solid #4d5b69;
}

.table-hover > tbody > tr:hover {
    background-color: #33404d;
}

a {
    color: #007eff;
}

.nav-tabs-custom {
    background: #222;
}

.nav-tabs-custom > .nav-tabs > li.active {
    border-top-color: #00a65a;
}

.nav-tabs-custom > .nav-tabs > li.active > a {
    border-right-color: hsl(210, 23%, 18%);
    border-left-color: hsl(210, 23%, 18%);
    background: hsl(210, 24%, 16%);
}

.nav-tabs-custom > .nav-tabs > li > a {
    color: #9aa5b1;
}

.nav-tabs-custom > .nav-tabs > li.active > a,
.nav-tabs-custom > .nav-tabs > li.active:hover > a {
    color: #9aa5b1;
}

input.form-control {
    padding: 0.75rem;
    background-color: #111;
    border-width: 1px;
    border-color: hsl(209, 20%, 25%);
    border-radius: 0.25rem;
    color: #cad1d8;
    box-shadow: none;
    -webkit-transition: border 0.15s linear, box-shaodw 0.15s ease-in;
    transition: border 0.15s linear, box-shaodw 0.15s ease-in;
}

textarea.form-control {
    padding: 0.75rem;
    background-color: #111;
    border-width: 1px;
    border-color: hsl(209, 20%, 25%);
    border-radius: 0.25rem;
    color: #cad1d8;
    box-shadow: none;
    -webkit-transition: border 0.15s linear, box-shaodw 0.15s ease-in;
    transition: border 0.15s linear, box-shaodw 0.15s ease-in;
}

.input-group .input-group-addon {
    border-color: #606d7b;
    background-color: #111;
    color: #cad1d8;
}

.select2-container--default .select2-selection--single,
.select2-selection .select2-selection--single {
    border: 1px solid #606d7b;
}

.select2-container--default .select2-selection--single {
    background-color: #111;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #cad1d8;
}

.select2-container--default .select2-selection--multiple {
    background-color: #111;
}

.select2-container--default .select2-selection--multiple {
    border: 1px solid #606d7b;
    border-radius: 0;
}

code {
    background-color: #444;
    color: #c3c3c3;
    border: 1px solid rgba(0, 0, 0, 0.25);
}

.btn-default {
    background-color: hsl(210, 23%, 18%);
    color: #cad1d8;
    border-color: #606d7b;
}

.select2-results__option {
    background-color: #b5bcc1;
    color: #444;
}

.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #3c8dbc;
}

.modal-body {
    background: #3f4d5a;
}

.modal-header {
    background: #3f4d5a;
    border-bottom-color: #4d5b69;
}

.modal-footer {
    background: #3f4d5a;
    border-top-color: #4d5b69;
}

@media (max-width: 991px) {
    .content-header > .breadcrumb {
        background: #1f2933 !important;
    }
}

.nav-tabs-custom > .nav-tabs > li.active > a,
.nav-tabs-custom > .nav-tabs > li.active:hover > a {
    background-color: #333;
}

.select2-container--default .select2-results__option[aria-selected='true'],
.select2-container--default .select2-results__option[aria-selected='true']:hover {
    color: #fff;
}

.select2-dropdown {
    background-color: #111;
    border: 1px solid #606d7b;
}
.select2-container--default.select2-container--focus .select2-selection--multiple,
.select2-container--default .select2-search--dropdown .select2-search__field {
    border-color: #d2d6de !important;
    background-color: #111;
}

.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #099aa5;
}

a {
    color: #288afb;
}

a:hover {
    color: #206ec7;
}

.form-control {
    border-color: hsl(209, 20%, 25%);
    background-color: hsl(210, 23%, 18%);
    color: #cad1d8;
}

.form-control[disabled],
.form-control[readonly],
fieldset[disabled] .form-control {
    background-color: #1f2933;
    color: #cad1d8;
    cursor: not-allowed;
}

.well {
    min-height: 20px;
    padding: 19px;
    margin-bottom: 20px;
    background-color: #515f6cbb;
    border: 1px solid #606d7b;
}

.well-lg {
    padding: 24px;
}

.well-sm {
    padding: 9px;
}

.small-box h3,
.small-box p {
    color: #c3c3c3;
}

.small-box-footer {
    color: #288afb;
}

.small-box .icon {
    color: #cad1d8;
}

.bg-gray {
    background-color: #33404d !important;
}

pre {
    color: #cad1d8;
    background-color: hsl(210, 23%, 18%);
    border-color: hsl(209, 20%, 25%);
}
</file>

<file path="public/themes/default/css/checkbox.css">
/**
 * Bootsnip - "Bootstrap Checkboxes/Radios"
 * Bootstrap 3.2.0 Snippet by i-heart-php <http://bootsnipp.com/i-heart-php>
 *
 * Copyright (c) 2013 Bootsnipp.com
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
.checkbox {
    padding-left: 20px;
}
.checkbox label {
    display: inline-block;
    position: relative;
    padding-left: 5px;
}
.checkbox label::before {
    content: '';
    display: inline-block;
    position: absolute;
    width: 17px;
    height: 17px;
    left: 0;
    top: 2.5px;
    margin-left: -20px;
    border: 1px solid #cccccc;
    border-radius: 3px;
    background-color: #fff;
    -webkit-transition: border 0.15s ease-in-out, color 0.15s ease-in-out;
    -o-transition: border 0.15s ease-in-out, color 0.15s ease-in-out;
    transition: border 0.15s ease-in-out, color 0.15s ease-in-out;
}
.checkbox label::after {
    display: inline-block;
    position: absolute;
    width: 16px;
    height: 16px;
    left: 0;
    top: 2.5px;
    margin-left: -20px;
    padding-left: 3px;
    padding-top: 1px;
    font-size: 11px;
    color: #555555;
}
.checkbox input[type='checkbox'] {
    opacity: 0;
}
.checkbox input[type='checkbox']:focus + label::before {
    outline: thin dotted;
    outline: 5px auto -webkit-focus-ring-color;
    outline-offset: -2px;
}
.checkbox input[type='checkbox']:checked + label::after {
    font-family: 'FontAwesome';
    content: '\f00c';
}
.checkbox input[type='checkbox']:disabled + label {
    opacity: 0.65;
}
.checkbox input[type='checkbox']:disabled + label::before {
    background-color: #eeeeee;
    cursor: not-allowed;
}
.checkbox.checkbox-circle label::before {
    border-radius: 50%;
}
.checkbox.checkbox-inline {
    margin-top: 0;
}
.checkbox-primary input[type='checkbox']:checked + label::before {
    background-color: #428bca;
    border-color: #428bca;
}
.checkbox-primary input[type='checkbox']:checked + label::after {
    color: #fff;
}
.checkbox-danger input[type='checkbox']:checked + label::before {
    background-color: #d9534f;
    border-color: #d9534f;
}
.checkbox-danger input[type='checkbox']:checked + label::after {
    color: #fff;
}
.checkbox-info input[type='checkbox']:checked + label::before {
    background-color: #5bc0de;
    border-color: #5bc0de;
}
.checkbox-info input[type='checkbox']:checked + label::after {
    color: #fff;
}
.checkbox-warning input[type='checkbox']:checked + label::before {
    background-color: #f0ad4e;
    border-color: #f0ad4e;
}
.checkbox-warning input[type='checkbox']:checked + label::after {
    color: #fff;
}
.checkbox-success input[type='checkbox']:checked + label::before {
    background-color: #5cb85c;
    border-color: #5cb85c;
}
.checkbox-success input[type='checkbox']:checked + label::after {
    color: #fff;
}
.radio {
    padding-left: 20px;
}
.radio label {
    display: inline-block;
    position: relative;
    padding-left: 5px;
}
.radio label::before {
    content: '';
    display: inline-block;
    position: absolute;
    width: 17px;
    height: 17px;
    left: 0;
    margin-left: -20px;
    border: 1px solid #cccccc;
    border-radius: 50%;
    background-color: #fff;
    -webkit-transition: border 0.15s ease-in-out;
    -o-transition: border 0.15s ease-in-out;
    transition: border 0.15s ease-in-out;
}
.radio label::after {
    display: inline-block;
    position: absolute;
    content: ' ';
    width: 11px;
    height: 11px;
    left: 3px;
    top: 3px;
    margin-left: -20px;
    border-radius: 50%;
    background-color: #555555;
    -webkit-transform: scale(0, 0);
    -ms-transform: scale(0, 0);
    -o-transform: scale(0, 0);
    transform: scale(0, 0);
    -webkit-transition: -webkit-transform 0.1s cubic-bezier(0.8, -0.33, 0.2, 1.33);
    -moz-transition: -moz-transform 0.1s cubic-bezier(0.8, -0.33, 0.2, 1.33);
    -o-transition: -o-transform 0.1s cubic-bezier(0.8, -0.33, 0.2, 1.33);
    transition: transform 0.1s cubic-bezier(0.8, -0.33, 0.2, 1.33);
}
.radio input[type='radio'] {
    opacity: 0;
}
.radio input[type='radio']:focus + label::before {
    outline: thin dotted;
    outline: 5px auto -webkit-focus-ring-color;
    outline-offset: -2px;
}
.radio input[type='radio']:checked + label::after {
    -webkit-transform: scale(1, 1);
    -ms-transform: scale(1, 1);
    -o-transform: scale(1, 1);
    transform: scale(1, 1);
}
.radio input[type='radio']:disabled + label {
    opacity: 0.65;
}
.radio input[type='radio']:disabled + label::before {
    cursor: not-allowed;
}
.radio.radio-inline {
    margin-top: 0;
}
.radio-primary input[type='radio'] + label::after {
    background-color: #428bca;
}
.radio-primary input[type='radio']:checked + label::before {
    border-color: #428bca;
}
.radio-primary input[type='radio']:checked + label::after {
    background-color: #428bca;
}
.radio-danger input[type='radio'] + label::after {
    background-color: #d9534f;
}
.radio-danger input[type='radio']:checked + label::before {
    border-color: #d9534f;
}
.radio-danger input[type='radio']:checked + label::after {
    background-color: #d9534f;
}
.radio-info input[type='radio'] + label::after {
    background-color: #5bc0de;
}
.radio-info input[type='radio']:checked + label::before {
    border-color: #5bc0de;
}
.radio-info input[type='radio']:checked + label::after {
    background-color: #5bc0de;
}
.radio-warning input[type='radio'] + label::after {
    background-color: #f0ad4e;
}
.radio-warning input[type='radio']:checked + label::before {
    border-color: #f0ad4e;
}
.radio-warning input[type='radio']:checked + label::after {
    background-color: #f0ad4e;
}
.radio-success input[type='radio'] + label::after {
    background-color: #5cb85c;
}
.radio-success input[type='radio']:checked + label::before {
    border-color: #5cb85c;
}
.radio-success input[type='radio']:checked + label::after {
    background-color: #5cb85c;
}
</file>

<file path="public/themes/default/js/admin/server/transfer.js">
$(document).ready(function () {
    $('#pNodeId')
        .select2({
            placeholder: 'Select a Node',
        })
        .change();

    $('#pAllocation').select2({
        placeholder: 'Select a Default Allocation',
    });

    $('#pAllocationAdditional').select2({
        placeholder: 'Select Additional Allocations',
    });
});

$('#pNodeId').on('change', function () {
    let currentNode = $(this).val();

    $.each(Jexactyl.nodeData, function (i, v) {
        if (v.id == currentNode) {
            $('#pAllocation').html('').select2({
                data: v.allocations,
                placeholder: 'Select a Default Allocation',
            });

            updateAdditionalAllocations();
        }
    });
});

$('#pAllocation').on('change', function () {
    updateAdditionalAllocations();
});

function updateAdditionalAllocations() {
    let currentAllocation = $('#pAllocation').val();
    let currentNode = $('#pNodeId').val();

    $.each(Jexactyl.nodeData, function (i, v) {
        if (v.id == currentNode) {
            let allocations = [];

            for (let i = 0; i < v.allocations.length; i++) {
                const allocation = v.allocations[i];

                if (allocation.id != currentAllocation) {
                    allocations.push(allocation);
                }
            }

            $('#pAllocationAdditional').html('').select2({
                data: allocations,
                placeholder: 'Select Additional Allocations',
            });
        }
    });
}
</file>

<file path="public/themes/default/js/admin/functions.js">
// Copyright (c) 2015 - 2017 Dane Everitt <dane@daneeveritt.com>
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.
$.urlParam = function (name) {
    var results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(decodeURIComponent(window.location.href));
    if (results == null) {
        return null;
    } else {
        return results[1] || 0;
    }
};
function getPageName(url) {
    var index = url.lastIndexOf('/') + 1;
    var filenameWithExtension = url.substr(index);
    var filename = filenameWithExtension.split('.')[0];
    return filename;
}
// Remeber Active Tab and Navigate to it on Reload
for (
    var queryParameters = {}, queryString = location.search.substring(1), re = /([^&=]+)=([^&]*)/g, m;
    (m = re.exec(queryString));

)
    queryParameters[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
$("a[data-toggle='tab']").click(function () {
    (queryParameters.tab = $(this).attr('href').substring(1)),
        window.history.pushState(null, null, location.pathname + '?' + $.param(queryParameters));
});
if ($.urlParam('tab') != null) {
    $('.nav.nav-tabs a[href="#' + $.urlParam('tab') + '"]').tab('show');
}
</file>

<file path="public/themes/default/js/admin/new-server.js">
// Copyright (c) 2015 - 2017 Dane Everitt <dane@daneeveritt.com>
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.
$(document).ready(function () {
    $('#pNestId')
        .select2({
            placeholder: 'Select a Nest',
        })
        .change();

    $('#pEggId').select2({
        placeholder: 'Select a Nest Egg',
    });

    $('#pPackId').select2({
        placeholder: 'Select a Service Pack',
    });

    $('#pNodeId')
        .select2({
            placeholder: 'Select a Node',
        })
        .change();

    $('#pAllocation').select2({
        placeholder: 'Select a Default Allocation',
    });

    $('#pAllocationAdditional').select2({
        placeholder: 'Select Additional Allocations',
    });
});

let lastActiveBox = null;
$(document).on('click', function (event) {
    if (lastActiveBox !== null) {
        lastActiveBox.removeClass('box-primary');
    }

    lastActiveBox = $(event.target).closest('.box');
    lastActiveBox.addClass('box-primary');
});

$('#pNodeId').on('change', function () {
    currentNode = $(this).val();
    $.each(Jexactyl.nodeData, function (i, v) {
        if (v.id == currentNode) {
            $('#pAllocation').html('').select2({
                data: v.allocations,
                placeholder: 'Select a Default Allocation',
            });

            updateAdditionalAllocations();
        }
    });
});

$('#pNestId').on('change', function (event) {
    $('#pEggId')
        .html('')
        .select2({
            data: $.map(_.get(Jexactyl.nests, $(this).val() + '.eggs', []), function (item) {
                return {
                    id: item.id,
                    text: item.name,
                };
            }),
        })
        .change();
});

$('#pEggId').on('change', function (event) {
    let parentChain = _.get(Jexactyl.nests, $('#pNestId').val(), null);
    let objectChain = _.get(parentChain, 'eggs.' + $(this).val(), null);

    const images = _.get(objectChain, 'docker_images', {});
    $('#pDefaultContainer').html('');
    const keys = Object.keys(images);
    for (let i = 0; i < keys.length; i++) {
        let opt = document.createElement('option');
        opt.value = images[keys[i]];
        opt.innerHTML = keys[i] + ' (' + images[keys[i]] + ')';
        $('#pDefaultContainer').append(opt);
    }

    if (!_.get(objectChain, 'startup', false)) {
        $('#pStartup').val(_.get(parentChain, 'startup', 'ERROR: Startup Not Defined!'));
    } else {
        $('#pStartup').val(_.get(objectChain, 'startup'));
    }

    $('#pPackId')
        .html('')
        .select2({
            data: [{ id: 0, text: 'No Service Pack' }].concat(
                $.map(_.get(objectChain, 'packs', []), function (item, i) {
                    return {
                        id: item.id,
                        text: item.name + ' (' + item.version + ')',
                    };
                })
            ),
        });

    const variableIds = {};
    $('#appendVariablesTo').html('');
    $.each(_.get(objectChain, 'variables', []), function (i, item) {
        variableIds[item.env_variable] = 'var_ref_' + item.id;

        let isRequired = item.required === 1 ? '<span class="label label-danger">Required</span> ' : '';
        let dataAppend =
            ' \
            <div class="form-group col-sm-6"> \
                <label for="var_ref_' +
            item.id +
            '" class="control-label">' +
            isRequired +
            item.name +
            '</label> \
                <input type="text" id="var_ref_' +
            item.id +
            '" autocomplete="off" name="environment[' +
            item.env_variable +
            ']" class="form-control" value="' +
            item.default_value +
            '" /> \
                <p class="text-muted small">' +
            item.description +
            '<br /> \
                <strong>Access in Startup:</strong> <code>{{' +
            item.env_variable +
            '}}</code><br /> \
                <strong>Validation Rules:</strong> <code>' +
            item.rules +
            '</code></small></p> \
            </div> \
        ';
        $('#appendVariablesTo').append(dataAppend);
    });

    // If you receive a warning on this line, it should be fine to ignore. this function is
    // defined in "resources/views/admin/servers/new.blade.php" near the bottom of the file.
    serviceVariablesUpdated($('#pEggId').val(), variableIds);
});

$('#pAllocation').on('change', function () {
    updateAdditionalAllocations();
});

function updateAdditionalAllocations() {
    let currentAllocation = $('#pAllocation').val();
    let currentNode = $('#pNodeId').val();

    $.each(Jexactyl.nodeData, function (i, v) {
        if (v.id == currentNode) {
            let allocations = [];

            for (let i = 0; i < v.allocations.length; i++) {
                const allocation = v.allocations[i];

                if (allocation.id != currentAllocation) {
                    allocations.push(allocation);
                }
            }

            $('#pAllocationAdditional').html('').select2({
                data: allocations,
                placeholder: 'Select Additional Allocations',
            });
        }
    });
}

function initUserIdSelect(data) {
    function escapeHtml(str) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    $('#pUserId').select2({
        ajax: {
            url: '/admin/users/accounts.json',
            dataType: 'json',
            delay: 250,

            data: function (params) {
                return {
                    filter: { email: params.term },
                    page: params.page,
                };
            },

            processResults: function (data, params) {
                return { results: data };
            },

            cache: true,
        },

        data: data,
        escapeMarkup: function (markup) {
            return markup;
        },
        minimumInputLength: 2,
        templateResult: function (data) {
            if (data.loading) return escapeHtml(data.text);

            return (
                '<div class="user-block"> \
                <img class="img-circle img-bordered-xs" src="https://www.gravatar.com/avatar/' +
                escapeHtml(data.md5) +
                '?s=120" alt="User Image"> \
                <span class="username"> \
                    <a href="#">' +
                escapeHtml(data.name_first) +
                ' ' +
                escapeHtml(data.name_last) +
                '</a> \
                </span> \
                <span class="description"><strong>' +
                escapeHtml(data.email) +
                '</strong> - ' +
                escapeHtml(data.username) +
                '</span> \
            </div>'
            );
        },
        templateSelection: function (data) {
            return (
                '<div> \
                <span> \
                    <img class="img-rounded img-bordered-xs" src="https://www.gravatar.com/avatar/' +
                escapeHtml(data.md5) +
                '?s=120" style="height:28px;margin-top:-4px;" alt="User Image"> \
                </span> \
                <span style="padding-left:5px;"> \
                    ' +
                escapeHtml(data.name_first) +
                ' ' +
                escapeHtml(data.name_last) +
                ' (<strong>' +
                escapeHtml(data.email) +
                '</strong>) \
                </span> \
            </div>'
            );
        },
    });
}
</file>

<file path="public/themes/default/js/admin/statistics.js">
// Jexactyl Software. (https://jexactyl.com)
// Green: #189a1c
// Gray: hsl(211, 22%, 21%)

console.log(Jexactyl);

const suspended = Jexactyl.suspended;
const active = Jexactyl.servers.length - Jexactyl.suspended;
const freeDisk = Jexactyl.diskTotal - Jexactyl.diskUsed;
const freeMemory = Jexactyl.memoryTotal - Jexactyl.memoryUsed;

const diskChart = new Chart($('#disk_chart'), {
    type: 'pie',
    data: {
        labels: ['Free Disk', 'Used Disk'],
        datasets: [
            {
                backgroundColor: ['#189a1c', 'hsl(211, 22%, 21%)'],
                data: [freeDisk, Jexactyl.diskUsed],
            },
        ],
    },
});

const ramChart = new Chart($('#ram_chart'), {
    type: 'pie',
    data: {
        labels: ['Free RAM', 'Used RAM'],
        datasets: [
            {
                backgroundColor: ['#189a1c', 'hsl(211, 22%, 21%)'],
                data: [freeMemory, Jexactyl.memoryUsed],
            },
        ],
    },
});

const serversChart = new Chart($('#servers_chart'), {
    type: 'pie',
    data: {
        labels: ['Active Servers', 'Suspended Servers'],
        datasets: [
            {
                backgroundColor: ['#189a1c', 'hsl(211, 22%, 21%)'],
                data: [active, suspended],
            },
        ],
    },
});
</file>

<file path="public/themes/jexactyl/css/jexactyl.css">
/**
 * Jexactyl - Panel
 * Copyright (c) 2015 - 2017 Dane Everitt <dane@daneeveritt.com>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
@import 'checkbox.css';

body {
    color: #cad1d8;
}

.skin-blue .wrapper,
.skin-blue .main-sidebar,
.skin-blue .left-side {
    background-color: #181f27;
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.12), 0 2px 4px 0 rgba(0, 0, 0, 0.08);
}

.skin-blue .main-header .logo {
    background-color: hsl(210, 23%, 18%);
    color: #9aa5b1;
}

.skin-blue .main-header .navbar .sidebar-toggle {
    color: #9aa5b1;
}

.skin-blue .main-header .navbar .nav > li > a {
    color: #9aa5b1;
}

.skin-blue .sidebar-menu > li.header {
    color: #797979;
    background: #0e111582;
}

.skin-blue .main-header .navbar {
    background-color: hsl(210, 23%, 18%);
}

.skin-blue .main-header .navbar .sidebar-toggle:hover {
    background-color: #1c252e;
}

.skin-blue .main-header .logo:hover {
    background-color: hsl(210, 23%, 18%);
    color: #f0f0f0;
}

.main-footer {
    background: #1f2933;
    color: #9aa5b1;
    border-top: 1px solid #1f2933;
}

.skin-blue .sidebar-menu > li.active > a {
    border-left-color: #099aa5;
}

.text-gray {
    color: #9aa5b1 !important;
}

.text-green {
    color: #00a65a !important;
}

.text-muted {
    color: #9aa5b1 !important;
}

.text-danger {
    color: #ff1c00;
}

.content-wrapper {
    background-color: hsl(211, 22%, 21%);
}

.btn-success {
    background-color: #189a1c;
    border-color: #0f8513;
}

.btn.btn-green:hover {
    background-color: #0f8513;
    border-color: #0e7717;
}

.btn-primary {
    background-color: #0967d3;
    border-color: #0550b3;
}

.btn.btn-primary:hover {
    background-color: #0550b3;
    border-color: #0345a0;
}

.box {
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.12), 0 2px 4px 0 rgba(0, 0, 0, 0.08) !important;
    background: hsl(210, 24%, 16%);
    border-top: 3px solid #1f2933;
}

.box-header {
    color: #cad1d8;
    background: hsl(210, 23%, 18%);
}

.box-header.with-border {
    border-bottom: 1px solid #1f2933;
}

.box.box-default {
    border-top-color: #1f2933;
}

.box-footer {
    border-top: 1px solid hsl(210, 23%, 18%);
    background-color: #1f2933;
}

.content-header > .breadcrumb > li > a {
    color: #cad1d8;
}

.breadcrumb > .active {
    color: #cad1d8;
}

.h1 .small,
.h1 small,
.h2 .small,
.h2 small,
.h3 .small,
.h3 small,
.h4 .small,
.h4 small,
.h5 .small,
.h5 small,
.h6 .small,
.h6 small,
h1 .small,
h1 small,
h2 .small,
h2 small,
h3 .small,
h3 small,
h4 .small,
h4 small,
h5 .small,
h5 small,
h6 .small,
h6 small {
    color: #cad1d8;
}

.table > thead > tr > th,
.table > tbody > tr > th,
.table > tfoot > tr > th,
.table > thead > tr > td,
.table > tbody > tr > td,
.table > tfoot > tr > td {
    border-top: 1px solid #4d5b69;
}

.table > thead > tr > th {
    border-bottom: 2px solid #4d5b69;
}

.table-hover > tbody > tr:hover {
    background-color: #33404d;
}

a {
    color: #007eff;
}

.nav-tabs-custom {
    background: hsl(210, 24%, 16%);
}

.nav-tabs-custom > .nav-tabs > li.active {
    border-top-color: #00a65a;
}

.nav-tabs-custom > .nav-tabs > li.active > a {
    border-right-color: hsl(210, 23%, 18%);
    border-left-color: hsl(210, 23%, 18%);
    background: hsl(210, 24%, 16%);
}

.nav-tabs-custom > .nav-tabs > li > a {
    color: #9aa5b1;
}

.nav-tabs-custom > .nav-tabs > li.active > a,
.nav-tabs-custom > .nav-tabs > li.active:hover > a {
    color: #9aa5b1;
}

input.form-control {
    padding: 0.75rem;
    background-color: hsl(210, 23%, 18%);
    border-width: 1px;
    border-color: hsl(209, 20%, 25%);
    border-radius: 0.25rem;
    color: #cad1d8;
    box-shadow: none;
    -webkit-transition: border 0.15s linear, box-shaodw 0.15s ease-in;
    transition: border 0.15s linear, box-shaodw 0.15s ease-in;
}

textarea.form-control {
    padding: 0.75rem;
    background-color: hsl(210, 23%, 18%);
    border-width: 1px;
    border-color: hsl(209, 20%, 25%);
    border-radius: 0.25rem;
    color: #cad1d8;
    box-shadow: none;
    -webkit-transition: border 0.15s linear, box-shaodw 0.15s ease-in;
    transition: border 0.15s linear, box-shaodw 0.15s ease-in;
}

.input-group .input-group-addon {
    border-color: #606d7b;
    background-color: #515f6cbb;
    color: #cad1d8;
}

.select2-container--default .select2-selection--single,
.select2-selection .select2-selection--single {
    border: 1px solid #606d7b;
}

.select2-container--default .select2-selection--single {
    background-color: #515f6cbb;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #cad1d8;
}

.select2-container--default .select2-selection--multiple {
    background-color: #515f6cbb;
}

.select2-container--default .select2-selection--multiple {
    border: 1px solid #606d7b;
    border-radius: 0;
}

code {
    background-color: #515f6cbb;
    color: #c3c3c3;
    border: 1px solid rgba(0, 0, 0, 0.25);
}

.btn-default {
    background-color: hsl(210, 23%, 18%);
    color: #cad1d8;
    border-color: #606d7b;
}

.select2-results__option {
    background-color: #b5bcc1;
    color: #444;
}

.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #3c8dbc;
}

.modal-body {
    background: #3f4d5a;
}

.modal-header {
    background: #3f4d5a;
    border-bottom-color: #4d5b69;
}

.modal-footer {
    background: #3f4d5a;
    border-top-color: #4d5b69;
}

@media (max-width: 991px) {
    .content-header > .breadcrumb {
        background: #1f2933 !important;
    }
}

.nav-tabs-custom > .nav-tabs > li.active > a,
.nav-tabs-custom > .nav-tabs > li.active:hover > a {
    background-color: hsl(210, 23%, 18%);
}

.select2-container--default .select2-results__option[aria-selected='true'],
.select2-container--default .select2-results__option[aria-selected='true']:hover {
    color: #fff;
}

.select2-dropdown {
    background-color: #515f6cbb;
    border: 1px solid #606d7b;
}
.select2-container--default.select2-container--focus .select2-selection--multiple,
.select2-container--default .select2-search--dropdown .select2-search__field {
    border-color: #d2d6de !important;
    background-color: #515f6cbb;
}

.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #099aa5;
}

a {
    color: #288afb;
}

a:hover {
    color: #206ec7;
}

.form-control {
    border-color: hsl(209, 20%, 25%);
    background-color: hsl(210, 23%, 18%);
    color: #cad1d8;
}

.form-control[disabled],
.form-control[readonly],
fieldset[disabled] .form-control {
    background-color: #1f2933;
    color: #cad1d8;
    cursor: not-allowed;
}

.well {
    min-height: 20px;
    padding: 19px;
    margin-bottom: 20px;
    background-color: #515f6cbb;
    border: 1px solid #606d7b;
}

.well-lg {
    padding: 24px;
}

.well-sm {
    padding: 9px;
}

.small-box h3,
.small-box p {
    color: #c3c3c3;
}

.small-box-footer {
    color: #288afb;
}

.small-box .icon {
    color: #cad1d8;
}

.bg-gray {
    background-color: #33404d !important;
}

pre {
    color: #cad1d8;
    background-color: hsl(210, 23%, 18%);
    border-color: hsl(209, 20%, 25%);
}
</file>

<file path="public/themes/light/css/light.css">
/**
 * This file is essentially just a placeholder, as AdminLTE's default skin is 'light'.
 */
</file>

<file path="public/themes/minecraft/css/minecraft.css">
/**
 * Jexactyl - Panel
 * Copyright (c) 2015 - 2017 Dane Everitt <dane@daneeveritt.com>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
@import 'checkbox.css';

body {
    color: #cad1d8;
}

.skin-blue .wrapper,
.skin-blue .main-sidebar,
.skin-blue .left-side {
    background-color: #3e5c20;
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.12), 0 2px 4px 0 rgba(0, 0, 0, 0.08);
}

.skin-blue .main-header .logo {
    background-color: #3e5c20;
    color: #fff;
}

.skin-blue .main-header .navbar {
    background-color: #202b4a;
}

.skin-blue .main-header .navbar .sidebar-toggle:hover {
    background-color: #1c252e;
}

.skin-blue .main-header .logo:hover {
    background-color: #202b4a;
    color: #f0f0f0;
}

.main-footer {
    background: #1f2933;
    color: #9aa5b1;
    border-top: 1px solid #1f2933;
}

.skin-blue .sidebar-menu > li.active > a {
    border-left-color: #099aa5;
}

.text-gray {
    color: #9aa5b1 !important;
}

.text-green {
    color: #00a65a !important;
}

.text-muted {
    color: #9aa5b1 !important;
}

.text-danger {
    color: #ff1c00;
}

.content-wrapper {
    background: url('https://wallpaperaccess.com/full/171177.jpg');
}

.btn-success {
    background-color: #45aca5;
}

.btn.btn-green:hover {
    background-color: #45aca5;
}

.btn-primary {
    background-color: #45aca5;
}

.btn.btn-primary:hover {
    background-color: #45aca5;
}

.box {
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.12), 0 2px 4px 0 rgba(0, 0, 0, 0.08) !important;
    background: #7c5e42;
    border-top: 3px solid #1f2933;
}

.box-header {
    color: #cad1d8;
    background: #3e5c20;
}

.box-header.with-border {
    border-bottom: 1px solid #1f2933;
}

.box.box-default {
    border-top-color: #1f2933;
}

.box-footer {
    border-top: 1px solid hsl(210, 23%, 18%);
    background-color: #7c5e42;
}

.content-header > .breadcrumb > li > a {
    color: #cad1d8;
}

.breadcrumb > .active {
    color: #cad1d8;
}

.h1 .small,
.h1 small,
.h2 .small,
.h2 small,
.h3 .small,
.h3 small,
.h4 .small,
.h4 small,
.h5 .small,
.h5 small,
.h6 .small,
.h6 small,
h1 .small,
h1 small,
h2 .small,
h2 small,
h3 .small,
h3 small,
h4 .small,
h4 small,
h5 .small,
h5 small,
h6 .small,
h6 small {
    color: #cad1d8;
}

.table > thead > tr > th,
.table > tbody > tr > th,
.table > tfoot > tr > th,
.table > thead > tr > td,
.table > tbody > tr > td,
.table > tfoot > tr > td {
    border-top: 1px solid #4d5b69;
}

.table > thead > tr > th {
    border-bottom: 2px solid #4d5b69;
}

.table-hover > tbody > tr:hover {
    background-color: #33404d;
}

a {
    color: #007eff;
}

.nav-tabs-custom {
    background: #3e5c20;
}

.nav-tabs-custom > .nav-tabs > li.active {
    border-top-color: #7c5e42;
}

.nav-tabs-custom > .nav-tabs > li.active > a {
    border-right-color: #3e5c20;
    border-left-color: #3e5c20;
    background: #3e5c20;
}

.nav-tabs-custom > .nav-tabs > li > a {
    color: #9aa5b1;
}

.nav-tabs-custom > .nav-tabs > li.active > a,
.nav-tabs-custom > .nav-tabs > li.active:hover > a {
    color: #9aa5b1;
}

input.form-control {
    padding: 0.75rem;
    background-color: hsl(210, 23%, 18%);
    border-width: 1px;
    border-color: hsl(209, 20%, 25%);
    border-radius: 0.25rem;
    color: #cad1d8;
    box-shadow: none;
    -webkit-transition: border 0.15s linear, box-shaodw 0.15s ease-in;
    transition: border 0.15s linear, box-shaodw 0.15s ease-in;
}

textarea.form-control {
    padding: 0.75rem;
    background-color: hsl(210, 23%, 18%);
    border-width: 1px;
    border-color: hsl(209, 20%, 25%);
    border-radius: 0.25rem;
    color: #cad1d8;
    box-shadow: none;
    -webkit-transition: border 0.15s linear, box-shaodw 0.15s ease-in;
    transition: border 0.15s linear, box-shaodw 0.15s ease-in;
}

.input-group .input-group-addon {
    border-color: #606d7b;
    background-color: #515f6cbb;
    color: #cad1d8;
}

.select2-container--default .select2-selection--single,
.select2-selection .select2-selection--single {
    border: 1px solid #606d7b;
}

.select2-container--default .select2-selection--single {
    background-color: #515f6cbb;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #cad1d8;
}

.select2-container--default .select2-selection--multiple {
    background-color: #515f6cbb;
}

.select2-container--default .select2-selection--multiple {
    border: 1px solid #606d7b;
    border-radius: 0;
}

code {
    background-color: #515f6cbb;
    color: #c3c3c3;
    border: 1px solid rgba(0, 0, 0, 0.25);
}

.btn-default {
    background-color: hsl(210, 23%, 18%);
    color: #cad1d8;
    border-color: #606d7b;
}

.select2-results__option {
    background-color: #b5bcc1;
    color: #444;
}

.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #3c8dbc;
}

.modal-body {
    background: #3f4d5a;
}

.modal-header {
    background: #3f4d5a;
    border-bottom-color: #4d5b69;
}

.modal-footer {
    background: #3f4d5a;
    border-top-color: #4d5b69;
}

@media (max-width: 991px) {
    .content-header > .breadcrumb {
        background: #1f2933 !important;
    }
}

.select2-container--default .select2-results__option[aria-selected='true'],
.select2-container--default .select2-results__option[aria-selected='true']:hover {
    color: #fff;
}

.select2-dropdown {
    background-color: #515f6cbb;
    border: 1px solid #606d7b;
}
.select2-container--default.select2-container--focus .select2-selection--multiple,
.select2-container--default .select2-search--dropdown .select2-search__field {
    border-color: #d2d6de !important;
    background-color: #515f6cbb;
}

.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #099aa5;
}

a {
    color: #288afb;
}

a:hover {
    color: #206ec7;
}

.form-control {
    border-color: hsl(209, 20%, 25%);
    background-color: hsl(210, 23%, 18%);
    color: #cad1d8;
}

.form-control[disabled],
.form-control[readonly],
fieldset[disabled] .form-control {
    background-color: #1f2933;
    color: #cad1d8;
    cursor: not-allowed;
}

.well {
    min-height: 20px;
    padding: 19px;
    margin-bottom: 20px;
    background-color: #515f6cbb;
    border: 1px solid #606d7b;
}

.well-lg {
    padding: 24px;
}

.well-sm {
    padding: 9px;
}

.small-box h3,
.small-box p {
    color: #c3c3c3;
}

.small-box-footer {
    color: #288afb;
}

.small-box .icon {
    color: #cad1d8;
}

.bg-gray {
    background-color: #33404d !important;
}

pre {
    color: #cad1d8;
    background-color: hsl(210, 23%, 18%);
    border-color: hsl(209, 20%, 25%);
}
</file>

<file path="public/themes/pterodactyl/css/checkbox.css">
/**
 * Bootsnip - "Bootstrap Checkboxes/Radios"
 * Bootstrap 3.2.0 Snippet by i-heart-php <http://bootsnipp.com/i-heart-php>
 *
 * Copyright (c) 2013 Bootsnipp.com
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
.checkbox {
    padding-left: 20px;
}
.checkbox label {
    display: inline-block;
    position: relative;
    padding-left: 5px;
}
.checkbox label::before {
    content: '';
    display: inline-block;
    position: absolute;
    width: 17px;
    height: 17px;
    left: 0;
    top: 2.5px;
    margin-left: -20px;
    border: 1px solid #cccccc;
    border-radius: 3px;
    background-color: #fff;
    -webkit-transition: border 0.15s ease-in-out, color 0.15s ease-in-out;
    -o-transition: border 0.15s ease-in-out, color 0.15s ease-in-out;
    transition: border 0.15s ease-in-out, color 0.15s ease-in-out;
}
.checkbox label::after {
    display: inline-block;
    position: absolute;
    width: 16px;
    height: 16px;
    left: 0;
    top: 2.5px;
    margin-left: -20px;
    padding-left: 3px;
    padding-top: 1px;
    font-size: 11px;
    color: #555555;
}
.checkbox input[type='checkbox'] {
    opacity: 0;
}
.checkbox input[type='checkbox']:focus + label::before {
    outline: thin dotted;
    outline: 5px auto -webkit-focus-ring-color;
    outline-offset: -2px;
}
.checkbox input[type='checkbox']:checked + label::after {
    font-family: 'FontAwesome';
    content: '\f00c';
}
.checkbox input[type='checkbox']:disabled + label {
    opacity: 0.65;
}
.checkbox input[type='checkbox']:disabled + label::before {
    background-color: #eeeeee;
    cursor: not-allowed;
}
.checkbox.checkbox-circle label::before {
    border-radius: 50%;
}
.checkbox.checkbox-inline {
    margin-top: 0;
}
.checkbox-primary input[type='checkbox']:checked + label::before {
    background-color: #428bca;
    border-color: #428bca;
}
.checkbox-primary input[type='checkbox']:checked + label::after {
    color: #fff;
}
.checkbox-danger input[type='checkbox']:checked + label::before {
    background-color: #d9534f;
    border-color: #d9534f;
}
.checkbox-danger input[type='checkbox']:checked + label::after {
    color: #fff;
}
.checkbox-info input[type='checkbox']:checked + label::before {
    background-color: #5bc0de;
    border-color: #5bc0de;
}
.checkbox-info input[type='checkbox']:checked + label::after {
    color: #fff;
}
.checkbox-warning input[type='checkbox']:checked + label::before {
    background-color: #f0ad4e;
    border-color: #f0ad4e;
}
.checkbox-warning input[type='checkbox']:checked + label::after {
    color: #fff;
}
.checkbox-success input[type='checkbox']:checked + label::before {
    background-color: #5cb85c;
    border-color: #5cb85c;
}
.checkbox-success input[type='checkbox']:checked + label::after {
    color: #fff;
}
.radio {
    padding-left: 20px;
}
.radio label {
    display: inline-block;
    position: relative;
    padding-left: 5px;
}
.radio label::before {
    content: '';
    display: inline-block;
    position: absolute;
    width: 17px;
    height: 17px;
    left: 0;
    margin-left: -20px;
    border: 1px solid #cccccc;
    border-radius: 50%;
    background-color: #fff;
    -webkit-transition: border 0.15s ease-in-out;
    -o-transition: border 0.15s ease-in-out;
    transition: border 0.15s ease-in-out;
}
.radio label::after {
    display: inline-block;
    position: absolute;
    content: ' ';
    width: 11px;
    height: 11px;
    left: 3px;
    top: 3px;
    margin-left: -20px;
    border-radius: 50%;
    background-color: #555555;
    -webkit-transform: scale(0, 0);
    -ms-transform: scale(0, 0);
    -o-transform: scale(0, 0);
    transform: scale(0, 0);
    -webkit-transition: -webkit-transform 0.1s cubic-bezier(0.8, -0.33, 0.2, 1.33);
    -moz-transition: -moz-transform 0.1s cubic-bezier(0.8, -0.33, 0.2, 1.33);
    -o-transition: -o-transform 0.1s cubic-bezier(0.8, -0.33, 0.2, 1.33);
    transition: transform 0.1s cubic-bezier(0.8, -0.33, 0.2, 1.33);
}
.radio input[type='radio'] {
    opacity: 0;
}
.radio input[type='radio']:focus + label::before {
    outline: thin dotted;
    outline: 5px auto -webkit-focus-ring-color;
    outline-offset: -2px;
}
.radio input[type='radio']:checked + label::after {
    -webkit-transform: scale(1, 1);
    -ms-transform: scale(1, 1);
    -o-transform: scale(1, 1);
    transform: scale(1, 1);
}
.radio input[type='radio']:disabled + label {
    opacity: 0.65;
}
.radio input[type='radio']:disabled + label::before {
    cursor: not-allowed;
}
.radio.radio-inline {
    margin-top: 0;
}
.radio-primary input[type='radio'] + label::after {
    background-color: #428bca;
}
.radio-primary input[type='radio']:checked + label::before {
    border-color: #428bca;
}
.radio-primary input[type='radio']:checked + label::after {
    background-color: #428bca;
}
.radio-danger input[type='radio'] + label::after {
    background-color: #d9534f;
}
.radio-danger input[type='radio']:checked + label::before {
    border-color: #d9534f;
}
.radio-danger input[type='radio']:checked + label::after {
    background-color: #d9534f;
}
.radio-info input[type='radio'] + label::after {
    background-color: #5bc0de;
}
.radio-info input[type='radio']:checked + label::before {
    border-color: #5bc0de;
}
.radio-info input[type='radio']:checked + label::after {
    background-color: #5bc0de;
}
.radio-warning input[type='radio'] + label::after {
    background-color: #f0ad4e;
}
.radio-warning input[type='radio']:checked + label::before {
    border-color: #f0ad4e;
}
.radio-warning input[type='radio']:checked + label::after {
    background-color: #f0ad4e;
}
.radio-success input[type='radio'] + label::after {
    background-color: #5cb85c;
}
.radio-success input[type='radio']:checked + label::before {
    border-color: #5cb85c;
}
.radio-success input[type='radio']:checked + label::after {
    background-color: #5cb85c;
}
</file>

<file path="public/themes/pterodactyl/css/pterodactyl.css">
/**
 * Pterodactyl - Panel
 * Copyright (c) 2015 - 2017 Dane Everitt <dane@daneeveritt.com>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
@import 'checkbox.css';

.login-page {
    background: #10529f;
}

#login-position-elements {
    margin: 25% auto;
}

.login-logo {
    color: #fff;
    font-weight: 400;
}

.login-copyright {
    color: rgba(255, 255, 255, 0.3);
}

.login-copyright > a {
    color: rgba(255, 255, 255, 0.6);
}

.particles-js-canvas-el {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    z-index: -1;
}

.pterodactyl-login-box {
    background: rgba(0, 0, 0, 0.25);
    border-radius: 3px;
    padding: 20px;
}

.pterodactyl-login-input > input {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid #000;
    border-radius: 2px;
    color: #000000;
}

.pterodactyl-login-input > .form-control-feedback {
    color: #000000;
}

.pterodactyl-login-button--main {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid #000;
    border-radius: 2px;
    color: #fff;
}

.pterodactyl-login-button--main:hover {
    background: rgba(0, 0, 0, 0.7);
    border: 1px solid #000;
    border-radius: 2px;
    color: #fff;
}

.pterodactyl-login-button--left {
    background: rgba(255, 255, 255, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.6);
    border-radius: 2px;
    color: #fff;
}

.pterodactyl-login-button--left:hover {
    background: rgba(255, 255, 255, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.8);
    border-radius: 2px;
    color: #fff;
}

.weight-100 {
    font-weight: 100;
}

.weight-300 {
    font-weight: 300;
}

.btn-clear {
    background: transparent;
}

.user-panel > .info {
    position: relative;
    left: 0;
}

code {
    background-color: #eef1f6;
    color: #596981;
    border-radius: 2px;
    padding-left: 4px;
    padding-right: 4px;
    line-height: 1.4;
    font-size: 85%;
    border: 1px solid rgba(0, 0, 0, 0.1);
    display: inline-block;
}

p {
    line-height: 1.6 !important;
}

p.small {
    margin-top: 3px !important;
}

.control-sidebar-dark .control-sidebar-menu > li > a.active {
    background: #1e282c;
}

.callout-nomargin {
    margin: 0;
}

.table {
    font-size: 14px !important;
}

.table .min-size {
    width: 1px;
    white-space: nowrap;
}

@media (max-width: 767px) {
    .box-header > .box-tools {
        position: relative !important;
        padding: 0px 10px 10px;
    }
}

.middle,
.align-middle {
    vertical-align: middle !important;
}

#fileOptionMenu.dropdown-menu > li > a {
    padding: 3px 6px;
}

.hasFileHover {
    border: 2px dashed #0087f7;
    border-top: 0 !important;
    border-radius: 5px;
    margin: 0;
    opacity: 0.5;
}

.hasFileHover * {
    pointer-events: none !important;
}

td.has-progress {
    padding: 0px !important;
    border-top: 0px !important;
}

.progress.progress-table-bottom {
    margin: 0 !important;
    height: 5px !important;
    padding: 0;
    border: 0;
}

.muted {
    filter: alpha(opacity=20);
    opacity: 0.2;
}

.muted-hover:hover {
    filter: alpha(opacity=100);
    opacity: 1;
}

.use-pointer {
    cursor: pointer !important;
}

.input-loader {
    display: none;
    position: relative;
    top: -25px;
    float: right;
    right: 5px;
    color: #cccccc;
    height: 0;
}

.box-header > .form-group {
    margin-bottom: 0;
}

.box-header > .form-group > div > p.small {
    margin: 0;
}

.no-margin {
    margin: 0 !important;
}

li.select2-results__option--highlighted[aria-selected='false'] > .user-block > .username > a {
    color: #fff;
}

li.select2-results__option--highlighted[aria-selected='false'] > .user-block > .description {
    color: #eee;
}

.select2-selection.select2-selection--multiple {
    min-height: 36px !important;
}

.select2-search--inline .select2-search__field:focus {
    outline: none;
    border: 0 !important;
}

.img-bordered-xs {
    border: 1px solid #d2d6de;
    padding: 1px;
}

span[aria-labelledby='select2-pUserId-container'] {
    padding-left: 2px !important;
}

.box {
    box-shadow: 0 0 0 1px rgba(89, 105, 128, 0.1), 0 1px 3px 0 rgba(89, 105, 128, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important;
}

.alert-danger {
    color: #ffffff !important;
    background: #d64242 !important;
    border: 1px solid #841d1d;
}

.alert-info {
    color: #ffffff !important;
    background: #408fec !important;
    border: 1px solid #1055a5;
}

.alert-success {
    color: #ffffff !important;
    background: #51b060 !important;
    border: 1px solid #2b5f33;
}

.alert-warning {
    color: #ffffff !important;
    background: #fa9636 !important;
    border: 1px solid #b45b05;
}

.callout-slim a {
    color: #555 !important;
}

.bg-purple {
    background-color: #79589f !important;
}

.label-default {
    background-color: #eef1f6 !important;
}

.callout.callout-info.callout-slim {
    border: 1px solid #1055a5 !important;
    border-left: 5px solid #1055a5 !important;
    border-right: 5px solid #1055a5 !important;
    color: #777 !important;
    background: transparent !important;
}

.callout.callout-danger.callout-slim {
    border: 1px solid #c23321 !important;
    border-left: 5px solid #c23321 !important;
    border-right: 5px solid #c23321 !important;
    color: #777 !important;
    background: transparent !important;
}

.callout.callout-warning.callout-slim {
    border: 1px solid #c87f0a !important;
    border-left: 5px solid #c87f0a !important;
    border-right: 5px solid #c87f0a !important;
    color: #777 !important;
    background: transparent !important;
}

.callout.callout-success.callout-slim {
    border: 1px solid #00733e !important;
    border-left: 5px solid #00733e !important;
    border-right: 5px solid #00733e !important;
    color: #777 !important;
    background: transparent !important;
}

.callout.callout-default.callout-slim {
    border: 1px solid #eee !important;
    border-left: 5px solid #eee !important;
    border-right: 5px solid #eee !important;
    color: #777 !important;
    background: transparent !important;
}

.callout code {
    background-color: #515f6cbb;
    color: #c3c3c3;
    border: 1px solid rgba(0, 0, 0, 0.25);
}

.tab-pane .box-footer {
    margin: 0 -10px -10px;
}

.select2-container {
    width: 100% !important;
}

.nav-tabs-custom > .nav-tabs > li:hover {
    border-top-color: #3c8dbc;
}

.nav-tabs-custom > .nav-tabs > li.active.tab-danger,
.nav-tabs-custom > .nav-tabs > li.tab-danger:hover {
    border-top-color: #c23321;
}

.nav-tabs-custom > .nav-tabs > li.active.tab-success,
.nav-tabs-custom > .nav-tabs > li.tab-success:hover {
    border-top-color: #00733e;
}

.nav-tabs-custom > .nav-tabs > li.active.tab-info,
.nav-tabs-custom > .nav-tabs > li.tab-info:hover {
    border-top-color: #0097bc;
}

.nav-tabs-custom > .nav-tabs > li.active.tab-warning,
.nav-tabs-custom > .nav-tabs > li.tab-warning:hover {
    border-top-color: #c87f0a;
}

.nav-tabs-custom.nav-tabs-floating > .nav-tabs {
    border-bottom: 0px !important;
}

.nav-tabs-custom.nav-tabs-floating > .nav-tabs > li {
    margin-bottom: 0px !important;
}

.nav-tabs-custom.nav-tabs-floating > .nav-tabs > li:first-child.active,
.nav-tabs-custom.nav-tabs-floating > .nav-tabs > li:first-child:hover {
    border-radius: 3px 0 0 0;
}

.nav-tabs-custom.nav-tabs-floating > .nav-tabs > li:first-child.active > a {
    border-radius: 0 0 0 3px;
}

.position-relative {
    position: relative;
}

.no-pad-bottom {
    padding-bottom: 0 !important;
}

.no-margin-bottom {
    margin-bottom: 0 !important;
}

.btn-icon > i.fa {
    line-height: 1.5;
}

.btn.active,
.btn.active.focus {
    background-color: #408fec;
}

.strong {
    font-weight: bold !important;
}

.server-description > td {
    padding-top: 0 !important;
    border-top: 0 !important;
}

tr:hover + tr.server-description {
    background-color: #f5f5f5 !important;
}

.login-corner-info {
    position: absolute;
    bottom: 5px;
    right: 10px;
    color: white;
}

input.form-autocomplete-stop[readonly] {
    background: inherit;
    cursor: text;
}

/* fix Google Recaptcha badge */
.grecaptcha-badge {
    bottom: 54px !important;
    background: white;
    box-shadow: none !important;
}

.dropdown-massactions {
    min-width: 80px;
}

.select-all-files {
    position: relative;
    bottom: 1px;
    margin-right: 7px !important;
}

.select-file {
    position: relative;
    bottom: 1px;
    margin-right: 2px !important;
}

.select-folder {
    position: relative;
    bottom: 1px;
    margin-right: 5px !important;
}

label.control-label > span {
    font-size: 80%;
    font-weight: 400;
    font-style: italic;
    color: #dd4b39;
}

label.control-label > span.field-required:before {
    content: 'required';
    color: #dd4b39;
}

label.control-label > span.field-optional:before {
    content: 'optional';
    color: #bbbbbb;
}

.pagination > li > a,
.pagination > li > span {
    padding: 3px 10px !important;
}

.logo-mini > img {
    height: 42px;
    width: auto;
}

.search01 {
    width: 30%;
}

.number-info-box-content {
    padding: 15px 10px 0;
}

/* *******

  > Version v1.0

******* */

body {
    color: #cad1d8;
}

.fixed .main-header {
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.12), 0 2px 4px 0 rgba(0, 0, 0, 0.08);
}

.skin-blue .wrapper,
.skin-blue .main-sidebar,
.skin-blue .left-side {
    background-color: #181f27;
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.12), 0 2px 4px 0 rgba(0, 0, 0, 0.08);
}

.skin-blue .main-header .logo {
    background-color: #1f2933;
    color: #9aa5b1;
}

.skin-blue .main-header .navbar .sidebar-toggle {
    color: #9aa5b1;
}

.skin-blue .main-header .navbar .nav > li > a {
    color: #9aa5b1;
}

.skin-blue .sidebar-menu > li.header {
    color: #797979;
    background: #0e111582;
}

.skin-blue .main-header .navbar {
    background-color: #1f2933;
}

.skin-blue .main-header .navbar .sidebar-toggle:hover {
    background-color: #1c252e;
}

.skin-blue .main-header .logo:hover {
    background-color: #1c252e;
}

.main-footer {
    background: #1f2933;
    color: #9aa5b1;
    border-top: 1px solid #1f2933;
}

.skin-blue .sidebar-menu > li.active > a {
    border-left-color: #099aa5;
}

.text-gray {
    color: #9aa5b1 !important;
}

.text-green {
    color: #00a65a !important;
}

.text-muted {
    color: #9aa5b1 !important;
}

.text-danger {
    color: #ff1c00;
}

.content-wrapper {
    background-color: #33404d;
}

.btn-success {
    background-color: #189a1c;
    border-color: #0f8513;
}

.btn.btn-green:hover {
    background-color: #0f8513;
    border-color: #0e7717;
}

.btn-primary {
    background-color: #0967d3;
    border-color: #0550b3;
}

.btn.btn-primary:hover {
    background-color: #0550b3;
    border-color: #0345a0;
}

.box {
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.12), 0 2px 4px 0 rgba(0, 0, 0, 0.08) !important;
    background: #3f4d5a;
    border-top: 3px solid #1f2933;
}

.box-header {
    color: #cad1d8;
    background: #1f2933;
}

.box-header.with-border {
    border-bottom: 1px solid #1f2933;
}

.box.box-default {
    border-top-color: #1f2933;
}

.box-footer {
    border-top: 1px solid #4d5b69;
    background-color: #3f4d5a;
}
.content-header > .breadcrumb > li > a {
    color: #cad1d8;
}

.breadcrumb > .active {
    color: #cad1d8;
}

.h1 .small,
.h1 small,
.h2 .small,
.h2 small,
.h3 .small,
.h3 small,
.h4 .small,
.h4 small,
.h5 .small,
.h5 small,
.h6 .small,
.h6 small,
h1 .small,
h1 small,
h2 .small,
h2 small,
h3 .small,
h3 small,
h4 .small,
h4 small,
h5 .small,
h5 small,
h6 .small,
h6 small {
    color: #cad1d8;
}

.table > thead > tr > th,
.table > tbody > tr > th,
.table > tfoot > tr > th,
.table > thead > tr > td,
.table > tbody > tr > td,
.table > tfoot > tr > td {
    border-top: 1px solid #4d5b69;
}

.table > thead > tr > th {
    border-bottom: 2px solid #4d5b69;
}

.table-hover > tbody > tr:hover {
    background-color: #33404d;
}

a {
    color: #007eff;
}

.nav-tabs-custom {
    background: #1f2933;
}

.nav-tabs-custom > .nav-tabs > li.active {
    border-top-color: #099aa5;
}

.nav-tabs-custom > .nav-tabs > li.active > a {
    border-top-color: transparent;
    border-left-color: #15161c;
    border-right-color: #15161c;
    background: #13181e;
}

.nav-tabs-custom > .nav-tabs > li > a {
    color: #9aa5b1;
}

.nav-tabs-custom > .nav-tabs > li.active > a,
.nav-tabs-custom > .nav-tabs > li.active:hover > a {
    color: #9aa5b1;
}

input.form-control {
    padding: 0.75rem;
    background-color: #515f6cbb;
    border-width: 1px;
    border-color: #606d7b;
    border-radius: 0.25rem;
    color: #cad1d8;
    box-shadow: none;
    -webkit-transition: border 0.15s linear, box-shaodw 0.15s ease-in;
    transition: border 0.15s linear, box-shaodw 0.15s ease-in;
}

textarea.form-control {
    padding: 0.75rem;
    background-color: #515f6cbb;
    border-width: 1px;
    border-color: #606d7b;
    border-radius: 0.25rem;
    color: #cad1d8;
    box-shadow: none;
    -webkit-transition: border 0.15s linear, box-shaodw 0.15s ease-in;
    transition: border 0.15s linear, box-shaodw 0.15s ease-in;
}

.input-group .input-group-addon {
    border-color: #606d7b;
    background-color: #515f6cbb;
    color: #cad1d8;
}

.select2-container--default .select2-selection--single,
.select2-selection .select2-selection--single {
    border: 1px solid #606d7b;
}

.select2-container--default .select2-selection--single {
    background-color: #515f6cbb;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #cad1d8;
}

.select2-container--default .select2-selection--multiple {
    background-color: #515f6cbb;
}

.select2-container--default .select2-selection--multiple {
    border: 1px solid #606d7b;
    border-radius: 0;
}

code {
    background-color: #515f6cbb;
    color: #c3c3c3;
    border: 1px solid rgba(0, 0, 0, 0.25);
}

.btn-default {
    background-color: #33404d;
    color: #cad1d8;
    border-color: #606d7b;
}

.select2-results__option {
    background-color: #b5bcc1;
    color: #444;
}

.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #3c8dbc;
}

.modal-body {
    background: #3f4d5a;
}

.modal-header {
    background: #3f4d5a;
    border-bottom-color: #4d5b69;
}

.modal-footer {
    background: #3f4d5a;
    border-top-color: #4d5b69;
}

@media (max-width: 991px) {
    .content-header > .breadcrumb {
        background: #1f2933 !important;
    }
}

.nav-tabs-custom > .nav-tabs > li.active > a,
.nav-tabs-custom > .nav-tabs > li.active:hover > a {
    background-color: #101216;
}

.select2-container--default .select2-results__option[aria-selected='true'],
.select2-container--default .select2-results__option[aria-selected='true']:hover {
    color: #fff;
}

.select2-dropdown {
    background-color: #515f6cbb;
    border: 1px solid #606d7b;
}
.select2-container--default.select2-container--focus .select2-selection--multiple,
.select2-container--default .select2-search--dropdown .select2-search__field {
    border-color: #d2d6de !important;
    background-color: #515f6cbb;
}

.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #099aa5;
}

a {
    color: #288afb;
}

a:hover {
    color: #206ec7;
}

.form-control {
    border-color: #606d7b;
    background-color: #515f6cbb;
    color: #cad1d8;
}

.form-control[disabled],
.form-control[readonly],
fieldset[disabled] .form-control {
    background-color: #1f2933;
    color: #cad1d8;
    cursor: not-allowed;
}

.well {
    min-height: 20px;
    padding: 19px;
    margin-bottom: 20px;
    background-color: #515f6cbb;
    border: 1px solid #606d7b;
}

.well-lg {
    padding: 24px;
}

.well-sm {
    padding: 9px;
}

.small-box h3,
.small-box p {
    color: #c3c3c3;
}

.small-box-footer {
    color: #288afb;
}

.small-box .icon {
    color: #cad1d8;
}

.bg-gray {
    background-color: #33404d !important;
}

pre {
    color: #cad1d8;
    background-color: #515f6cbb;
    border-color: #1f2933;
}
</file>

<file path="public/themes/pterodactyl/css/terminal.css">
/*Design for Terminal*/
@import url('https://fonts.googleapis.com/css?family=Source+Code+Pro');

#terminal-body {
    background: rgb(26, 26, 26, 0.01);
    margin: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
}

#terminal {
    font-family: 'Source Code Pro', monospace;
    color: rgb(223, 223, 223);
    background: rgb(26, 26, 26);
    font-size: 12px;
    line-height: 14px;
    padding: 10px 10px 0;
    box-sizing: border-box;
    height: 500px;
    max-height: 500px;
    overflow-y: auto;
    overflow-x: hidden;
    border-radius: 5px 5px 0 0;
}

#terminal > .cmd {
    padding: 1px 0;
    word-wrap: break-word;
    white-space: pre-wrap;
}

#terminal_input {
    width: 100%;
    background: rgb(26, 26, 26);
    border-radius: 0 0 5px 5px;
    padding: 0 0 0 10px !important;
}

.terminal_input--input,
.terminal_input--prompt {
    font-family: 'Source Code Pro', monospace;
    margin-bottom: 0;
    border: 0 !important;
    background: transparent !important;
    color: rgb(223, 223, 223);
    font-size: 12px;
    padding: 1px 0 4px !important;
}
.terminal_input--input {
    margin-left: 6px;
    line-height: 1;
    outline: none !important;
}

.terminal-notify {
    position: absolute;
    right: 30px;
    bottom: 30px;
    padding: 3.5px 7px;
    border-radius: 3px;
    background: #fff;
    color: #000;
    opacity: 0.5;
    font-size: 16px;
    cursor: pointer;
    z-index: 10;
}

.terminal-notify:hover {
    opacity: 0.9;
}

.ansi-black-fg {
    color: rgb(0, 0, 0);
}
.ansi-red-fg {
    color: rgb(166, 0, 44);
}
.ansi-green-fg {
    color: rgb(55, 106, 27);
}
.ansi-yellow-fg {
    color: rgb(241, 133, 24);
}
.ansi-blue-fg {
    color: rgb(17, 56, 163);
}
.ansi-magenta-fg {
    color: rgb(67, 0, 117);
}
.ansi-cyan-fg {
    color: rgb(18, 95, 105);
}
.ansi-white-fg {
    color: rgb(255, 255, 255);
}
.ansi-bright-black-fg {
    color: rgb(51, 51, 51);
}
.ansi-bright-red-fg {
    color: rgb(223, 45, 39);
}
.ansi-bright-green-fg {
    color: rgb(105, 175, 45);
}
.ansi-bright-yellow-fg {
    color: rgb(254, 232, 57);
}
.ansi-bright-blue-fg {
    color: rgb(68, 145, 240);
}
.ansi-bright-magenta-fg {
    color: rgb(151, 50, 174);
}
.ansi-bright-cyan-fg {
    color: rgb(37, 173, 98);
}
.ansi-bright-white-fg {
    color: rgb(208, 208, 208);
}

.ansi-black-bg {
    background: rgb(0, 0, 0);
}
.ansi-red-bg {
    background: rgb(166, 0, 44);
}
.ansi-green-bg {
    background: rgb(55, 106, 27);
}
.ansi-yellow-bg {
    background: rgb(241, 133, 24);
}
.ansi-blue-bg {
    background: rgb(17, 56, 163);
}
.ansi-magenta-bg {
    background: rgb(67, 0, 117);
}
.ansi-cyan-bg {
    background: rgb(18, 95, 105);
}
.ansi-white-bg {
    background: rgb(255, 255, 255);
}
.ansi-bright-black-bg {
    background: rgb(51, 51, 51);
}
.ansi-bright-red-bg {
    background: rgb(223, 45, 39);
}
.ansi-bright-green-bg {
    background: rgb(105, 175, 45);
}
.ansi-bright-yellow-bg {
    background: rgb(254, 232, 57);
}
.ansi-bright-blue-bg {
    background: rgb(68, 145, 240);
}
.ansi-bright-magenta-bg {
    background: rgb(151, 50, 174);
}
.ansi-bright-cyan-bg {
    background: rgb(37, 173, 98);
}
.ansi-bright-white-bg {
    background: rgb(208, 208, 208);
}
</file>

<file path="public/themes/pterodactyl/js/admin/server/transfer.js">
$(document).ready(function () {
    $('#pNodeId')
        .select2({
            placeholder: 'Select a Node',
        })
        .change();

    $('#pAllocation').select2({
        placeholder: 'Select a Default Allocation',
    });

    $('#pAllocationAdditional').select2({
        placeholder: 'Select Additional Allocations',
    });
});

$('#pNodeId').on('change', function () {
    let currentNode = $(this).val();

    $.each(Pterodactyl.nodeData, function (i, v) {
        if (v.id == currentNode) {
            $('#pAllocation').html('').select2({
                data: v.allocations,
                placeholder: 'Select a Default Allocation',
            });

            updateAdditionalAllocations();
        }
    });
});

$('#pAllocation').on('change', function () {
    updateAdditionalAllocations();
});

function updateAdditionalAllocations() {
    let currentAllocation = $('#pAllocation').val();
    let currentNode = $('#pNodeId').val();

    $.each(Pterodactyl.nodeData, function (i, v) {
        if (v.id == currentNode) {
            let allocations = [];

            for (let i = 0; i < v.allocations.length; i++) {
                const allocation = v.allocations[i];

                if (allocation.id != currentAllocation) {
                    allocations.push(allocation);
                }
            }

            $('#pAllocationAdditional').html('').select2({
                data: allocations,
                placeholder: 'Select Additional Allocations',
            });
        }
    });
}
</file>

<file path="public/themes/pterodactyl/js/admin/functions.js">
// Copyright (c) 2015 - 2017 Dane Everitt <dane@daneeveritt.com>
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.
$.urlParam = function (name) {
    var results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(decodeURIComponent(window.location.href));
    if (results == null) {
        return null;
    } else {
        return results[1] || 0;
    }
};
function getPageName(url) {
    var index = url.lastIndexOf('/') + 1;
    var filenameWithExtension = url.substr(index);
    var filename = filenameWithExtension.split('.')[0];
    return filename;
}
// Remeber Active Tab and Navigate to it on Reload
for (
    var queryParameters = {}, queryString = location.search.substring(1), re = /([^&=]+)=([^&]*)/g, m;
    (m = re.exec(queryString));

)
    queryParameters[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
$("a[data-toggle='tab']").click(function () {
    (queryParameters.tab = $(this).attr('href').substring(1)),
        window.history.pushState(null, null, location.pathname + '?' + $.param(queryParameters));
});
if ($.urlParam('tab') != null) {
    $('.nav.nav-tabs a[href="#' + $.urlParam('tab') + '"]').tab('show');
}
</file>

<file path="public/themes/pterodactyl/js/admin/new-server.js">
// Copyright (c) 2015 - 2017 Dane Everitt <dane@daneeveritt.com>
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.
$(document).ready(function () {
    $('#pNestId')
        .select2({
            placeholder: 'Select a Nest',
        })
        .change();

    $('#pEggId').select2({
        placeholder: 'Select a Nest Egg',
    });

    $('#pPackId').select2({
        placeholder: 'Select a Service Pack',
    });

    $('#pNodeId')
        .select2({
            placeholder: 'Select a Node',
        })
        .change();

    $('#pAllocation').select2({
        placeholder: 'Select a Default Allocation',
    });

    $('#pAllocationAdditional').select2({
        placeholder: 'Select Additional Allocations',
    });
});

let lastActiveBox = null;
$(document).on('click', function (event) {
    if (lastActiveBox !== null) {
        lastActiveBox.removeClass('box-primary');
    }

    lastActiveBox = $(event.target).closest('.box');
    lastActiveBox.addClass('box-primary');
});

$('#pNodeId').on('change', function () {
    currentNode = $(this).val();
    $.each(Pterodactyl.nodeData, function (i, v) {
        if (v.id == currentNode) {
            $('#pAllocation').html('').select2({
                data: v.allocations,
                placeholder: 'Select a Default Allocation',
            });

            updateAdditionalAllocations();
        }
    });
});

$('#pNestId').on('change', function (event) {
    $('#pEggId')
        .html('')
        .select2({
            data: $.map(_.get(Pterodactyl.nests, $(this).val() + '.eggs', []), function (item) {
                return {
                    id: item.id,
                    text: item.name,
                };
            }),
        })
        .change();
});

$('#pEggId').on('change', function (event) {
    let parentChain = _.get(Pterodactyl.nests, $('#pNestId').val(), null);
    let objectChain = _.get(parentChain, 'eggs.' + $(this).val(), null);

    const images = _.get(objectChain, 'docker_images', {});
    $('#pDefaultContainer').html('');
    const keys = Object.keys(images);
    for (let i = 0; i < keys.length; i++) {
        let opt = document.createElement('option');
        opt.value = images[keys[i]];
        opt.innerText = keys[i] + ' (' + images[keys[i]] + ')';
        $('#pDefaultContainer').append(opt);
    }

    if (!_.get(objectChain, 'startup', false)) {
        $('#pStartup').val(_.get(parentChain, 'startup', 'ERROR: Startup Not Defined!'));
    } else {
        $('#pStartup').val(_.get(objectChain, 'startup'));
    }

    $('#pPackId')
        .html('')
        .select2({
            data: [{ id: 0, text: 'No Service Pack' }].concat(
                $.map(_.get(objectChain, 'packs', []), function (item, i) {
                    return {
                        id: item.id,
                        text: item.name + ' (' + item.version + ')',
                    };
                })
            ),
        });

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    const variableIds = {};
    $('#appendVariablesTo').html('');
    $.each(_.get(objectChain, 'variables', []), function (i, item) {
        variableIds[item.env_variable] = 'var_ref_' + item.id;

        let isRequired = item.required === 1 ? '<span class="label label-danger">Required</span> ' : '';
        let dataAppend =
            ' \
            <div class="form-group col-sm-6"> \
                <label for="var_ref_' +
            escapeHtml(item.id) +
            '" class="control-label">' +
            isRequired +
            escapeHtml(item.name) +
            '</label> \
                <input type="text" id="var_ref_' +
            escapeHtml(item.id) +
            '" autocomplete="off" name="environment[' +
            escapeHtml(item.env_variable) +
            ']" class="form-control" value="' +
            escapeHtml(item.default_value) +
            '" /> \
                <p class="text-muted small">' +
            escapeHtml(item.description) +
            '<br /> \
                <strong>Access in Startup:</strong> <code>{{' +
            escapeHtml(item.env_variable) +
            '}}</code><br /> \
                <strong>Validation Rules:</strong> <code>' +
            escapeHtml(item.rules) +
            '</code></small></p> \
            </div> \
        ';
        $('#appendVariablesTo').append(dataAppend);
    });

    // If you receive a warning on this line, it should be fine to ignore. this function is
    // defined in "resources/views/admin/servers/new.blade.php" near the bottom of the file.
    serviceVariablesUpdated($('#pEggId').val(), variableIds);
});

$('#pAllocation').on('change', function () {
    updateAdditionalAllocations();
});

function updateAdditionalAllocations() {
    let currentAllocation = $('#pAllocation').val();
    let currentNode = $('#pNodeId').val();

    $.each(Pterodactyl.nodeData, function (i, v) {
        if (v.id == currentNode) {
            let allocations = [];

            for (let i = 0; i < v.allocations.length; i++) {
                const allocation = v.allocations[i];

                if (allocation.id != currentAllocation) {
                    allocations.push(allocation);
                }
            }

            $('#pAllocationAdditional').html('').select2({
                data: allocations,
                placeholder: 'Select Additional Allocations',
            });
        }
    });
}

function initUserIdSelect(data) {
    function escapeHtml(str) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    $('#pUserId').select2({
        ajax: {
            url: '/admin/users/accounts.json',
            dataType: 'json',
            delay: 250,

            data: function (params) {
                return {
                    filter: { email: params.term },
                    page: params.page,
                };
            },

            processResults: function (data, params) {
                return { results: data };
            },

            cache: true,
        },

        data: data,
        escapeMarkup: function (markup) {
            return markup;
        },
        minimumInputLength: 2,
        templateResult: function (data) {
            if (data.loading) return escapeHtml(data.text);

            return (
                '<div class="user-block"> \
                <img class="img-circle img-bordered-xs" src="https://www.gravatar.com/avatar/' +
                escapeHtml(data.md5) +
                '?s=120" alt="User Image"> \
                <span class="username"> \
                    <a href="#">' +
                escapeHtml(data.name_first) +
                ' ' +
                escapeHtml(data.name_last) +
                '</a> \
                </span> \
                <span class="description"><strong>' +
                escapeHtml(data.email) +
                '</strong> - ' +
                escapeHtml(data.username) +
                '</span> \
            </div>'
            );
        },
        templateSelection: function (data) {
            return (
                '<div> \
                <span> \
                    <img class="img-rounded img-bordered-xs" src="https://www.gravatar.com/avatar/' +
                escapeHtml(data.md5) +
                '?s=120" style="height:28px;margin-top:-4px;" alt="User Image"> \
                </span> \
                <span style="padding-left:5px;"> \
                    ' +
                escapeHtml(data.name_first) +
                ' ' +
                escapeHtml(data.name_last) +
                ' (<strong>' +
                escapeHtml(data.email) +
                '</strong>) \
                </span> \
            </div>'
            );
        },
    });
}
</file>

<file path="public/themes/pterodactyl/js/plugins/minecraft/eula.js">
// Copyright (c) 2015 - 2017 Dane Everitt <dane@daneeveritt.com>
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.
$(document).ready(function () {
    Socket.on('console', function (data) {
        if (typeof data === 'undefined' || typeof data.line === 'undefined') {
            return;
        }

        if (~data.line.indexOf('You need to agree to the EULA in order to run the server')) {
            swal(
                {
                    title: 'EULA Acceptance',
                    text: 'By pressing \'I Accept\' below you are indicating your agreement to the <a href="https://account.mojang.com/documents/minecraft_eula" target="_blank">Mojang EULA</a>.',
                    type: 'info',
                    html: true,
                    showCancelButton: true,
                    showConfirmButton: true,
                    cancelButtonText: 'I do not Accept',
                    confirmButtonText: 'I Accept',
                    closeOnConfirm: false,
                    showLoaderOnConfirm: true,
                },
                function () {
                    $.ajax({
                        type: 'POST',
                        url: Pterodactyl.meta.saveFile,
                        headers: { 'X-CSRF-Token': Pterodactyl.meta.csrfToken },
                        data: {
                            file: 'eula.txt',
                            contents: 'eula=true',
                        },
                    })
                        .done(function (data) {
                            $('[data-attr="power"][data-action="start"]').trigger('click');
                            swal({
                                type: 'success',
                                title: '',
                                text: 'The EULA for this server has been accepted, restarting server now.',
                            });
                        })
                        .fail(function (jqXHR) {
                            console.error(jqXHR);
                            swal({
                                title: 'Whoops!',
                                text:
                                    'An error occurred while attempting to set the EULA as accepted: ' +
                                    jqXHR.responseJSON.error,
                                type: 'error',
                            });
                        });
                }
            );
        }
    });
});
</file>

<file path="public/.gitignore">
assets
assets/*
!assets/svgs
!assets/svgs/*.svg
</file>

<file path="public/.htaccess">
<IfModule mod_rewrite.c>
    <IfModule mod_negotiation.c>
        Options -MultiViews -Indexes
    </IfModule>

    RewriteEngine On

    # Handle Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Redirect Trailing Slashes If Not A Folder...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

    # Handle Front Controller...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]
</IfModule>
</file>

<file path="public/index.php">
<?php

/**
 * Laravel - A PHP Framework For Web Artisans.
 *
 * @author   Taylor Otwell <taylor@laravel.com>
 */
define('LARAVEL_START', microtime(true));

/*
|--------------------------------------------------------------------------
| Check If Application Is Under Maintenance
|--------------------------------------------------------------------------
|
| If the application is maintenance / demo mode via the "down" command we
| will require this file so that any pre-rendered template can be shown
| instead of starting the framework, which could cause an exception.
|
*/

if (file_exists(__DIR__ . '/../storage/framework/maintenance.php')) {
    require __DIR__ . '/../storage/framework/maintenance.php';
}

/*
|--------------------------------------------------------------------------
| Register The Auto Loader
|--------------------------------------------------------------------------
|
| Composer provides a convenient, automatically generated class loader for
| our application. We just need to utilize it! We'll simply require it
| into the script here so that we don't have to worry about manual
| loading any of our classes later on. It feels great to relax.
|
*/

require __DIR__ . '/../vendor/autoload.php';

/*
|--------------------------------------------------------------------------
| Turn On The Lights
|--------------------------------------------------------------------------
|
| We need to illuminate PHP development, so let us turn on the lights.
| This bootstraps the framework and gets it ready for use, then it
| will load up this application so that we can run it and send
| the responses back to the browser and delight our users.
|
*/

$app = require_once __DIR__ . '/../bootstrap/app.php';

/*
|--------------------------------------------------------------------------
| Run The Application
|--------------------------------------------------------------------------
|
| Once we have the application, we can handle the incoming request
| through the kernel, and send the associated response back to
| the client's browser allowing them to enjoy the creative
| and wonderful application we have prepared for them.
|
*/

$kernel = $app->make(Illuminate\Contracts\Http\Kernel::class);

$response = $kernel->handle(
    $request = Illuminate\Http\Request::capture()
);

$response->send();

$kernel->terminate($request, $response);
</file>

<file path="public/robots.txt">
User-agent: *
Disallow: /
</file>

<file path="resources/lang/en/admin/nests.php">
<?php

return [
    'notices' => [
        'created' => 'A new nest, :name, has been successfully created.',
        'deleted' => 'Successfully deleted the requested nest from the Panel.',
        'updated' => 'Successfully updated the nest configuration options.',
    ],
    'eggs' => [
        'notices' => [
            'imported' => 'Successfully imported this Egg and its associated variables.',
            'updated_via_import' => 'This Egg has been updated using the file provided.',
            'deleted' => 'Successfully deleted the requested egg from the Panel.',
            'updated' => 'Egg configuration has been updated successfully.',
            'script_updated' => 'Egg install script has been updated and will run whenever servers are installed.',
            'egg_created' => 'A new egg was laid successfully. You will need to restart any running daemons to apply this new egg.',
        ],
    ],
    'variables' => [
        'notices' => [
            'variable_deleted' => 'The variable ":variable" has been deleted and will no longer be available to servers once rebuilt.',
            'variable_updated' => 'The variable ":variable" has been updated. You will need to rebuild any servers using this variable in order to apply changes.',
            'variable_created' => 'New variable has successfully been created and assigned to this egg.',
        ],
    ],
];
</file>

<file path="resources/lang/en/admin/node.php">
<?php

return [
    'validation' => [
        'fqdn_not_resolvable' => 'The FQDN or IP address provided does not resolve to a valid IP address.',
        'fqdn_required_for_ssl' => 'A fully qualified domain name that resolves to a public IP address is required in order to use SSL for this node.',
    ],
    'notices' => [
        'allocations_added' => 'Allocations have successfully been added to this node.',
        'node_deleted' => 'Node has been successfully removed from the panel.',
        'location_required' => 'You must have at least one location configured before you can add a node to this panel.',
        'node_created' => 'Successfully created new node. You can automatically configure the daemon on this machine by visiting the \'Configuration\' tab. <strong>Before you can add any servers you must first allocate at least one IP address and port.</strong>',
        'node_updated' => 'Node information has been updated. If any daemon settings were changed you will need to reboot it for those changes to take effect.',
        'unallocated_deleted' => 'Deleted all un-allocated ports for <code>:ip</code>.',
    ],
];
</file>

<file path="resources/lang/en/admin/server.php">
<?php

return [
    'exceptions' => [
        'no_new_default_allocation' => 'You are attempting to delete the default allocation for this server but there is no fallback allocation to use.',
        'marked_as_failed' => 'This server was marked as having failed a previous installation. Current status cannot be toggled in this state.',
        'bad_variable' => 'There was a validation error with the :name variable.',
        'daemon_exception' => 'There was an exception while attempting to communicate with the daemon resulting in a HTTP/:code response code. This exception has been logged. (request id: :request_id)',
        'default_allocation_not_found' => 'The requested default allocation was not found in this server\'s allocations.',
    ],
    'alerts' => [
        'startup_changed' => 'The startup configuration for this server has been updated. If this server\'s nest or egg was changed a reinstall will be occurring now.',
        'server_deleted' => 'Server has successfully been deleted from the system.',
        'server_created' => 'Server was successfully created on the panel. Please allow the daemon a few minutes to completely install this server.',
        'build_updated' => 'The build details for this server have been updated. Some changes may require a restart to take effect.',
        'suspension_toggled' => 'Server suspension status has been changed to :status.',
        'rebuild_on_boot' => 'This server has been marked as requiring a Docker Container rebuild. This will happen the next time the server is started.',
        'install_toggled' => 'The installation status for this server has been toggled.',
        'server_reinstalled' => 'This server has been queued for a reinstallation beginning now.',
        'details_updated' => 'Server details have been successfully updated.',
        'docker_image_updated' => 'Successfully changed the default Docker image to use for this server. A reboot is required to apply this change.',
        'node_required' => 'You must have at least one node configured before you can add a server to this panel.',
        'transfer_nodes_required' => 'You must have at least two nodes configured before you can transfer servers.',
        'transfer_started' => 'Server transfer has been started.',
        'transfer_not_viable' => 'The node you selected does not have the required disk space or memory available to accommodate this server.',
    ],
];
</file>

<file path="resources/lang/en/admin/user.php">
<?php

return [
    'exceptions' => [
        'user_has_servers' => 'Cannot delete a user with active servers attached to their account. Please delete their servers before continuing.',
    ],
    'notices' => [
        'account_created' => 'Account has been created successfully.',
        'account_updated' => 'Account has been successfully updated.',
    ],
];
</file>

<file path="resources/lang/en/command/messages.php">
<?php

return [
    'location' => [
        'no_location_found' => 'Could not locate a record matching the provided short code.',
        'ask_short' => 'Location Short Code',
        'ask_long' => 'Location Description',
        'created' => 'Successfully created a new location (:name) with an ID of :id.',
        'deleted' => 'Successfully deleted the requested location.',
    ],
    'user' => [
        'search_users' => 'Enter a Username, User ID, or Email Address',
        'select_search_user' => 'ID of user to delete (Enter \'0\' to re-search)',
        'deleted' => 'User successfully deleted from the Panel.',
        'confirm_delete' => 'Are you sure you want to delete this user from the Panel?',
        'no_users_found' => 'No users were found for the search term provided.',
        'multiple_found' => 'Multiple accounts were found for the user provided, unable to delete a user because of the --no-interaction flag.',
        'ask_admin' => 'Is this user an administrator?',
        'ask_email' => 'Email Address',
        'ask_username' => 'Username',
        'ask_name_first' => 'First Name',
        'ask_name_last' => 'Last Name',
        'ask_password' => 'Password',
        'ask_password_tip' => 'If you would like to create an account with a random password emailed to the user, re-run this command (CTRL+C) and pass the `--no-password` flag.',
        'ask_password_help' => 'Passwords must be at least 8 characters in length and contain at least one capital letter and number.',
        '2fa_help_text' => [
            'This command will disable 2-factor authentication for a user\'s account if it is enabled. This should only be used as an account recovery command if the user is locked out of their account.',
            'If this is not what you wanted to do, press CTRL+C to exit this process.',
        ],
        '2fa_disabled' => '2-Factor authentication has been disabled for :email.',
    ],
    'schedule' => [
        'output_line' => 'Dispatching job for first task in `:schedule` (:hash).',
    ],
    'maintenance' => [
        'deleting_service_backup' => 'Deleting service backup file :file.',
    ],
    'server' => [
        'rebuild_failed' => 'Rebuild request for ":name" (#:id) on node ":node" failed with error: :message',
        'reinstall' => [
            'failed' => 'Reinstall request for ":name" (#:id) on node ":node" failed with error: :message',
            'confirm' => 'You are about to reinstall against a group of servers. Do you wish to continue?',
        ],
        'power' => [
            'confirm' => 'You are about to perform a :action against :count servers. Do you wish to continue?',
            'action_failed' => 'Power action request for ":name" (#:id) on node ":node" failed with error: :message',
        ],
    ],
    'environment' => [
        'mail' => [
            'ask_smtp_host' => 'SMTP Host (e.g. smtp.gmail.com)',
            'ask_smtp_port' => 'SMTP Port',
            'ask_smtp_username' => 'SMTP Username',
            'ask_smtp_password' => 'SMTP Password',
            'ask_mailgun_domain' => 'Mailgun Domain',
            'ask_mailgun_endpoint' => 'Mailgun Endpoint',
            'ask_mailgun_secret' => 'Mailgun Secret',
            'ask_mandrill_secret' => 'Mandrill Secret',
            'ask_postmark_username' => 'Postmark API Key',
            'ask_driver' => 'Which driver should be used for sending emails?',
            'ask_mail_from' => 'Email address emails should originate from',
            'ask_mail_name' => 'Name that emails should appear from',
            'ask_encryption' => 'Encryption method to use',
        ],
    ],
];
</file>

<file path="resources/lang/en/dashboard/account.php">
<?php

return [
    'email' => [
        'title' => 'Update your email',
        'updated' => 'Your email address has been updated.',
    ],
    'password' => [
        'title' => 'Change your password',
        'requirements' => 'Your new password should be at least 8 characters in length.',
        'updated' => 'Your password has been updated.',
    ],
    'two_factor' => [
        'button' => 'Configure 2-Factor Authentication',
        'disabled' => 'Two-factor authentication has been disabled on your account. You will no longer be prompted to provide a token when logging in.',
        'enabled' => 'Two-factor authentication has been enabled on your account! From now on, when logging in, you will be required to provide the code generated by your device.',
        'invalid' => 'The token provided was invalid.',
        'setup' => [
            'title' => 'Setup two-factor authentication',
            'help' => 'Can\'t scan the code? Enter the code below into your application:',
            'field' => 'Enter token',
        ],
        'disable' => [
            'title' => 'Disable two-factor authentication',
            'field' => 'Enter token',
        ],
    ],
];
</file>

<file path="resources/lang/en/dashboard/index.php">
<?php

return [
    'search' => 'Search for servers...',
    'no_matches' => 'There were no servers found matching the search criteria provided.',
    'cpu_title' => 'CPU',
    'memory_title' => 'Memory',
];
</file>

<file path="resources/lang/en/server/users.php">
<?php

return [
    'permissions' => [
        'websocket_*' => 'Allows access to the websocket for this server.',
        'control_console' => 'Allows the user to send data to the server console.',
        'control_start' => 'Allows the user to start the server instance.',
        'control_stop' => 'Allows the user to stop the server instance.',
        'control_restart' => 'Allows the user to restart the server instance.',
        'control_kill' => 'Allows the user to kill the server instance.',
        'user_create' => 'Allows the user to create new user accounts for the server.',
        'user_read' => 'Allows the user permission to view users associated with this server.',
        'user_update' => 'Allows the user to modify other users associated with this server.',
        'user_delete' => 'Allows the user to delete other users associated with this server.',
        'file_create' => 'Allows the user permission to create new files and directories.',
        'file_read' => 'Allows the user to see files and folders associated with this server instance, as well as view their contents.',
        'file_update' => 'Allows the user to update files and folders associated with the server.',
        'file_delete' => 'Allows the user to delete files and directories.',
        'file_archive' => 'Allows the user to create file archives and decompress existing archives.',
        'file_sftp' => 'Allows the user to perform the above file actions using a SFTP client.',
        'allocation_read' => 'Allows access to the server allocation management pages.',
        'allocation_update' => 'Allows user permission to make modifications to the server\'s allocations.',
        'database_create' => 'Allows user permission to create a new database for the server.',
        'database_read' => 'Allows user permission to view the server databases.',
        'database_update' => 'Allows a user permission to make modifications to a database. If the user does not have the "View Password" permission as well they will not be able to modify the password.',
        'database_delete' => 'Allows a user permission to delete a database instance.',
        'database_view_password' => 'Allows a user permission to view a database password in the system.',
        'schedule_create' => 'Allows a user to create a new schedule for the server.',
        'schedule_read' => 'Allows a user permission to view schedules for a server.',
        'schedule_update' => 'Allows a user permission to make modifications to an existing server schedule.',
        'schedule_delete' => 'Allows a user to delete a schedule for the server.',
    ],
];
</file>

<file path="resources/lang/en/activity.php">
<?php

/**
 * Contains all of the translation strings for different activity log
 * events. These should be keyed by the value in front of the colon (:)
 * in the event name. If there is no colon present, they should live at
 * the top level.
 */
return [
    'auth' => [
        'fail' => 'Failed log in',
        'success' => 'Logged in',
        'password-reset' => 'Password reset',
        'reset-password' => 'Requested password reset',
        'checkpoint' => 'Two-factor authentication requested',
        'recovery-token' => 'Used two-factor recovery token',
        'token' => 'Solved two-factor challenge',
        'ip-blocked' => 'Blocked request from unlisted IP address for :identifier',
        'sftp' => [
            'fail' => 'Failed SFTP log in',
        ],
    ],
    'user' => [
        'account' => [
            'email-changed' => 'Changed email from :old to :new',
            'password-changed' => 'Changed password',
            'username-changed' => 'Changed username from :old to :new',
        ],
        'api-key' => [
            'create' => 'Created new API key :identifier',
            'delete' => 'Deleted API key :identifier',
        ],
        'ssh-key' => [
            'create' => 'Added SSH key :fingerprint to account',
            'delete' => 'Removed SSH key :fingerprint from account',
        ],
        'two-factor' => [
            'create' => 'Enabled two-factor auth',
            'delete' => 'Disabled two-factor auth',
        ],
        'store' => [
            'resource-purchase' => 'A resource was purchased',
        ],
    ],

    'server' => [
        'reinstall' => 'Reinstalled server',
        'console' => [
            'command' => 'Executed ":command" on the server',
        ],
        'power' => [
            'start' => 'Started the server',
            'stop' => 'Stopped the server',
            'restart' => 'Restarted the server',
            'kill' => 'Killed the server process',
        ],
        'backup' => [
            'download' => 'Downloaded the :name backup',
            'delete' => 'Deleted the :name backup',
            'restore' => 'Restored the :name backup (deleted files: :truncate)',
            'restore-complete' => 'Completed restoration of the :name backup',
            'restore-failed' => 'Failed to complete restoration of the :name backup',
            'start' => 'Started a new backup :name',
            'complete' => 'Marked the :name backup as complete',
            'fail' => 'Marked the :name backup as failed',
            'lock' => 'Locked the :name backup',
            'unlock' => 'Unlocked the :name backup',
        ],
        'database' => [
            'create' => 'Created new database :name',
            'rotate-password' => 'Password rotated for database :name',
            'delete' => 'Deleted database :name',
        ],
        'file' => [
            'compress_one' => 'Compressed :directory:file',
            'compress_other' => 'Compressed :count files in :directory',
            'read' => 'Viewed the contents of :file',
            'copy' => 'Created a copy of :file',
            'create-directory' => 'Created directory :directory:name',
            'decompress' => 'Decompressed :files in :directory',
            'delete_one' => 'Deleted :directory:files.0',
            'delete_other' => 'Deleted :count files in :directory',
            'download' => 'Downloaded :file',
            'pull' => 'Downloaded a remote file from :url to :directory',
            'rename_one' => 'Renamed :directory:files.0.from to :directory:files.0.to',
            'rename_other' => 'Renamed :count files in :directory',
            'write' => 'Wrote new content to :file',
            'upload' => 'Began a file upload',
            'uploaded' => 'Uploaded :directory:file',
        ],
        'sftp' => [
            'denied' => 'Blocked SFTP access due to permissions',
            'create_one' => 'Created :files.0',
            'create_other' => 'Created :count new files',
            'write_one' => 'Modified the contents of :files.0',
            'write_other' => 'Modified the contents of :count files',
            'delete_one' => 'Deleted :files.0',
            'delete_other' => 'Deleted :count files',
            'create-directory_one' => 'Created the :files.0 directory',
            'create-directory_other' => 'Created :count directories',
            'rename_one' => 'Renamed :files.0.from to :files.0.to',
            'rename_other' => 'Renamed or moved :count files',
        ],
        'allocation' => [
            'create' => 'Added :allocation to the server',
            'notes' => 'Updated the notes for :allocation from ":old" to ":new"',
            'primary' => 'Set :allocation as the primary server allocation',
            'delete' => 'Deleted the :allocation allocation',
        ],
        'schedule' => [
            'create' => 'Created the :name schedule',
            'update' => 'Updated the :name schedule',
            'execute' => 'Manually executed the :name schedule',
            'delete' => 'Deleted the :name schedule',
        ],
        'task' => [
            'create' => 'Created a new ":action" task for the :name schedule',
            'update' => 'Updated the ":action" task for the :name schedule',
            'delete' => 'Deleted a task for the :name schedule',
        ],
        'settings' => [
            'rename' => 'Renamed the server from :old to :new',
            'description' => 'Changed the server description from :old to :new',
        ],
        'startup' => [
            'edit' => 'Changed the :variable variable from ":old" to ":new"',
            'image' => 'Updated the Docker Image for the server from :old to :new',
        ],
        'subuser' => [
            'create' => 'Added :email as a subuser',
            'update' => 'Updated the subuser permissions for :email',
            'delete' => 'Removed :email as a subuser',
        ],
    ],
];
</file>

<file path="resources/lang/en/auth.php">
<?php

return [
    'sign_in' => 'Sign In',
    'go_to_login' => 'Go to Login',
    'failed' => 'No account matching those credentials could be found.',

    'forgot_password' => [
        'label' => 'Forgot Password?',
        'label_help' => 'Enter your account email address to receive instructions on resetting your password.',
        'button' => 'Recover Account',
    ],

    'reset_password' => [
        'button' => 'Reset and Sign In',
    ],

    'two_factor' => [
        'label' => '2-Factor Token',
        'label_help' => 'This account requires a second layer of authentication in order to continue. Please enter the code generated by your device to complete this login.',
        'checkpoint_failed' => 'The two-factor authentication token was invalid.',
    ],

    'throttle' => 'Too many login attempts. Please try again in :seconds seconds.',
    'password_requirements' => 'Password must be at least 8 characters in length and should be unique to this site.',
    '2fa_must_be_enabled' => 'The administrator has required that 2-Factor Authentication be enabled for your account in order to use the Panel.',
];
</file>

<file path="resources/lang/en/exceptions.php">
<?php

return [
    'daemon_connection_failed' => 'There was an exception while attempting to communicate with the daemon resulting in a HTTP/:code response code. This exception has been logged.',
    'node' => [
        'servers_attached' => 'A node must have no servers linked to it in order to be deleted.',
        'daemon_off_config_updated' => 'The daemon configuration <strong>has been updated</strong>, however there was an error encountered while attempting to automatically update the configuration file on the Daemon. You will need to manually update the configuration file (config.yml) for the daemon to apply these changes.',
    ],
    'allocations' => [
        'server_using' => 'A server is currently assigned to this allocation. An allocation can only be deleted if no server is currently assigned.',
        'too_many_ports' => 'Adding more than 1000 ports in a single range at once is not supported.',
        'invalid_mapping' => 'The mapping provided for :port was invalid and could not be processed.',
        'cidr_out_of_range' => 'CIDR notation only allows masks between /25 and /32.',
        'port_out_of_range' => 'Ports in an allocation must be greater than 1024 and less than or equal to 65535.',
    ],
    'nest' => [
        'delete_has_servers' => 'A Nest with active servers attached to it cannot be deleted from the Panel.',
        'egg' => [
            'delete_has_servers' => 'An Egg with active servers attached to it cannot be deleted from the Panel.',
            'invalid_copy_id' => 'The Egg selected for copying a script from either does not exist, or is copying a script itself.',
            'must_be_child' => 'The "Copy Settings From" directive for this Egg must be a child option for the selected Nest.',
            'has_children' => 'This Egg is a parent to one or more other Eggs. Please delete those Eggs before deleting this Egg.',
        ],
        'variables' => [
            'env_not_unique' => 'The environment variable :name must be unique to this Egg.',
            'reserved_name' => 'The environment variable :name is protected and cannot be assigned to a variable.',
            'bad_validation_rule' => 'The validation rule ":rule" is not a valid rule for this application.',
        ],
        'importer' => [
            'json_error' => 'There was an error while attempting to parse the JSON file: :error.',
            'file_error' => 'The JSON file provided was not valid.',
            'invalid_json_provided' => 'The JSON file provided is not in a format that can be recognized.',
        ],
    ],
    'subusers' => [
        'editing_self' => 'Editing your own subuser account is not permitted.',
        'user_is_owner' => 'You cannot add the server owner as a subuser for this server.',
        'subuser_exists' => 'A user with that email address is already assigned as a subuser for this server.',
    ],
    'databases' => [
        'delete_has_databases' => 'Cannot delete a database host server that has active databases linked to it.',
    ],
    'tasks' => [
        'chain_interval_too_long' => 'The maximum interval time for a chained task is 15 minutes.',
    ],
    'locations' => [
        'has_nodes' => 'Cannot delete a location that has active nodes attached to it.',
    ],
    'users' => [
        'node_revocation_failed' => 'Failed to revoke keys on <a href=":link">Node #:node</a>. :error',
    ],
    'deployment' => [
        'no_viable_nodes' => 'No nodes satisfying the requirements specified for automatic deployment could be found.',
        'no_viable_allocations' => 'No allocations satisfying the requirements for automatic deployment were found.',
    ],
    'api' => [
        'resource_not_found' => 'The requested resource does not exist on this server.',
    ],
];
</file>

<file path="resources/lang/en/pagination.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Pagination Language Lines
    |--------------------------------------------------------------------------
    |
    | The following language lines are used by the paginator library to build
    | the simple pagination links. You are free to change them to anything
    | you want to customize your views to better match your application.
    |
    */

    'previous' => '&laquo; Previous',
    'next' => 'Next &raquo;',
];
</file>

<file path="resources/lang/en/passwords.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Password Reset Language Lines
    |--------------------------------------------------------------------------
    |
    | The following language lines are the default lines which match reasons
    | that are given by the password broker for a password update attempt
    | has failed, such as for an invalid token or invalid new password.
    |
    */
    'password' => 'Passwords must be at least six characters and match the confirmation.',
    'reset' => 'Your password has been reset!',
    'sent' => 'We have e-mailed your password reset link!',
    'token' => 'This password reset token is invalid.',
    'user' => "We can't find a user with that e-mail address.",
];
</file>

<file path="resources/lang/en/strings.php">
<?php

return [
    'email' => 'Email',
    'email_address' => 'Email address',
    'user_identifier' => 'Username or Email',
    'password' => 'Password',
    'new_password' => 'New password',
    'confirm_password' => 'Confirm new password',
    'login' => 'Login',
    'home' => 'Home',
    'servers' => 'Servers',
    'id' => 'ID',
    'name' => 'Name',
    'node' => 'Node',
    'connection' => 'Connection',
    'memory' => 'Memory',
    'cpu' => 'CPU',
    'disk' => 'Disk',
    'status' => 'Status',
    'search' => 'Search',
    'suspended' => 'Suspended',
    'account' => 'Account',
    'security' => 'Security',
    'ip' => 'IP Address',
    'last_activity' => 'Last Activity',
    'revoke' => 'Revoke',
    '2fa_token' => 'Authentication Token',
    'submit' => 'Submit',
    'close' => 'Close',
    'settings' => 'Settings',
    'configuration' => 'Configuration',
    'sftp' => 'SFTP',
    'databases' => 'Databases',
    'memo' => 'Memo',
    'created' => 'Created',
    'expires' => 'Expires',
    'public_key' => 'Token',
    'api_access' => 'Api Access',
    'never' => 'never',
    'sign_out' => 'Sign out',
    'admin_control' => 'Admin Control',
    'required' => 'Required',
    'port' => 'Port',
    'username' => 'Username',
    'database' => 'Database',
    'new' => 'New',
    'danger' => 'Danger',
    'create' => 'Create',
    'select_all' => 'Select All',
    'select_none' => 'Select None',
    'alias' => 'Alias',
    'primary' => 'Primary',
    'make_primary' => 'Make Primary',
    'none' => 'None',
    'cancel' => 'Cancel',
    'created_at' => 'Created At',
    'action' => 'Action',
    'data' => 'Data',
    'queued' => 'Queued',
    'last_run' => 'Last Run',
    'next_run' => 'Next Run',
    'not_run_yet' => 'Not Run Yet',
    'yes' => 'Yes',
    'no' => 'No',
    'delete' => 'Delete',
    '2fa' => '2FA',
    'logout' => 'Logout',
    'admin_cp' => 'Admin Control Panel',
    'optional' => 'Optional',
    'read_only' => 'Read Only',
    'relation' => 'Relation',
    'owner' => 'Owner',
    'admin' => 'Admin',
    'subuser' => 'Subuser',
    'captcha_invalid' => 'The provided captcha is invalid.',
    'tasks' => 'Tasks',
    'seconds' => 'Seconds',
    'minutes' => 'Minutes',
    'under_maintenance' => 'Under Maintenance',
    'days' => [
        'sun' => 'Sunday',
        'mon' => 'Monday',
        'tues' => 'Tuesday',
        'wed' => 'Wednesday',
        'thurs' => 'Thursday',
        'fri' => 'Friday',
        'sat' => 'Saturday',
    ],
    'last_used' => 'Last Used',
    'enable' => 'Enable',
    'disable' => 'Disable',
    'save' => 'Save',
    'copyright' => '&copy; 2015 - :year Jexactyl Software',
];
</file>

<file path="resources/lang/en/validation.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Validation Language Lines
    |--------------------------------------------------------------------------
    |
    | The following language lines contain the default error messages used by
    | the validator class. Some of these rules have multiple versions such
    | as the size rules. Feel free to tweak each of these messages here.
    |
    */

    'accepted' => 'The :attribute must be accepted.',
    'active_url' => 'The :attribute is not a valid URL.',
    'after' => 'The :attribute must be a date after :date.',
    'after_or_equal' => 'The :attribute must be a date after or equal to :date.',
    'alpha' => 'The :attribute may only contain letters.',
    'alpha_dash' => 'The :attribute may only contain letters, numbers, and dashes.',
    'alpha_num' => 'The :attribute may only contain letters and numbers.',
    'array' => 'The :attribute must be an array.',
    'before' => 'The :attribute must be a date before :date.',
    'before_or_equal' => 'The :attribute must be a date before or equal to :date.',
    'between' => [
        'numeric' => 'The :attribute must be between :min and :max.',
        'file' => 'The :attribute must be between :min and :max kilobytes.',
        'string' => 'The :attribute must be between :min and :max characters.',
        'array' => 'The :attribute must have between :min and :max items.',
    ],
    'boolean' => 'The :attribute field must be true or false.',
    'confirmed' => 'The :attribute confirmation does not match.',
    'date' => 'The :attribute is not a valid date.',
    'date_format' => 'The :attribute does not match the format :format.',
    'different' => 'The :attribute and :other must be different.',
    'digits' => 'The :attribute must be :digits digits.',
    'digits_between' => 'The :attribute must be between :min and :max digits.',
    'dimensions' => 'The :attribute has invalid image dimensions.',
    'distinct' => 'The :attribute field has a duplicate value.',
    'email' => 'The :attribute must be a valid email address.',
    'exists' => 'The selected :attribute is invalid.',
    'file' => 'The :attribute must be a file.',
    'filled' => 'The :attribute field is required.',
    'image' => 'The :attribute must be an image.',
    'in' => 'The selected :attribute is invalid.',
    'in_array' => 'The :attribute field does not exist in :other.',
    'integer' => 'The :attribute must be an integer.',
    'ip' => 'The :attribute must be a valid IP address.',
    'json' => 'The :attribute must be a valid JSON string.',
    'max' => [
        'numeric' => 'The :attribute may not be greater than :max.',
        'file' => 'The :attribute may not be greater than :max kilobytes.',
        'string' => 'The :attribute may not be greater than :max characters.',
        'array' => 'The :attribute may not have more than :max items.',
    ],
    'mimes' => 'The :attribute must be a file of type: :values.',
    'mimetypes' => 'The :attribute must be a file of type: :values.',
    'min' => [
        'numeric' => 'The :attribute must be at least :min.',
        'file' => 'The :attribute must be at least :min kilobytes.',
        'string' => 'The :attribute must be at least :min characters.',
        'array' => 'The :attribute must have at least :min items.',
    ],
    'not_in' => 'The selected :attribute is invalid.',
    'numeric' => 'The :attribute must be a number.',
    'present' => 'The :attribute field must be present.',
    'regex' => 'The :attribute format is invalid.',
    'required' => 'The :attribute field is required.',
    'required_if' => 'The :attribute field is required when :other is :value.',
    'required_unless' => 'The :attribute field is required unless :other is in :values.',
    'required_with' => 'The :attribute field is required when :values is present.',
    'required_with_all' => 'The :attribute field is required when :values is present.',
    'required_without' => 'The :attribute field is required when :values is not present.',
    'required_without_all' => 'The :attribute field is required when none of :values are present.',
    'same' => 'The :attribute and :other must match.',
    'size' => [
        'numeric' => 'The :attribute must be :size.',
        'file' => 'The :attribute must be :size kilobytes.',
        'string' => 'The :attribute must be :size characters.',
        'array' => 'The :attribute must contain :size items.',
    ],
    'string' => 'The :attribute must be a string.',
    'timezone' => 'The :attribute must be a valid zone.',
    'unique' => 'The :attribute has already been taken.',
    'uploaded' => 'The :attribute failed to upload.',
    'url' => 'The :attribute format is invalid.',

    /*
    |--------------------------------------------------------------------------
    | Custom Validation Attributes
    |--------------------------------------------------------------------------
    |
    | The following language lines are used to swap attribute place-holders
    | with something more reader friendly such as E-Mail Address instead
    | of "email". This simply helps us make messages a little cleaner.
    |
    */

    'attributes' => [],

    // Internal validation logic for Jexactyl
    'internal' => [
        'variable_value' => ':env variable',
        'invalid_password' => 'The password provided was invalid for this account.',
    ],
];
</file>

<file path="resources/scripts/__mocks__/file.ts">
module.exports = 'test-file-stub';
</file>

<file path="resources/scripts/api/account/activity.ts">
import { AxiosError } from 'axios';
import { useUserSWRKey } from '@/plugins/useSWRKey';
import { toPaginatedSet } from '@definitions/helpers';
import useFilteredObject from '@/plugins/useFilteredObject';
import { ActivityLog, Transformers } from '@definitions/user';
import useSWR, { ConfigInterface, responseInterface } from 'swr';
import http, { PaginatedResult, QueryBuilderParams, withQueryBuilderParams } from '@/api/http';

export type ActivityLogFilters = QueryBuilderParams<'ip' | 'event', 'timestamp'>;

const useActivityLogs = (
    filters?: ActivityLogFilters,
    config?: ConfigInterface<PaginatedResult<ActivityLog>, AxiosError>
): responseInterface<PaginatedResult<ActivityLog>, AxiosError> => {
    const key = useUserSWRKey(['account', 'activity', JSON.stringify(useFilteredObject(filters || {}))]);

    return useSWR<PaginatedResult<ActivityLog>>(
        key,
        async () => {
            const { data } = await http.get('/api/client/account/activity', {
                params: {
                    ...withQueryBuilderParams(filters),
                    include: ['actor'],
                },
            });

            return toPaginatedSet(data, Transformers.toActivityLog);
        },
        { revalidateOnMount: false, ...(config || {}) }
    );
};

export { useActivityLogs };
</file>

<file path="resources/scripts/api/account/createApiKey.ts">
import http from '@/api/http';
import { ApiKey, rawDataToApiKey } from '@/api/account/getApiKeys';

export default (description: string, allowedIps: string): Promise<ApiKey & { secretToken: string }> => {
    return new Promise((resolve, reject) => {
        http.post('/api/client/account/api-keys', {
            description,
            allowed_ips: allowedIps.length > 0 ? allowedIps.split('\n') : [],
        })
            .then(({ data }) =>
                resolve({
                    ...rawDataToApiKey(data.attributes),
                    // eslint-disable-next-line camelcase
                    secretToken: data.meta?.secret_token ?? '',
                })
            )
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/account/createReferralCode.ts">
import http from '@/api/http';
import { ReferralCode, rawDataToReferralCode } from '@/api/account/getReferralCodes';

export default (): Promise<ReferralCode> => {
    return new Promise((resolve, reject) => {
        http.post('/api/client/account/referrals')
            .then(({ data }) =>
                resolve({
                    ...rawDataToReferralCode(data.attributes),
                })
            )
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/account/deleteApiKey.ts">
import http from '@/api/http';

export default (identifier: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.delete(`/api/client/account/api-keys/${identifier}`)
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/account/deleteReferralCode.ts">
import http from '@/api/http';

export default (code: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.delete(`/api/client/account/referrals/${code}`)
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/account/disableAccountTwoFactor.ts">
import http from '@/api/http';

function disableAccountTwoFactor(password: string): Promise<void> {
    return new Promise((resolve, reject) => {
        http.post('/api/client/account/two-factor/disable', { password })
            .then(() => resolve())
            .catch(reject);
    });
}

export default disableAccountTwoFactor;
</file>

<file path="resources/scripts/api/account/discord.ts">
import http from '@/api/http';

export const linkDiscord = (): Promise<string> => {
    return new Promise((resolve, reject) => {
        http.get('/api/client/account/discord')
            .then((data) => resolve(data.data))
            .catch(reject);
    });
};

export const unlinkDiscord = (): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post('/api/client/account/discord/unlink')
            .then((data) => resolve(data.data))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/account/earnCredits.ts">
import http from '@/api/http';

export default (): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post('/api/client/store/earn')
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/account/enableAccountTwoFactor.ts">
import http from '@/api/http';

export default async (code: string, password: string): Promise<string[]> => {
    const { data } = await http.post('/api/client/account/two-factor', { code, password });

    return data.attributes.tokens;
};
</file>

<file path="resources/scripts/api/account/getApiKeys.ts">
import http from '@/api/http';

export interface ApiKey {
    identifier: string;
    description: string;
    allowedIps: string[];
    createdAt: Date | null;
    lastUsedAt: Date | null;
}

export const rawDataToApiKey = (data: any): ApiKey => ({
    identifier: data.identifier,
    description: data.description,
    allowedIps: data.allowed_ips,
    createdAt: data.created_at ? new Date(data.created_at) : null,
    lastUsedAt: data.last_used_at ? new Date(data.last_used_at) : null,
});

export default (): Promise<ApiKey[]> => {
    return new Promise((resolve, reject) => {
        http.get('/api/client/account/api-keys')
            .then(({ data }) => resolve((data.data || []).map((d: any) => rawDataToApiKey(d.attributes))))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/account/getLatestActivity.ts">
import http, { FractalResponseData } from '@/api/http';

export interface Activity {
    event: string;
    timestamp: Date;
    properties: Record<string, string | unknown>;
}

export const rawDataToActivity = ({ attributes: data }: FractalResponseData): Activity => ({
    event: data.event,
    timestamp: new Date(data.timestamp),
    properties: data.properties,
});

export default async (): Promise<Activity> => {
    return new Promise((resolve, reject) => {
        http.get('/api/client/account/activity/latest')
            .then(({ data }) => resolve(rawDataToActivity(data)))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/account/getReferralActivity.ts">
import http from '@/api/http';

export interface ReferralActivity {
    code: string;
    userId: number;
    userEmail: string;
    createdAt: Date | null;
}

export const rawDataToReferralActivity = (data: any): ReferralActivity => ({
    code: data.code,
    userId: data.user_id,
    userEmail: data.user_email,
    createdAt: data.created_at ? new Date(data.created_at) : null,
});

export default (): Promise<ReferralActivity[]> => {
    return new Promise((resolve, reject) => {
        http.get('/api/client/account/referrals/activity')
            .then(({ data }) => resolve((data.data || []).map((d: any) => rawDataToReferralActivity(d.attributes))))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/account/getReferralCodes.ts">
import http from '@/api/http';

export interface ReferralCode {
    code: string;
    createdAt: Date | null;
}

export const rawDataToReferralCode = (data: any): ReferralCode => ({
    code: data.code,
    createdAt: data.created_at ? new Date(data.created_at) : null,
});

export default (): Promise<ReferralCode[]> => {
    return new Promise((resolve, reject) => {
        http.get('/api/client/account/referrals')
            .then(({ data }) => resolve((data.data || []).map((d: any) => rawDataToReferralCode(d.attributes))))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/account/getTwoFactorTokenData.ts">
import http from '@/api/http';

export interface TwoFactorTokenData {
    // eslint-disable-next-line camelcase
    image_url_data: string;
    secret: string;
}

export default (): Promise<TwoFactorTokenData> => {
    return new Promise((resolve, reject) => {
        http.get('/api/client/account/two-factor')
            .then(({ data }) => resolve(data.data))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/account/redeemCoupon.ts">
import http from '@/api/http';

export default (code: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post('/api/client/account/coupon', { code: code })
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/account/ssh-keys.ts">
import { AxiosError } from 'axios';
import useSWR, { ConfigInterface } from 'swr';
import { useUserSWRKey } from '@/plugins/useSWRKey';
import http, { FractalResponseList } from '@/api/http';
import { SSHKey, Transformers } from '@definitions/user';

const useSSHKeys = (config?: ConfigInterface<SSHKey[], AxiosError>) => {
    const key = useUserSWRKey(['account', 'ssh-keys']);

    return useSWR(
        key,
        async () => {
            const { data } = await http.get('/api/client/account/ssh-keys');

            return (data as FractalResponseList).data.map((datum: any) => {
                return Transformers.toSSHKey(datum.attributes);
            });
        },
        { revalidateOnMount: false, ...(config || {}) }
    );
};

const createSSHKey = async (name: string, publicKey: string): Promise<SSHKey> => {
    const { data } = await http.post('/api/client/account/ssh-keys', { name, public_key: publicKey });

    return Transformers.toSSHKey(data.attributes);
};

const deleteSSHKey = async (fingerprint: string): Promise<void> =>
    await http.post('/api/client/account/ssh-keys/remove', { fingerprint });

export { useSSHKeys, createSSHKey, deleteSSHKey };
</file>

<file path="resources/scripts/api/account/tickets.ts">
import http from '@/api/http';

export type TicketStatus = 'pending' | 'resolved' | 'unresolved' | 'in-progress';

export interface Ticket {
    id: number;
    staffEmail: string;
    title: string;
    status: TicketStatus;
    content: string[];
    createdAt: Date | null;
    updatedAt: Date | null;
}

export interface TicketMessage {
    id: number;
    userEmail: string;
    content: string[];
    createdAt: Date | null;
    updatedAt: Date | null;
}

export const rawDataToTicket = (data: any): Ticket => ({
    id: data.id,
    staffEmail: data.staff_email,
    title: data.title,
    status: data.status,
    content: data.content,
    createdAt: data.created_at ? new Date(data.created_at) : null,
    updatedAt: data.updated_at ? new Date(data.updated_at) : null,
});

export const rawDataToTicketMessage = (data: any): TicketMessage => ({
    id: data.id,
    userEmail: data.user_email,
    content: data.content,
    createdAt: data.created_at ? new Date(data.created_at) : null,
    updatedAt: data.updated_at ? new Date(data.updated_at) : null,
});

// API actions for ticket handling.

export const getTickets = (): Promise<Ticket[]> => {
    return new Promise((resolve, reject) => {
        http.get('/api/client/account/tickets')
            .then(({ data }) => resolve((data.data || []).map((d: any) => rawDataToTicket(d.attributes))))
            .catch(reject);
    });
};

export const getTicket = (id: number): Promise<Ticket> => {
    return new Promise((resolve, reject) => {
        http.get(`/api/client/account/tickets/${id}`)
            .then(({ data }) => resolve(rawDataToTicket(data.attributes)))
            .catch(reject);
    });
};

export const deleteTicket = (id: number): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.delete(`/api/client/account/tickets/${id}`)
            .then((data) => resolve(data.data))
            .catch(reject);
    });
};

export const createTicket = (title: string, description: string): Promise<string> => {
    return new Promise((resolve, reject) => {
        http.post('/api/client/account/tickets', { title, description })
            .then((data) => resolve(data.data))
            .catch(reject);
    });
};

// API actions for ticket messages.

export const createMessage = (id: number, description: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post(`/api/client/account/tickets/${id}/messages`, { description })
            .then((data) => resolve(data.data))
            .catch(reject);
    });
};

export const getMessages = (id: number): Promise<TicketMessage[]> => {
    return new Promise((resolve, reject) => {
        http.get(`/api/client/account/tickets/${id}/messages`)
            .then(({ data }) => resolve((data.data || []).map((d: any) => rawDataToTicketMessage(d.attributes))))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/account/updateAccountEmail.ts">
import http from '@/api/http';

export default (email: string, password: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.put('/api/client/account/email', { email, password })
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/account/updateAccountPassword.ts">
import http from '@/api/http';

interface Data {
    current: string;
    password: string;
    confirmPassword: string;
}

export default ({ current, password, confirmPassword }: Data): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.put('/api/client/account/password', {
            current_password: current,
            password: password,
            password_confirmation: confirmPassword,
        })
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/account/updateAccountUsername.ts">
import http from '@/api/http';

interface Data {
    username: string;
    password: string;
}

export default ({ username, password }: Data): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.put('/api/client/account/username', {
            username: username,
            password: password,
        })
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/account/useReferralCode.ts">
import http from '@/api/http';

interface Data {
    code: string;
    password: string;
}

export default ({ code, password }: Data): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.put('/api/client/account/referrals/use-code', {
            code: code,
            password: password,
        })
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/account/verify.ts">
import http from '@/api/http';

interface Data {
    success: boolean;
    data: string[];
}

export default (): Promise<Data> => {
    return new Promise((resolve, reject) => {
        http.post('/api/client/account/verify')
            .then((data) => resolve(data.data))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/auth/discord.ts">
import http from '@/api/http';

export default (): Promise<any> => {
    return new Promise((resolve, reject) => {
        http.post('/auth/discord/login')
            .then((data) => resolve(data.data || []))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/auth/login.ts">
import http from '@/api/http';

export interface LoginResponse {
    complete: boolean;
    intended?: string;
    confirmationToken?: string;
}

export interface LoginData {
    username: string;
    password: string;
    recaptchaData?: string | null;
}

export default ({ username, password, recaptchaData }: LoginData): Promise<LoginResponse> => {
    return new Promise((resolve, reject) => {
        http.get('/sanctum/csrf-cookie')
            .then(() =>
                http.post('/auth/login', {
                    user: username,
                    password,
                    'g-recaptcha-response': recaptchaData,
                })
            )
            .then((response) => {
                if (!(response.data instanceof Object)) {
                    return reject(new Error('An error occurred while processing the login request.'));
                }

                return resolve({
                    complete: response.data.data.complete,
                    intended: response.data.data.intended || undefined,
                    confirmationToken: response.data.data.confirmation_token || undefined,
                });
            })
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/auth/loginCheckpoint.ts">
import http from '@/api/http';
import { LoginResponse } from '@/api/auth/login';

export default (token: string, code: string, recoveryToken?: string): Promise<LoginResponse> => {
    return new Promise((resolve, reject) => {
        http.post('/auth/login/checkpoint', {
            confirmation_token: token,
            authentication_code: code,
            recovery_token: recoveryToken && recoveryToken.length > 0 ? recoveryToken : undefined,
        })
            .then((response) =>
                resolve({
                    complete: response.data.data.complete,
                    intended: response.data.data.intended || undefined,
                })
            )
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/auth/performPasswordReset.ts">
import http from '@/api/http';

interface Data {
    token: string;
    password: string;
    passwordConfirmation: string;
}

interface PasswordResetResponse {
    redirectTo?: string | null;
    sendToLogin: boolean;
}

export default (email: string, data: Data): Promise<PasswordResetResponse> => {
    return new Promise((resolve, reject) => {
        http.post('/auth/password/reset', {
            email,
            token: data.token,
            password: data.password,
            password_confirmation: data.passwordConfirmation,
        })
            .then((response) =>
                resolve({
                    redirectTo: response.data.redirect_to,
                    sendToLogin: response.data.send_to_login,
                })
            )
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/auth/register.ts">
import http from '@/api/http';

export interface RegisterResponse {
    complete: boolean;
    intended?: string;
    confirmationToken?: string;
}

export interface RegisterData {
    username: string;
    email: string;
    password: string;
    recaptchaData?: string | null;
}

export default ({ username, email, password, recaptchaData }: RegisterData): Promise<RegisterResponse> => {
    return new Promise((resolve, reject) => {
        http.get('/sanctum/csrf-cookie')
            .then(() =>
                http.post('/auth/register', {
                    user: username,
                    email: email,
                    password: password,
                    'g-recaptcha-response': recaptchaData,
                })
            )
            .then((response) => {
                if (!(response.data instanceof Object)) {
                    return reject(new Error('Unable to register account. Please contact an administrator.'));
                }

                return resolve({
                    complete: response.data.data.complete,
                    intended: response.data.data.intended || undefined,
                    confirmationToken: response.data.data.confirmation_token || undefined,
                });
            })
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/auth/requestPasswordResetEmail.ts">
import http from '@/api/http';

export default (email: string, recaptchaData?: string): Promise<string> => {
    return new Promise((resolve, reject) => {
        http.post('/auth/password', { email, 'g-recaptcha-response': recaptchaData })
            .then((response) => resolve(response.data.status || ''))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/definitions/user/index.ts">
export * from './models.d';
export { default as Transformers, MetaTransformers } from './transformers';
</file>

<file path="resources/scripts/api/definitions/user/models.d.ts">
import { Model, UUID } from '@/api/definitions';
import { SubuserPermission } from '@/state/server/subusers';

interface User extends Model {
    uuid: string;
    username: string;
    email: string;
    image: string;
    twoFactorEnabled: boolean;
    createdAt: Date;
    permissions: SubuserPermission[];
    can(permission: SubuserPermission): boolean;
}

interface SSHKey extends Model {
    name: string;
    publicKey: string;
    fingerprint: string;
    createdAt: Date;
}

interface ActivityLog extends Model<'actor'> {
    id: string;
    batch: UUID | null;
    event: string;
    ip: string | null;
    isApi: boolean;
    description: string | null;
    properties: Record<string, string | unknown>;
    hasAdditionalMetadata: boolean;
    timestamp: Date;
    relationships: {
        actor: User | null;
    };
}
</file>

<file path="resources/scripts/api/definitions/user/transformers.ts">
import * as Models from '@definitions/user/models';
import { FractalResponseData } from '@/api/http';
import { transform } from '@definitions/helpers';

export default class Transformers {
    static toSSHKey = (data: Record<any, any>): Models.SSHKey => {
        return {
            name: data.name,
            publicKey: data.public_key,
            fingerprint: data.fingerprint,
            createdAt: new Date(data.created_at),
        };
    };

    static toUser = ({ attributes }: FractalResponseData): Models.User => {
        return {
            uuid: attributes.uuid,
            username: attributes.username,
            email: attributes.email,
            image: attributes.image,
            twoFactorEnabled: attributes['2fa_enabled'],
            permissions: attributes.permissions || [],
            createdAt: new Date(attributes.created_at),
            can(permission): boolean {
                return this.permissions.includes(permission);
            },
        };
    };

    static toActivityLog = ({ attributes }: FractalResponseData): Models.ActivityLog => {
        const { actor } = attributes.relationships || {};

        return {
            id: attributes.id,
            batch: attributes.batch,
            event: attributes.event,
            ip: attributes.ip,
            isApi: attributes.is_api,
            description: attributes.description,
            properties: attributes.properties,
            hasAdditionalMetadata: attributes.has_additional_metadata ?? false,
            timestamp: new Date(attributes.timestamp),
            relationships: {
                actor: transform(actor as FractalResponseData, this.toUser, null),
            },
        };
    };
}

export class MetaTransformers {}
</file>

<file path="resources/scripts/api/definitions/helpers.ts">
import {
    FractalPaginatedResponse,
    FractalResponseData,
    FractalResponseList,
    getPaginationSet,
    PaginatedResult,
} from '@/api/http';
import { Model } from '@definitions/index';

type TransformerFunc<T> = (callback: FractalResponseData) => T;

const isList = (data: FractalResponseList | FractalResponseData): data is FractalResponseList => data.object === 'list';

function transform<T, M>(data: null | undefined, transformer: TransformerFunc<T>, missing?: M): M;
function transform<T, M>(
    data: FractalResponseData | null | undefined,
    transformer: TransformerFunc<T>,
    missing?: M
): T | M;
function transform<T, M>(
    data: FractalResponseList | FractalPaginatedResponse | null | undefined,
    transformer: TransformerFunc<T>,
    missing?: M
): T[] | M;
function transform<T>(
    data: FractalResponseData | FractalResponseList | FractalPaginatedResponse | null | undefined,
    transformer: TransformerFunc<T>,
    missing = undefined
) {
    if (data === undefined || data === null) {
        return missing;
    }

    if (isList(data)) {
        return data.data.map(transformer);
    }

    if (!data || !data.attributes || data.object === 'null_resource') {
        return missing;
    }

    return transformer(data);
}

function toPaginatedSet<T extends TransformerFunc<Model>>(
    response: FractalPaginatedResponse,
    transformer: T
): PaginatedResult<ReturnType<T>> {
    return {
        items: transform(response, transformer) as ReturnType<T>[],
        pagination: getPaginationSet(response.meta.pagination),
    };
}

export { transform, toPaginatedSet };
</file>

<file path="resources/scripts/api/definitions/index.d.ts">
import { MarkRequired } from 'ts-essentials';
import { FractalResponseData, FractalResponseList } from '../http';

export type UUID = string;

// eslint-disable-next-line @typescript-eslint/no-empty-interface
export interface Model {}

interface ModelWithRelationships extends Model {
    relationships: Record<string, FractalResponseData | FractalResponseList | undefined>;
}

/**
 * Allows a model to have optional relationships that are marked as being
 * present in a given pathway. This allows different API calls to specify the
 * "completeness" of a response object without having to make every API return
 * the same information, or every piece of logic do explicit null checking.
 *
 * Example:
 *  >> const user: WithLoaded<User, 'servers'> = {};
 *  >> // "user.servers" is no longer potentially undefined.
 */
type WithLoaded<M extends ModelWithRelationships, R extends keyof M['relationships']> = M & {
    relationships: MarkRequired<M['relationships'], R>;
};

/**
 * Helper type that allows you to infer the type of an object by giving
 * it the specific API request function with a return type. For example:
 *
 * type Egg = InferModel<typeof getEgg>;
 */
export type InferModel<T extends (...args: any) => any> = ReturnType<T> extends Promise<infer U> ? U : T;
</file>

<file path="resources/scripts/api/server/backups/createServerBackup.ts">
import http from '@/api/http';
import { ServerBackup } from '@/api/server/types';
import { rawDataToServerBackup } from '@/api/transformers';

interface RequestParameters {
    name?: string;
    ignored?: string;
    isLocked: boolean;
}

export default async (uuid: string, params: RequestParameters): Promise<ServerBackup> => {
    const { data } = await http.post(`/api/client/servers/${uuid}/backups`, {
        name: params.name,
        ignored: params.ignored,
        is_locked: params.isLocked,
    });

    return rawDataToServerBackup(data);
};
</file>

<file path="resources/scripts/api/server/backups/deleteBackup.ts">
import http from '@/api/http';

export default (uuid: string, backup: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.delete(`/api/client/servers/${uuid}/backups/${backup}`)
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/backups/getBackupDownloadUrl.ts">
import http from '@/api/http';

export default (uuid: string, backup: string): Promise<string> => {
    return new Promise((resolve, reject) => {
        http.get(`/api/client/servers/${uuid}/backups/${backup}/download`)
            .then(({ data }) => resolve(data.attributes.url))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/backups/index.ts">
import http from '@/api/http';

export const restoreServerBackup = async (uuid: string, backup: string, truncate?: boolean): Promise<void> => {
    await http.post(`/api/client/servers/${uuid}/backups/${backup}/restore`, {
        truncate,
    });
};
</file>

<file path="resources/scripts/api/server/databases/createServerDatabase.ts">
import http from '@/api/http';
import { rawDataToServerDatabase, ServerDatabase } from '@/api/server/databases/getServerDatabases';

export default (uuid: string, data: { connectionsFrom: string; databaseName: string }): Promise<ServerDatabase> => {
    return new Promise((resolve, reject) => {
        http.post(
            `/api/client/servers/${uuid}/databases`,
            {
                database: data.databaseName,
                remote: data.connectionsFrom,
            },
            {
                params: { include: 'password' },
            }
        )
            .then((response) => resolve(rawDataToServerDatabase(response.data.attributes)))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/databases/deleteServerDatabase.ts">
import http from '@/api/http';

export default (uuid: string, database: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.delete(`/api/client/servers/${uuid}/databases/${database}`)
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/databases/getServerDatabases.ts">
import http from '@/api/http';

export interface ServerDatabase {
    id: string;
    name: string;
    username: string;
    connectionString: string;
    allowConnectionsFrom: string;
    password?: string;
}

export const rawDataToServerDatabase = (data: any): ServerDatabase => ({
    id: data.id,
    name: data.name,
    username: data.username,
    connectionString: `${data.host.address}:${data.host.port}`,
    allowConnectionsFrom: data.connections_from,
    password: data.relationships.password?.attributes?.password,
});

export default (uuid: string, includePassword = true): Promise<ServerDatabase[]> => {
    return new Promise((resolve, reject) => {
        http.get(`/api/client/servers/${uuid}/databases`, {
            params: includePassword ? { include: 'password' } : undefined,
        })
            .then((response) =>
                resolve((response.data.data || []).map((item: any) => rawDataToServerDatabase(item.attributes)))
            )
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/databases/rotateDatabasePassword.ts">
import http from '@/api/http';
import { rawDataToServerDatabase, ServerDatabase } from '@/api/server/databases/getServerDatabases';

export default (uuid: string, database: string): Promise<ServerDatabase> => {
    return new Promise((resolve, reject) => {
        http.post(`/api/client/servers/${uuid}/databases/${database}/rotate-password`)
            .then((response) => resolve(rawDataToServerDatabase(response.data.attributes)))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/files/chmodFiles.ts">
import http from '@/api/http';

interface Data {
    file: string;
    mode: string;
}

export default (uuid: string, directory: string, files: Data[]): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post(`/api/client/servers/${uuid}/files/chmod`, { root: directory, files })
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/files/compressFiles.ts">
import http from '@/api/http';
import { rawDataToFileObject } from '@/api/transformers';
import { FileObject } from '@/api/server/files/loadDirectory';

export default async (uuid: string, directory: string, files: string[]): Promise<FileObject> => {
    const { data } = await http.post(
        `/api/client/servers/${uuid}/files/compress`,
        { root: directory, files },
        {
            timeout: 60000,
            timeoutErrorMessage:
                'It looks like this archive is taking a long time to generate. It will appear once completed.',
        }
    );

    return rawDataToFileObject(data);
};
</file>

<file path="resources/scripts/api/server/files/copyFile.ts">
import http from '@/api/http';

export default (uuid: string, location: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post(`/api/client/servers/${uuid}/files/copy`, { location })
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/files/createDirectory.ts">
import http from '@/api/http';

export default (uuid: string, root: string, name: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post(`/api/client/servers/${uuid}/files/create-folder`, { root, name })
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/files/decompressFiles.ts">
import http from '@/api/http';

export default async (uuid: string, directory: string, file: string): Promise<void> => {
    await http.post(
        `/api/client/servers/${uuid}/files/decompress`,
        { root: directory, file },
        {
            timeout: 300000,
            timeoutErrorMessage:
                'It looks like this archive is taking a long time to be unarchived. Once completed the unarchived files will appear.',
        }
    );
};
</file>

<file path="resources/scripts/api/server/files/deleteFiles.ts">
import http from '@/api/http';

export default (uuid: string, directory: string, files: string[]): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post(`/api/client/servers/${uuid}/files/delete`, { root: directory, files })
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/files/getFileContents.ts">
import http from '@/api/http';

export default (server: string, file: string): Promise<string> => {
    return new Promise((resolve, reject) => {
        http.get(`/api/client/servers/${server}/files/contents`, {
            params: { file },
            transformResponse: (res) => res,
            responseType: 'text',
        })
            .then(({ data }) => resolve(data))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/files/getFileDownloadUrl.ts">
import http from '@/api/http';

export default (uuid: string, file: string): Promise<string> => {
    return new Promise((resolve, reject) => {
        http.get(`/api/client/servers/${uuid}/files/download`, { params: { file } })
            .then(({ data }) => resolve(data.attributes.url))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/files/getFileUploadUrl.ts">
import http from '@/api/http';

export default (uuid: string): Promise<string> => {
    return new Promise((resolve, reject) => {
        http.get(`/api/client/servers/${uuid}/files/upload`)
            .then(({ data }) => resolve(data.attributes.url))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/files/loadDirectory.ts">
import http from '@/api/http';
import { rawDataToFileObject } from '@/api/transformers';

export interface FileObject {
    key: string;
    name: string;
    mode: string;
    modeBits: string;
    size: number;
    isFile: boolean;
    isSymlink: boolean;
    mimetype: string;
    createdAt: Date;
    modifiedAt: Date;
    isArchiveType: () => boolean;
    isEditable: () => boolean;
}

export default async (uuid: string, directory?: string): Promise<FileObject[]> => {
    const { data } = await http.get(`/api/client/servers/${uuid}/files/list`, {
        params: { directory: directory ?? '/' },
    });

    return (data.data || []).map(rawDataToFileObject);
};
</file>

<file path="resources/scripts/api/server/files/pullFile.ts">
import http from '@/api/http';

export default (uuid: string, directory: string, url: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post(`/api/client/servers/${uuid}/files/pull`, { root: directory, url })
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/files/renameFiles.ts">
import http from '@/api/http';

interface Data {
    to: string;
    from: string;
}

export default (uuid: string, directory: string, files: Data[]): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.put(`/api/client/servers/${uuid}/files/rename`, { root: directory, files })
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/files/saveFileContents.ts">
import http from '@/api/http';

export default async (uuid: string, file: string, content: string): Promise<void> => {
    await http.post(`/api/client/servers/${uuid}/files/write`, content, {
        params: { file },
        headers: {
            'Content-Type': 'text/plain',
        },
    });
};
</file>

<file path="resources/scripts/api/server/network/createServerAllocation.ts">
import http from '@/api/http';
import { Allocation } from '@/api/server/getServer';
import { rawDataToServerAllocation } from '@/api/transformers';

export default async (uuid: string): Promise<Allocation> => {
    const { data } = await http.post(`/api/client/servers/${uuid}/network/allocations`);

    return rawDataToServerAllocation(data);
};
</file>

<file path="resources/scripts/api/server/network/deleteServerAllocation.ts">
import http from '@/api/http';
import { Allocation } from '@/api/server/getServer';

export default async (uuid: string, id: number): Promise<Allocation> =>
    await http.delete(`/api/client/servers/${uuid}/network/allocations/${id}`);
</file>

<file path="resources/scripts/api/server/network/setPrimaryServerAllocation.ts">
import http from '@/api/http';
import { Allocation } from '@/api/server/getServer';
import { rawDataToServerAllocation } from '@/api/transformers';

export default async (uuid: string, id: number): Promise<Allocation> => {
    const { data } = await http.post(`/api/client/servers/${uuid}/network/allocations/${id}/primary`);

    return rawDataToServerAllocation(data);
};
</file>

<file path="resources/scripts/api/server/network/setServerAllocationNotes.ts">
import http from '@/api/http';
import { Allocation } from '@/api/server/getServer';
import { rawDataToServerAllocation } from '@/api/transformers';

export default async (uuid: string, id: number, notes: string | null): Promise<Allocation> => {
    const { data } = await http.post(`/api/client/servers/${uuid}/network/allocations/${id}`, { notes });

    return rawDataToServerAllocation(data);
};
</file>

<file path="resources/scripts/api/server/plugins/getPlugins.ts">
import http from '@/api/http';

export interface Plugin {
    plugins: any[];
}

export default async (uuid: string, query: string): Promise<Plugin> => {
    const { data } = await http.post(`/api/client/servers/${uuid}/plugins`, {
        query,
    });

    return data.data || [];
};
</file>

<file path="resources/scripts/api/server/plugins/installPlugin.ts">
import http from '@/api/http';

export default async (uuid: string, id: number): Promise<void> => {
    const { data } = await http.post(`/api/client/servers/${uuid}/plugins/install/${id}`);

    return data.data || [];
};
</file>

<file path="resources/scripts/api/server/schedules/createOrUpdateSchedule.ts">
import http from '@/api/http';
import { rawDataToServerSchedule, Schedule } from '@/api/server/schedules/getServerSchedules';

type Data = Pick<Schedule, 'cron' | 'name' | 'onlyWhenOnline' | 'isActive'> & { id?: number };

export default async (uuid: string, schedule: Data): Promise<Schedule> => {
    const { data } = await http.post(`/api/client/servers/${uuid}/schedules${schedule.id ? `/${schedule.id}` : ''}`, {
        is_active: schedule.isActive,
        only_when_online: schedule.onlyWhenOnline,
        name: schedule.name,
        minute: schedule.cron.minute,
        hour: schedule.cron.hour,
        day_of_month: schedule.cron.dayOfMonth,
        month: schedule.cron.month,
        day_of_week: schedule.cron.dayOfWeek,
    });

    return rawDataToServerSchedule(data.attributes);
};
</file>

<file path="resources/scripts/api/server/schedules/createOrUpdateScheduleTask.ts">
import http from '@/api/http';
import { rawDataToServerTask, Task } from '@/api/server/schedules/getServerSchedules';

interface Data {
    action: string;
    payload: string;
    timeOffset: string | number;
    continueOnFailure: boolean;
}

export default async (uuid: string, schedule: number, task: number | undefined, data: Data): Promise<Task> => {
    const { data: response } = await http.post(
        `/api/client/servers/${uuid}/schedules/${schedule}/tasks${task ? `/${task}` : ''}`,
        {
            action: data.action,
            payload: data.payload,
            continue_on_failure: data.continueOnFailure,
            time_offset: data.timeOffset,
        }
    );

    return rawDataToServerTask(response.attributes);
};
</file>

<file path="resources/scripts/api/server/schedules/deleteSchedule.ts">
import http from '@/api/http';

export default (uuid: string, schedule: number): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.delete(`/api/client/servers/${uuid}/schedules/${schedule}`)
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/schedules/deleteScheduleTask.ts">
import http from '@/api/http';

export default (uuid: string, scheduleId: number, taskId: number): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.delete(`/api/client/servers/${uuid}/schedules/${scheduleId}/tasks/${taskId}`)
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/schedules/getServerSchedule.ts">
import http from '@/api/http';
import { rawDataToServerSchedule, Schedule } from '@/api/server/schedules/getServerSchedules';

export default (uuid: string, schedule: number): Promise<Schedule> => {
    return new Promise((resolve, reject) => {
        http.get(`/api/client/servers/${uuid}/schedules/${schedule}`, {
            params: {
                include: ['tasks'],
            },
        })
            .then(({ data }) => resolve(rawDataToServerSchedule(data.attributes)))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/schedules/getServerSchedules.ts">
import http from '@/api/http';

export interface Schedule {
    id: number;
    name: string;
    cron: {
        dayOfWeek: string;
        month: string;
        dayOfMonth: string;
        hour: string;
        minute: string;
    };
    isActive: boolean;
    isProcessing: boolean;
    onlyWhenOnline: boolean;
    lastRunAt: Date | null;
    nextRunAt: Date | null;
    createdAt: Date;
    updatedAt: Date;

    tasks: Task[];
}

export interface Task {
    id: number;
    sequenceId: number;
    action: string;
    payload: string;
    timeOffset: number;
    isQueued: boolean;
    continueOnFailure: boolean;
    createdAt: Date;
    updatedAt: Date;
}

export const rawDataToServerTask = (data: any): Task => ({
    id: data.id,
    sequenceId: data.sequence_id,
    action: data.action,
    payload: data.payload,
    timeOffset: data.time_offset,
    isQueued: data.is_queued,
    continueOnFailure: data.continue_on_failure,
    createdAt: new Date(data.created_at),
    updatedAt: new Date(data.updated_at),
});

export const rawDataToServerSchedule = (data: any): Schedule => ({
    id: data.id,
    name: data.name,
    cron: {
        dayOfWeek: data.cron.day_of_week,
        month: data.cron.month,
        dayOfMonth: data.cron.day_of_month,
        hour: data.cron.hour,
        minute: data.cron.minute,
    },
    isActive: data.is_active,
    isProcessing: data.is_processing,
    onlyWhenOnline: data.only_when_online,
    lastRunAt: data.last_run_at ? new Date(data.last_run_at) : null,
    nextRunAt: data.next_run_at ? new Date(data.next_run_at) : null,
    createdAt: new Date(data.created_at),
    updatedAt: new Date(data.updated_at),

    tasks: (data.relationships?.tasks?.data || []).map((row: any) => rawDataToServerTask(row.attributes)),
});

export default async (uuid: string): Promise<Schedule[]> => {
    const { data } = await http.get(`/api/client/servers/${uuid}/schedules`, {
        params: {
            include: ['tasks'],
        },
    });

    return (data.data || []).map((row: any) => rawDataToServerSchedule(row.attributes));
};
</file>

<file path="resources/scripts/api/server/schedules/triggerScheduleExecution.ts">
import http from '@/api/http';

export default async (server: string, schedule: number): Promise<void> =>
    await http.post(`/api/client/servers/${server}/schedules/${schedule}/execute`);
</file>

<file path="resources/scripts/api/server/users/createOrUpdateSubuser.ts">
import http from '@/api/http';
import { Subuser } from '@/state/server/subusers';
import { rawDataToServerSubuser } from '@/api/server/users/getServerSubusers';

interface Params {
    email: string;
    permissions: string[];
}

export default (uuid: string, params: Params, subuser?: Subuser): Promise<Subuser> => {
    return new Promise((resolve, reject) => {
        http.post(`/api/client/servers/${uuid}/users${subuser ? `/${subuser.uuid}` : ''}`, {
            ...params,
        })
            .then((data) => resolve(rawDataToServerSubuser(data.data)))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/users/deleteSubuser.ts">
import http from '@/api/http';

export default (uuid: string, userId: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.delete(`/api/client/servers/${uuid}/users/${userId}`)
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/users/getServerSubusers.ts">
import { Subuser } from '@/state/server/subusers';
import http, { FractalResponseData } from '@/api/http';

export const rawDataToServerSubuser = (data: FractalResponseData): Subuser => ({
    uuid: data.attributes.uuid,
    username: data.attributes.username,
    email: data.attributes.email,
    image: data.attributes.image,
    twoFactorEnabled: data.attributes['2fa_enabled'],
    createdAt: new Date(data.attributes.created_at),
    permissions: data.attributes.permissions || [],
    can: (permission) => (data.attributes.permissions || []).indexOf(permission) >= 0,
});

export default (uuid: string): Promise<Subuser[]> => {
    return new Promise((resolve, reject) => {
        http.get(`/api/client/servers/${uuid}/users`)
            .then(({ data }) => resolve((data.data || []).map(rawDataToServerSubuser)))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/activity.ts">
import useSWR, { ConfigInterface, responseInterface } from 'swr';
import { ActivityLog, Transformers } from '@definitions/user';
import { AxiosError } from 'axios';
import http, { PaginatedResult, QueryBuilderParams, withQueryBuilderParams } from '@/api/http';
import { toPaginatedSet } from '@definitions/helpers';
import useFilteredObject from '@/plugins/useFilteredObject';
import { useServerSWRKey } from '@/plugins/useSWRKey';
import { ServerContext } from '@/state/server';

export type ActivityLogFilters = QueryBuilderParams<'ip' | 'event', 'timestamp'>;

const useActivityLogs = (
    filters?: ActivityLogFilters,
    config?: ConfigInterface<PaginatedResult<ActivityLog>, AxiosError>
): responseInterface<PaginatedResult<ActivityLog>, AxiosError> => {
    const uuid = ServerContext.useStoreState((state) => state.server.data?.uuid);
    const key = useServerSWRKey(['activity', useFilteredObject(filters || {})]);

    return useSWR<PaginatedResult<ActivityLog>>(
        key,
        async () => {
            const { data } = await http.get(`/api/client/servers/${uuid}/activity`, {
                params: {
                    ...withQueryBuilderParams(filters),
                    include: ['actor'],
                },
            });

            return toPaginatedSet(data, Transformers.toActivityLog);
        },
        { revalidateOnMount: false, ...(config || {}) }
    );
};

export { useActivityLogs };
</file>

<file path="resources/scripts/api/server/analytics.ts">
import http from '@/api/http';

export interface Analytics {
    id: number;
    cpu: number;
    memory: number;
    disk: number;
}

export interface Message {
    id: number;
    title: string;
    content: string;
    type: 'success' | 'info' | 'warning' | 'danger';
    createdAt: string;
}

export const rawDataToAnalytics = (data: any): Analytics => ({
    id: data.id,
    cpu: data.cpu,
    memory: data.memory,
    disk: data.disk,
});

export const rawDataToMessage = (data: any): Message => ({
    id: data.id,
    title: data.title,
    content: data.content,
    type: data.type,
    createdAt: data.created_at,
});

export const getAnalytics = (uuid: string): Promise<Analytics> => {
    return new Promise((resolve, reject) => {
        http.get(`/api/client/servers/${uuid}/analytics`)
            .then(({ data }) => resolve(rawDataToAnalytics(data.attributes)))
            .catch(reject);
    });
};

export const getMessages = (uuid: string): Promise<Message[]> => {
    return new Promise((resolve, reject) => {
        http.get(`/api/client/servers/${uuid}/analytics/messages`)
            .then(({ data }) => resolve((data.data || []).map((d: any) => rawDataToMessage(d.attributes))))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/changeBackground.ts">
import http from '@/api/http';

export default (uuid: string, bg: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post(`/api/client/servers/${uuid}/background`, { bg })
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/deleteServer.ts">
import http from '@/api/http';

export default (uuid: string, name: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post(`/api/client/servers/${uuid}/delete`, { name })
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/editServer.ts">
import http from '@/api/http';

export default (uuid: string, resource: string, amount: number): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post(`/api/client/servers/${uuid}/edit`, {
            resource,
            amount,
        })
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/getServer.ts">
import { ServerEggVariable, ServerStatus } from '@/api/server/types';
import http, { FractalResponseData, FractalResponseList } from '@/api/http';
import { rawDataToServerAllocation, rawDataToServerEggVariable } from '@/api/transformers';

export interface Allocation {
    id: number;
    ip: string;
    alias: string | null;
    port: number;
    notes: string | null;
    isDefault: boolean;
}

export interface Server {
    id: string;
    internalId: number | string;
    uuid: string;
    name: string;
    node: string;
    isNodeUnderMaintenance: boolean;
    status: ServerStatus;
    sftpDetails: {
        ip: string;
        port: number;
    };
    invocation: string;
    dockerImage: string;
    description: string;
    limits: {
        memory: number;
        swap: number;
        disk: number;
        io: number;
        cpu: number;
        threads: string;
    };
    eggFeatures: string[];
    featureLimits: {
        databases: number;
        allocations: number;
        backups: number;
    };
    isTransferring: boolean;
    variables: ServerEggVariable[];
    allocations: Allocation[];
    renewal: number;
    renewable: boolean;
    bg: string;
}

export const rawDataToServerObject = ({ attributes: data }: FractalResponseData): Server => ({
    id: data.identifier,
    internalId: data.internal_id,
    uuid: data.uuid,
    name: data.name,
    node: data.node,
    isNodeUnderMaintenance: data.is_node_under_maintenance,
    status: data.status,
    invocation: data.invocation,
    dockerImage: data.docker_image,
    sftpDetails: {
        ip: data.sftp_details.ip,
        port: data.sftp_details.port,
    },
    description: data.description ? (data.description.length > 0 ? data.description : null) : null,
    limits: { ...data.limits },
    eggFeatures: data.egg_features || [],
    featureLimits: { ...data.feature_limits },
    isTransferring: data.is_transferring,
    variables: ((data.relationships?.variables as FractalResponseList | undefined)?.data || []).map(
        rawDataToServerEggVariable
    ),
    allocations: ((data.relationships?.allocations as FractalResponseList | undefined)?.data || []).map(
        rawDataToServerAllocation
    ),
    renewal: data.renewal,
    renewable: data.renewable,
    bg: data.bg,
});

export default (uuid: string): Promise<[Server, string[]]> => {
    return new Promise((resolve, reject) => {
        http.get(`/api/client/servers/${uuid}`)
            .then(({ data }) =>
                resolve([
                    rawDataToServerObject(data),
                    // eslint-disable-next-line camelcase
                    data.meta?.is_server_owner ? ['*'] : data.meta?.user_permissions || [],
                ])
            )
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/getServerResourceUsage.ts">
import http from '@/api/http';

export type ServerPowerState = 'offline' | 'starting' | 'running' | 'stopping';

export interface ServerStats {
    status: ServerPowerState;
    isSuspended: boolean;
    memoryUsageInBytes: number;
    cpuUsagePercent: number;
    diskUsageInBytes: number;
    networkRxInBytes: number;
    networkTxInBytes: number;
    uptime: number;
}

export default (server: string): Promise<ServerStats> => {
    return new Promise((resolve, reject) => {
        http.get(`/api/client/servers/${server}/resources`)
            .then(({ data: { attributes } }) =>
                resolve({
                    status: attributes.current_state,
                    isSuspended: attributes.is_suspended,
                    memoryUsageInBytes: attributes.resources.memory_bytes,
                    cpuUsagePercent: attributes.resources.cpu_absolute,
                    diskUsageInBytes: attributes.resources.disk_bytes,
                    networkRxInBytes: attributes.resources.network_rx_bytes,
                    networkTxInBytes: attributes.resources.network_tx_bytes,
                    uptime: attributes.resources.uptime,
                })
            )
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/getWebsocketToken.ts">
import http from '@/api/http';

interface Response {
    token: string;
    socket: string;
}

export default (server: string): Promise<Response> => {
    return new Promise((resolve, reject) => {
        http.get(`/api/client/servers/${server}/websocket`)
            .then(({ data }) =>
                resolve({
                    token: data.data.token,
                    socket: data.data.socket,
                })
            )
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/reinstallServer.ts">
import http from '@/api/http';

export default (uuid: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post(`/api/client/servers/${uuid}/settings/reinstall`)
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/renameServer.ts">
import http from '@/api/http';

export default (uuid: string, name: string, description?: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post(`/api/client/servers/${uuid}/settings/rename`, { name, description })
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/renewServer.ts">
import http from '@/api/http';

export default (uuid: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post(`/api/client/servers/${uuid}/renew`)
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/server/setSelectedDockerImage.ts">
import http from '@/api/http';

export default async (uuid: string, image: string): Promise<void> => {
    await http.put(`/api/client/servers/${uuid}/settings/docker-image`, { docker_image: image });
};
</file>

<file path="resources/scripts/api/server/types.d.ts">
export type ServerStatus =
    | 'installing'
    | 'install_failed'
    | 'reinstall_failed'
    | 'suspended'
    | 'restoring_backup'
    | null;

export interface ServerBackup {
    uuid: string;
    isSuccessful: boolean;
    isLocked: boolean;
    name: string;
    ignoredFiles: string;
    checksum: string;
    bytes: number;
    createdAt: Date;
    completedAt: Date | null;
}

export interface ServerEggVariable {
    name: string;
    description: string;
    envVariable: string;
    defaultValue: string;
    serverValue: string;
    isEditable: boolean;
    rules: string[];
}
</file>

<file path="resources/scripts/api/server/updateStartupVariable.ts">
import http from '@/api/http';
import { ServerEggVariable } from '@/api/server/types';
import { rawDataToServerEggVariable } from '@/api/transformers';

export default async (uuid: string, key: string, value: string): Promise<[ServerEggVariable, string]> => {
    const { data } = await http.put(`/api/client/servers/${uuid}/startup/variable`, { key, value });

    return [rawDataToServerEggVariable(data), data.meta.startup_command];
};
</file>

<file path="resources/scripts/api/store/gateways/paypal.ts">
import http from '@/api/http';

export default (amount: number): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post('/api/client/store/paypal', { amount })
            .then((data) => {
                resolve(data.data || []);
            })
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/store/gateways/stripe.ts">
import http from '@/api/http';

export default (amount: number): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post('/api/client/store/stripe', { amount })
            .then((data) => {
                resolve(data.data || []);
            })
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/store/createServer.ts">
import http from '@/api/http';

interface Params {
    name: string;
    description: string | null;
    cpu: number;
    memory: number;
    disk: number;
    ports: number;
    backups: number | null;
    databases: number | null;

    egg: number | null;
    nest: number | null;
    node: number | null;
}

interface Data {
    success: boolean;
    id: string;
}

export default (params: Params, egg: number, nest: number, node: number): Promise<Data> => {
    return new Promise((resolve, reject) => {
        http.post('/api/client/store/create', { ...params, egg, nest, node })
            .then((data) => resolve(data.data))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/store/getCosts.ts">
import http, { FractalResponseData } from '@/api/http';

export interface Costs {
    cpu: number;
    memory: number;
    disk: number;
    slots: number;
    ports: number;
    backups: number;
    databases: number;
}

export const rawDataToCosts = ({ attributes: data }: FractalResponseData): Costs => ({
    cpu: data.cpu,
    memory: data.memory,
    disk: data.disk,
    slots: data.slots,
    ports: data.ports,
    backups: data.backups,
    databases: data.databases,
});

export const getCosts = async (): Promise<Costs> => {
    return new Promise((resolve, reject) => {
        http.get('/api/client/store/costs')
            .then(({ data }) => resolve(rawDataToCosts(data)))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/store/getEggs.ts">
import http from '@/api/http';

export interface Egg {
    id: number;
    name: string;
    dockerImages: string[];
}

export const rawDataToEgg = (data: any): Egg => ({
    id: data.id,
    name: data.name,
    dockerImages: data.docker_images,
});

export const getEggs = async (id?: number): Promise<Egg[]> => {
    return new Promise((resolve, reject) => {
        http.post('/api/client/store/eggs', { id })
            .then(({ data }) => resolve((data.data || []).map((d: any) => rawDataToEgg(d.attributes))))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/store/getNests.ts">
import http from '@/api/http';

export interface Nest {
    id: number;
    name: string;
}

export const rawDataToNest = (data: any): Nest => ({
    id: data.id,
    name: data.name,
});

export const getNests = async (): Promise<Nest[]> => {
    return new Promise((resolve, reject) => {
        http.get('/api/client/store/nests')
            .then(({ data }) => resolve((data.data || []).map((d: any) => rawDataToNest(d.attributes))))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/store/getNodes.ts">
import http from '@/api/http';

export interface Node {
    id: number;
    name: string;
    deployFee: number;
    location: string;
    total: number;
    used: number;
}

export const rawDataToNode = (data: any): Node => ({
    id: data.id,
    name: data.name,
    deployFee: data.deploy_fee,
    location: data.location,
    total: data.total,
    used: data.used,
});

export const getNodes = async (): Promise<Node[]> => {
    return new Promise((resolve, reject) => {
        http.get('/api/client/store/nodes')
            .then(({ data }) => resolve((data.data || []).map((d: any) => rawDataToNode(d.attributes))))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/store/getResources.ts">
import http, { FractalResponseData } from '@/api/http';

export interface Resources {
    balance: number;
    cpu: number;
    memory: number;
    disk: number;
    slots: number;
    ports: number;
    backups: number;
    databases: number;
}

export const rawDataToResources = ({ attributes: data }: FractalResponseData): Resources => ({
    balance: data.balance,
    cpu: data.cpu,
    memory: data.memory,
    disk: data.disk,
    slots: data.slots,
    ports: data.ports,
    backups: data.backups,
    databases: data.databases,
});

export const getResources = async (): Promise<Resources> => {
    return new Promise((resolve, reject) => {
        http.get('/api/client/store')
            .then(({ data }) => resolve(rawDataToResources(data)))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/store/purchaseResource.ts">
import http from '@/api/http';

export default (resource: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        http.post('/api/client/store/resources', { resource })
            .then(() => resolve())
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/swr/getServerAllocations.ts">
import useSWR from 'swr';
import http from '@/api/http';
import { ServerContext } from '@/state/server';
import { Allocation } from '@/api/server/getServer';
import { rawDataToServerAllocation } from '@/api/transformers';

export default () => {
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);

    return useSWR<Allocation[]>(
        ['server:allocations', uuid],
        async () => {
            const { data } = await http.get(`/api/client/servers/${uuid}/network/allocations`);

            return (data.data || []).map(rawDataToServerAllocation);
        },
        { revalidateOnFocus: false, revalidateOnMount: false }
    );
};
</file>

<file path="resources/scripts/api/swr/getServerBackups.ts">
import useSWR from 'swr';
import { ServerContext } from '@/state/server';
import { ServerBackup } from '@/api/server/types';
import { createContext, useContext } from 'react';
import { rawDataToServerBackup } from '@/api/transformers';
import http, { getPaginationSet, PaginatedResult } from '@/api/http';

interface ctx {
    page: number;
    setPage: (value: number | ((s: number) => number)) => void;
}

export const Context = createContext<ctx>({ page: 1, setPage: () => 1 });

type BackupResponse = PaginatedResult<ServerBackup> & { backupCount: number };

export default () => {
    const { page } = useContext(Context);
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);

    return useSWR<BackupResponse>(['server:backups', uuid, page], async () => {
        const { data } = await http.get(`/api/client/servers/${uuid}/backups`, { params: { page } });

        return {
            items: (data.data || []).map(rawDataToServerBackup),
            pagination: getPaginationSet(data.meta.pagination),
            backupCount: data.meta.backup_count,
        };
    });
};
</file>

<file path="resources/scripts/api/swr/getServerStartup.ts">
import useSWR, { ConfigInterface } from 'swr';
import http, { FractalResponseList } from '@/api/http';
import { ServerEggVariable } from '@/api/server/types';
import { rawDataToServerEggVariable } from '@/api/transformers';

interface Response {
    invocation: string;
    variables: ServerEggVariable[];
    dockerImages: Record<string, string>;
}

export default (uuid: string, initialData?: Response | null, config?: ConfigInterface<Response>) =>
    useSWR(
        [uuid, '/startup'],
        async (): Promise<Response> => {
            const { data } = await http.get(`/api/client/servers/${uuid}/startup`);

            const variables = ((data as FractalResponseList).data || []).map(rawDataToServerEggVariable);

            return {
                variables,
                invocation: data.meta.startup_command,
                dockerImages: data.meta.docker_images || {},
            };
        },
        { initialData: initialData || undefined, errorRetryCount: 3, ...(config || {}) }
    );
</file>

<file path="resources/scripts/api/getServers.ts">
import http, { getPaginationSet, PaginatedResult } from '@/api/http';
import { rawDataToServerObject, Server } from '@/api/server/getServer';

interface QueryParams {
    query?: string;
    page?: number;
    type?: string;
}

export default ({ query, ...params }: QueryParams): Promise<PaginatedResult<Server>> => {
    return new Promise((resolve, reject) => {
        http.get('/api/client', {
            params: {
                'filter[*]': query,
                ...params,
            },
        })
            .then(({ data }) =>
                resolve({
                    items: (data.data || []).map((datum: any) => rawDataToServerObject(datum)),
                    pagination: getPaginationSet(data.meta.pagination),
                })
            )
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/getSystemPermissions.ts">
import http from '@/api/http';
import { PanelPermissions } from '@/state/permissions';

export default (): Promise<PanelPermissions> => {
    return new Promise((resolve, reject) => {
        http.get('/api/client/permissions')
            .then(({ data }) => resolve(data.attributes.permissions))
            .catch(reject);
    });
};
</file>

<file path="resources/scripts/api/http.ts">
import { store } from '@/state';
import axios, { AxiosInstance } from 'axios';

const http: AxiosInstance = axios.create({
    withCredentials: true,
    timeout: 20000,
    headers: {
        'X-Requested-With': 'XMLHttpRequest',
        Accept: 'application/json',
        'Content-Type': 'application/json',
    },
});

http.interceptors.request.use((req) => {
    if (!req.url?.endsWith('/resources')) {
        store.getActions().progress.startContinuous();
    }

    return req;
});

http.interceptors.response.use(
    (resp) => {
        if (!resp.request?.url?.endsWith('/resources')) {
            store.getActions().progress.setComplete();
        }

        return resp;
    },
    (error) => {
        store.getActions().progress.setComplete();

        throw error;
    }
);

export default http;

/**
 * Converts an error into a human readable response. Mostly just a generic helper to
 * make sure we display the message from the server back to the user if we can.
 */
export function httpErrorToHuman(error: any): string {
    if (error.response && error.response.data) {
        let { data } = error.response;

        // Some non-JSON requests can still return the error as a JSON block. In those cases, attempt
        // to parse it into JSON so we can display an actual error.
        if (typeof data === 'string') {
            try {
                data = JSON.parse(data);
            } catch (e) {
                // do nothing, bad json
            }
        }

        if (data.errors && data.errors[0] && data.errors[0].detail) {
            return data.errors[0].detail;
        }

        // Errors from wings directory, mostly just for file uploads.
        if (data.error && typeof data.error === 'string') {
            return data.error;
        }
    }

    return error.message;
}

export interface FractalResponseData {
    object: string;
    attributes: {
        [k: string]: any;
        relationships?: Record<string, FractalResponseData | FractalResponseList | null | undefined>;
    };
}

export interface FractalResponseList {
    object: 'list';
    data: FractalResponseData[];
}

export interface FractalPaginatedResponse extends FractalResponseList {
    meta: {
        pagination: {
            total: number;
            count: number;
            /* eslint-disable camelcase */
            per_page: number;
            current_page: number;
            total_pages: number;
            /* eslint-enable camelcase */
        };
    };
}

export interface PaginatedResult<T> {
    items: T[];
    pagination: PaginationDataSet;
}

export interface PaginationDataSet {
    total: number;
    count: number;
    perPage: number;
    currentPage: number;
    totalPages: number;
}

export function getPaginationSet(data: any): PaginationDataSet {
    return {
        total: data.total,
        count: data.count,
        perPage: data.per_page,
        currentPage: data.current_page,
        totalPages: data.total_pages,
    };
}

type QueryBuilderFilterValue = string | number | boolean | null;

export interface QueryBuilderParams<FilterKeys extends string = string, SortKeys extends string = string> {
    page?: number;
    filters?: {
        [K in FilterKeys]?: QueryBuilderFilterValue | Readonly<QueryBuilderFilterValue[]>;
    };
    sorts?: {
        [K in SortKeys]?: -1 | 0 | 1 | 'asc' | 'desc' | null;
    };
}

/**
 * Helper function that parses a data object provided and builds query parameters
 * for the Laravel Query Builder package automatically. This will apply sorts and
 * filters deterministically based on the provided values.
 */
export const withQueryBuilderParams = (data?: QueryBuilderParams): Record<string, unknown> => {
    if (!data) return {};

    const filters = Object.keys(data.filters || {}).reduce((obj, key) => {
        const value = data.filters?.[key];

        return !value || value === '' ? obj : { ...obj, [`filter[${key}]`]: value };
    }, {} as NonNullable<QueryBuilderParams['filters']>);

    const sorts = Object.keys(data.sorts || {}).reduce((arr, key) => {
        const value = data.sorts?.[key];
        if (!value || !['asc', 'desc', 1, -1].includes(value)) {
            return arr;
        }

        return [...arr, (value === -1 || value === 'desc' ? '-' : '') + key];
    }, [] as string[]);

    return {
        ...filters,
        sort: !sorts.length ? undefined : sorts.join(','),
        page: data.page,
    };
};
</file>

<file path="resources/scripts/api/interceptors.ts">
import http from '@/api/http';
import { History } from 'history';
import { AxiosError } from 'axios';

export const setupInterceptors = (history: History) => {
    http.interceptors.response.use(
        (resp) => resp,
        (error: AxiosError) => {
            if (error.response?.status === 400) {
                if (
                    (error.response?.data as Record<string, any>).errors?.[0].code === 'TwoFactorAuthRequiredException'
                ) {
                    if (!window.location.pathname.startsWith('/account')) {
                        history.replace('/account', { twoFactorRedirect: true });
                    }
                }
            }
            throw error;
        }
    );
};
</file>

<file path="resources/scripts/api/transformers.ts">
import { FractalResponseData } from '@/api/http';
import { Allocation } from '@/api/server/getServer';
import { FileObject } from '@/api/server/files/loadDirectory';
import { ServerBackup, ServerEggVariable } from '@/api/server/types';

export const rawDataToServerAllocation = (data: FractalResponseData): Allocation => ({
    id: data.attributes.id,
    ip: data.attributes.ip,
    alias: data.attributes.ip_alias,
    port: data.attributes.port,
    notes: data.attributes.notes,
    isDefault: data.attributes.is_default,
});

export const rawDataToFileObject = (data: FractalResponseData): FileObject => ({
    key: `${data.attributes.is_file ? 'file' : 'dir'}_${data.attributes.name}`,
    name: data.attributes.name,
    mode: data.attributes.mode,
    modeBits: data.attributes.mode_bits,
    size: Number(data.attributes.size),
    isFile: data.attributes.is_file,
    isSymlink: data.attributes.is_symlink,
    mimetype: data.attributes.mimetype,
    createdAt: new Date(data.attributes.created_at),
    modifiedAt: new Date(data.attributes.modified_at),

    isArchiveType: function () {
        return (
            this.isFile &&
            [
                'application/vnd.rar', // .rar
                'application/x-rar-compressed', // .rar (2)
                'application/x-tar', // .tar
                'application/x-br', // .tar.br
                'application/x-bzip2', // .tar.bz2, .bz2
                'application/gzip', // .tar.gz, .gz
                'application/x-gzip',
                'application/x-lzip', // .tar.lz4, .lz4 (not sure if this mime type is correct)
                'application/x-sz', // .tar.sz, .sz (not sure if this mime type is correct)
                'application/x-xz', // .tar.xz, .xz
                'application/zstd', // .tar.zst, .zst
                'application/zip', // .zip
            ].indexOf(this.mimetype) >= 0
        );
    },

    isEditable: function () {
        if (this.isArchiveType() || !this.isFile) return false;

        const matches = ['application/jar', 'application/octet-stream', 'inode/directory', /^image\//];

        return matches.every((m) => !this.mimetype.match(m));
    },
});

export const rawDataToServerBackup = ({ attributes }: FractalResponseData): ServerBackup => ({
    uuid: attributes.uuid,
    isSuccessful: attributes.is_successful,
    isLocked: attributes.is_locked,
    name: attributes.name,
    ignoredFiles: attributes.ignored_files,
    checksum: attributes.checksum,
    bytes: attributes.bytes,
    createdAt: new Date(attributes.created_at),
    completedAt: attributes.completed_at ? new Date(attributes.completed_at) : null,
});

export const rawDataToServerEggVariable = ({ attributes }: FractalResponseData): ServerEggVariable => ({
    name: attributes.name,
    description: attributes.description,
    envVariable: attributes.env_variable,
    defaultValue: attributes.default_value,
    serverValue: attributes.server_value,
    isEditable: attributes.is_editable,
    rules: attributes.rules.split('|'),
});
</file>

<file path="resources/scripts/assets/css/GlobalStylesheet.ts">
import tw from 'twin.macro';
import { createGlobalStyle } from 'styled-components/macro';

export default createGlobalStyle`
    body {
        ${tw`bg-neutral-900 font-sans font-medium text-gray-200`};
    }

    h1, h2, h3, h4, h5, h6 {
        ${tw`tracking-normal`};
    }

    p {
        ${tw`leading-snug`};
    }

    form {
        ${tw`m-0`};
    }

    textarea, select, input, button, button:focus, button:focus-visible {
        ${tw`outline-none`};
    }

    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
        -webkit-appearance: none !important;
        margin: 0;
    }

    input[type=number] {
        -moz-appearance: textfield !important;
    }

    /* Scroll Bar Style */
    ::-webkit-scrollbar {
        background: none;
        width: 16px;
        height: 16px;
    }

    ::-webkit-scrollbar-thumb {
        border: solid 0 rgb(0 0 0 / 0%);
        border-right-width: 4px;
        border-left-width: 4px;
        -webkit-border-radius: 9px 4px;
        -webkit-box-shadow: inset 0 0 0 1px hsl(211, 10%, 53%), inset 0 0 0 4px hsl(209deg 18% 30%);
    }

    ::-webkit-scrollbar-track-piece {
        margin: 4px 0;
    }

    ::-webkit-scrollbar-thumb:horizontal {
        border-right-width: 0;
        border-left-width: 0;
        border-top-width: 4px;
        border-bottom-width: 4px;
        -webkit-border-radius: 4px 9px;
    }

    ::-webkit-scrollbar-corner {
        background: transparent;
    }
`;
</file>

<file path="resources/scripts/assets/images/discord.svg">
<svg width="71" height="55" viewBox="0 0 71 55" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0)">
<path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z" fill="#5865F2"/>
</g>
<defs>
<clipPath id="clip0">
<rect width="71" height="55" fill="white"/>
</clipPath>
</defs>
</svg>
</file>

<file path="resources/scripts/assets/images/divide_square.svg">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8b8000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-divide-square"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="8" y1="12" x2="16" y2="12"></line><line x1="12" y1="16" x2="12" y2="16"></line><line x1="12" y1="8" x2="12" y2="8"></line></svg>
</file>

<file path="resources/scripts/assets/images/not_found.svg">
<svg id="a706cf1c-1654-439b-8fcf-310eb7aa0e00" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" width="1120.59226" height="777.91584" viewBox="0 0 1120.59226 777.91584"><title>not found</title><circle cx="212.59226" cy="103" r="64" fill="#ff6584"/><path d="M563.68016,404.16381c0,151.01141-89.77389,203.73895-200.51559,203.73895S162.649,555.17522,162.649,404.16381,363.16457,61.04208,363.16457,61.04208,563.68016,253.1524,563.68016,404.16381Z" transform="translate(-39.70387 -61.04208)" fill="#f2f2f2"/><polygon points="316.156 523.761 318.21 397.378 403.674 241.024 318.532 377.552 319.455 320.725 378.357 207.605 319.699 305.687 319.699 305.687 321.359 203.481 384.433 113.423 321.621 187.409 322.658 0 316.138 248.096 316.674 237.861 252.547 139.704 315.646 257.508 309.671 371.654 309.493 368.625 235.565 265.329 309.269 379.328 308.522 393.603 308.388 393.818 308.449 394.99 293.29 684.589 313.544 684.589 315.974 535.005 389.496 421.285 316.156 523.761" fill="#3f3d56"/><path d="M1160.29613,466.01367c0,123.61-73.4842,166.77-164.13156,166.77s-164.13156-43.16-164.13156-166.77S996.16457,185.15218,996.16457,185.15218,1160.29613,342.40364,1160.29613,466.01367Z" transform="translate(-39.70387 -61.04208)" fill="#f2f2f2"/><polygon points="950.482 552.833 952.162 449.383 1022.119 321.4 952.426 433.154 953.182 386.639 1001.396 294.044 953.382 374.329 953.382 374.329 954.741 290.669 1006.369 216.952 954.954 277.514 955.804 124.11 950.467 327.188 950.906 318.811 898.414 238.464 950.064 334.893 945.173 428.327 945.027 425.847 884.514 341.294 944.844 434.608 944.232 446.293 944.123 446.469 944.173 447.428 931.764 684.478 948.343 684.478 950.332 562.037 1010.514 468.952 950.482 552.833" fill="#3f3d56"/><ellipse cx="554.59226" cy="680.47903" rx="554.59226" ry="28.03433" fill="#3f3d56"/><ellipse cx="892.44491" cy="726.79663" rx="94.98858" ry="4.80162" fill="#3f3d56"/><ellipse cx="548.71959" cy="773.11422" rx="94.98858" ry="4.80162" fill="#3f3d56"/><ellipse cx="287.94432" cy="734.27887" rx="217.01436" ry="10.96996" fill="#3f3d56"/><circle cx="97.08375" cy="566.26982" r="79" fill="#2f2e41"/><rect x="99.80546" y="689.02332" width="24" height="43" transform="translate(-31.32451 -62.31008) rotate(0.67509)" fill="#2f2e41"/><rect x="147.80213" y="689.58887" width="24" height="43" transform="translate(-31.31452 -62.87555) rotate(0.67509)" fill="#2f2e41"/><ellipse cx="119.54569" cy="732.61606" rx="7.5" ry="20" transform="translate(-654.1319 782.47948) rotate(-89.32491)" fill="#2f2e41"/><ellipse cx="167.55414" cy="732.18168" rx="7.5" ry="20" transform="translate(-606.25475 830.05533) rotate(-89.32491)" fill="#2f2e41"/><circle cx="99.31925" cy="546.29477" r="27" fill="#fff"/><circle cx="99.31925" cy="546.29477" r="9" fill="#3f3d56"/><path d="M61.02588,552.94636c-6.04185-28.64075,14.68758-57.26483,46.30049-63.93367s62.13813,11.14292,68.18,39.78367-14.97834,38.93-46.59124,45.59886S67.06774,581.58712,61.02588,552.94636Z" transform="translate(-39.70387 -61.04208)" fill="#0967d3"/><path d="M257.29613,671.38411c0,55.07585-32.73985,74.3063-73.13,74.3063q-1.40351,0-2.80255-.0312c-1.87139-.04011-3.72494-.1292-5.55619-.254-36.45135-2.57979-64.77127-22.79937-64.77127-74.02113,0-53.00843,67.73872-119.89612,72.827-124.84633l.00892-.00889c.19608-.19159.29409-.28516.29409-.28516S257.29613,616.30827,257.29613,671.38411Z" transform="translate(-39.70387 -61.04208)" fill="#0967d3"/><path d="M181.50168,737.26482l26.747-37.37367-26.81386,41.4773-.07125,4.29076c-1.87139-.04011-3.72494-.1292-5.55619-.254l2.88282-55.10258-.0223-.42775.049-.0802.27179-5.20415-26.88076-41.5798,26.96539,37.67668.06244,1.105,2.17874-41.63324-23.0132-42.96551,23.29391,35.6583,2.26789-86.31419.00892-.294v.28516l-.37871,68.064,22.91079-26.98321-23.00435,32.84678-.60595,37.27566L204.18523,621.958l-21.4805,41.259-.33863,20.723,31.05561-49.79149-31.17146,57.023Z" transform="translate(-39.70387 -61.04208)" fill="#3f3d56"/><circle cx="712.48505" cy="565.41532" r="79" fill="#2f2e41"/><rect x="741.77716" y="691.82355" width="24" height="43" transform="translate(-215.99457 191.86399) rotate(-17.08345)" fill="#2f2e41"/><rect x="787.6593" y="677.72286" width="24" height="43" transform="matrix(0.95588, -0.29376, 0.29376, 0.95588, -209.82788, 204.72037)" fill="#2f2e41"/><ellipse cx="767.887" cy="732.00275" rx="20" ry="7.5" transform="translate(-220.8593 196.83312) rotate(-17.08345)" fill="#2f2e41"/><ellipse cx="813.47537" cy="716.94619" rx="20" ry="7.5" transform="translate(-214.42477 209.56103) rotate(-17.08345)" fill="#2f2e41"/><circle cx="708.52153" cy="545.71023" r="27" fill="#fff"/><circle cx="708.52153" cy="545.71023" r="9" fill="#3f3d56"/><path d="M657.35526,578.74316c-14.48957-25.43323-3.47841-59.016,24.59412-75.0092s62.57592-8.34055,77.06549,17.09268-2.39072,41.6435-30.46325,57.63671S671.84483,604.17639,657.35526,578.74316Z" transform="translate(-39.70387 -61.04208)" fill="#0967d3"/><path d="M611.29613,661.29875c0,50.55711-30.05368,68.20979-67.13,68.20979q-1.28835,0-2.57261-.02864c-1.71785-.03682-3.41933-.1186-5.10033-.23313-33.46068-2.36813-59.45707-20.92878-59.45707-67.948,0-48.65932,62.18106-110.05916,66.85186-114.60322l.00819-.00817c.18-.17587.27-.26177.27-.26177S611.29613,610.74164,611.29613,661.29875Z" transform="translate(-39.70387 -61.04208)" fill="#0967d3"/><path d="M541.72029,721.77424l24.55253-34.30732-24.6139,38.07426-.0654,3.93872c-1.71785-.03682-3.41933-.1186-5.10033-.23313l2.6463-50.58165-.02047-.39266.045-.07361.24949-4.77718-24.67531-38.16836,24.753,34.58547.05731,1.01433,2-38.21741-21.12507-39.44039L541.80616,625.928l2.08182-79.23247.00819-.26994v.26177l-.34764,62.47962,21.031-24.76934-21.11693,30.15184-.55624,34.21735,19.63634-32.839-19.71812,37.87389-.31085,19.0228,28.50763-45.70631-28.614,52.34448Z" transform="translate(-39.70387 -61.04208)" fill="#3f3d56"/><path d="M875.29613,682.38411c0,55.07585-32.73985,74.3063-73.13,74.3063q-1.4035,0-2.80255-.0312c-1.87139-.04011-3.72494-.1292-5.55619-.254-36.45135-2.57979-64.77127-22.79937-64.77127-74.02113,0-53.00843,67.73872-119.89612,72.827-124.84633l.00892-.00889c.19608-.19159.29409-.28516.29409-.28516S875.29613,627.30827,875.29613,682.38411Z" transform="translate(-39.70387 -61.04208)" fill="#0967d3"/><path d="M799.50168,748.26482l26.747-37.37367-26.81386,41.4773-.07125,4.29076c-1.87139-.04011-3.72494-.1292-5.55619-.254l2.88282-55.10258-.0223-.42775.049-.0802.27179-5.20415L770.108,654.01076l26.96539,37.67668.06244,1.105,2.17874-41.63324-23.0132-42.96551,23.29391,35.6583,2.26789-86.31419.00892-.294v.28516l-.37871,68.064,22.91079-26.98321-23.00435,32.84678-.606,37.27566L822.18523,632.958l-21.4805,41.259-.33863,20.723,31.05561-49.79149-31.17146,57.023Z" transform="translate(-39.70387 -61.04208)" fill="#3f3d56"/><ellipse cx="721.51694" cy="656.82212" rx="12.40027" ry="39.5" transform="translate(-220.83517 966.22323) rotate(-64.62574)" fill="#2f2e41"/><ellipse cx="112.51694" cy="651.82212" rx="12.40027" ry="39.5" transform="translate(-574.07936 452.71367) rotate(-68.15829)" fill="#2f2e41"/></svg>
</file>

<file path="resources/scripts/assets/images/plus_square.svg">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="green" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus-square"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
</file>

<file path="resources/scripts/assets/images/pterodactyl.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1280 1280"><defs><style>.cls-1{fill:#904a04;}.cls-2{fill:#b26734;}.cls-3{fill:#6d3c0f;}.cls-4{fill:#bd6e35;}.cls-5{fill:#a56032;}.cls-6{fill:#3a3a3a;}.cls-7{fill:#444;}.cls-8{fill:#515151;}.cls-9{fill:#303030;}.cls-10{fill:#aaa;}.cls-11{fill:#a4571f;}.cls-12{fill:#824009;}.cls-13{fill:#3f3f3f;}.cls-14{fill:#cb63d3;}.cls-15{fill:#b25f8c;}.cls-16{fill:#fff;}.cls-17{fill:#91562d;}.cls-18{fill:#232323;}.cls-19{fill:#161616;}.cls-20{fill:#7c441e;}.cls-21{fill:none;}.cls-22{fill:#ffc33e;}</style></defs><title>Artboard 1</title><g id="Layer_1" data-name="Layer 1"><path class="cls-1" d="M921.82,627.73s-2,9.07-2,10.58-52.4-4.53-52.4-4.53l2-16.63Z"/><path class="cls-1" d="M912.81,623.68s-133.07-39.78-190.5-29.2-20.22,41.57-20.22,41.57Z"/><path class="cls-1" d="M385.21,629.24s2,9.07,2,10.58,52.39-4.53,52.39-4.53l-2-16.63Z"/><path class="cls-1" d="M394.22,625.2S527.29,585.41,584.72,596s20.22,41.57,20.22,41.57Z"/><ellipse class="cls-2" cx="661.81" cy="721.44" rx="243.34" ry="123.94"/><path class="cls-2" d="M589.26,603.55,454.74,624.71,368,638l-23.38,24v42.51l4.43,52.9,73.33,26.45,57.09,3.78C462.74,617.52,589.26,603.55,589.26,603.55Z"/><path class="cls-3" d="M522.41,738.07s-27.2-42.32-98.24-19.65,39.3,42.32,39.3,42.32Z"/><path class="cls-3" d="M318.71,1082.18s47-52.34,153.74-60.78c41.82-3.3,32,94.78,32,94.78l71.24-63.61L715,1063.91l56.45,41.57s36.09-89.36,104.91-87.51,110.37,56.44,110.37,56.44l-87.43-276H393.23Z"/><path class="cls-2" d="M780.61,864.53c-28.25,116.39-35.37,236-124.87,236-89.31,0-95.6-107.1-120.18-226.8-22.46-109.4,48.38-182.41,120.18-182.41a131.4,131.4,0,0,1,65.58,18.13C766.57,735.84,798.71,790,780.61,864.53Z"/><path class="cls-4" d="M744.93,895.92c0,84.15-58.69,177.73-102.78,158.55-46.3-20.16-70.81-80-80-167.2-8.77-83.21,44.22-144.88,90.28-144.88S744.93,811.76,744.93,895.92Z"/><path class="cls-2" d="M717.77,602,852.29,623.2,939,636.44l23.38,24v42.51L958,755.82l-73.33,26.45-57.09,3.78C844.29,616,717.77,602,717.77,602Z"/><polygon class="cls-5" points="563.56 608.08 616.06 721.44 669 777 712 717 761.56 608.08 689.56 595.99 619.46 601.18 563.56 608.08"/><path class="cls-6" d="M773.17,783.34s13.81,71.11-13.4,80.18-52.9-58.95-52.9-58.95H649.44l-1.52-36.27,93.71-18.14Z"/><path class="cls-6" d="M541.09,783.34s-13.8,71.11,13.4,80.18,52.9-58.95,52.9-58.95h57.44l1.51-36.27-93.71-18.14Z"/><polygon class="cls-7" points="568.1 797.01 581.7 787.95 587.75 780.39 726.8 780.39 731.33 787.95 743.42 793.99 734.35 751.67 642.16 745.63 580.19 751.67 568.1 797.01"/><path class="cls-8" d="M772.48,760.11s7.55,32.49-15.12,39.26-30.26-40.1-30.26-40.1l16.66-4.58Z"/><path class="cls-8" d="M540.89,760.11S533.33,792.6,556,799.37s30.26-40.1,30.26-40.1l-16.66-4.58Z"/><polygon class="cls-9" points="686.19 732.02 747.96 732.02 773.65 760.74 746.45 762.25 713.19 757.72 687.5 760.74 686.19 732.02"/><polygon class="cls-9" points="628.55 732.02 566.78 732.02 541.09 760.74 568.3 762.25 601.55 757.72 627.24 760.74 628.55 732.02"/><polygon class="cls-8" points="687.5 760.74 625.53 760.74 611.93 732.02 704.13 732.02 687.5 760.74"/><circle class="cls-10" cx="685.99" cy="742.6" r="4.53"/><rect class="cls-10" x="649.71" y="751.67" width="15.11" height="3.02" rx="1"/><path class="cls-6" d="M559.56,793.1a79.75,79.75,0,0,0,9-27.76c.12-1-1.39-1-1.51,0a77.43,77.43,0,0,1-8.75,27c-.46.85.84,1.62,1.31.76Z"/><path class="cls-6" d="M754.31,792.34a77.41,77.41,0,0,1-8.74-27c-.13-1-1.64-1-1.51,0a79.33,79.33,0,0,0,9,27.76c.46.86,1.76.1,1.3-.76Z"/><path class="cls-11" d="M602.82,745.76c-132.25,128.47-160.43,380.45-160.43,380.45s-25.51-114.06-51-118.31c-34-5.67-71.95,69.74-71.95,69.74s34.32-140.44,22-189.87c-11.57-46.59-74.6-117.53-36.82-204.43,0,0,33.58-55,118.44-63,0,0-261.1,79.46,172.81,121.66h14.48Z"/><path class="cls-1" d="M567.57,761.87c-105.22,102.21-126.14,312.31-126.14,312.31s-23.94-90.75-44.23-94.13c-27.05-4.51-59.07,54.76-59.07,54.76s36.2-113.48,19.36-150.34C308.38,777,305.36,747.88,309.93,719.6c0,0,.08-51.55,49.69-73.86,0,0-142.7,76.88,202.53,110.46h11.39Z"/><path class="cls-3" d="M793.68,736.56s27.21-42.32,98.25-19.65-39.3,42.32-39.3,42.32Z"/><path class="cls-11" d="M704.21,744.24C836.46,872.72,864.64,1124.7,864.64,1124.7s25.51-114.07,51-118.32c34-5.66,72,69.75,72,69.75s-34.32-140.44-22-189.87c11.57-46.59,74.6-117.53,36.82-204.44,0,0-33.58-55-118.44-63,0,0,261.1,79.46-172.81,121.66H696.65Z"/><path class="cls-1" d="M739.46,760.36C844.68,862.57,865.6,1072.67,865.6,1072.67s23.93-90.75,44.22-94.14c27.06-4.51,59.08,54.77,59.08,54.77S932.69,919.82,949.53,883c49.12-107.52,52.14-136.59,47.57-164.87,0,0-.08-51.55-49.69-73.86,0,0,142.7,76.88-202.54,110.45H733.49Z"/><path class="cls-5" d="M487,619s21.91,42,107,42c4,0-8.89-6.4-8.89-6.4s-54.91,3.14-89.39-36.34C492,614,487,619,487,619Z"/><polygon class="cls-11" points="382.68 719.43 382.68 758.27 401.54 725.13 382.68 719.43"/><polygon class="cls-11" points="370.89 711.17 370.89 739.25 384.53 715.28 370.89 711.17"/><polygon class="cls-11" points="924.35 717.92 924.35 756.76 905.49 723.62 924.35 717.92"/><polygon class="cls-11" points="936.13 709.65 936.13 737.74 922.5 713.77 936.13 709.65"/><polygon class="cls-12" points="566.97 594.28 563.23 607.64 595.3 608.08 596.81 595.99 566.97 594.28"/><polygon class="cls-12" points="762.51 593.34 761.41 608.33 734.01 603.03 735.87 591.46 762.51 593.34"/><path class="cls-2" d="M613.09,1109c-12.68,37.21-21.62,63.4-41.79,63.4s-41.1-36.76-41.1-76.07,18.34-89.89,38.52-89.89S627.26,1067.41,613.09,1109Z"/><polygon class="cls-2" points="592.69 1188.11 550.72 1184.29 561.64 1152.63 589.21 1151.51 592.69 1188.11"/><path class="cls-11" d="M551.92,1180.8l40.58,5.38L610.91,1232c-45.11-49.36-90.21-7.08-90.21-7.08Z"/><path class="cls-11" d="M554.24,1201.83s-13.69,20.19-9,30.17l15.11-15.08,17.82-15.09Z"/><path class="cls-2" d="M698.85,1101.89c11.18,37.68,15.83,65.09,36,65.09s41.1-36.76,41.1-76.07S757.6,1001,737.43,1001,686.57,1060.49,698.85,1101.89Z"/><polygon class="cls-2" points="713.46 1182.72 755.42 1178.9 744.5 1147.24 716.94 1146.12 713.46 1182.72"/><path class="cls-11" d="M754.22,1175.41l-40.58,5.38-18.4,45.82c45.1-49.36,90.21-7.09,90.21-7.09Z"/><path class="cls-11" d="M748.5,1197.17s13.7,20.19,9,30.17l-15.12-15.09-17.82-15.08Z"/><rect class="cls-13" x="569.61" y="657.45" width="43.83" height="19.65" rx="6.17"/><path class="cls-9" d="M800.74,296.09s0-10.5-21.38-13.65c-8.72-1.29-59.12-.7-59.12-.7l-15.68-34.6s69.52.8,91.42,11.49S813,286,811,303.1"/><path class="cls-9" d="M485.42,316.6s-1.39-10.41,19.43-16.31c8.48-2.4,58.53-8.35,58.53-8.35L583.82,255s-78.21,10.41-98.54,23.84-13.3,29.32-9.12,46"/><path class="cls-2" d="M560.77,567.57c-1.3,4,4.4,10.16,6.51,12.81,16.61,20.85,29.62,44.28,44.26,66.55,6.38,9.71,46.93,69.27,59.36,56.05,21.16-22.5,36.75-50.25,52-77,16-28.08,30.2-57.4,39.11-88.55a8.31,8.31,0,0,0,.46-3.23c-1-8.41-37.28-9.1-44.15-10.15l-20.82-3.2c-1.88-.29-6.68-2-8.53-1.31l-97.35,36.15-19.31,7.17c-2.64,1-9.83,1.41-11.26,4.11A3.76,3.76,0,0,0,560.77,567.57Z"/><polygon class="cls-11" points="574.86 574.98 632.37 665.52 646.49 677.97 664.23 693.47 681.83 675.67 732.15 596.66 758.37 534.08 685.27 523.98 574.86 574.98"/><polyline class="cls-14" points="721.26 601.57 598.84 595.53 630.58 660.52 642.67 672.61 659.29 686.21 669.87 677.14 677.43 669.59 684.99 659.01"/><polygon class="cls-15" points="633.6 643.38 644.18 661.52 657.78 675.12 708.99 629.78 650.23 623.73 633.6 643.38"/><path class="cls-4" d="M671.69,49.44c-4.64.63-9.72,6.23-12,9-32.3,39.35-51.93,87.41-68.9,135.4C581.58,219.94,573,246.3,563,272.17c-9.7,25.24-23.21,49-31.84,74.42-9.77,28.78-13.29,59.55-11.61,89.86,2.42,43.68,8.59,97.89,40.23,131.13,48.62,51.07,83.3,87.35,83.3,87.35l20.67,16.32,21.13-19S741.3,602.16,747.43,580s6.44-20.54,11.63-32.24,13.62-12.48,20-45.08c15.41-78.47-12.25-158.34-39.58-231.26-15.46-41.27-31.89-82.35-42.36-125.16-4.51-18.47-7.89-37.18-11.68-55.81-1.9-9.3-3.88-18.59-6.15-27.81-.8-3.23-1.12-11.16-4.6-12.78A5.4,5.4,0,0,0,671.69,49.44Z"/><path class="cls-2" d="M675.74,50.6c3.58,4.67-1.86,8.25-1.34,13.89q.95,10.23,2.16,20.44,2.52,21.06,6.18,41.95a772.75,772.75,0,0,0,18.84,81.32c21.39,73.88,54.09,146.09,56,223,2,78.41-28.81,154.7-71.79,220.32,46-39.47,79.71-83.64,94.25-152.73,8.09-38.38,4.23-79.54-4.21-117.82-4.13-18.72-13.35-35.66-18.29-53.9-5.41-20-11.93-39.73-18.83-59.28-13.81-39.14-29.25-77.74-40.84-117.63-7.7-26.5-10.21-54.2-16.93-81-.45-1.76-2.47-22.71-9.26-19.26"/><path class="cls-16" d="M594.1,472.41c.74,11.43-7.13,21.25-17.59,21.93s-19.53-8-20.28-19.47,7.66-13.14,18.12-13.82S593.35,461,594.1,472.41Z"/><path class="cls-16" d="M760,462.52c.78,11.94-7.88,22.21-19.33,23s-21.37-8.33-22.14-20.26,8.4-14.1,19.86-14.84S759.21,450.59,760,462.52Z"/><ellipse class="cls-17" cx="622.99" cy="559.47" rx="5.17" ry="10.14" transform="translate(-142.84 220.9) rotate(-18.07)"/><ellipse class="cls-17" cx="695.17" cy="559.47" rx="10.14" ry="5.17" transform="translate(-52.38 1046.75) rotate(-71.93)"/><circle class="cls-18" cx="580.95" cy="482.63" r="7.67"/><circle class="cls-18" cx="735.18" cy="472.41" r="7.75"/><rect class="cls-13" x="775.83" y="376.94" width="27.21" height="120.91" rx="3.69" transform="translate(-26.73 52.17) rotate(-3.72)"/><rect class="cls-19" x="807.48" y="381.52" width="9.07" height="107.31" transform="translate(-26.53 53.63) rotate(-3.72)"/><rect class="cls-19" x="816.62" y="388.28" width="15.11" height="95.22" rx="3" transform="translate(-26.56 54.42) rotate(-3.72)"/><polygon class="cls-9" points="797.4 500.49 796.71 479.33 802.15 469.89 796.76 386.94 787.76 376.92 786.82 373.95 798.79 371.66 806.63 375.69 814.28 493.34 807.13 499.86 797.4 500.49"/><polygon class="cls-9" points="807.93 369.55 812.31 381.38 819.48 491.48 814.67 499.37 828.05 495.47 820.2 374.81 807.93 369.55"/><polygon class="cls-9" points="800.93 295.99 811.24 300.33 816.56 367.06 807.5 368.5 800.93 295.99"/><polygon class="cls-9" points="807.74 369.56 807.68 345.33 820.2 374.81 807.74 369.56"/><rect class="cls-9" x="466.97" y="474.71" width="10.58" height="22.67" rx="2.77" transform="translate(-30.55 31.68) rotate(-3.72)"/><path class="cls-9" d="M465.75,467.54S389.3,690.62,594.51,677.27L599,677l-.88-13.58S430.89,700,472.24,497.41c6.63-32.48-1.87-28.66-1.87-28.66Z"/><rect class="cls-13" x="501.33" y="394.8" width="27.21" height="120.91" rx="3.69" transform="translate(1058.33 876.12) rotate(176.28)"/><rect class="cls-19" x="487.73" y="402.31" width="9.07" height="107.31" transform="translate(1013.08 879.03) rotate(176.28)"/><rect class="cls-19" x="472.74" y="410.65" width="15.11" height="95.22" rx="3" transform="translate(989.32 884.38) rotate(176.28)"/><polygon class="cls-9" points="515.21 518.85 513.16 497.78 506.54 489.12 501.14 406.17 508.76 395.07 509.31 392 497.14 391.28 489.89 396.3 497.55 513.94 505.48 519.48 515.21 518.85"/><polygon class="cls-9" points="487.81 390.37 484.99 402.67 492.15 512.78 497.94 519.97 484.17 517.84 476.32 397.18 487.81 390.37"/><polygon class="cls-9" points="485.6 316.5 476.08 324.14 478.92 389.02 488.1 389.27 485.6 316.5"/><polygon class="cls-9" points="487.99 390.36 484.92 366.33 476.32 397.18 487.99 390.36"/><path class="cls-20" d="M526.29,367.2c7.4-5,17-5.67,25.6-6.74,10-1.22,20-1.81,29.79.8,8.46,2.26,12.08-10.86,3.61-13.12-11.6-3.09-23.42-2.58-35.22-1.05-10.48,1.36-21.66,2.26-30.65,8.36-7.2,4.89-.4,16.68,6.87,11.75Z"/><path class="cls-20" d="M714.85,356.31A78.59,78.59,0,0,1,766,353.26c8.44,2.36,12-10.76,3.61-13.12a90.81,90.81,0,0,0-58.36,3.06c-3.43,1.38-5.76,4.52-4.75,8.36.86,3.24,5,6.13,8.37,4.75Z"/><g id="Glasses"><path class="cls-18" d="M678.15,451.06c-.36-7-13-15.45-28-14.69s-26.76,10.41-26.41,17.43,12-3.51,27.08-4.26S678.5,458.09,678.15,451.06Z"/><ellipse class="cls-16" cx="574.11" cy="443.03" rx="53.17" ry="73.48" transform="translate(-21.53 29.39) rotate(-2.88)"/><ellipse class="cls-16" cx="726.85" cy="435.35" rx="53.17" ry="73.48" transform="translate(-20.95 37.06) rotate(-2.88)"/><path class="cls-21" d="M623.18,443.41l54.44-2.74"/><path class="cls-18" d="M541.67,391.16C533.46,403,528.51,409.42,523,409.7s-10.83-9.8-11.43-21.85,34.53-13.84,40.09-14.12S543.56,388.42,541.67,391.16Z"/><path class="cls-18" d="M751.2,380.62c9.35,11,14.92,16.85,20.48,16.57s9.79-10.83,9.19-22.88-35.75-10.31-41.31-10S749,378.09,751.2,380.62Z"/></g><circle class="cls-18" cx="576.26" cy="485.84" r="18"/><circle class="cls-18" cx="731.99" cy="478.01" r="19.71"/><circle class="cls-16" cx="580.18" cy="494.28" r="4.93"/><circle class="cls-16" cx="727.07" cy="487.72" r="5.4"/><ellipse class="cls-22" cx="518.2" cy="386.11" rx="3.29" ry="1.44" transform="translate(-98.95 194.44) rotate(-19.44)"/><ellipse class="cls-22" cx="774.2" cy="373.11" rx="1.44" ry="3.29" transform="translate(103.54 910.52) rotate(-64.44)"/><path class="cls-12" d="M487,619.64s-5.33-11.84-5.87-15.72c-.13-.92,6.55-1.26,6.55-1.26L496,618Z"/></g></svg>
</file>

<file path="resources/scripts/assets/images/server_error.svg">
<svg id="aa03ddf9-f8f2-4819-a4ce-be9b0a220741" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" width="1119.60911" height="699" viewBox="0 0 1119.60911 699"><title>server down</title><circle cx="292.60911" cy="213" r="213" fill="#f2f2f2"/><path d="M31.39089,151.64237c0,77.49789,48.6181,140.20819,108.70073,140.20819" transform="translate(-31.39089 -100.5)" fill="#2f2e41"/><path d="M140.09162,291.85056c0-78.36865,54.255-141.78356,121.30372-141.78356" transform="translate(-31.39089 -100.5)" fill="#0967d3"/><path d="M70.77521,158.66768c0,73.61476,31.00285,133.18288,69.31641,133.18288" transform="translate(-31.39089 -100.5)" fill="#0967d3"/><path d="M140.09162,291.85056c0-100.13772,62.7103-181.16788,140.20819-181.16788" transform="translate(-31.39089 -100.5)" fill="#2f2e41"/><path d="M117.22379,292.83905s15.41555-.47479,20.06141-3.783,23.713-7.2585,24.86553-1.95278,23.16671,26.38821,5.76263,26.5286-40.43935-2.711-45.07627-5.53549S117.22379,292.83905,117.22379,292.83905Z" transform="translate(-31.39089 -100.5)" fill="#a8a8a8"/><path d="M168.224,311.78489c-17.40408.14042-40.43933-2.71094-45.07626-5.53548-3.53126-2.151-4.93843-9.86945-5.40926-13.43043-.32607.014-.51463.02-.51463.02s.97638,12.43276,5.61331,15.2573,27.67217,5.67589,45.07626,5.53547c5.02386-.04052,6.7592-1.82793,6.66391-4.47526C173.87935,310.756,171.96329,311.75474,168.224,311.78489Z" transform="translate(-31.39089 -100.5)" opacity="0.2"/><ellipse cx="198.60911" cy="424.5" rx="187" ry="25.43993" fill="#3f3d56"/><ellipse cx="198.60911" cy="424.5" rx="157" ry="21.35866" opacity="0.1"/><ellipse cx="836.60911" cy="660.5" rx="283" ry="38.5" fill="#3f3d56"/><ellipse cx="310.60911" cy="645.5" rx="170" ry="23.12721" fill="#3f3d56"/><path d="M494,726.5c90,23,263-30,282-90" transform="translate(-31.39089 -100.5)" fill="none" stroke="#2f2e41" stroke-miterlimit="10" stroke-width="2"/><path d="M341,359.5s130-36,138,80-107,149-17,172" transform="translate(-31.39089 -100.5)" fill="none" stroke="#2f2e41" stroke-miterlimit="10" stroke-width="2"/><path d="M215.40233,637.78332s39.0723-10.82,41.47675,24.04449-32.15951,44.78287-5.10946,51.69566" transform="translate(-31.39089 -100.5)" fill="none" stroke="#2f2e41" stroke-miterlimit="10" stroke-width="2"/><path d="M810.09554,663.73988,802.218,714.03505s-38.78182,20.60284-11.51335,21.20881,155.73324,0,155.73324,0,24.84461,0-14.54318-21.81478l-7.87756-52.719Z" transform="translate(-31.39089 -100.5)" fill="#2f2e41"/><path d="M785.21906,734.69812c6.193-5.51039,16.9989-11.252,16.9989-11.252l7.87756-50.2952,113.9216.10717,7.87756,49.582c9.185,5.08711,14.8749,8.987,18.20362,11.97818,5.05882-1.15422,10.58716-5.44353-18.20362-21.38921l-7.87756-52.719-113.9216,3.02983L802.218,714.03506S769.62985,731.34968,785.21906,734.69812Z" transform="translate(-31.39089 -100.5)" opacity="0.1"/><rect x="578.43291" y="212.68859" width="513.25314" height="357.51989" rx="18.04568" fill="#2f2e41"/><rect x="595.70294" y="231.77652" width="478.71308" height="267.83694" fill="#3f3d56"/><circle cx="835.05948" cy="223.29299" r="3.02983" fill="#f2f2f2"/><path d="M1123.07694,621.32226V652.6628a18.04341,18.04341,0,0,1-18.04568,18.04568H627.86949A18.04341,18.04341,0,0,1,609.8238,652.6628V621.32226Z" transform="translate(-31.39089 -100.5)" fill="#2f2e41"/><polygon points="968.978 667.466 968.978 673.526 642.968 673.526 642.968 668.678 643.417 667.466 651.452 645.651 962.312 645.651 968.978 667.466" fill="#2f2e41"/><path d="M1125.828,762.03359c-.59383,2.539-2.83591,5.21743-7.90178,7.75032-18.179,9.08949-55.1429-2.42386-55.1429-2.42386s-28.4804-4.84773-28.4804-17.573a22.72457,22.72457,0,0,1,2.49658-1.48459c7.64294-4.04351,32.98449-14.02122,77.9177.42248a18.73921,18.73921,0,0,1,8.54106,5.59715C1125.07908,756.45353,1126.50669,759.15715,1125.828,762.03359Z" transform="translate(-31.39089 -100.5)" fill="#2f2e41"/><path d="M1125.828,762.03359c-22.251,8.526-42.0843,9.1622-62.43871-4.975-10.26507-7.12617-19.59089-8.88955-26.58979-8.75618,7.64294-4.04351,32.98449-14.02122,77.9177.42248a18.73921,18.73921,0,0,1,8.54106,5.59715C1125.07908,756.45353,1126.50669,759.15715,1125.828,762.03359Z" transform="translate(-31.39089 -100.5)" opacity="0.1"/><ellipse cx="1066.53846" cy="654.13477" rx="7.87756" ry="2.42386" fill="#f2f2f2"/><circle cx="835.05948" cy="545.66686" r="11.51335" fill="#f2f2f2"/><polygon points="968.978 667.466 968.978 673.526 642.968 673.526 642.968 668.678 643.417 667.466 968.978 667.466" opacity="0.1"/><rect x="108.60911" y="159" width="208" height="242" fill="#2f2e41"/><rect x="87.60911" y="135" width="250" height="86" fill="#3f3d56"/><rect x="87.60911" y="237" width="250" height="86" fill="#3f3d56"/><rect x="87.60911" y="339" width="250" height="86" fill="#3f3d56"/><rect x="271.60911" y="150" width="16" height="16" fill="#0967d3" opacity="0.4"/><rect x="294.60911" y="150" width="16" height="16" fill="#0967d3" opacity="0.8"/><rect x="317.60911" y="150" width="16" height="16" fill="#0967d3"/><rect x="271.60911" y="251" width="16" height="16" fill="#0967d3" opacity="0.4"/><rect x="294.60911" y="251" width="16" height="16" fill="#0967d3" opacity="0.8"/><rect x="317.60911" y="251" width="16" height="16" fill="#0967d3"/><rect x="271.60911" y="352" width="16" height="16" fill="#0967d3" opacity="0.4"/><rect x="294.60911" y="352" width="16" height="16" fill="#0967d3" opacity="0.8"/><rect x="317.60911" y="352" width="16" height="16" fill="#0967d3"/><circle cx="316.60911" cy="538" r="79" fill="#2f2e41"/><rect x="280.60911" y="600" width="24" height="43" fill="#2f2e41"/><rect x="328.60911" y="600" width="24" height="43" fill="#2f2e41"/><ellipse cx="300.60911" cy="643.5" rx="20" ry="7.5" fill="#2f2e41"/><ellipse cx="348.60911" cy="642.5" rx="20" ry="7.5" fill="#2f2e41"/><circle cx="318.60911" cy="518" r="27" fill="#fff"/><circle cx="318.60911" cy="518" r="9" fill="#3f3d56"/><path d="M271.36733,565.03228c-6.37889-28.56758,14.01185-57.43392,45.544-64.47477s62.2651,10.41,68.644,38.9776-14.51861,39.10379-46.05075,46.14464S277.74622,593.59986,271.36733,565.03228Z" transform="translate(-31.39089 -100.5)" fill="#0967d3"/><ellipse cx="417.21511" cy="611.34365" rx="39.5" ry="12.40027" transform="translate(-238.28665 112.98044) rotate(-23.17116)" fill="#2f2e41"/><ellipse cx="269.21511" cy="664.34365" rx="39.5" ry="12.40027" transform="translate(-271.07969 59.02084) rotate(-23.17116)" fill="#2f2e41"/><path d="M394,661.5c0,7.732-19.90861,23-42,23s-43-14.268-43-22,20.90861-6,43-6S394,653.768,394,661.5Z" transform="translate(-31.39089 -100.5)" fill="#fff"/></svg>
</file>

<file path="resources/scripts/assets/images/server_installing.svg">
<svg id="f1903550-5374-4fc8-959e-1f31e4981ba4" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1017.23" height="708.31" viewBox="0 0 1017.23 708.31"><defs><linearGradient id="ae8f1d99-169f-42eb-bca8-084a90728b1c" x1="815.82" y1="804.15" x2="815.82" y2="292.5" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="gray" stop-opacity="0.25"/><stop offset="0.54" stop-color="gray" stop-opacity="0.12"/><stop offset="1" stop-color="gray" stop-opacity="0.1"/></linearGradient></defs><title>uploading</title><path d="M685.63,207.25c-64.72-2.25-126.36-23.14-185.23-46S383.24,113.06,320.07,101c-40.63-7.79-87.09-8.89-119.83,12.89-31.5,21-41.68,57.15-47.16,90.72-4.11,25.27-6.54,51.85,4.75,75.5,7.83,16.42,21.74,30.22,31.36,45.95,33.46,54.72,9.81,122.2-26.46,175.63-17,25.06-36.74,49-49.87,75.66s-19.2,57.25-7.72,84.47c11.39,27,38.52,47.24,67.9,61.49,59.69,28.94,130,37.23,198.62,41.92,151.82,10.39,304.46,5.89,456.68,1.39,56.34-1.67,112.92-3.36,168.34-12.07,30.78-4.84,62.56-12.52,84.9-31,28.36-23.53,35.39-63.38,16.39-92.88-31.88-49.49-120-61.79-142.31-114.9-12.27-29.23.33-61.8,18.15-88.91,38.24-58.17,102.33-109.19,105.71-175.68,2.32-45.66-28.49-91.39-76.13-113-49.94-22.65-119.18-19.8-156,17.69C809.43,194.38,742.77,209.23,685.63,207.25Z" transform="translate(-91.39 -95.85)" fill="#0967d3" opacity="0.1"/><g opacity="0.1"><path d="M177.74,424.21S103,392.77,93.17,449.46c0,0-5.11,8.84,2,16.14,0,0,1.53-3.92,8.75.13a37.17,37.17,0,0,0,8.16,3.32,18.36,18.36,0,0,0,11.62-.62h0s24.59-1.33,45.27-33.5c0,0,8.87-5.48,9.31-7.54l-14.82,1s1.14,10.85-5,17.36c0,0,5.44-16.84,2.83-17.31-.53-.1-7.83.86-7.83.86s1.89,18.87-8,28.63c0,0,9.18-19.19,5.19-28.29l-10.94,2.11s3,19.85-7.82,31.39c0,0,8.9-20.4,5.46-30.76l-10.47,3.52s2.52,19.41-6.53,29c0,0,7.9-24.61,4.18-28,0,0-9.42,3.82-11.43,6,0,0,1.49,14-4.26,19.05,0,0,3.53-17,1.78-17.7,0,0-10.94,8.24-14.28,15.35,0,0,4.16-10.86,12.91-17,0,0-7.35-1.24-13,1.83,0,0,3.78-7.21,15.65-3.79,0,0,8.79-6.09,10.55-6,0,0-11.23-5-19.34-4.38,0,0,8.7-5,22.08,3.35l10.45-3.77s-14.5-7.43-21.76-7.4c0,0,9.66-3.74,24.47,6.66l10.7-2.18s-12-7.35-20.09-9.06c0,0,9.7-1.54,23.18,8.55l7.31-.61s-8.85-5.22-11.53-6.49-2.56-2.09-2.56-2.09a34.89,34.89,0,0,1,17.16,8.26S177.68,425.14,177.74,424.21Z" transform="translate(-91.39 -95.85)" fill="#0967d3"/></g><g opacity="0.1"><path d="M175,367.85s-26.51-61.27-64.63-33.17c0,0-8.06,2.34-8,10.7,0,0,3.14-1.46,5.13,5.07a30.1,30.1,0,0,0,3,6.61,15,15,0,0,0,7.25,6.25h0s15.37,13.22,46,5.89c0,0,8.4,1.79,9.83.83l-9.36-7.87s-5.51,7.1-12.89,7.44c0,0,12.83-6.9,11.55-8.67-.26-.36-5.15-3.94-5.15-3.94s-9.62,12.28-21,12.47c0,0,16.39-6.18,19.2-13.85l-7.7-5s-9.54,13.49-22.53,14.19c0,0,16.91-7.05,20.77-15.17l-8.23-3.87s-9.56,13-20.37,13.49c0,0,18.72-10.12,18.43-14.25,0,0-7.77-3.1-10.24-2.92,0,0-7.07,9.15-13.38,8.89,0,0,11.79-8.09,11.15-9.5,0,0-11.2-1.34-17.23,1,0,0,8.66-4.08,17.35-2.74,0,0-3.66-4.93-8.75-6.3,0,0,6.36-2.13,11.46,6.65,0,0,8.68,1.4,9.7,2.44,0,0-3.81-9.39-9-13.62,0,0,8,2,11.2,14.57l8.36,3.71s-4.38-12.68-8.72-16.79c0,0,7.87,3.28,10.75,17.9l7.6,4.79s-2.94-11.2-6.77-16.83c0,0,6.64,4.62,8.89,18.29l4.7,3.8s-2.29-8.14-3.16-10.42-.33-2.7-.33-2.7a28.65,28.65,0,0,1,5.49,14.68S174.41,368.36,175,367.85Z" transform="translate(-91.39 -95.85)" fill="#0967d3"/></g><path d="M1024.66,763c-1-3.62-2-7.29-4-10.44a36.28,36.28,0,0,0-6.56-7.17c-7.25-6.59-16.16-13.28-25.77-11.61a34,34,0,0,0-8.56,3.12c-1.4.65-2.81,1.3-4.25,1.85a21.2,21.2,0,0,1-12.83,1.12c-2.2-.59-4.25-1.65-6.42-2.31a20.72,20.72,0,0,0-3.16-.68,58.18,58.18,0,0,0,6.1-3.21C970,727,978.61,715,977.4,702.3c-.4-4.3-1.88-8.41-3.34-12.46q-1.92-5.31-3.85-10.63c-1.66-4.61-3.37-9.3-6.41-13.13-3.38-4.26-8.18-7.15-13.14-9.31-10.66-4.63-22.31-6.26-33.81-7.84l-.8-.11V524.58a8,8,0,0,0-8-8.05H892.92q-1-6.12-2-12.23c-1.91-11.61-3.88-23.45-9.23-33.91-3.5-6.85-9.08-13.37-16.59-14.72a16.54,16.54,0,0,1-4.32-1c-2.2-1.08-3.4-3.48-5.1-5.26-4.36-4.57-11.45-4.64-17.3-7-5.16-2.05-9.38-5.92-14.08-8.89s-10.55-5.09-15.76-3.15c0,.38-.07.75-.11,1.13L805.09,430c-3.6-1.66-7.28-3.38-10.17-6.12-3.72-3.51-5.7-8.14-7.24-13.08-.16-.52-.31-1-.46-1.55a46.53,46.53,0,0,0,12.44-23.77c.27.87.55,1.75.82,2.63a13.88,13.88,0,0,0,1,2.59,6.86,6.86,0,0,0,.47.79,5.1,5.1,0,0,0,1.22,1.27,3.41,3.41,0,0,0,1.61.63,3,3,0,0,0,.84,0,4.62,4.62,0,0,0,3.36-2.87,6,6,0,0,0,.35-1.22,6.31,6.31,0,0,0,.07-.76c0-.08,0-.16,0-.24s0-.35,0-.52,0-.19,0-.28,0-.34,0-.5l0-.26c0-.2-.06-.4-.1-.59s0-.11,0-.16c-.05-.26-.11-.51-.16-.77a1,1,0,0,1,0-.17l-.15-.63-.09-.38,0-.1h0c-.1-.39-.19-.79-.28-1.19a34.44,34.44,0,0,1-.55-10.57,114.49,114.49,0,0,1,2.86-15.36l.21-.91.24-1.06c.16-.72.31-1.44.46-2.16v0c.13-.61.25-1.23.36-1.85s.19-1.09.27-1.64c0-.07,0-.13,0-.2a47.52,47.52,0,0,0,.49-11.28h0c-.47-5.23-2.09-10.18-5.65-14.13-2.51-2.79-5.81-4.85-8.14-7.78-2.19-2.75-3.42-6.13-5.68-8.82-6.25-7.46-22.28-13.21-32.12-14.21-11.27-1.14-29.48,1.74-38.56,8.4-3.36,2.46-5.66,6-8,9.37-4.3,6.26-9.19,12.5-16.08,16-2.61,1.32-5.59,2.32-7.32,4.62a12.59,12.59,0,0,0-2,5.19,102.21,102.21,0,0,0-2.06,19.8,24.41,24.41,0,0,0,1.1,8.6c.14.38.31.77.49,1.14h0c.16.33.34.66.53,1l.12.21a41.55,41.55,0,0,1,3.21,5.45,7.9,7.9,0,0,1,.48,1.66,12.29,12.29,0,0,1-.28,4.39h0c0,.22-.08.43-.13.64l-.09.46c0,.14,0,.29-.08.43q-.12.65-.21,1.29c0,.3-.06.61-.07.92a7.51,7.51,0,0,0,.69,3.6,4.58,4.58,0,0,0,.47.76,4,4,0,0,0,1.35,1.15,15.14,15.14,0,0,0,3.7.88c3.74.84,6.08,3.7,7.6,7.21a25.46,25.46,0,0,1,.89,2.41,42.63,42.63,0,0,1,1.4,6.27c1.7-.09,2.69-1.59,3.29-3.23a15.2,15.2,0,0,0,.47-1.65c.23-1.05.46-2.1.7-3.15a46.49,46.49,0,0,0,18.26,20.12c.28.82.55,1.65.8,2.49,1.31,4.53,1.94,9.28-.33,13.24-1.62,2.81-4.35,4.55-7.39,5.75a4.89,4.89,0,0,0-1.65-1.41c-2.64-1.32-5.8.29-8,2.26-4,3.62-7.26,8.81-12.53,10-1.9.44-4,.35-5.59,1.51a12.92,12.92,0,0,0-2.59,3.41,11.93,11.93,0,0,1-10.24,5.1c-1.83-.09-4-.51-5.25.83-.93,1-1,2.59-2,3.54-1.35,1.32-3.54.67-5.42.59a10,10,0,0,0-7.25,3.14,17.06,17.06,0,0,0-4.36-10.9c-2.7-2.78-6.45-4.21-9.65-6.39-8-5.44-12-15-16.17-23.76s-9.67-18-18.77-21.19c-2.09-.74-5-.8-5.94,1.23a4.43,4.43,0,0,0-.15,2.65c.88,4.66,4.2,8.4,7.07,12.15,4.83,6.32,8.88,14.05,7.71,21.95-1.37,9.35-9.7,16.61-10.7,26-.44,4.14.61,8.3.6,12.46,0,2.6-.41,5.23.15,7.76a52.63,52.63,0,0,0,2.11,5.65,33.09,33.09,0,0,1,1.38,9.31q1.06,19.88,2.11,39.77c.53,9.89-1.63,19.65-3.81,29.38a92.19,92.19,0,0,0-6.26,18c-2.46,10.83-2.53,22.37,1,32.91,1.89,5.73,4.79,11.1,6.34,16.93,0,.13.06.25.09.37.15,1.24.32,2.48.55,3.71a35.66,35.66,0,0,0,1.11,4.2,29.93,29.93,0,0,0,2.2,6.87,19.22,19.22,0,0,0,6,7c-1.44,2.82-3.77,5.09-5.32,7.85-2.7,4.78-2.81,10.65-1.83,16.07,1.89,10.46,7.54,19.81,15,27.41a8.68,8.68,0,0,0-1,0,15.68,15.68,0,0,0-6.84,2.45c-15.79,9.23-24.82,29-21.52,47.1.65,3.54,1.78,7.12,4.14,9.81a15.56,15.56,0,0,0,7.29,4.47,25.29,25.29,0,0,0,5.37,1c12.31,1,24.23-4.71,36.57-5.19a98.49,98.49,0,0,1,12.25.57q8.91.74,17.86.94c9.69.23,15.15-2.35,21.34-9.6a25.88,25.88,0,0,0,3.77-5.94c5.26-.3,11.07-.76,15.28-1.11l.06.59c.23,2,.58,4.3,2.18,5.57a7.79,7.79,0,0,0,3,1.22c10.11,2.49,20.34,5,30.74,5a129.72,129.72,0,0,0,14.6-1.13l18.3-2.11a93.21,93.21,0,0,1,15.71,3.42c5.28,1.8,10.22,4.47,15.38,6.57,12,4.87,24.92,6.61,37.71,8.31,2.18.29,4.68.49,6.3-1,2.08-2,1.38-5.35.8-8.15-.24-1.14-.42-2.3-.57-3.46a173.5,173.5,0,0,1,25.26,8.77l1.44.63c.41,2.18,2.43,3.93,4.36,6.28a15.9,15.9,0,0,0,2.21,2.73,7.25,7.25,0,0,0,3.17,1.15,148.12,148.12,0,0,0,41,1.85,42,42,0,0,1,8.45-.29,35.64,35.64,0,0,1,6.1,1.38l11.58,3.31c8.53,2.45,17.28,4.92,26.13,4.37a34.71,34.71,0,0,0,5.34-.77c7-1.62,13.53-5.54,16.89-11.84C1029.42,782.89,1027.23,772.36,1024.66,763ZM685,606.59a36.39,36.39,0,0,1-3.34,12.51c-1.24,2.51-2.84,4.82-4,7.34-1.1,2.28-1.92,6.59-2.41,11.32-.6-.1-1.21-.19-1.81-.26.89-3.12,1.56-6.32,2.45-9.45C678,620.61,681.47,613.58,685,606.59Z" transform="translate(-91.39 -95.85)" fill="url(#ae8f1d99-169f-42eb-bca8-084a90728b1c)"/><path d="M700.41,760.39c-2.11-4.8-4.11-10.32-2-15.12a12.85,12.85,0,0,1,6.65-6.25,32,32,0,0,1,9-2.22,125.61,125.61,0,0,1,29.26-.4c.71,5.62-.79,11.32-2.08,16.75-1.17,5-1.84,5.74-7,6C730.9,759.33,701.2,762.16,700.41,760.39Z" transform="translate(-91.39 -95.85)" fill="#fbbebe"/><ellipse cx="698.07" cy="592.16" rx="143" ry="40" fill="#464353"/><ellipse cx="698.07" cy="592.16" rx="143" ry="40" opacity="0.1"/><path d="M815.1,476.85a44.49,44.49,0,0,1-22.94,20.84A57.58,57.58,0,0,1,774,501.15c-6.79.31-13.72-.13-20.1-2.45-8.56-3.1-15.67-9.44-21-16.83s-9-15.83-12.19-24.34c-1.68-4.43-3.28-9.15-2.49-13.83,5.15-1.17,10.79-2.89,13.45-7.46,2.27-3.92,1.64-8.62.33-13.1-.37-1.27-.8-2.53-1.23-3.74-1-2.9-4.45-8.41-2.05-10.89,1.53-1.57,7.94-2.37,10.15-3.39,6.81-3.14,13.09-7.68,20.57-9.17,6.47-1.29,13.15-.08,19.61,1.26a6.45,6.45,0,0,1,2.42.87,5.82,5.82,0,0,1,1.8,2.7c1.84,4.48,2.92,9.43,4.4,14.1,1.54,4.89,3.52,9.48,7.23,12.95,2.89,2.71,6.57,4.41,10.17,6.06l8.86,4.06a11.65,11.65,0,0,1,4.19,2.71,10.61,10.61,0,0,1,2,5.44A50.82,50.82,0,0,1,815.1,476.85Z" transform="translate(-91.39 -95.85)" fill="#fbbebe"/><path d="M787.63,414.88A46,46,0,0,1,732,423.14c-.37-1.27-.8-2.53-1.23-3.74-1-2.9-4.45-8.41-2.05-10.89,1.53-1.57,7.94-2.37,10.15-3.39,6.81-3.14,13.09-7.68,20.57-9.17,6.47-1.29,13.15-.08,19.61,1.26a6.45,6.45,0,0,1,2.42.87,5.82,5.82,0,0,1,1.8,2.7C785.07,405.26,786.15,410.21,787.63,414.88Z" transform="translate(-91.39 -95.85)" opacity="0.1"/><circle cx="663.07" cy="285.16" r="46" fill="#fbbebe"/><path d="M894.61,530.3l-3.78-22.9c-1.91-11.49-3.88-23.2-9.22-33.55-3.51-6.78-9.08-13.24-16.59-14.58a16.05,16.05,0,0,1-4.32-1c-2.2-1.06-3.4-3.44-5.09-5.2-4.36-4.52-11.46-4.59-17.3-6.89-5.16-2-9.38-5.85-14.08-8.79s-10.55-5-15.75-3.12c-.84,8.95-1.73,18.1-5.53,26.25a39.28,39.28,0,0,1-59.26,14.76c-8.91-6.71-14.62-17.06-17.28-27.89-.65-2.64-1.39-5.67-3.82-6.88-2.63-1.32-5.79.28-8,2.22-4.05,3.59-7.27,8.73-12.53,9.94-1.9.44-4,.35-5.58,1.5a12.7,12.7,0,0,0-2.6,3.37,12,12,0,0,1-10.23,5.06c-1.83-.09-4-.51-5.25.82-.93,1-1,2.56-2,3.49-1.35,1.31-3.54.67-5.42.6-3.56-.15-6.87,2.13-8.91,5s-3,6.42-4,9.86c10.93,24.34,20.93,48.71,31.86,73.05a6.23,6.23,0,0,1,.79,3,7.31,7.31,0,0,1-1.36,3c-5.36,8.61-5.19,19.44-4.6,29.56s1.31,20.81-3.21,29.88c-1.23,2.49-2.83,4.77-4,7.26-2.74,5.64-3.73,23.68-2.13,29.74h226c-4.31-11.85-2.67-35.63-1.77-48.21.63-8.8-1-17.59-1.7-26.39C896.48,565.29,897.58,548.24,894.61,530.3Z" transform="translate(-91.39 -95.85)" fill="#f86d70"/><path d="M906.18,650.86c3.33-1.27,7-.81,10.57-.33,11.49,1.57,23.15,3.18,33.8,7.77,5,2.14,9.76,5,13.14,9.21,3,3.79,4.75,8.43,6.41,13L973.94,691c1.46,4,2.94,8.08,3.35,12.33,1.2,12.59-7.41,24.46-18.24,31s-23.58,8.87-36,11.31-24.89,5.14-37.26,8a150,150,0,0,1-17.53,3.45c-13.24,1.5-27.08-.71-39.66,3.67-5,1.75-9.91,4.35-15.1,5.56A93.93,93.93,0,0,1,803.07,768l-23.81,2.72a129.89,129.89,0,0,1-14.6,1.12c-10.4,0-20.63-2.46-30.73-4.92a7.77,7.77,0,0,1-3-1.21c-1.6-1.26-1.95-3.49-2.18-5.51q-1.53-13.41-2.68-26.85c-.24-2.91-.42-6.06,1.17-8.51,2-3,5.9-3.94,9.46-4.52a246.88,246.88,0,0,1,45.68-3.17c5.81-5.81,15.39-5.84,23-9a68.39,68.39,0,0,0,8.11-4.41A106,106,0,0,1,858,689.67a41.45,41.45,0,0,0,9.11-1.3c5.89-1.83,11.26-6.81,17.31-5.59.75-2.07,1.27-4.84,3-6.26.86-.73,1.92-1.22,2.71-2,1.67-1.69,1.82-4.35,1.57-6.71s-.81-4.78-.2-7.08a9.79,9.79,0,0,1,1.11-2.47C895.62,653,900.15,650.36,906.18,650.86Z" transform="translate(-91.39 -95.85)" fill="#464353"/><path d="M906.18,650.86c3.33-1.27,7-.81,10.57-.33,11.49,1.57,23.15,3.18,33.8,7.77,5,2.14,9.76,5,13.14,9.21,3,3.79,4.75,8.43,6.41,13L973.94,691c1.46,4,2.94,8.08,3.35,12.33,1.2,12.59-7.41,24.46-18.24,31s-23.58,8.87-36,11.31-24.89,5.14-37.26,8a150,150,0,0,1-17.53,3.45c-13.24,1.5-27.08-.71-39.66,3.67-5,1.75-9.91,4.35-15.1,5.56A93.93,93.93,0,0,1,803.07,768l-23.81,2.72a129.89,129.89,0,0,1-14.6,1.12c-10.4,0-20.63-2.46-30.73-4.92a7.77,7.77,0,0,1-3-1.21c-1.6-1.26-1.95-3.49-2.18-5.51q-1.53-13.41-2.68-26.85c-.24-2.91-.42-6.06,1.17-8.51,2-3,5.9-3.94,9.46-4.52a246.88,246.88,0,0,1,45.68-3.17c5.81-5.81,15.39-5.84,23-9a68.39,68.39,0,0,0,8.11-4.41A106,106,0,0,1,858,689.67a41.45,41.45,0,0,0,9.11-1.3c5.89-1.83,11.26-6.81,17.31-5.59.75-2.07,1.27-4.84,3-6.26.86-.73,1.92-1.22,2.71-2,1.67-1.69,1.82-4.35,1.57-6.71s-.81-4.78-.2-7.08a9.79,9.79,0,0,1,1.11-2.47C895.62,653,900.15,650.36,906.18,650.86Z" transform="translate(-91.39 -95.85)" opacity="0.05"/><path d="M709.61,766.57c-6.19,7.17-11.64,9.73-21.33,9.5q-8.94-.21-17.86-.93a100.2,100.2,0,0,0-12.24-.57c-12.34.48-24.25,6.13-36.56,5.14a25.92,25.92,0,0,1-5.37-1A15.63,15.63,0,0,1,609,774.3c-2.36-2.67-3.49-6.21-4.14-9.71-3.29-17.94,5.73-37.48,21.52-46.61a15.78,15.78,0,0,1,6.84-2.43,16.21,16.21,0,0,1,6.92,1.52l.15.06a52.33,52.33,0,0,1,17.14,11.44,9.66,9.66,0,0,0,2.62,2.11,9,9,0,0,0,3.09.58l13.14.83a31.14,31.14,0,0,1,6.6.91,52.46,52.46,0,0,1,6.94,3c7.07,3.16,14.91,4,22.55,5.22a3.37,3.37,0,0,1,2,.8,3.13,3.13,0,0,1,.62,1.3A25.51,25.51,0,0,1,709.61,766.57Z" transform="translate(-91.39 -95.85)" fill="#3f3d56"/><path d="M640.25,717.13a78.9,78.9,0,0,0-13.15,16.44,82.28,82.28,0,0,0-10.74,32.54,60.4,60.4,0,0,0-.11,12.61A15.63,15.63,0,0,1,609,774.3c-2.36-2.67-3.49-6.21-4.14-9.71-3.29-17.94,5.73-37.48,21.52-46.61a15.78,15.78,0,0,1,6.84-2.43,16.21,16.21,0,0,1,6.92,1.52Z" transform="translate(-91.39 -95.85)" opacity="0.1"/><path d="M894.74,742c7.35-.2,15.6-.57,21,4.38,5.15,4.68,5.83,12.4,6.17,19.35l.39,8.07c.12,2.46.22,5-.77,7.28-1.76,4-6.59,5.93-11,5.7s-8.46-2.16-12.49-3.9a175.7,175.7,0,0,0-34-10.71q.57-8.37,1.9-16.66c.61-3.83.71-10.24,3.27-13.42,2.71-3.36,6.24-1.54,9.92-.92A79.63,79.63,0,0,0,894.74,742Z" transform="translate(-91.39 -95.85)" fill="#fbbebe"/><path d="M700.52,660.92c0,1-1.57,0-1.71-1.07-1.1-8.09-7.52-14.76-15-18s-16-3.41-24.1-2.64c-12.25,1.16-25.95,5.85-30.48,17.3-1.06,2.68-1.54,5.58-2.84,8.15-1.44,2.82-3.79,5.07-5.35,7.81-2.69,4.74-2.8,10.55-1.83,15.91,2.61,14.3,12.39,26.53,24.24,35s25.7,13.53,39.51,18.09a685.19,685.19,0,0,0,112,26.75c6.16.93,12.38,1.79,18.28,3.77,5.28,1.77,10.22,4.42,15.38,6.5,12,4.82,24.91,6.54,37.7,8.23,2.18.28,4.68.48,6.29-1,2.08-1.93,1.39-5.29.8-8.06a43.35,43.35,0,0,1,5.09-30.74c2.14-3.6,4.92-7.29,4.52-11.46-.48-4.86-5.32-8.3-10.14-9.08s-9.72.37-14.56,1c-1.67.22-3.49.36-5-.49a9.89,9.89,0,0,1-1.94-1.72,21.93,21.93,0,0,0-25.54-3.57c-1.79,1-4.5-1.23-6.36-2.07L798.47,710c-24.16-10.93-48.44-21.91-74-28.83a15.54,15.54,0,0,1-5.7-2.37c-1.27-1-2.18-2.36-3.35-3.47-2.55-2.41-6.1-3.37-9.16-5.08S699.8,664.35,700.52,660.92Z" transform="translate(-91.39 -95.85)" fill="#464353"/><path d="M1024.71,791.61c-3.36,6.23-9.88,10.11-16.88,11.71a33.5,33.5,0,0,1-5.34.76c-8.85.55-17.59-1.9-26.12-4.32l-11.58-3.28a36.55,36.55,0,0,0-6.1-1.36,41.86,41.86,0,0,0-8.44.29,149.59,149.59,0,0,1-41-1.84,7.23,7.23,0,0,1-3.17-1.13,15.75,15.75,0,0,1-2.21-2.71c-3.15-3.79-6.54-6-2.81-11,2.15-2.9,6.14-4.35,7.81-7.68s.6-8.06-.39-11.5c-1.35-4.75-5.79-6.8-7.38-11.16-1.19-3.29.81-7.11,3.82-8.9s6.73-1.93,10.2-1.47,6.87,1.44,10.36,1.71c10.26.82,20.75-4.47,30.6-1.49,2.17.66,4.22,1.71,6.42,2.29a21.35,21.35,0,0,0,12.83-1.11c1.44-.54,2.85-1.19,4.25-1.83a34.23,34.23,0,0,1,8.55-3.09c9.61-1.65,18.52,5,25.77,11.49a36.44,36.44,0,0,1,6.55,7.1c2,3.12,3.06,6.75,4,10.33C1027.1,772.69,1029.29,783.11,1024.71,791.61Z" transform="translate(-91.39 -95.85)" fill="#3f3d56"/><path d="M1024.71,791.61c-3.36,6.23-9.88,10.11-16.88,11.71a32.69,32.69,0,0,0,3.55-17.16c-.6-9.51-4.78-18.47-10.11-26.37a93.4,93.4,0,0,0-11.14-13.57c-3.18-3.2-7.09-5.74-10.51-8.67a34.23,34.23,0,0,1,8.55-3.09c9.61-1.65,18.52,5,25.77,11.49a36.44,36.44,0,0,1,6.55,7.1c2,3.12,3.06,6.75,4,10.33C1027.1,772.69,1029.29,783.11,1024.71,791.61Z" transform="translate(-91.39 -95.85)" opacity="0.1"/><path d="M722.68,306.35c-3.36,2.43-5.66,5.92-8,9.27-4.31,6.19-9.19,12.37-16.08,15.82-2.61,1.31-5.59,2.3-7.32,4.58a12.34,12.34,0,0,0-1.95,5.13,101.65,101.65,0,0,0-2.06,19.6c0,3.28.14,6.66,1.59,9.64,1.37,2.8,3.84,5.17,4.35,8.22.39,2.38-.49,4.75-.8,7.14s.23,5.22,2.44,6.36a14.79,14.79,0,0,0,3.7.87c6.65,1.48,8.88,9.28,9.89,15.73,2.26-.13,3.28-2.72,3.75-4.83l6.93-30.81c.75-3.34,2-7.21,5.33-8.38,2.23-.77,4.67-.05,7,.15,9.15.75,16.89-6.32,25.84-8.27A33,33,0,0,1,766,356c7.06.35,15.27,3.25,16.77,9.84.25,1.07.4,2.35,1.4,2.88s2,.08,3.1,0c4.48-.45,7.12,4.59,8.41,8.71l4.7,15c.7,2.27,1.88,4.94,4.34,5.23,2.27.28,4.2-1.87,4.54-4s-.4-4.34-.89-6.48c-2.21-9.85,1.17-19.93,3.23-29.8s2.43-21.21-4.48-28.81c-2.51-2.75-5.81-4.8-8.15-7.7-2.18-2.72-3.41-6.06-5.67-8.73-6.25-7.37-22.28-13.06-32.11-14C750,296.91,731.76,299.76,722.68,306.35Z" transform="translate(-91.39 -95.85)" fill="#3f3d56"/><g opacity="0.1"><path d="M804.76,390.65c-2.46-.3-3.64-3-4.34-5.23q-2.35-7.51-4.7-15c-1.29-4.13-3.93-9.17-8.41-8.71-1,.11-2.18.52-3.1,0s-1.15-1.81-1.4-2.88c-1.5-6.6-9.71-9.49-16.77-9.84a33.43,33.43,0,0,0-8.71.57c-9,2-16.69,9-25.84,8.27-2.36-.19-4.8-.91-7-.14-3.37,1.16-4.58,5-5.33,8.38l-6.93,30.8c-.47,2.12-1.49,4.71-3.75,4.83-1-6.44-3.24-14.24-9.89-15.72a15.72,15.72,0,0,1-3.7-.87,4.34,4.34,0,0,1-1.93-2.15c-.18.93-.39,1.86-.51,2.79-.3,2.38.23,5.22,2.44,6.36a14.79,14.79,0,0,0,3.7.87c6.65,1.48,8.88,9.28,9.89,15.73,2.26-.13,3.28-2.72,3.75-4.83l6.93-30.81c.75-3.34,2-7.21,5.33-8.38,2.23-.77,4.67-.05,7,.15,9.15.75,16.89-6.32,25.84-8.27A33,33,0,0,1,766,356c7.06.35,15.27,3.25,16.77,9.84.25,1.07.4,2.35,1.4,2.88s2,.08,3.1,0c4.48-.45,7.12,4.59,8.41,8.71q2.34,7.51,4.7,15c.7,2.27,1.88,4.94,4.34,5.23,2.27.28,4.2-1.87,4.54-4a13.58,13.58,0,0,0-.6-5.31A4.13,4.13,0,0,1,804.76,390.65Z" transform="translate(-91.39 -95.85)"/><path d="M693.22,371.61c-.51-3.05-3-5.42-4.35-8.22a16.45,16.45,0,0,1-1.48-6c0,1.12-.1,2.24-.11,3.37,0,3.28.14,6.66,1.59,9.64,1.11,2.27,2.94,4.27,3.86,6.58A15.06,15.06,0,0,0,693.22,371.61Z" transform="translate(-91.39 -95.85)"/><path d="M811.64,350.33c-1.82,8.72-4.66,17.6-3.78,26.34.57-6.45,2.45-12.94,3.78-19.34a51,51,0,0,0,1.16-14.82A61.14,61.14,0,0,1,811.64,350.33Z" transform="translate(-91.39 -95.85)"/></g><path d="M697.16,574.5c-1.21,19.86-15.78,36.27-21.33,55.37-1.38,4.78-2.21,9.74-4.19,14.29-4,9.15-12.23,15.79-21,20.47a31.54,31.54,0,0,1-10.34,3.76,19.82,19.82,0,0,1-19.91-10.59c-2.29-4.65-2.61-10-4-15-1.55-5.77-4.45-11.09-6.34-16.76-3.48-10.43-3.41-21.85-1-32.57a100,100,0,0,1,10.73-26.56c.7-1.23,1.41-2.45,2.14-3.66a83.18,83.18,0,0,1,6.93-10c6-7.23,13.71-12.79,21.34-18.27a5,5,0,0,1,2-1l.12,0a4.83,4.83,0,0,1,2.47.58A195.56,195.56,0,0,1,685.13,551c3.44,2.29,8.87,4.85,10.67,8.75S697.42,570.26,697.16,574.5Z" transform="translate(-91.39 -95.85)" fill="#fbbebe"/><path d="M657.46,483.11a10.35,10.35,0,0,0-2.22,3.55,167.86,167.86,0,0,0-14.1,57.62,5.76,5.76,0,0,1-.65,2.79,12.21,12.21,0,0,1-1.47,1.59,5.52,5.52,0,0,0,.94,8c1.65-3.11,5.6-4.12,9.11-4.39,16.81-1.33,33.23,6.49,50.09,5.9-1.19-4.11-2.9-8.06-3.87-12.22-4.29-18.47,6.41-38.58-.15-56.37-1.31-3.56-3.5-7.06-6.95-8.62a18.51,18.51,0,0,0-4.45-1.18c-4.26-.77-12.74-4.06-16.86-2.74-1.52.49-2.12,1.92-3.38,2.78C661.63,481.05,659.09,481.48,657.46,483.11Z" transform="translate(-91.39 -95.85)" fill="#f86d70"/><path d="M664.35,648.46a29.49,29.49,0,0,1-25,14.51,19.7,19.7,0,0,1-8-1.47c-6.39-2.82-10-9.8-11.34-16.66s-.92-13.94-1.87-20.87c-.76-5.52-2.38-10.88-3.22-16.39-2.06-13.63,2-27.09,4.89-40.66.7-1.23,1.41-2.45,2.14-3.66a83.18,83.18,0,0,1,6.93-10c6-7.23,13.71-12.79,21.34-18.27h-8a1.37,1.37,0,0,1,2.17.95c.79,7,10.66,14,12.81,20.8,1.33,4.18,2.93,8.28,4,12.54a100.47,100.47,0,0,1,1.92,11q2.13,15.53,4.24,31C669.13,623.87,670.65,637.48,664.35,648.46Z" transform="translate(-91.39 -95.85)" opacity="0.1"/><path d="M651.11,517.16l9.65-30.27c1.44-4.53,2.9-9.13,3.07-13.89s-1.08-9.75-4.41-13.15c-2.7-2.75-6.44-4.17-9.64-6.32-8-5.39-12-14.83-16.17-23.52s-9.66-17.78-18.76-21c-2.1-.74-5-.8-5.94,1.21a4.25,4.25,0,0,0-.15,2.62c.88,4.62,4.19,8.31,7.07,12,4.83,6.25,8.87,13.9,7.71,21.72-1.38,9.26-9.7,16.44-10.7,25.75-.44,4.1.61,8.21.6,12.34,0,2.56-.42,5.17.15,7.67A51.66,51.66,0,0,0,615.7,498a33.18,33.18,0,0,1,1.38,9.21l2.11,39.36c1.14,21.29-10.41,42-7.23,63,.84,5.51,2.46,10.87,3.22,16.39,1,6.93.53,14,1.87,20.87s5,13.84,11.34,16.66a19.7,19.7,0,0,0,8,1.47,29.49,29.49,0,0,0,25-14.51c6.3-11,4.78-24.59,3.06-37.13l-4.24-31a100.47,100.47,0,0,0-1.92-11c-1.06-4.26-2.66-8.36-4-12.54C650,545.11,646.79,530.74,651.11,517.16Z" transform="translate(-91.39 -95.85)" fill="#fbbebe"/><rect x="601.57" y="423.66" width="223" height="142" rx="7.97" fill="#3f3d56"/><rect x="601.57" y="423.66" width="223" height="142" rx="7.97" opacity="0.2"/><circle cx="712.57" cy="494.66" r="6" fill="#fff"/><path d="M449.44,611h12.11a25,25,0,0,1,25,25v37.11a0,0,0,0,1,0,0H424.44a0,0,0,0,1,0,0V636A25,25,0,0,1,449.44,611Z" fill="#3f3d56"/><path d="M449.44,611h12.11a25,25,0,0,1,25,25v37.11a0,0,0,0,1,0,0H424.44a0,0,0,0,1,0,0V636A25,25,0,0,1,449.44,611Z" opacity="0.1"/><circle cx="453.02" cy="619.7" r="4.97" fill="#3f3d56"/><circle cx="453.02" cy="613.49" r="4.97" fill="#3f3d56"/><circle cx="453.02" cy="607.28" r="4.97" fill="#3f3d56"/><circle cx="453.02" cy="601.07" r="4.97" fill="#3f3d56"/><circle cx="453.02" cy="594.86" r="4.97" fill="#3f3d56"/><circle cx="453.02" cy="588.65" r="4.97" fill="#3f3d56"/><circle cx="453.02" cy="582.44" r="4.97" fill="#3f3d56"/><circle cx="460.47" cy="584.92" r="4.97" fill="#3f3d56"/><circle cx="465.44" cy="582.44" r="4.97" fill="#3f3d56"/><circle cx="470.41" cy="579.95" r="4.97" fill="#3f3d56"/><circle cx="453.02" cy="576.22" r="4.97" fill="#3f3d56"/><circle cx="453.02" cy="570.01" r="4.97" fill="#3f3d56"/><circle cx="453.02" cy="563.8" r="4.97" fill="#3f3d56"/><circle cx="453.02" cy="557.59" r="4.97" fill="#3f3d56"/><path d="M565,637.41c-1.23.18-2.47.31-3.71.39a28.56,28.56,0,0,0,3.2-3.28,21.22,21.22,0,0,0-3-5.83,10.22,10.22,0,0,1-4,1.26c-1.23.18-2.47.32-3.71.4a68.41,68.41,0,0,0,4.75-5A21.1,21.1,0,1,0,565.52,641a20.68,20.68,0,0,0-.32-3.63Z" transform="translate(-91.39 -95.85)" fill="#0967d3"/><path d="M581.61,662.1a9.83,9.83,0,0,1-4.18,1.4c-1.23.18-2.47.31-3.71.39a36.4,36.4,0,0,0,3.68-3.82,12.44,12.44,0,1,0,4.21,2Z" transform="translate(-91.39 -95.85)" fill="#0967d3"/><circle cx="445.56" cy="584.92" r="4.97" fill="#3f3d56"/><circle cx="440.59" cy="582.44" r="4.97" fill="#3f3d56"/><circle cx="435.62" cy="579.95" r="4.97" fill="#3f3d56"/><path d="M507.2,662.1a9.78,9.78,0,0,0,4.18,1.4c1.23.18,2.47.31,3.71.39a35.42,35.42,0,0,1-3.68-3.82,12.44,12.44,0,1,1-4.21,2Z" transform="translate(-91.39 -95.85)" fill="#0967d3"/><path d="M449.44,614.73h12.11a25,25,0,0,1,25,25v32.87a4.24,4.24,0,0,1-4.24,4.24H428.68a4.24,4.24,0,0,1-4.24-4.24V639.73A25,25,0,0,1,449.44,614.73Z" fill="#3f3d56"/><g opacity="0.1"><path d="M565.38,638.77a18.83,18.83,0,0,1-1.6,1.52c.57,0,1.13-.09,1.7-.15C565.46,639.68,565.43,639.22,565.38,638.77Z" transform="translate(-91.39 -95.85)"/><path d="M556.32,632.83c1.25-.08,2.48-.21,3.72-.39a12,12,0,0,0,3.23-.88,21.92,21.92,0,0,0-1.74-2.87,7.52,7.52,0,0,1-2,.85A28.79,28.79,0,0,1,556.32,632.83Z" transform="translate(-91.39 -95.85)"/><path d="M525.77,643.5a21.08,21.08,0,0,1,32.5-17.76l.32-.34a21.1,21.1,0,1,0-27.82,31.73A21,21,0,0,1,525.77,643.5Z" transform="translate(-91.39 -95.85)"/></g><g opacity="0.1"><path d="M573.72,666.37c1.24-.08,2.48-.21,3.71-.39a9.7,9.7,0,0,0,4.18-1.4,12.43,12.43,0,0,1,5,8.8,11.38,11.38,0,0,0,.07-1.31,12.38,12.38,0,0,0-5-10,9.83,9.83,0,0,1-4.18,1.4l-1,.12A25.37,25.37,0,0,1,573.72,666.37Z" transform="translate(-91.39 -95.85)"/><path d="M574.22,662.13a10.19,10.19,0,0,1,1.24.09c.65-.69,1.29-1.43,1.94-2.15a12.4,12.4,0,0,0-15.6,12c0,.42,0,.83.06,1.24A12.42,12.42,0,0,1,574.22,662.13Z" transform="translate(-91.39 -95.85)"/></g><g opacity="0.1"><path d="M515.09,666.37c-1.24-.08-2.48-.21-3.71-.39a9.65,9.65,0,0,1-4.18-1.4,12.43,12.43,0,0,0-5,8.8,11.38,11.38,0,0,1-.07-1.31,12.38,12.38,0,0,1,5-10,9.78,9.78,0,0,0,4.18,1.4l1,.12A23.67,23.67,0,0,0,515.09,666.37Z" transform="translate(-91.39 -95.85)"/><path d="M514.59,662.13a10.36,10.36,0,0,0-1.25.09c-.64-.69-1.28-1.43-1.93-2.15a12.4,12.4,0,0,1,15.6,12c0,.42,0,.83-.06,1.24A12.42,12.42,0,0,0,514.59,662.13Z" transform="translate(-91.39 -95.85)"/></g><rect x="158.11" y="179.65" width="226" height="88" fill="#0967d3"/><rect x="158.11" y="179.65" width="371" height="88" rx="12" fill="none" stroke="#3f3d56" stroke-miterlimit="10" stroke-width="9"/><path d="M452.76,314.79A18.1,18.1,0,0,0,418.93,310a14.48,14.48,0,0,0,1.57,28.88h31.42A12.11,12.11,0,0,0,464,326.75,11.93,11.93,0,0,0,452.76,314.79Zm-13.89,7.13v9.18h-7.74v-9.18h-8.21L435,309.83l12.08,12.09Z" transform="translate(-91.39 -95.85)" fill="#fff"/></svg>
</file>

<file path="resources/scripts/assets/images/server_restore.svg">
<svg id="f38f865d-e131-49ab-9ab3-db2059075423" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" width="529.16032" height="479.14405" viewBox="0 0 529.16032 479.14405"><path d="M765.72354,403.19867c-28.1703-21.05969-72.292-40.97652-121.05146-54.643-44.39571-12.44368-87.69779-18.45153-121.939-16.91729l-.17824-3.982c34.64906-1.55175,78.40036,4.50652,123.19313,17.06132,49.21419,13.794,93.81384,33.94594,122.36243,55.28863Z" transform="translate(-335.41984 -210.42797)" fill="#3f3d56"/><path d="M762.79915,419.42a132.645,132.645,0,0,1-11.47943,54.15643q-.95064,2.14046-1.981,4.241A133.14833,133.14833,0,0,1,496.541,419.42q0-4.62167.31485-9.17157.14943-2.31379.38666-4.59967A133.13571,133.13571,0,0,1,762.79909,419.42Z" transform="translate(-335.41984 -210.42797)" fill="#f2f2f2"/><path d="M751.31978,473.57642q-.95064,2.14046-1.981,4.241-5.83542.63373-12.28455.92073c-3.55944.15942-7.22243.23917-10.96523.23917-32.69234,0-72.03715-6.03467-112.231-17.29881-44.79353-12.55559-85.31818-30.11744-114.11236-49.453q-1.47081-.98649-2.88975-1.977.14943-2.31378.38666-4.59966,2.28992,1.63222,4.72327,3.2684c28.45533,19.10443,68.57346,36.479,112.9684,48.923,39.843,11.16847,78.81718,17.15132,111.13487,17.15132q5.54229,0,10.8058-.23519Q744.53983,474.40949,751.31978,473.57642Z" transform="translate(-335.41984 -210.42797)" opacity="0.1" style="isolation:isolate"/><path d="M726.08951,475.78934c-32.69134.00079-72.03851-6.03452-112.23055-17.29975-44.79312-12.55479-85.31948-30.11732-114.11389-49.45238-29.39541-19.73857-43.17947-39.18813-38.81332-54.76584,4.366-15.57772,26.25091-25.02983,61.623-26.615l.17824,3.982c-16.51832.74014-29.98006,3.19534-40.01121,7.29724-10.00674,4.09178-16.04676,9.61345-17.95214,16.41168-1.90539,6.798.38494,14.65439,6.8072,23.35119,6.438,8.7178,16.66275,17.81181,30.39018,27.02963,28.45209,19.10528,68.57151,36.48015,112.9678,48.92363,39.844,11.16752,78.81478,17.15181,111.13517,17.15258q5.53931,0,10.80357-.23549c16.5185-.74035,29.98024-3.19534,40.01162-7.29724,10.00675-4.09178,16.04676-9.61324,17.95215-16.41147,3.42112-12.20681-6.91811-28.06791-29.11379-44.66139l2.38689-3.19222c11.42169,8.53893,19.87659,16.95584,25.12983,25.01638,5.63166,8.64167,7.46025,16.68743,5.43507,23.913-4.3662,15.57772-26.25127,25.02942-61.623,26.61484C733.493,475.71033,729.83213,475.78934,726.08951,475.78934Z" transform="translate(-335.41984 -210.42797)" fill="#3f3d56"/><circle cx="297.772" cy="50.32748" r="1.52555" fill="#f2f2f2"/><circle cx="95.3852" cy="115.42627" r="2.62444" fill="#ccc"/><circle cx="89.79158" cy="218.14518" r="5.18452" fill="#ccc"/><circle cx="400.99939" cy="59.48065" r="3.45535" fill="#ccc"/><circle cx="523.55018" cy="202.8899" r="5.61015" fill="#ccc"/><circle cx="479.6815" cy="113.28657" r="2.40701" fill="#ccc"/><circle cx="187.42543" cy="82.36358" r="3.75502" fill="#ccc"/><circle cx="471.25695" cy="191.51423" r="2.40701" fill="#ccc"/><circle cx="2.99584" cy="200.37057" r="2.99584" fill="#ccc"/><circle cx="48.50845" cy="151.06835" r="3.24432" fill="#ccc"/><polygon points="256.822 6.402 250.42 6.402 250.42 0 246.985 0 246.985 6.402 240.58 6.402 240.58 9.84 246.985 9.84 246.985 16.242 250.42 16.242 250.42 9.84 256.822 9.84 256.822 6.402" fill="#ccc"/><polygon points="405.335 352.829 401.314 352.829 401.314 348.81 399.158 348.81 399.158 352.829 395.138 352.829 395.138 354.986 399.158 354.986 399.158 359.006 401.314 359.006 401.314 354.986 405.335 354.986 405.335 352.829" fill="#ccc"/><polygon points="498.123 332.252 495.118 332.252 495.118 329.247 493.504 329.247 493.504 332.252 490.499 332.252 490.499 333.866 493.504 333.866 493.504 336.871 495.118 336.871 495.118 333.866 498.123 333.866 498.123 332.252" fill="#ccc"/><circle cx="210.30838" cy="186.6176" r="11.1872" opacity="0.1" style="isolation:isolate"/><circle cx="333.87617" cy="298.99821" r="11.18721" opacity="0.1" style="isolation:isolate"/><circle cx="296.2465" cy="203.90693" r="11.18722" opacity="0.1" style="isolation:isolate"/><circle cx="215.90196" cy="265.43656" r="11.18719" opacity="0.1" style="isolation:isolate"/><circle cx="356.25061" cy="143.9028" r="11.18722" opacity="0.1" style="isolation:isolate"/><circle cx="393.37178" cy="219.67073" r="11.18722" opacity="0.1" style="isolation:isolate"/><circle cx="356.25061" cy="97.11993" r="14.74678" fill="#fff"/><path d="M691.67038,286.19055a20.84885,20.84885,0,0,0-20.84883,20.84885c0,11.51451,20.84883,49.32542,20.84883,49.32542s20.84883-37.81091,20.84883-49.32542A20.84885,20.84885,0,0,0,691.67038,286.19055Zm0,31.01907a9.66171,9.66171,0,1,1,9.66173-9.6617,9.66167,9.66167,0,0,1-9.66173,9.6617h0Z" transform="translate(-335.41984 -210.42797)" fill="#0967d3"/><circle cx="210.25061" cy="137.11993" r="14.74678" fill="#fff"/><path d="M545.67038,326.19055a20.84885,20.84885,0,0,0-20.84883,20.84885c0,11.51451,20.84883,49.32542,20.84883,49.32542s20.84883-37.81091,20.84883-49.32542A20.84885,20.84885,0,0,0,545.67038,326.19055Zm0,31.01907a9.66171,9.66171,0,1,1,9.66173-9.6617,9.66167,9.66167,0,0,1-9.66173,9.6617h0Z" transform="translate(-335.41984 -210.42797)" fill="#3f3d56"/><circle cx="395.25061" cy="171.11993" r="14.74678" fill="#fff"/><path d="M730.67038,360.19055a20.84885,20.84885,0,0,0-20.84883,20.84885c0,11.51451,20.84883,49.32542,20.84883,49.32542s20.84883-37.81091,20.84883-49.32542A20.84885,20.84885,0,0,0,730.67038,360.19055Zm0,31.01907a9.66171,9.66171,0,1,1,9.66173-9.6617,9.66167,9.66167,0,0,1-9.66173,9.6617h0Z" transform="translate(-335.41984 -210.42797)" fill="#ccc" style="isolation:isolate"/><circle cx="145.25061" cy="245.11993" r="14.74678" fill="#fff"/><path d="M480.67038,434.19055a20.84885,20.84885,0,0,0-20.84883,20.84885c0,11.51451,20.84883,49.32542,20.84883,49.32542s20.84883-37.81091,20.84883-49.32542A20.84885,20.84885,0,0,0,480.67038,434.19055Zm0,31.01907a9.66171,9.66171,0,1,1,9.66173-9.6617,9.66167,9.66167,0,0,1-9.66173,9.6617h0Z" transform="translate(-335.41984 -210.42797)" fill="#0967d3"/><ellipse cx="806.28614" cy="557.44742" rx="6.76007" ry="21.53369" transform="translate(-505.20259 437.21082) rotate(-39.93837)" fill="#2f2e41"/><circle cx="425.05916" cy="339.54155" r="43.06732" fill="#2f2e41"/><rect x="430.20422" y="373.34107" width="13.08374" height="23.44171" fill="#2f2e41"/><rect x="404.03674" y="373.34107" width="13.08374" height="23.44171" fill="#2f2e41"/><ellipse cx="432.38483" cy="397.05537" rx="10.90314" ry="4.08868" fill="#2f2e41"/><ellipse cx="406.21735" cy="396.51023" rx="10.90314" ry="4.08868" fill="#2f2e41"/><path d="M746.95616,495.83258c3.84558-15.487,20.82055-24.60076,37.91473-20.35617s27.83429,20.2403,23.98871,35.7273-16.604,15.537-33.69812,11.29236S743.11057,511.31961,746.95616,495.83258Z" transform="translate(-335.41984 -210.42797)" fill="#0967d3"/><ellipse cx="711.97081" cy="529.9859" rx="6.76007" ry="21.53369" transform="translate(-407.4064 735.72895) rotate(-64.62574)" fill="#2f2e41"/><circle cx="418.62054" cy="330.45396" r="14.35864" fill="#fff"/><circle cx="412.71918" cy="325.30717" r="4.78621" fill="#3f3d56"/><path d="M763.04777,570.79734a9.57244,9.57244,0,1,1-18.83533,3.42883h0l-.00335-.01849c-.94178-5.20215,3.08038-7.043,8.28253-7.98474S762.10606,565.59525,763.04777,570.79734Z" transform="translate(-335.41984 -210.42797)" fill="#fff"/><path d="M671.78358,458.47658a29.898,29.898,0,1,0,1.6951,44.1547l36.67359,30.945a2.75511,2.75511,0,0,0,3.55755-4.20789l-.00405-.00342-36.6736-30.945A29.89973,29.89973,0,0,0,671.78358,458.47658Zm-2.3642,36.96358a22.39982,22.39982,0,1,1-2.67418-31.565l0,0A22.39982,22.39982,0,0,1,669.41938,495.44016Z" transform="translate(-335.41984 -210.42797)" fill="#3f3d56"/><path d="M637.85433,498.11434a22.401,22.401,0,0,1-3.80106-30.11267q-.64243.647-1.24211,1.35516a22.39981,22.39981,0,1,0,34.23921,28.89088q.59832-.70909,1.12688-1.45239A22.401,22.401,0,0,1,637.85433,498.11434Z" transform="translate(-335.41984 -210.42797)" opacity="0.3" style="isolation:isolate"/><ellipse cx="477.08894" cy="517.44733" rx="21.53369" ry="6.76007" transform="translate(-512.00949 567.92143) rotate(-69.08217)" fill="#2f2e41"/><circle cx="101.8619" cy="339.54148" r="43.06735" fill="#2f2e41"/><rect x="82.2363" y="373.34109" width="13.08374" height="23.44171" fill="#2f2e41"/><rect x="108.40377" y="373.34109" width="13.08374" height="23.44171" fill="#2f2e41"/><ellipse cx="93.13944" cy="397.05537" rx="10.90314" ry="4.08868" fill="#2f2e41"/><ellipse cx="119.30692" cy="396.51022" rx="10.90314" ry="4.08868" fill="#2f2e41"/><circle cx="102.95225" cy="328.63826" r="14.71921" fill="#fff"/><circle cx="102.95224" cy="328.63827" r="4.90643" fill="#3f3d56"/><path d="M395.505,509.91794c-3.47747-15.57379,7.63868-31.31042,24.82862-35.1488s33.94421,5.67511,37.42169,21.24884-7.91492,21.31763-25.10486,25.156S398.98249,525.49179,395.505,509.91794Z" transform="translate(-335.41984 -210.42797)" fill="#0967d3"/><ellipse cx="388.77359" cy="529.98595" rx="6.76007" ry="21.53369" transform="translate(-592.1042 443.71128) rotate(-64.62574)" fill="#2f2e41"/><path d="M416.12724,565.50632c0,4.21515,10.85327,12.53858,22.89657,12.53858s23.33515-11.867,23.33515-16.0821-11.29193.81775-23.33515.81775S416.12724,561.29117,416.12724,565.50632Z" transform="translate(-335.41984 -210.42797)" fill="#fff"/><circle cx="241.58115" cy="417.54139" r="43.06733" fill="#2f2e41"/><rect x="221.95553" y="451.34107" width="13.08374" height="23.44171" fill="#2f2e41"/><rect x="248.12302" y="451.34107" width="13.08373" height="23.44171" fill="#2f2e41"/><ellipse cx="232.85861" cy="475.05537" rx="10.90314" ry="4.08868" fill="#2f2e41"/><ellipse cx="259.02615" cy="474.5102" rx="10.90314" ry="4.08868" fill="#2f2e41"/><path d="M535.22424,587.91806c-3.47748-15.57379,7.63865-31.31042,24.82866-35.1488s33.94421,5.67511,37.42169,21.2489-7.91492,21.31769-25.10486,25.156S538.70173,603.49186,535.22424,587.91806Z" transform="translate(-335.41984 -210.42797)" fill="#3f3d56"/><path d="M577.1739,620.50684s3.12411-13.7461-2.8117-13.12127-14.05851.93723-16.24539.93723-14.68333-1.56207-16.5578,6.56062-4.37375,18.11986.93724,24.36809c0,0,1.87447,27.49221,9.05992,29.36666s26.24255,4.06135,33.1156-4.99859a23.3002,23.3002,0,0,0,4.06135-19.05709H585.609Z" transform="translate(-335.41984 -210.42797)" fill="#0967d3"/><path d="M545.62034,641.43839s5.311,2.49929,16.24538.93724v4.68617l-16.24538-1.24965Z" transform="translate(-335.41984 -210.42797)" opacity="0.1" style="isolation:isolate"/><path d="M585.31128,657.10278l-3.53662-1.86914L597.50439,625.468a7.431,7.431,0,0,0-6.37036-10.90039l-16.50732-.44433.10742-3.999,16.50757.44434a11.43167,11.43167,0,0,1,9.79931,16.76855Z" transform="translate(-335.41984 -210.42797)" fill="#0967d3"/><path d="M547.2937,657.10278,531.564,627.33715A11.43168,11.43168,0,0,1,541.363,610.5686l16.50781-.44434.10742,3.999-16.50757.44433a7.431,7.431,0,0,0-6.37012,10.90039l15.72974,29.76563Z" transform="translate(-335.41984 -210.42797)" fill="#0967d3"/><ellipse cx="611.10465" cy="627.84819" rx="7.50055" ry="23.89244" transform="translate(-565.0462 664.02437) rotate(-62.12179)" fill="#2f2e41"/></svg>
</file>

<file path="resources/scripts/assets/tailwind.css">
@tailwind base;
@tailwind components;
@tailwind utilities;
</file>

<file path="resources/scripts/components/dashboard/activity/ActivityLogContainer.tsx">
import classNames from 'classnames';
import * as Icon from 'react-feather';
import { Link } from 'react-router-dom';
import { useFlashKey } from '@/plugins/useFlash';
import React, { useEffect, useState } from 'react';
import Spinner from '@/components/elements/Spinner';
import useLocationHash from '@/plugins/useLocationHash';
import Tooltip from '@/components/elements/tooltip/Tooltip';
import FlashMessageRender from '@/components/FlashMessageRender';
import { styles as btnStyles } from '@/components/elements/button/index';
import PaginationFooter from '@/components/elements/table/PaginationFooter';
import { ActivityLogFilters, useActivityLogs } from '@/api/account/activity';
import ActivityLogEntry from '@/components/elements/activity/ActivityLogEntry';

export default () => {
    const { hash } = useLocationHash();
    const { clearAndAddHttpError } = useFlashKey('account');
    const [filters, setFilters] = useState<ActivityLogFilters>({ page: 1, sorts: { timestamp: -1 } });
    const { data, isValidating, error } = useActivityLogs(filters, {
        revalidateOnMount: true,
        revalidateOnFocus: false,
    });

    useEffect(() => {
        setFilters((value) => ({ ...value, filters: { ip: hash.ip, event: hash.event } }));
    }, [hash]);

    useEffect(() => {
        clearAndAddHttpError(error);
    }, [error]);

    return (
        <>
            <FlashMessageRender byKey={'account'} />
            {(filters.filters?.event || filters.filters?.ip) && (
                <div className={'flex justify-end mb-2'}>
                    <Link
                        to={'#'}
                        className={classNames(btnStyles.button, btnStyles.text, 'w-full sm:w-auto')}
                        onClick={() => setFilters((value) => ({ ...value, filters: {} }))}
                    >
                        Clear Filters <Icon.XCircle className={'w-4 h-4 ml-2'} />
                    </Link>
                </div>
            )}
            {!data && isValidating ? (
                <Spinner centered />
            ) : (
                <div className={'bg-gray-850'}>
                    {data?.items.map((activity) => (
                        <ActivityLogEntry key={activity.id} activity={activity}>
                            {typeof activity.properties.useragent === 'string' && (
                                <Tooltip content={activity.properties.useragent} placement={'top'}>
                                    <span>
                                        <Icon.Monitor />
                                    </span>
                                </Tooltip>
                            )}
                        </ActivityLogEntry>
                    ))}
                </div>
            )}
            {data && (
                <PaginationFooter
                    pagination={data.pagination}
                    onPageSelect={(page) => setFilters((value) => ({ ...value, page }))}
                />
            )}
        </>
    );
};
</file>

<file path="resources/scripts/components/dashboard/forms/AddReferralCodeForm.tsx">
import React from 'react';
import * as Yup from 'yup';
import { ApplicationStore } from '@/state';
import { httpErrorToHuman } from '@/api/http';
import { useStoreState } from '@/state/hooks';
import Field from '@/components/elements/Field';
import { Form, Formik, FormikHelpers } from 'formik';
import { Actions, useStoreActions } from 'easy-peasy';
import { Button } from '@/components/elements/button/index';
import useReferralCode from '@/api/account/useReferralCode';

interface Values {
    code: string;
    password: string;
}

const schema = Yup.object().shape({
    code: Yup.string().length(16).required(),
    password: Yup.string().required('You must provide your current account password.'),
});

export default () => {
    const code = useStoreState((state) => state.user.data!.referralCode);
    const { clearFlashes, addFlash } = useStoreActions((actions: Actions<ApplicationStore>) => actions.flashes);

    const submit = (values: Values, { resetForm, setSubmitting }: FormikHelpers<Values>) => {
        clearFlashes('account:referral');

        useReferralCode({ ...values })
            .then(() =>
                addFlash({
                    type: 'success',
                    key: 'account:referral',
                    message: 'You are now using a referral code.',
                })
            )
            .catch((error) =>
                addFlash({
                    type: 'danger',
                    key: 'account:referral',
                    title: 'Error',
                    message: httpErrorToHuman(error),
                })
            )
            .then(() => {
                resetForm();
                setSubmitting(false);

                // @ts-expect-error this is valid
                window.location = '/account';
            });
    };

    return (
        <>
            {code ? (
                <p className={'my-2 text-gray-400'}>
                    You have already used a referral code.
                    <span className={'bg-gray-800 rounded p-1 ml-2'}>{code}</span>
                </p>
            ) : (
                <Formik onSubmit={submit} initialValues={{ code: '', password: '' }} validationSchema={schema}>
                    {({ isSubmitting, isValid }) => (
                        <React.Fragment>
                            <Form className={'m-0'}>
                                <Field id={'code'} type={'text'} name={'code'} label={'Enter referral code'} />
                                <div className={'mt-6'}>
                                    <Field
                                        id={'confirm_password'}
                                        type={'password'}
                                        name={'password'}
                                        label={'Confirm Password'}
                                    />
                                </div>
                                <div className={'mt-6'}>
                                    <Button disabled={isSubmitting || !isValid}>Use Code</Button>
                                </div>
                            </Form>
                        </React.Fragment>
                    )}
                </Formik>
            )}
        </>
    );
};
</file>

<file path="resources/scripts/components/dashboard/forms/ConfigureTwoFactorForm.tsx">
import React, { useEffect, useState } from 'react';
import { useStoreState } from 'easy-peasy';
import { ApplicationStore } from '@/state';
import tw from 'twin.macro';
import { Button } from '@/components/elements/button/index';
import SetupTOTPDialog from '@/components/dashboard/forms/SetupTOTPDialog';
import RecoveryTokensDialog from '@/components/dashboard/forms/RecoveryTokensDialog';
import DisableTOTPDialog from '@/components/dashboard/forms/DisableTOTPDialog';
import { useFlashKey } from '@/plugins/useFlash';

export default () => {
    const [tokens, setTokens] = useState<string[]>([]);
    const [visible, setVisible] = useState<'enable' | 'disable' | null>(null);
    const isEnabled = useStoreState((state: ApplicationStore) => state.user.data!.useTotp);
    const { clearAndAddHttpError } = useFlashKey('account:two-step');

    useEffect(() => {
        return () => {
            clearAndAddHttpError();
        };
    }, [visible]);

    const onTokens = (tokens: string[]) => {
        setTokens(tokens);
        setVisible(null);
    };

    return (
        <div>
            <SetupTOTPDialog open={visible === 'enable'} onClose={() => setVisible(null)} onTokens={onTokens} />
            <RecoveryTokensDialog tokens={tokens} open={tokens.length > 0} onClose={() => setTokens([])} />
            <DisableTOTPDialog open={visible === 'disable'} onClose={() => setVisible(null)} />
            <p css={tw`text-sm`}>
                {isEnabled
                    ? 'Two-step verification is currently enabled on your account.'
                    : 'You do not currently have two-step verification enabled on your account. Click the button below to begin configuring it.'}
            </p>
            <div css={tw`mt-6`}>
                {isEnabled ? (
                    <Button.Danger onClick={() => setVisible('disable')}>Disable Two-Step</Button.Danger>
                ) : (
                    <Button onClick={() => setVisible('enable')}>Enable Two-Step</Button>
                )}
            </div>
        </div>
    );
};
</file>

<file path="resources/scripts/components/dashboard/forms/CreateApiKeyForm.tsx">
import tw from 'twin.macro';
import { object, string } from 'yup';
import React, { useState } from 'react';
import { ApplicationStore } from '@/state';
import styled from 'styled-components/macro';
import { httpErrorToHuman } from '@/api/http';
import { ApiKey } from '@/api/account/getApiKeys';
import createApiKey from '@/api/account/createApiKey';
import { Actions, useStoreActions } from 'easy-peasy';
import { Button } from '@/components/elements/button/index';
import { Field, Form, Formik, FormikHelpers } from 'formik';
import ApiKeyModal from '@/components/dashboard/ApiKeyModal';
import Input, { Textarea } from '@/components/elements/Input';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import FormikFieldWrapper from '@/components/elements/FormikFieldWrapper';

interface Values {
    description: string;
    allowedIps: string;
}

const CustomTextarea = styled(Textarea)`
    ${tw`h-32`}
`;

export default ({ onKeyCreated }: { onKeyCreated: (key: ApiKey) => void }) => {
    const [apiKey, setApiKey] = useState('');
    const { addError, clearFlashes } = useStoreActions((actions: Actions<ApplicationStore>) => actions.flashes);

    const submit = (values: Values, { setSubmitting, resetForm }: FormikHelpers<Values>) => {
        clearFlashes('account');
        createApiKey(values.description, values.allowedIps)
            .then(({ secretToken, ...key }) => {
                resetForm();
                setSubmitting(false);
                setApiKey(`${key.identifier}${secretToken}`);
                onKeyCreated(key);
            })
            .catch((error) => {
                console.error(error);

                addError({ key: 'account', message: httpErrorToHuman(error) });
                setSubmitting(false);
            });
    };

    return (
        <>
            <ApiKeyModal visible={apiKey.length > 0} onModalDismissed={() => setApiKey('')} apiKey={apiKey} />
            <Formik
                onSubmit={submit}
                initialValues={{ description: '', allowedIps: '' }}
                validationSchema={object().shape({
                    allowedIps: string(),
                    description: string().required().min(4),
                })}
            >
                {({ isSubmitting }) => (
                    <Form>
                        <SpinnerOverlay visible={isSubmitting} />
                        <FormikFieldWrapper
                            label={'Description'}
                            name={'description'}
                            description={'A description of this API key.'}
                            css={tw`mb-6`}
                        >
                            <Field name={'description'} as={Input} />
                        </FormikFieldWrapper>
                        <FormikFieldWrapper
                            label={'Allowed IPs'}
                            name={'allowedIps'}
                            description={
                                'Leave blank to allow any IP address to use this API key, otherwise provide each IP address on a new line.'
                            }
                        >
                            <Field name={'allowedIps'} as={CustomTextarea} />
                        </FormikFieldWrapper>
                        <div css={tw`flex justify-end mt-6`}>
                            <Button>Create</Button>
                        </div>
                    </Form>
                )}
            </Formik>
        </>
    );
};
</file>

<file path="resources/scripts/components/dashboard/forms/CreateSSHKeyForm.tsx">
import React from 'react';
import tw from 'twin.macro';
import { object, string } from 'yup';
import styled from 'styled-components/macro';
import { useFlashKey } from '@/plugins/useFlash';
import { Button } from '@/components/elements/button/index';
import { Field, Form, Formik, FormikHelpers } from 'formik';
import Input, { Textarea } from '@/components/elements/Input';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import { createSSHKey, useSSHKeys } from '@/api/account/ssh-keys';
import FormikFieldWrapper from '@/components/elements/FormikFieldWrapper';

interface Values {
    name: string;
    publicKey: string;
}

const CustomTextarea = styled(Textarea)`
    ${tw`h-32`}
`;

export default () => {
    const { clearAndAddHttpError } = useFlashKey('account');
    const { mutate } = useSSHKeys();

    const submit = (values: Values, { setSubmitting, resetForm }: FormikHelpers<Values>) => {
        clearAndAddHttpError();

        createSSHKey(values.name, values.publicKey)
            .then((key) => {
                resetForm();
                mutate((data) => (data || []).concat(key));
            })
            .catch((error) => clearAndAddHttpError(error))
            .then(() => setSubmitting(false));
    };

    return (
        <>
            <Formik
                onSubmit={submit}
                initialValues={{ name: '', publicKey: '' }}
                validationSchema={object().shape({
                    name: string().required(),
                    publicKey: string().required(),
                })}
            >
                {({ isSubmitting }) => (
                    <Form>
                        <SpinnerOverlay visible={isSubmitting} />
                        <FormikFieldWrapper label={'SSH Key Name'} name={'name'} css={tw`mb-6`}>
                            <Field name={'name'} as={Input} />
                        </FormikFieldWrapper>
                        <FormikFieldWrapper
                            label={'Public Key'}
                            name={'publicKey'}
                            description={'Enter your public SSH key.'}
                        >
                            <Field name={'publicKey'} as={CustomTextarea} />
                        </FormikFieldWrapper>
                        <div css={tw`flex justify-end mt-6`}>
                            <Button>Save</Button>
                        </div>
                    </Form>
                )}
            </Formik>
        </>
    );
};
</file>

<file path="resources/scripts/components/dashboard/forms/DisableTOTPDialog.tsx">
import React, { useContext, useEffect, useState } from 'react';
import asDialog from '@/hoc/asDialog';
import { Dialog, DialogWrapperContext } from '@/components/elements/dialog';
import { Button } from '@/components/elements/button/index';
import { Input } from '@/components/elements/inputs';
import Tooltip from '@/components/elements/tooltip/Tooltip';
import disableAccountTwoFactor from '@/api/account/disableAccountTwoFactor';
import { useFlashKey } from '@/plugins/useFlash';
import { useStoreActions } from '@/state/hooks';
import FlashMessageRender from '@/components/FlashMessageRender';

const DisableTOTPDialog = () => {
    const [submitting, setSubmitting] = useState(false);
    const [password, setPassword] = useState('');
    const { clearAndAddHttpError } = useFlashKey('account:two-step');
    const { close, setProps } = useContext(DialogWrapperContext);
    const updateUserData = useStoreActions((actions) => actions.user.updateUserData);

    useEffect(() => {
        setProps((state) => ({ ...state, preventExternalClose: submitting }));
    }, [submitting]);

    const submit = (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();
        e.stopPropagation();

        if (submitting) return;

        setSubmitting(true);
        clearAndAddHttpError();
        disableAccountTwoFactor(password)
            .then(() => {
                updateUserData({ useTotp: false });
                close();
            })
            .catch(clearAndAddHttpError)
            .then(() => setSubmitting(false));
    };

    return (
        <form id={'disable-totp-form'} className={'mt-6'} onSubmit={submit}>
            <FlashMessageRender byKey={'account:two-step'} className={'-mt-2 mb-6'} />
            <label className={'block pb-1'} htmlFor={'totp-password'}>
                Password
            </label>
            <Input.Text
                id={'totp-password'}
                type={'password'}
                variant={Input.Text.Variants.Loose}
                value={password}
                onChange={(e) => setPassword(e.currentTarget.value)}
            />
            <Dialog.Footer>
                <Button.Text onClick={close}>Cancel</Button.Text>
                <Tooltip
                    delay={100}
                    disabled={password.length > 0}
                    content={'You must enter your account password to continue.'}
                >
                    <Button.Danger type={'submit'} form={'disable-totp-form'} disabled={submitting || !password.length}>
                        Disable
                    </Button.Danger>
                </Tooltip>
            </Dialog.Footer>
        </form>
    );
};

export default asDialog({
    title: 'Disable Two-Step Verification',
    description: 'Disabling two-step verification will make your account less secure.',
})(DisableTOTPDialog);
</file>

<file path="resources/scripts/components/dashboard/forms/DiscordAccountForm.tsx">
import React from 'react';
import { useStoreState } from '@/state/hooks';
import { Button } from '@/components/elements/button';
import { linkDiscord, unlinkDiscord } from '@/api/account/discord';

export default () => {
    const discordId = useStoreState((state) => state.user.data!.discordId);

    const link = () => {
        linkDiscord().then((data) => {
            window.location.href = data;
        });
    };

    const unlink = () => {
        unlinkDiscord().then(() => {
            window.location.href = '/account';
        });
    };

    return (
        <>
            {discordId ? (
                <>
                    <p className={'text-gray-400'}>Your account is currently linked to the Discord: {discordId}</p>
                    <Button.Success className={'mt-4'} onClick={() => unlink()}>
                        Unlink Discord Account
                    </Button.Success>
                </>
            ) : (
                <>
                    <p className={'text-gray-400'}>Your account is not linked to Discord.</p>
                    <Button.Success className={'mt-4'} onClick={() => link()}>
                        Link Discord Account
                    </Button.Success>
                </>
            )}
        </>
    );
};
</file>

<file path="resources/scripts/components/dashboard/forms/RecoveryTokensDialog.tsx">
import React from 'react';
import { Dialog, DialogProps } from '@/components/elements/dialog';
import { Button } from '@/components/elements/button/index';
import CopyOnClick from '@/components/elements/CopyOnClick';
import { Alert } from '@/components/elements/alert';

interface RecoveryTokenDialogProps extends DialogProps {
    tokens: string[];
}

export default ({ tokens, open, onClose }: RecoveryTokenDialogProps) => {
    const grouped = [] as [string, string][];
    tokens.forEach((token, index) => {
        if (index % 2 === 0) {
            grouped.push([token, tokens[index + 1] || '']);
        }
    });

    return (
        <Dialog
            open={open}
            onClose={onClose}
            title={'Two-Step Authentication Enabled'}
            description={
                'Store the codes below somewhere safe. If you lose access to your phone you can use these backup codes to sign in.'
            }
            hideCloseIcon
            preventExternalClose
        >
            <Dialog.Icon position={'container'} type={'success'} />
            <CopyOnClick text={tokens.join('\n')} showInNotification={false}>
                <pre className={'bg-gray-800 rounded p-2 mt-6'}>
                    {grouped.map((value) => (
                        <span key={value.join('_')} className={'block'}>
                            {value[0]}
                            <span className={'mx-2 selection:bg-gray-800'}>&nbsp;</span>
                            {value[1]}
                            <span className={'selection:bg-gray-800'}>&nbsp;</span>
                        </span>
                    ))}
                </pre>
            </CopyOnClick>
            <Alert type={'danger'} className={'mt-3'}>
                These codes will not be shown again.
            </Alert>
            <Dialog.Footer>
                <Button.Text onClick={onClose}>Done</Button.Text>
            </Dialog.Footer>
        </Dialog>
    );
};
</file>

<file path="resources/scripts/components/dashboard/forms/SetupTOTPDialog.tsx">
import React, { useContext, useEffect, useState } from 'react';
import { Dialog, DialogWrapperContext } from '@/components/elements/dialog';
import getTwoFactorTokenData, { TwoFactorTokenData } from '@/api/account/getTwoFactorTokenData';
import { useFlashKey } from '@/plugins/useFlash';
import tw from 'twin.macro';
import QRCode from 'qrcode.react';
import { Button } from '@/components/elements/button/index';
import Spinner from '@/components/elements/Spinner';
import { Input } from '@/components/elements/inputs';
import CopyOnClick from '@/components/elements/CopyOnClick';
import Tooltip from '@/components/elements/tooltip/Tooltip';
import enableAccountTwoFactor from '@/api/account/enableAccountTwoFactor';
import FlashMessageRender from '@/components/FlashMessageRender';
import { Actions, useStoreActions } from 'easy-peasy';
import { ApplicationStore } from '@/state';
import asDialog from '@/hoc/asDialog';

interface Props {
    onTokens: (tokens: string[]) => void;
}

const ConfigureTwoFactorForm = ({ onTokens }: Props) => {
    const [submitting, setSubmitting] = useState(false);
    const [value, setValue] = useState('');
    const [password, setPassword] = useState('');
    const [token, setToken] = useState<TwoFactorTokenData | null>(null);
    const { clearAndAddHttpError } = useFlashKey('account:two-step');
    const updateUserData = useStoreActions((actions: Actions<ApplicationStore>) => actions.user.updateUserData);

    const { close, setProps } = useContext(DialogWrapperContext);

    useEffect(() => {
        getTwoFactorTokenData()
            .then(setToken)
            .catch((error) => clearAndAddHttpError(error));
    }, []);

    useEffect(() => {
        setProps((state) => ({ ...state, preventExternalClose: submitting }));
    }, [submitting]);

    const submit = (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();
        e.stopPropagation();

        if (submitting) return;

        setSubmitting(true);
        clearAndAddHttpError();
        enableAccountTwoFactor(value, password)
            .then((tokens) => {
                updateUserData({ useTotp: true });
                onTokens(tokens);
            })
            .catch((error) => {
                clearAndAddHttpError(error);
                setSubmitting(false);
            });
    };

    return (
        <form id={'enable-totp-form'} onSubmit={submit}>
            <FlashMessageRender byKey={'account:two-step'} className={'mt-4'} />
            <div className={'flex items-center justify-center w-56 h-56 p-2 bg-gray-50 shadow mx-auto mt-6'}>
                {!token ? (
                    <Spinner />
                ) : (
                    <QRCode renderAs={'svg'} value={token.image_url_data} css={tw`w-full h-full shadow-none`} />
                )}
            </div>
            <CopyOnClick text={token?.secret}>
                <p className={'font-mono text-sm text-gray-100 text-center mt-2'}>
                    {token?.secret.match(/.{1,4}/g)!.join(' ') || 'Loading...'}
                </p>
            </CopyOnClick>
            <p id={'totp-code-description'} className={'mt-6'}>
                Scan the QR code above using the two-step authentication app of your choice. Then, enter the 6-digit
                code generated into the field below.
            </p>
            <Input.Text
                aria-labelledby={'totp-code-description'}
                variant={Input.Text.Variants.Loose}
                value={value}
                onChange={(e) => setValue(e.currentTarget.value)}
                className={'mt-3'}
                placeholder={'000000'}
                type={'text'}
                inputMode={'numeric'}
                autoComplete={'one-time-code'}
                pattern={'\\d{6}'}
            />
            <label htmlFor={'totp-password'} className={'block mt-3'}>
                Account Password
            </label>
            <Input.Text
                variant={Input.Text.Variants.Loose}
                className={'mt-1'}
                type={'password'}
                value={password}
                onChange={(e) => setPassword(e.currentTarget.value)}
            />
            <Dialog.Footer>
                <Button.Text onClick={close}>Cancel</Button.Text>
                <Tooltip
                    disabled={password.length > 0 && value.length === 6}
                    content={
                        !token
                            ? 'Waiting for QR code to load...'
                            : 'You must enter the 6-digit code and your password to continue.'
                    }
                    delay={100}
                >
                    <Button
                        disabled={!token || value.length !== 6 || !password.length}
                        type={'submit'}
                        form={'enable-totp-form'}
                    >
                        Enable
                    </Button>
                </Tooltip>
            </Dialog.Footer>
        </form>
    );
};

export default asDialog({
    title: 'Enable Two-Step Verification',
    description:
        "Help protect your account from unauthorized access. You'll be prompted for a verification code each time you sign in.",
})(ConfigureTwoFactorForm);
</file>

<file path="resources/scripts/components/dashboard/forms/UpdateEmailAddressForm.tsx">
import React from 'react';
import * as Yup from 'yup';
import tw from 'twin.macro';
import { ApplicationStore } from '@/state';
import { httpErrorToHuman } from '@/api/http';
import Field from '@/components/elements/Field';
import { Form, Formik, FormikHelpers } from 'formik';
import { Button } from '@/components/elements/button/index';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import { Actions, State, useStoreActions, useStoreState } from 'easy-peasy';

interface Values {
    email: string;
    password: string;
}

const schema = Yup.object().shape({
    email: Yup.string().email().required(),
    password: Yup.string().required('You must provide your current account password.'),
});

export default () => {
    const user = useStoreState((state: State<ApplicationStore>) => state.user.data);
    const updateEmail = useStoreActions((state: Actions<ApplicationStore>) => state.user.updateUserEmail);

    const { clearFlashes, addFlash } = useStoreActions((actions: Actions<ApplicationStore>) => actions.flashes);

    const submit = (values: Values, { resetForm, setSubmitting }: FormikHelpers<Values>) => {
        clearFlashes('account:email');

        updateEmail({ ...values })
            .then(() =>
                addFlash({
                    type: 'success',
                    key: 'account:email',
                    message: 'Your primary email has been updated.',
                })
            )
            .catch((error) =>
                addFlash({
                    type: 'danger',
                    key: 'account:email',
                    title: 'Error',
                    message: httpErrorToHuman(error),
                })
            )
            .then(() => {
                resetForm();
                setSubmitting(false);
            });
    };

    return (
        <Formik onSubmit={submit} validationSchema={schema} initialValues={{ email: user!.email, password: '' }}>
            {({ isSubmitting, isValid }) => (
                <React.Fragment>
                    <SpinnerOverlay size={'large'} visible={isSubmitting} />
                    <Form css={tw`m-0`}>
                        <Field id={'current_email'} type={'email'} name={'email'} label={'Email'} />
                        <div css={tw`mt-6`}>
                            <Field
                                id={'confirm_password'}
                                type={'password'}
                                name={'password'}
                                label={'Confirm Password'}
                            />
                        </div>
                        <div css={tw`mt-6`}>
                            <Button disabled={isSubmitting || !isValid}>Update Email</Button>
                        </div>
                    </Form>
                </React.Fragment>
            )}
        </Formik>
    );
};
</file>

<file path="resources/scripts/components/dashboard/forms/UpdatePasswordForm.tsx">
import React from 'react';
import * as Yup from 'yup';
import tw from 'twin.macro';
import { ApplicationStore } from '@/state';
import { httpErrorToHuman } from '@/api/http';
import Field from '@/components/elements/Field';
import { Form, Formik, FormikHelpers } from 'formik';
import { Button } from '@/components/elements/button/index';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import updateAccountPassword from '@/api/account/updateAccountPassword';
import { Actions, State, useStoreActions, useStoreState } from 'easy-peasy';

interface Values {
    current: string;
    password: string;
    confirmPassword: string;
}

const schema = Yup.object().shape({
    current: Yup.string().min(1).required('You must provide your current password.'),
    password: Yup.string().min(8).required(),
    confirmPassword: Yup.string().test(
        'password',
        'Password confirmation does not match the password you entered.',
        function (value) {
            return value === this.parent.password;
        }
    ),
});

export default () => {
    const user = useStoreState((state: State<ApplicationStore>) => state.user.data);
    const { clearFlashes, addFlash } = useStoreActions((actions: Actions<ApplicationStore>) => actions.flashes);

    if (!user) {
        return null;
    }

    const submit = (values: Values, { setSubmitting }: FormikHelpers<Values>) => {
        clearFlashes('account:password');
        updateAccountPassword({ ...values })
            .then(() => {
                // @ts-expect-error this is valid
                window.location = '/auth/login';
            })
            .catch((error) =>
                addFlash({
                    key: 'account:password',
                    type: 'danger',
                    title: 'Error',
                    message: httpErrorToHuman(error),
                })
            )
            .then(() => setSubmitting(false));
    };

    return (
        <React.Fragment>
            <Formik
                onSubmit={submit}
                validationSchema={schema}
                initialValues={{ current: '', password: '', confirmPassword: '' }}
            >
                {({ isSubmitting, isValid }) => (
                    <React.Fragment>
                        <SpinnerOverlay size={'large'} visible={isSubmitting} />
                        <Form css={tw`m-0`}>
                            <Field
                                id={'current_password'}
                                type={'password'}
                                name={'current'}
                                label={'Current Password'}
                            />
                            <div css={tw`mt-6`}>
                                <Field
                                    id={'new_password'}
                                    type={'password'}
                                    name={'password'}
                                    label={'New Password'}
                                    description={
                                        'Your new password should be at least 8 characters in length and unique to this website.'
                                    }
                                />
                            </div>
                            <div css={tw`mt-6`}>
                                <Field
                                    id={'confirm_new_password'}
                                    type={'password'}
                                    name={'confirmPassword'}
                                    label={'Confirm New Password'}
                                />
                            </div>
                            <div css={tw`mt-6`}>
                                <Button disabled={isSubmitting || !isValid}>Update Password</Button>
                            </div>
                        </Form>
                    </React.Fragment>
                )}
            </Formik>
        </React.Fragment>
    );
};
</file>

<file path="resources/scripts/components/dashboard/forms/UpdateUsernameForm.tsx">
import React from 'react';
import * as Yup from 'yup';
import tw from 'twin.macro';
import { ApplicationStore } from '@/state';
import { httpErrorToHuman } from '@/api/http';
import Field from '@/components/elements/Field';
import { Form, Formik, FormikHelpers } from 'formik';
import { Actions, useStoreActions } from 'easy-peasy';
import { Button } from '@/components/elements/button/index';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import updateAccountUsername from '@/api/account/updateAccountUsername';

interface Values {
    username: string;
    password: string;
}

const schema = Yup.object().shape({
    username: Yup.string().min(3).required(),
    password: Yup.string().required('You must provide your current account password.'),
});

export default () => {
    const { clearFlashes, addFlash } = useStoreActions((actions: Actions<ApplicationStore>) => actions.flashes);

    const submit = (values: Values, { resetForm, setSubmitting }: FormikHelpers<Values>) => {
        clearFlashes('account:email');

        updateAccountUsername({ ...values })
            .then(() =>
                addFlash({
                    type: 'success',
                    key: 'account:username',
                    message: 'Your username has been changed.',
                })
            )
            .catch((error) =>
                addFlash({
                    type: 'danger',
                    key: 'account:username',
                    title: 'Error',
                    message: httpErrorToHuman(error),
                })
            )
            .then(() => {
                resetForm();
                setSubmitting(false);
            });
    };

    return (
        <Formik onSubmit={submit} initialValues={{ username: '', password: '' }} validationSchema={schema}>
            {({ isSubmitting, isValid }) => (
                <React.Fragment>
                    <SpinnerOverlay size={'large'} visible={isSubmitting} />
                    <Form css={tw`m-0`}>
                        <Field id={'new_username'} type={'username'} name={'username'} label={'New Username'} />
                        <div css={tw`mt-6`}>
                            <Field
                                id={'confirm_password'}
                                type={'password'}
                                name={'password'}
                                label={'Confirm Password'}
                            />
                        </div>
                        <div css={tw`mt-6`}>
                            <Button disabled={isSubmitting || !isValid}>Update Username</Button>
                        </div>
                    </Form>
                </React.Fragment>
            )}
        </Formik>
    );
};
</file>

<file path="resources/scripts/components/dashboard/search/SearchContainer.tsx">
import * as Icon from 'react-feather';
import React, { useState } from 'react';
import useEventListener from '@/plugins/useEventListener';
import SearchModal from '@/components/dashboard/search/SearchModal';
import Tooltip from '@/components/elements/tooltip/Tooltip';

interface Props {
    size: number;
}

export default ({ size }: Props) => {
    const [visible, setVisible] = useState(false);

    useEventListener('keydown', (e: KeyboardEvent) => {
        if (['input', 'textarea'].indexOf(((e.target as HTMLElement).tagName || 'input').toLowerCase()) < 0) {
            if (!visible && e.metaKey && e.key.toLowerCase() === '/') {
                setVisible(true);
            }
        }
    });

    return (
        <>
            {visible && <SearchModal appear visible={visible} onDismissed={() => setVisible(false)} />}
            <Tooltip placement={'bottom'} content={'Search'}>
                <div className={'navigation-link'} onClick={() => setVisible(true)}>
                    <Icon.Search size={size} />
                </div>
            </Tooltip>
        </>
    );
};
</file>

<file path="resources/scripts/components/dashboard/search/SearchModal.tsx">
import tw from 'twin.macro';
import debounce from 'debounce';
import { object, string } from 'yup';
import { ip } from '@/lib/formatters';
import { Link } from 'react-router-dom';
import getServers from '@/api/getServers';
import { ApplicationStore } from '@/state';
import styled from 'styled-components/macro';
import Input from '@/components/elements/Input';
import { Server } from '@/api/server/getServer';
import React, { useEffect, useRef, useState } from 'react';
import InputSpinner from '@/components/elements/InputSpinner';
import { Actions, useStoreActions, useStoreState } from 'easy-peasy';
import Modal, { RequiredModalProps } from '@/components/elements/Modal';
import FormikFieldWrapper from '@/components/elements/FormikFieldWrapper';
import { Field, Form, Formik, FormikHelpers, useFormikContext } from 'formik';

type Props = RequiredModalProps;

interface Values {
    term: string;
}

const ServerResult = styled(Link)`
    ${tw`flex items-center bg-neutral-900 p-4 rounded border-l-4 border-neutral-900 no-underline transition-all duration-150`};

    &:hover {
        ${tw`shadow border-cyan-500`};
    }

    &:not(:last-of-type) {
        ${tw`mb-2`};
    }
`;

const SearchWatcher = () => {
    const { values, submitForm } = useFormikContext<Values>();

    useEffect(() => {
        if (values.term.length >= 3) {
            submitForm();
        }
    }, [values.term]);

    return null;
};

export default ({ ...props }: Props) => {
    const ref = useRef<HTMLInputElement>(null);
    const isAdmin = useStoreState((state) => state.user.data!.rootAdmin);
    const [servers, setServers] = useState<Server[]>([]);
    const { clearAndAddHttpError, clearFlashes } = useStoreActions(
        (actions: Actions<ApplicationStore>) => actions.flashes
    );

    const search = debounce(({ term }: Values, { setSubmitting }: FormikHelpers<Values>) => {
        clearFlashes('search');

        // if (ref.current) ref.current.focus();
        getServers({ query: term, type: isAdmin ? 'admin-all' : undefined })
            .then((servers) => setServers(servers.items.filter((_, index) => index < 5)))
            .catch((error) => {
                console.error(error);
                clearAndAddHttpError({ key: 'search', error });
            })
            .then(() => setSubmitting(false))
            .then(() => ref.current?.focus());
    }, 500);

    useEffect(() => {
        if (props.visible) {
            if (ref.current) ref.current.focus();
        }
    }, [props.visible]);

    // Formik does not support an innerRef on custom components.
    const InputWithRef = (props: any) => <Input autoFocus {...props} ref={ref} />;

    return (
        <Formik
            onSubmit={search}
            validationSchema={object().shape({
                term: string().min(3, 'Please enter at least three characters to begin searching.'),
            })}
            initialValues={{ term: '' } as Values}
        >
            {({ isSubmitting }) => (
                <Modal {...props}>
                    <Form>
                        <FormikFieldWrapper
                            name={'term'}
                            label={'Search term'}
                            description={'Enter a server name, uuid, or allocation to begin searching.'}
                        >
                            <SearchWatcher />
                            <InputSpinner visible={isSubmitting}>
                                <Field as={InputWithRef} name={'term'} />
                            </InputSpinner>
                        </FormikFieldWrapper>
                    </Form>
                    {servers.length > 0 && (
                        <div css={tw`mt-6`}>
                            {servers.map((server) => (
                                <ServerResult
                                    key={server.uuid}
                                    to={`/server/${server.id}`}
                                    onClick={() => props.onDismissed()}
                                >
                                    <div css={tw`flex-1 mr-4`}>
                                        <p css={tw`text-sm`}>{server.name}</p>
                                        <p css={tw`mt-1 text-xs text-neutral-400`}>
                                            {server.allocations
                                                .filter((alloc) => alloc.isDefault)
                                                .map((allocation) => (
                                                    <span key={allocation.ip + allocation.port.toString()}>
                                                        {allocation.alias || ip(allocation.ip)}:{allocation.port}
                                                    </span>
                                                ))}
                                        </p>
                                    </div>
                                    <div css={tw`flex-none text-right`}>
                                        <span css={tw`text-xs py-1 px-2 bg-cyan-800 text-cyan-100 rounded`}>
                                            {server.node}
                                        </span>
                                    </div>
                                </ServerResult>
                            ))}
                        </div>
                    )}
                </Modal>
            )}
        </Formik>
    );
};
</file>

<file path="resources/scripts/components/dashboard/ssh/AccountSSHContainer.tsx">
import tw from 'twin.macro';
import { format } from 'date-fns';
import * as Icon from 'react-feather';
import React, { useEffect } from 'react';
import { useFlashKey } from '@/plugins/useFlash';
import { useSSHKeys } from '@/api/account/ssh-keys';
import ContentBox from '@/components/elements/ContentBox';
import GreyRowBox from '@/components/elements/GreyRowBox';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import PageContentBlock from '@/components/elements/PageContentBlock';
import CreateSSHKeyForm from '@/components/dashboard/forms/CreateSSHKeyForm';
import DeleteSSHKeyButton from '@/components/dashboard/ssh/DeleteSSHKeyButton';

export default () => {
    const { clearAndAddHttpError } = useFlashKey('account');

    const { data, isValidating, error } = useSSHKeys({
        revalidateOnMount: true,
        revalidateOnFocus: false,
    });

    useEffect(() => {
        clearAndAddHttpError(error);
    }, [error]);

    return (
        <PageContentBlock
            title={'Account SSH'}
            description={'Create SSH keys to connect to your servers.'}
            showFlashKey={'account'}
        >
            <div className={'md:flex flex-nowrap my-10'}>
                <ContentBox title={'Add SSH Key'} css={tw`flex-none w-full md:w-1/2`}>
                    <CreateSSHKeyForm />
                </ContentBox>
                <ContentBox title={'SSH Keys'} css={tw`flex-1 overflow-hidden mt-8 md:mt-0 md:ml-8`}>
                    <SpinnerOverlay visible={!data && isValidating} />
                    {!data || !data.length ? (
                        <p css={tw`text-center text-sm`}>
                            {!data ? 'Loading...' : 'No SSH Keys exist for this account.'}
                        </p>
                    ) : (
                        data.map((key, index) => (
                            <GreyRowBox
                                key={key.fingerprint}
                                css={[tw`bg-neutral-600 flex space-x-4 items-center`, index > 0 && tw`mt-2`]}
                            >
                                <Icon.Key css={tw`text-neutral-300`} />
                                <div css={tw`flex-1`}>
                                    <p css={tw`text-sm break-words font-medium`}>{key.name}</p>
                                    <p css={tw`text-xs mt-1 font-mono truncate`}>SHA256:{key.fingerprint}</p>
                                    <p css={tw`text-xs mt-1 text-neutral-300 uppercase`}>
                                        Added on:&nbsp;
                                        {format(key.createdAt, 'MMM do, yyyy HH:mm')}
                                    </p>
                                </div>
                                <DeleteSSHKeyButton name={key.name} fingerprint={key.fingerprint} />
                            </GreyRowBox>
                        ))
                    )}
                </ContentBox>
            </div>
        </PageContentBlock>
    );
};
</file>

<file path="resources/scripts/components/dashboard/ssh/CreateSSHKeyForm.tsx">
import React from 'react';
import { Field, Form, Formik, FormikHelpers } from 'formik';
import { object, string } from 'yup';
import FormikFieldWrapper from '@/components/elements/FormikFieldWrapper';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import tw from 'twin.macro';
import Button from '@/components/elements/Button';
import Input, { Textarea } from '@/components/elements/Input';
import styled from 'styled-components/macro';
import { useFlashKey } from '@/plugins/useFlash';
import { createSSHKey, useSSHKeys } from '@/api/account/ssh-keys';

interface Values {
    name: string;
    publicKey: string;
}

const CustomTextarea = styled(Textarea)`
    ${tw`h-32`}
`;

export default () => {
    const { clearAndAddHttpError } = useFlashKey('account');
    const { mutate } = useSSHKeys();

    const submit = (values: Values, { setSubmitting, resetForm }: FormikHelpers<Values>) => {
        clearAndAddHttpError();

        createSSHKey(values.name, values.publicKey)
            .then((key) => {
                resetForm();
                mutate((data) => (data || []).concat(key));
            })
            .catch((error) => clearAndAddHttpError(error))
            .then(() => setSubmitting(false));
    };

    return (
        <>
            <Formik
                onSubmit={submit}
                initialValues={{ name: '', publicKey: '' }}
                validationSchema={object().shape({
                    name: string().required(),
                    publicKey: string().required(),
                })}
            >
                {({ isSubmitting }) => (
                    <Form>
                        <SpinnerOverlay visible={isSubmitting} />
                        <FormikFieldWrapper label={'SSH Key Name'} name={'name'} css={tw`mb-6`}>
                            <Field name={'name'} as={Input} />
                        </FormikFieldWrapper>
                        <FormikFieldWrapper
                            label={'Public Key'}
                            name={'publicKey'}
                            description={'Enter your public SSH key.'}
                        >
                            <Field name={'publicKey'} as={CustomTextarea} />
                        </FormikFieldWrapper>
                        <div css={tw`flex justify-end mt-6`}>
                            <Button>Save</Button>
                        </div>
                    </Form>
                )}
            </Formik>
        </>
    );
};
</file>

<file path="resources/scripts/components/dashboard/ssh/DeleteSSHKeyButton.tsx">
import tw from 'twin.macro';
import * as Icon from 'react-feather';
import React, { useState } from 'react';
import Code from '@/components/elements/Code';
import { useFlashKey } from '@/plugins/useFlash';
import { Dialog } from '@/components/elements/dialog';
import { deleteSSHKey, useSSHKeys } from '@/api/account/ssh-keys';

export default ({ name, fingerprint }: { name: string; fingerprint: string }) => {
    const { clearAndAddHttpError } = useFlashKey('account');
    const [visible, setVisible] = useState(false);
    const { mutate } = useSSHKeys();

    const onClick = () => {
        clearAndAddHttpError();

        Promise.all([
            mutate((data) => data?.filter((value) => value.fingerprint !== fingerprint), false),
            deleteSSHKey(fingerprint),
        ]).catch((error) => {
            mutate(undefined, true).catch(console.error);
            clearAndAddHttpError(error);
        });
    };

    return (
        <>
            <Dialog.Confirm
                open={visible}
                title={'Delete SSH Key'}
                confirm={'Delete Key'}
                onConfirmed={onClick}
                onClose={() => setVisible(false)}
            >
                Removing the <Code>{name}</Code> SSH key will invalidate its usage across the Panel.
            </Dialog.Confirm>
            <button css={tw`ml-4 p-2 text-sm`} onClick={() => setVisible(true)}>
                <Icon.Trash css={tw`text-neutral-400 hover:text-red-400 transition-colors duration-150`} />
            </button>
        </>
    );
};
</file>

<file path="resources/scripts/components/dashboard/AccountApiContainer.tsx">
import tw from 'twin.macro';
import { format } from 'date-fns';
import * as Icon from 'react-feather';
import Code from '@/components/elements/Code';
import { useFlashKey } from '@/plugins/useFlash';
import React, { useEffect, useState } from 'react';
import deleteApiKey from '@/api/account/deleteApiKey';
import { Dialog } from '@/components/elements/dialog';
import ContentBox from '@/components/elements/ContentBox';
import GreyRowBox from '@/components/elements/GreyRowBox';
import getApiKeys, { ApiKey } from '@/api/account/getApiKeys';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import PageContentBlock from '@/components/elements/PageContentBlock';
import CreateApiKeyForm from '@/components/dashboard/forms/CreateApiKeyForm';

export default () => {
    const [loading, setLoading] = useState(true);
    const [keys, setKeys] = useState<ApiKey[]>([]);
    const [deleteIdentifier, setDeleteIdentifier] = useState('');
    const { clearAndAddHttpError } = useFlashKey('account');

    useEffect(() => {
        getApiKeys()
            .then((keys) => setKeys(keys))
            .then(() => setLoading(false))
            .catch((error) => clearAndAddHttpError(error));
    }, []);

    const doDeletion = (identifier: string) => {
        setLoading(true);

        clearAndAddHttpError();
        deleteApiKey(identifier)
            .then(() => setKeys((s) => [...(s || []).filter((key) => key.identifier !== identifier)]))
            .catch((error) => clearAndAddHttpError(error))
            .then(() => {
                setLoading(false);
                setDeleteIdentifier('');
            });
    };

    return (
        <PageContentBlock
            title={'Account API'}
            description={'Create API keys to interact with the Panel.'}
            showFlashKey={'account'}
        >
            <div className={'md:flex flex-nowrap my-10'}>
                <ContentBox title={'Create API Key'} css={tw`flex-none w-full md:w-1/2`}>
                    <CreateApiKeyForm onKeyCreated={(key) => setKeys((s) => [...s!, key])} />
                </ContentBox>
                <ContentBox title={'API Keys'} css={tw`flex-1 overflow-hidden mt-8 md:mt-0 md:ml-8`}>
                    <SpinnerOverlay visible={loading} />
                    <Dialog.Confirm
                        title={'Delete API Key'}
                        confirm={'Delete Key'}
                        open={!!deleteIdentifier}
                        onClose={() => setDeleteIdentifier('')}
                        onConfirmed={() => doDeletion(deleteIdentifier)}
                    >
                        All requests using the <Code>{deleteIdentifier}</Code> key will be invalidated.
                    </Dialog.Confirm>
                    {keys.length === 0 ? (
                        <p css={tw`text-center text-sm`}>
                            {loading ? 'Loading...' : 'No API keys exist for this account.'}
                        </p>
                    ) : (
                        keys.map((key, index) => (
                            <GreyRowBox
                                key={key.identifier}
                                css={[tw`bg-neutral-700 flex items-center`, index > 0 && tw`mt-2`]}
                            >
                                <Icon.Key css={tw`text-neutral-300`} />
                                <div css={tw`ml-4 flex-1 overflow-hidden`}>
                                    <p css={tw`text-sm break-words`}>{key.description}</p>
                                    <p css={tw`text-2xs text-neutral-300 uppercase`}>
                                        Last used:&nbsp;
                                        {key.lastUsedAt ? format(key.lastUsedAt, 'MMM do, yyyy HH:mm') : 'Never'}
                                    </p>
                                </div>
                                <p css={tw`text-sm ml-4 hidden md:block`}>
                                    <code css={tw`font-mono py-1 px-2 bg-neutral-900 rounded`}>{key.identifier}</code>
                                </p>
                                <button css={tw`ml-4 p-2 text-sm`} onClick={() => setDeleteIdentifier(key.identifier)}>
                                    <Icon.Trash
                                        css={tw`text-neutral-400 hover:text-red-400 transition-colors duration-150`}
                                    />
                                </button>
                            </GreyRowBox>
                        ))
                    )}
                </ContentBox>
            </div>
        </PageContentBlock>
    );
};
</file>

<file path="resources/scripts/components/dashboard/AccountOverviewContainer.tsx">
import tw from 'twin.macro';
import * as React from 'react';
import { breakpoint } from '@/theme';
import styled from 'styled-components/macro';
import { useStoreState } from '@/state/hooks';
import { useLocation } from 'react-router-dom';
import Alert from '@/components/elements/alert/Alert';
import ContentBox from '@/components/elements/ContentBox';
import PageContentBlock from '@/components/elements/PageContentBlock';
import DiscordAccountForm from '@/components/dashboard/forms/DiscordAccountForm';
import UpdateUsernameForm from '@/components/dashboard/forms/UpdateUsernameForm';
import AddReferralCodeForm from '@/components/dashboard/forms/AddReferralCodeForm';
import UpdateEmailAddressForm from '@/components/dashboard/forms/UpdateEmailAddressForm';

const Container = styled.div`
    ${tw`flex flex-wrap`};

    & > div {
        ${tw`w-full`};

        ${breakpoint('sm')`
        width: calc(50% - 1rem);
      `}

        ${breakpoint('md')`
        ${tw`w-auto flex-1`};
      `}
    }
`;

export default () => {
    const { state } = useLocation<undefined | { twoFactorRedirect?: boolean }>();
    const discord = useStoreState((state) => state.settings.data!.registration.discord);
    const referrals = useStoreState((state) => state.storefront.data!.referrals.enabled);

    return (
        <PageContentBlock title={'Account Overview'} description={'View and update account details.'}>
            {state?.twoFactorRedirect && (
                <Alert type={'danger'}>
                    Your account must have two-factor authentication enabled in order to continue.
                </Alert>
            )}
            <Container
                className={'j-up'}
                css={[tw`lg:grid lg:grid-cols-2 gap-8 mb-10`, state?.twoFactorRedirect ? tw`mt-4` : tw`mt-10`]}
            >
                <ContentBox title={'Update Username'} showFlashes={'account:username'}>
                    <UpdateUsernameForm />
                </ContentBox>
                <ContentBox title={'Update Email Address'} showFlashes={'account:email'}>
                    <UpdateEmailAddressForm />
                </ContentBox>
                {referrals && (
                    <ContentBox title={'Referral Codes'} showFlashes={'account:referral'}>
                        <AddReferralCodeForm />
                    </ContentBox>
                )}
                {discord && (
                    <ContentBox title={'Connect with Discord'} showFlashes={'account:discord'}>
                        <DiscordAccountForm />
                    </ContentBox>
                )}
            </Container>
        </PageContentBlock>
    );
};
</file>

<file path="resources/scripts/components/dashboard/AccountSecurityContainer.tsx">
import tw from 'twin.macro';
import * as React from 'react';
import { breakpoint } from '@/theme';
import styled from 'styled-components/macro';
import ContentBox from '@/components/elements/ContentBox';
import ActivityLogContainer from './activity/ActivityLogContainer';
import PageContentBlock from '@/components/elements/PageContentBlock';
import UpdatePasswordForm from '@/components/dashboard/forms/UpdatePasswordForm';
import ConfigureTwoFactorForm from '@/components/dashboard/forms/ConfigureTwoFactorForm';

const Container = styled.div`
    ${tw`flex flex-wrap`};

    & > div {
        ${tw`w-full`};

        ${breakpoint('sm')`
        width: calc(50% - 1rem);
      `}

        ${breakpoint('md')`
        ${tw`w-auto flex-1`};
      `}
    }
`;

export default () => (
    <PageContentBlock title={'Account Security'} description={'Manage account logs and authentication.'}>
        <Container css={tw`lg:grid lg:grid-cols-3 my-10`}>
            <div css={tw`flex-none w-full col-span-1`}>
                <ContentBox className={'j-right'} title={'Update Password'} showFlashes={'account:password'}>
                    <UpdatePasswordForm />
                </ContentBox>
                <ContentBox className={'j-right'} title={'Setup 2FA'} css={tw`mt-8`} showFlashes={'account:2fa'}>
                    <ConfigureTwoFactorForm />
                </ContentBox>
            </div>
            <ContentBox
                className={'j-left'}
                title={'Account Logs'}
                css={tw`md:ml-8 mt-8 md:mt-0 col-span-2`}
                showFlashes={'account:logs'}
            >
                <ActivityLogContainer />
            </ContentBox>
        </Container>
    </PageContentBlock>
);
</file>

<file path="resources/scripts/components/dashboard/ApiKeyModal.tsx">
import tw from 'twin.macro';
import asModal from '@/hoc/asModal';
import React, { useContext } from 'react';
import ModalContext from '@/context/ModalContext';
import { Button } from '@/components/elements/button/index';
import CopyOnClick from '@/components/elements/CopyOnClick';

interface Props {
    apiKey: string;
}

const ApiKeyModal = ({ apiKey }: Props) => {
    const { dismiss } = useContext(ModalContext);

    return (
        <>
            <h3 css={tw`mb-6 text-2xl`}>Your API Key</h3>
            <p css={tw`text-sm mb-6`}>
                The API key you have requested is shown below. Please store this in a safe location, it will not be
                shown again.
            </p>
            <pre css={tw`text-sm bg-neutral-900 rounded py-2 px-4 font-mono`}>
                <CopyOnClick text={apiKey}>
                    <code css={tw`font-mono`}>{apiKey}</code>
                </CopyOnClick>
            </pre>
            <div css={tw`flex justify-end mt-6`}>
                <Button type={'button'} onClick={() => dismiss()}>
                    Close
                </Button>
            </div>
        </>
    );
};

ApiKeyModal.displayName = 'ApiKeyModal';

export default asModal<Props>({
    closeOnEscape: false,
    closeOnBackground: false,
})(ApiKeyModal);
</file>

<file path="resources/scripts/components/dashboard/CouponContainer.tsx">
import PageContentBlock from '@/components/elements/PageContentBlock';
import React, { Fragment } from 'react';
import FlashMessageRender from '@/components/FlashMessageRender';
import ContentBox from '@/components/elements/ContentBox';
import { Form, Formik, FormikHelpers } from 'formik';
import { object, string } from 'yup';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import Field from '@/components/elements/Field';
import { Button } from '@/components/elements/button';
import redeemCoupon from '@/api/account/redeemCoupon';
import { Actions, useStoreActions } from 'easy-peasy';
import { ApplicationStore } from '@/state';
import { httpErrorToHuman } from '@/api/http';

const schema = object().shape({
    code: string().required('You must specify the code you wish to redeem.'),
});

export default () => {
    const { clearFlashes, addFlash } = useStoreActions((actions: Actions<ApplicationStore>) => actions.flashes);

    const submit = (values: { code: string }, { resetForm, setSubmitting }: FormikHelpers<{ code: string }>) => {
        clearFlashes();
        redeemCoupon(values.code)
            .then(() => {
                addFlash({ type: 'success', key: 'coupons', message: 'Successfully redeemed the coupon.' });
            })
            .catch((err) => {
                addFlash({ type: 'danger', key: 'coupons', message: httpErrorToHuman(err) });
            })
            .then(() => {
                resetForm();
                setSubmitting(false);
            });
    };

    return (
        <PageContentBlock title={'Coupons'}>
            <h1 className={'text-5xl'}>Coupons</h1>
            <h3 className={'text-2xl mt-2 text-neutral-500'}>Redeem coupons given to you.</h3>
            <FlashMessageRender byKey={'coupons'} className={'mt-2'} />
            <ContentBox title={'Redeem'} className={'w-1/4 mt-6'}>
                <Formik initialValues={{ code: '' }} onSubmit={submit} validationSchema={schema}>
                    {({ isSubmitting, isValid }) => (
                        <Fragment>
                            <SpinnerOverlay size={'large'} visible={isSubmitting} />
                            <Form>
                                <Field id={'code'} type={'text'} name={'code'} label={'Enter Code'} />
                                <div className={'mt-6'}>
                                    <Button disabled={isSubmitting || !isValid}>Redeem</Button>
                                </div>
                            </Form>
                        </Fragment>
                    )}
                </Formik>
            </ContentBox>
        </PageContentBlock>
    );
};
</file>

<file path="resources/scripts/components/dashboard/ReferralContainer.tsx">
import tw from 'twin.macro';
import { format } from 'date-fns';
import { breakpoint } from '@/theme';
import * as Icon from 'react-feather';
import styled from 'styled-components/macro';
import { useStoreState } from '@/state/hooks';
import React, { useState, useEffect } from 'react';
import { Button } from '@/components/elements/button';
import { Dialog } from '@/components/elements/dialog';
import GreyRowBox from '@/components/elements/GreyRowBox';
import ContentBox from '@/components/elements/ContentBox';
import useFlash, { useFlashKey } from '@/plugins/useFlash';
import deleteReferralCode from '@/api/account/deleteReferralCode';
import createReferralCode from '@/api/account/createReferralCode';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import PageContentBlock from '@/components/elements/PageContentBlock';
import getReferralCodes, { ReferralCode } from '@/api/account/getReferralCodes';
import getReferralActivity, { ReferralActivity } from '@/api/account/getReferralActivity';

const Container = styled.div`
    ${tw`flex flex-wrap`};

    & > div {
        ${tw`w-full`};

        ${breakpoint('sm')`
      width: calc(50% - 1rem);
    `}

        ${breakpoint('md')`
      ${tw`w-auto flex-1`};
    `}
    }
`;

export default () => {
    const { addFlash } = useFlash();
    const [code, setCode] = useState('');
    const [loading, setLoading] = useState(false);
    const [codes, setCodes] = useState<ReferralCode[]>([]);
    const [activity, setActivity] = useState<ReferralActivity[]>([]);
    const { clearFlashes, clearAndAddHttpError } = useFlashKey('referrals');
    const reward = useStoreState((state) => state.storefront.data?.referrals.reward);

    useEffect(() => {
        clearFlashes();
        setLoading(true);

        getReferralCodes()
            .then((codes) => {
                setCodes(codes);
                setLoading(false);
            })
            .catch((error) => clearAndAddHttpError(error));

        getReferralActivity()
            .then((activity) => {
                setActivity(activity);
                setLoading(false);
            })
            .catch((error) => clearAndAddHttpError(error));
    }, []);

    const doCreation = () => {
        clearFlashes();
        setLoading(true);

        createReferralCode()
            .then(() => {
                getReferralCodes().then((codes) => setCodes(codes));
                addFlash({
                    type: 'success',
                    key: 'referrals',
                    message: 'Referral code has been created.',
                });
            })
            .catch((error) => clearAndAddHttpError(error))
            .then(() => {
                setLoading(false);
            });
    };

    const doDeletion = (code: string) => {
        clearFlashes();
        setLoading(true);

        deleteReferralCode(code)
            .then(() => {
                getReferralCodes().then((codes) => setCodes(codes));
                addFlash({
                    type: 'success',
                    key: 'referrals',
                    message: 'Referral code has been deleted.',
                });
            })
            .catch((error) => clearAndAddHttpError(error))
            .then(() => {
                setLoading(false);
                setCode('');
            });
    };

    return (
        <PageContentBlock
            title={'Referrals'}
            description={'Create a code and share it with others.'}
            showFlashKey={'referrals'}
        >
            <Container className={'lg:grid lg:grid-cols-3 my-10'}>
                <ContentBox title={'Your Referral Codes'} css={tw`sm:mt-0`}>
                    <Dialog.Confirm
                        title={'Delete Referral Code'}
                        confirm={'Delete Code'}
                        open={!!code}
                        onClose={() => setCode('')}
                        onConfirmed={() => doDeletion(code)}
                    >
                        Users will no longer be able to use this key for signup.
                    </Dialog.Confirm>
                    <SpinnerOverlay visible={loading} />
                    {codes.length === 0 ? (
                        <p css={tw`text-center my-2`}>{!loading && 'No referral codes exist for this account.'}</p>
                    ) : (
                        codes.map((code, index) => (
                            <GreyRowBox
                                key={code.code}
                                css={[tw`bg-neutral-900 flex items-center`, index > 0 && tw`mt-2`]}
                            >
                                <Icon.GitBranch css={tw`text-neutral-300`} />
                                <div css={tw`ml-4 flex-1 overflow-hidden`}>
                                    <p css={tw`text-sm break-words`}>{code.code}</p>
                                    <p css={tw`text-2xs text-neutral-300 uppercase`}>
                                        Created at:&nbsp;
                                        {code.createdAt ? format(code.createdAt, 'MMM do, yyyy HH:mm') : 'Never'}
                                    </p>
                                </div>
                                <button css={tw`ml-4 p-2 text-sm`} onClick={() => setCode(code.code)}>
                                    <Icon.Trash
                                        css={tw`text-neutral-400 hover:text-red-400 transition-colors duration-150`}
                                    />
                                </button>
                            </GreyRowBox>
                        ))
                    )}
                    <Button onClick={() => doCreation()} className={'mt-4'}>
                        Create
                    </Button>
                </ContentBox>
                <ContentBox title={'Available Perks'} css={tw`mt-8 sm:mt-0 sm:ml-8`}>
                    <h1 css={tw`text-xl`}>
                        You will recieve <span className={'text-green-500'}>{reward}</span> credits for every user you
                        refer to this Panel.
                    </h1>
                </ContentBox>
                <ContentBox title={'Users Referred'} css={tw`mt-8 sm:mt-0 sm:ml-8`}>
                    <SpinnerOverlay visible={loading} />
                    {activity.length === 0 ? (
                        <p css={tw`text-center my-2`}>{!loading && 'No referral activity exists for this account.'}</p>
                    ) : (
                        activity.map((act, index) => (
                            <GreyRowBox
                                key={act.code}
                                css={[tw`bg-neutral-900 flex items-center`, index > 0 && tw`mt-2`]}
                            >
                                <Icon.GitBranch css={tw`text-neutral-300`} />
                                <div css={tw`ml-4 flex-1 overflow-hidden`}>
                                    <p css={tw`text-sm break-words`}>
                                        {act.userEmail} (ID: {act.userId})
                                    </p>
                                    <p css={tw`text-2xs text-neutral-300 uppercase`}>
                                        Used at:&nbsp;
                                        {act.createdAt ? format(act.createdAt, 'MMM do, yyyy HH:mm') : 'Never'}
                                    </p>
                                    <p css={tw`text-2xs text-neutral-300 uppercase`}>Code used:&nbsp;{act.code}</p>
                                </div>
                            </GreyRowBox>
                        ))
                    )}
                </ContentBox>
            </Container>
        </PageContentBlock>
    );
};
</file>

<file path="resources/scripts/components/dashboard/ServerRow.tsx">
// // import tw from 'twin.macro';
// // import * as Icon from 'react-feather';
// // import { Link } from 'react-router-dom';
// // import styled from 'styled-components/macro';
// // import { Server } from '@/api/server/getServer';
// // import Spinner from '@/components/elements/Spinner';
// // import { bytesToString, ip } from '@/lib/formatters';
// // import GreyRowBox from '@/components/elements/GreyRowBox';
// // import React, { useEffect, useRef, useState } from 'react';
// // import getServerResourceUsage, { ServerPowerState, ServerStats } from '@/api/server/getServerResourceUsage';

// // // Determines if the current value is in an alarm threshold so we can show it in red rather
// // // than the more faded default style.
// // const isAlarmState = (current: number, limit: number): boolean => limit > 0 && current / (limit * 1024 * 1024) >= 0.9;

// // const IconDescription = styled.p<{ $alarm?: boolean }>`
// //     ${tw`text-sm ml-2`};
// //     ${(props) => props.$alarm && tw`text-red-300`};
// // `;

// // const StatusIndicatorBox = styled(GreyRowBox)<{ $status: ServerPowerState | undefined; $bg: string }>`
// //     ${tw`grid grid-cols-12 gap-4 relative`};

// //     ${({ $bg }) => `background-image: url("${$bg}");`}
// //     background-position: center;
// //     background-repeat: no-repeat;
// //     background-size: cover;

// //     & .status-bar {
// //         ${tw`w-4 h-4 bg-red-500 absolute right-0 top-0 z-20 rounded-full m-2 transition-all duration-150 animate-pulse`};

// //         ${({ $status }) =>
// //             !$status || $status === 'offline'
// //                 ? tw`bg-red-500`
// //                 : $status === 'running'
// //                 ? tw`bg-green-500`
// //                 : tw`bg-yellow-500`};
// //     }

// //     &:hover .status-bar {
// //         ${tw`opacity-75`};
// //     }
// // `;

// // type Timer = ReturnType<typeof setInterval>;

// // export default ({ server, className }: { server: Server; className?: string }) => {
// //     const interval = useRef<Timer>(null) as React.MutableRefObject<Timer>;
// //     const [isSuspended, setIsSuspended] = useState(server.status === 'suspended');
// //     const [stats, setStats] = useState<ServerStats | null>(null);

// //     const getStats = () =>
// //         getServerResourceUsage(server.uuid)
// //             .then((data) => setStats(data))
// //             .catch((error) => console.error(error));

// //     useEffect(() => {
// //         setIsSuspended(stats?.isSuspended || server.status === 'suspended');
// //     }, [stats?.isSuspended, server.status]);

// //     useEffect(() => {
// //         // Don't waste a HTTP request if there is nothing important to show to the user because
// //         // the server is suspended.
// //         if (isSuspended) return;

// //         getStats().then(() => {
// //             interval.current = setInterval(() => getStats(), 30000);
// //         });

// //         return () => {
// //             interval.current && clearInterval(interval.current);
// //         };
// //     }, [isSuspended]);

// //     const alarms = { cpu: false, memory: false, disk: false };
// //     if (stats) {
// //         alarms.cpu = server.limits.cpu === 0 ? false : stats.cpuUsagePercent >= server.limits.cpu * 0.9;
// //         alarms.memory = isAlarmState(stats.memoryUsageInBytes, server.limits.memory);
// //     }

// //     return (
// //         <StatusIndicatorBox
// //             as={Link}
// //             to={`/server/${server.id}`}
// //             className={className}
// //             $status={stats?.status}
// //             $bg={server.bg}
// //         >
// //             <div css={tw`hidden col-span-12 w-full sm:flex items-baseline justify-center items-center text-center`}>
// //                 <div>
// //                     <p css={tw`text-xl font-medium break-words m-2 text-gray-200`}>{server.name}</p>
// //                     <p css={tw`text-sm text-neutral-400 break-words line-clamp-1 mb-2`}>
// //                         {server.allocations
// //                             .filter((alloc) => alloc.isDefault)
// //                             .map((allocation) => (
// //                                 <React.Fragment key={allocation.ip + allocation.port.toString()}>
// //                                     {allocation.alias || ip(allocation.ip)}:{allocation.port}
// //                                 </React.Fragment>
// //                             ))}
// //                     </p>
// //                 </div>
// //                 {!stats ||
// //                     (isSuspended &&
// //                         (isSuspended ? (
// //                             <div css={tw`flex-1 text-center`}>
// //                                 <span css={tw`bg-red-500 rounded px-2 py-1 text-red-100 text-xs`}>
// //                                     {server.status === 'suspended' ? 'Suspended' : 'Connection Error'}
// //                                 </span>
// //                             </div>
// //                         ) : server.isTransferring || server.status ? (
// //                             <div css={tw`flex-1 text-center`}>
// //                                 <span css={tw`bg-neutral-500 rounded px-2 py-1 text-neutral-100 text-xs`}>
// //                                     {server.isTransferring
// //                                         ? 'Transferring'
// //                                         : server.status === 'installing'
// //                                         ? 'Installing'
// //                                         : server.status === 'restoring_backup'
// //                                         ? 'Restoring Backup'
// //                                         : 'Unavailable'}
// //                                 </span>
// //                             </div>
// //                         ) : (
// //                             <Spinner size={'small'} />
// //                         )))}
// //             </div>
// //             {stats && (
// //                 <div css={tw`hidden col-span-12 sm:flex items-baseline justify-center items-center`}>
// //                     <React.Fragment>
// //                         <div css={tw`flex-1 sm:block hidden`}>
// //                             <div css={tw`flex justify-center text-neutral-500`}>
// //                                 <Icon.Cpu size={20} />
// //                                 <IconDescription $alarm={alarms.cpu}>
// //                                     {stats.cpuUsagePercent.toFixed(2)}%
// //                                 </IconDescription>
// //                             </div>
// //                         </div>
// //                         <div css={tw`flex-1 sm:block hidden`}>
// //                             <div css={tw`flex justify-center text-gray-500`}>
// //                                 <Icon.PieChart size={20} />
// //                                 <IconDescription $alarm={alarms.memory}>
// //                                     {bytesToString(stats.memoryUsageInBytes)}
// //                                 </IconDescription>
// //                             </div>
// //                         </div>
// //                         <div css={tw`flex-1 sm:block hidden`}>
// //                             <div css={tw`flex justify-center text-gray-500`}>
// //                                 <Icon.HardDrive size={20} />
// //                                 <IconDescription>{bytesToString(stats?.diskUsageInBytes)}</IconDescription>
// //                             </div>
// //                         </div>
// //                     </React.Fragment>
// //                 </div>
// //             )}
// //             <div className={'status-bar'} />
// //         </StatusIndicatorBox>
// //     );
// // };

// import tw from 'twin.macro';
// import * as Icon from 'react-feather';
// import { Link } from 'react-router-dom';
// import styled from 'styled-components/macro';
// import { Server } from '@/api/server/getServer';
// import Spinner from '@/components/elements/Spinner';
// import { bytesToString, ip } from '@/lib/formatters';
// import GreyRowBox from '@/components/elements/GreyRowBox';
// import React, { useEffect, useRef, useState } from 'react';
// import getServerResourceUsage, { ServerPowerState, ServerStats } from '@/api/server/getServerResourceUsage';

// const isAlarmState = (current: number, limit: number): boolean => limit > 0 && current / (limit * 1024 * 1024) >= 0.9;

// const StyledCardContainer = styled.div<{ $bg: string; $status: ServerPowerState | undefined }>`
//     ${tw`relative overflow-hidden rounded-xl p-8 transition-all duration-300 block`};
//     background-color: hsl(0, 0%, 12%);
//     border: 1px solid hsl(0, 0%, 20%);
//     display: flex;
//     flex-direction: column;
//     gap: 2rem;
//     text-decoration: none;
//     color: inherit;
//     min-height: 200px;

//     &:hover {
//         border-color: hsl(0, 0%, 30%);
//         ${tw`shadow-lg`};
//     }

//     ${({ $bg }) =>
//         $bg &&
//         `
//         &::before {
//             content: '';
//             position: absolute;
//             inset: 0;
//             background-image: url("${$bg}");
//             background-position: center;
//             background-repeat: no-repeat;
//             background-size: cover;
//             opacity: 0.15;
//             z-index: 0;
//         }
//     `}

//     & > * {
//         position: relative;
//         z-index: 10;
//     }

//     & .status-bar {
//         ${tw`w-3 h-3 absolute top-4 right-4 z-20 rounded-full transition-all duration-200`};

//         ${({ $status }) => {
//             if (!$status || $status === 'offline') {
//                 return `
//                     background-color: rgb(239, 68, 68);
//                     box-shadow: 0 0 12px rgba(239, 68, 68, 0.5);
//                 `;
//             } else if ($status === 'running') {
//                 return `
//                     background-color: rgb(34, 197, 94);
//                     box-shadow: 0 0 12px rgba(34, 197, 94, 0.5);
//                 `;
//             } else {
//                 return `
//                     background-color: rgb(234, 179, 8);
//                     box-shadow: 0 0 12px rgba(234, 179, 8, 0.5);
//                 `;
//             }
//         }}
//     }
// `;

// const StatusIndicatorBox = styled(Link)`
//     ${tw`no-underline`};
//     all: unset;

//     & a {
//         text-decoration: none;
//         color: inherit;
//     }
// `;

// const ServerHeader = styled.div`
//     ${tw`flex-1`};
// `;

// const ServerName = styled.h3`
//     ${tw`text-xl font-semibold mb-1 transition-colors`};
//     color: white;

//     ${StatusIndicatorBox}:hover & {
//         color: rgb(34, 197, 94);
//     }
// `;

// const ServerAddress = styled.p`
//     ${tw`text-sm break-words line-clamp-1`};
//     color: hsl(0, 0%, 50%);
// `;

// const StatusBadge = styled.div<{ $type?: string }>`
//     ${tw`inline-block rounded-md px-3 py-1 text-xs font-semibold border`};

//     ${({ $type }) => {
//         if ($type === 'suspended') {
//             return `
//                 background-color: rgba(239, 68, 68, 0.2);
//                 color: rgb(248, 113, 113);
//                 border-color: rgba(239, 68, 68, 0.3);
//             `;
//         } else if ($type === 'error') {
//             return `
//                 background-color: rgba(239, 68, 68, 0.2);
//                 color: rgb(248, 113, 113);
//                 border-color: rgba(239, 68, 68, 0.3);
//             `;
//         } else if ($type === 'transferring') {
//             return `
//                 background-color: rgba(59, 130, 246, 0.2);
//                 color: rgb(147, 197, 253);
//                 border-color: rgba(59, 130, 246, 0.3);
//             `;
//         } else if ($type === 'installing') {
//             return `
//                 background-color: rgba(168, 85, 247, 0.2);
//                 color: rgb(221, 214, 254);
//                 border-color: rgba(168, 85, 247, 0.3);
//             `;
//         } else if ($type === 'restoring') {
//             return `
//                 background-color: rgba(234, 179, 8, 0.2);
//                 color: rgb(253, 230, 138);
//                 border-color: rgba(234, 179, 8, 0.3);
//             `;
//         } else {
//             return `
//                 background-color: rgba(107, 114, 128, 0.2);
//                 color: rgb(209, 213, 219);
//                 border-color: rgba(107, 114, 128, 0.3);
//             `;
//         }
//     }}
// `;

// const StatsGrid = styled.div`
//     ${tw`grid grid-cols-3 gap-8`};
//     width: 100%;
// `;

// const StatItem = styled.div`
//     ${tw`flex items-center gap-2`};
//     flex: 1;
// `;

// const StatIcon = styled.div<{ $alarm?: boolean }>`
//     ${tw`w-6 h-6 rounded-lg flex items-center justify-center transition-colors flex-shrink-0`};
//     color: ${(props) => (props.$alarm ? 'rgb(239, 68, 68)' : 'white')};
// `;

// const StatValue = styled.span<{ $alarm?: boolean }>`
//     ${tw`text-sm font-semibold`};
//     color: ${(props) => (props.$alarm ? 'rgb(239, 68, 68)' : 'white')};
// `;

// const StatLabel = styled.p`
//     ${tw`text-xs`};
//     color: hsl(0, 0%, 50%);
//     margin: 0;
// `;

// type Timer = ReturnType<typeof setInterval>;

// export default ({ server, className }: { server: Server; className?: string }) => {
//     const interval = useRef<Timer>(null) as React.MutableRefObject<Timer>;
//     const [isSuspended, setIsSuspended] = useState(server.status === 'suspended');
//     const [stats, setStats] = useState<ServerStats | null>(null);

//     const getStats = () =>
//         getServerResourceUsage(server.uuid)
//             .then((data) => setStats(data))
//             .catch((error) => console.error(error));

//     useEffect(() => {
//         setIsSuspended(stats?.isSuspended || server.status === 'suspended');
//     }, [stats?.isSuspended, server.status]);

//     useEffect(() => {
//         if (isSuspended) return;

//         getStats().then(() => {
//             interval.current = setInterval(() => getStats(), 30000);
//         });

//         return () => {
//             interval.current && clearInterval(interval.current);
//         };
//     }, [isSuspended]);

//     const alarms = { cpu: false, memory: false, disk: false };
//     if (stats) {
//         alarms.cpu = server.limits.cpu === 0 ? false : stats.cpuUsagePercent >= server.limits.cpu * 0.9;
//         alarms.memory = isAlarmState(stats.memoryUsageInBytes, server.limits.memory);
//     }

//     const getStatusType = () => {
//         if (server.status === 'suspended') return 'suspended';
//         if (server.isTransferring) return 'transferring';
//         if (server.status === 'installing') return 'installing';
//         if (server.status === 'restoring_backup') return 'restoring';
//         if (server.status) return 'error';
//         return undefined;
//     };

//     return (
//         <Link to={`/server/${server.id}`} style={{ textDecoration: 'none', display: 'block' }}>
//             <StyledCardContainer $status={stats?.status} $bg={server.bg}>
//                 <ServerHeader>
//                     <ServerName>{server.name}</ServerName>
//                     <ServerAddress>
//                         {server.allocations
//                             .filter((alloc) => alloc.isDefault)
//                             .map((allocation) => (
//                                 <React.Fragment key={allocation.ip + allocation.port.toString()}>
//                                     {allocation.alias || ip(allocation.ip)}:{allocation.port}
//                                 </React.Fragment>
//                             ))}
//                     </ServerAddress>
//                 </ServerHeader>

//                 {!stats || isSuspended ? (
//                     <div>
//                         {isSuspended ? (
//                             <StatusBadge $type={server.status === 'suspended' ? 'suspended' : 'error'}>
//                                 {server.status === 'suspended' ? 'Suspended' : 'Connection Error'}
//                             </StatusBadge>
//                         ) : server.isTransferring || server.status ? (
//                             <StatusBadge $type={getStatusType()}>
//                                 {server.isTransferring
//                                     ? 'Transferring'
//                                     : server.status === 'installing'
//                                     ? 'Installing'
//                                     : server.status === 'restoring_backup'
//                                     ? 'Restoring Backup'
//                                     : 'Unavailable'}
//                             </StatusBadge>
//                         ) : (
//                             <Spinner size={'small'} />
//                         )}
//                     </div>
//                 ) : (
//                     <StatsGrid>
//                         <StatItem>
//                             <StatIcon $alarm={alarms.cpu}>
//                                 <Icon.Cpu size={20} />
//                             </StatIcon>
//                             <StatValue $alarm={alarms.cpu}>{stats.cpuUsagePercent.toFixed(2)}%</StatValue>
//                             <StatLabel>CPU</StatLabel>
//                         </StatItem>
//                         <StatItem>
//                             <StatIcon $alarm={alarms.memory}>
//                                 <Icon.PieChart size={20} />
//                             </StatIcon>
//                             <StatValue $alarm={alarms.memory}>{bytesToString(stats.memoryUsageInBytes)}</StatValue>
//                             <StatLabel>Memory</StatLabel>
//                         </StatItem>
//                         <StatItem>
//                             <StatIcon>
//                                 <Icon.HardDrive size={20} />
//                             </StatIcon>
//                             <StatValue>{bytesToString(stats?.diskUsageInBytes)}</StatValue>
//                             <StatLabel>Disk</StatLabel>
//                         </StatItem>
//                     </StatsGrid>
//                 )}

//                 <div className={'status-bar'} />
//             </StyledCardContainer>
//         </Link>
//     );
// };

import tw from 'twin.macro';
import * as Icon from 'react-feather';
import { Link } from 'react-router-dom';
import styled from 'styled-components/macro';
import { Server } from '@/api/server/getServer';
import Spinner from '@/components/elements/Spinner';
import { bytesToString, ip } from '@/lib/formatters';
import React, { useEffect, useRef, useState } from 'react';
import getServerResourceUsage, { ServerPowerState, ServerStats } from '@/api/server/getServerResourceUsage';

const isAlarmState = (current: number, limit: number): boolean => limit > 0 && current / (limit * 1024 * 1024) >= 0.9;

const StyledCardContainer = styled.div<{ $bg: string; $status: ServerPowerState | undefined }>`
    ${tw`relative overflow-hidden rounded-xl p-8 transition-all duration-300 block`};
    background-color: hsl(0, 0%, 12%);
    border: 1px solid hsl(0, 0%, 20%);
    display: flex;
    flex-direction: column;
    gap: 2rem;
    text-decoration: none;
    color: inherit;
    min-height: 200px;

    &:hover {
        border-color: hsl(0, 0%, 30%);
        ${tw`shadow-lg`};
    }

    ${({ $bg }) =>
        $bg &&
        `
        &::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("${$bg}");
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            opacity: 0.15;
            z-index: 0;
        }
    `}

    & > * {
        position: relative;
        z-index: 10;
    }

    & .status-bar {
        ${tw`w-3 h-3 absolute top-4 right-4 z-20 rounded-full transition-all duration-200`};

        ${({ $status }) => {
            if (!$status || $status === 'offline') {
                return `
                    background-color: rgb(239, 68, 68);
                    box-shadow: 0 0 12px rgba(239, 68, 68, 0.5);
                `;
            } else if ($status === 'running') {
                return `
                    background-color: rgb(34, 197, 94);
                    box-shadow: 0 0 12px rgba(34, 197, 94, 0.5);
                `;
            } else {
                return `
                    background-color: rgb(234, 179, 8);
                    box-shadow: 0 0 12px rgba(234, 179, 8, 0.5);
                `;
            }
        }}
    }

    @media (max-width: 1280px) {
        padding: 1rem;
        gap: 1rem;
        min-height: auto;
    }
`;

const StatusIndicatorBox = styled(Link)`
    ${tw`no-underline`};
    all: unset;

    & a {
        text-decoration: none;
        color: inherit;
    }
`;

const ServerHeader = styled.div`
    ${tw`flex-1`};
`;

const ServerName = styled.h3`
    ${tw`text-xl font-semibold mb-1 transition-colors`};
    color: white;

    ${StatusIndicatorBox}:hover & {
        color: rgb(34, 197, 94);
    }

    @media (max-width: 1280px) {
        font-size: 1rem;
    }
`;

const ServerAddress = styled.p`
    ${tw`text-sm break-words line-clamp-1`};
    color: hsl(0, 0%, 50%);
    margin: 0;

    @media (max-width: 1280px) {
        font-size: 0.75rem;
    }
`;

const StatusBadge = styled.div<{ $type?: string }>`
    ${tw`inline-block rounded-md px-3 py-1 text-xs font-semibold border`};

    ${({ $type }) => {
        if ($type === 'suspended') {
            return `
                background-color: rgba(239, 68, 68, 0.2);
                color: rgb(248, 113, 113);
                border-color: rgba(239, 68, 68, 0.3);
            `;
        } else if ($type === 'error') {
            return `
                background-color: rgba(239, 68, 68, 0.2);
                color: rgb(248, 113, 113);
                border-color: rgba(239, 68, 68, 0.3);
            `;
        } else if ($type === 'transferring') {
            return `
                background-color: rgba(59, 130, 246, 0.2);
                color: rgb(147, 197, 253);
                border-color: rgba(59, 130, 246, 0.3);
            `;
        } else if ($type === 'installing') {
            return `
                background-color: rgba(168, 85, 247, 0.2);
                color: rgb(221, 214, 254);
                border-color: rgba(168, 85, 247, 0.3);
            `;
        } else if ($type === 'restoring') {
            return `
                background-color: rgba(234, 179, 8, 0.2);
                color: rgb(253, 230, 138);
                border-color: rgba(234, 179, 8, 0.3);
            `;
        } else {
            return `
                background-color: rgba(107, 114, 128, 0.2);
                color: rgb(209, 213, 219);
                border-color: rgba(107, 114, 128, 0.3);
            `;
        }
    }}
`;

const StatsGrid = styled.div`
    ${tw`grid grid-cols-3 gap-8`};
    width: 100%;

    @media (max-width: 1280px) {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
    }
`;

const StatItem = styled.div`
    ${tw`flex items-center gap-2`};
    flex: 1;

    @media (max-width: 1280px) {
        flex-direction: column;
        gap: 0.25rem;
        text-align: center;
    }
`;

const StatIcon = styled.div<{ $alarm?: boolean }>`
    ${tw`w-6 h-6 rounded-lg flex items-center justify-center transition-colors flex-shrink-0`};
    color: ${(props) => (props.$alarm ? 'rgb(239, 68, 68)' : 'white')};

    @media (max-width: 1280px) {
        width: 1.25rem;
        height: 1.25rem;

        svg {
            width: 0.875rem;
            height: 0.875rem;
        }
    }
`;

const StatValue = styled.span<{ $alarm?: boolean }>`
    ${tw`text-sm font-semibold`};
    color: ${(props) => (props.$alarm ? 'rgb(239, 68, 68)' : 'white')};

    @media (max-width: 1280px) {
        font-size: 0.7rem;
        line-height: 1;
    }
`;

const StatLabel = styled.p`
    ${tw`text-xs`};
    color: hsl(0, 0%, 50%);
    margin: 0;
    display: none;

    @media (max-width: 1280px) {
        display: block;
        font-size: 0.6rem;
    }
`;

type Timer = ReturnType<typeof setInterval>;

export default ({ server, className }: { server: Server; className?: string }) => {
    const interval = useRef<Timer>(null) as React.MutableRefObject<Timer>;
    const [isSuspended, setIsSuspended] = useState(server.status === 'suspended');
    const [stats, setStats] = useState<ServerStats | null>(null);

    const getStats = () =>
        getServerResourceUsage(server.uuid)
            .then((data) => setStats(data))
            .catch((error) => console.error(error));

    useEffect(() => {
        setIsSuspended(stats?.isSuspended || server.status === 'suspended');
    }, [stats?.isSuspended, server.status]);

    useEffect(() => {
        if (isSuspended) return;

        getStats().then(() => {
            interval.current = setInterval(() => getStats(), 30000);
        });

        return () => {
            interval.current && clearInterval(interval.current);
        };
    }, [isSuspended]);

    const alarms = { cpu: false, memory: false, disk: false };
    if (stats) {
        alarms.cpu = server.limits.cpu === 0 ? false : stats.cpuUsagePercent >= server.limits.cpu * 0.9;
        alarms.memory = isAlarmState(stats.memoryUsageInBytes, server.limits.memory);
    }

    const getStatusType = () => {
        if (server.status === 'suspended') return 'suspended';
        if (server.isTransferring) return 'transferring';
        if (server.status === 'installing') return 'installing';
        if (server.status === 'restoring_backup') return 'restoring';
        if (server.status) return 'error';
        return undefined;
    };

    return (
        <Link to={`/server/${server.id}`} style={{ textDecoration: 'none', display: 'block' }}>
            <StyledCardContainer $status={stats?.status} $bg={server.bg}>
                <ServerHeader>
                    <ServerName>{server.name}</ServerName>
                    <ServerAddress>
                        {server.allocations
                            .filter((alloc) => alloc.isDefault)
                            .map((allocation) => (
                                <React.Fragment key={allocation.ip + allocation.port.toString()}>
                                    {allocation.alias || ip(allocation.ip)}:{allocation.port}
                                </React.Fragment>
                            ))}
                    </ServerAddress>
                </ServerHeader>

                {!stats || isSuspended ? (
                    <div>
                        {isSuspended ? (
                            <StatusBadge $type={server.status === 'suspended' ? 'suspended' : 'error'}>
                                {server.status === 'suspended' ? 'Suspended' : 'Connection Error'}
                            </StatusBadge>
                        ) : server.isTransferring || server.status ? (
                            <StatusBadge $type={getStatusType()}>
                                {server.isTransferring
                                    ? 'Transferring'
                                    : server.status === 'installing'
                                    ? 'Installing'
                                    : server.status === 'restoring_backup'
                                    ? 'Restoring Backup'
                                    : 'Unavailable'}
                            </StatusBadge>
                        ) : (
                            <Spinner size={'small'} />
                        )}
                    </div>
                ) : (
                    <StatsGrid>
                        <StatItem>
                            <StatIcon $alarm={alarms.cpu}>
                                <Icon.Cpu size={20} />
                            </StatIcon>
                            <StatValue $alarm={alarms.cpu}>{stats.cpuUsagePercent.toFixed(2)}%</StatValue>
                            <StatLabel>CPU</StatLabel>
                        </StatItem>
                        <StatItem>
                            <StatIcon $alarm={alarms.memory}>
                                <Icon.PieChart size={20} />
                            </StatIcon>
                            <StatValue $alarm={alarms.memory}>{bytesToString(stats.memoryUsageInBytes)}</StatValue>
                            <StatLabel>Memory</StatLabel>
                        </StatItem>
                        <StatItem>
                            <StatIcon>
                                <Icon.HardDrive size={20} />
                            </StatIcon>
                            <StatValue>{bytesToString(stats?.diskUsageInBytes)}</StatValue>
                            <StatLabel>Disk</StatLabel>
                        </StatItem>
                    </StatsGrid>
                )}

                <div className={'status-bar'} />
            </StyledCardContainer>
        </Link>
    );
};
</file>

<file path="resources/scripts/components/elements/activity/ActivityLogEntry.tsx">
import React from 'react';
import classNames from 'classnames';
import * as Icon from 'react-feather';
import style from './style.module.css';
import { Link } from 'react-router-dom';
import Avatar from '@/components/Avatar';
import { ActivityLog } from '@definitions/user';
import useLocationHash from '@/plugins/useLocationHash';
import Translate from '@/components/elements/Translate';
import { getObjectKeys, isObject } from '@/lib/objects';
import Tooltip from '@/components/elements/tooltip/Tooltip';
import { format, formatDistanceToNowStrict } from 'date-fns';
import ActivityLogMetaButton from '@/components/elements/activity/ActivityLogMetaButton';

interface Props {
    activity: ActivityLog;
    children?: React.ReactNode;
}

export function wrapProperties(value: unknown): any {
    if (value === null || typeof value === 'string' || typeof value === 'number') {
        return `<strong>${String(value)}</strong>`;
    }

    if (isObject(value)) {
        return getObjectKeys(value).reduce((obj, key) => {
            if (key === 'count' || (typeof key === 'string' && key.endsWith('_count'))) {
                return { ...obj, [key]: value[key] };
            }
            return { ...obj, [key]: wrapProperties(value[key]) };
        }, {} as Record<string, unknown>);
    }

    if (Array.isArray(value)) {
        return value.map(wrapProperties);
    }

    return value;
}

export default ({ activity, children }: Props) => {
    const { pathTo } = useLocationHash();
    const actor = activity.relationships.actor;
    const properties = wrapProperties(activity.properties);

    return (
        <div className={'grid grid-cols-10 py-4 border-b-2 border-gray-800 last:rounded-b last:border-0 group'}>
            <div className={'hidden sm:flex sm:col-span-1 items-center justify-center select-none'}>
                <div className={'flex items-center w-10 h-10 rounded-full bg-gray-600 overflow-hidden'}>
                    <Avatar name={actor?.uuid || 'system'} />
                </div>
            </div>
            <div className={'col-span-10 sm:col-span-9 flex'}>
                <div className={'flex-1 px-4 sm:px-0'}>
                    <div className={'flex items-center text-gray-50'}>
                        <Tooltip placement={'top'} content={actor?.email || 'System User'}>
                            <span>{actor?.username || 'System'}</span>
                        </Tooltip>
                        <span className={'text-gray-400'}>&nbsp;&mdash;&nbsp;</span>
                        <Link
                            to={`#${pathTo({ event: activity.event })}`}
                            className={'transition-colors duration-75 active:text-cyan-400 hover:text-cyan-400'}
                        >
                            <Translate ns={'activity'} values={properties} i18nKey={activity.event.replace(':', '.')} />
                        </Link>
                        <div className={classNames(style.icons, 'group-hover:text-gray-300')}>
                            {activity.isApi && (
                                <Tooltip placement={'top'} content={'Using API Key'}>
                                    <Icon.Key />
                                </Tooltip>
                            )}
                            {activity.event.startsWith('server:sftp.') && (
                                <Tooltip placement={'top'} content={'Using SFTP'}>
                                    <Icon.Folder />
                                </Tooltip>
                            )}
                            {children}
                        </div>
                    </div>
                    <p className={style.description}>
                        <Translate ns={'activity'} values={properties} i18nKey={activity.event.replace(':', '.')} />
                    </p>
                    <div className={'mt-1 flex items-center text-sm'}>
                        {activity.ip && (
                            <span>
                                {activity.ip}
                                <span className={'text-gray-400'}>&nbsp;|&nbsp;</span>
                            </span>
                        )}
                        <Tooltip placement={'right'} content={format(activity.timestamp, 'MMM do, yyyy H:mm:ss')}>
                            <span>{formatDistanceToNowStrict(activity.timestamp, { addSuffix: true })}</span>
                        </Tooltip>
                    </div>
                </div>
                {activity.hasAdditionalMetadata && <ActivityLogMetaButton meta={activity.properties} />}
            </div>
        </div>
    );
};
</file>

<file path="resources/scripts/components/elements/activity/ActivityLogMetaButton.tsx">
import React, { useState } from 'react';
import { ClipboardListIcon } from '@heroicons/react/outline';
import { Dialog } from '@/components/elements/dialog';
import { Button } from '@/components/elements/button/index';

export default ({ meta }: { meta: Record<string, unknown> }) => {
    const [open, setOpen] = useState(false);

    return (
        <div className={'self-center md:px-4'}>
            <Dialog open={open} onClose={() => setOpen(false)} hideCloseIcon title={'Metadata'}>
                <pre
                    className={
                        'bg-gray-900 rounded p-2 font-mono text-sm leading-relaxed overflow-x-scroll whitespace-pre-wrap'
                    }
                >
                    {JSON.stringify(meta, null, 2)}
                </pre>
                <Dialog.Footer>
                    <Button.Text onClick={() => setOpen(false)}>Close</Button.Text>
                </Dialog.Footer>
            </Dialog>
            <button
                aria-describedby={'View additional event metadata'}
                className={
                    'p-2 transition-colors duration-100 text-gray-400 group-hover:text-gray-300 group-hover:hover:text-gray-50'
                }
                onClick={() => setOpen(true)}
            >
                <ClipboardListIcon className={'w-5 h-5'} />
            </button>
        </div>
    );
};
</file>

<file path="resources/scripts/components/elements/activity/style.module.css">
.icons {
    @apply flex space-x-1 mx-2 transition-colors duration-100 text-gray-400;

    & svg {
        @apply px-1 py-px cursor-pointer hover:text-gray-50 h-5 w-auto;
    }
}

.description {
    @apply mt-1 text-sm break-words line-clamp-2 pr-4;

    & strong {
        @apply text-gray-50 font-semibold break-all;
    }
}
</file>

<file path="resources/scripts/components/elements/alert/Alert.tsx">
import React from 'react';
import classNames from 'classnames';
import { ExclamationIcon, InformationCircleIcon } from '@heroicons/react/outline';

interface AlertProps {
    type: 'success' | 'info' | 'warning' | 'danger';
    className?: string;
    children: React.ReactNode;
}

export default ({ type, className, children }: AlertProps) => {
    return (
        <div
            className={classNames(
                'flex items-center border-l-8 text-gray-50 rounded-md shadow px-4 py-3',
                {
                    ['border-green-500 bg-green-500/25']: type === 'success',
                    ['border-blue-500 bg-blue-500/25']: type === 'info',
                    ['border-yellow-500 bg-yellow-500/25']: type === 'warning',
                    ['border-red-500 bg-red-500/25']: type === 'danger',
                },
                className
            )}
        >
            {type === 'warning' ? (
                <ExclamationIcon className={'w-6 h-6 text-yellow-500 mr-2'} />
            ) : type === 'success' ? (
                <InformationCircleIcon className={'w-6 h-6 text-green-500 mr-2'} />
            ) : type === 'info' ? (
                <InformationCircleIcon className={'w-6 h-6 text-blue-500 mr-2'} />
            ) : (
                <InformationCircleIcon className={'w-6 h-6 text-red-500 mr-2'} />
            )}
            {children}
        </div>
    );
};
</file>

<file path="resources/scripts/components/elements/alert/index.ts">
export { default as Alert } from './Alert';
</file>

<file path="resources/scripts/components/elements/button/Button.tsx">
import classNames from 'classnames';
import styles from './style.module.css';
import React, { forwardRef } from 'react';
import { ButtonProps, Options } from '@/components/elements/button/types';

const Button = forwardRef<HTMLButtonElement, ButtonProps>(
    ({ children, shape, size, variant, className, ...rest }, ref) => {
        return (
            <button
                ref={ref}
                className={classNames(
                    styles.button,
                    styles.primary,
                    {
                        [styles.secondary]: variant === Options.Variant.Secondary,
                        [styles.square]: shape === Options.Shape.IconSquare,
                        [styles.small]: size === Options.Size.Small,
                        [styles.large]: size === Options.Size.Large,
                    },
                    className
                )}
                {...rest}
            >
                {children}
            </button>
        );
    }
);

const TextButton = forwardRef<HTMLButtonElement, ButtonProps>(({ className, ...props }, ref) => (
    // @ts-expect-error not sure how to get this correct
    <Button ref={ref} className={classNames(styles.text, className)} {...props} />
));

const SuccessButton = forwardRef<HTMLButtonElement, ButtonProps>(({ className, ...props }, ref) => (
    // @ts-expect-error not sure how to get this correct
    <Button ref={ref} className={classNames(styles.success, className)} {...props} />
));

const WarnButton = forwardRef<HTMLButtonElement, ButtonProps>(({ className, ...props }, ref) => (
    // @ts-expect-error not sure how to get this correct
    <Button ref={ref} className={classNames(styles.warn, className)} {...props} />
));

const DangerButton = forwardRef<HTMLButtonElement, ButtonProps>(({ className, ...props }, ref) => (
    // @ts-expect-error not sure how to get this correct
    <Button ref={ref} className={classNames(styles.danger, className)} {...props} />
));

const _Button = Object.assign(Button, {
    Sizes: Options.Size,
    Shapes: Options.Shape,
    Variants: Options.Variant,
    Text: TextButton,
    Danger: DangerButton,
    Success: SuccessButton,
    Warn: WarnButton,
});

export default _Button;
</file>

<file path="resources/scripts/components/elements/button/index.ts">
export { default as Button } from './Button';
export { default as styles } from './style.module.css';
</file>

<file path="resources/scripts/components/elements/button/style.module.css">
.button {
    @apply px-4 py-2 inline-flex items-center justify-center;
    @apply rounded text-base font-semibold transition-all duration-100;
    @apply focus:ring-[3px] focus:ring-offset-2 focus:ring-offset-gray-700 focus:ring-opacity-50;

    /* Sizing Controls */
    &.small {
        @apply px-4 py-0 h-8 font-normal text-sm focus:ring-2;
    }

    &.large {
        @apply px-5 py-3;
    }

    &.secondary {
        @apply text-gray-50 bg-transparent;

        &:disabled {
            background: transparent !important;
        }
    }

    &:disabled {
        @apply cursor-not-allowed;
    }

    &.square {
        @apply p-0 w-12 h-12;

        &.small {
            @apply w-8 h-8;
        }
    }
}

.primary {
    @apply bg-green-600 text-green-50;
    @apply hover:bg-green-500 active:bg-green-500 focus:ring-green-400 focus:ring-opacity-75;

    &.secondary {
        @apply hover:bg-green-600 active:bg-green-600;
    }

    &:disabled {
        @apply bg-green-500/75 text-green-200/75;
    }
}

.success {
    @apply bg-green-600 text-green-50;
    @apply hover:bg-green-500 active:bg-green-500 focus:ring-green-400 focus:ring-opacity-75;

    &.secondary {
        @apply hover:bg-green-600 active:bg-green-600;
    }

    &:disabled {
        @apply bg-green-500/75 text-green-200/75;
    }
}

.warn {
    @apply bg-yellow-600 text-yellow-50;
    @apply hover:bg-yellow-500 active:bg-yellow-500 focus:ring-yellow-400 focus:ring-opacity-75;

    &.secondary {
        @apply hover:bg-yellow-600 active:bg-yellow-600;
    }

    &:disabled {
        @apply bg-yellow-500/75 text-yellow-200/75;
    }
}

.danger {
    @apply bg-red-600 text-gray-50;
    @apply hover:bg-red-500 active:bg-red-500 focus:ring-red-400 focus:ring-opacity-75;

    &.secondary {
        @apply hover:bg-red-600 active:bg-red-600;
    }

    &:disabled {
        @apply bg-red-600/75 text-red-50/75;
    }
}

.text {
    @apply bg-gray-500 text-gray-50;
    @apply hover:bg-gray-400 active:bg-gray-400 focus:ring-gray-300 focus:ring-opacity-50;

    &.secondary {
        @apply hover:bg-gray-500 active:bg-gray-500;
    }

    &:disabled {
        @apply bg-gray-500/75 text-gray-200/75;
    }
}
</file>

<file path="resources/scripts/components/elements/button/types.ts">
enum Shape {
    Default,
    IconSquare,
}

enum Size {
    Default,
    Small,
    Large,
}

enum Variant {
    Primary,
    Success,
    Secondary,
}

export const Options = { Shape, Size, Variant };

export type ButtonProps = JSX.IntrinsicElements['button'] & {
    shape?: Shape;
    size?: Size;
    variant?: Variant;
};
</file>

<file path="resources/scripts/components/elements/dialog/ConfirmationDialog.tsx">
import React from 'react';
import { Dialog, RenderDialogProps } from './';
import { Button } from '@/components/elements/button/index';

type ConfirmationProps = Omit<RenderDialogProps, 'description' | 'children'> & {
    children: React.ReactNode;
    confirm?: string | undefined;
    onConfirmed: (e: React.MouseEvent<HTMLButtonElement, MouseEvent>) => void;
};

export default ({ confirm = 'Okay', children, onConfirmed, ...props }: ConfirmationProps) => {
    return (
        <Dialog {...props} description={typeof children === 'string' ? children : undefined}>
            {typeof children !== 'string' && children}
            <Dialog.Footer>
                <Button.Text onClick={props.onClose}>Cancel</Button.Text>
                <Button.Danger onClick={onConfirmed}>{confirm}</Button.Danger>
            </Dialog.Footer>
        </Dialog>
    );
};
</file>

<file path="resources/scripts/components/elements/dialog/context.ts">
import React from 'react';
import { DialogContextType, DialogWrapperContextType } from './types';

export const DialogContext = React.createContext<DialogContextType>({
    setIcon: () => null,
    setFooter: () => null,
    setIconPosition: () => null,
});

export const DialogWrapperContext = React.createContext<DialogWrapperContextType>({
    props: {},
    setProps: () => null,
    close: () => null,
});
</file>

<file path="resources/scripts/components/elements/dialog/Dialog.tsx">
import React, { useRef, useState } from 'react';
import { Dialog as HDialog } from '@headlessui/react';
import { Button } from '@/components/elements/button/index';
import { XIcon } from '@heroicons/react/solid';
import { AnimatePresence, motion } from 'framer-motion';
import { DialogContext, IconPosition, RenderDialogProps, styles } from './';

const variants = {
    open: {
        scale: 1,
        opacity: 1,
        transition: {
            type: 'spring',
            damping: 15,
            stiffness: 300,
            duration: 0.15,
        },
    },
    closed: {
        scale: 0.75,
        opacity: 0,
        transition: {
            type: 'easeIn',
            duration: 0.15,
        },
    },
    bounce: {
        scale: 0.95,
        opacity: 1,
        transition: { type: 'linear', duration: 0.075 },
    },
};

export default ({
    open,
    title,
    description,
    onClose,
    hideCloseIcon,
    preventExternalClose,
    children,
}: RenderDialogProps) => {
    const container = useRef<HTMLDivElement>(null);
    const [icon, setIcon] = useState<React.ReactNode>();
    const [footer, setFooter] = useState<React.ReactNode>();
    const [iconPosition, setIconPosition] = useState<IconPosition>('title');
    const [down, setDown] = useState(false);

    const onContainerClick = (down: boolean, e: React.MouseEvent<HTMLDivElement>): void => {
        if (e.target instanceof HTMLElement && container.current?.isSameNode(e.target)) {
            setDown(down);
        }
    };

    const onDialogClose = (): void => {
        if (!preventExternalClose) {
            return onClose();
        }
    };

    return (
        <AnimatePresence>
            {open && (
                <DialogContext.Provider value={{ setIcon, setFooter, setIconPosition }}>
                    <HDialog
                        static
                        as={motion.div}
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        transition={{ duration: 0.15 }}
                        open={open}
                        onClose={onDialogClose}
                    >
                        <div className={'fixed inset-0 bg-gray-900/50 z-40'} />
                        <div className={'fixed inset-0 overflow-y-auto z-50'}>
                            <div
                                ref={container}
                                className={styles.container}
                                onMouseDown={onContainerClick.bind(this, true)}
                                onMouseUp={onContainerClick.bind(this, false)}
                            >
                                <HDialog.Panel
                                    as={motion.div}
                                    initial={'closed'}
                                    animate={down ? 'bounce' : 'open'}
                                    exit={'closed'}
                                    variants={variants}
                                    className={styles.panel}
                                >
                                    <div className={'flex p-6 pb-0 overflow-y-auto'}>
                                        {iconPosition === 'container' && icon}
                                        <div className={'flex-1 max-h-[70vh] min-w-0'}>
                                            <div className={'flex items-center'}>
                                                {iconPosition !== 'container' && icon}
                                                <div>
                                                    {title && (
                                                        <HDialog.Title className={styles.title}>{title}</HDialog.Title>
                                                    )}
                                                    {description && (
                                                        <HDialog.Description>{description}</HDialog.Description>
                                                    )}
                                                </div>
                                            </div>
                                            {children}
                                            <div className={'invisible h-6'} />
                                        </div>
                                    </div>
                                    {footer}
                                    {/* Keep this below the other buttons so that it isn't the default focus if they're present. */}
                                    {!hideCloseIcon && (
                                        <div className={'absolute right-0 top-0 m-4'}>
                                            <Button.Text
                                                size={Button.Sizes.Small}
                                                shape={Button.Shapes.IconSquare}
                                                onClick={onClose}
                                                className={'group'}
                                            >
                                                <XIcon className={styles.close_icon} />
                                            </Button.Text>
                                        </div>
                                    )}
                                </HDialog.Panel>
                            </div>
                        </div>
                    </HDialog>
                </DialogContext.Provider>
            )}
        </AnimatePresence>
    );
};
</file>

<file path="resources/scripts/components/elements/dialog/DialogFooter.tsx">
import React, { useContext } from 'react';
import { DialogContext } from './';
import { useDeepCompareEffect } from '@/plugins/useDeepCompareEffect';

export default ({ children }: { children: React.ReactNode }) => {
    const { setFooter } = useContext(DialogContext);

    useDeepCompareEffect(() => {
        setFooter(
            <div className={'px-6 py-3 bg-neutral-850 flex items-center justify-end space-x-3 rounded-b'}>
                {children}
            </div>
        );
    }, [children]);

    return null;
};
</file>

<file path="resources/scripts/components/elements/dialog/DialogIcon.tsx">
import React, { useContext, useEffect } from 'react';
import { CheckIcon, ExclamationIcon, InformationCircleIcon, ShieldExclamationIcon } from '@heroicons/react/outline';
import classNames from 'classnames';
import { DialogContext, DialogIconProps, styles } from './';

const icons = {
    danger: ShieldExclamationIcon,
    warning: ExclamationIcon,
    success: CheckIcon,
    info: InformationCircleIcon,
};

export default ({ type, position, className }: DialogIconProps) => {
    const { setIcon, setIconPosition } = useContext(DialogContext);

    useEffect(() => {
        const Icon = icons[type];

        setIcon(
            <div className={classNames(styles.dialog_icon, styles[type], className)}>
                <Icon className={'w-6 h-6'} />
            </div>
        );
    }, [type, className]);

    useEffect(() => {
        setIconPosition(position);
    }, [position]);

    return null;
};
</file>

<file path="resources/scripts/components/elements/dialog/index.ts">
import DialogComponent from './Dialog';
import DialogFooter from './DialogFooter';
import DialogIcon from './DialogIcon';
import ConfirmationDialog from './ConfirmationDialog';

const Dialog = Object.assign(DialogComponent, {
    Confirm: ConfirmationDialog,
    Footer: DialogFooter,
    Icon: DialogIcon,
});

export { Dialog };
export * from './types.d';
export * from './context';
export { default as styles } from './style.module.css';
</file>

<file path="resources/scripts/components/elements/dialog/style.module.css">
.container {
    @apply flex min-h-full items-center justify-center p-4 text-center;
}

.panel {
    @apply relative bg-gray-900 rounded max-w-xl w-full mx-auto shadow-lg text-left;
    @apply ring-4 ring-gray-800 ring-opacity-80;
}

.title {
    @apply text-xl font-medium mb-2 text-gray-50 pr-4;
}

.close_icon {
    @apply w-5 h-5 group-hover:rotate-90 transition-transform duration-100;
}

.dialog_icon {
    @apply flex items-center justify-center w-10 h-10 rounded-full mr-4;

    &.danger {
        @apply bg-red-500 text-red-50;
    }

    &.warning {
        @apply bg-yellow-600 text-yellow-50;
    }

    &.success {
        @apply bg-green-600 text-green-50;
    }

    &.info {
        @apply bg-primary-500 text-primary-50;
    }
}
</file>

<file path="resources/scripts/components/elements/dialog/types.d.ts">
import React from 'react';
import { IconPosition } from '@/components/elements/dialog/DialogIcon';

type Callback<T> = ((value: T) => void) | React.Dispatch<React.SetStateAction<T>>;

export interface DialogProps {
    open: boolean;
    onClose: () => void;
}

export type IconPosition = 'title' | 'container' | undefined;

export interface DialogIconProps {
    type: 'danger' | 'info' | 'success' | 'warning';
    position?: IconPosition;
    className?: string;
}

export interface RenderDialogProps extends DialogProps {
    hideCloseIcon?: boolean;
    preventExternalClose?: boolean;
    title?: string;
    description?: string | undefined;
    children?: React.ReactNode;
}

export type WrapperProps = Omit<RenderDialogProps, 'children' | 'open' | 'onClose'>;
export interface DialogWrapperContextType {
    props: Readonly<WrapperProps>;
    setProps: React.Dispatch<React.SetStateAction<WrapperProps>>;
    close: () => void;
}

export interface DialogContextType {
    setIcon: Callback<React.ReactNode>;
    setFooter: Callback<React.ReactNode>;
    setIconPosition: Callback<IconPosition>;
}
</file>

<file path="resources/scripts/components/elements/dropdown/Dropdown.tsx">
import React, { ElementType, forwardRef, useMemo } from 'react';
import { Menu, Transition } from '@headlessui/react';
import styles from './style.module.css';
import classNames from 'classnames';
import DropdownItem from '@/components/elements/dropdown/DropdownItem';
import DropdownButton from '@/components/elements/dropdown/DropdownButton';

interface Props {
    as?: ElementType;
    children: React.ReactNode;
}

const DropdownGap = ({ invisible }: { invisible?: boolean }) => (
    <div className={classNames('border m-2', { 'border-neutral-700': !invisible, 'border-transparent': invisible })} />
);

type TypedChild = (React.ReactChild | React.ReactFragment | React.ReactPortal) & {
    type?: JSX.Element;
};

const Dropdown = forwardRef<typeof Menu, Props>(({ as, children }, ref) => {
    const [Button, items] = useMemo(() => {
        const list = React.Children.toArray(children) as unknown as TypedChild[];

        return [
            list.filter((child) => child.type === DropdownButton),
            list.filter((child) => child.type !== DropdownButton),
        ];
    }, [children]);

    if (!Button) {
        throw new Error('Cannot mount <Dropdown /> component without a child <Dropdown.Button />.');
    }

    return (
        <Menu as={as || 'div'} className={styles.menu} ref={ref}>
            {Button}
            <Transition
                enter={'transition duration-100 ease-out'}
                enterFrom={'transition scale-95 opacity-0'}
                enterTo={'transform scale-100 opacity-100'}
                leave={'transition duration-75 ease-out'}
                leaveFrom={'transform scale-100 opacity-100'}
                leaveTo={'transform scale-95 opacity-0'}
            >
                <Menu.Items className={classNames(styles.items_container, 'w-56')}>
                    <div className={'px-1 py-1'}>{items}</div>
                </Menu.Items>
            </Transition>
        </Menu>
    );
});

const _Dropdown = Object.assign(Dropdown, {
    Button: DropdownButton,
    Item: DropdownItem,
    Gap: DropdownGap,
});

export { _Dropdown as default };
</file>

<file path="resources/scripts/components/elements/dropdown/DropdownButton.tsx">
import classNames from 'classnames';
import styles from '@/components/elements/dropdown/style.module.css';
import { ChevronDownIcon } from '@heroicons/react/solid';
import { Menu } from '@headlessui/react';
import React from 'react';

interface Props {
    className?: string;
    animate?: boolean;
    children: React.ReactNode;
}

export default ({ className, animate = true, children }: Props) => (
    <Menu.Button className={classNames(styles.button, className || 'px-4')}>
        {typeof children === 'string' ? (
            <>
                <span className={'mr-2'}>{children}</span>
                <ChevronDownIcon aria-hidden={'true'} data-animated={animate.toString()} />
            </>
        ) : (
            children
        )}
    </Menu.Button>
);
</file>

<file path="resources/scripts/components/elements/dropdown/DropdownItem.tsx">
import React, { forwardRef } from 'react';
import { Menu } from '@headlessui/react';
import styles from './style.module.css';
import classNames from 'classnames';

interface Props {
    children: React.ReactNode | ((opts: { active: boolean; disabled: boolean }) => JSX.Element);
    danger?: boolean;
    disabled?: boolean;
    className?: string;
    icon?: JSX.Element;
    onClick?: (e: React.MouseEvent) => void;
}

const DropdownItem = forwardRef<HTMLAnchorElement, Props>(
    ({ disabled, danger, className, onClick, children, icon: IconComponent }, ref) => {
        return (
            <Menu.Item disabled={disabled}>
                {({ disabled, active }) => (
                    <a
                        ref={ref}
                        href={'#'}
                        className={classNames(
                            styles.menu_item,
                            {
                                [styles.danger]: danger,
                                [styles.disabled]: disabled,
                            },
                            className
                        )}
                        onClick={onClick}
                    >
                        {IconComponent}
                        {typeof children === 'function' ? children({ disabled, active }) : children}
                    </a>
                )}
            </Menu.Item>
        );
    }
);

export default DropdownItem;
</file>

<file path="resources/scripts/components/elements/dropdown/index.ts">
export { default as Dropdown } from './Dropdown';
export * as styles from './style.module.css';
</file>

<file path="resources/scripts/components/elements/dropdown/style.module.css">
.menu {
    @apply relative inline-block text-left;

    & .button {
        @apply inline-flex justify-center items-center w-full py-2 text-neutral-100 rounded-md;
        @apply transition-all duration-100;

        &:hover,
        &[aria-expanded='true'] {
            @apply bg-neutral-600 text-white;
        }

        &:focus,
        &:focus-within,
        &:active {
            @apply ring-2 ring-opacity-50 ring-neutral-300 text-white;
        }

        & svg {
            @apply w-5 h-5 transition-transform duration-75;
        }

        &[aria-expanded='true'] svg[data-animated='true'] {
            @apply rotate-180;
        }
    }

    & .items_container {
        @apply absolute right-0 mt-2 origin-top-right bg-neutral-900 rounded z-10;
    }
}

.menu_item {
    @apply flex items-center rounded w-full px-2 py-2;

    & svg {
        @apply w-4 h-4 mr-4 text-neutral-300;
    }

    &:hover,
    &:focus {
        @apply bg-blue-500 text-blue-50;

        & svg {
            @apply text-blue-50;
        }
    }

    &.danger {
        &:hover,
        &:focus {
            @apply bg-red-500 text-red-50;

            & svg {
                @apply text-red-50;
            }
        }
    }

    &.disabled {
        @apply cursor-not-allowed hover:bg-neutral-800 opacity-30 focus:bg-transparent focus:hover:bg-neutral-800;
    }
}
</file>

<file path="resources/scripts/components/elements/inputs/Checkbox.tsx">
import React, { forwardRef } from 'react';
import classNames from 'classnames';
import styles from './styles.module.css';

type Props = Omit<React.ComponentProps<'input'>, 'type'>;

export default forwardRef<HTMLInputElement, Props>(({ className, ...props }, ref) => (
    <input
        ref={ref}
        type={'checkbox'}
        className={classNames('form-input', styles.checkbox_input, className)}
        {...props}
    />
));
</file>

<file path="resources/scripts/components/elements/inputs/index.ts">
import Checkbox from '@/components/elements/inputs/Checkbox';
import InputField from '@/components/elements/inputs/InputField';

const Input = Object.assign(
    {},
    {
        Text: InputField,
        Checkbox: Checkbox,
    }
);

export { Input };
export { default as styles } from './styles.module.css';
</file>

<file path="resources/scripts/components/elements/inputs/InputField.tsx">
import React, { forwardRef } from 'react';
import classNames from 'classnames';
import styles from './styles.module.css';

enum Variant {
    Normal,
    Snug,
    Loose,
}

interface InputFieldProps extends React.ComponentProps<'input'> {
    variant?: Variant;
}

const Component = forwardRef<HTMLInputElement, InputFieldProps>(({ className, variant, ...props }, ref) => (
    <input
        ref={ref}
        className={classNames(
            'form-input',
            styles.text_input,
            { [styles.loose]: variant === Variant.Loose },
            className
        )}
        {...props}
    />
));

const InputField = Object.assign(Component, { Variants: Variant });

export default InputField;
</file>

<file path="resources/scripts/components/elements/inputs/styles.module.css">
.checkbox_input {
    @apply w-4 h-4 rounded-sm border-neutral-500 bg-neutral-600 text-primary-500;

    &:focus,
    &:active {
        @apply ring-2 ring-primary-500 ring-offset-2 ring-offset-neutral-700;
    }

    &.indeterminate:checked {
        @apply text-primary-500/50 border border-primary-500;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='white'%3E%3Cpath fill-rule='evenodd' d='M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z' clip-rule='evenodd' /%3E%3C/svg%3E");
    }
}

.text_input {
    @apply transition-shadow duration-75;
    @apply w-full bg-neutral-800 rounded px-4 py-2 outline-none border-0;

    &:focus,
    &:active {
        @apply ring-4 ring-blue-300 ring-opacity-75;
    }

    &.loose {
        @apply px-6 py-3;
    }
}
</file>

<file path="resources/scripts/components/elements/store/PurchaseBox.tsx">
import { Button } from '@/components/elements/button';
import React, { Dispatch, SetStateAction } from 'react';
import TitledGreyBox from '@/components/elements/TitledGreyBox';

interface BoxProps {
    type: string;
    icon: React.ReactElement;
    amount: number;
    suffix?: string;
    description: string;
    cost: number;

    setOpen: Dispatch<SetStateAction<boolean>>;
    setResource: Dispatch<SetStateAction<string>>;
}

export default (props: BoxProps) => (
    <TitledGreyBox title={'Purchase ' + props.type}>
        <div className={'flex flex-row justify-center items-center my-2'}>
            {props.icon}
            <Button.Success
                className={'ml-4'}
                onClick={() => {
                    props.setOpen(true);
                    props.setResource(props.type.toLowerCase());
                }}
            >
                +{props.amount}
                {props.suffix} {props.type}
            </Button.Success>
        </div>
        <p className={'mt-2 text-gray-500 text-xs flex justify-center'}>{props.description}</p>
        <p className={'mt-1 text-gray-500 text-xs flex justify-center'}>
            Cost per {props.amount}
            {props.suffix} {props.type}: {props.cost} credits
        </p>
    </TitledGreyBox>
);
</file>

<file path="resources/scripts/components/elements/store/ResourceBar.tsx">
import tw from 'twin.macro';
import classNames from 'classnames';
import * as Icon from 'react-feather';
import styled from 'styled-components/macro';
import { megabytesToHuman } from '@/helpers';
import React, { useState, useEffect } from 'react';
import Spinner from '@/components/elements/Spinner';
import ContentBox from '@/components/elements/ContentBox';
import Tooltip from '@/components/elements/tooltip/Tooltip';
import StoreContainer from '@/components/elements/StoreContainer';
import { getResources, Resources } from '@/api/store/getResources';

const Wrapper = styled.div`
    ${tw`text-2xl flex flex-row justify-center items-center`};
`;

interface RowProps {
    className?: string;
    titles?: boolean;
}

interface BoxProps {
    title: string;
    description: string;
    icon: React.ReactElement;
    amount: number;
    toHuman?: boolean;
    suffix?: string;
}

export default ({ className, titles }: RowProps) => {
    const [resources, setResources] = useState<Resources>();

    useEffect(() => {
        getResources().then((resources) => setResources(resources));
    }, []);

    if (!resources) return <Spinner size={'large'} centered />;

    const ResourceBox = (props: BoxProps) => (
        <ContentBox title={titles ? props.title : undefined}>
            <Tooltip content={props.description}>
                <Wrapper>
                    {props.icon}
                    <span className={'ml-2'}>{props.toHuman ? megabytesToHuman(props.amount) : props.amount}</span>
                    {props.suffix}
                </Wrapper>
            </Tooltip>
        </ContentBox>
    );

    return (
        <StoreContainer className={classNames(className, 'grid grid-cols-2 sm:grid-cols-7 gap-x-6 gap-y-2')}>
            <ResourceBox
                title={'Credits'}
                description={'The amount of credits you have available.'}
                icon={<Icon.DollarSign />}
                amount={resources.balance}
            />
            <ResourceBox
                title={'CPU'}
                description={'The amount of CPU (in %) you have available.'}
                icon={<Icon.Cpu />}
                amount={resources.cpu}
                suffix={'%'}
            />
            <ResourceBox
                title={'Memory'}
                description={'The amount of RAM (in MB/GB) you have available.'}
                icon={<Icon.PieChart />}
                amount={resources.memory}
                toHuman
            />
            <ResourceBox
                title={'Disk'}
                description={'The amount of storage (in MB/GB) you have available.'}
                icon={<Icon.HardDrive />}
                amount={resources.disk}
                toHuman
            />
            <ResourceBox
                title={'Slots'}
                description={'The amount of servers you are able to deploy.'}
                icon={<Icon.Server />}
                amount={resources.slots}
            />
            <ResourceBox
                title={'Ports'}
                description={'The amount of ports you can add to your servers.'}
                icon={<Icon.Share2 />}
                amount={resources.ports}
            />
            <ResourceBox
                title={'Backups'}
                description={'The amount of backup slots you can add to your servers.'}
                icon={<Icon.Archive />}
                amount={resources.backups}
            />
            <ResourceBox
                title={'Databases'}
                description={'The amount of database slots you can add to your servers.'}
                icon={<Icon.Database />}
                amount={resources.databases}
            />
        </StoreContainer>
    );
};
</file>

<file path="resources/scripts/components/elements/store/StoreBanner.tsx">
import React from 'react';
import classNames from 'classnames';
import { Link } from 'react-router-dom';
import { Button } from '@/components/elements/button';

interface BannerProps {
    className: string;
    title: string;
    action: string;
    link: string;
}

export default (props: BannerProps) => {
    return (
        <div
            className={classNames(props.className, 'w-full bg-auto bg-center rounded-tr-xl rounded-bl-xl bg-gray-800')}
        >
            <div className={'bg-gray-900 bg-opacity-75 text-center rounded-lg p-2 m-2 lg:mt-[40rem]'}>
                <p className={'text-3xl text-gray-200'}>{props.title}</p>
                <Link to={`/store/${props.link}`}>
                    <Button className={'my-2 w-full lg:w-1/2'}>{props.action}</Button>
                </Link>
            </div>
        </div>
    );
};
</file>

<file path="resources/scripts/components/elements/store/StoreError.tsx">
import React from 'react';
import { Alert } from '@/components/elements/alert';
import PageContentBlock from '@/components/elements/PageContentBlock';

interface ErrorProps {
    message: string;
    admin: string;
}

export default ({ message, admin }: ErrorProps) => (
    <PageContentBlock>
        <Alert type={'danger'}>{message}</Alert>
        <Alert type={'warning'} className={'mt-2'}>
            (Admin Message) {admin}
        </Alert>
    </PageContentBlock>
);
</file>

<file path="resources/scripts/components/elements/table/PaginationFooter.tsx">
import React from 'react';
import { PaginationDataSet } from '@/api/http';
import classNames from 'classnames';
import { Button } from '@/components/elements/button/index';
import { ChevronDoubleLeftIcon, ChevronDoubleRightIcon } from '@heroicons/react/solid';

interface Props {
    className?: string;
    pagination: PaginationDataSet;
    onPageSelect: (page: number) => void;
}

const PaginationFooter = ({ pagination, className, onPageSelect }: Props) => {
    const start = (pagination.currentPage - 1) * pagination.perPage;
    const end = (pagination.currentPage - 1) * pagination.perPage + pagination.count;

    const { currentPage: current, totalPages: total } = pagination;

    const pages = { previous: [] as number[], next: [] as number[] };
    for (let i = 1; i <= 2; i++) {
        if (current - i >= 1) {
            pages.previous.push(current - i);
        }
        if (current + i <= total) {
            pages.next.push(current + i);
        }
    }

    if (pagination.total === 0) {
        return null;
    }

    const buttonProps = (page: number) => ({
        size: Button.Sizes.Small,
        shape: Button.Shapes.IconSquare,
        variant: Button.Variants.Secondary,
        onClick: () => onPageSelect(page),
    });

    return (
        <div className={classNames('flex items-center justify-between my-2', className)}>
            <p className={'text-sm text-neutral-500'}>
                Showing&nbsp;
                <span className={'font-semibold text-neutral-400'}>
                    {Math.max(start, Math.min(pagination.total, 1))}
                </span>
                &nbsp;to&nbsp;
                <span className={'font-semibold text-neutral-400'}>{end}</span> of&nbsp;
                <span className={'font-semibold text-neutral-400'}>{pagination.total}</span> results.
            </p>
            {pagination.totalPages > 1 && (
                <div className={'flex space-x-1'}>
                    <Button.Text {...buttonProps(1)} disabled={pages.previous.length !== 2}>
                        <ChevronDoubleLeftIcon className={'w-3 h-3'} />
                    </Button.Text>
                    {pages.previous.reverse().map((value) => (
                        <Button.Text key={`previous-${value}`} {...buttonProps(value)}>
                            {value}
                        </Button.Text>
                    ))}
                    <Button size={Button.Sizes.Small} shape={Button.Shapes.IconSquare}>
                        {current}
                    </Button>
                    {pages.next.map((value) => (
                        <Button.Text key={`next-${value}`} {...buttonProps(value)}>
                            {value}
                        </Button.Text>
                    ))}
                    <Button.Text {...buttonProps(total)} disabled={pages.next.length !== 2}>
                        <ChevronDoubleRightIcon className={'w-3 h-3'} />
                    </Button.Text>
                </div>
            )}
        </div>
    );
};

export default PaginationFooter;
</file>

<file path="resources/scripts/components/elements/tooltip/Tooltip.tsx">
import React, { cloneElement, useRef, useState } from 'react';
import {
    arrow,
    autoUpdate,
    flip,
    offset,
    Placement,
    shift,
    Side,
    useClick,
    useDismiss,
    useFloating,
    useFocus,
    useHover,
    useInteractions,
    useRole,
} from '@floating-ui/react-dom-interactions';
import { AnimatePresence, motion } from 'framer-motion';
import classNames from 'classnames';

type Interaction = 'hover' | 'click' | 'focus';

interface Props {
    rest?: number;
    delay?: number | Partial<{ open: number; close: number }>;
    content: string | React.ReactChild;
    disabled?: boolean;
    arrow?: boolean;
    interactions?: Interaction[];
    placement?: Placement;
    className?: string;
    children: React.ReactElement;
}

const arrowSides: Record<Side, string> = {
    top: 'bottom-[-6px] left-0',
    bottom: 'top-[-6px] left-0',
    right: 'top-0 left-[-6px]',
    left: 'top-0 right-[-6px]',
};

export default ({ children, ...props }: Props) => {
    const arrowEl = useRef<HTMLDivElement>(null);
    const [open, setOpen] = useState(false);

    const { x, y, reference, floating, middlewareData, strategy, context } = useFloating({
        open,
        strategy: 'fixed',
        placement: props.placement || 'top',
        middleware: [
            offset(props.arrow ? 10 : 6),
            flip(),
            shift({ padding: 6 }),
            arrow({ element: arrowEl, padding: 6 }),
        ],
        onOpenChange: setOpen,
        whileElementsMounted: autoUpdate,
    });

    const interactions = props.interactions || ['hover', 'focus'];
    const { getReferenceProps, getFloatingProps } = useInteractions([
        useHover(context, {
            restMs: props.rest ?? 30,
            delay: props.delay ?? 0,
            enabled: interactions.includes('hover'),
        }),
        useFocus(context, { enabled: interactions.includes('focus') }),
        useClick(context, { enabled: interactions.includes('click') }),
        useRole(context, { role: 'tooltip' }),
        useDismiss(context),
    ]);

    const side = arrowSides[(props.placement || 'top').split('-')[0] as Side];
    const { x: ax, y: ay } = middlewareData.arrow || {};

    if (props.disabled) {
        return children;
    }

    return (
        <>
            {cloneElement(children, getReferenceProps({ ref: reference, ...children.props }))}
            <AnimatePresence>
                {open && (
                    <motion.div
                        initial={{ opacity: 0, scale: 0.85 }}
                        animate={{ opacity: 1, scale: 1 }}
                        exit={{ opacity: 0 }}
                        transition={{ type: 'spring', damping: 20, stiffness: 300, duration: 0.075 }}
                        {...getFloatingProps({
                            ref: floating,
                            className:
                                'bg-gray-900 text-sm text-gray-200 px-3 py-2 rounded pointer-events-none max-w-[24rem]',
                            style: {
                                position: strategy,
                                top: `${y || 0}px`,
                                left: `${x || 0}px`,
                            },
                        })}
                    >
                        {props.content}
                        {props.arrow && (
                            <div
                                ref={arrowEl}
                                style={{
                                    transform: `translate(${Math.round(ax || 0)}px, ${Math.round(
                                        ay || 0
                                    )}px) rotate(45deg)`,
                                }}
                                className={classNames('absolute bg-gray-900 w-3 h-3', side)}
                            />
                        )}
                    </motion.div>
                )}
            </AnimatePresence>
        </>
    );
};
</file>

<file path="resources/scripts/components/elements/transitions/FadeTransition.tsx">
import React from 'react';
import { Transition } from '@headlessui/react';

type Duration = `duration-${number}`;

interface Props {
    as?: React.ElementType;
    duration?: Duration | [Duration, Duration];
    show: boolean;
    children: React.ReactNode;
}

export default ({ children, duration, ...props }: Props) => {
    const [enterDuration, exitDuration] = Array.isArray(duration)
        ? duration
        : !duration
        ? ['duration-200', 'duration-100']
        : [duration, duration];

    return (
        <Transition
            {...props}
            enter={`ease-out ${enterDuration}`}
            enterFrom={'opacity-0'}
            enterTo={'opacity-100'}
            leave={`ease-in ${exitDuration}`}
            leaveFrom={'opacity-100'}
            leaveTo={'opacity-0'}
        >
            {children}
        </Transition>
    );
};
</file>

<file path="resources/scripts/components/elements/transitions/index.ts">
import { Transition as TransitionComponent } from '@headlessui/react';
import FadeTransition from '@/components/elements/transitions/FadeTransition';

const Transition = Object.assign(TransitionComponent, {
    Fade: FadeTransition,
});

export { Transition };
</file>

<file path="resources/scripts/components/elements/AuthenticatedRoute.tsx">
import React from 'react';
import { Redirect, Route, RouteProps } from 'react-router';
import { useStoreState } from '@/state/hooks';

export default ({ children, ...props }: Omit<RouteProps, 'render'>) => {
    const isAuthenticated = useStoreState((state) => !!state.user.data?.uuid);

    return (
        <Route
            {...props}
            render={({ location }) =>
                isAuthenticated ? children : <Redirect to={{ pathname: '/auth/login', state: { from: location } }} />
            }
        />
    );
};
</file>

<file path="resources/scripts/components/elements/Button.tsx">
import React from 'react';
import styled, { css } from 'styled-components/macro';
import tw from 'twin.macro';
import Spinner from '@/components/elements/Spinner';

interface Props {
    isLoading?: boolean;
    size?: 'xsmall' | 'small' | 'large' | 'xlarge';
    color?: 'green' | 'red' | 'primary' | 'grey';
    isSecondary?: boolean;
}

const ButtonStyle = styled.button<Omit<Props, 'isLoading'>>`
    ${tw`relative inline-block p-2 uppercase tracking-wide text-sm transition-all duration-150 border-2`};
    border-radius: 24px;

    ${(props) =>
        ((!props.isSecondary && !props.color) || props.color === 'primary') &&
        css<Props>`
            ${(props) => !props.isSecondary && tw`bg-red-600 border-red-600 text-red-50`};

            &:hover:not(:disabled) {
                ${tw`bg-red-500 border-red-500`};
            }
        `};

    ${(props) =>
        props.color === 'grey' &&
        css`
            ${tw`border-neutral-600 bg-neutral-500 text-neutral-50`};

            &:hover:not(:disabled) {
                ${tw`bg-neutral-600 border-neutral-700`};
            }
        `};

    ${(props) =>
        props.color === 'green' &&
        css<Props>`
            ${tw`border-green-600 bg-green-500 text-green-50`};

            &:hover:not(:disabled) {
                ${tw`bg-green-600 border-green-700`};
            }

            ${(props) =>
                props.isSecondary &&
                css`
                    &:active:not(:disabled) {
                        ${tw`bg-green-600 border-green-700`};
                    }
                `};
        `};

    ${(props) =>
        props.color === 'red' &&
        css<Props>`
            ${tw`border-red-600 bg-red-500 text-red-50`};

            &:hover:not(:disabled) {
                ${tw`bg-red-600 border-red-700`};
            }

            ${(props) =>
                props.isSecondary &&
                css`
                    &:active:not(:disabled) {
                        ${tw`bg-red-600 border-red-700`};
                    }
                `};
        `};

    ${(props) => props.size === 'xsmall' && tw`px-2 py-1 text-xs`};
    ${(props) => (!props.size || props.size === 'small') && tw`px-4 py-2`};
    ${(props) => props.size === 'large' && tw`p-4 text-sm`};
    ${(props) => props.size === 'xlarge' && tw`p-4 w-full`};

    ${(props) =>
        props.isSecondary &&
        css<Props>`
            ${tw`border-neutral-600 bg-transparent text-neutral-200`};

            &:hover:not(:disabled) {
                ${tw`border-neutral-500 text-neutral-100`};
                ${(props) => props.color === 'red' && tw`bg-red-500 border-red-600 text-red-50`};
                ${(props) => props.color === 'primary' && tw`bg-red-500 border-red-600 text-red-50`};
                ${(props) => props.color === 'green' && tw`bg-green-500 border-green-600 text-green-50`};
            }
        `};

    &:disabled {
        opacity: 0.55;
        cursor: default;
    }
`;

type ComponentProps = Omit<JSX.IntrinsicElements['button'], 'ref' | keyof Props> & Props;

const Button: React.FC<ComponentProps> = ({ children, isLoading, ...props }) => (
    <ButtonStyle {...props}>
        {isLoading && (
            <div css={tw`flex absolute justify-center items-center w-full h-full left-0 top-0`}>
                <Spinner size={'small'} />
            </div>
        )}
        <span css={isLoading ? tw`text-transparent` : undefined}>{children}</span>
    </ButtonStyle>
);

type LinkProps = Omit<JSX.IntrinsicElements['a'], 'ref' | keyof Props> & Props;

const LinkButton: React.FC<LinkProps> = (props) => <ButtonStyle as={'a'} {...props} />;

export { LinkButton, ButtonStyle };
export default Button;
</file>

<file path="resources/scripts/components/elements/Can.tsx">
import React, { memo } from 'react';
import isEqual from 'react-fast-compare';
import { usePermissions } from '@/plugins/usePermissions';

interface Props {
    action: string | string[];
    matchAny?: boolean;
    renderOnError?: React.ReactNode | null;
    children: React.ReactNode;
}

const Can = ({ action, matchAny = false, renderOnError, children }: Props) => {
    const can = usePermissions(action);

    return (
        <>
            {(matchAny && can.filter((p) => p).length > 0) || (!matchAny && can.every((p) => p))
                ? children
                : renderOnError}
        </>
    );
};

export default memo(Can, isEqual);
</file>

<file path="resources/scripts/components/elements/Checkbox.tsx">
import React from 'react';
import { Field, FieldProps } from 'formik';
import Input from '@/components/elements/Input';

interface Props {
    name: string;
    value: string;
    className?: string;
}

type OmitFields = 'ref' | 'name' | 'value' | 'type' | 'checked' | 'onClick' | 'onChange';

type InputProps = Omit<JSX.IntrinsicElements['input'], OmitFields>;

const Checkbox = ({ name, value, className, ...props }: Props & InputProps) => (
    <Field name={name}>
        {({ field, form }: FieldProps) => {
            if (!Array.isArray(field.value)) {
                console.error('Attempting to mount a checkbox using a field value that is not an array.');

                return null;
            }

            return (
                <Input
                    {...field}
                    {...props}
                    className={className}
                    type={'checkbox'}
                    checked={(field.value || []).includes(value)}
                    onClick={() => form.setFieldTouched(field.name, true)}
                    onChange={(e) => {
                        const set = new Set(field.value);
                        set.has(value) ? set.delete(value) : set.add(value);

                        field.onChange(e);
                        form.setFieldValue(field.name, Array.from(set));
                    }}
                />
            );
        }}
    </Field>
);

export default Checkbox;
</file>

<file path="resources/scripts/components/elements/Code.tsx">
import React from 'react';
import classNames from 'classnames';

interface CodeProps {
    dark?: boolean | undefined;
    className?: string;
    children: React.ReactChild | React.ReactFragment | React.ReactPortal;
}

export default ({ dark, className, children }: CodeProps) => (
    <code
        className={classNames('font-mono text-sm px-2 py-1 inline-block rounded', className, {
            'bg-neutral-700': !dark,
            'bg-neutral-900 text-gray-100': dark,
        })}
    >
        {children}
    </code>
);
</file>

<file path="resources/scripts/components/elements/CodemirrorEditor.tsx">
import tw from 'twin.macro';
import modes from '@/modes';
import CodeMirror from 'codemirror';
import styled from 'styled-components/macro';
import React, { useCallback, useEffect, useState } from 'react';

require('codemirror/addon/mode/simple');
require('codemirror/lib/codemirror.css');
require('codemirror/addon/edit/closetag');
require('codemirror/addon/fold/foldcode');
require('codemirror/addon/fold/xml-fold');
require('codemirror/addon/hint/css-hint');
require('codemirror/addon/hint/sql-hint');
require('codemirror/addon/hint/xml-hint');
require('codemirror/addon/dialog/dialog');
require('codemirror/addon/search/search');
require('codemirror/theme/ayu-mirage.css');
require('codemirror/addon/edit/matchtags');
require('codemirror/addon/hint/html-hint');
require('codemirror/addon/hint/show-hint');
require('codemirror/addon/fold/foldgutter');
require('codemirror/addon/fold/brace-fold');
require('codemirror/addon/fold/indent-fold');
require('codemirror/addon/fold/comment-fold');
require('codemirror/addon/dialog/dialog.css');
require('codemirror/addon/edit/closebrackets');
require('codemirror/addon/edit/matchbrackets');
require('codemirror/addon/edit/trailingspace');
require('codemirror/addon/fold/markdown-fold');
require('codemirror/addon/hint/show-hint.css');
require('codemirror/addon/fold/foldgutter.css');
require('codemirror/addon/search/jump-to-line');
require('codemirror/addon/search/searchcursor');
require('codemirror/addon/hint/javascript-hint');
require('codemirror/addon/scroll/scrollpastend');
require('codemirror/addon/scroll/simplescrollbars');
require('codemirror/addon/scroll/annotatescrollbar');
require('codemirror/addon/search/match-highlighter');
require('codemirror/addon/search/matchesonscrollbar');
require('codemirror/addon/scroll/simplescrollbars.css');
require('codemirror/addon/search/matchesonscrollbar.css');

require('codemirror/mode/go/go');
require('codemirror/mode/css/css');
require('codemirror/mode/gfm/gfm');
require('codemirror/mode/jsx/jsx');
require('codemirror/mode/lua/lua');
require('codemirror/mode/php/php');
require('codemirror/mode/pug/pug');
require('codemirror/mode/rpm/rpm');
require('codemirror/mode/sql/sql');
require('codemirror/mode/vue/vue');
require('codemirror/mode/xml/xml');
require('codemirror/mode/dart/dart');
require('codemirror/mode/diff/diff');
require('codemirror/mode/http/http');
require('codemirror/mode/perl/perl');
require('codemirror/mode/ruby/ruby');
require('codemirror/mode/rust/rust');
require('codemirror/mode/sass/sass');
require('codemirror/mode/toml/toml');
require('codemirror/mode/twig/twig');
require('codemirror/mode/yaml/yaml');
require('codemirror/mode/clike/clike');
require('codemirror/mode/julia/julia');
require('codemirror/mode/nginx/nginx');
require('codemirror/mode/shell/shell');
require('codemirror/mode/swift/swift');
require('codemirror/mode/erlang/erlang');
require('codemirror/mode/python/python');
require('codemirror/mode/smarty/smarty');
require('codemirror/mode/markdown/markdown');
require('codemirror/mode/protobuf/protobuf');
require('codemirror/mode/brainfuck/brainfuck');
require('codemirror/mode/htmlmixed/htmlmixed');
require('codemirror/mode/dockerfile/dockerfile');
require('codemirror/mode/handlebars/handlebars');
require('codemirror/mode/javascript/javascript');
require('codemirror/mode/properties/properties');
require('codemirror/mode/htmlembedded/htmlembedded');

const EditorContainer = styled.div`
    min-height: 16rem;
    height: calc(100vh - 20rem);
    ${tw`relative`};

    > div {
        ${tw`rounded h-full`};
    }

    .CodeMirror {
        font-size: 12px;
        line-height: 1.375rem;
    }

    .CodeMirror-linenumber {
        padding: 1px 12px 0 12px !important;
    }

    .CodeMirror-foldmarker {
        color: #cbccc6;
        text-shadow: none;
        margin-left: 0.25rem;
        margin-right: 0.25rem;
    }
`;

export interface Props {
    style?: React.CSSProperties;
    initialContent?: string;
    mode: string;
    filename?: string;
    onModeChanged: (mode: string) => void;
    fetchContent: (callback: () => Promise<string>) => void;
    onContentSaved: () => void;
}

const findModeByFilename = (filename: string) => {
    for (let i = 0; i < modes.length; i++) {
        const info = modes[i];

        if (info.file && info.file.test(filename)) {
            return info;
        }
    }

    const dot = filename.lastIndexOf('.');
    const ext = dot > -1 && filename.substring(dot + 1, filename.length);

    if (ext) {
        for (let i = 0; i < modes.length; i++) {
            const info = modes[i];
            if (info.ext) {
                for (let j = 0; j < info.ext.length; j++) {
                    if (info.ext[j] === ext) {
                        return info;
                    }
                }
            }
        }
    }

    return undefined;
};

export default ({ style, initialContent, filename, mode, fetchContent, onContentSaved, onModeChanged }: Props) => {
    const [editor, setEditor] = useState<CodeMirror.Editor>();

    const ref = useCallback((node) => {
        if (!node) return;

        const e = CodeMirror.fromTextArea(node, {
            mode: 'text/plain',
            theme: 'ayu-mirage',
            indentUnit: 4,
            smartIndent: true,
            tabSize: 4,
            indentWithTabs: false,
            lineWrapping: true,
            lineNumbers: true,
            foldGutter: true,
            fixedGutter: true,
            scrollbarStyle: 'overlay',
            coverGutterNextToScrollbar: false,
            readOnly: false,
            showCursorWhenSelecting: false,
            autofocus: false,
            spellcheck: true,
            autocorrect: false,
            autocapitalize: false,
            lint: false,
            // @ts-expect-error this property is actually used, the d.ts file for CodeMirror is incorrect.
            autoCloseBrackets: true,
            matchBrackets: true,
            gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
        });

        setEditor(e);
    }, []);

    useEffect(() => {
        if (filename === undefined) {
            return;
        }

        onModeChanged(findModeByFilename(filename)?.mime || 'text/plain');
    }, [filename]);

    useEffect(() => {
        editor && editor.setOption('mode', mode);
    }, [editor, mode]);

    useEffect(() => {
        editor && editor.setValue(initialContent || '');
    }, [editor, initialContent]);

    useEffect(() => {
        if (!editor) {
            fetchContent(() => Promise.reject(new Error('no editor session has been configured')));
            return;
        }

        editor.addKeyMap({
            'Ctrl-S': () => onContentSaved(),
            'Cmd-S': () => onContentSaved(),
        });

        fetchContent(() => Promise.resolve(editor.getValue()));
    }, [editor, fetchContent, onContentSaved]);

    return (
        <EditorContainer style={style}>
            <textarea ref={ref} />
        </EditorContainer>
    );
};
</file>

<file path="resources/scripts/components/elements/ConfirmationModal.tsx">
import React, { useContext } from 'react';
import tw from 'twin.macro';
import Button from '@/components/elements/Button';
import asModal from '@/hoc/asModal';
import ModalContext from '@/context/ModalContext';

type Props = {
    title: string;
    buttonText: string;
    onConfirmed: () => void;
    showSpinnerOverlay?: boolean;
};

const ConfirmationModal: React.FC<Props> = ({ title, children, buttonText, onConfirmed }) => {
    const { dismiss } = useContext(ModalContext);

    return (
        <>
            <h2 css={tw`text-2xl mb-6`}>{title}</h2>
            <div css={tw`text-neutral-300`}>{children}</div>
            <div css={tw`flex flex-wrap items-center justify-end mt-8`}>
                <Button isSecondary onClick={() => dismiss()} css={tw`w-full sm:w-auto border-transparent`}>
                    Cancel
                </Button>
                <Button color={'red'} css={tw`w-full sm:w-auto mt-4 sm:mt-0 sm:ml-4`} onClick={() => onConfirmed()}>
                    {buttonText}
                </Button>
            </div>
        </>
    );
};

ConfirmationModal.displayName = 'ConfirmationModal';

export default asModal<Props>((props) => ({
    showSpinnerOverlay: props.showSpinnerOverlay,
}))(ConfirmationModal);
</file>

<file path="resources/scripts/components/elements/ContentBox.tsx">
import React from 'react';
import tw from 'twin.macro';
import FlashMessageRender from '@/components/FlashMessageRender';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';

type Props = Readonly<
    React.DetailedHTMLProps<React.HTMLAttributes<HTMLDivElement>, HTMLDivElement> & {
        title?: string;
        borderColor?: string;
        showFlashes?: string | boolean;
        showLoadingOverlay?: boolean;
        isLight?: boolean;
    }
>;

const ContentBox = ({ title, borderColor, showFlashes, showLoadingOverlay, children, isLight, ...props }: Props) => (
    <div {...props}>
        {title && <h2 css={tw`text-neutral-300 mb-4 px-4 text-2xl`}>{title}</h2>}
        {showFlashes && (
            <FlashMessageRender byKey={typeof showFlashes === 'string' ? showFlashes : undefined} css={tw`mb-4`} />
        )}
        <div
            css={[
                tw`p-4 rounded shadow-lg relative`,
                !!borderColor && tw`border-t-4`,
                isLight ? tw`bg-neutral-700` : tw`bg-neutral-800`,
            ]}
        >
            <SpinnerOverlay visible={showLoadingOverlay || false} />
            {children}
        </div>
    </div>
);

export default ContentBox;
</file>

<file path="resources/scripts/components/elements/ContentContainer.tsx">
import tw from 'twin.macro';
import { breakpoint } from '@/theme';
import styled from 'styled-components/macro';

const ContentContainer = styled.div`
    ${tw`mx-4`};

    ${breakpoint('xl')`
        ${tw`ml-36 mr-16`};
    `};
`;

ContentContainer.displayName = 'ContentContainer';

export default ContentContainer;
</file>

<file path="resources/scripts/components/elements/CopyOnClick.tsx">
import copy from 'copy-to-clipboard';
import classNames from 'classnames';
import Fade from '@/components/elements/Fade';
import Portal from '@/components/elements/Portal';
import React, { useEffect, useState } from 'react';

interface CopyOnClickProps {
    text: string | number | null | undefined;
    showInNotification?: boolean;
    children: React.ReactNode;
}

const CopyOnClick = ({ text, showInNotification = true, children }: CopyOnClickProps) => {
    const [copied, setCopied] = useState(false);

    useEffect(() => {
        if (!copied) return;

        const timeout = setTimeout(() => {
            setCopied(false);
        }, 2500);

        return () => {
            clearTimeout(timeout);
        };
    }, [copied]);

    if (!React.isValidElement(children)) {
        throw new Error('Component passed to <CopyOnClick/> must be a valid React element.');
    }

    const child = !text
        ? React.Children.only(children)
        : React.cloneElement(React.Children.only(children), {
              className: classNames(children.props.className || '', 'cursor-pointer'),
              onClick: (e: React.MouseEvent<HTMLElement>) => {
                  copy(String(text));
                  setCopied(true);
                  if (typeof children.props.onClick === 'function') {
                      children.props.onClick(e);
                  }
              },
          });

    return (
        <>
            {copied && (
                <Portal>
                    <Fade in appear timeout={250} key={copied ? 'visible' : 'invisible'}>
                        <div className={'fixed z-50 bottom-0 right-0 m-4'}>
                            <div className={'rounded-md py-3 px-4 text-gray-200 bg-neutral-600/95 shadow'}>
                                <p>
                                    {showInNotification
                                        ? `Copied "${String(text)}" to clipboard.`
                                        : 'Copied text to clipboard.'}
                                </p>
                            </div>
                        </div>
                    </Fade>
                </Portal>
            )}
            {child}
        </>
    );
};

export default CopyOnClick;
</file>

<file path="resources/scripts/components/elements/DropdownMenu.tsx">
import tw from 'twin.macro';
import React, { createRef } from 'react';
import styled from 'styled-components/macro';
import Fade from '@/components/elements/Fade';

interface Props {
    children: React.ReactNode;
    renderToggle: (onClick: (e: React.MouseEvent<any, MouseEvent>) => void) => React.ReactChild;
}

export const DropdownButtonRow = styled.button<{ danger?: boolean }>`
    ${tw`p-2 flex items-center rounded w-full text-neutral-500`};
    transition: 150ms all ease;

    &:hover {
        ${(props) => (props.danger ? tw`text-red-700 bg-red-100` : tw`text-neutral-700 bg-neutral-100`)};
    }
`;

interface State {
    posX: number;
    visible: boolean;
}

class DropdownMenu extends React.PureComponent<Props, State> {
    menu = createRef<HTMLDivElement>();

    state: State = {
        posX: 0,
        visible: false,
    };

    componentWillUnmount() {
        this.removeListeners();
    }

    componentDidUpdate(prevProps: Readonly<Props>, prevState: Readonly<State>) {
        const menu = this.menu.current;

        if (this.state.visible && !prevState.visible && menu) {
            document.addEventListener('click', this.windowListener);
            document.addEventListener('contextmenu', this.contextMenuListener);
            menu.style.left = `${Math.round(this.state.posX - menu.clientWidth)}px`;
        }

        if (!this.state.visible && prevState.visible) {
            this.removeListeners();
        }
    }

    removeListeners = () => {
        document.removeEventListener('click', this.windowListener);
        document.removeEventListener('contextmenu', this.contextMenuListener);
    };

    onClickHandler = (e: React.MouseEvent<any, MouseEvent>) => {
        e.preventDefault();
        this.triggerMenu(e.clientX);
    };

    contextMenuListener = () => this.setState({ visible: false });

    windowListener = (e: MouseEvent) => {
        const menu = this.menu.current;

        if (e.button === 2 || !this.state.visible || !menu) {
            return;
        }

        if (e.target === menu || menu.contains(e.target as Node)) {
            return;
        }

        if (e.target !== menu && !menu.contains(e.target as Node)) {
            this.setState({ visible: false });
        }
    };

    triggerMenu = (posX: number) =>
        this.setState((s) => ({
            posX: !s.visible ? posX : s.posX,
            visible: !s.visible,
        }));

    render() {
        return (
            <div>
                {this.props.renderToggle(this.onClickHandler)}
                <Fade timeout={150} in={this.state.visible} unmountOnExit>
                    <div
                        ref={this.menu}
                        onClick={(e) => {
                            e.stopPropagation();
                            this.setState({ visible: false });
                        }}
                        style={{ width: '12rem' }}
                        css={tw`absolute bg-white p-2 rounded border border-neutral-700 shadow-lg text-neutral-500 z-50`}
                    >
                        {this.props.children}
                    </div>
                </Fade>
            </div>
        );
    }
}

export default DropdownMenu;
</file>

<file path="resources/scripts/components/elements/ErrorBoundary.tsx">
import React from 'react';
import tw from 'twin.macro';
import * as Icon from 'react-feather';

interface State {
    hasError: boolean;
}

// eslint-disable-next-line @typescript-eslint/ban-types
class ErrorBoundary extends React.Component<{}, State> {
    state: State = {
        hasError: false,
    };

    static getDerivedStateFromError() {
        return { hasError: true };
    }

    componentDidCatch(error: Error) {
        console.error(error);
    }

    render() {
        return this.state.hasError ? (
            <div css={tw`flex items-center justify-center w-full my-4`}>
                <div css={tw`flex items-center bg-neutral-900 rounded p-3 text-red-500`}>
                    <Icon.AlertTriangle css={tw`h-4 w-auto mr-2`} />
                    <p css={tw`text-sm text-neutral-100`}>An error was encountered while rendering this page.</p>
                </div>
            </div>
        ) : (
            this.props.children
        );
    }
}

export default ErrorBoundary;
</file>

<file path="resources/scripts/components/elements/Fade.tsx">
import React from 'react';
import tw from 'twin.macro';
import styled from 'styled-components/macro';
import CSSTransition, { CSSTransitionProps } from 'react-transition-group/CSSTransition';

interface Props extends Omit<CSSTransitionProps, 'timeout' | 'classNames'> {
    timeout: number;
}

const Container = styled.div<{ timeout: number }>`
    .fade-enter,
    .fade-exit,
    .fade-appear {
        will-change: opacity;
    }

    .fade-enter,
    .fade-appear {
        ${tw`opacity-0`};

        &.fade-enter-active,
        &.fade-appear-active {
            ${tw`opacity-100 transition-opacity ease-in`};
            transition-duration: ${(props) => props.timeout}ms;
        }
    }

    .fade-exit {
        ${tw`opacity-100`};

        &.fade-exit-active {
            ${tw`opacity-0 transition-opacity ease-in`};
            transition-duration: ${(props) => props.timeout}ms;
        }
    }
`;

const Fade: React.FC<Props> = ({ timeout, children, ...props }) => (
    <Container timeout={timeout}>
        <CSSTransition timeout={timeout} classNames={'fade'} {...props}>
            {children}
        </CSSTransition>
    </Container>
);
Fade.displayName = 'Fade';

export default Fade;
</file>

<file path="resources/scripts/components/elements/Field.tsx">
import React, { forwardRef } from 'react';
import Input from '@/components/elements/Input';
import Label from '@/components/elements/Label';
import { Field as FormikField, FieldProps } from 'formik';

interface OwnProps {
    name: string;
    light?: boolean;
    label?: string;
    description?: string;
    validate?: (value: any) => undefined | string | Promise<any>;
}

type Props = OwnProps & Omit<React.InputHTMLAttributes<HTMLInputElement>, 'name'>;

const Field = forwardRef<HTMLInputElement, Props>(
    ({ id, name, light = false, label, description, validate, ...props }, ref) => (
        <FormikField innerRef={ref} name={name} validate={validate}>
            {({ field, form: { errors, touched } }: FieldProps) => (
                <div>
                    {label && (
                        <Label htmlFor={id} isLight={light}>
                            {label}
                        </Label>
                    )}
                    <Input
                        id={id}
                        {...field}
                        {...props}
                        isLight={false}
                        hasError={!!(touched[field.name] && errors[field.name])}
                    />
                    {touched[field.name] && errors[field.name] ? (
                        <p className={'input-help error'}>
                            {(errors[field.name] as string).charAt(0).toUpperCase() +
                                (errors[field.name] as string).slice(1)}
                        </p>
                    ) : description ? (
                        <p className={'input-help'}>{description}</p>
                    ) : null}
                </div>
            )}
        </FormikField>
    )
);
Field.displayName = 'Field';

export default Field;
</file>

<file path="resources/scripts/components/elements/FormikFieldWrapper.tsx">
import React from 'react';
import { Field, FieldProps } from 'formik';
import Label from '@/components/elements/Label';
import InputError from '@/components/elements/InputError';

interface Props {
    id?: string;
    name: string;
    children: React.ReactNode;
    className?: string;
    label?: string;
    description?: string;
    validate?: (value: any) => undefined | string | Promise<any>;
}

const FormikFieldWrapper = ({ id, name, label, className, description, validate, children }: Props) => (
    <Field name={name} validate={validate}>
        {({ field, form: { errors, touched } }: FieldProps) => (
            <div className={`${className} ${touched[field.name] && errors[field.name] ? 'has-error' : undefined}`}>
                {label && <Label htmlFor={id}>{label}</Label>}
                {children}
                <InputError errors={errors} touched={touched} name={field.name}>
                    {description || null}
                </InputError>
            </div>
        )}
    </Field>
);

export default FormikFieldWrapper;
</file>

<file path="resources/scripts/components/elements/FormikSwitch.tsx">
import React from 'react';
import { Field, FieldProps } from 'formik';
import Switch, { SwitchProps } from '@/components/elements/Switch';
import FormikFieldWrapper from '@/components/elements/FormikFieldWrapper';

const FormikSwitch = ({ name, label, ...props }: SwitchProps) => {
    return (
        <FormikFieldWrapper name={name}>
            <Field name={name}>
                {({ field, form }: FieldProps) => (
                    <Switch
                        name={name}
                        label={label}
                        onChange={() => {
                            form.setFieldTouched(name);
                            form.setFieldValue(field.name, !field.value);
                        }}
                        defaultChecked={field.value}
                        {...props}
                    />
                )}
            </Field>
        </FormikFieldWrapper>
    );
};

export default FormikSwitch;
</file>

<file path="resources/scripts/components/elements/GreyRowBox.tsx">
import tw from 'twin.macro';
import styled from 'styled-components/macro';

export default styled.div<{ $hoverable?: boolean }>`
    ${tw`flex rounded no-underline text-neutral-200 items-center p-4 border border-transparent transition-colors duration-150 overflow-hidden`};
    background-color: rgba(38, 38, 38, 0.1);

    ${(props) => props.$hoverable !== false && tw`hover:border-neutral-700`};

    & .icon {
        ${tw`rounded-full w-16 flex items-center justify-center bg-neutral-500 p-3`};
    }
`;
</file>

<file path="resources/scripts/components/elements/Icon.tsx">
import React, { CSSProperties } from 'react';
import { IconDefinition } from '@fortawesome/fontawesome-svg-core';
import tw from 'twin.macro';

interface Props {
    icon: IconDefinition;
    className?: string;
    style?: CSSProperties;
}

const Icon = ({ icon, className, style }: Props) => {
    const [width, height, , , paths] = icon.icon;

    return (
        <svg
            xmlns={'http://www.w3.org/2000/svg'}
            viewBox={`0 0 ${width} ${height}`}
            css={tw`fill-current inline-block`}
            className={className}
            style={style}
        >
            {(Array.isArray(paths) ? paths : [paths]).map((path, index) => (
                <path key={`svg_path_${index}`} d={path} />
            ))}
        </svg>
    );
};

export default Icon;
</file>

<file path="resources/scripts/components/elements/InformationBox.tsx">
import React from 'react';
import { IconProp } from '@fortawesome/fontawesome-svg-core';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';

interface Props {
    icon: IconProp;
    iconCss?: string;
    children: React.ReactChild[] | React.ReactChild;
}

export default ({ children, icon, iconCss }: Props) => (
    <div className={'w-1/4 pointer-events-none bg-gray-700 p-2 my-2 rounded justify-between'}>
        <p className={'text-neutral-500 font-normal truncate'}>
            <FontAwesomeIcon icon={icon} className={'text-neutral-400 mr-2 ' + iconCss} />
            {children}
        </p>
    </div>
);
</file>

<file path="resources/scripts/components/elements/InformationContainer.tsx">
// import useFlash from '@/plugins/useFlash';
// import apiVerify from '@/api/account/verify';
// import { useStoreState } from '@/state/hooks';
// import React, { useEffect, useState } from 'react';
// import { formatDistanceToNowStrict } from 'date-fns';
// import { getResources } from '@/api/store/getResources';
// import Translate from '@/components/elements/Translate';
// import InformationBox from '@/components/elements/InformationBox';
// import getLatestActivity, { Activity } from '@/api/account/getLatestActivity';
// import { wrapProperties } from '@/components/elements/activity/ActivityLogEntry';
// import {
//     faCircle,
//     faCoins,
//     faExclamationCircle,
//     faScroll,
//     faTimesCircle,
//     faUserLock,
// } from '@fortawesome/free-solid-svg-icons';

// export default () => {
//     const { addFlash } = useFlash();
//     const [bal, setBal] = useState(0);
//     const [activity, setActivity] = useState<Activity>();
//     const properties = wrapProperties(activity?.properties);
//     const user = useStoreState((state) => state.user.data!);
//     const store = useStoreState((state) => state.storefront.data!);

//     useEffect(() => {
//         getResources().then((d) => setBal(d.balance));
//         getLatestActivity().then((d) => setActivity(d));
//     }, []);

//     const verify = () => {
//         apiVerify().then((data) => {
//             if (data.success)
//                 addFlash({ type: 'info', key: 'dashboard', message: 'Verification email has been resent.' });
//         });
//     };

//     return (
//         <>
//             {store.earn.enabled ? (
//                 <InformationBox icon={faCircle} iconCss={'animate-pulse'}>
//                     Earning <span className={'text-green-600'}>{store.earn.amount}</span> credits / min.
//                 </InformationBox>
//             ) : (
//                 <InformationBox icon={faExclamationCircle}>
//                     Credit earning is currently <span className={'text-red-600'}>disabled.</span>
//                 </InformationBox>
//             )}
//             <InformationBox icon={faCoins}>
//                 You have <span className={'text-green-600'}>{bal}</span> credits available.
//             </InformationBox>
//             <InformationBox icon={faUserLock}>
//                 {user.useTotp ? (
//                     <>
//                         <span className={'text-green-600'}>2FA is enabled</span> on your account.
//                     </>
//                 ) : (
//                     <>
//                         <span className={'text-yellow-600'}>Enable 2FA</span> to secure your account.
//                     </>
//                 )}
//             </InformationBox>
//             {!user.verified ? (
//                 <InformationBox icon={faTimesCircle} iconCss={'text-yellow-500'}>
//                     <span onClick={verify} className={'cursor-pointer text-blue-400'}>
//                         Verify your account to get started.
//                     </span>
//                 </InformationBox>
//             ) : (
//                 <InformationBox icon={faScroll}>
//                     {activity ? (
//                         <>
//                             <span className={'text-neutral-400'}>
//                                 <Translate
//                                     ns={'activity'}
//                                     values={properties}
//                                     i18nKey={activity.event.replace(':', '.')}
//                                 />
//                             </span>
//                             {' - '}
//                             {formatDistanceToNowStrict(activity.timestamp, { addSuffix: true })}
//                         </>
//                     ) : (
//                         'Unable to get latest activity logs.'
//                     )}
//                 </InformationBox>
//             )}
//         </>
//     );
// };
</file>

<file path="resources/scripts/components/elements/Input.tsx">
import tw from 'twin.macro';
import styled, { css } from 'styled-components/macro';

export interface Props {
    isLight?: boolean;
    hasError?: boolean;
}

const light = css<Props>`
    ${tw`bg-white border-neutral-200 text-neutral-800`};
    &:focus {
        ${tw`border-primary-400`}
    }

    &:disabled {
        ${tw`bg-neutral-100 border-neutral-200`};
    }
`;

const checkboxStyle = css<Props>`
    ${tw`bg-neutral-500 cursor-pointer appearance-none inline-block align-middle select-none flex-shrink-0 w-4 h-4 text-primary-400 border border-neutral-300 rounded-sm`};
    color-adjust: exact;
    background-origin: border-box;
    transition: all 75ms linear, box-shadow 25ms linear;

    &:checked {
        ${tw`border-transparent bg-no-repeat bg-center`};
        background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M5.707 7.293a1 1 0 0 0-1.414 1.414l2 2a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0-1.414-1.414L7 8.586 5.707 7.293z'/%3e%3c/svg%3e");
        background-color: currentColor;
        background-size: 100% 100%;
    }

    &:focus {
        ${tw`outline-none border-primary-300`};
        box-shadow: 0 0 0 1px rgba(9, 103, 210, 0.25);
    }
`;

const inputStyle = css<Props>`
    // Reset to normal styling.
    resize: none;
    ${tw`appearance-none outline-none w-full min-w-0`};
    ${tw`p-2.5 border-2 rounded text-sm transition-all duration-150`};
    ${tw`bg-neutral-800 border-neutral-700 hover:border-neutral-600 text-neutral-200 shadow-none focus:ring-0`};

    & + .input-help {
        ${tw`mt-1 text-xs`};
        ${(props) => (props.hasError ? tw`text-red-200` : tw`text-neutral-200`)};
    }

    &:required,
    &:invalid {
        ${tw`shadow-none`};
    }

    &:not(:disabled):not(:read-only):focus {
        ${tw`shadow-md border-primary-300 ring-2 ring-primary-400 ring-opacity-50`};
        ${(props) => props.hasError && tw`border-red-300 ring-red-200`};
    }

    &:disabled {
        ${tw`opacity-75`};
    }

    ${(props) => props.isLight && light};
    ${(props) => props.hasError && tw`text-red-100 border-red-400 hover:border-red-300`};
`;

const Input = styled.input<Props>`
    &:not([type='checkbox']):not([type='radio']) {
        ${inputStyle};
    }

    &[type='checkbox'],
    &[type='radio'] {
        ${checkboxStyle};

        &[type='radio'] {
            ${tw`rounded-full`};
        }
    }
`;
const Textarea = styled.textarea<Props>`
    ${inputStyle}
`;

export { Textarea };
export default Input;
</file>

<file path="resources/scripts/components/elements/InputError.tsx">
import React from 'react';
import tw from 'twin.macro';
import { capitalize } from '@/lib/strings';
import { FormikErrors, FormikTouched } from 'formik';

interface Props {
    errors: FormikErrors<any>;
    touched: FormikTouched<any>;
    name: string;
    children?: string | number | null | undefined;
}

const InputError = ({ errors, touched, name, children }: Props) =>
    touched[name] && errors[name] ? (
        <p css={tw`text-xs text-red-400 pt-2`}>
            {typeof errors[name] === 'string'
                ? capitalize(errors[name] as string)
                : capitalize((errors[name] as unknown as string[])[0])}
        </p>
    ) : (
        <>{children ? <p css={tw`text-xs text-neutral-400 pt-2`}>{children}</p> : null}</>
    );

export default InputError;
</file>

<file path="resources/scripts/components/elements/InputSpinner.tsx">
import React from 'react';
import tw from 'twin.macro';
import Fade from '@/components/elements/Fade';
import Select from '@/components/elements/Select';
import Spinner from '@/components/elements/Spinner';
import styled, { css } from 'styled-components/macro';

const Container = styled.div<{ visible?: boolean }>`
    ${tw`relative`};

    ${(props) =>
        props.visible &&
        css`
            & ${Select} {
                background-image: none;
            }
        `};
`;

const InputSpinner = ({ visible, children }: { visible: boolean; children: React.ReactNode }) => (
    <Container visible={visible}>
        <Fade appear unmountOnExit in={visible} timeout={150}>
            <div css={tw`absolute right-0 h-full flex items-center justify-end pr-3`}>
                <Spinner size={'small'} />
            </div>
        </Fade>
        {children}
    </Container>
);

export default InputSpinner;
</file>

<file path="resources/scripts/components/elements/Label.tsx">
import tw from 'twin.macro';
import styled from 'styled-components/macro';

const Label = styled.label<{ isLight?: boolean }>`
    ${tw`block text-sm font-medium text-neutral-200 font-semibold mb-1 sm:mb-2`};
    ${(props) => props.isLight && tw`text-gray-400`};
`;

export default Label;
</file>

<file path="resources/scripts/components/elements/MobileNavigation.tsx">
import http from '@/api/http';
import * as React from 'react';
import { useState } from 'react';
import * as Icon from 'react-feather';
import tw, { theme } from 'twin.macro';
import { useStoreState } from 'easy-peasy';
import { ApplicationStore } from '@/state';
import styled from 'styled-components/macro';
import { NavLink } from 'react-router-dom';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import SearchContainer from '@/components/dashboard/search/SearchContainer';

const Navigation = styled.div`
    ${tw`w-full bg-neutral-800 shadow-xl overflow-x-auto`};
    & > div {
        ${tw`mx-auto w-full flex items-center`};
    }
    & #logo {
        ${tw`flex-1`};

        & > a {
            ${tw`text-2xl px-4 no-underline text-neutral-200 hover:text-neutral-100 transition-colors duration-150`};
        }
    }
`;

const RightNavigation = styled.div`
    ${tw`flex h-full items-center justify-center`};

    & > a,
    & > button,
    & > .navigation-link {
        ${tw`flex items-center h-full no-underline text-neutral-300 px-4 cursor-pointer transition-all duration-150`};
        &:active,
        &:hover {
            ${tw`text-neutral-100 bg-black`};
        }
        &:active,
        &:hover,
        &.active {
            box-shadow: inset 0 -2px ${theme`colors.cyan.700`.toString()};
        }
    }
`;

export default () => {
    const [isLoggingOut, setIsLoggingOut] = useState(false);
    const tickets = useStoreState((state) => state.settings.data!.tickets);
    const store = useStoreState((state) => state.storefront.data!.enabled);
    const rootAdmin = useStoreState((state: ApplicationStore) => state.user.data!.rootAdmin);

    const onTriggerLogout = () => {
        setIsLoggingOut(true);
        http.post('/auth/logout').finally(() => {
            // @ts-expect-error this is valid
            window.location = '/';
        });
    };

    return (
        <Navigation>
            <SpinnerOverlay visible={isLoggingOut} />
            <div
                css={tw`mx-auto w-full flex justify-center items-center`}
                style={{ maxWidth: '1200px', height: '3rem' }}
            >
                <RightNavigation>
                    <SearchContainer size={20} />
                    <NavLink to={'/'} exact>
                        <Icon.Server size={20} />
                    </NavLink>
                    <NavLink to={'/account'}>
                        <Icon.User size={20} />
                    </NavLink>
                    {store && (
                        <NavLink to={'/store'}>
                            <Icon.ShoppingCart size={20} />
                        </NavLink>
                    )}
                    {tickets && (
                        <NavLink to={'/tickets'}>
                            <Icon.HelpCircle size={20} />
                        </NavLink>
                    )}
                    {rootAdmin && (
                        <a href={'/admin'} rel={'noreferrer'}>
                            <Icon.Settings size={20} />
                        </a>
                    )}
                    <button onClick={onTriggerLogout}>
                        <Icon.LogOut size={20} />
                    </button>
                </RightNavigation>
            </div>
        </Navigation>
    );
};
</file>

<file path="resources/scripts/components/elements/Modal.tsx">
import tw from 'twin.macro';
import { breakpoint } from '@/theme';
import { createPortal } from 'react-dom';
import Fade from '@/components/elements/Fade';
import Spinner from '@/components/elements/Spinner';
import styled, { css } from 'styled-components/macro';
import React, { useEffect, useMemo, useRef, useState } from 'react';

export interface RequiredModalProps {
    visible: boolean;
    onDismissed: () => void;
    appear?: boolean;
    top?: boolean;
}

export interface ModalProps extends RequiredModalProps {
    dismissable?: boolean;
    closeOnEscape?: boolean;
    closeOnBackground?: boolean;
    showSpinnerOverlay?: boolean;
}

export const ModalMask = styled.div`
    ${tw`fixed z-50 overflow-auto flex w-full inset-0`};
    background: rgba(0, 0, 0, 0.7);
`;

const ModalContainer = styled.div<{ alignTop?: boolean }>`
    max-width: 95%;
    max-height: calc(100vh - 8rem);
    ${breakpoint('md')`max-width: 75%`};
    ${breakpoint('lg')`max-width: 50%`};

    ${tw`relative flex flex-col w-full m-auto`};
    ${(props) =>
        props.alignTop &&
        css`
            margin-top: 20%;
            ${breakpoint('md')`margin-top: 10%`};
        `};

    margin-bottom: auto;

    & > .close-icon {
        ${tw`absolute right-0 p-2 text-white cursor-pointer opacity-50 transition-all duration-150 ease-linear hover:opacity-100`};
        top: -2.5rem;

        &:hover {
            ${tw`transform rotate-90`}
        }

        & > svg {
            ${tw`w-6 h-6`};
        }
    }
`;

const Modal: React.FC<ModalProps> = ({
    visible,
    appear,
    dismissable,
    showSpinnerOverlay,
    top = true,
    closeOnBackground = true,
    closeOnEscape = true,
    onDismissed,
    children,
}) => {
    const [render, setRender] = useState(visible);

    const isDismissable = useMemo(() => {
        return (dismissable || true) && !(showSpinnerOverlay || false);
    }, [dismissable, showSpinnerOverlay]);

    useEffect(() => {
        if (!isDismissable || !closeOnEscape) return;

        const handler = (e: KeyboardEvent) => {
            if (e.key === 'Escape') setRender(false);
        };

        window.addEventListener('keydown', handler);
        return () => {
            window.removeEventListener('keydown', handler);
        };
    }, [isDismissable, closeOnEscape, render]);

    useEffect(() => setRender(visible), [visible]);

    return (
        <Fade in={render} timeout={150} appear={appear || true} unmountOnExit onExited={() => onDismissed()}>
            <ModalMask
                onClick={(e) => e.stopPropagation()}
                onContextMenu={(e) => e.stopPropagation()}
                onMouseDown={(e) => {
                    if (isDismissable && closeOnBackground) {
                        e.stopPropagation();
                        if (e.target === e.currentTarget) {
                            setRender(false);
                        }
                    }
                }}
            >
                <ModalContainer alignTop={top}>
                    {isDismissable && (
                        <div className={'close-icon'} onClick={() => setRender(false)}>
                            <svg
                                xmlns={'http://www.w3.org/2000/svg'}
                                fill={'none'}
                                viewBox={'0 0 24 24'}
                                stroke={'currentColor'}
                            >
                                <path
                                    strokeLinecap={'round'}
                                    strokeLinejoin={'round'}
                                    strokeWidth={'2'}
                                    d={'M6 18L18 6M6 6l12 12'}
                                />
                            </svg>
                        </div>
                    )}
                    {showSpinnerOverlay && (
                        <Fade timeout={150} appear in>
                            <div
                                css={tw`absolute w-full h-full rounded flex items-center justify-center`}
                                style={{ background: 'hsla(211, 10%, 53%, 0.35)', zIndex: 9999 }}
                            >
                                <Spinner />
                            </div>
                        </Fade>
                    )}
                    <div
                        css={tw`bg-neutral-900 p-3 sm:p-4 md:p-6 rounded shadow-md overflow-y-scroll transition-all duration-150`}
                    >
                        {children}
                    </div>
                </ModalContainer>
            </ModalMask>
        </Fade>
    );
};

const PortaledModal: React.FC<ModalProps> = ({ children, ...props }) => {
    const element = useRef(document.getElementById('modal-portal'));

    return createPortal(<Modal {...props}>{children}</Modal>, element.current!);
};

export default PortaledModal;
</file>

<file path="resources/scripts/components/elements/Pagination.tsx">
import React from 'react';
import tw from 'twin.macro';
import * as Icon from 'react-feather';
import { PaginatedResult } from '@/api/http';
import styled from 'styled-components/macro';
import { Button } from '@/components/elements/button/index';

interface RenderFuncProps<T> {
    items: T[];
    isLastPage: boolean;
    isFirstPage: boolean;
}

interface Props<T> {
    data: PaginatedResult<T>;
    showGoToLast?: boolean;
    showGoToFirst?: boolean;
    onPageSelect: (page: number) => void;
    children: (props: RenderFuncProps<T>) => React.ReactNode;
}

const Block = styled(Button)`
    ${tw`p-0 w-10 h-10`}

    &:not(:last-of-type) {
        ${tw`mr-2`};
    }
`;

function Pagination<T>({ data: { items, pagination }, onPageSelect, children }: Props<T>) {
    const isFirstPage = pagination.currentPage === 1;
    const isLastPage = pagination.currentPage >= pagination.totalPages;

    const pages = [];

    // Start two spaces before the current page. If that puts us before the starting page default
    // to the first page as the starting point.
    const start = Math.max(pagination.currentPage - 2, 1);
    const end = Math.min(pagination.totalPages, pagination.currentPage + 5);

    for (let i = start; i <= end; i++) {
        pages.push(i);
    }

    return (
        <>
            {children({ items, isFirstPage, isLastPage })}
            {pages.length > 1 && (
                <div css={tw`mt-4 flex justify-center`}>
                    {pages[0] > 1 && !isFirstPage && (
                        <Block variant={Button.Variants.Secondary} color={'primary'} onClick={() => onPageSelect(1)}>
                            <Icon.ChevronLeft />
                        </Block>
                    )}
                    {pages.map((i) => (
                        <Block key={`block_page_${i}`} onClick={() => onPageSelect(i)}>
                            {i}
                        </Block>
                    ))}
                    {pages[4] < pagination.totalPages && !isLastPage && (
                        <Block
                            variant={Button.Variants.Secondary}
                            color={'primary'}
                            onClick={() => onPageSelect(pagination.totalPages)}
                        >
                            <Icon.ChevronRight />
                        </Block>
                    )}
                </div>
            )}
        </>
    );
}

export default Pagination;
</file>

<file path="resources/scripts/components/elements/PermissionRoute.tsx">
import React from 'react';
import { Route } from 'react-router-dom';
import { RouteProps } from 'react-router';
import Can from '@/components/elements/Can';
import { ServerError } from '@/components/elements/ScreenBlock';

interface Props extends Omit<RouteProps, 'path'> {
    path: string;
    permission: string | string[] | null;
}

export default ({ permission, children, ...props }: Props) => (
    <Route {...props}>
        {!permission ? (
            children
        ) : (
            <Can
                matchAny
                action={permission}
                renderOnError={
                    <ServerError title={'Access Denied'} message={'You do not have permission to access this page.'} />
                }
            >
                {children}
            </Can>
        )}
    </Route>
);
</file>

<file path="resources/scripts/components/elements/Portal.tsx">
import React, { useRef } from 'react';
import { createPortal } from 'react-dom';

export default ({ children }: { children: React.ReactNode }) => {
    const element = useRef(document.getElementById('modal-portal'));

    return createPortal(children, element!.current!);
};
</file>

<file path="resources/scripts/components/elements/ProgressBar.tsx">
import tw from 'twin.macro';
import { randomInt } from '@/helpers';
import styled from 'styled-components/macro';
import { CSSTransition } from 'react-transition-group';
import React, { useEffect, useRef, useState } from 'react';
import { useStoreActions, useStoreState } from 'easy-peasy';

const BarFill = styled.div`
    ${tw`h-full bg-green-400 animate-pulse`};
    transition: 500ms ease-in-out;
`;

type Timer = ReturnType<typeof setTimeout>;

export default () => {
    const interval = useRef<Timer>(null) as React.MutableRefObject<Timer>;
    const timeout = useRef<Timer>(null) as React.MutableRefObject<Timer>;
    const [visible, setVisible] = useState(false);
    const progress = useStoreState((state) => state.progress.progress);
    const continuous = useStoreState((state) => state.progress.continuous);
    const setProgress = useStoreActions((actions) => actions.progress.setProgress);

    useEffect(() => {
        return () => {
            timeout.current && clearTimeout(timeout.current);
            interval.current && clearInterval(interval.current);
        };
    }, []);

    useEffect(() => {
        setVisible((progress || 0) > 0);

        if (progress === 100) {
            timeout.current = setTimeout(() => setProgress(undefined), 500);
        }
    }, [progress]);

    useEffect(() => {
        if (!continuous) {
            interval.current && clearInterval(interval.current);
            return;
        }

        if (!progress || progress === 0) {
            setProgress(randomInt(20, 30));
        }
    }, [continuous]);

    useEffect(() => {
        if (continuous) {
            interval.current && clearInterval(interval.current);
            if ((progress || 0) >= 90) {
                setProgress(90);
            } else {
                interval.current = setTimeout(() => setProgress((progress || 0) + randomInt(1, 5)), 500);
            }
        }
    }, [progress, continuous]);

    return (
        <div css={tw`w-20 fixed`} style={{ height: '3px' }}>
            <CSSTransition timeout={150} appear in={visible} unmountOnExit classNames={'fade'}>
                <BarFill style={{ width: progress === undefined ? '100%' : `${progress}%` }} />
            </CSSTransition>
        </div>
    );
};
</file>

<file path="resources/scripts/components/elements/ScreenBlock.tsx">
import React from 'react';
import tw from 'twin.macro';
import * as Icon from 'react-feather';
import NotFoundSvg from '@/assets/images/not_found.svg';
import { Button } from '@/components/elements/button/index';
import styled, { keyframes } from 'styled-components/macro';
import ServerErrorSvg from '@/assets/images/server_error.svg';
import PageContentBlock from '@/components/elements/PageContentBlock';

interface BaseProps {
    title: string;
    image: string;
    message: string;
    noContainer?: boolean;
    onRetry?: () => void;
    onBack?: () => void;
}

interface PropsWithRetry extends BaseProps {
    onRetry?: () => void;
    onBack?: never;
}

interface PropsWithBack extends BaseProps {
    onBack?: () => void;
    onRetry?: never;
}

export type ScreenBlockProps = PropsWithBack | PropsWithRetry;

const spin = keyframes`
    to { transform: rotate(360deg) }
`;

const ActionButton = styled(Button)`
    ${tw`rounded-full w-8 h-8 flex items-center justify-center p-0`};

    &.hover\\:spin:hover {
        animation: ${spin} 2s linear infinite;
    }
`;

const ScreenBlock = ({ title, image, message, onBack, onRetry, noContainer }: ScreenBlockProps) => (
    <>
        {noContainer ? (
            <div css={tw`flex justify-center`}>
                <div
                    css={tw`w-full sm:w-3/4 md:w-1/2 p-12 md:p-20 bg-neutral-800 rounded-lg shadow-lg text-center relative`}
                >
                    {(typeof onBack === 'function' || typeof onRetry === 'function') && (
                        <div css={tw`absolute left-0 top-0 ml-4 mt-4`}>
                            <ActionButton
                                onClick={() => (onRetry ? onRetry() : onBack ? onBack() : null)}
                                className={onRetry ? 'hover:spin' : undefined}
                            >
                                {onRetry ? <Icon.RefreshCw /> : <Icon.ChevronLeft />}
                            </ActionButton>
                        </div>
                    )}
                    <img src={image} css={tw`w-2/3 h-auto select-none mx-auto`} />
                    <h2 css={tw`mt-10 font-bold text-4xl`}>{title}</h2>
                    <p css={tw`text-sm text-neutral-400 mt-2`}>{message}</p>
                </div>
            </div>
        ) : (
            <PageContentBlock>
                <div css={tw`flex justify-center`}>
                    <div
                        css={tw`w-full sm:w-3/4 md:w-1/2 p-12 md:p-20 bg-neutral-900 rounded-lg shadow-lg text-center relative`}
                    >
                        {(typeof onBack === 'function' || typeof onRetry === 'function') && (
                            <div css={tw`absolute left-0 top-0 ml-4 mt-4`}>
                                <ActionButton
                                    onClick={() => (onRetry ? onRetry() : onBack ? onBack() : null)}
                                    className={onRetry ? 'hover:spin' : undefined}
                                >
                                    {onRetry ? <Icon.RefreshCw /> : <Icon.ChevronLeft />}
                                </ActionButton>
                            </div>
                        )}
                        <img src={image} css={tw`w-2/3 h-auto select-none mx-auto`} />
                        <h2 css={tw`mt-10 font-bold text-4xl`}>{title}</h2>
                        <p css={tw`text-sm text-neutral-400 mt-2`}>{message}</p>
                    </div>
                </div>
            </PageContentBlock>
        )}
    </>
);

type ServerErrorProps = (Omit<PropsWithBack, 'image' | 'title'> | Omit<PropsWithRetry, 'image' | 'title'>) & {
    title?: string;
};

type NotApprovedProps = (Omit<PropsWithBack, 'image' | 'title'> | Omit<PropsWithRetry, 'image' | 'title'>) & {
    title: string;
    message: string;
};

const ServerError = ({ title, ...props }: ServerErrorProps) => (
    <ScreenBlock title={title || 'Something went wrong'} image={ServerErrorSvg} {...props} />
);

const NotApproved = ({ title, message }: NotApprovedProps) => (
    <ScreenBlock title={title} image={NotFoundSvg} message={message} />
);

const NotFound = ({ title, message, onBack }: Partial<Pick<ScreenBlockProps, 'title' | 'message' | 'onBack'>>) => (
    <ScreenBlock
        title={title || '404'}
        image={NotFoundSvg}
        message={message || 'The requested resource was not found.'}
        onBack={onBack}
    />
);

export { ServerError, NotFound, NotApproved };
export default ScreenBlock;
</file>

<file path="resources/scripts/components/elements/Select.tsx">
import tw from 'twin.macro';
import styled, { css } from 'styled-components/macro';

interface Props {
    hideDropdownArrow?: boolean;
}

const Select = styled.select<Props>`
    ${tw`shadow-none block p-3 pr-8 rounded border w-full text-sm transition-colors duration-150 ease-linear`};

    &,
    &:hover:not(:disabled),
    &:focus {
        ${tw`outline-none`};
    }

    -webkit-appearance: none;
    -moz-appearance: none;
    background-size: 1rem;
    background-repeat: no-repeat;
    background-position-x: calc(100% - 0.75rem);
    background-position-y: center;

    &::-ms-expand {
        display: none;
    }

    ${(props) =>
        !props.hideDropdownArrow &&
        css`
            ${tw`bg-neutral-800 border-neutral-700 text-neutral-200`};
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='%23C3D1DF' d='M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z'/%3e%3c/svg%3e ");

            &:hover:not(:disabled),
            &:focus {
                ${tw`border-neutral-400`};
            }
        `};
`;

export default Select;
</file>

<file path="resources/scripts/components/elements/ServerContentBlock.tsx">
import React from 'react';
import PageContentBlock, { PageContentBlockProps } from '@/components/elements/PageContentBlock';

interface Props extends PageContentBlockProps {
    title: string;
}

const ServerContentBlock: React.FC<Props> = ({ title, children, ...props }) => (
    <PageContentBlock title={title} {...props}>
        {children}
    </PageContentBlock>
);

export default ServerContentBlock;
</file>

<file path="resources/scripts/components/elements/Spinner.tsx">
import tw from 'twin.macro';
import React, { Suspense } from 'react';
import ErrorBoundary from '@/components/elements/ErrorBoundary';
import styled, { css, keyframes } from 'styled-components/macro';

export type SpinnerSize = 'small' | 'base' | 'large';

interface Props {
    size?: SpinnerSize;
    centered?: boolean;
    isBlue?: boolean;
}

interface Spinner extends React.FC<Props> {
    Size: Record<'SMALL' | 'BASE' | 'LARGE', SpinnerSize>;
    Suspense: React.FC<Props>;
}

const spin = keyframes`
    to { transform: rotate(360deg); }
`;

// noinspection CssOverwrittenProperties
const SpinnerComponent = styled.div<Props>`
    ${tw`w-8 h-8`};
    border-width: 3px;
    border-radius: 50%;
    animation: ${spin} 1s cubic-bezier(0.55, 0.25, 0.25, 0.7) infinite;

    ${(props) =>
        props.size === 'small'
            ? tw`w-4 h-4 border-2`
            : props.size === 'large'
            ? css`
                  ${tw`w-16 h-16`};
                  border-width: 6px;
              `
            : null};

    border-color: ${(props) => (!props.isBlue ? 'rgba(255, 255, 255, 0.2)' : 'hsla(212, 92%, 43%, 0.2)')};
    border-top-color: ${(props) => (!props.isBlue ? 'rgb(255, 255, 255)' : 'hsl(212, 92%, 43%)')};
`;

const Spinner: Spinner = ({ centered, ...props }) =>
    centered ? (
        <div css={[tw`flex justify-center items-center`, props.size === 'large' ? tw`m-20` : tw`m-6`]}>
            <SpinnerComponent {...props} />
        </div>
    ) : (
        <SpinnerComponent {...props} />
    );
Spinner.displayName = 'Spinner';

Spinner.Size = {
    SMALL: 'small',
    BASE: 'base',
    LARGE: 'large',
};

Spinner.Suspense = ({ children, centered = true, size = Spinner.Size.LARGE, ...props }) => (
    <Suspense fallback={<Spinner centered={centered} size={size} {...props} />}>
        <ErrorBoundary>{children}</ErrorBoundary>
    </Suspense>
);
Spinner.Suspense.displayName = 'Spinner.Suspense';

export default Spinner;
</file>

<file path="resources/scripts/components/elements/SpinnerOverlay.tsx">
import React from 'react';
import tw from 'twin.macro';
import Fade from '@/components/elements/Fade';
import Spinner, { SpinnerSize } from '@/components/elements/Spinner';

interface Props {
    visible: boolean;
    fixed?: boolean;
    size?: SpinnerSize;
    backgroundOpacity?: number;
}

const SpinnerOverlay: React.FC<Props> = ({ size, fixed, visible, backgroundOpacity, children }) => (
    <Fade timeout={150} in={visible} unmountOnExit>
        <div
            css={[
                tw`top-0 left-0 flex items-center justify-center w-full h-full rounded flex-col z-40`,
                !fixed ? tw`absolute` : tw`fixed`,
            ]}
            style={{ background: `rgba(0, 0, 0, ${backgroundOpacity || 0.45})` }}
        >
            <Spinner size={size} />
            {children && (typeof children === 'string' ? <p css={tw`mt-4 text-neutral-400`}>{children}</p> : children)}
        </div>
    </Fade>
);

export default SpinnerOverlay;
</file>

<file path="resources/scripts/components/elements/StoreContainer.tsx">
import tw from 'twin.macro';
import { breakpoint } from '@/theme';
import styled from 'styled-components/macro';

export default styled.div`
    ${tw`flex flex-wrap`};

    & > div {
        ${tw`w-full`};

        ${breakpoint('sm')`
            width: calc(50% - 1rem);
        `}

        ${breakpoint('md')`
            ${tw`w-auto flex-1`};
        `}
    }
`;
</file>

<file path="resources/scripts/components/elements/SubNavigation.tsx">
// // import tw, { theme } from 'twin.macro';
// // import styled from 'styled-components/macro';

// // const SubNavigation = styled.div`
// //     ${tw`bg-neutral-800 overflow-x-auto font-mono font-semibold mb-4 sm:mb-10 xl:ml-20`};

// //     & > div {
// //         ${tw`flex text-sm mx-auto px-2`};

// //         & > a,
// //         & > div {
// //             ${tw`inline-block py-3 px-4 text-neutral-300 no-underline whitespace-nowrap transition-all duration-150`};

// //             &:not(:first-of-type) {
// //                 ${tw`ml-2`};
// //             }

// //             &:hover {
// //                 ${tw`text-neutral-100`};
// //             }

// //             &:active,
// //             &.active {
// //                 ${tw`text-neutral-100`};
// //                 box-shadow: inset 0 -2px ${theme`colors.green.600`.toString()};
// //             }
// //         }
// //     }
// // `;

// // export default SubNavigation;

import tw from 'twin.macro';
import { theme } from 'twin.macro';
import styled from 'styled-components/macro';

const SubNavigation = styled.div`
    ${tw`bg-neutral-800 overflow-x-auto font-mono font-semibold mb-4 sm:mb-10 ml-0 xl:ml-32`};

    & > div {
        ${tw`flex text-sm mx-auto px-2`};

        & > a,
        & > div {
            ${tw`inline-block py-3 px-4 text-neutral-300 no-underline whitespace-nowrap transition-all duration-150`};

            &:not(:first-of-type) {
                ${tw`ml-2`};
            }

            &:hover {
                ${tw`text-neutral-100`};
            }

            &:active,
            &.active {
                ${tw`text-neutral-100`};
                box-shadow: inset 0 -2px ${theme`colors.green.600`.toString()};
            }
        }
    }
`;

export default SubNavigation;
</file>

<file path="resources/scripts/components/elements/Suspended.tsx">
import tw from 'twin.macro';
import React, { useState } from 'react';
import useFlash from '@/plugins/useFlash';
import { useStoreState } from '@/state/hooks';
import Code from '@/components/elements/Code';
import { ServerContext } from '@/state/server';
import Input from '@/components/elements/Input';
import renewServer from '@/api/server/renewServer';
import deleteServer from '@/api/server/deleteServer';
import { Button } from '@/components/elements/button';
import { Dialog } from '@/components/elements/dialog';
import ServerErrorSvg from '@/assets/images/server_error.svg';
import FlashMessageRender from '@/components/FlashMessageRender';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import PageContentBlock from '@/components/elements/PageContentBlock';

export default () => {
    const [name, setName] = useState('');

    const [isSubmit, setSubmit] = useState(false);
    const [renewDialog, setRenewDialog] = useState(false);
    const [deleteDialog, setDeleteDialog] = useState(false);
    const [confirmDialog, setConfirmDialog] = useState(false);

    const { clearFlashes, clearAndAddHttpError } = useFlash();
    const store = useStoreState((state) => state.storefront.data!);
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const serverName = ServerContext.useStoreState((state) => state.server.data!.name);
    const renewable = ServerContext.useStoreState((state) => state.server.data?.renewable);

    const doRenewal = () => {
        clearFlashes('server:renewal');
        setSubmit(true);

        renewServer(uuid)
            .then(() => {
                setSubmit(false);
                // @ts-expect-error this is valid
                window.location = '/';
            })
            .catch((error) => {
                clearAndAddHttpError({ key: 'server:renewal', error });
                setSubmit(false);
            });
    };

    const doDeletion = (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();
        e.stopPropagation();

        clearFlashes('server:renewal');
        setSubmit(true);

        deleteServer(uuid, name)
            .then(() => {
                setSubmit(false);
                // @ts-expect-error this is valid
                window.location = '/store';
            })
            .catch((error) => {
                clearAndAddHttpError({ key: 'server:renewal', error });
                setSubmit(false);
            });
    };

    return (
        <>
            <Dialog.Confirm
                open={renewDialog}
                onClose={() => setRenewDialog(false)}
                title={'Confirm server renewal'}
                confirm={'Continue'}
                onConfirmed={() => doRenewal()}
            >
                <SpinnerOverlay visible={isSubmit} />
                Are you sure you want to spend {store.renewals.cost} credits to renew your server?
            </Dialog.Confirm>
            <Dialog.Confirm
                open={deleteDialog}
                onClose={() => setDeleteDialog(false)}
                title={'Confirm server deletion'}
                confirm={'Continue'}
                onConfirmed={() => setConfirmDialog(true)}
            >
                <SpinnerOverlay visible={isSubmit} />
                This action will remove your server from the system, along with all files and configurations.
            </Dialog.Confirm>
            <form id={'delete-suspended-server-form'} onSubmit={doDeletion}>
                <Dialog open={confirmDialog} title={'Confirm server deletion'} onClose={() => setConfirmDialog(false)}>
                    {name !== serverName && (
                        <>
                            <p className={'my-2 text-gray-400'}>
                                Type <Code>{serverName}</Code> below.
                            </p>
                            <Input type={'text'} value={name} onChange={(n) => setName(n.target.value)} />
                        </>
                    )}
                    <Button
                        disabled={name !== serverName}
                        type={'submit'}
                        className={'mt-2'}
                        form={'delete-suspended-server-form'}
                    >
                        Confirm
                    </Button>
                </Dialog>
            </form>
            <PageContentBlock title={'Server Suspended'}>
                <FlashMessageRender byKey={'server:renewal'} css={tw`mb-1`} />
                <div css={tw`flex justify-center`}>
                    <div
                        css={tw`w-full sm:w-3/4 md:w-1/2 p-12 md:p-20 bg-neutral-900 rounded-lg shadow-lg text-center relative`}
                    >
                        <img src={ServerErrorSvg} css={tw`w-2/3 h-auto select-none mx-auto`} />
                        <h2 css={tw`mt-10 font-bold text-4xl`}>Suspended</h2>
                        {renewable ? (
                            <>
                                <p css={tw`text-sm my-2`}>
                                    Your server has been suspended due to it not being renewed on time. Please click the
                                    &apos;Renew&apos; button in order to reactivate your server. If you want to delete
                                    your server, the resources will automatically be added back to your account so you
                                    can re-deploy a new server easily.
                                </p>
                                <Button
                                    className={'mx-2 my-1'}
                                    onClick={() => setRenewDialog(true)}
                                    disabled={isSubmit}
                                >
                                    Renew Now
                                </Button>
                                <Button.Danger
                                    className={'mx-2 my-1'}
                                    onClick={() => setDeleteDialog(true)}
                                    disabled={isSubmit}
                                >
                                    Delete Server
                                </Button.Danger>
                            </>
                        ) : (
                            <>This server is suspended and cannot be accessed.</>
                        )}
                    </div>
                </div>
            </PageContentBlock>
        </>
    );
};
</file>

<file path="resources/scripts/components/elements/Switch.tsx">
import { v4 } from 'uuid';
import tw from 'twin.macro';
import React, { useMemo } from 'react';
import styled from 'styled-components/macro';
import Label from '@/components/elements/Label';
import Input from '@/components/elements/Input';

const ToggleContainer = styled.div`
    ${tw`relative select-none w-12 leading-normal`};

    & > input[type='checkbox'] {
        ${tw`hidden`};

        &:checked + label {
            background-color: rgb(220, 38, 38);
            border-color: rgb(185, 28, 28);
        }

        &:checked + label:before {
            right: 0.125rem;
        }
    }

    & > label {
        ${tw`mb-0 block overflow-hidden cursor-pointer bg-neutral-400 border border-neutral-700 rounded-full h-6 shadow-inner`};
        transition: all 75ms linear;

        &::before {
            ${tw`absolute block bg-white border h-5 w-5 rounded-full`};
            top: 0.125rem;
            right: calc(50% + 0.125rem);
            //width: 1.25rem;
            //height: 1.25rem;
            content: '';
            transition: all 75ms ease-in;
        }
    }
`;

export interface SwitchProps {
    name: string;
    label?: string;
    description?: string;
    defaultChecked?: boolean;
    readOnly?: boolean;
    onChange?: (e: React.ChangeEvent<HTMLInputElement>) => void;
    children?: React.ReactNode;
}

const Switch = ({ name, label, description, defaultChecked, readOnly, onChange, children }: SwitchProps) => {
    const uuid = useMemo(() => v4(), []);

    return (
        <div css={tw`flex items-center`}>
            <ToggleContainer css={tw`flex-none`}>
                {children || (
                    <Input
                        id={uuid}
                        name={name}
                        type={'checkbox'}
                        onChange={(e) => onChange && onChange(e)}
                        defaultChecked={defaultChecked}
                        disabled={readOnly}
                    />
                )}
                <Label htmlFor={uuid} />
            </ToggleContainer>
            {(label || description) && (
                <div css={tw`ml-4 w-full`}>
                    {label && (
                        <Label css={[tw`cursor-pointer`, !!description && tw`mb-0`]} htmlFor={uuid}>
                            {label}
                        </Label>
                    )}
                    {description && <p css={tw`text-neutral-400 text-sm mt-2`}>{description}</p>}
                </div>
            )}
        </div>
    );
};

export default Switch;

// import { v4 } from 'uuid';
// import tw from 'twin.macro';
// import React, { useMemo } from 'react';
// import styled from 'styled-components/macro';
// import Label from '@/components/elements/Label';
// import Input from '@/components/elements/Input';

// const ToggleContainer = styled.div`
//     ${tw`relative select-none leading-normal`};

//     & > input[type='checkbox'] {
//         ${tw`hidden`};

//         &:checked + label {
//             background-color: rgb(220, 38, 38);
//             border-color: rgb(185, 28, 28);
//         }

//         &:checked + label:before {
//             left: calc(100% - 1.125rem - 0.15rem);
//             background-color: rgb(153, 27, 27);
//         }
//     }

//     & > label {
//         ${tw`mb-0 block overflow-hidden cursor-pointer border-2 rounded-lg h-6 shadow-inner transition-all`};
//         background-color: transparent;
//         border-color: rgb(220, 38, 38);
//         width: 4rem;
//         display: flex;
//         align-items: center;

//         &::before {
//             ${tw`absolute block rounded transition-all`};
//             width: 1.25rem;
//             height: 1.25rem;
//             top: 0.1rem;
//             left: 0.15rem;
//             content: '';
//             transition: all 150ms ease-in;
//         }
//     }
// `;

// export interface SwitchProps {
//     name: string;
//     label?: string;
//     description?: string;
//     defaultChecked?: boolean;
//     readOnly?: boolean;
//     onChange?: (e: React.ChangeEvent<HTMLInputElement>) => void;
//     children?: React.ReactNode;
// }

// const Switch = ({ name, label, description, defaultChecked, readOnly, onChange, children }: SwitchProps) => {
//     const uuid = useMemo(() => v4(), []);

//     return (
//         <div css={tw`flex items-center`}>
//             <ToggleContainer css={tw`flex-none`}>
//                 {children || (
//                     <Input
//                         id={uuid}
//                         name={name}
//                         type={'checkbox'}
//                         onChange={(e) => onChange && onChange(e)}
//                         defaultChecked={defaultChecked}
//                         disabled={readOnly}
//                     />
//                 )}
//                 <Label htmlFor={uuid} />
//             </ToggleContainer>
//             {(label || description) && (
//                 <div css={tw`ml-4 w-full`}>
//                     {label && (
//                         <Label css={[tw`cursor-pointer`, !!description && tw`mb-0`]} htmlFor={uuid}>
//                             {label}
//                         </Label>
//                     )}
//                     {description && <p css={tw`text-neutral-400 text-sm mt-2`}>{description}</p>}
//                 </div>
//             )}
//         </div>
//     );
// };

// export default Switch;
</file>

<file path="resources/scripts/components/elements/TitledGreyBox.tsx">
import classNames from 'classnames';
import React, { memo } from 'react';
import isEqual from 'react-fast-compare';
import Icon from '@/components/elements/Icon';
import { IconDefinition } from '@fortawesome/free-solid-svg-icons';

interface Props {
    className?: string;
    icon?: IconDefinition;
    children: React.ReactNode;
    title: string | React.ReactNode;
}

const TitledGreyBox = ({ icon, title, children, className }: Props) => (
    <div className={classNames('shadow-2xl bg-gray-900', className)}>
        <div className={'bg-neutral-800 p-3 border-b border-gray-900'}>
            <p className={'font-semibold font-sans line-clamp-1 text-lg'}>
                {icon && <Icon icon={icon} className={'w-4 h-4 mr-2 mb-1'} />}
                {title}
            </p>
        </div>
        <div className={'p-3'}>{children}</div>
    </div>
);

export default memo(TitledGreyBox, isEqual);
</file>

<file path="resources/scripts/components/elements/Translate.tsx">
import React from 'react';
import { Trans, TransProps, useTranslation } from 'react-i18next';

type Props = Omit<TransProps, 't'>;

export default ({ ns, children, ...props }: Props) => {
    const { t } = useTranslation(ns);

    return (
        <Trans t={t} {...props}>
            {children}
        </Trans>
    );
};
</file>

<file path="resources/scripts/components/server/analytics/AnalyticsContainer.tsx">
import Can from '@/components/elements/Can';
import { ServerContext } from '@/state/server';
import React, { useEffect, useState } from 'react';
import { Alert } from '@/components/elements/alert';
import ContentBox from '@/components/elements/ContentBox';
import { getMessages, Message } from '@/api/server/analytics';
import StatGraphs from '@/components/server/console/StatGraphs';
import TitledGreyBox from '@/components/elements/TitledGreyBox';
import PowerButtons from '@/components/server/console/PowerButtons';
import UsageMetrics from '@/components/server/analytics/UsageMetrics';
import { SocketEvent, SocketRequest } from '@/components/server/events';
import ServerContentBlock from '@/components/elements/ServerContentBlock';

type Stats = Record<'memory' | 'cpu' | 'disk' | 'uptime', number>;

const svgProps = {
    cx: 16,
    cy: 16,
    r: 14,
    strokeWidth: 3,
    fill: 'none',
    stroke: 'currentColor',
};

const ProgressCircle = ({ data }: { data: number }) => (
    <svg viewBox={'0 0 32 32'} className={'w-16 h-16'}>
        <circle {...svgProps} className={'opacity-50'} />
        <circle
            {...svgProps}
            stroke={data >= 95 ? '#ef4444' : data >= 75 ? '#eab308' : '#22C55E'}
            strokeDasharray={28 * Math.PI}
            className={'rotate-[-90deg] origin-[50%_50%] transition-[stroke-dashoffset] duration-1000'}
            style={{ strokeDashoffset: ((100 - data) / 100) * 28 * Math.PI }}
        />
    </svg>
);

const UsageBox = ({ progress, title, content }: { progress: number; title: string; content: string }) => (
    <div className={'grid grid-cols-1 lg:grid-cols-5 gap-2 sm:gap-4 p-6'}>
        <ProgressCircle data={progress} />
        <div className={'col-span-4 inline-block align-text-middle'}>
            <p className={'text-2xl text-gray-200'}>{title}</p>
            <p className={'text-lg text-gray-400'}>{content}</p>
        </div>
    </div>
);

export default () => {
    const [messages, setMessages] = useState<Message[]>();
    const [stats, setStats] = useState<Stats>({ memory: 0, cpu: 0, disk: 0, uptime: 0 });

    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const instance = ServerContext.useStoreState((state) => state.socket.instance);
    const connected = ServerContext.useStoreState((state) => state.socket.connected);
    const limits = ServerContext.useStoreState((state) => state.server.data!.limits);

    const cpuUsed = ((stats.cpu / limits.cpu) * 100).toFixed(2);
    const diskUsed = ((stats.disk / 1024 / 1024 / limits.disk) * 100).toFixed(2);
    const memoryUsed = ((stats.memory / 1024 / 1024 / limits.memory) * 100).toFixed(2);

    const statsListener = (data: string) => {
        let stats: any = {};

        try {
            stats = JSON.parse(data);
        } catch (e) {
            return;
        }

        setStats({
            memory: stats.memory_bytes,
            cpu: stats.cpu_absolute,
            disk: stats.disk_bytes,
            uptime: stats.uptime || 0,
        });
    };

    useEffect(() => {
        getMessages(uuid).then((data) => {
            setMessages(data);
        });

        if (!connected || !instance) {
            return;
        }

        instance.addListener(SocketEvent.STATS, statsListener);
        instance.send(SocketRequest.SEND_STATS);

        return () => {
            instance.removeListener(SocketEvent.STATS, statsListener);
        };
    }, [instance, connected]);

    return (
        <ServerContentBlock title={'Server Analytics'} description={'View statistics and performance for your server.'}>
            <div className={'grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-2'}>
                <div className={'col-span-2 grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-4'}>
                    <UsageMetrics />
                    <StatGraphs />
                </div>
                <div className={'lg:ml-2'}>
                    <Can action={['control.start', 'control.stop', 'control.restart']} matchAny>
                        <PowerButtons className={'flex space-x-4 text-center mb-4'} />
                    </Can>
                    <ContentBox>
                        <UsageBox progress={parseInt(cpuUsed)} title={'CPU Usage'} content={`${cpuUsed}% used`} />
                        <UsageBox
                            progress={parseInt(memoryUsed)}
                            title={'Memory Usage'}
                            content={`${memoryUsed}% used`}
                        />
                        <UsageBox progress={parseInt(diskUsed)} title={'Disk Usage'} content={`${diskUsed}% used`} />
                    </ContentBox>
                    <TitledGreyBox title={'Performance Metrics'} className={'rounded mt-4'}>
                        {!messages || messages.length < 1 ? (
                            <p className={'text-gray-400 text-center'}>No metrics are currently available.</p>
                        ) : (
                            <>
                                {messages.slice(0, 6).map((message) => (
                                    <Alert type={message.type} key={message.id} className={'mb-2'}>
                                        <div>
                                            {message.title}{' '}
                                            <span className={'text-xs text-gray-400'}>({message.createdAt})</span>
                                            <p className={'text-sm text-gray-400'}>{message.content}</p>
                                        </div>
                                    </Alert>
                                ))}
                            </>
                        )}
                    </TitledGreyBox>
                </div>
            </div>
        </ServerContentBlock>
    );
};
</file>

<file path="resources/scripts/components/server/analytics/UsageMetrics.tsx">
import classNames from 'classnames';
import UptimeDuration from '../UptimeDuration';
import { ServerContext } from '@/state/server';
import React, { useEffect, useState } from 'react';
import ContentBox from '@/components/elements/ContentBox';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import styles from '@/components/server/console/style.module.css';
import { SocketEvent, SocketRequest } from '@/components/server/events';
import { faClock, faMicrochip, faMemory, faHdd } from '@fortawesome/free-solid-svg-icons';

type Stats = Record<'memory' | 'cpu' | 'disk' | 'uptime', number>;

const getColorFromStatus = (status: string): string => {
    switch (status) {
        case 'offline':
            return 'text-red-500';
        case 'starting':
            return 'text-yellow-500';
        case 'stopping':
            return 'text-yellow-500';
        case 'running':
            return 'text-green-500';
        default:
            return 'text-gray-500';
    }
};

const getStatusFromUsage = (usage: number): string => {
    if (usage <= 0) return 'N/A';
    if (usage <= 25) return 'low';
    if (usage >= 80) return 'high';
    else return 'normal';
};

export default () => {
    const status = ServerContext.useStoreState((state) => state.status.value);
    const [stats, setStats] = useState<Stats>({ memory: 0, cpu: 0, disk: 0, uptime: 0 });

    const instance = ServerContext.useStoreState((state) => state.socket.instance);
    const connected = ServerContext.useStoreState((state) => state.socket.connected);
    const limits = ServerContext.useStoreState((state) => state.server.data!.limits);

    const cpuUsed = ((stats.cpu / limits.cpu) * 100).toFixed(2);
    const diskUsed = ((stats.disk / 1024 / 1024 / limits.disk) * 100).toFixed(2);
    const memoryUsed = ((stats.memory / 1024 / 1024 / limits.memory) * 100).toFixed(2);

    const statsListener = (data: string) => {
        let stats: any = {};

        try {
            stats = JSON.parse(data);
        } catch (e) {
            return;
        }

        setStats({
            memory: stats.memory_bytes,
            cpu: stats.cpu_absolute,
            disk: stats.disk_bytes,
            uptime: stats.uptime || 0,
        });
    };

    useEffect(() => {
        if (!connected || !instance) {
            return;
        }

        instance.addListener(SocketEvent.STATS, statsListener);
        instance.send(SocketRequest.SEND_STATS);

        return () => {
            instance.removeListener(SocketEvent.STATS, statsListener);
        };
    }, [instance, connected]);

    return (
        <div className={classNames(styles.chart_container, 'group')}>
            <div className={'flex items-center justify-between px-4 py-2'}>
                <h3
                    className={'font-header transition-colors duration-100 group-hover:text-gray-50 font-semibold mb-2'}
                >
                    Current Status
                </h3>
            </div>
            <div className={'grid grid-cols-2 gap-3 mx-4'}>
                <ContentBox isLight>
                    <div className={'text-center'}>
                        <p className={'font-bold text-xl'}>
                            <FontAwesomeIcon icon={faClock} size={'1x'} />
                            <br />
                            Server is <span className={getColorFromStatus(status ?? 'offline')}>{status}</span>
                        </p>
                        <p className={'font-semibold text-sm text-gray-400 mt-1'}>
                            {status === 'running' ? (
                                <UptimeDuration uptime={stats.uptime / 1000} />
                            ) : (
                                <>Unable to fetch uptime</>
                            )}
                        </p>
                    </div>
                </ContentBox>
                <ContentBox isLight>
                    <div className={'text-center'}>
                        <p className={'font-bold text-xl'}>
                            <FontAwesomeIcon icon={faMicrochip} size={'1x'} />
                            <br />
                            CPU usage is {getStatusFromUsage(parseInt(cpuUsed))}
                        </p>
                        <p className={'font-semibold text-sm text-gray-400 mt-1'}>Using {cpuUsed}%</p>
                    </div>
                </ContentBox>
                <ContentBox isLight>
                    <div className={'text-center'}>
                        <p className={'font-bold text-xl'}>
                            <FontAwesomeIcon icon={faMemory} size={'1x'} />
                            <br />
                            RAM usage is {getStatusFromUsage(parseInt(memoryUsed))}
                        </p>
                        <p className={'font-semibold text-sm text-gray-400 mt-1'}>Using {memoryUsed}%</p>
                    </div>
                </ContentBox>
                <ContentBox isLight>
                    <div className={'text-center'}>
                        <p className={'font-bold text-xl'}>
                            <FontAwesomeIcon icon={faHdd} size={'1x'} />
                            <br />
                            Disk usage is {getStatusFromUsage(parseInt(diskUsed))}
                        </p>
                        <p className={'font-semibold text-sm text-gray-400 mt-1'}>Using {diskUsed}%</p>
                    </div>
                </ContentBox>
            </div>
        </div>
    );
};
</file>

<file path="resources/scripts/components/server/backups/BackupContainer.tsx">
import tw from 'twin.macro';
import useFlash from '@/plugins/useFlash';
import Can from '@/components/elements/Can';
import { ServerContext } from '@/state/server';
import Spinner from '@/components/elements/Spinner';
import Pagination from '@/components/elements/Pagination';
import BackupRow from '@/components/server/backups/BackupRow';
import React, { useContext, useEffect, useState } from 'react';
import ServerContentBlock from '@/components/elements/ServerContentBlock';
import CreateBackupButton from '@/components/server/backups/CreateBackupButton';
import getServerBackups, { Context as ServerBackupContext } from '@/api/swr/getServerBackups';

const BackupContainer = () => {
    const { page, setPage } = useContext(ServerBackupContext);
    const { clearFlashes, clearAndAddHttpError } = useFlash();
    const { data: backups, error, isValidating } = getServerBackups();

    const backupLimit = ServerContext.useStoreState((state) => state.server.data!.featureLimits.backups);

    useEffect(() => {
        if (!error) {
            clearFlashes('backups');

            return;
        }

        clearAndAddHttpError({ error, key: 'backups' });
    }, [error]);

    if (!backups || (error && isValidating)) {
        return <Spinner size={'large'} centered />;
    }

    return (
        <ServerContentBlock title={'Backups'} description={'Protect your data with backups.'} showFlashKey={'backups'}>
            <Pagination data={backups} onPageSelect={setPage}>
                {({ items }) =>
                    !items.length ? (
                        // Don't show any error messages if the server has no backups and the user cannot
                        // create additional ones for the server.
                        !backupLimit ? null : (
                            <p css={tw`text-center text-sm text-neutral-300`}>
                                {page > 1
                                    ? "Looks like we've run out of backups to show you, try going back a page."
                                    : 'It looks like there are no backups currently stored for this server.'}
                            </p>
                        )
                    ) : (
                        items.map((backup, index) => (
                            <BackupRow key={backup.uuid} backup={backup} css={index > 0 ? tw`mt-2` : undefined} />
                        ))
                    )
                }
            </Pagination>
            {backupLimit === 0 && (
                <p css={tw`text-center text-sm text-neutral-300`}>
                    Backups cannot be created for this server because the backup limit is set to 0.
                </p>
            )}
            <Can action={'backup.create'}>
                <div css={tw`mt-6 sm:flex items-center justify-end`}>
                    {backupLimit > 0 && backups.backupCount > 0 && (
                        <p css={tw`text-sm text-neutral-300 mb-4 sm:mr-6 sm:mb-0`}>
                            {backups.backupCount} of {backupLimit} backups have been created for this server.
                        </p>
                    )}
                    {backupLimit > 0 && backupLimit > backups.backupCount && (
                        <CreateBackupButton css={tw`w-full sm:w-auto`} />
                    )}
                </div>
            </Can>
        </ServerContentBlock>
    );
};

export default () => {
    const [page, setPage] = useState<number>(1);
    return (
        <ServerBackupContext.Provider value={{ page, setPage }}>
            <BackupContainer />
        </ServerBackupContext.Provider>
    );
};
</file>

<file path="resources/scripts/components/server/backups/BackupContextMenu.tsx">
import tw from 'twin.macro';
import * as Icon from 'react-feather';
import React, { useState } from 'react';
import useFlash from '@/plugins/useFlash';
import Can from '@/components/elements/Can';
import { ServerContext } from '@/state/server';
import Input from '@/components/elements/Input';
import { ServerBackup } from '@/api/server/types';
import http, { httpErrorToHuman } from '@/api/http';
import { Dialog } from '@/components/elements/dialog';
import getServerBackups from '@/api/swr/getServerBackups';
import { restoreServerBackup } from '@/api/server/backups';
import deleteBackup from '@/api/server/backups/deleteBackup';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import getBackupDownloadUrl from '@/api/server/backups/getBackupDownloadUrl';
import DropdownMenu, { DropdownButtonRow } from '@/components/elements/DropdownMenu';

interface Props {
    backup: ServerBackup;
}

export default ({ backup }: Props) => {
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const setServerFromState = ServerContext.useStoreActions((actions) => actions.server.setServerFromState);
    const [modal, setModal] = useState('');
    const [loading, setLoading] = useState(false);
    const [truncate, setTruncate] = useState(false);
    const { clearFlashes, clearAndAddHttpError } = useFlash();
    const { mutate } = getServerBackups();

    const doDownload = () => {
        setLoading(true);
        clearFlashes('backups');
        getBackupDownloadUrl(uuid, backup.uuid)
            .then((url) => {
                // @ts-expect-error this is valid
                window.location = url;
            })
            .catch((error) => {
                console.error(error);
                clearAndAddHttpError({ key: 'backups', error });
            })
            .then(() => setLoading(false));
    };

    const doDeletion = () => {
        setLoading(true);
        clearFlashes('backups');
        deleteBackup(uuid, backup.uuid)
            .then(() =>
                mutate(
                    (data) => ({
                        ...data,
                        items: data.items.filter((b) => b.uuid !== backup.uuid),
                        backupCount: data.backupCount - 1,
                    }),
                    false
                )
            )
            .catch((error) => {
                console.error(error);
                clearAndAddHttpError({ key: 'backups', error });
                setLoading(false);
                setModal('');
            });
    };

    const doRestorationAction = () => {
        setLoading(true);
        clearFlashes('backups');
        restoreServerBackup(uuid, backup.uuid, truncate)
            .then(() =>
                setServerFromState((s) => ({
                    ...s,
                    status: 'restoring_backup',
                }))
            )
            .catch((error) => {
                console.error(error);
                clearAndAddHttpError({ key: 'backups', error });
            })
            .then(() => setLoading(false))
            .then(() => setModal(''));
    };

    const onLockToggle = () => {
        if (backup.isLocked && modal !== 'unlock') {
            return setModal('unlock');
        }

        http.post(`/api/client/servers/${uuid}/backups/${backup.uuid}/lock`)
            .then(() =>
                mutate(
                    (data) => ({
                        ...data,
                        items: data.items.map((b) =>
                            b.uuid !== backup.uuid
                                ? b
                                : {
                                      ...b,
                                      isLocked: !b.isLocked,
                                  }
                        ),
                    }),
                    false
                )
            )
            .catch((error) => alert(httpErrorToHuman(error)))
            .then(() => setModal(''));
    };

    return (
        <>
            <Dialog.Confirm
                open={modal === 'unlock'}
                onClose={() => setModal('')}
                title={`Unlock "${backup.name}"`}
                onConfirmed={onLockToggle}
            >
                This backup will no longer be protected from automated or accidental deletions.
            </Dialog.Confirm>
            <Dialog.Confirm
                open={modal === 'restore'}
                onClose={() => setModal('')}
                confirm={'Restore'}
                title={`Restore "${backup.name}"`}
                onConfirmed={() => doRestorationAction()}
            >
                <p>
                    Your server will be stopped. You will not be able to control the power state, access the file
                    manager, or create additional backups until completed.
                </p>
                <p css={tw`mt-4 -mb-2 bg-gray-700 p-3 rounded`}>
                    <label htmlFor={'restore_truncate'} css={tw`text-base flex items-center cursor-pointer`}>
                        <Input
                            type={'checkbox'}
                            css={tw`text-red-500! w-5! h-5! mr-2`}
                            id={'restore_truncate'}
                            value={'true'}
                            checked={truncate}
                            onChange={() => setTruncate((s) => !s)}
                        />
                        Delete all files before restoring backup.
                    </label>
                </p>
            </Dialog.Confirm>
            <Dialog.Confirm
                title={`Delete "${backup.name}"`}
                confirm={'Continue'}
                open={modal === 'delete'}
                onClose={() => setModal('')}
                onConfirmed={doDeletion}
            >
                This is a permanent operation. The backup cannot be recovered once deleted.
            </Dialog.Confirm>
            <SpinnerOverlay visible={loading} fixed />
            {backup.isSuccessful ? (
                <DropdownMenu
                    renderToggle={(onClick) => (
                        <button
                            onClick={onClick}
                            css={tw`text-gray-200 transition-colors duration-150 hover:text-gray-100 p-2`}
                        >
                            <Icon.MoreHorizontal />
                        </button>
                    )}
                >
                    <div css={tw`text-sm`}>
                        <Can action={'backup.download'}>
                            <DropdownButtonRow onClick={doDownload}>
                                <Icon.DownloadCloud css={tw`text-xs`} />
                                <span css={tw`ml-2`}>Download</span>
                            </DropdownButtonRow>
                        </Can>
                        <Can action={'backup.restore'}>
                            <DropdownButtonRow onClick={() => setModal('restore')}>
                                <Icon.Upload css={tw`text-xs`} />
                                <span css={tw`ml-2`}>Restore</span>
                            </DropdownButtonRow>
                        </Can>
                        <Can action={'backup.delete'}>
                            <>
                                <DropdownButtonRow onClick={onLockToggle}>
                                    {backup.isLocked ? (
                                        <>
                                            <Icon.Unlock css={tw`text-xs mr-2`} />
                                            Unlock
                                        </>
                                    ) : (
                                        <>
                                            <Icon.Lock css={tw`text-xs mr-2`} />
                                            Lock
                                        </>
                                    )}
                                </DropdownButtonRow>
                                {!backup.isLocked && (
                                    <DropdownButtonRow danger onClick={() => setModal('delete')}>
                                        <Icon.Trash css={tw`text-xs`} />
                                        <span css={tw`ml-2`}>Delete</span>
                                    </DropdownButtonRow>
                                )}
                            </>
                        </Can>
                    </div>
                </DropdownMenu>
            ) : (
                <button
                    onClick={() => setModal('delete')}
                    css={tw`text-gray-200 transition-colors duration-150 hover:text-gray-100 p-2`}
                >
                    <Icon.Trash />
                </button>
            )}
        </>
    );
};
</file>

<file path="resources/scripts/components/server/backups/BackupRow.tsx">
import React from 'react';
import tw from 'twin.macro';
import * as Icon from 'react-feather';
import Can from '@/components/elements/Can';
import { bytesToString } from '@/lib/formatters';
import { ServerBackup } from '@/api/server/types';
import Spinner from '@/components/elements/Spinner';
import { format, formatDistanceToNow } from 'date-fns';
import { SocketEvent } from '@/components/server/events';
import GreyRowBox from '@/components/elements/GreyRowBox';
import getServerBackups from '@/api/swr/getServerBackups';
import useWebsocketEvent from '@/plugins/useWebsocketEvent';
import BackupContextMenu from '@/components/server/backups/BackupContextMenu';

interface Props {
    backup: ServerBackup;
    className?: string;
}

export default ({ backup, className }: Props) => {
    const { mutate } = getServerBackups();

    useWebsocketEvent(`${SocketEvent.BACKUP_COMPLETED}:${backup.uuid}` as SocketEvent, (data) => {
        try {
            const parsed = JSON.parse(data);

            mutate(
                (data) => ({
                    ...data,
                    items: data.items.map((b) =>
                        b.uuid !== backup.uuid
                            ? b
                            : {
                                  ...b,
                                  isSuccessful: parsed.is_successful || true,
                                  checksum: (parsed.checksum_type || '') + ':' + (parsed.checksum || ''),
                                  bytes: parsed.file_size || 0,
                                  completedAt: new Date(),
                              }
                    ),
                }),
                false
            );
        } catch (e) {
            console.warn(e);
        }
    });

    return (
        <GreyRowBox css={tw`flex-wrap md:flex-nowrap items-center`} className={className}>
            <div css={tw`flex items-center truncate w-full md:flex-1`}>
                <div css={tw`mr-4`}>
                    {backup.completedAt !== null ? (
                        backup.isLocked ? (
                            <Icon.Lock css={tw`text-yellow-500`} />
                        ) : (
                            <Icon.Unlock css={tw`text-neutral-300`} />
                        )
                    ) : (
                        <Spinner size={'small'} />
                    )}
                </div>
                <div css={tw`flex flex-col truncate`}>
                    <div css={tw`flex items-center text-sm mb-1`}>
                        {backup.completedAt !== null && !backup.isSuccessful && (
                            <span
                                css={tw`bg-red-500 py-px px-2 rounded-full text-white text-xs uppercase border border-red-600 mr-2`}
                            >
                                Failed
                            </span>
                        )}
                        <p css={tw`break-words truncate`}>{backup.name}</p>
                        {backup.completedAt !== null && backup.isSuccessful && (
                            <span css={tw`ml-3 text-neutral-300 text-xs font-extralight hidden sm:inline`}>
                                {bytesToString(backup.bytes)}
                            </span>
                        )}
                    </div>
                    <p css={tw`mt-1 md:mt-0 text-xs text-neutral-400 font-mono truncate`}>{backup.checksum}</p>
                </div>
            </div>
            <div css={tw`flex-1 md:flex-none md:w-48 mt-4 md:mt-0 md:ml-8 md:text-center`}>
                <p title={format(backup.createdAt, 'ddd, MMMM do, yyyy HH:mm:ss')} css={tw`text-sm`}>
                    {formatDistanceToNow(backup.createdAt, { includeSeconds: true, addSuffix: true })}
                </p>
                <p css={tw`text-2xs text-neutral-500 uppercase mt-1`}>Created</p>
            </div>
            <Can action={['backup.download', 'backup.restore', 'backup.delete']} matchAny>
                <div css={tw`mt-4 md:mt-0 ml-6`} style={{ marginRight: '-0.5rem' }}>
                    {!backup.completedAt ? (
                        <div css={tw`p-2 invisible`}>
                            <Icon.MoreHorizontal />
                        </div>
                    ) : (
                        <BackupContextMenu backup={backup} />
                    )}
                </div>
            </Can>
        </GreyRowBox>
    );
};
</file>

<file path="resources/scripts/components/server/backups/CreateBackupButton.tsx">
import tw from 'twin.macro';
import useFlash from '@/plugins/useFlash';
import Can from '@/components/elements/Can';
import { boolean, object, string } from 'yup';
import { ServerContext } from '@/state/server';
import Field from '@/components/elements/Field';
import React, { useEffect, useState } from 'react';
import { Textarea } from '@/components/elements/Input';
import getServerBackups from '@/api/swr/getServerBackups';
import { Button } from '@/components/elements/button/index';
import FormikSwitch from '@/components/elements/FormikSwitch';
import FlashMessageRender from '@/components/FlashMessageRender';
import Modal, { RequiredModalProps } from '@/components/elements/Modal';
import createServerBackup from '@/api/server/backups/createServerBackup';
import FormikFieldWrapper from '@/components/elements/FormikFieldWrapper';
import { Field as FormikField, Form, Formik, FormikHelpers, useFormikContext } from 'formik';

interface Values {
    name: string;
    ignored: string;
    isLocked: boolean;
}

const ModalContent = ({ ...props }: RequiredModalProps) => {
    const { isSubmitting } = useFormikContext<Values>();

    return (
        <Modal {...props} showSpinnerOverlay={isSubmitting}>
            <Form>
                <FlashMessageRender byKey={'backups:create'} css={tw`mb-4`} />
                <h2 css={tw`text-2xl mb-6`}>Create server backup</h2>
                <Field
                    name={'name'}
                    label={'Backup name'}
                    description={'If provided, the name that should be used to reference this backup.'}
                />
                <div css={tw`mt-6`}>
                    <FormikFieldWrapper
                        name={'ignored'}
                        label={'Ignored Files & Directories'}
                        description={`
                            Enter the files or folders to ignore while generating this backup. Leave blank to use
                            the contents of the .pteroignore file in the root of the server directory if present.
                            Wildcard matching of files and folders is supported in addition to negating a rule by
                            prefixing the path with an exclamation point.
                        `}
                    >
                        <FormikField as={Textarea} name={'ignored'} rows={6} />
                    </FormikFieldWrapper>
                </div>
                <Can action={'backup.delete'}>
                    <div css={tw`mt-6 bg-neutral-700 border border-neutral-800 shadow-inner p-4 rounded`}>
                        <FormikSwitch
                            name={'isLocked'}
                            label={'Locked'}
                            description={'Prevents this backup from being deleted until explicitly unlocked.'}
                        />
                    </div>
                </Can>
                <div css={tw`flex justify-end mt-6`}>
                    <Button type={'submit'} disabled={isSubmitting}>
                        Start backup
                    </Button>
                </div>
            </Form>
        </Modal>
    );
};

export default () => {
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const { clearFlashes, clearAndAddHttpError } = useFlash();
    const [visible, setVisible] = useState(false);
    const { mutate } = getServerBackups();

    useEffect(() => {
        clearFlashes('backups:create');
    }, [visible]);

    const submit = (values: Values, { setSubmitting }: FormikHelpers<Values>) => {
        clearFlashes('backups:create');
        createServerBackup(uuid, values)
            .then((backup) => {
                mutate(
                    (data) => ({ ...data, items: data.items.concat(backup), backupCount: data.backupCount + 1 }),
                    false
                );
                setVisible(false);
            })
            .catch((error) => {
                clearAndAddHttpError({ key: 'backups:create', error });
                setSubmitting(false);
            });
    };

    return (
        <>
            {visible && (
                <Formik
                    onSubmit={submit}
                    initialValues={{ name: '', ignored: '', isLocked: false }}
                    validationSchema={object().shape({
                        name: string().max(191),
                        ignored: string(),
                        isLocked: boolean(),
                    })}
                >
                    <ModalContent appear visible={visible} onDismissed={() => setVisible(false)} />
                </Formik>
            )}
            <Button css={tw`w-full sm:w-auto`} onClick={() => setVisible(true)}>
                Create backup
            </Button>
        </>
    );
};
</file>

<file path="resources/scripts/components/server/console/chart.ts">
import {
    Chart as ChartJS,
    ChartData,
    ChartDataset,
    ChartOptions,
    Filler,
    LinearScale,
    LineElement,
    PointElement,
} from 'chart.js';
import { DeepPartial } from 'ts-essentials';
import { useState } from 'react';
import { deepmerge, deepmergeCustom } from 'deepmerge-ts';
import { theme } from 'twin.macro';
import { hexToRgba } from '@/lib/helpers';

ChartJS.register(LineElement, PointElement, Filler, LinearScale);

const options: ChartOptions<'line'> = {
    responsive: true,
    animation: false,
    plugins: {
        legend: { display: false },
        title: { display: false },
        tooltip: { enabled: false },
    },
    layout: {
        padding: 0,
    },
    scales: {
        x: {
            min: 0,
            max: 19,
            type: 'linear',
            grid: {
                display: false,
                drawBorder: false,
            },
            ticks: {
                display: false,
            },
        },
        y: {
            min: 0,
            type: 'linear',
            ticks: {
                display: true,
                count: 5,
                color: theme('colors.gray.700'),
                font: {
                    family: theme('fontFamily.sans'),
                    size: 10,
                    weight: '400',
                },
            },
        },
    },
    elements: {
        point: {
            radius: 0,
        },
        line: {
            tension: 0.15,
        },
    },
};

function getOptions(opts?: DeepPartial<ChartOptions<'line'>> | undefined): ChartOptions<'line'> {
    return deepmerge(options, opts || {});
}

type ChartDatasetCallback = (value: ChartDataset<'line'>, index: number) => ChartDataset<'line'>;

function getEmptyData(label: string, sets = 1, callback?: ChartDatasetCallback | undefined): ChartData<'line'> {
    const next = callback || ((value) => value);

    return {
        labels: Array(20)
            .fill(0)
            .map((_, index) => index),
        datasets: Array(sets)
            .fill(0)
            .map((_, index) =>
                next(
                    {
                        fill: true,
                        label,
                        data: Array(20).fill(-5),
                        borderColor: theme('colors.green.400'),
                        backgroundColor: hexToRgba(theme('colors.green.700'), 0.5),
                    },
                    index
                )
            ),
    };
}

const merge = deepmergeCustom({ mergeArrays: false });

interface UseChartOptions {
    sets: number;
    options?: DeepPartial<ChartOptions<'line'>> | number | undefined;
    callback?: ChartDatasetCallback | undefined;
}

function useChart(label: string, opts?: UseChartOptions) {
    const options = getOptions(
        typeof opts?.options === 'number' ? { scales: { y: { min: 0, suggestedMax: opts.options } } } : opts?.options
    );
    const [data, setData] = useState(getEmptyData(label, opts?.sets || 1, opts?.callback));

    const push = (items: number | null | (number | null)[]) =>
        setData((state) =>
            merge(state, {
                datasets: (Array.isArray(items) ? items : [items]).map((item, index) => ({
                    ...state.datasets[index],
                    data: state.datasets[index].data
                        .slice(1)
                        .concat(typeof item === 'number' ? Number(item.toFixed(2)) : item),
                })),
            })
        );

    const clear = () =>
        setData((state) =>
            merge(state, {
                datasets: state.datasets.map((value) => ({
                    ...value,
                    data: Array(20).fill(-5),
                })),
            })
        );

    return { props: { data, options }, push, clear };
}

function useChartTickLabel(label: string, max: number, tickLabel: string, roundTo?: number) {
    return useChart(label, {
        sets: 1,
        options: {
            scales: {
                y: {
                    suggestedMax: max,
                    ticks: {
                        callback(value) {
                            return `${roundTo ? Number(value).toFixed(roundTo) : value}${tickLabel}`;
                        },
                    },
                },
            },
        },
    });
}

export { useChart, useChartTickLabel, getOptions, getEmptyData };
</file>

<file path="resources/scripts/components/server/console/ChartBlock.tsx">
import React from 'react';
import classNames from 'classnames';
import styles from '@/components/server/console/style.module.css';

interface ChartBlockProps {
    title: string;
    legend?: React.ReactNode;
    children: React.ReactNode;
}

export default ({ title, legend, children }: ChartBlockProps) => (
    <div className={classNames(styles.chart_container, 'group', 'j-up')}>
        <div className={'flex items-center justify-between px-4 py-2'}>
            <h3 className={'font-header transition-colors duration-100 group-hover:text-gray-50'}>{title}</h3>
            {legend && <p className={'text-sm flex items-center'}>{legend}</p>}
        </div>
        <div className={'z-10 ml-2'}>{children}</div>
    </div>
);
</file>

<file path="resources/scripts/components/server/console/Console.tsx">
import 'xterm/css/xterm.css';
import classNames from 'classnames';
import * as Icon from 'react-feather';
import styles from './style.module.css';
import { FitAddon } from 'xterm-addon-fit';
import { theme as th } from 'twin.macro';
import { SearchAddon } from 'xterm-addon-search';
import { Terminal, ITerminalOptions } from 'xterm';
import { WebLinksAddon } from 'xterm-addon-web-links';
import { SearchBarAddon } from 'xterm-addon-search-bar';
import React, { useEffect, useMemo, useRef, useState } from 'react';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import { ServerContext } from '@/state/server';
import { usePermissions } from '@/plugins/usePermissions';
import useEventListener from '@/plugins/useEventListener';
import { debounce } from 'debounce';
import { usePersistedState } from '@/plugins/usePersistedState';
import { SocketEvent, SocketRequest } from '@/components/server/events';
import 'xterm/css/xterm.css';
import Tooltip from '@/components/elements/tooltip/Tooltip';

const theme = {
    background: th`colors.black`.toString(),
    cursor: 'transparent',
    black: th`colors.black`.toString(),
    red: '#E54B4B',
    green: '#9ECE58',
    yellow: '#FAED70',
    blue: '#396FE2',
    magenta: '#BB80B3',
    cyan: '#2DDAFD',
    white: '#d0d0d0',
    brightBlack: 'rgba(255, 255, 255, 0.2)',
    brightRed: '#FF5370',
    brightGreen: '#C3E88D',
    brightYellow: '#FFCB6B',
    brightBlue: '#82AAFF',
    brightMagenta: '#C792EA',
    brightCyan: '#89DDFF',
    brightWhite: '#ffffff',
    selection: '#FAF089',
};

const terminalProps: ITerminalOptions = {
    disableStdin: true,
    cursorStyle: 'underline',
    allowTransparency: true,
    fontSize: 12,
    fontFamily: th('fontFamily.mono'),
    rows: 50,
    theme: theme,
};

export default () => {
    const TERMINAL_PRELUDE = '\u001b[1m\u001b[33mJexactyl: \u001b[0m';
    const ref = useRef<HTMLDivElement>(null);
    const terminal = useMemo(() => new Terminal({ ...terminalProps }), []);
    const fitAddon = new FitAddon();
    const searchAddon = new SearchAddon();
    const webLinksAddon = new WebLinksAddon();
    const searchBar = new SearchBarAddon({ searchAddon });
    const [historyIndex, setHistoryIndex] = useState(-1);
    const isConsoleDetached = location.pathname.endsWith('/console');
    const [canSendCommands] = usePermissions(['control.console']);
    const serverId = ServerContext.useStoreState((state) => state.server.data!.id);
    const { connected, instance } = ServerContext.useStoreState((state) => state.socket);
    const isTransferring = ServerContext.useStoreState((state) => state.server.data!.isTransferring);
    const [history, setHistory] = usePersistedState<string[]>(`${serverId}:command_history`, []);

    const zIndex = `
    .xterm-search-bar__addon {
        z-index: 10;
    }`;

    const handleConsoleOutput = (line: string, prelude = false) =>
        terminal.writeln((prelude ? TERMINAL_PRELUDE : '') + line.replace(/(?:\r\n|\r|\n)$/im, '') + '\u001b[0m');

    const handleTransferStatus = (status: string) => {
        switch (status) {
            // Sent by either the source or target node if a failure occurs.
            case 'failure':
                terminal.writeln(TERMINAL_PRELUDE + 'Transfer has failed.\u001b[0m');
                return;
        }
    };

    const popout = () => {
        window.open(window.location.href + '/console', 'Server Console', 'height=400,width=800');
    };

    const handleDaemonErrorOutput = (line: string) =>
        terminal.writeln(
            TERMINAL_PRELUDE + '\u001b[1m\u001b[41m' + line.replace(/(?:\r\n|\r|\n)$/im, '') + '\u001b[0m'
        );

    const handlePowerChangeEvent = (state: string) =>
        terminal.writeln(TERMINAL_PRELUDE + 'Server marked as ' + state + '...\u001b[0m');

    const handleCommandKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
        if (e.key === 'ArrowUp') {
            const newIndex = Math.min(historyIndex + 1, history!.length - 1);

            setHistoryIndex(newIndex);
            e.currentTarget.value = history![newIndex] || '';

            // By default up arrow will also bring the cursor to the start of the line,
            // so we'll preventDefault to keep it at the end.
            e.preventDefault();
        }

        if (e.key === 'ArrowDown') {
            const newIndex = Math.max(historyIndex - 1, -1);

            setHistoryIndex(newIndex);
            e.currentTarget.value = history![newIndex] || '';
        }

        const command = e.currentTarget.value;
        if (e.key === 'Enter' && command.length > 0) {
            setHistory((prevHistory) => [command, ...prevHistory!].slice(0, 32));
            setHistoryIndex(-1);

            instance && instance.send('send command', command);
            e.currentTarget.value = '';
        }
    };

    useEffect(() => {
        if (connected && ref.current && !terminal.element) {
            terminal.loadAddon(fitAddon);
            terminal.loadAddon(searchAddon);
            terminal.loadAddon(searchBar);
            terminal.loadAddon(webLinksAddon);

            terminal.open(ref.current);
            fitAddon.fit();
            searchBar.addNewStyle(zIndex);

            // Add support for capturing keys
            terminal.attachCustomKeyEventHandler((e: KeyboardEvent) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
                    document.execCommand('copy');
                    return false;
                } else if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    searchBar.show();
                    return false;
                } else if (e.key === 'Escape') {
                    searchBar.hidden();
                }
                return true;
            });
        }
    }, [terminal, connected]);

    useEventListener(
        'resize',
        debounce(() => {
            if (terminal.element) {
                fitAddon.fit();
            }
        }, 100)
    );

    useEffect(() => {
        const listeners: Record<string, (s: string) => void> = {
            [SocketEvent.STATUS]: handlePowerChangeEvent,
            [SocketEvent.CONSOLE_OUTPUT]: handleConsoleOutput,
            [SocketEvent.INSTALL_OUTPUT]: handleConsoleOutput,
            [SocketEvent.TRANSFER_LOGS]: handleConsoleOutput,
            [SocketEvent.TRANSFER_STATUS]: handleTransferStatus,
            [SocketEvent.DAEMON_MESSAGE]: (line) => handleConsoleOutput(line, true),
            [SocketEvent.DAEMON_ERROR]: handleDaemonErrorOutput,
        };

        if (connected && instance) {
            // Do not clear the console if the server is being transferred.
            if (!isTransferring) {
                terminal.clear();
            }

            Object.keys(listeners).forEach((key: string) => {
                instance.addListener(key, listeners[key]);
            });
            instance.send(SocketRequest.SEND_LOGS);
        }

        return () => {
            if (instance) {
                Object.keys(listeners).forEach((key: string) => {
                    instance.removeListener(key, listeners[key]);
                });
            }
        };
    }, [connected, instance]);

    return (
        <div className={classNames(styles.terminal, 'relative')}>
            <SpinnerOverlay visible={!connected} size={'large'} />
            <div
                className={classNames(styles.container, styles.overflows_container, { 'rounded-b': !canSendCommands })}
            >
                <div id={styles.terminal} ref={ref} />
            </div>
            {canSendCommands && (
                <div className={classNames('relative', styles.overflows_container)}>
                    <input
                        className={classNames('peer', styles.command_input)}
                        type={'text'}
                        id={'console_input'}
                        aria-label={'Console command input.'}
                        disabled={!instance || !connected}
                        onKeyDown={handleCommandKeyDown}
                        autoCorrect={'off'}
                        autoCapitalize={'none'}
                    />
                    <div className={classNames('text-gray-100', styles.command_icon)}>
                        {!isConsoleDetached && (
                            <Tooltip content={'Launch console in external window'}>
                                <Icon.ExternalLink className={'w-4 h-4'} onClick={() => popout()} />
                            </Tooltip>
                        )}
                        <Tooltip content={'Type a command...'}>
                            <Icon.ChevronsRight
                                className={'w-4 h-4 ml-2 hover:animate-pulse'}
                                onClick={() => {
                                    // @ts-expect-error this is valid
                                    document.getElementById('console_input').focus();
                                }}
                            />
                        </Tooltip>
                    </div>
                </div>
            )}
        </div>
    );
};
</file>

<file path="resources/scripts/components/server/console/ConsoleShareContainer.tsx">
import stripAnsi from 'strip-ansi';
import useFlash from '@/plugins/useFlash';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import React, { useEffect, useState } from 'react';
import { SocketEvent } from '@/components/server/events';
import saveFileContents from '@/api/server/files/saveFileContents';

export default () => {
    const [log, setLog] = useState<string[]>([]);

    const { addFlash, clearFlashes } = useFlash();
    const status = ServerContext.useStoreState((state) => state.status.value);
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const { connected, instance } = ServerContext.useStoreState((state) => state.socket);

    const addLog = (data: string) => {
        setLog((prevLog) => [...prevLog, data.startsWith('>') ? data.substring(1) : data]);
    };

    const submit = () => {
        clearFlashes('console:share');

        const data = stripAnsi(log.map((it) => it.replace('\r', '')).join('\n')) || '';

        saveFileContents(uuid, '/share/console-' + new Date().toLocaleTimeString() + '.txt', data)
            .then(() => {
                addFlash({
                    key: 'console:share',
                    type: 'success',
                    message: 'Your server logs have been saved to the /share folder.',
                });
            })
            .catch((error) => {
                addFlash({ key: 'console:share', type: 'danger', message: httpErrorToHuman(error) });
            });
    };

    useEffect(() => {
        if (!connected || !instance) return;

        instance.addListener(SocketEvent.CONSOLE_OUTPUT, addLog);

        return () => {
            instance.removeListener(SocketEvent.CONSOLE_OUTPUT, addLog);
        };
    }, [connected, instance]);

    return (
        <>
            {status === 'offline' ? (
                <span className={'text-gray-400'}>Offline</span>
            ) : (
                <div className={'cursor-pointer'} onClick={submit}>
                    Save
                </div>
            )}
        </>
    );
};
</file>

<file path="resources/scripts/components/server/console/PowerButtons.tsx">
import React, { useEffect, useState } from 'react';
import { Button } from '@/components/elements/button/index';
import Can from '@/components/elements/Can';
import { ServerContext } from '@/state/server';
import { PowerAction } from '@/components/server/console/ServerConsoleContainer';
import { Dialog } from '@/components/elements/dialog';

interface PowerButtonProps {
    className?: string;
}

export default ({ className }: PowerButtonProps) => {
    const [open, setOpen] = useState(false);
    const status = ServerContext.useStoreState((state) => state.status.value);
    const instance = ServerContext.useStoreState((state) => state.socket.instance);

    const killable = status === 'stopping';
    const onButtonClick = (
        action: PowerAction | 'kill-confirmed',
        e: React.MouseEvent<HTMLButtonElement, MouseEvent>
    ): void => {
        e.preventDefault();
        if (action === 'kill') {
            return setOpen(true);
        }

        if (instance) {
            setOpen(false);
            instance.send('set state', action === 'kill-confirmed' ? 'kill' : action);
        }
    };

    useEffect(() => {
        if (status === 'offline') {
            setOpen(false);
        }
    }, [status]);

    return (
        <div className={className}>
            <Dialog.Confirm
                open={open}
                hideCloseIcon
                onClose={() => setOpen(false)}
                title={'Forcibly Stop Process'}
                confirm={'Continue'}
                onConfirmed={onButtonClick.bind(this, 'kill-confirmed')}
            >
                Forcibly stopping a server can lead to data corruption.
            </Dialog.Confirm>
            <Can action={'control.start'}>
                <Button.Success
                    className={'flex-1'}
                    disabled={status !== 'offline'}
                    onClick={onButtonClick.bind(this, 'start')}
                >
                    Start
                </Button.Success>
            </Can>
            <Can action={'control.restart'}>
                <Button.Text className={'flex-1'} disabled={!status} onClick={onButtonClick.bind(this, 'restart')}>
                    Restart
                </Button.Text>
            </Can>
            <Can action={'control.stop'}>
                <Button.Danger
                    className={'flex-1'}
                    disabled={status === 'offline'}
                    onClick={onButtonClick.bind(this, killable ? 'kill' : 'stop')}
                >
                    {killable ? 'Kill' : 'Stop'}
                </Button.Danger>
            </Can>
        </div>
    );
};
</file>

<file path="resources/scripts/components/server/console/RenewalInfo.tsx">
import React, { useState } from 'react';
import useFlash from '@/plugins/useFlash';
import { httpErrorToHuman } from '@/api/http';
import { useStoreState } from '@/state/hooks';
import { ServerContext } from '@/state/server';
import renewServer from '@/api/server/renewServer';
import { Dialog } from '@/components/elements/dialog';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';

export default () => {
    const [open, setOpen] = useState(false);
    const { addFlash, clearFlashes } = useFlash();
    const [loading, setLoading] = useState(false);
    const store = useStoreState((state) => state.storefront.data!);
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const renewal = ServerContext.useStoreState((state) => state.server.data!.renewal);

    const doRenewal = () => {
        setLoading(true);
        clearFlashes('console:share');

        renewServer(uuid)
            .then(() => {
                setOpen(false);
                setLoading(false);

                addFlash({
                    key: 'console:share',
                    type: 'success',
                    message: 'Server has been renewed.',
                });
            })
            .catch((error) => {
                setOpen(false);
                setLoading(false);

                console.log(httpErrorToHuman(error));
                addFlash({
                    key: 'console:share',
                    type: 'danger',
                    message: 'Unable to renew your server. Are you sure you have enough credits?',
                });
            });
    };

    return (
        <>
            <Dialog.Confirm
                open={open}
                onClose={() => setOpen(false)}
                title={'Confirm server renewal'}
                onConfirmed={() => doRenewal()}
            >
                <SpinnerOverlay visible={loading} />
                You will be charged {store.renewals.cost} credits to add {store.renewals.days} days until your next
                renewal is due.
            </Dialog.Confirm>
            in {renewal} days{' '}
            <span className={'text-blue-500 text-sm cursor-pointer'} onClick={() => setOpen(true)}>
                {'('}Renew{')'}
            </span>
        </>
    );
};
</file>

<file path="resources/scripts/components/server/console/ServerConsoleContainer.tsx">
import React, { memo } from 'react';
import isEqual from 'react-fast-compare';
import Features from '@feature/Features';
import Can from '@/components/elements/Can';
import { ServerContext } from '@/state/server';
import Spinner from '@/components/elements/Spinner';
import { Alert } from '@/components/elements/alert';
import Console from '@/components/server/console/Console';
import PowerButtons from '@/components/server/console/PowerButtons';
import ServerContentBlock from '@/components/elements/ServerContentBlock';
import ServerDetailsBlock from '@/components/server/console/ServerDetailsBlock';

export type PowerAction = 'start' | 'stop' | 'restart' | 'kill';

const ServerConsoleContainer = () => {
    const name = ServerContext.useStoreState((state) => state.server.data!.name);
    const isInstalling = ServerContext.useStoreState((state) => state.server.isInstalling);
    const description = ServerContext.useStoreState((state) => state.server.data!.description);
    const isTransferring = ServerContext.useStoreState((state) => state.server.data!.isTransferring);
    const eggFeatures = ServerContext.useStoreState((state) => state.server.data!.eggFeatures, isEqual);
    const isNodeUnderMaintenance = ServerContext.useStoreState((state) => state.server.data!.isNodeUnderMaintenance);

    return (
        <ServerContentBlock title={'Console'} showFlashKey={'console:share'}>
            {(isNodeUnderMaintenance || isInstalling || isTransferring) && (
                <Alert type={'warning'} className={'mb-4'}>
                    {isNodeUnderMaintenance
                        ? 'The node of this server is currently under maintenance and all actions are unavailable.'
                        : isInstalling
                        ? 'This server is currently running its installation process and most actions are unavailable.'
                        : 'This server is currently being transferred to another node and all actions are unavailable.'}
                </Alert>
            )}
            <div className={'grid grid-cols-4 gap-4 mb-4'}>
                <div className={'hidden sm:block sm:col-span-2 lg:col-span-3 pr-4'}>
                    <h1 className={'font-header text-2xl text-gray-50 leading-relaxed line-clamp-1'}>{name}</h1>
                    <p className={'text-sm line-clamp-2'}>{description}</p>
                </div>
                <div className={'flex-1'}>
                    <Can action={['control.start', 'control.stop', 'control.restart']} matchAny>
                        <PowerButtons className={'flex sm:justify-end space-x-2'} />
                    </Can>
                </div>
            </div>
            <div className={'grid grid-cols-4 gap-2 sm:gap-4 mb-8'}>
                <div className={'col-span-4 lg:col-span-3'}>
                    <Spinner.Suspense>
                        <Console />
                    </Spinner.Suspense>
                </div>
                <ServerDetailsBlock className={'col-span-4 lg:col-span-1 order-last lg:order-none'} />
            </div>
            <Features enabled={eggFeatures} />
        </ServerContentBlock>
    );
};

export default memo(ServerConsoleContainer, isEqual);
</file>

<file path="resources/scripts/components/server/console/ServerDetailsBlock.tsx">
import classNames from 'classnames';
import { ServerContext } from '@/state/server';
import React, { useEffect, useMemo, useState } from 'react';
import useWebsocketEvent from '@/plugins/useWebsocketEvent';
import ConsoleShareContainer from './ConsoleShareContainer';
import StatBlock from '@/components/server/console/StatBlock';
import UptimeDuration from '@/components/server/UptimeDuration';
import { bytesToString, ip, mbToBytes } from '@/lib/formatters';
import { SocketEvent, SocketRequest } from '@/components/server/events';
import { faClock, faHdd, faMemory, faMicrochip, faScroll, faWifi } from '@fortawesome/free-solid-svg-icons';
import { capitalize } from '@/lib/strings';
import styled from 'styled-components/macro';
import tw from 'twin.macro';
import RenewalInfo from './RenewalInfo';
import { useStoreState } from '@/state/hooks';

type Stats = Record<'memory' | 'cpu' | 'disk' | 'uptime', number>;

const Limit = ({ limit, children }: { limit: string | null; children: React.ReactNode }) => (
    <>
        {children}
        <span className={'ml-1 text-gray-300 text-[70%] select-none'}>/ {limit || <>&infin;</>}</span>
    </>
);

const Bar = styled.div`
    ${tw`h-0.5 bg-cyan-400`};
    transition: 500ms ease-in-out;
`;

export default ({ className }: { className?: string }) => {
    const [stats, setStats] = useState<Stats>({ memory: 0, cpu: 0, disk: 0, uptime: 0 });

    const status = ServerContext.useStoreState((state) => state.status.value);
    const instance = ServerContext.useStoreState((state) => state.socket.instance);
    const connected = ServerContext.useStoreState((state) => state.socket.connected);
    const limits = ServerContext.useStoreState((state) => state.server.data!.limits);
    const renewable = ServerContext.useStoreState((state) => state.server.data!.renewable);
    const renewalEnabled = useStoreState((state) => state.storefront.data!.renewals);

    const textLimits = useMemo(
        () => ({
            cpu: limits?.cpu ? `${limits.cpu}%` : null,
            memory: limits?.memory ? bytesToString(mbToBytes(limits.memory)) : null,
            disk: limits?.disk ? bytesToString(mbToBytes(limits.disk)) : null,
        }),
        [limits]
    );

    const allocation = ServerContext.useStoreState((state) => {
        const match = state.server.data!.allocations.find((allocation) => allocation.isDefault);

        return !match ? 'n/a' : `${match.alias || ip(match.ip)}:${match.port}`;
    });

    useEffect(() => {
        if (!connected || !instance) {
            return;
        }

        instance.send(SocketRequest.SEND_STATS);
    }, [instance, connected]);

    useWebsocketEvent(SocketEvent.STATS, (data) => {
        let stats: any = {};
        try {
            stats = JSON.parse(data);
        } catch (e) {
            return;
        }

        setStats({
            memory: stats.memory_bytes,
            cpu: stats.cpu_absolute,
            disk: stats.disk_bytes,
            uptime: stats.uptime || 0,
        });
    });

    const cpuUsed = stats.cpu / (limits.cpu / 100);
    const diskUsed = (stats.disk / 1024 / 1024 / limits.disk) * 100;
    const memoryUsed = (stats.memory / 1024 / 1024 / limits.memory) * 100;

    return (
        <div className={classNames('grid grid-cols-6 gap-2 md:gap-4', className)}>
            <StatBlock icon={faClock} title={'Uptime'}>
                {status === null ? (
                    'Offline'
                ) : stats.uptime > 0 ? (
                    <UptimeDuration uptime={stats.uptime / 1000} />
                ) : (
                    capitalize(status)
                )}
            </StatBlock>
            <StatBlock icon={faWifi} title={'Address'} copyOnClick={allocation}>
                {allocation}
            </StatBlock>
            <StatBlock icon={faMicrochip} title={'CPU'}>
                {status === 'offline' ? (
                    <span className={'text-gray-400'}>Offline</span>
                ) : (
                    <Limit limit={textLimits.cpu}>{stats.cpu.toFixed(2)}%</Limit>
                )}
                {cpuUsed > 100 ? (
                    <Bar style={{ width: '100%' }} css={tw`bg-red-500`} />
                ) : limits.cpu === 0 ? (
                    <Bar style={{ width: '100%' }} css={tw`bg-neutral-900`} />
                ) : (
                    <Bar style={{ width: cpuUsed === undefined ? '100%' : `${cpuUsed}%` }} />
                )}
            </StatBlock>
            <StatBlock icon={faMemory} title={'Memory'}>
                {status === 'offline' ? (
                    <span className={'text-gray-400'}>Offline</span>
                ) : (
                    <Limit limit={textLimits.memory}>{bytesToString(stats.memory)}</Limit>
                )}
                {memoryUsed > 90 ? (
                    <Bar style={{ width: '100%' }} css={tw`bg-red-500`} />
                ) : limits.memory === 0 ? (
                    <Bar style={{ width: '100%' }} css={tw`bg-neutral-900`} />
                ) : (
                    <Bar style={{ width: memoryUsed === undefined ? '100%' : `${memoryUsed}%` }} />
                )}
            </StatBlock>
            <StatBlock icon={faHdd} title={'Disk'}>
                <Limit limit={textLimits.disk}>{bytesToString(stats.disk)}</Limit>
                {diskUsed > 90 ? (
                    <Bar style={{ width: '100%' }} css={tw`bg-red-500`} />
                ) : limits.disk === 0 ? (
                    <Bar style={{ width: '100%' }} css={tw`bg-neutral-900`} />
                ) : (
                    <Bar style={{ width: diskUsed === undefined ? '100%' : `${diskUsed}%` }} />
                )}
            </StatBlock>
            <StatBlock icon={faScroll} title={'Save Console Logs'}>
                <ConsoleShareContainer />
            </StatBlock>
            {renewable && renewalEnabled && (
                <StatBlock icon={faClock} title={'Renewal Date'}>
                    <RenewalInfo />
                </StatBlock>
            )}
        </div>
    );
};
</file>

<file path="resources/scripts/components/server/console/StatBlock.tsx">
import React from 'react';
import classNames from 'classnames';
import useFitText from 'use-fit-text';
import styles from './style.module.css';
import Icon from '@/components/elements/Icon';
import CopyOnClick from '@/components/elements/CopyOnClick';
import { IconDefinition } from '@fortawesome/free-solid-svg-icons';

interface Props {
    title?: string | undefined;
    copyOnClick?: string;
    color?: string | undefined;
    icon: IconDefinition;
    children: React.ReactNode;
    className?: string;
}

export default ({ title, copyOnClick, icon, color, className, children }: Props) => {
    const { fontSize, ref } = useFitText({ minFontSize: 8, maxFontSize: 500 });

    return (
        <CopyOnClick text={copyOnClick}>
            <div className={classNames(styles.stat_block, className)}>
                <div className={classNames(styles.status_bar, color || 'bg-gray-700')} />
                <div className={classNames(styles.icon, color || 'bg-gray-700')}>
                    <Icon
                        icon={icon}
                        className={classNames({
                            'text-gray-100': 'bg-gray-700',
                            'text-gray-50': 'bg-gray-700',
                        })}
                    />
                </div>
                <div className={'flex flex-col justify-center overflow-hidden w-full'}>
                    {title && <p className={'font-header leading-tight text-xs md:text-sm text-gray-200'}>{title}</p>}
                    <div
                        ref={ref}
                        className={'h-[2rem] w-full font-semibold text-gray-50 truncate'}
                        style={{ fontSize }}
                    >
                        {children}
                    </div>
                </div>
            </div>
        </CopyOnClick>
    );
};
</file>

<file path="resources/scripts/components/server/console/StatGraphs.tsx">
import { Line } from 'react-chartjs-2';
import { ServerContext } from '@/state/server';
import { bytesToString } from '@/lib/formatters';
import React, { useEffect, useRef } from 'react';
import { SocketEvent } from '@/components/server/events';
import useWebsocketEvent from '@/plugins/useWebsocketEvent';
import ChartBlock from '@/components/server/console/ChartBlock';
import { useChart, useChartTickLabel } from '@/components/server/console/chart';

export default () => {
    const status = ServerContext.useStoreState((state) => state.status.value);
    const limits = ServerContext.useStoreState((state) => state.server.data!.limits);
    const previous = useRef<Record<'tx' | 'rx', number>>({ tx: -1, rx: -1 });

    const cpu = useChartTickLabel('CPU', limits.cpu, '%', 2);
    const disk = useChartTickLabel('Disk', limits.disk, 'MiB');
    const memory = useChartTickLabel('Memory', limits.memory, 'MiB');
    const networkIn = useChart('Network In', {
        sets: 1,
        options: {
            scales: {
                y: {
                    ticks: {
                        callback(value) {
                            return bytesToString(typeof value === 'string' ? parseInt(value, 10) : value);
                        },
                    },
                },
            },
        },
        callback(opts) {
            return {
                ...opts,
                label: 'Network In',
            };
        },
    });
    const networkOut = useChart('Network In', {
        sets: 1,
        options: {
            scales: {
                y: {
                    ticks: {
                        callback(value) {
                            return bytesToString(typeof value === 'string' ? parseInt(value, 10) : value);
                        },
                    },
                },
            },
        },
        callback(opts) {
            return {
                ...opts,
                label: 'Network Out',
            };
        },
    });

    useEffect(() => {
        if (status === 'offline') {
            cpu.clear();
            disk.clear();
            memory.clear();
            networkIn.clear();
            networkOut.clear();
        }
    }, [status]);

    useWebsocketEvent(SocketEvent.STATS, (data: string) => {
        let values: any = {};
        try {
            values = JSON.parse(data);
        } catch (e) {
            return;
        }

        cpu.push(values.cpu_absolute);
        disk.push(Math.floor(values.disk_bytes / 1024 / 1024));
        memory.push(Math.floor(values.memory_bytes / 1024 / 1024));
        networkIn.push(previous.current.tx < 0 ? 0 : Math.max(0, values.network.tx_bytes - previous.current.tx));
        networkOut.push(previous.current.rx < 0 ? 0 : Math.max(0, values.network.rx_bytes - previous.current.rx));

        previous.current = { tx: values.network.tx_bytes, rx: values.network.rx_bytes };
    });

    return (
        <>
            <ChartBlock title={'CPU Load'}>
                <Line {...cpu.props} />
            </ChartBlock>
            <ChartBlock title={'Disk'}>
                <Line {...disk.props} />
            </ChartBlock>
            <ChartBlock title={'Memory'}>
                <Line {...memory.props} />
            </ChartBlock>
            <ChartBlock title={'Network In'}>
                <Line {...networkIn.props} />
            </ChartBlock>
            <ChartBlock title={'Network Out'}>
                <Line {...networkOut.props} />
            </ChartBlock>
        </>
    );
};
</file>

<file path="resources/scripts/components/server/console/style.module.css">
.stat_block {
    @apply flex items-center rounded shadow-lg relative;
    @apply col-span-3 md:col-span-2 lg:col-span-6;
    @apply px-3 py-2 md:p-3 lg:p-4;
    @apply bg-neutral-800;

    & > .status_bar {
        @apply w-1 h-full absolute left-0 top-0 rounded-l sm:hidden;
    }

    & > .icon {
        @apply hidden flex-shrink-0 items-center justify-center rounded-lg shadow-md w-12 h-12;
        @apply transition-colors duration-500;
        @apply sm:flex sm:mr-4;

        & > svg {
            @apply w-6 h-6 m-auto;
        }
    }
}

.terminal {
    @apply flex flex-col w-full;

    & .overflows_container {
        @apply -ml-4 sm:ml-0;
        width: calc(100% + 2rem);

        @screen sm {
            @apply w-full;
        }
    }

    & > .container {
        @apply rounded-t p-1 sm:p-2 bg-black min-h-[16rem] flex-1 font-mono text-sm;

        & #terminal {
            @apply h-full;

            &::-webkit-scrollbar-track {
                @apply w-2;
            }

            &::-webkit-scrollbar-thumb {
                @apply bg-gray-900;
            }
        }
    }

    & .command_icon {
        @apply flex items-center top-0 left-0 absolute z-10 select-none h-full px-3 transition-colors duration-100;
    }

    & .command_input {
        @apply relative bg-gray-800 px-2 text-gray-100 pl-16 pr-4 py-2 w-full font-mono text-sm sm:rounded-b;
        @apply focus:ring-0 outline-none focus-visible:outline-none;
        @apply border-0 border-b-2 border-transparent transition-colors duration-100;
        @apply active:border-cyan-500 focus:border-cyan-500;
    }
}

.chart_container {
    @apply bg-neutral-800 rounded shadow-lg pt-2 border-b-4 border-gray-700 relative;
}
</file>

<file path="resources/scripts/components/server/databases/CreateDatabaseButton.tsx">
import tw from 'twin.macro';
import { object, string } from 'yup';
import React, { useState } from 'react';
import useFlash from '@/plugins/useFlash';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import Modal from '@/components/elements/Modal';
import Field from '@/components/elements/Field';
import { Form, Formik, FormikHelpers } from 'formik';
import { Button } from '@/components/elements/button/index';
import FlashMessageRender from '@/components/FlashMessageRender';
import createServerDatabase from '@/api/server/databases/createServerDatabase';

interface Values {
    databaseName: string;
    connectionsFrom: string;
}

const schema = object().shape({
    databaseName: string()
        .required('A database name must be provided.')
        .min(3, 'Database name must be at least 3 characters.')
        .max(48, 'Database name must not exceed 48 characters.')
        .matches(
            /^[\w\-.]{3,48}$/,
            'Database name should only contain alphanumeric characters, underscores, dashes, and/or periods.'
        ),
    connectionsFrom: string().matches(/^[\w\-/.%:]+$/, 'A valid host address must be provided.'),
});

export default () => {
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const { addError, clearFlashes } = useFlash();
    const [visible, setVisible] = useState(false);

    const appendDatabase = ServerContext.useStoreActions((actions) => actions.databases.appendDatabase);

    const submit = (values: Values, { setSubmitting }: FormikHelpers<Values>) => {
        clearFlashes('database:create');
        createServerDatabase(uuid, {
            databaseName: values.databaseName,
            connectionsFrom: values.connectionsFrom || '%',
        })
            .then((database) => {
                appendDatabase(database);
                setVisible(false);
            })
            .catch((error) => {
                addError({ key: 'database:create', message: httpErrorToHuman(error) });
                setSubmitting(false);
            });
    };

    return (
        <>
            <Formik
                onSubmit={submit}
                initialValues={{ databaseName: '', connectionsFrom: '' }}
                validationSchema={schema}
            >
                {({ isSubmitting, resetForm }) => (
                    <Modal
                        visible={visible}
                        dismissable={!isSubmitting}
                        showSpinnerOverlay={isSubmitting}
                        onDismissed={() => {
                            resetForm();
                            setVisible(false);
                        }}
                    >
                        <FlashMessageRender byKey={'database:create'} css={tw`mb-6`} />
                        <h2 css={tw`text-2xl mb-6`}>Create new database</h2>
                        <Form css={tw`m-0`}>
                            <Field
                                type={'string'}
                                id={'database_name'}
                                name={'databaseName'}
                                label={'Database Name'}
                                description={'A descriptive name for your database instance.'}
                            />
                            <div css={tw`mt-6`}>
                                <Field
                                    type={'string'}
                                    id={'connections_from'}
                                    name={'connectionsFrom'}
                                    label={'Connections From'}
                                    description={
                                        'Where connections should be allowed from. Leave blank to allow connections from anywhere.'
                                    }
                                />
                            </div>
                            <div css={tw`flex flex-wrap justify-end mt-6`}>
                                <Button
                                    type={'button'}
                                    variant={Button.Variants.Secondary}
                                    css={tw`w-full sm:w-auto sm:mr-2`}
                                    onClick={() => setVisible(false)}
                                >
                                    Cancel
                                </Button>
                                <Button css={tw`w-full mt-4 sm:w-auto sm:mt-0`} type={'submit'}>
                                    Create Database
                                </Button>
                            </div>
                        </Form>
                    </Modal>
                )}
            </Formik>
            <Button onClick={() => setVisible(true)}>New Database</Button>
        </>
    );
};
</file>

<file path="resources/scripts/components/server/databases/DatabaseRow.tsx">
import tw from 'twin.macro';
import { object, string } from 'yup';
import * as Icon from 'react-feather';
import React, { useState } from 'react';
import useFlash from '@/plugins/useFlash';
import Can from '@/components/elements/Can';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import Modal from '@/components/elements/Modal';
import Field from '@/components/elements/Field';
import Label from '@/components/elements/Label';
import Input from '@/components/elements/Input';
import { Form, Formik, FormikHelpers } from 'formik';
import GreyRowBox from '@/components/elements/GreyRowBox';
import { Button } from '@/components/elements/button/index';
import CopyOnClick from '@/components/elements/CopyOnClick';
import FlashMessageRender from '@/components/FlashMessageRender';
import { ServerDatabase } from '@/api/server/databases/getServerDatabases';
import deleteServerDatabase from '@/api/server/databases/deleteServerDatabase';
import RotatePasswordButton from '@/components/server/databases/RotatePasswordButton';

interface Props {
    database: ServerDatabase;
    className?: string;
}

export default ({ database, className }: Props) => {
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const { addError, clearFlashes } = useFlash();
    const [visible, setVisible] = useState(false);
    const [connectionVisible, setConnectionVisible] = useState(false);

    const appendDatabase = ServerContext.useStoreActions((actions) => actions.databases.appendDatabase);
    const removeDatabase = ServerContext.useStoreActions((actions) => actions.databases.removeDatabase);

    const jdbcConnectionString = `jdbc:mysql://${database.username}${
        database.password ? `:${encodeURIComponent(database.password)}` : ''
    }@${database.connectionString}/${database.name}`;

    const schema = object().shape({
        confirm: string()
            .required('The database name must be provided.')
            .oneOf([database.name.split('_', 2)[1], database.name], 'The database name must be provided.'),
    });

    const submit = (values: { confirm: string }, { setSubmitting }: FormikHelpers<{ confirm: string }>) => {
        clearFlashes();
        deleteServerDatabase(uuid, database.id)
            .then(() => {
                setVisible(false);
                setTimeout(() => removeDatabase(database.id), 150);
            })
            .catch((error) => {
                console.error(error);
                setSubmitting(false);
                addError({ key: 'database:delete', message: httpErrorToHuman(error) });
            });
    };

    return (
        <>
            <Formik onSubmit={submit} initialValues={{ confirm: '' }} validationSchema={schema} isInitialValid={false}>
                {({ isSubmitting, isValid, resetForm }) => (
                    <Modal
                        visible={visible}
                        dismissable={!isSubmitting}
                        showSpinnerOverlay={isSubmitting}
                        onDismissed={() => {
                            setVisible(false);
                            resetForm();
                        }}
                    >
                        <FlashMessageRender byKey={'database:delete'} css={tw`mb-6`} />
                        <h2 css={tw`text-2xl mb-6`}>Confirm database deletion</h2>
                        <p css={tw`text-sm`}>
                            Deleting a database is a permanent action, it cannot be undone. This will permanently delete
                            the <strong>{database.name}</strong> database and remove all associated data.
                        </p>
                        <Form css={tw`m-0 mt-6`}>
                            <Field
                                type={'text'}
                                id={'confirm_name'}
                                name={'confirm'}
                                label={'Confirm Database Name'}
                                description={'Enter the database name to confirm deletion.'}
                            />
                            <div css={tw`mt-6 text-right`}>
                                <Button
                                    type={'button'}
                                    variant={Button.Variants.Secondary}
                                    css={tw`mr-2`}
                                    onClick={() => setVisible(false)}
                                >
                                    Cancel
                                </Button>
                                <Button type={'submit'} color={'red'} disabled={!isValid}>
                                    Delete Database
                                </Button>
                            </div>
                        </Form>
                    </Modal>
                )}
            </Formik>
            <Modal visible={connectionVisible} onDismissed={() => setConnectionVisible(false)}>
                <FlashMessageRender byKey={'database-connection-modal'} css={tw`mb-6`} />
                <h3 css={tw`mb-6 text-2xl`}>Database connection details</h3>
                <div>
                    <Label>Endpoint</Label>
                    <CopyOnClick text={database.connectionString}>
                        <Input type={'text'} readOnly value={database.connectionString} />
                    </CopyOnClick>
                </div>
                <div css={tw`mt-6`}>
                    <Label>Connections from</Label>
                    <Input type={'text'} readOnly value={database.allowConnectionsFrom} />
                </div>
                <div css={tw`mt-6`}>
                    <Label>Username</Label>
                    <CopyOnClick text={database.username}>
                        <Input type={'text'} readOnly value={database.username} />
                    </CopyOnClick>
                </div>
                <Can action={'database.view_password'}>
                    <div css={tw`mt-6`}>
                        <Label>Password</Label>
                        <CopyOnClick text={database.password}>
                            <Input type={'text'} readOnly value={database.password} />
                        </CopyOnClick>
                    </div>
                </Can>
                <div css={tw`mt-6`}>
                    <Label>JDBC Connection String</Label>
                    <CopyOnClick text={jdbcConnectionString}>
                        <Input type={'text'} readOnly value={jdbcConnectionString} />
                    </CopyOnClick>
                </div>
                <div css={tw`mt-6 text-right`}>
                    <Can action={'database.update'}>
                        <RotatePasswordButton databaseId={database.id} onUpdate={appendDatabase} />
                    </Can>
                    <Button variant={Button.Variants.Secondary} onClick={() => setConnectionVisible(false)}>
                        Close
                    </Button>
                </div>
            </Modal>
            <GreyRowBox $hoverable={false} className={className} css={tw`mb-2`}>
                <div css={tw`hidden md:block`}>
                    <Icon.Database />
                </div>
                <div css={tw`flex-1 ml-4`}>
                    <CopyOnClick text={database.name}>
                        <p css={tw`text-lg`}>{database.name}</p>
                    </CopyOnClick>
                </div>
                <div css={tw`ml-8 text-center hidden md:block`}>
                    <CopyOnClick text={database.connectionString}>
                        <p css={tw`text-sm`}>{database.connectionString}</p>
                    </CopyOnClick>
                    <p css={tw`mt-1 text-2xs text-neutral-500 uppercase select-none`}>Endpoint</p>
                </div>
                <div css={tw`ml-8 text-center hidden md:block`}>
                    <p css={tw`text-sm`}>{database.allowConnectionsFrom}</p>
                    <p css={tw`mt-1 text-2xs text-neutral-500 uppercase select-none`}>Connections from</p>
                </div>
                <div css={tw`ml-8 text-center hidden md:block`}>
                    <CopyOnClick text={database.username}>
                        <p css={tw`text-sm`}>{database.username}</p>
                    </CopyOnClick>
                    <p css={tw`mt-1 text-2xs text-neutral-500 uppercase select-none`}>Username</p>
                </div>
                <div css={tw`ml-8`}>
                    <Button
                        variant={Button.Variants.Secondary}
                        css={tw`mr-2`}
                        onClick={() => setConnectionVisible(true)}
                    >
                        <Icon.Eye />
                    </Button>
                    <Can action={'database.delete'}>
                        <Button.Danger variant={Button.Variants.Secondary} onClick={() => setVisible(true)}>
                            <Icon.Trash />
                        </Button.Danger>
                    </Can>
                </div>
            </GreyRowBox>
        </>
    );
};
</file>

<file path="resources/scripts/components/server/databases/DatabasesContainer.tsx">
import tw from 'twin.macro';
import useFlash from '@/plugins/useFlash';
import Can from '@/components/elements/Can';
import { httpErrorToHuman } from '@/api/http';
import Fade from '@/components/elements/Fade';
import { ServerContext } from '@/state/server';
import React, { useEffect, useState } from 'react';
import Spinner from '@/components/elements/Spinner';
import { useDeepMemoize } from '@/plugins/useDeepMemoize';
import DatabaseRow from '@/components/server/databases/DatabaseRow';
import ServerContentBlock from '@/components/elements/ServerContentBlock';
import getServerDatabases from '@/api/server/databases/getServerDatabases';
import CreateDatabaseButton from '@/components/server/databases/CreateDatabaseButton';

export default () => {
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const databaseLimit = ServerContext.useStoreState((state) => state.server.data!.featureLimits.databases);

    const { addError, clearFlashes } = useFlash();
    const [loading, setLoading] = useState(true);

    const databases = useDeepMemoize(ServerContext.useStoreState((state) => state.databases.data));
    const setDatabases = ServerContext.useStoreActions((state) => state.databases.setDatabases);

    useEffect(() => {
        setLoading(!databases.length);
        clearFlashes('databases');

        getServerDatabases(uuid)
            .then((databases) => setDatabases(databases))
            .catch((error) => {
                console.error(error);
                addError({ key: 'databases', message: httpErrorToHuman(error) });
            })
            .then(() => setLoading(false));
    }, []);

    return (
        <ServerContentBlock
            title={'Databases'}
            description={'Create databases for your application.'}
            showFlashKey={'databases'}
        >
            {!databases.length && loading ? (
                <Spinner size={'large'} centered />
            ) : (
                <Fade timeout={150}>
                    <>
                        {databases.length > 0 ? (
                            databases.map((database, index) => (
                                <DatabaseRow
                                    key={database.id}
                                    database={database}
                                    className={index > 0 ? 'mt-1' : undefined}
                                />
                            ))
                        ) : (
                            <p css={tw`text-center text-sm text-neutral-300`}>
                                {databaseLimit > 0
                                    ? 'It looks like you have no databases.'
                                    : 'Databases cannot be created for this server.'}
                            </p>
                        )}
                        <Can action={'database.create'}>
                            <div css={tw`mt-6 flex items-center justify-end`}>
                                {databaseLimit > 0 && databases.length > 0 && (
                                    <p css={tw`text-sm text-neutral-300 mb-4 sm:mr-6 sm:mb-0`}>
                                        {databases.length} of {databaseLimit} databases have been allocated to this
                                        server.
                                    </p>
                                )}
                                {databaseLimit > 0 && databaseLimit !== databases.length && (
                                    <CreateDatabaseButton css={tw`flex justify-end mt-6`} />
                                )}
                            </div>
                        </Can>
                    </>
                </Fade>
            )}
        </ServerContentBlock>
    );
};
</file>

<file path="resources/scripts/components/server/databases/RotatePasswordButton.tsx">
import React from 'react';
import tw from 'twin.macro';
import { ApplicationStore } from '@/state';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import { Actions, useStoreActions } from 'easy-peasy';
import { Button } from '@/components/elements/button/index';
import { ServerDatabase } from '@/api/server/databases/getServerDatabases';
import rotateDatabasePassword from '@/api/server/databases/rotateDatabasePassword';

export default ({ databaseId, onUpdate }: { databaseId: string; onUpdate: (database: ServerDatabase) => void }) => {
    const { addFlash, clearFlashes } = useStoreActions((actions: Actions<ApplicationStore>) => actions.flashes);
    const server = ServerContext.useStoreState((state) => state.server.data!);

    if (!databaseId) {
        return null;
    }

    const rotate = () => {
        clearFlashes();

        rotateDatabasePassword(server.uuid, databaseId)
            .then((database) => onUpdate(database))
            .catch((error) => {
                console.error(error);
                addFlash({
                    type: 'danger',
                    title: 'Error',
                    message: httpErrorToHuman(error),
                    key: 'database-connection-modal',
                });
            });
    };

    return (
        <Button variant={Button.Variants.Secondary} color={'primary'} css={tw`mr-2`} onClick={rotate}>
            Rotate Password
        </Button>
    );
};
</file>

<file path="resources/scripts/components/server/edit/EditContainer.tsx">
import tw from 'twin.macro';
import { breakpoint } from '@/theme';
import * as Icon from 'react-feather';
import React, { useState } from 'react';
import useFlash from '@/plugins/useFlash';
import styled from 'styled-components/macro';
import { ServerContext } from '@/state/server';
import editServer from '@/api/server/editServer';
import { Dialog } from '@/components/elements/dialog';
import { Button } from '@/components/elements/button/index';
import TitledGreyBox from '@/components/elements/TitledGreyBox';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import ServerContentBlock from '@/components/elements/ServerContentBlock';

const Container = styled.div`
    ${tw`flex flex-wrap`};

    & > div {
        ${tw`w-full`};

        ${breakpoint('sm')`
      width: calc(50% - 1rem);
    `}

        ${breakpoint('md')`
      ${tw`w-auto flex-1`};
    `}
    }
`;

const Wrapper = styled.div`
    ${tw`text-2xl flex flex-row justify-center items-center`};
`;

export default () => {
    const [submitting, setSubmitting] = useState(false);
    const [resource, setResource] = useState('');
    const [amount, setAmount] = useState(0);

    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const { clearFlashes, addFlash, clearAndAddHttpError } = useFlash();

    const edit = (resource: string, amount: number) => {
        clearFlashes('server:edit');
        setSubmitting(true);

        editServer(uuid, resource, amount)
            .then(() => {
                setSubmitting(false);
                addFlash({
                    key: 'server:edit',
                    type: 'success',
                    message: 'Server resources have been edited successfully.',
                });
            })
            .catch((error) => clearAndAddHttpError({ key: 'server:edit', error }));
    };

    return (
        <ServerContentBlock
            title={'Edit Server'}
            description={'Add and remove resources from your server.'}
            showFlashKey={'server:edit'}
        >
            <SpinnerOverlay size={'large'} visible={submitting} />
            <Dialog.Confirm
                open={submitting}
                onClose={() => setSubmitting(false)}
                title={'Confirm resource edit'}
                onConfirmed={() => edit(resource, amount)}
            >
                This will move resources between your account and the server. Are you sure you want to continue?
            </Dialog.Confirm>
            <Container css={tw`lg:grid lg:grid-cols-3 gap-4 my-10`}>
                <TitledGreyBox title={'Edit server CPU limit'} css={tw`mt-8 sm:mt-0`}>
                    <Wrapper>
                        <Icon.Cpu size={40} />
                        <Button.Success
                            css={tw`ml-4`}
                            onClick={() => {
                                setSubmitting(true);
                                setResource('cpu');
                                setAmount(50);
                            }}
                        >
                            <Icon.Plus />
                        </Button.Success>
                        <Button.Danger
                            css={tw`ml-4`}
                            onClick={() => {
                                setSubmitting(true);
                                setResource('cpu');
                                setAmount(-50);
                            }}
                        >
                            <Icon.Minus />
                        </Button.Danger>
                    </Wrapper>
                    <p css={tw`mt-1 text-gray-500 text-xs flex justify-center`}>
                        Change the amount of CPU assigned to the server.
                    </p>
                    <p css={tw`mt-1 text-gray-500 text-xs flex justify-center`}>Limit cannot be lower than 50%.</p>
                </TitledGreyBox>
                <TitledGreyBox title={'Edit server RAM limit'} css={tw`mt-8 sm:mt-0 sm:ml-8`}>
                    <Wrapper>
                        <Icon.PieChart size={40} />
                        <Button.Success
                            css={tw`ml-4`}
                            onClick={() => {
                                setSubmitting(true);
                                setResource('memory');
                                setAmount(1024);
                            }}
                        >
                            <Icon.Plus />
                        </Button.Success>
                        <Button.Danger
                            css={tw`ml-4`}
                            onClick={() => {
                                setSubmitting(true);
                                setResource('memory');
                                setAmount(-1024);
                            }}
                        >
                            <Icon.Minus />
                        </Button.Danger>
                    </Wrapper>
                    <p css={tw`mt-1 text-gray-500 text-xs flex justify-center`}>
                        Change the amount of RAM assigned to the server.
                    </p>
                    <p css={tw`mt-1 text-gray-500 text-xs flex justify-center`}>Limit cannot be lower than 1GB.</p>
                </TitledGreyBox>
                <TitledGreyBox title={'Edit server storage limit'} css={tw`mt-8 sm:mt-0 sm:ml-8`}>
                    <Wrapper>
                        <Icon.HardDrive size={40} />
                        <Button.Success
                            css={tw`ml-4`}
                            onClick={() => {
                                setSubmitting(true);
                                setResource('disk');
                                setAmount(1024);
                            }}
                        >
                            <Icon.Plus />
                        </Button.Success>
                        <Button.Danger
                            css={tw`ml-4`}
                            onClick={() => {
                                setSubmitting(true);
                                setResource('disk');
                                setAmount(-1024);
                            }}
                        >
                            <Icon.Minus />
                        </Button.Danger>
                    </Wrapper>
                    <p css={tw`mt-1 text-gray-500 text-xs flex justify-center`}>
                        Change the amount of storage assigned to the server.
                    </p>
                    <p css={tw`mt-1 text-gray-500 text-xs flex justify-center`}>Limit cannot be lower than 1GB.</p>
                </TitledGreyBox>
                <TitledGreyBox title={'Edit server port quantity'} css={tw`mt-8 sm:mt-0`}>
                    <Wrapper>
                        <Icon.Share2 size={40} />
                        <Button.Success
                            css={tw`ml-4`}
                            onClick={() => {
                                setSubmitting(true);
                                setResource('allocation_limit');
                                setAmount(1);
                            }}
                        >
                            <Icon.Plus />
                        </Button.Success>
                        <Button.Danger
                            css={tw`ml-4`}
                            onClick={() => {
                                setSubmitting(true);
                                setResource('allocation_limit');
                                setAmount(-1);
                            }}
                        >
                            <Icon.Minus />
                        </Button.Danger>
                    </Wrapper>
                    <p css={tw`mt-1 text-gray-500 text-xs flex justify-center`}>
                        Change the limit of ports assigned to the server.
                    </p>
                    <p css={tw`mt-1 text-gray-500 text-xs flex justify-center`}>Limit cannot be lower than 1.</p>
                </TitledGreyBox>
                <TitledGreyBox title={'Edit server backup limit'} css={tw`mt-8 sm:mt-0 sm:ml-8`}>
                    <Wrapper>
                        <Icon.Archive size={40} />
                        <Button.Success
                            css={tw`ml-4`}
                            onClick={() => {
                                setSubmitting(true);
                                setResource('backup_limit');
                                setAmount(1);
                            }}
                        >
                            <Icon.Plus />
                        </Button.Success>
                        <Button.Danger
                            css={tw`ml-4`}
                            onClick={() => {
                                setSubmitting(true);
                                setResource('backup_limit');
                                setAmount(-1);
                            }}
                        >
                            <Icon.Minus />
                        </Button.Danger>
                    </Wrapper>
                    <p css={tw`mt-1 text-gray-500 text-xs flex justify-center`}>
                        Change the limit of backups assigned to the server.
                    </p>
                </TitledGreyBox>
                <TitledGreyBox title={'Edit server database limit'} css={tw`mt-8 sm:mt-0 sm:ml-8`}>
                    <Wrapper>
                        <Icon.Database size={40} />
                        <Button.Success
                            css={tw`ml-4`}
                            onClick={() => {
                                setSubmitting(true);
                                setResource('database_limit');
                                setAmount(1);
                            }}
                        >
                            <Icon.Plus />
                        </Button.Success>
                        <Button.Danger
                            css={tw`ml-4`}
                            onClick={() => {
                                setSubmitting(true);
                                setResource('database_limit');
                                setAmount(-1);
                            }}
                        >
                            <Icon.Minus />
                        </Button.Danger>
                    </Wrapper>
                    <p css={tw`mt-1 text-gray-500 text-xs flex justify-center`}>
                        Change the limit of databases assigned to the server.
                    </p>
                </TitledGreyBox>
            </Container>
        </ServerContentBlock>
    );
};
</file>

<file path="resources/scripts/components/server/features/eula/EulaModalFeature.tsx">
import tw from 'twin.macro';
import useFlash from '@/plugins/useFlash';
import { ServerContext } from '@/state/server';
import Modal from '@/components/elements/Modal';
import React, { useEffect, useState } from 'react';
import { Button } from '@/components/elements/button/index';
import FlashMessageRender from '@/components/FlashMessageRender';
import saveFileContents from '@/api/server/files/saveFileContents';
import { SocketEvent, SocketRequest } from '@/components/server/events';

const EulaModalFeature = () => {
    const [visible, setVisible] = useState(false);
    const [loading, setLoading] = useState(false);

    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const status = ServerContext.useStoreState((state) => state.status.value);
    const { clearFlashes, clearAndAddHttpError } = useFlash();
    const { connected, instance } = ServerContext.useStoreState((state) => state.socket);

    useEffect(() => {
        if (!connected || !instance || status === 'running') return;

        const listener = (line: string) => {
            if (line.toLowerCase().indexOf('you need to agree to the eula in order to run the server') >= 0) {
                setVisible(true);
            }
        };

        instance.addListener(SocketEvent.CONSOLE_OUTPUT, listener);

        return () => {
            instance.removeListener(SocketEvent.CONSOLE_OUTPUT, listener);
        };
    }, [connected, instance, status]);

    const onAcceptEULA = () => {
        setLoading(true);
        clearFlashes('feature:eula');

        saveFileContents(uuid, 'eula.txt', 'eula=true')
            .then(() => {
                if (status === 'offline' && instance) {
                    instance.send(SocketRequest.SET_STATE, 'restart');
                }

                setLoading(false);
                setVisible(false);
            })
            .catch((error) => {
                console.error(error);
                clearAndAddHttpError({ key: 'feature:eula', error });
            })
            .then(() => setLoading(false));
    };

    useEffect(() => {
        clearFlashes('feature:eula');
    }, []);

    return (
        <Modal
            visible={visible}
            onDismissed={() => setVisible(false)}
            closeOnBackground={false}
            showSpinnerOverlay={loading}
        >
            <FlashMessageRender key={'feature:eula'} css={tw`mb-4`} />
            <h2 css={tw`text-2xl mb-4 text-neutral-100`}>Accept Minecraft&reg; EULA</h2>
            <p css={tw`text-neutral-200`}>
                By pressing {'"I Accept"'} below you are indicating your agreement to the&nbsp;
                <a
                    target={'_blank'}
                    css={tw`text-primary-300 underline transition-colors duration-150 hover:text-primary-400`}
                    rel={'noreferrer noopener'}
                    href='https://account.mojang.com/documents/minecraft_eula'
                >
                    Minecraft&reg; EULA
                </a>
                .
            </p>
            <div css={tw`mt-8 sm:flex items-center justify-end`}>
                <Button
                    variant={Button.Variants.Secondary}
                    onClick={() => setVisible(false)}
                    css={tw`w-full sm:w-auto border-transparent`}
                >
                    Cancel
                </Button>
                <Button onClick={onAcceptEULA} css={tw`mt-4 sm:mt-0 sm:ml-4 w-full sm:w-auto`}>
                    I Accept
                </Button>
            </div>
        </Modal>
    );
};

export default EulaModalFeature;
</file>

<file path="resources/scripts/components/server/features/Features.tsx">
import React, { useMemo } from 'react';
import features from './index';
import { getObjectKeys } from '@/lib/objects';

type ListItems = [string, React.ComponentType][];

export default ({ enabled }: { enabled: string[] }) => {
    const mapped: ListItems = useMemo(() => {
        return getObjectKeys(features)
            .filter((key) => enabled.map((v) => v.toLowerCase()).includes(key.toLowerCase()))
            .reduce((arr, key) => [...arr, [key, features[key]]], [] as ListItems);
    }, [enabled]);

    return (
        <React.Suspense fallback={null}>
            {mapped.map(([key, Component]) => (
                <Component key={key} />
            ))}
        </React.Suspense>
    );
};
</file>

<file path="resources/scripts/components/server/features/GSLTokenModalFeature.tsx">
import tw from 'twin.macro';
import { Form, Formik } from 'formik';
import useFlash from '@/plugins/useFlash';
import { ServerContext } from '@/state/server';
import Modal from '@/components/elements/Modal';
import Field from '@/components/elements/Field';
import React, { useEffect, useState } from 'react';
import { Button } from '@/components/elements/button/index';
import FlashMessageRender from '@/components/FlashMessageRender';
import updateStartupVariable from '@/api/server/updateStartupVariable';
import { SocketEvent, SocketRequest } from '@/components/server/events';

interface Values {
    gslToken: string;
}

const GSLTokenModalFeature = () => {
    const [visible, setVisible] = useState(false);
    const [loading, setLoading] = useState(false);

    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const status = ServerContext.useStoreState((state) => state.status.value);
    const { clearFlashes, clearAndAddHttpError } = useFlash();
    const { connected, instance } = ServerContext.useStoreState((state) => state.socket);

    useEffect(() => {
        if (!connected || !instance || status === 'running') return;

        const errors = ['(gsl token expired)', '(account not found)'];

        const listener = (line: string) => {
            if (errors.some((p) => line.toLowerCase().includes(p))) {
                setVisible(true);
            }
        };

        instance.addListener(SocketEvent.CONSOLE_OUTPUT, listener);

        return () => {
            instance.removeListener(SocketEvent.CONSOLE_OUTPUT, listener);
        };
    }, [connected, instance, status]);

    const updateGSLToken = (values: Values) => {
        setLoading(true);
        clearFlashes('feature:gslToken');

        updateStartupVariable(uuid, 'STEAM_ACC', values.gslToken)
            .then(() => {
                if (instance) {
                    instance.send(SocketRequest.SET_STATE, 'restart');
                }

                setLoading(false);
                setVisible(false);
            })
            .catch((error) => {
                console.error(error);
                clearAndAddHttpError({ key: 'feature:gslToken', error });
            })
            .then(() => setLoading(false));
    };

    useEffect(() => {
        clearFlashes('feature:gslToken');
    }, []);

    return (
        <Formik onSubmit={updateGSLToken} initialValues={{ gslToken: '' }}>
            <Modal
                visible={visible}
                onDismissed={() => setVisible(false)}
                closeOnBackground={false}
                showSpinnerOverlay={loading}
            >
                <FlashMessageRender key={'feature:gslToken'} css={tw`mb-4`} />
                <Form>
                    <h2 css={tw`text-2xl mb-4 text-neutral-100`}>Invalid GSL token!</h2>
                    <p css={tw`mt-4`}>
                        It seems like your Gameserver Login Token (GSL token) is invalid or has expired.
                    </p>
                    <p css={tw`mt-4`}>
                        You can either generate a new one and enter it below or leave the field blank to remove it
                        completely.
                    </p>
                    <div css={tw`sm:flex items-center mt-4`}>
                        <Field
                            name={'gslToken'}
                            label={'GSL Token'}
                            description={'Visit https://steamcommunity.com/dev/managegameservers to generate a token.'}
                            autoFocus
                        />
                    </div>
                    <div css={tw`mt-8 sm:flex items-center justify-end`}>
                        <Button type={'submit'} css={tw`mt-4 sm:mt-0 sm:ml-4 w-full sm:w-auto`}>
                            Update GSL Token
                        </Button>
                    </div>
                </Form>
            </Modal>
        </Formik>
    );
};

export default GSLTokenModalFeature;
</file>

<file path="resources/scripts/components/server/features/index.ts">
import { ComponentType, lazy } from 'react';

/**
 * Custom features should be registered here as lazy components so that they do
 * not impact the generated JS bundle size. They will be automatically loaded in
 * whenever they are actually loaded for the client (which may be never, depending
 * on the feature and the egg).
 */
const features: Record<string, ComponentType> = {
    eula: lazy(() => import('@feature/eula/EulaModalFeature')),
    java_version: lazy(() => import('@feature/JavaVersionModalFeature')),
    gsl_token: lazy(() => import('@feature/GSLTokenModalFeature')),
    pid_limit: lazy(() => import('@feature/PIDLimitModalFeature')),
    steam_disk_space: lazy(() => import('@feature/SteamDiskSpaceFeature')),
};

export default features;
</file>

<file path="resources/scripts/components/server/features/JavaVersionModalFeature.tsx">
import tw from 'twin.macro';
import useFlash from '@/plugins/useFlash';
import Can from '@/components/elements/Can';
import { ServerContext } from '@/state/server';
import Modal from '@/components/elements/Modal';
import Select from '@/components/elements/Select';
import React, { useEffect, useState } from 'react';
import getServerStartup from '@/api/swr/getServerStartup';
import { Button } from '@/components/elements/button/index';
import useWebsocketEvent from '@/plugins/useWebsocketEvent';
import InputSpinner from '@/components/elements/InputSpinner';
import FlashMessageRender from '@/components/FlashMessageRender';
import { SocketEvent, SocketRequest } from '@/components/server/events';
import setSelectedDockerImage from '@/api/server/setSelectedDockerImage';

const MATCH_ERRORS = [
    'unsupported major.minor version',
    'java.lang.unsupportedclassversionerror',
    'has been compiled by a more recent version of the java runtime',
    'minecraft 1.17 requires running the server with java 16 or above',
    'minecraft 1.18 requires running the server with java 17 or above',
];

const JavaVersionModalFeature = () => {
    const [visible, setVisible] = useState(false);
    const [loading, setLoading] = useState(false);
    const [selectedVersion, setSelectedVersion] = useState('');

    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const status = ServerContext.useStoreState((state) => state.status.value);
    const { clearFlashes, clearAndAddHttpError } = useFlash();
    const { instance } = ServerContext.useStoreState((state) => state.socket);

    const { data, isValidating, mutate } = getServerStartup(uuid, null, { revalidateOnMount: false });

    useEffect(() => {
        if (!visible) return;

        mutate().then((value) => {
            setSelectedVersion(Object.values(value?.dockerImages || [])[0] || '');
        });
    }, [visible]);

    useWebsocketEvent(SocketEvent.CONSOLE_OUTPUT, (data) => {
        if (status === 'running') return;

        if (MATCH_ERRORS.some((p) => data.toLowerCase().includes(p.toLowerCase()))) {
            setVisible(true);
        }
    });

    const updateJava = () => {
        setLoading(true);
        clearFlashes('feature:javaVersion');

        setSelectedDockerImage(uuid, selectedVersion)
            .then(() => {
                if (status === 'offline' && instance) {
                    instance.send(SocketRequest.SET_STATE, 'restart');
                }
                setVisible(false);
            })
            .catch((error) => clearAndAddHttpError({ key: 'feature:javaVersion', error }))
            .then(() => setLoading(false));
    };

    useEffect(() => {
        clearFlashes('feature:javaVersion');
    }, []);

    return (
        <Modal
            visible={visible}
            onDismissed={() => setVisible(false)}
            closeOnBackground={false}
            showSpinnerOverlay={loading}
        >
            <FlashMessageRender key={'feature:javaVersion'} css={tw`mb-4`} />
            <h2 css={tw`text-2xl mb-4 text-neutral-100`}>Unsupported Java Version</h2>
            <p css={tw`mt-4`}>
                This server is currently running an unsupported version of Java and cannot be started.
                <Can action={'startup.docker-image'}>
                    &nbsp;Please select a supported version from the list below to continue starting the server.
                </Can>
            </p>
            <Can action={'startup.docker-image'}>
                <div css={tw`mt-4`}>
                    <InputSpinner visible={!data || isValidating}>
                        <Select disabled={!data} onChange={(e) => setSelectedVersion(e.target.value)}>
                            {!data ? (
                                <option disabled />
                            ) : (
                                Object.keys(data.dockerImages).map((key) => (
                                    <option key={key} value={data.dockerImages[key]}>
                                        {key}
                                    </option>
                                ))
                            )}
                        </Select>
                    </InputSpinner>
                </div>
            </Can>
            <div css={tw`mt-8 flex flex-col sm:flex-row justify-end sm:space-x-4 space-y-4 sm:space-y-0`}>
                <Button
                    variant={Button.Variants.Secondary}
                    onClick={() => setVisible(false)}
                    css={tw`w-full sm:w-auto`}
                >
                    Cancel
                </Button>
                <Can action={'startup.docker-image'}>
                    <Button onClick={updateJava} css={tw`w-full sm:w-auto`}>
                        Update Docker Image
                    </Button>
                </Can>
            </div>
        </Modal>
    );
};

export default JavaVersionModalFeature;
</file>

<file path="resources/scripts/components/server/features/PIDLimitModalFeature.tsx">
import tw from 'twin.macro';
import * as Icon from 'react-feather';
import useFlash from '@/plugins/useFlash';
import { useStoreState } from 'easy-peasy';
import { ServerContext } from '@/state/server';
import Modal from '@/components/elements/Modal';
import React, { useEffect, useState } from 'react';
import { SocketEvent } from '@/components/server/events';
import { Button } from '@/components/elements/button/index';
import FlashMessageRender from '@/components/FlashMessageRender';

const PIDLimitModalFeature = () => {
    const [visible, setVisible] = useState(false);
    const [loading] = useState(false);

    const status = ServerContext.useStoreState((state) => state.status.value);
    const { clearFlashes } = useFlash();
    const { connected, instance } = ServerContext.useStoreState((state) => state.socket);
    const isAdmin = useStoreState((state) => state.user.data!.rootAdmin);

    useEffect(() => {
        if (!connected || !instance || status === 'running') return;

        const errors = [
            'pthread_create failed',
            'failed to create thread',
            'unable to create thread',
            'unable to create native thread',
            'unable to create new native thread',
            'exception in thread "craft async scheduler management thread"',
        ];

        const listener = (line: string) => {
            if (errors.some((p) => line.toLowerCase().includes(p))) {
                setVisible(true);
            }
        };

        instance.addListener(SocketEvent.CONSOLE_OUTPUT, listener);

        return () => {
            instance.removeListener(SocketEvent.CONSOLE_OUTPUT, listener);
        };
    }, [connected, instance, status]);

    useEffect(() => {
        clearFlashes('feature:pidLimit');
    }, []);

    return (
        <Modal
            visible={visible}
            onDismissed={() => setVisible(false)}
            closeOnBackground={false}
            showSpinnerOverlay={loading}
        >
            <FlashMessageRender key={'feature:pidLimit'} css={tw`mb-4`} />
            {isAdmin ? (
                <>
                    <div css={tw`mt-4 sm:flex items-center`}>
                        <Icon.AlertTriangle css={tw`pr-4`} color={'orange'} size={'4x'} />
                        <h2 css={tw`text-2xl mb-4 text-neutral-100 `}>Memory or process limit reached...</h2>
                    </div>
                    <p css={tw`mt-4`}>This server has reached the maximum process or memory limit.</p>
                    <p css={tw`mt-4`}>
                        Increasing <code css={tw`font-mono bg-neutral-900`}>container_pid_limit</code> in the wings
                        configuration, <code css={tw`font-mono bg-neutral-900`}>config.yml</code>, might help resolve
                        this issue.
                    </p>
                    <p css={tw`mt-4`}>
                        <b>Note: Wings must be restarted for the configuration file changes to take effect</b>
                    </p>
                    <div css={tw`mt-8 sm:flex items-center justify-end`}>
                        <Button onClick={() => setVisible(false)} css={tw`w-full sm:w-auto border-transparent`}>
                            Close
                        </Button>
                    </div>
                </>
            ) : (
                <>
                    <div css={tw`mt-4 sm:flex items-center`}>
                        <Icon.AlertTriangle css={tw`pr-4`} color={'orange'} size={'4x'} />
                        <h2 css={tw`text-2xl mb-4 text-neutral-100`}>Possible resource limit reached...</h2>
                    </div>
                    <p css={tw`mt-4`}>
                        This server is attempting to use more resources than allocated. Please contact the administrator
                        and give them the error below.
                    </p>
                    <p css={tw`mt-4`}>
                        <code css={tw`font-mono bg-neutral-900`}>
                            pthread_create failed, Possibly out of memory or process/resource limits reached
                        </code>
                    </p>
                    <div css={tw`mt-8 sm:flex items-center justify-end`}>
                        <Button onClick={() => setVisible(false)} css={tw`w-full sm:w-auto border-transparent`}>
                            Close
                        </Button>
                    </div>
                </>
            )}
        </Modal>
    );
};

export default PIDLimitModalFeature;
</file>

<file path="resources/scripts/components/server/features/SteamDiskSpaceFeature.tsx">
import tw from 'twin.macro';
import useFlash from '@/plugins/useFlash';
import { useStoreState } from 'easy-peasy';
import { ServerContext } from '@/state/server';
import Modal from '@/components/elements/Modal';
import React, { useEffect, useState } from 'react';
import { SocketEvent } from '@/components/server/events';
import { Button } from '@/components/elements/button/index';
import FlashMessageRender from '@/components/FlashMessageRender';

const SteamDiskSpaceFeature = () => {
    const [visible, setVisible] = useState(false);
    const [loading] = useState(false);

    const status = ServerContext.useStoreState((state) => state.status.value);
    const { clearFlashes } = useFlash();
    const { connected, instance } = ServerContext.useStoreState((state) => state.socket);
    const isAdmin = useStoreState((state) => state.user.data!.rootAdmin);

    useEffect(() => {
        if (!connected || !instance || status === 'running') return;

        const errors = ['steamcmd needs 250mb of free disk space to update', '0x202 after update job'];

        const listener = (line: string) => {
            if (errors.some((p) => line.toLowerCase().includes(p))) {
                setVisible(true);
            }
        };

        instance.addListener(SocketEvent.CONSOLE_OUTPUT, listener);

        return () => {
            instance.removeListener(SocketEvent.CONSOLE_OUTPUT, listener);
        };
    }, [connected, instance, status]);

    useEffect(() => {
        clearFlashes('feature:steamDiskSpace');
    }, []);

    return (
        <Modal
            visible={visible}
            onDismissed={() => setVisible(false)}
            closeOnBackground={false}
            showSpinnerOverlay={loading}
        >
            <FlashMessageRender key={'feature:steamDiskSpace'} css={tw`mb-4`} />
            {isAdmin ? (
                <>
                    <div css={tw`mt-4 sm:flex items-center`}>
                        <h2 css={tw`text-2xl mb-4 text-neutral-100 `}>Out of available disk space...</h2>
                    </div>
                    <p css={tw`mt-4`}>
                        This server has run out of available disk space and cannot complete the install or update
                        process.
                    </p>
                    <p css={tw`mt-4`}>
                        Ensure the machine has enough disk space by typing{' '}
                        <code css={tw`font-mono bg-neutral-900 rounded py-1 px-2`}>df -h</code> on the machine hosting
                        this server. Delete files or increase the available disk space to resolve the issue.
                    </p>
                    <div css={tw`mt-8 sm:flex items-center justify-end`}>
                        <Button onClick={() => setVisible(false)} css={tw`w-full sm:w-auto border-transparent`}>
                            Close
                        </Button>
                    </div>
                </>
            ) : (
                <>
                    <div css={tw`mt-4 sm:flex items-center`}>
                        <h2 css={tw`text-2xl mb-4 text-neutral-100`}>Out of available disk space...</h2>
                    </div>
                    <p css={tw`mt-4`}>
                        This server has run out of available disk space and cannot complete the install or update
                        process. Please get in touch with the administrator(s) and inform them of disk space issues.
                    </p>
                    <div css={tw`mt-8 sm:flex items-center justify-end`}>
                        <Button onClick={() => setVisible(false)} css={tw`w-full sm:w-auto border-transparent`}>
                            Close
                        </Button>
                    </div>
                </>
            )}
        </Modal>
    );
};

export default SteamDiskSpaceFeature;
</file>

<file path="resources/scripts/components/server/files/ChmodFileModal.tsx">
import React from 'react';
import tw from 'twin.macro';
import useFlash from '@/plugins/useFlash';
import { fileBitsToString } from '@/helpers';
import { ServerContext } from '@/state/server';
import Field from '@/components/elements/Field';
import { Form, Formik, FormikHelpers } from 'formik';
import chmodFiles from '@/api/server/files/chmodFiles';
import { Button } from '@/components/elements/button/index';
import useFileManagerSwr from '@/plugins/useFileManagerSwr';
import Modal, { RequiredModalProps } from '@/components/elements/Modal';

interface FormikValues {
    mode: string;
}

interface File {
    file: string;
    mode: string;
}

type OwnProps = RequiredModalProps & { files: File[] };

const ChmodFileModal = ({ files, ...props }: OwnProps) => {
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const { mutate } = useFileManagerSwr();
    const { clearFlashes, clearAndAddHttpError } = useFlash();
    const directory = ServerContext.useStoreState((state) => state.files.directory);
    const setSelectedFiles = ServerContext.useStoreActions((actions) => actions.files.setSelectedFiles);

    const submit = ({ mode }: FormikValues, { setSubmitting }: FormikHelpers<FormikValues>) => {
        clearFlashes('files');

        mutate(
            (data) =>
                data.map((f) =>
                    f.name === files[0].file ? { ...f, mode: fileBitsToString(mode, !f.isFile), modeBits: mode } : f
                ),
            false
        );

        const data = files.map((f) => ({ file: f.file, mode: mode }));

        chmodFiles(uuid, directory, data)
            .then((): Promise<any> => (files.length > 0 ? mutate() : Promise.resolve()))
            .then(() => setSelectedFiles([]))
            .catch((error) => {
                mutate();
                setSubmitting(false);
                clearAndAddHttpError({ key: 'files', error });
            })
            .then(() => props.onDismissed());
    };

    return (
        <Formik onSubmit={submit} initialValues={{ mode: files.length > 1 ? '' : files[0].mode || '' }}>
            {({ isSubmitting }) => (
                <Modal {...props} dismissable={!isSubmitting} showSpinnerOverlay={isSubmitting}>
                    <Form css={tw`m-0`}>
                        <div css={tw`flex flex-wrap items-end`}>
                            <div css={tw`w-full sm:flex-1 sm:mr-4`}>
                                <Field type={'string'} id={'file_mode'} name={'mode'} label={'File Mode'} autoFocus />
                            </div>
                            <div css={tw`w-full sm:w-auto mt-4 sm:mt-0`}>
                                <Button css={tw`w-full`}>Update</Button>
                            </div>
                        </div>
                    </Form>
                </Modal>
            )}
        </Formik>
    );
};

export default ChmodFileModal;
</file>

<file path="resources/scripts/components/server/files/FileDropdownMenu.tsx">
import { join } from 'path';
import tw from 'twin.macro';
import * as Icon from 'react-feather';
import isEqual from 'react-fast-compare';
import useFlash from '@/plugins/useFlash';
import Can from '@/components/elements/Can';
import styled from 'styled-components/macro';
import { ServerContext } from '@/state/server';
import copyFile from '@/api/server/files/copyFile';
import { Dialog } from '@/components/elements/dialog';
import React, { memo, useRef, useState } from 'react';
import deleteFiles from '@/api/server/files/deleteFiles';
import useEventListener from '@/plugins/useEventListener';
import useFileManagerSwr from '@/plugins/useFileManagerSwr';
import compressFiles from '@/api/server/files/compressFiles';
import { FileObject } from '@/api/server/files/loadDirectory';
import DropdownMenu from '@/components/elements/DropdownMenu';
import decompressFiles from '@/api/server/files/decompressFiles';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import ChmodFileModal from '@/components/server/files/ChmodFileModal';
import getFileDownloadUrl from '@/api/server/files/getFileDownloadUrl';
import RenameFileModal from '@/components/server/files/RenameFileModal';

type ModalType = 'rename' | 'move' | 'chmod';

const StyledRow = styled.div<{ $danger?: boolean }>`
    ${tw`p-2 flex items-center rounded`};
    ${(props) =>
        props.$danger ? tw`hover:bg-red-100 hover:text-red-700` : tw`hover:bg-neutral-100 hover:text-neutral-700`};
`;

interface RowProps extends React.HTMLAttributes<HTMLDivElement> {
    title: string;
    $danger?: boolean;
}

const Row = ({ title, ...props }: RowProps) => (
    <StyledRow {...props}>
        <span css={tw`ml-2`}>{title}</span>
    </StyledRow>
);

const FileDropdownMenu = ({ file }: { file: FileObject }) => {
    const onClickRef = useRef<DropdownMenu>(null);
    const [showSpinner, setShowSpinner] = useState(false);
    const [modal, setModal] = useState<ModalType | null>(null);
    const [showConfirmation, setShowConfirmation] = useState(false);

    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const { mutate } = useFileManagerSwr();
    const { clearAndAddHttpError, clearFlashes } = useFlash();
    const directory = ServerContext.useStoreState((state) => state.files.directory);

    useEventListener(`Jexactyl:files:ctx:${file.key}`, (e: CustomEvent) => {
        if (onClickRef.current) {
            onClickRef.current.triggerMenu(e.detail);
        }
    });

    const doDeletion = () => {
        clearFlashes('files');

        // For UI speed, immediately remove the file from the listing before calling the deletion function.
        // If the delete actually fails, we'll fetch the current directory contents again automatically.
        mutate((files) => files.filter((f) => f.key !== file.key), false);

        deleteFiles(uuid, directory, [file.name]).catch((error) => {
            mutate();
            clearAndAddHttpError({ key: 'files', error });
        });
    };

    const doCopy = () => {
        setShowSpinner(true);
        clearFlashes('files');

        copyFile(uuid, join(directory, file.name))
            .then(() => mutate())
            .catch((error) => clearAndAddHttpError({ key: 'files', error }))
            .then(() => setShowSpinner(false));
    };

    const doDownload = () => {
        setShowSpinner(true);
        clearFlashes('files');

        getFileDownloadUrl(uuid, join(directory, file.name))
            .then((url) => {
                // @ts-expect-error this is valid
                window.location = url;
            })
            .catch((error) => clearAndAddHttpError({ key: 'files', error }))
            .then(() => setShowSpinner(false));
    };

    const doArchive = () => {
        setShowSpinner(true);
        clearFlashes('files');

        compressFiles(uuid, directory, [file.name])
            .then(() => mutate())
            .catch((error) => clearAndAddHttpError({ key: 'files', error }))
            .then(() => setShowSpinner(false));
    };

    const doUnarchive = () => {
        setShowSpinner(true);
        clearFlashes('files');

        decompressFiles(uuid, directory, file.name)
            .then(() => mutate())
            .catch((error) => clearAndAddHttpError({ key: 'files', error }))
            .then(() => setShowSpinner(false));
    };

    return (
        <>
            <Dialog.Confirm
                open={showConfirmation}
                onClose={() => setShowConfirmation(false)}
                title={`Delete ${file.isFile ? 'File' : 'Directory'}`}
                confirm={'Delete'}
                onConfirmed={doDeletion}
            >
                You will not be able to recover the contents of&nbsp;
                <span className={'font-semibold text-gray-50'}>{file.name}</span> once deleted.
            </Dialog.Confirm>
            <DropdownMenu
                ref={onClickRef}
                renderToggle={(onClick) => (
                    <div css={tw`px-4 py-2 hover:text-white`} onClick={onClick}>
                        <Icon.MoreHorizontal />
                        {modal ? (
                            modal === 'chmod' ? (
                                <ChmodFileModal
                                    visible
                                    appear
                                    files={[{ file: file.name, mode: file.modeBits }]}
                                    onDismissed={() => setModal(null)}
                                />
                            ) : (
                                <RenameFileModal
                                    visible
                                    appear
                                    files={[file.name]}
                                    useMoveTerminology={modal === 'move'}
                                    onDismissed={() => setModal(null)}
                                />
                            )
                        ) : null}
                        <SpinnerOverlay visible={showSpinner} fixed size={'large'} />
                    </div>
                )}
            >
                <Can action={'file.update'}>
                    <Row onClick={() => setModal('rename')} title={'Rename'} />
                    <Row onClick={() => setModal('move')} title={'Move'} />
                    <Row onClick={() => setModal('chmod')} title={'Permissions'} />
                </Can>
                {file.isFile && (
                    <Can action={'file.create'}>
                        <Row onClick={doCopy} title={'Copy'} />
                    </Can>
                )}
                {file.isArchiveType() ? (
                    <Can action={'file.create'}>
                        <Row onClick={doUnarchive} title={'Unarchive'} />
                    </Can>
                ) : (
                    <Can action={'file.archive'}>
                        <Row onClick={doArchive} title={'Archive'} />
                    </Can>
                )}
                {file.isFile && <Row onClick={doDownload} title={'Download'} />}
                <Can action={'file.delete'}>
                    <Row onClick={() => setShowConfirmation(true)} title={'Delete'} $danger />
                </Can>
            </DropdownMenu>
        </>
    );
};

export default memo(FileDropdownMenu, isEqual);
</file>

<file path="resources/scripts/components/server/files/FileManagerBreadcrumbs.tsx">
import tw from 'twin.macro';
import { ServerContext } from '@/state/server';
import React, { useEffect, useState } from 'react';
import { NavLink, useLocation } from 'react-router-dom';
import { encodePathSegments, hashToPath } from '@/helpers';

interface Props {
    renderLeft?: JSX.Element;
    withinFileEditor?: boolean;
    isNewFile?: boolean;
}

export default ({ renderLeft, withinFileEditor, isNewFile }: Props) => {
    const [file, setFile] = useState<string | null>(null);
    const id = ServerContext.useStoreState((state) => state.server.data!.id);
    const directory = ServerContext.useStoreState((state) => state.files.directory);
    const { hash } = useLocation();

    useEffect(() => {
        const path = hashToPath(hash);

        if (withinFileEditor && !isNewFile) {
            const name = path.split('/').pop() || null;
            setFile(name);
        }
    }, [withinFileEditor, isNewFile, hash]);

    const breadcrumbs = (): { name: string; path?: string }[] =>
        directory
            .split('/')
            .filter((directory) => !!directory)
            .map((directory, index, dirs) => {
                if (!withinFileEditor && index === dirs.length - 1) {
                    return { name: directory };
                }

                return { name: directory, path: `/${dirs.slice(0, index + 1).join('/')}` };
            });

    return (
        <div css={tw`flex flex-grow-0 items-center text-sm text-neutral-500 overflow-x-hidden`}>
            {renderLeft || <div css={tw`w-12`} />}/<span css={tw`px-1 text-neutral-300`}>home</span>/
            <NavLink to={`/server/${id}/files`} css={tw`px-1 text-neutral-200 no-underline hover:text-neutral-100`}>
                container
            </NavLink>
            /
            {breadcrumbs().map((crumb, index) =>
                crumb.path ? (
                    <React.Fragment key={index}>
                        <NavLink
                            to={`/server/${id}/files#${encodePathSegments(crumb.path)}`}
                            css={tw`px-1 text-neutral-200 no-underline hover:text-neutral-100`}
                        >
                            {crumb.name}
                        </NavLink>
                        /
                    </React.Fragment>
                ) : (
                    <span key={index} css={tw`px-1 text-neutral-300`}>
                        {crumb.name}
                    </span>
                )
            )}
            {file && (
                <React.Fragment>
                    <span css={tw`px-1 text-neutral-300`}>{file}</span>
                </React.Fragment>
            )}
        </div>
    );
};
</file>

<file path="resources/scripts/components/server/files/FileManagerContainer.tsx">
import tw from 'twin.macro';
import { ip } from '@/lib/formatters';
import { hashToPath } from '@/helpers';
import style from './style.module.css';
import Can from '@/components/elements/Can';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import Input from '@/components/elements/Input';
import Label from '@/components/elements/Label';
import Spinner from '@/components/elements/Spinner';
import { CSSTransition } from 'react-transition-group';
import { NavLink, useLocation } from 'react-router-dom';
import { Button } from '@/components/elements/button/index';
import CopyOnClick from '@/components/elements/CopyOnClick';
import useFileManagerSwr from '@/plugins/useFileManagerSwr';
import { FileObject } from '@/api/server/files/loadDirectory';
import { useStoreActions, useStoreState } from '@/state/hooks';
import React, { ChangeEvent, useEffect, useState } from 'react';
import { ServerError } from '@/components/elements/ScreenBlock';
import ErrorBoundary from '@/components/elements/ErrorBoundary';
import TitledGreyBox from '@/components/elements/TitledGreyBox';
import UploadButton from '@/components/server/files/UploadButton';
import PullFileModal from '@/components/server/files/PullFileModal';
import FileObjectRow from '@/components/server/files/FileObjectRow';
import MassActionsBar from '@/components/server/files/MassActionsBar';
import ServerContentBlock from '@/components/elements/ServerContentBlock';
import FileManagerStatus from '@/components/server/files/FileManagerStatus';
import NewDirectoryButton from '@/components/server/files/NewDirectoryButton';
import { FileActionCheckbox } from '@/components/server/files/SelectFileCheckbox';
import FileManagerBreadcrumbs from '@/components/server/files/FileManagerBreadcrumbs';

const sortFiles = (files: FileObject[], searchString: string): FileObject[] => {
    const sortedFiles: FileObject[] = files
        .sort((a, b) => a.name.localeCompare(b.name))
        .sort((a, b) => (a.isFile === b.isFile ? 0 : a.isFile ? 1 : -1));
    return sortedFiles
        .filter((file, index) => index === 0 || file.name !== sortedFiles[index - 1].name)
        .filter((file) => file.name.toLowerCase().includes(searchString.toLowerCase()));
};

export default () => {
    const id = ServerContext.useStoreState((state) => state.server.data!.id);
    const username = useStoreState((state) => state.user.data!.username);
    const sftp = ServerContext.useStoreState((state) => state.server.data!.sftpDetails);
    const { hash } = useLocation();
    const { data: files, error, mutate } = useFileManagerSwr();
    const directory = ServerContext.useStoreState((state) => state.files.directory);
    const clearFlashes = useStoreActions((actions) => actions.flashes.clearFlashes);
    const setDirectory = ServerContext.useStoreActions((actions) => actions.files.setDirectory);

    const setSelectedFiles = ServerContext.useStoreActions((actions) => actions.files.setSelectedFiles);
    const selectedFilesLength = ServerContext.useStoreState((state) => state.files.selectedFiles.length);

    const [searchString, setSearchString] = useState('');

    useEffect(() => {
        clearFlashes('files');
        setSelectedFiles([]);
        setDirectory(hashToPath(hash));
    }, [hash]);

    useEffect(() => {
        mutate();
    }, [directory]);

    const onSelectAllClick = (e: React.ChangeEvent<HTMLInputElement>) => {
        setSelectedFiles(e.currentTarget.checked ? files?.map((file) => file.name) || [] : []);
    };

    if (error) {
        return <ServerError message={httpErrorToHuman(error)} onRetry={() => mutate()} />;
    }

    const searchFiles = (event: ChangeEvent<HTMLInputElement>) => {
        if (files) {
            setSearchString(event.target.value);
            sortFiles(files, searchString);
            mutate();
        }
    };

    return (
        <ServerContentBlock title={'File Manager'} description={'Create, edit and view files.'} showFlashKey={'files'}>
            <Input onChange={searchFiles} className={'mb-4 j-up'} placeholder={'Search for files and folders...'} />
            <div css={tw`flex flex-wrap-reverse md:flex-nowrap justify-center mb-4`}>
                <ErrorBoundary>
                    <div className={'j-right'}>
                        <FileManagerBreadcrumbs
                            css={tw`w-full`}
                            renderLeft={
                                <FileActionCheckbox
                                    type={'checkbox'}
                                    css={tw`mx-4`}
                                    checked={selectedFilesLength === (files?.length === 0 ? -1 : files?.length)}
                                    onChange={onSelectAllClick}
                                />
                            }
                        />
                    </div>
                    <Can action={'file.create'}>
                        <div className={style.manager_actions}>
                            <FileManagerStatus />
                            <NewDirectoryButton />
                            <UploadButton />
                            <PullFileModal />
                            <NavLink to={`/server/${id}/files/new${window.location.hash}`}>
                                <Button>New File</Button>
                            </NavLink>
                        </div>
                    </Can>
                </ErrorBoundary>
            </div>
            {!files ? (
                <Spinner size={'large'} centered />
            ) : (
                <>
                    {!files.length ? (
                        <p css={tw`text-sm text-neutral-400 text-center`}>This directory seems to be empty.</p>
                    ) : (
                        <CSSTransition classNames={'fade'} timeout={150} appear in>
                            <>
                                {files.length > 250 && (
                                    <div css={tw`rounded bg-yellow-400 mb-px p-3`}>
                                        <p css={tw`text-yellow-900 text-sm text-center`}>
                                            This directory is too large to display in the browser, limiting the output
                                            to the first 250 files.
                                        </p>
                                    </div>
                                )}
                                {sortFiles(files.slice(0, 250), searchString).map((file) => (
                                    <FileObjectRow key={file.key} file={file} />
                                ))}
                                <MassActionsBar />
                            </>
                        </CSSTransition>
                    )}
                </>
            )}
            <Can action={'file.sftp'}>
                <TitledGreyBox title={'SFTP Details'} className={'mt-8 md:mt-6'}>
                    <div>
                        <Label>Server Address</Label>
                        <CopyOnClick text={`sftp://${ip(sftp.ip)}:${sftp.port}`}>
                            <Input type={'text'} value={`sftp://${ip(sftp.ip)}:${sftp.port}`} readOnly />
                        </CopyOnClick>
                    </div>
                    <div css={tw`mt-6`}>
                        <Label>Username</Label>
                        <CopyOnClick text={`${username}.${id}`}>
                            <Input type={'text'} value={`${username}.${id}`} readOnly />
                        </CopyOnClick>
                    </div>
                    <div css={tw`mt-6 flex items-center`}>
                        <div css={tw`flex-1`}>
                            <div css={tw`border-l-4 border-cyan-500 p-3`}>
                                <p css={tw`text-xs text-neutral-200`}>
                                    Your SFTP password is the same as the password you use to access this panel.
                                </p>
                            </div>
                        </div>
                        <div css={tw`ml-4`}>
                            <a href={`sftp://${username}.${id}@${ip(sftp.ip)}:${sftp.port}`}>
                                <Button.Text variant={Button.Variants.Secondary}>Launch SFTP</Button.Text>
                            </a>
                        </div>
                    </div>
                </TitledGreyBox>
            </Can>
        </ServerContentBlock>
    );
};
</file>

<file path="resources/scripts/components/server/files/FileManagerStatus.tsx">
import React, { useContext, useEffect } from 'react';
import { ServerContext } from '@/state/server';
import { CloudUploadIcon, XIcon } from '@heroicons/react/solid';
import asDialog from '@/hoc/asDialog';
import { Dialog, DialogWrapperContext } from '@/components/elements/dialog';
import { Button } from '@/components/elements/button/index';
import Tooltip from '@/components/elements/tooltip/Tooltip';
import Code from '@/components/elements/Code';
import { useSignal } from '@preact/signals-react';

const svgProps = {
    cx: 16,
    cy: 16,
    r: 14,
    strokeWidth: 3,
    fill: 'none',
    stroke: 'currentColor',
};

const Spinner = ({ progress, className }: { progress: number; className?: string }) => (
    <svg viewBox={'0 0 32 32'} className={className}>
        <circle {...svgProps} className={'opacity-25'} />
        <circle
            {...svgProps}
            stroke={'white'}
            strokeDasharray={28 * Math.PI}
            className={'rotate-[-90deg] origin-[50%_50%] transition-[stroke-dashoffset] duration-300'}
            style={{ strokeDashoffset: ((100 - progress) / 100) * 28 * Math.PI }}
        />
    </svg>
);

const FileUploadList = () => {
    const { close } = useContext(DialogWrapperContext);
    const cancelFileUpload = ServerContext.useStoreActions((actions) => actions.files.cancelFileUpload);
    const clearFileUploads = ServerContext.useStoreActions((actions) => actions.files.clearFileUploads);
    const uploads = ServerContext.useStoreState((state) =>
        Object.entries(state.files.uploads).sort(([a], [b]) => a.localeCompare(b))
    );

    return (
        <div className={'space-y-2 mt-6'}>
            {uploads.map(([name, file]) => (
                <div key={name} className={'flex items-center space-x-3 bg-gray-700 p-3 rounded'}>
                    <Tooltip content={`${Math.floor((file.loaded / file.total) * 100)}%`} placement={'left'}>
                        <div className={'flex-shrink-0'}>
                            <Spinner progress={(file.loaded / file.total) * 100} className={'w-6 h-6'} />
                        </div>
                    </Tooltip>
                    <Code className={'flex-1 truncate'}>{name}</Code>
                    <button
                        onClick={cancelFileUpload.bind(this, name)}
                        className={'text-gray-500 hover:text-gray-200 transition-colors duration-75'}
                    >
                        <XIcon className={'w-5 h-5'} />
                    </button>
                </div>
            ))}
            <Dialog.Footer>
                <Button.Danger variant={Button.Variants.Secondary} onClick={() => clearFileUploads()}>
                    Cancel Uploads
                </Button.Danger>
                <Button.Text onClick={close}>Close</Button.Text>
            </Dialog.Footer>
        </div>
    );
};

const FileUploadListDialog = asDialog({
    title: 'File Uploads',
    description: 'The following files are being uploaded to your server.',
})(FileUploadList);

export default () => {
    const open = useSignal(false);

    const count = ServerContext.useStoreState((state) => Object.keys(state.files.uploads).length);
    const progress = ServerContext.useStoreState((state) => ({
        uploaded: Object.values(state.files.uploads).reduce((count, file) => count + file.loaded, 0),
        total: Object.values(state.files.uploads).reduce((count, file) => count + file.total, 0),
    }));

    useEffect(() => {
        if (count === 0) {
            open.value = false;
        }
    }, [count]);

    return (
        <>
            {count > 0 && (
                <Tooltip content={`${count} files are uploading, click to view`}>
                    <button
                        className={'flex items-center justify-center w-10 h-10'}
                        onClick={() => (open.value = true)}
                    >
                        <Spinner progress={(progress.uploaded / progress.total) * 100} className={'w-8 h-8'} />
                        <CloudUploadIcon className={'h-3 absolute mx-auto animate-pulse'} />
                    </button>
                </Tooltip>
            )}
            <FileUploadListDialog open={open.value} onClose={() => (open.value = false)} />
        </>
    );
};
</file>

<file path="resources/scripts/components/server/files/FileNameModal.tsx">
import React from 'react';
import { join } from 'path';
import tw from 'twin.macro';
import { object, string } from 'yup';
import { ServerContext } from '@/state/server';
import Field from '@/components/elements/Field';
import { Form, Formik, FormikHelpers } from 'formik';
import { Button } from '@/components/elements/button/index';
import Modal, { RequiredModalProps } from '@/components/elements/Modal';

type Props = RequiredModalProps & {
    onFileNamed: (name: string) => void;
};

interface Values {
    fileName: string;
}

export default ({ onFileNamed, onDismissed, ...props }: Props) => {
    const directory = ServerContext.useStoreState((state) => state.files.directory);

    const submit = (values: Values, { setSubmitting }: FormikHelpers<Values>) => {
        onFileNamed(join(directory, values.fileName));
        setSubmitting(false);
    };

    return (
        <Formik
            onSubmit={submit}
            initialValues={{ fileName: '' }}
            validationSchema={object().shape({
                fileName: string().required().min(1),
            })}
        >
            {({ resetForm }) => (
                <Modal
                    onDismissed={() => {
                        resetForm();
                        onDismissed();
                    }}
                    {...props}
                >
                    <Form>
                        <Field
                            id={'fileName'}
                            name={'fileName'}
                            label={'File Name'}
                            description={'Enter the name that this file should be saved as.'}
                            autoFocus
                        />
                        <div css={tw`mt-6 text-right`}>
                            <Button>Create File</Button>
                        </div>
                    </Form>
                </Modal>
            )}
        </Formik>
    );
};
</file>

<file path="resources/scripts/components/server/files/FileObjectRow.tsx">
import { encodePathSegments } from '@/helpers';
import { differenceInHours, format, formatDistanceToNow } from 'date-fns';
import { FileObject } from '@/api/server/files/loadDirectory';
import FileDropdownMenu from '@/components/server/files/FileDropdownMenu';
import { ServerContext } from '@/state/server';
import { NavLink, useRouteMatch } from 'react-router-dom';
import tw from 'twin.macro';
import * as Icon from 'react-feather';
import React, { memo } from 'react';
import isEqual from 'react-fast-compare';
import SelectFileCheckbox from '@/components/server/files/SelectFileCheckbox';
import { usePermissions } from '@/plugins/usePermissions';
import { join } from 'path';
import { bytesToString } from '@/lib/formatters';
import styles from './style.module.css';

const Clickable: React.FC<{ file: FileObject }> = memo(({ file, children }) => {
    const [canReadContents] = usePermissions(['file.read-content']);
    const directory = ServerContext.useStoreState((state) => state.files.directory);

    const match = useRouteMatch();

    return !canReadContents || (file.isFile && !file.isEditable()) ? (
        <div className={styles.details}>{children}</div>
    ) : (
        <NavLink
            className={styles.details}
            to={`${match.url}${file.isFile ? '/edit' : ''}#${encodePathSegments(join(directory, file.name))}`}
        >
            {children}
        </NavLink>
    );
}, isEqual);

const FileObjectRow = ({ file }: { file: FileObject }) => (
    <div
        className={styles.file_row}
        key={file.name}
        onContextMenu={(e) => {
            e.preventDefault();
            window.dispatchEvent(new CustomEvent(`Jexactyl:files:ctx:${file.key}`, { detail: e.clientX }));
        }}
    >
        <SelectFileCheckbox name={file.name} />
        <Clickable file={file}>
            <div css={tw`flex-none text-neutral-400 ml-6 mr-4 text-lg pl-3`}>
                {file.isFile ? (
                    <>{file.isSymlink ? <Icon.Download /> : file.isArchiveType() ? <Icon.Archive /> : <Icon.File />}</>
                ) : (
                    <Icon.Folder />
                )}
            </div>
            <div css={tw`flex-1 truncate`}>{file.name}</div>
            {file.isFile && <div css={tw`w-1/6 text-right mr-4 hidden sm:block`}>{bytesToString(file.size)}</div>}
            <div css={tw`w-1/5 text-right mr-4 hidden md:block`} title={file.modifiedAt.toString()}>
                {Math.abs(differenceInHours(file.modifiedAt, new Date())) > 48
                    ? format(file.modifiedAt, 'MMM do, yyyy h:mma')
                    : formatDistanceToNow(file.modifiedAt, { addSuffix: true })}
            </div>
        </Clickable>
        <FileDropdownMenu file={file} />
    </div>
);

export default memo(FileObjectRow, (prevProps, nextProps) => {
    /* eslint-disable @typescript-eslint/no-unused-vars */
    const { isArchiveType, isEditable, ...prevFile } = prevProps.file;
    const { isArchiveType: nextIsArchiveType, isEditable: nextIsEditable, ...nextFile } = nextProps.file;
    /* eslint-enable @typescript-eslint/no-unused-vars */

    return isEqual(prevFile, nextFile);
});
</file>

<file path="resources/scripts/components/server/files/MassActionsBar.tsx">
import tw from 'twin.macro';
import useFlash from '@/plugins/useFlash';
import Fade from '@/components/elements/Fade';
import { ServerContext } from '@/state/server';
import Portal from '@/components/elements/Portal';
import React, { useEffect, useState } from 'react';
import { Dialog } from '@/components/elements/dialog';
import deleteFiles from '@/api/server/files/deleteFiles';
import { Button } from '@/components/elements/button/index';
import useFileManagerSwr from '@/plugins/useFileManagerSwr';
import compressFiles from '@/api/server/files/compressFiles';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import RenameFileModal from '@/components/server/files/RenameFileModal';

const MassActionsBar = () => {
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);

    const { mutate } = useFileManagerSwr();
    const { clearFlashes, clearAndAddHttpError } = useFlash();
    const [loading, setLoading] = useState(false);
    const [loadingMessage, setLoadingMessage] = useState('');
    const [showConfirm, setShowConfirm] = useState(false);
    const [showMove, setShowMove] = useState(false);
    const directory = ServerContext.useStoreState((state) => state.files.directory);

    const selectedFiles = ServerContext.useStoreState((state) => state.files.selectedFiles);
    const setSelectedFiles = ServerContext.useStoreActions((actions) => actions.files.setSelectedFiles);

    useEffect(() => {
        if (!loading) setLoadingMessage('');
    }, [loading]);

    const onClickCompress = () => {
        setLoading(true);
        clearFlashes('files');
        setLoadingMessage('Archiving files...');

        compressFiles(uuid, directory, selectedFiles)
            .then(() => mutate())
            .then(() => setSelectedFiles([]))
            .catch((error) => clearAndAddHttpError({ key: 'files', error }))
            .then(() => setLoading(false));
    };

    const onClickConfirmDeletion = () => {
        setLoading(true);
        setShowConfirm(false);
        clearFlashes('files');
        setLoadingMessage('Deleting files...');

        deleteFiles(uuid, directory, selectedFiles)
            .then(() => {
                mutate((files) => files.filter((f) => selectedFiles.indexOf(f.name) < 0), false);
                setSelectedFiles([]);
            })
            .catch((error) => {
                mutate();
                clearAndAddHttpError({ key: 'files', error });
            })
            .then(() => setLoading(false));
    };

    return (
        <>
            <div css={tw`pointer-events-none fixed bottom-0 z-20 left-0 right-0 flex justify-center`}>
                <SpinnerOverlay visible={loading} size={'large'} fixed>
                    {loadingMessage}
                </SpinnerOverlay>
                <Dialog.Confirm
                    title={'Delete Files'}
                    open={showConfirm}
                    confirm={'Delete'}
                    onClose={() => setShowConfirm(false)}
                    onConfirmed={onClickConfirmDeletion}
                >
                    <p className={'mb-2'}>
                        Are you sure you want to delete&nbsp;
                        <span className={'font-semibold text-gray-50'}>{selectedFiles.length} files</span>? This is a
                        permanent action and the files cannot be recovered.
                    </p>
                    {selectedFiles.slice(0, 15).map((file) => (
                        <li key={file}>{file}</li>
                    ))}
                    {selectedFiles.length > 15 && <li>and {selectedFiles.length - 15} others</li>}
                </Dialog.Confirm>
                {showMove && (
                    <RenameFileModal
                        files={selectedFiles}
                        visible
                        appear
                        useMoveTerminology
                        onDismissed={() => setShowMove(false)}
                    />
                )}
                <Portal>
                    <div className={'fixed bottom-0 mb-6 flex justify-center w-full z-50'}>
                        <Fade timeout={75} in={selectedFiles.length > 0} unmountOnExit>
                            <div css={tw`flex items-center space-x-4 pointer-events-auto rounded p-4 bg-black/50`}>
                                <Button onClick={() => setShowMove(true)}>Move</Button>
                                <Button onClick={onClickCompress}>Archive</Button>
                                <Button.Danger variant={Button.Variants.Secondary} onClick={() => setShowConfirm(true)}>
                                    Delete
                                </Button.Danger>
                            </div>
                        </Fade>
                    </div>
                </Portal>
            </div>
        </>
    );
};

export default MassActionsBar;
</file>

<file path="resources/scripts/components/server/files/NewDirectoryButton.tsx">
import React, { useContext, useEffect, useState } from 'react';
import { ServerContext } from '@/state/server';
import { Form, Formik, FormikHelpers } from 'formik';
import Field from '@/components/elements/Field';
import { join } from 'path';
import { object, string } from 'yup';
import createDirectory from '@/api/server/files/createDirectory';
import tw from 'twin.macro';
import { Button } from '@/components/elements/button/index';
import { FileObject } from '@/api/server/files/loadDirectory';
import { useFlashKey } from '@/plugins/useFlash';
import useFileManagerSwr from '@/plugins/useFileManagerSwr';
import { WithClassname } from '@/components/types';
import FlashMessageRender from '@/components/FlashMessageRender';
import { Dialog, DialogWrapperContext } from '@/components/elements/dialog';
import Code from '@/components/elements/Code';
import asDialog from '@/hoc/asDialog';

interface Values {
    directoryName: string;
}

const schema = object().shape({
    directoryName: string().required('A valid directory name must be provided.'),
});

const generateDirectoryData = (name: string): FileObject => ({
    key: `dir_${name.split('/', 1)[0] ?? name}`,
    name: name.replace(/^(\/*)/, '').split('/', 1)[0] ?? name,
    mode: 'drwxr-xr-x',
    modeBits: '0755',
    size: 0,
    isFile: false,
    isSymlink: false,
    mimetype: '',
    createdAt: new Date(),
    modifiedAt: new Date(),
    isArchiveType: () => false,
    isEditable: () => false,
});

const NewDirectoryDialog = asDialog({
    title: 'Create Directory',
})(() => {
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const directory = ServerContext.useStoreState((state) => state.files.directory);

    const { mutate } = useFileManagerSwr();
    const { close } = useContext(DialogWrapperContext);
    const { clearAndAddHttpError } = useFlashKey('files:directory-modal');

    useEffect(() => {
        return () => {
            clearAndAddHttpError();
        };
    }, []);

    const submit = ({ directoryName }: Values, { setSubmitting }: FormikHelpers<Values>) => {
        createDirectory(uuid, directory, directoryName)
            .then(() => mutate((data) => [...data, generateDirectoryData(directoryName)], false))
            .then(() => close())
            .catch((error) => {
                setSubmitting(false);
                clearAndAddHttpError(error);
            });
    };

    return (
        <Formik onSubmit={submit} validationSchema={schema} initialValues={{ directoryName: '' }}>
            {({ submitForm, values }) => (
                <>
                    <FlashMessageRender key={'files:directory-modal'} />
                    <Form css={tw`m-0`}>
                        <Field autoFocus id={'directoryName'} name={'directoryName'} label={'Name'} />
                        <p css={tw`mt-2 text-sm md:text-base break-all`}>
                            <span css={tw`text-neutral-200`}>This directory will be created as&nbsp;</span>
                            <Code>
                                /home/container/
                                <span css={tw`text-cyan-200`}>
                                    {join(directory, values.directoryName).replace(/^(\.\.\/|\/)+/, '')}
                                </span>
                            </Code>
                        </p>
                    </Form>
                    <Dialog.Footer>
                        <Button.Text className={'w-full sm:w-auto'} onClick={close}>
                            Cancel
                        </Button.Text>
                        <Button className={'w-full sm:w-auto'} onClick={submitForm}>
                            Create
                        </Button>
                    </Dialog.Footer>
                </>
            )}
        </Formik>
    );
});

export default ({ className }: WithClassname) => {
    const [open, setOpen] = useState(false);

    return (
        <>
            <NewDirectoryDialog open={open} onClose={setOpen.bind(this, false)} />
            <Button.Text onClick={setOpen.bind(this, true)} className={className}>
                Create Directory
            </Button.Text>
        </>
    );
};
</file>

<file path="resources/scripts/components/server/files/PullFileModal.tsx">
import tw from 'twin.macro';
import { join } from 'path';
import { object, string } from 'yup';
import useFlash from '@/plugins/useFlash';
import Code from '@/components/elements/Code';
import { ServerContext } from '@/state/server';
import Field from '@/components/elements/Field';
import Portal from '@/components/elements/Portal';
import pullFile from '@/api/server/files/pullFile';
import { WithClassname } from '@/components/types';
import React, { useEffect, useState } from 'react';
import { Form, Formik, FormikHelpers } from 'formik';
import { Dialog } from '@/components/elements/dialog';
import { Button } from '@/components/elements/button/index';
import useFileManagerSwr from '@/plugins/useFileManagerSwr';
import { FileObject } from '@/api/server/files/loadDirectory';
import FlashMessageRender from '@/components/FlashMessageRender';

interface Values {
    url: string;
}

const generateFileData = (name: string): FileObject => ({
    key: `file_${name.split('/', 1)[0] ?? name}`,
    name: name,
    mode: 'rw-rw-rw-',
    modeBits: '0644',
    size: 0,
    isFile: true,
    isSymlink: false,
    mimetype: '',
    createdAt: new Date(),
    modifiedAt: new Date(),
    isArchiveType: () => false,
    isEditable: () => false,
});

export default ({ className }: WithClassname) => {
    const [visible, setVisible] = useState(false);

    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const directory = ServerContext.useStoreState((state) => state.files.directory);

    const { clearFlashes, clearAndAddHttpError } = useFlash();

    const { data, mutate } = useFileManagerSwr();

    useEffect(() => {
        if (!visible) return;

        return () => {
            clearFlashes('files:pull-modal');
        };
    }, [visible]);

    const submit = ({ url }: Values, { setSubmitting }: FormikHelpers<Values>) => {
        pullFile(uuid, directory, url)
            .then(() =>
                mutate((data) => [...data!, generateFileData(new URL(url).pathname.split('/').pop() || '')], false)
            )
            .then(() => setVisible(false))
            .catch((error) => {
                console.error(error);
                setSubmitting(false);
                clearAndAddHttpError({ key: 'files:pull-modal', error });
            });
    };

    return (
        <>
            <Portal>
                <Formik
                    onSubmit={submit}
                    initialValues={{ url: '' }}
                    validationSchema={object().shape({
                        url: string()
                            .required()
                            .url()
                            .test('unique', 'File or directory with that name already exists.', (v) => {
                                return (
                                    v !== undefined &&
                                    data !== undefined &&
                                    data.filter((f) => f.name.toLowerCase() === v.toLowerCase()).length < 1
                                );
                            }),
                    })}
                >
                    {({ resetForm, submitForm, isSubmitting: _, values }) => (
                        <Dialog
                            title={'Pull Remote File'}
                            open={visible}
                            onClose={() => {
                                setVisible(false);
                                resetForm();
                            }}
                        >
                            <FlashMessageRender key={'files:pull-modal'} />
                            <Form css={tw`m-0`}>
                                <Field type={'text'} id={'url'} name={'url'} label={'URL'} autoFocus />
                                <p css={tw`mt-2 text-sm md:text-base break-all`}>
                                    <span css={tw`text-neutral-200`}>This file will be downloaded to&nbsp;</span>
                                    <Code>
                                        /home/container/
                                        <span css={tw`text-cyan-200`}>
                                            {join(
                                                directory,
                                                values.url.split('/')[values.url.split('/').length - 1]
                                            ).replace(/^(\.\.\/|\/)+/, '')}
                                        </span>
                                    </Code>
                                </p>
                            </Form>
                            <Dialog.Footer>
                                <Button.Text
                                    className={'w-full sm:w-auto'}
                                    onClick={() => {
                                        setVisible(false);
                                        resetForm();
                                    }}
                                >
                                    Cancel
                                </Button.Text>
                                <Button className={'w-full sm:w-auto'} onClick={submitForm}>
                                    Pull File
                                </Button>
                            </Dialog.Footer>
                        </Dialog>
                    )}
                </Formik>
            </Portal>
            <Button.Text onClick={() => setVisible(true)} className={className}>
                Pull Remote File
            </Button.Text>
        </>
    );
};
</file>

<file path="resources/scripts/components/server/files/RenameFileModal.tsx">
import React from 'react';
import { join } from 'path';
import tw from 'twin.macro';
import useFlash from '@/plugins/useFlash';
import { ServerContext } from '@/state/server';
import Field from '@/components/elements/Field';
import { Form, Formik, FormikHelpers } from 'formik';
import renameFiles from '@/api/server/files/renameFiles';
import { Button } from '@/components/elements/button/index';
import useFileManagerSwr from '@/plugins/useFileManagerSwr';
import Modal, { RequiredModalProps } from '@/components/elements/Modal';

interface FormikValues {
    name: string;
}

type OwnProps = RequiredModalProps & { files: string[]; useMoveTerminology?: boolean };

const RenameFileModal = ({ files, useMoveTerminology, ...props }: OwnProps) => {
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const { mutate } = useFileManagerSwr();
    const { clearFlashes, clearAndAddHttpError } = useFlash();
    const directory = ServerContext.useStoreState((state) => state.files.directory);
    const setSelectedFiles = ServerContext.useStoreActions((actions) => actions.files.setSelectedFiles);

    const submit = ({ name }: FormikValues, { setSubmitting }: FormikHelpers<FormikValues>) => {
        clearFlashes('files');

        const len = name.split('/').length;
        if (files.length === 1) {
            if (!useMoveTerminology && len === 1) {
                // Rename the file within this directory.
                mutate((data) => data.map((f) => (f.name === files[0] ? { ...f, name } : f)), false);
            } else if (useMoveTerminology || len > 1) {
                // Remove the file from this directory since they moved it elsewhere.
                mutate((data) => data.filter((f) => f.name !== files[0]), false);
            }
        }

        let data;
        if (useMoveTerminology && files.length > 1) {
            data = files.map((f) => ({ from: f, to: join(name, f) }));
        } else {
            data = files.map((f) => ({ from: f, to: name }));
        }

        renameFiles(uuid, directory, data)
            .then((): Promise<any> => (files.length > 0 ? mutate() : Promise.resolve()))
            .then(() => setSelectedFiles([]))
            .catch((error) => {
                mutate();
                setSubmitting(false);
                clearAndAddHttpError({ key: 'files', error });
            })
            .then(() => props.onDismissed());
    };

    return (
        <Formik onSubmit={submit} initialValues={{ name: files.length > 1 ? '' : files[0] || '' }}>
            {({ isSubmitting, values }) => (
                <Modal {...props} dismissable={!isSubmitting} showSpinnerOverlay={isSubmitting}>
                    <Form css={tw`m-0`}>
                        <div css={[tw`flex flex-wrap`, useMoveTerminology ? tw`items-center` : tw`items-end`]}>
                            <div css={tw`w-full sm:flex-1 sm:mr-4`}>
                                <Field
                                    type={'string'}
                                    id={'file_name'}
                                    name={'name'}
                                    label={'File Name'}
                                    description={
                                        useMoveTerminology
                                            ? 'Enter the new name and directory of this file or folder, relative to the current directory.'
                                            : undefined
                                    }
                                    autoFocus
                                />
                            </div>
                            <div css={tw`w-full sm:w-auto mt-4 sm:mt-0`}>
                                <Button css={tw`w-full`}>{useMoveTerminology ? 'Move' : 'Rename'}</Button>
                            </div>
                        </div>
                        {useMoveTerminology && (
                            <p css={tw`text-xs mt-2 text-neutral-400`}>
                                <strong css={tw`text-neutral-200`}>New location:</strong>
                                &nbsp;/home/container/{join(directory, values.name).replace(/^(\.\.\/|\/)+/, '')}
                            </p>
                        )}
                    </Form>
                </Modal>
            )}
        </Formik>
    );
};

export default RenameFileModal;
</file>

<file path="resources/scripts/components/server/files/SelectFileCheckbox.tsx">
import React from 'react';
import tw from 'twin.macro';
import styled from 'styled-components/macro';
import { ServerContext } from '@/state/server';
import Input from '@/components/elements/Input';

export const FileActionCheckbox = styled(Input)`
    && {
        ${tw`border-neutral-500 bg-transparent`};

        &:not(:checked) {
            ${tw`hover:border-neutral-300`};
        }
    }
`;

export default ({ name }: { name: string }) => {
    const isChecked = ServerContext.useStoreState((state) => state.files.selectedFiles.indexOf(name) >= 0);
    const appendSelectedFile = ServerContext.useStoreActions((actions) => actions.files.appendSelectedFile);
    const removeSelectedFile = ServerContext.useStoreActions((actions) => actions.files.removeSelectedFile);

    return (
        <label css={tw`flex-none px-4 py-2 absolute self-center z-30 cursor-pointer`}>
            <FileActionCheckbox
                name={'selectedFiles'}
                value={name}
                checked={isChecked}
                type={'checkbox'}
                onChange={(e: React.ChangeEvent<HTMLInputElement>) => {
                    if (e.currentTarget.checked) {
                        appendSelectedFile(name);
                    } else {
                        removeSelectedFile(name);
                    }
                }}
            />
        </label>
    );
};
</file>

<file path="resources/scripts/components/server/files/style.module.css">
.manager_actions {
    @apply grid grid-cols-2 sm:grid-cols-3 w-full gap-4 mb-4;

    & button {
        @apply w-full first:col-span-2 sm:first:col-span-1;
    }

    @screen md {
        @apply flex flex-1 justify-end mb-0;

        & button {
            @apply w-auto;
        }
    }
}

.file_row {
    @apply flex items-center cursor-pointer bg-neutral-800 rounded-sm mb-0.5 text-sm no-underline;
    @apply hover:text-neutral-100 hover:bg-neutral-700 transition delay-100;

    & > .details {
        @apply flex flex-1 items-center text-neutral-300 no-underline px-4 py-2 overflow-hidden truncate;

        &:not(a) {
            @apply cursor-default;
        }
    }
}
</file>

<file path="resources/scripts/components/server/files/UploadButton.tsx">
import axios from 'axios';
import getFileUploadUrl from '@/api/server/files/getFileUploadUrl';
import tw from 'twin.macro';
import { Button } from '@/components/elements/button/index';
import React, { useEffect, useRef } from 'react';
import { ModalMask } from '@/components/elements/Modal';
import Fade from '@/components/elements/Fade';
import useEventListener from '@/plugins/useEventListener';
import { useFlashKey } from '@/plugins/useFlash';
import useFileManagerSwr from '@/plugins/useFileManagerSwr';
import { ServerContext } from '@/state/server';
import { WithClassname } from '@/components/types';
import Portal from '@/components/elements/Portal';
import { CloudUploadIcon } from '@heroicons/react/outline';
import { useSignal } from '@preact/signals-react';

function isFileOrDirectory(event: DragEvent): boolean {
    if (!event.dataTransfer?.types) {
        return false;
    }

    return event.dataTransfer.types.some((value) => value.toLowerCase() === 'files');
}

export default ({ className }: WithClassname) => {
    const fileUploadInput = useRef<HTMLInputElement>(null);

    const visible = useSignal(false);
    const timeouts = useSignal<NodeJS.Timeout[]>([]);

    const { mutate } = useFileManagerSwr();
    const { addError, clearAndAddHttpError } = useFlashKey('files');

    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const directory = ServerContext.useStoreState((state) => state.files.directory);
    const { clearFileUploads, removeFileUpload, pushFileUpload, setUploadProgress } = ServerContext.useStoreActions(
        (actions) => actions.files
    );

    useEventListener(
        'dragenter',
        (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (isFileOrDirectory(e)) {
                visible.value = true;
            }
        },
        { capture: true }
    );

    useEventListener('dragexit', () => (visible.value = false), { capture: true });

    useEventListener('keydown', () => (visible.value = false));

    useEffect(() => {
        return () => timeouts.value.forEach(clearTimeout);
    }, []);

    const onUploadProgress = (data: ProgressEvent, name: string) => {
        setUploadProgress({ name, loaded: data.loaded });
    };

    const onFileSubmission = (files: FileList) => {
        clearAndAddHttpError();
        const list = Array.from(files);
        if (list.some((file) => !file.size || (!file.type && file.size === 4096))) {
            return addError('Folder uploads are not supported at this time.', 'Error');
        }

        const uploads = list.map((file) => {
            const controller = new AbortController();
            pushFileUpload({
                name: file.name,
                data: { abort: controller, loaded: 0, total: file.size },
            });

            return () =>
                getFileUploadUrl(uuid).then((url) =>
                    axios
                        .post(
                            url,
                            { files: file },
                            {
                                signal: controller.signal,
                                headers: { 'Content-Type': 'multipart/form-data' },
                                params: { directory },
                                onUploadProgress: (data) => onUploadProgress(data, file.name),
                            }
                        )
                        .then(() => timeouts.value.push(setTimeout(() => removeFileUpload(file.name), 500)))
                );
        });

        Promise.all(uploads.map((fn) => fn()))
            .then(() => mutate())
            .catch((error) => {
                clearFileUploads();
                clearAndAddHttpError(error);
            });
    };

    return (
        <>
            <Portal>
                <Fade appear in={visible.value} timeout={75} key={'upload_modal_mask'} unmountOnExit>
                    <ModalMask
                        onClick={() => (visible.value = false)}
                        onDragOver={(e) => e.preventDefault()}
                        onDrop={(e) => {
                            e.preventDefault();
                            e.stopPropagation();

                            visible.value = false;
                            if (!e.dataTransfer?.files.length) return;

                            onFileSubmission(e.dataTransfer.files);
                        }}
                    >
                        <div className={'w-full flex items-center justify-center pointer-events-none'}>
                            <div
                                className={
                                    'flex items-center space-x-4 bg-black w-full ring-4 ring-blue-200 ring-opacity-60 rounded p-6 mx-10 max-w-sm'
                                }
                            >
                                <CloudUploadIcon className={'w-10 h-10 flex-shrink-0'} />
                                <p className={'font-header flex-1 text-lg text-neutral-100 text-center'}>
                                    Drag and drop files to upload.
                                </p>
                            </div>
                        </div>
                    </ModalMask>
                </Fade>
            </Portal>
            <input
                type={'file'}
                ref={fileUploadInput}
                css={tw`hidden`}
                onChange={(e) => {
                    if (!e.currentTarget.files) return;

                    onFileSubmission(e.currentTarget.files);
                    if (fileUploadInput.current) {
                        fileUploadInput.current.files = null;
                    }
                }}
                multiple
            />
            <Button className={className} onClick={() => fileUploadInput.current && fileUploadInput.current.click()}>
                Upload
            </Button>
        </>
    );
};
</file>

<file path="resources/scripts/components/server/network/AllocationRow.tsx">
import tw from 'twin.macro';
import { debounce } from 'debounce';
import { ip } from '@/lib/formatters';
import * as Icon from 'react-feather';
import isEqual from 'react-fast-compare';
import Can from '@/components/elements/Can';
import styled from 'styled-components/macro';
import Code from '@/components/elements/Code';
import { ServerContext } from '@/state/server';
import { useFlashKey } from '@/plugins/useFlash';
import { Allocation } from '@/api/server/getServer';
import { Textarea } from '@/components/elements/Input';
import GreyRowBox from '@/components/elements/GreyRowBox';
import React, { memo, useCallback, useState } from 'react';
import { Button } from '@/components/elements/button/index';
import CopyOnClick from '@/components/elements/CopyOnClick';
import InputSpinner from '@/components/elements/InputSpinner';
import getServerAllocations from '@/api/swr/getServerAllocations';
import setServerAllocationNotes from '@/api/server/network/setServerAllocationNotes';
import DeleteAllocationButton from '@/components/server/network/DeleteAllocationButton';
import setPrimaryServerAllocation from '@/api/server/network/setPrimaryServerAllocation';

const Label = styled.label`
    ${tw`uppercase text-xs mt-1 text-neutral-400 block px-1 select-none transition-colors duration-150`}
`;

interface Props {
    allocation: Allocation;
}

const AllocationRow = ({ allocation }: Props) => {
    const [loading, setLoading] = useState(false);
    const { clearFlashes, clearAndAddHttpError } = useFlashKey('server:network');
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const { mutate } = getServerAllocations();

    const onNotesChanged = useCallback((id: number, notes: string) => {
        mutate((data) => data?.map((a) => (a.id === id ? { ...a, notes } : a)), false);
    }, []);

    const setAllocationNotes = debounce((notes: string) => {
        setLoading(true);
        clearFlashes();

        setServerAllocationNotes(uuid, allocation.id, notes)
            .then(() => onNotesChanged(allocation.id, notes))
            .catch((error) => clearAndAddHttpError(error))
            .then(() => setLoading(false));
    }, 750);

    const setPrimaryAllocation = () => {
        clearFlashes();
        mutate((data) => data?.map((a) => ({ ...a, isDefault: a.id === allocation.id })), false);

        setPrimaryServerAllocation(uuid, allocation.id).catch((error) => {
            clearAndAddHttpError(error);
            mutate();
        });
    };

    return (
        <GreyRowBox $hoverable={false} className={'flex-wrap md:flex-nowrap mt-2'}>
            <div className={'flex items-center w-full md:w-auto'}>
                <div className={'pl-4 pr-6 text-neutral-400'}>
                    <Icon.Share2 />
                </div>
                <div className={'mr-4 flex-1 md:w-40'}>
                    {allocation.alias ? (
                        <CopyOnClick text={allocation.alias}>
                            <Code dark className={'w-40 truncate'}>
                                {allocation.alias}
                            </Code>
                        </CopyOnClick>
                    ) : (
                        <CopyOnClick text={ip(allocation.ip)}>
                            <Code dark>{ip(allocation.ip)}</Code>
                        </CopyOnClick>
                    )}
                    <Label>{allocation.alias ? 'Hostname' : 'IP Address'}</Label>
                </div>
                <div className={'w-16 md:w-24 overflow-hidden'}>
                    <Code dark>{allocation.port}</Code>
                    <Label>Port</Label>
                </div>
            </div>
            <div className={'mt-4 w-full md:mt-0 md:flex-1 md:w-auto'}>
                <InputSpinner visible={loading}>
                    <Textarea
                        className={'bg-neutral-800 hover:border-neutral-600 border-transparent'}
                        placeholder={'Notes'}
                        defaultValue={allocation.notes || undefined}
                        onChange={(e) => setAllocationNotes(e.currentTarget.value)}
                    />
                </InputSpinner>
            </div>
            <div className={'flex justify-end space-x-4 mt-4 w-full md:mt-0 md:w-48'}>
                {allocation.isDefault ? (
                    <Button size={Button.Sizes.Small} className={'!text-gray-50 !bg-blue-600'} disabled>
                        Primary
                    </Button>
                ) : (
                    <>
                        <Can action={'allocation.delete'}>
                            <DeleteAllocationButton allocation={allocation.id} />
                        </Can>
                        <Can action={'allocation.update'}>
                            <Button.Text size={Button.Sizes.Small} onClick={setPrimaryAllocation}>
                                Make Primary
                            </Button.Text>
                        </Can>
                    </>
                )}
            </div>
        </GreyRowBox>
    );
};

export default memo(AllocationRow, isEqual);
</file>

<file path="resources/scripts/components/server/network/DeleteAllocationButton.tsx">
import tw from 'twin.macro';
import * as Icon from 'react-feather';
import React, { useState } from 'react';
import { ServerContext } from '@/state/server';
import { useFlashKey } from '@/plugins/useFlash';
import { Dialog } from '@/components/elements/dialog';
import { Button } from '@/components/elements/button/index';
import getServerAllocations from '@/api/swr/getServerAllocations';
import deleteServerAllocation from '@/api/server/network/deleteServerAllocation';

interface Props {
    allocation: number;
}

const DeleteAllocationButton = ({ allocation }: Props) => {
    const [confirm, setConfirm] = useState(false);

    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const setServerFromState = ServerContext.useStoreActions((actions) => actions.server.setServerFromState);

    const { mutate } = getServerAllocations();
    const { clearFlashes, clearAndAddHttpError } = useFlashKey('server:network');

    const deleteAllocation = () => {
        clearFlashes();

        mutate((data) => data?.filter((a) => a.id !== allocation), false);
        setServerFromState((s) => ({ ...s, allocations: s.allocations.filter((a) => a.id !== allocation) }));

        deleteServerAllocation(uuid, allocation).catch((error) => {
            clearAndAddHttpError(error);
            mutate();
        });
    };

    return (
        <>
            <Dialog.Confirm
                open={confirm}
                onClose={() => setConfirm(false)}
                title={'Remove Allocation'}
                confirm={'Delete'}
                onConfirmed={deleteAllocation}
            >
                This allocation will be immediately removed from your server.
            </Dialog.Confirm>
            <Button.Danger
                variant={Button.Variants.Secondary}
                size={Button.Sizes.Small}
                shape={Button.Shapes.IconSquare}
                type={'button'}
                onClick={() => setConfirm(true)}
            >
                <Icon.Trash css={tw`w-3 h-auto`} />
            </Button.Danger>
        </>
    );
};

export default DeleteAllocationButton;
</file>

<file path="resources/scripts/components/server/network/NetworkContainer.tsx">
import tw from 'twin.macro';
import isEqual from 'react-fast-compare';
import Can from '@/components/elements/Can';
import { ServerContext } from '@/state/server';
import { useFlashKey } from '@/plugins/useFlash';
import React, { useEffect, useState } from 'react';
import Spinner from '@/components/elements/Spinner';
import { Button } from '@/components/elements/button/index';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import getServerAllocations from '@/api/swr/getServerAllocations';
import AllocationRow from '@/components/server/network/AllocationRow';
import { useDeepCompareEffect } from '@/plugins/useDeepCompareEffect';
import ServerContentBlock from '@/components/elements/ServerContentBlock';
import createServerAllocation from '@/api/server/network/createServerAllocation';

const NetworkContainer = () => {
    const [loading, setLoading] = useState(false);
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const allocationLimit = ServerContext.useStoreState((state) => state.server.data!.featureLimits.allocations);
    const allocations = ServerContext.useStoreState((state) => state.server.data!.allocations, isEqual);
    const setServerFromState = ServerContext.useStoreActions((actions) => actions.server.setServerFromState);

    const { clearFlashes, clearAndAddHttpError } = useFlashKey('server:network');
    const { data, error, mutate } = getServerAllocations();

    useEffect(() => {
        mutate(allocations);
    }, []);

    useEffect(() => {
        clearAndAddHttpError(error);
    }, [error]);

    useDeepCompareEffect(() => {
        if (!data) return;

        setServerFromState((state) => ({ ...state, allocations: data }));
    }, [data]);

    const onCreateAllocation = () => {
        clearFlashes();

        setLoading(true);
        createServerAllocation(uuid)
            .then((allocation) => {
                setServerFromState((s) => ({ ...s, allocations: s.allocations.concat(allocation) }));
                return mutate(data?.concat(allocation), false);
            })
            .catch((error) => clearAndAddHttpError(error))
            .then(() => setLoading(false));
    };

    return (
        <ServerContentBlock
            title={'Network'}
            description={'Configure external networking and ports.'}
            showFlashKey={'server:network'}
        >
            {!data ? (
                <Spinner size={'large'} centered />
            ) : (
                <>
                    {data.map((allocation) => (
                        <AllocationRow key={`${allocation.ip}:${allocation.port}`} allocation={allocation} />
                    ))}
                    {allocationLimit > 0 && (
                        <Can action={'allocation.create'}>
                            <SpinnerOverlay visible={loading} />
                            <div css={tw`mt-6 sm:flex items-center justify-end`}>
                                <p css={tw`text-sm text-neutral-300 mb-4 sm:mr-6 sm:mb-0`}>
                                    You are currently using {data.length} of {allocationLimit} allowed allocations for
                                    this server.
                                </p>
                                {allocationLimit > data.length && (
                                    <Button css={tw`w-full sm:w-auto`} onClick={onCreateAllocation}>
                                        Create Allocation
                                    </Button>
                                )}
                            </div>
                        </Can>
                    )}
                </>
            )}
        </ServerContentBlock>
    );
};

export default NetworkContainer;
</file>

<file path="resources/scripts/components/server/schedules/DeleteScheduleButton.tsx">
import tw from 'twin.macro';
import React, { useState } from 'react';
import { ApplicationStore } from '@/state';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import { Actions, useStoreActions } from 'easy-peasy';
import { Dialog } from '@/components/elements/dialog';
import { Button } from '@/components/elements/button/index';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import deleteSchedule from '@/api/server/schedules/deleteSchedule';

interface Props {
    scheduleId: number;
    onDeleted: () => void;
}

export default ({ scheduleId, onDeleted }: Props) => {
    const [visible, setVisible] = useState(false);
    const [isLoading, setIsLoading] = useState(false);
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const { addError, clearFlashes } = useStoreActions((actions: Actions<ApplicationStore>) => actions.flashes);

    const onDelete = () => {
        setIsLoading(true);
        clearFlashes('schedules');
        deleteSchedule(uuid, scheduleId)
            .then(() => {
                setIsLoading(false);
                onDeleted();
            })
            .catch((error) => {
                console.error(error);

                addError({ key: 'schedules', message: httpErrorToHuman(error) });
                setIsLoading(false);
                setVisible(false);
            });
    };

    return (
        <>
            <Dialog.Confirm
                open={visible}
                onClose={() => setVisible(false)}
                title={'Delete Schedule'}
                confirm={'Delete'}
                onConfirmed={onDelete}
            >
                <SpinnerOverlay visible={isLoading} />
                All tasks will be removed and any running processes will be terminated.
            </Dialog.Confirm>
            <Button.Danger css={tw`flex-1 sm:flex-none mr-4 border-transparent`} onClick={() => setVisible(true)}>
                Delete
            </Button.Danger>
        </>
    );
};
</file>

<file path="resources/scripts/components/server/schedules/EditScheduleModal.tsx">
import tw from 'twin.macro';
import asModal from '@/hoc/asModal';
import useFlash from '@/plugins/useFlash';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import Field from '@/components/elements/Field';
import ModalContext from '@/context/ModalContext';
import Switch from '@/components/elements/Switch';
import { Form, Formik, FormikHelpers } from 'formik';
import { Button } from '@/components/elements/button/index';
import FormikSwitch from '@/components/elements/FormikSwitch';
import React, { useContext, useEffect, useState } from 'react';
import FlashMessageRender from '@/components/FlashMessageRender';
import { Schedule } from '@/api/server/schedules/getServerSchedules';
import createOrUpdateSchedule from '@/api/server/schedules/createOrUpdateSchedule';
import ScheduleCheatsheetCards from '@/components/server/schedules/ScheduleCheatsheetCards';

interface Props {
    schedule?: Schedule;
}

interface Values {
    name: string;
    dayOfWeek: string;
    month: string;
    dayOfMonth: string;
    hour: string;
    minute: string;
    enabled: boolean;
    onlyWhenOnline: boolean;
}

const EditScheduleModal = ({ schedule }: Props) => {
    const { addError, clearFlashes } = useFlash();
    const { dismiss } = useContext(ModalContext);

    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const appendSchedule = ServerContext.useStoreActions((actions) => actions.schedules.appendSchedule);
    const [showCheatsheet, setShowCheetsheet] = useState(false);

    useEffect(() => {
        return () => {
            clearFlashes('schedule:edit');
        };
    }, []);

    const submit = (values: Values, { setSubmitting }: FormikHelpers<Values>) => {
        clearFlashes('schedule:edit');
        createOrUpdateSchedule(uuid, {
            id: schedule?.id,
            name: values.name,
            cron: {
                minute: values.minute,
                hour: values.hour,
                dayOfWeek: values.dayOfWeek,
                month: values.month,
                dayOfMonth: values.dayOfMonth,
            },
            onlyWhenOnline: values.onlyWhenOnline,
            isActive: values.enabled,
        })
            .then((schedule) => {
                setSubmitting(false);
                appendSchedule(schedule);
                dismiss();
            })
            .catch((error) => {
                console.error(error);

                setSubmitting(false);
                addError({ key: 'schedule:edit', message: httpErrorToHuman(error) });
            });
    };

    return (
        <Formik
            onSubmit={submit}
            initialValues={
                {
                    name: schedule?.name || '',
                    minute: schedule?.cron.minute || '*/5',
                    hour: schedule?.cron.hour || '*',
                    dayOfMonth: schedule?.cron.dayOfMonth || '*',
                    month: schedule?.cron.month || '*',
                    dayOfWeek: schedule?.cron.dayOfWeek || '*',
                    enabled: schedule?.isActive ?? true,
                    onlyWhenOnline: schedule?.onlyWhenOnline ?? true,
                } as Values
            }
        >
            {({ isSubmitting }) => (
                <Form>
                    <h3 css={tw`text-2xl mb-6`}>{schedule ? 'Edit schedule' : 'Create new schedule'}</h3>
                    <FlashMessageRender byKey={'schedule:edit'} css={tw`mb-6`} />
                    <Field
                        name={'name'}
                        label={'Schedule name'}
                        description={'A human readable identifier for this schedule.'}
                    />
                    <div css={tw`grid grid-cols-2 sm:grid-cols-5 gap-4 mt-6`}>
                        <Field name={'minute'} label={'Minute'} />
                        <Field name={'hour'} label={'Hour'} />
                        <Field name={'dayOfMonth'} label={'Day of month'} />
                        <Field name={'month'} label={'Month'} />
                        <Field name={'dayOfWeek'} label={'Day of week'} />
                    </div>
                    <p css={tw`text-neutral-400 text-xs mt-2`}>
                        The schedule system supports the use of Cronjob syntax when defining when tasks should begin
                        running. Use the fields above to specify when these tasks should begin running.
                    </p>
                    <div css={tw`mt-6 bg-neutral-900 border border-neutral-800 shadow-inner p-4 rounded`}>
                        <Switch
                            name={'show_cheatsheet'}
                            description={'Show the cron cheatsheet for some examples.'}
                            label={'Show Cheatsheet'}
                            defaultChecked={showCheatsheet}
                            onChange={() => setShowCheetsheet((s) => !s)}
                        />
                        {showCheatsheet && (
                            <div css={tw`block md:flex w-full`}>
                                <ScheduleCheatsheetCards />
                            </div>
                        )}
                    </div>
                    <div css={tw`mt-6 bg-neutral-900 border border-neutral-800 shadow-inner p-4 rounded`}>
                        <FormikSwitch
                            name={'onlyWhenOnline'}
                            description={'Only execute this schedule when the server is in a running state.'}
                            label={'Only When Server Is Online'}
                        />
                    </div>
                    <div css={tw`mt-6 bg-neutral-900 border border-neutral-800 shadow-inner p-4 rounded`}>
                        <FormikSwitch
                            name={'enabled'}
                            description={'This schedule will be executed automatically if enabled.'}
                            label={'Schedule Enabled'}
                        />
                    </div>
                    <div css={tw`mt-6 text-right`}>
                        <Button className={'w-full sm:w-auto'} type={'submit'} disabled={isSubmitting}>
                            {schedule ? 'Save changes' : 'Create schedule'}
                        </Button>
                    </div>
                </Form>
            )}
        </Formik>
    );
};

export default asModal<Props>()(EditScheduleModal);
</file>

<file path="resources/scripts/components/server/schedules/NewTaskButton.tsx">
import React, { useState } from 'react';
import { Button } from '@/components/elements/button/index';
import { Schedule } from '@/api/server/schedules/getServerSchedules';
import TaskDetailsModal from '@/components/server/schedules/TaskDetailsModal';

interface Props {
    schedule: Schedule;
}

export default ({ schedule }: Props) => {
    const [visible, setVisible] = useState(false);

    return (
        <>
            <TaskDetailsModal schedule={schedule} visible={visible} onModalDismissed={() => setVisible(false)} />
            <Button onClick={() => setVisible(true)} className={'flex-1'}>
                New Task
            </Button>
        </>
    );
};
</file>

<file path="resources/scripts/components/server/schedules/RunScheduleButton.tsx">
import useFlash from '@/plugins/useFlash';
import { ServerContext } from '@/state/server';
import React, { useCallback, useState } from 'react';
import { Button } from '@/components/elements/button/index';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import { Schedule } from '@/api/server/schedules/getServerSchedules';
import triggerScheduleExecution from '@/api/server/schedules/triggerScheduleExecution';

const RunScheduleButton = ({ schedule }: { schedule: Schedule }) => {
    const [loading, setLoading] = useState(false);
    const { clearFlashes, clearAndAddHttpError } = useFlash();

    const id = ServerContext.useStoreState((state) => state.server.data!.id);
    const appendSchedule = ServerContext.useStoreActions((actions) => actions.schedules.appendSchedule);

    const onTriggerExecute = useCallback(() => {
        clearFlashes('schedule');
        setLoading(true);
        triggerScheduleExecution(id, schedule.id)
            .then(() => {
                setLoading(false);
                appendSchedule({ ...schedule, isProcessing: true });
            })
            .catch((error) => {
                console.error(error);
                clearAndAddHttpError({ error, key: 'schedules' });
            })
            .then(() => setLoading(false));
    }, []);

    return (
        <>
            <SpinnerOverlay visible={loading} size={'large'} />
            <Button
                variant={Button.Variants.Secondary}
                className={'flex-1 sm:flex-none'}
                disabled={schedule.isProcessing}
                onClick={onTriggerExecute}
            >
                Run Now
            </Button>
        </>
    );
};

export default RunScheduleButton;
</file>

<file path="resources/scripts/components/server/schedules/ScheduleCheatsheetCards.tsx">
import React from 'react';
import tw from 'twin.macro';

export default () => {
    return (
        <>
            <div css={tw`md:w-1/2 h-full bg-neutral-600`}>
                <div css={tw`flex flex-col`}>
                    <h2 css={tw`py-4 px-6 font-bold`}>Examples</h2>
                    <div css={tw`flex py-4 px-6 bg-neutral-500`}>
                        <div css={tw`w-1/2`}>*/5 * * * *</div>
                        <div css={tw`w-1/2`}>every 5 minutes</div>
                    </div>
                    <div css={tw`flex py-4 px-6`}>
                        <div css={tw`w-1/2`}>0 */1 * * *</div>
                        <div css={tw`w-1/2`}>every hour</div>
                    </div>
                    <div css={tw`flex py-4 px-6 bg-neutral-500`}>
                        <div css={tw`w-1/2`}>0 8-12 * * *</div>
                        <div css={tw`w-1/2`}>hour range</div>
                    </div>
                    <div css={tw`flex py-4 px-6`}>
                        <div css={tw`w-1/2`}>0 0 * * *</div>
                        <div css={tw`w-1/2`}>once a day</div>
                    </div>
                    <div css={tw`flex py-4 px-6 bg-neutral-500`}>
                        <div css={tw`w-1/2`}>0 0 * * MON</div>
                        <div css={tw`w-1/2`}>every Monday</div>
                    </div>
                </div>
            </div>
            <div css={tw`md:w-1/2 h-full bg-neutral-600`}>
                <h2 css={tw`py-4 px-6 font-bold`}>Special Characters</h2>
                <div css={tw`flex flex-col`}>
                    <div css={tw`flex py-4 px-6 bg-neutral-500`}>
                        <div css={tw`w-1/2`}>*</div>
                        <div css={tw`w-1/2`}>any value</div>
                    </div>
                    <div css={tw`flex py-4 px-6`}>
                        <div css={tw`w-1/2`}>,</div>
                        <div css={tw`w-1/2`}>value list separator</div>
                    </div>
                    <div css={tw`flex py-4 px-6 bg-neutral-500`}>
                        <div css={tw`w-1/2`}>-</div>
                        <div css={tw`w-1/2`}>range values</div>
                    </div>
                    <div css={tw`flex py-4 px-6`}>
                        <div css={tw`w-1/2`}>/</div>
                        <div css={tw`w-1/2`}>step values</div>
                    </div>
                </div>
            </div>
        </>
    );
};
</file>

<file path="resources/scripts/components/server/schedules/ScheduleContainer.tsx">
import tw from 'twin.macro';
import useFlash from '@/plugins/useFlash';
import Can from '@/components/elements/Can';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import React, { useEffect, useState } from 'react';
import Spinner from '@/components/elements/Spinner';
import GreyRowBox from '@/components/elements/GreyRowBox';
import { Button } from '@/components/elements/button/index';
import { useHistory, useRouteMatch } from 'react-router-dom';
import ScheduleRow from '@/components/server/schedules/ScheduleRow';
import ServerContentBlock from '@/components/elements/ServerContentBlock';
import getServerSchedules from '@/api/server/schedules/getServerSchedules';
import EditScheduleModal from '@/components/server/schedules/EditScheduleModal';

export default () => {
    const match = useRouteMatch();
    const history = useHistory();

    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const { clearFlashes, addError } = useFlash();
    const [loading, setLoading] = useState(true);
    const [visible, setVisible] = useState(false);

    const schedules = ServerContext.useStoreState((state) => state.schedules.data);
    const setSchedules = ServerContext.useStoreActions((actions) => actions.schedules.setSchedules);

    useEffect(() => {
        clearFlashes('schedules');
        getServerSchedules(uuid)
            .then((schedules) => setSchedules(schedules))
            .catch((error) => {
                addError({ message: httpErrorToHuman(error), key: 'schedules' });
                console.error(error);
            })
            .then(() => setLoading(false));
    }, []);

    return (
        <ServerContentBlock
            title={'Schedules'}
            description={'Manage scheduled functions for your server.'}
            showFlashKey={'schedules'}
        >
            {!schedules.length && loading ? (
                <Spinner size={'large'} centered />
            ) : (
                <>
                    {schedules.length === 0 ? (
                        <p css={tw`text-sm text-center text-neutral-300`}>
                            There are no schedules configured for this server.
                        </p>
                    ) : (
                        schedules.map((schedule) => (
                            <GreyRowBox
                                as={'a'}
                                key={schedule.id}
                                href={`${match.url}/${schedule.id}`}
                                css={tw`cursor-pointer mb-2 flex-wrap`}
                                onClick={(e: any) => {
                                    e.preventDefault();
                                    history.push(`${match.url}/${schedule.id}`);
                                }}
                            >
                                <ScheduleRow schedule={schedule} />
                            </GreyRowBox>
                        ))
                    )}
                    <Can action={'schedule.create'}>
                        <div css={tw`mt-8 flex justify-end`}>
                            <EditScheduleModal visible={visible} onModalDismissed={() => setVisible(false)} />
                            <Button type={'button'} onClick={() => setVisible(true)}>
                                Create schedule
                            </Button>
                        </div>
                    </Can>
                </>
            )}
        </ServerContentBlock>
    );
};
</file>

<file path="resources/scripts/components/server/schedules/ScheduleCronRow.tsx">
import React from 'react';
import { Schedule } from '@/api/server/schedules/getServerSchedules';
import classNames from 'classnames';

interface Props {
    cron: Schedule['cron'];
    className?: string;
}

const ScheduleCronRow = ({ cron, className }: Props) => (
    <div className={classNames('flex', className)}>
        <div className={'w-1/5 sm:w-auto text-center'}>
            <p className={'font-medium'}>{cron.minute}</p>
            <p className={'text-2xs text-neutral-500 uppercase'}>Minute</p>
        </div>
        <div className={'w-1/5 sm:w-auto text-center ml-4'}>
            <p className={'font-medium'}>{cron.hour}</p>
            <p className={'text-2xs text-neutral-500 uppercase'}>Hour</p>
        </div>
        <div className={'w-1/5 sm:w-auto text-center ml-4'}>
            <p className={'font-medium'}>{cron.dayOfMonth}</p>
            <p className={'text-2xs text-neutral-500 uppercase'}>Day (Month)</p>
        </div>
        <div className={'w-1/5 sm:w-auto text-center ml-4'}>
            <p className={'font-medium'}>{cron.month}</p>
            <p className={'text-2xs text-neutral-500 uppercase'}>Month</p>
        </div>
        <div className={'w-1/5 sm:w-auto text-center ml-4'}>
            <p className={'font-medium'}>{cron.dayOfWeek}</p>
            <p className={'text-2xs text-neutral-500 uppercase'}>Day (Week)</p>
        </div>
    </div>
);

export default ScheduleCronRow;
</file>

<file path="resources/scripts/components/server/schedules/ScheduleEditContainer.tsx">
import tw from 'twin.macro';
import { format } from 'date-fns';
import isEqual from 'react-fast-compare';
import useFlash from '@/plugins/useFlash';
import Can from '@/components/elements/Can';
import { ServerContext } from '@/state/server';
import Spinner from '@/components/elements/Spinner';
import { useHistory, useParams } from 'react-router-dom';
import { Button } from '@/components/elements/button/index';
import React, { useCallback, useEffect, useState } from 'react';
import FlashMessageRender from '@/components/FlashMessageRender';
import PageContentBlock from '@/components/elements/PageContentBlock';
import NewTaskButton from '@/components/server/schedules/NewTaskButton';
import getServerSchedule from '@/api/server/schedules/getServerSchedule';
import ScheduleTaskRow from '@/components/server/schedules/ScheduleTaskRow';
import ScheduleCronRow from '@/components/server/schedules/ScheduleCronRow';
import EditScheduleModal from '@/components/server/schedules/EditScheduleModal';
import RunScheduleButton from '@/components/server/schedules/RunScheduleButton';
import DeleteScheduleButton from '@/components/server/schedules/DeleteScheduleButton';

interface Params {
    id: string;
}

const CronBox = ({ title, value }: { title: string; value: string }) => (
    <div css={tw`bg-neutral-700 rounded p-3`}>
        <p css={tw`text-neutral-300 text-sm`}>{title}</p>
        <p css={tw`text-xl font-medium text-neutral-100`}>{value}</p>
    </div>
);

const ActivePill = ({ active }: { active: boolean }) => (
    <span
        css={[
            tw`rounded-full px-2 py-px text-xs ml-4 uppercase`,
            active ? tw`bg-green-600 text-green-100` : tw`bg-red-600 text-red-100`,
        ]}
    >
        {active ? 'Active' : 'Inactive'}
    </span>
);

export default () => {
    const history = useHistory();
    const { id: scheduleId } = useParams<Params>();

    const id = ServerContext.useStoreState((state) => state.server.data!.id);
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);

    const { clearFlashes, clearAndAddHttpError } = useFlash();
    const [isLoading, setIsLoading] = useState(true);
    const [showEditModal, setShowEditModal] = useState(false);

    const schedule = ServerContext.useStoreState(
        (st) => st.schedules.data.find((s) => s.id === Number(scheduleId)),
        isEqual
    );
    const appendSchedule = ServerContext.useStoreActions((actions) => actions.schedules.appendSchedule);

    useEffect(() => {
        if (schedule?.id === Number(scheduleId)) {
            setIsLoading(false);
            return;
        }

        clearFlashes('schedules');
        getServerSchedule(uuid, Number(scheduleId))
            .then((schedule) => appendSchedule(schedule))
            .catch((error) => {
                console.error(error);
                clearAndAddHttpError({ error, key: 'schedules' });
            })
            .then(() => setIsLoading(false));
    }, [scheduleId]);

    const toggleEditModal = useCallback(() => {
        setShowEditModal((s) => !s);
    }, []);

    return (
        <PageContentBlock title={'Schedules'}>
            <FlashMessageRender byKey={'schedules'} css={tw`mb-4`} />
            {!schedule || isLoading ? (
                <Spinner size={'large'} centered />
            ) : (
                <>
                    <ScheduleCronRow cron={schedule.cron} css={tw`sm:hidden bg-neutral-700 rounded mb-4 p-3`} />
                    <div css={tw`rounded shadow`}>
                        <div
                            css={tw`sm:flex items-center bg-neutral-900 p-3 sm:p-6 border-b-4 border-neutral-600 rounded-t`}
                        >
                            <div css={tw`flex-1`}>
                                <h3 css={tw`flex items-center text-neutral-100 text-2xl`}>
                                    {schedule.name}
                                    {schedule.isProcessing ? (
                                        <span
                                            css={tw`flex items-center rounded-full px-2 py-px text-xs ml-4 uppercase bg-neutral-600 text-white`}
                                        >
                                            <Spinner css={tw`w-3! h-3! mr-2`} />
                                            Processing
                                        </span>
                                    ) : (
                                        <ActivePill active={schedule.isActive} />
                                    )}
                                </h3>
                                <p css={tw`mt-1 text-sm text-neutral-200`}>
                                    Last run at:&nbsp;
                                    {schedule.lastRunAt ? (
                                        format(schedule.lastRunAt, "MMM do 'at' h:mma")
                                    ) : (
                                        <span css={tw`text-neutral-300`}>n/a</span>
                                    )}
                                    <span css={tw`ml-4 pl-4 border-l-4 border-neutral-600 py-px`}>
                                        Next run at:&nbsp;
                                        {schedule.nextRunAt ? (
                                            format(schedule.nextRunAt, "MMM do 'at' h:mma")
                                        ) : (
                                            <span css={tw`text-neutral-300`}>n/a</span>
                                        )}
                                    </span>
                                </p>
                            </div>
                            <div css={tw`flex sm:block mt-3 sm:mt-0`}>
                                <Can action={'schedule.update'}>
                                    <Button.Text className={'flex-1 mr-4'} onClick={toggleEditModal}>
                                        Edit
                                    </Button.Text>
                                    <NewTaskButton schedule={schedule} />
                                </Can>
                            </div>
                        </div>
                        <div css={tw`hidden sm:grid grid-cols-5 md:grid-cols-5 gap-4 mb-4 mt-4`}>
                            <CronBox title={'Minute'} value={schedule.cron.minute} />
                            <CronBox title={'Hour'} value={schedule.cron.hour} />
                            <CronBox title={'Day (Month)'} value={schedule.cron.dayOfMonth} />
                            <CronBox title={'Month'} value={schedule.cron.month} />
                            <CronBox title={'Day (Week)'} value={schedule.cron.dayOfWeek} />
                        </div>
                        <div css={tw`bg-neutral-700 rounded-b`}>
                            {schedule.tasks.length > 0
                                ? schedule.tasks
                                      .sort((a, b) =>
                                          a.sequenceId === b.sequenceId ? 0 : a.sequenceId > b.sequenceId ? 1 : -1
                                      )
                                      .map((task) => (
                                          <ScheduleTaskRow
                                              key={`${schedule.id}_${task.id}`}
                                              task={task}
                                              schedule={schedule}
                                          />
                                      ))
                                : null}
                        </div>
                    </div>
                    <EditScheduleModal visible={showEditModal} schedule={schedule} onModalDismissed={toggleEditModal} />
                    <div css={tw`mt-6 flex sm:justify-end`}>
                        <Can action={'schedule.delete'}>
                            <DeleteScheduleButton
                                scheduleId={schedule.id}
                                onDeleted={() => history.push(`/server/${id}/schedules`)}
                            />
                        </Can>
                        {schedule.tasks.length > 0 && (
                            <Can action={'schedule.update'}>
                                <RunScheduleButton schedule={schedule} />
                            </Can>
                        )}
                    </div>
                </>
            )}
        </PageContentBlock>
    );
};
</file>

<file path="resources/scripts/components/server/schedules/ScheduleRow.tsx">
import React from 'react';
import tw from 'twin.macro';
import { format } from 'date-fns';
import * as Icon from 'react-feather';
import { Schedule } from '@/api/server/schedules/getServerSchedules';
import ScheduleCronRow from '@/components/server/schedules/ScheduleCronRow';

export default ({ schedule }: { schedule: Schedule }) => (
    <>
        <div css={tw`hidden md:block`}>
            <Icon.Calendar />
        </div>
        <div css={tw`flex-1 md:ml-4`}>
            <p>{schedule.name}</p>
            <p css={tw`text-xs text-neutral-400`}>
                Last run at: {schedule.lastRunAt ? format(schedule.lastRunAt, "MMM do 'at' h:mma") : 'never'}
            </p>
        </div>
        <div>
            <p
                css={[
                    tw`py-1 px-3 rounded text-xs uppercase text-white sm:hidden`,
                    schedule.isActive ? tw`bg-green-600` : tw`bg-neutral-400`,
                ]}
            >
                {schedule.isActive ? 'Active' : 'Inactive'}
            </p>
        </div>
        <ScheduleCronRow cron={schedule.cron} css={tw`mx-auto sm:mx-8 w-full sm:w-auto mt-4 sm:mt-0`} />
        <div>
            <p
                css={[
                    tw`py-1 px-3 rounded text-xs uppercase text-white hidden sm:block`,
                    schedule.isActive && !schedule.isProcessing ? tw`bg-green-600` : tw`bg-neutral-400`,
                ]}
            >
                {schedule.isProcessing ? 'Processing' : schedule.isActive ? 'Active' : 'Inactive'}
            </p>
        </div>
    </>
);
</file>

<file path="resources/scripts/components/server/schedules/ScheduleTaskRow.tsx">
import tw from 'twin.macro';
import * as Icon from 'react-feather';
import React, { useState } from 'react';
import useFlash from '@/plugins/useFlash';
import Can from '@/components/elements/Can';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import { Dialog } from '@/components/elements/dialog';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import { Schedule, Task } from '@/api/server/schedules/getServerSchedules';
import deleteScheduleTask from '@/api/server/schedules/deleteScheduleTask';
import TaskDetailsModal from '@/components/server/schedules/TaskDetailsModal';

interface Props {
    schedule: Schedule;
    task: Task;
}

const getActionDetails = (action: string): [string] => {
    switch (action) {
        case 'command':
            return ['Send Command'];
        case 'power':
            return ['Send Power Action'];
        case 'backup':
            return ['Create Backup'];
        default:
            return ['Unknown Action'];
    }
};

export default ({ schedule, task }: Props) => {
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const { clearFlashes, addError } = useFlash();
    const [visible, setVisible] = useState(false);
    const [isLoading, setIsLoading] = useState(false);
    const [isEditing, setIsEditing] = useState(false);
    const appendSchedule = ServerContext.useStoreActions((actions) => actions.schedules.appendSchedule);

    const onConfirmDeletion = () => {
        setIsLoading(true);
        clearFlashes('schedules');
        deleteScheduleTask(uuid, schedule.id, task.id)
            .then(() =>
                appendSchedule({
                    ...schedule,
                    tasks: schedule.tasks.filter((t) => t.id !== task.id),
                })
            )
            .catch((error) => {
                console.error(error);
                setIsLoading(false);
                addError({ message: httpErrorToHuman(error), key: 'schedules' });
            });
    };

    const [title] = getActionDetails(task.action);

    return (
        <div css={tw`sm:flex items-center p-3 sm:p-6 border-b border-neutral-800`}>
            <SpinnerOverlay visible={isLoading} fixed size={'large'} />
            <TaskDetailsModal
                schedule={schedule}
                task={task}
                visible={isEditing}
                onModalDismissed={() => setIsEditing(false)}
            />
            <Dialog.Confirm
                open={visible}
                title={'Confirm task deletion'}
                confirm={'Yes, delete task'}
                onClose={() => setVisible(false)}
                onConfirmed={onConfirmDeletion}
            >
                Are you sure you want to delete this task? This action cannot be undone.
            </Dialog.Confirm>
            <div css={tw`flex-none sm:flex-1 w-full sm:w-auto overflow-x-auto`}>
                <p css={tw`md:ml-6 text-neutral-200 uppercase text-sm`}>{title}</p>
                {task.payload && (
                    <div css={tw`md:ml-6 mt-2`}>
                        {task.action === 'backup' && (
                            <p css={tw`text-xs uppercase text-neutral-400 mb-1`}>Ignoring files & folders:</p>
                        )}
                        <div
                            css={tw`font-mono bg-neutral-800 rounded py-1 px-2 text-sm w-auto inline-block whitespace-pre-wrap break-all`}
                        >
                            {task.payload}
                        </div>
                    </div>
                )}
            </div>
            <div css={tw`mt-3 sm:mt-0 flex items-center w-full sm:w-auto`}>
                {task.continueOnFailure && (
                    <div css={tw`mr-6`}>
                        <div css={tw`flex items-center px-2 py-1 bg-yellow-500 text-yellow-800 text-sm rounded-full`}>
                            <Icon.ChevronDown css={tw`w-3 h-3 mr-2`} />
                            Continues on Failure
                        </div>
                    </div>
                )}
                {task.sequenceId > 1 && task.timeOffset > 0 && (
                    <div css={tw`mr-6`}>
                        <div css={tw`flex items-center px-2 py-1 bg-neutral-500 text-sm rounded-full`}>
                            <Icon.Clock css={tw`w-3 h-3 mr-2`} />
                            {task.timeOffset}s later
                        </div>
                    </div>
                )}
                <Can action={'schedule.update'}>
                    <button
                        type={'button'}
                        aria-label={'Edit scheduled task'}
                        css={tw`block text-sm p-2 text-neutral-500 hover:text-neutral-100 transition-colors duration-150 mr-4 ml-auto sm:ml-0`}
                        onClick={() => setIsEditing(true)}
                    >
                        <Icon.PenTool />
                    </button>
                </Can>
                <Can action={'schedule.update'}>
                    <button
                        type={'button'}
                        aria-label={'Delete scheduled task'}
                        css={tw`block text-sm p-2 text-neutral-500 hover:text-red-600 transition-colors duration-150`}
                        onClick={() => setVisible(true)}
                    >
                        <Icon.Trash />
                    </button>
                </Can>
            </div>
        </div>
    );
};
</file>

<file path="resources/scripts/components/server/schedules/TaskDetailsModal.tsx">
import tw from 'twin.macro';
import asModal from '@/hoc/asModal';
import useFlash from '@/plugins/useFlash';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import Field from '@/components/elements/Field';
import Label from '@/components/elements/Label';
import Select from '@/components/elements/Select';
import ModalContext from '@/context/ModalContext';
import React, { useContext, useEffect } from 'react';
import { boolean, number, object, string } from 'yup';
import { Textarea } from '@/components/elements/Input';
import { Button } from '@/components/elements/button/index';
import FormikSwitch from '@/components/elements/FormikSwitch';
import FlashMessageRender from '@/components/FlashMessageRender';
import FormikFieldWrapper from '@/components/elements/FormikFieldWrapper';
import { Schedule, Task } from '@/api/server/schedules/getServerSchedules';
import { Field as FormikField, Form, Formik, FormikHelpers, useField } from 'formik';
import createOrUpdateScheduleTask from '@/api/server/schedules/createOrUpdateScheduleTask';

interface Props {
    schedule: Schedule;
    // If a task is provided we can assume we're editing it. If not provided,
    // we are creating a new one.
    task?: Task;
}

interface Values {
    action: string;
    payload: string;
    timeOffset: string;
    continueOnFailure: boolean;
}

const schema = object().shape({
    action: string().required().oneOf(['command', 'power', 'backup']),
    payload: string().when('action', {
        is: (v) => v !== 'backup',
        then: string().required('A task payload must be provided.'),
        otherwise: string(),
    }),
    continueOnFailure: boolean(),
    timeOffset: number()
        .typeError('The time offset must be a valid number between 0 and 900.')
        .required('A time offset value must be provided.')
        .min(0, 'The time offset must be at least 0 seconds.')
        .max(900, 'The time offset must be less than 900 seconds.'),
});

const ActionListener = () => {
    const [{ value }, { initialValue: initialAction }] = useField<string>('action');
    const [, { initialValue: initialPayload }, { setValue, setTouched }] = useField<string>('payload');

    useEffect(() => {
        if (value !== initialAction) {
            setValue(value === 'power' ? 'start' : '');
            setTouched(false);
        } else {
            setValue(initialPayload || '');
            setTouched(false);
        }
    }, [value]);

    return null;
};

const TaskDetailsModal = ({ schedule, task }: Props) => {
    const { dismiss } = useContext(ModalContext);
    const { clearFlashes, addError } = useFlash();

    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const appendSchedule = ServerContext.useStoreActions((actions) => actions.schedules.appendSchedule);
    const backupLimit = ServerContext.useStoreState((state) => state.server.data!.featureLimits.backups);

    useEffect(() => {
        return () => {
            clearFlashes('schedule:task');
        };
    }, []);

    const submit = (values: Values, { setSubmitting }: FormikHelpers<Values>) => {
        clearFlashes('schedule:task');
        if (backupLimit === 0 && values.action === 'backup') {
            setSubmitting(false);
            addError({
                message: "A backup task cannot be created when the server's backup limit is set to 0.",
                key: 'schedule:task',
            });
        } else {
            createOrUpdateScheduleTask(uuid, schedule.id, task?.id, values)
                .then((task) => {
                    let tasks = schedule.tasks.map((t) => (t.id === task.id ? task : t));
                    if (!schedule.tasks.find((t) => t.id === task.id)) {
                        tasks = [...tasks, task];
                    }

                    appendSchedule({ ...schedule, tasks });
                    dismiss();
                })
                .catch((error) => {
                    console.error(error);
                    setSubmitting(false);
                    addError({ message: httpErrorToHuman(error), key: 'schedule:task' });
                });
        }
    };

    return (
        <Formik
            onSubmit={submit}
            validationSchema={schema}
            initialValues={{
                action: task?.action || 'command',
                payload: task?.payload || '',
                timeOffset: task?.timeOffset.toString() || '0',
                continueOnFailure: task?.continueOnFailure || false,
            }}
        >
            {({ isSubmitting, values }) => (
                <Form css={tw`m-0`}>
                    <FlashMessageRender byKey={'schedule:task'} css={tw`mb-4`} />
                    <h2 css={tw`text-2xl mb-6`}>{task ? 'Edit Task' : 'Create Task'}</h2>
                    <div css={tw`flex`}>
                        <div css={tw`mr-2 w-1/3`}>
                            <Label>Action</Label>
                            <ActionListener />
                            <FormikFieldWrapper name={'action'}>
                                <FormikField as={Select} name={'action'}>
                                    <option value={'command'}>Send command</option>
                                    <option value={'power'}>Send power action</option>
                                    <option value={'backup'}>Create backup</option>
                                </FormikField>
                            </FormikFieldWrapper>
                        </div>
                        <div css={tw`flex-1 ml-6`}>
                            <Field
                                name={'timeOffset'}
                                label={'Time offset (in seconds)'}
                                description={
                                    'The amount of time to wait after the previous task executes before running this one. If this is the first task on a schedule this will not be applied.'
                                }
                            />
                        </div>
                    </div>
                    <div css={tw`mt-6`}>
                        {values.action === 'command' ? (
                            <div>
                                <Label>Payload</Label>
                                <FormikFieldWrapper name={'payload'}>
                                    <FormikField as={Textarea} name={'payload'} rows={6} />
                                </FormikFieldWrapper>
                            </div>
                        ) : values.action === 'power' ? (
                            <div>
                                <Label>Payload</Label>
                                <FormikFieldWrapper name={'payload'}>
                                    <FormikField as={Select} name={'payload'}>
                                        <option value={'start'}>Start the server</option>
                                        <option value={'restart'}>Restart the server</option>
                                        <option value={'stop'}>Stop the server</option>
                                        <option value={'kill'}>Terminate the server</option>
                                    </FormikField>
                                </FormikFieldWrapper>
                            </div>
                        ) : (
                            <div>
                                <Label>Ignored Files</Label>
                                <FormikFieldWrapper
                                    name={'payload'}
                                    description={
                                        'Optional. Include the files and folders to be excluded in this backup. By default, the contents of your .pteroignore file will be used. If you have reached your backup limit, the oldest backup will be rotated.'
                                    }
                                >
                                    <FormikField as={Textarea} name={'payload'} rows={6} />
                                </FormikFieldWrapper>
                            </div>
                        )}
                    </div>
                    <div css={tw`mt-6 bg-neutral-700 border border-neutral-800 shadow-inner p-4 rounded`}>
                        <FormikSwitch
                            name={'continueOnFailure'}
                            description={'Future tasks will be run when this task fails.'}
                            label={'Continue on Failure'}
                        />
                    </div>
                    <div css={tw`flex justify-end mt-6`}>
                        <Button type={'submit'} disabled={isSubmitting}>
                            {task ? 'Save Changes' : 'Create Task'}
                        </Button>
                    </div>
                </Form>
            )}
        </Formik>
    );
};

export default asModal<Props>()(TaskDetailsModal);
</file>

<file path="resources/scripts/components/server/settings/ChangeBackgroundBox.tsx">
import React from 'react';
import tw from 'twin.macro';
import { object, string } from 'yup';
import { ApplicationStore } from '@/state';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import Field from '@/components/elements/Field';
import { Actions, useStoreActions } from 'easy-peasy';
import { Button } from '@/components/elements/button/index';
import changeBackground from '@/api/server/changeBackground';
import TitledGreyBox from '@/components/elements/TitledGreyBox';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import { Form, Formik, FormikHelpers, useFormikContext } from 'formik';

interface Values {
    bg: string;
}

const ChangeBackgroundBox = () => {
    const { isSubmitting } = useFormikContext<Values>();

    return (
        <TitledGreyBox title={'Change Server Background'} css={tw`relative`}>
            <SpinnerOverlay visible={isSubmitting} />
            <Form css={tw`mb-0`}>
                <Field id={'bg'} name={'bg'} label={'Server Background'} type={'text'} />
                <div css={tw`mt-6 text-right`}>
                    <Button type={'submit'}>Save</Button>
                </div>
            </Form>
        </TitledGreyBox>
    );
};

export default () => {
    const server = ServerContext.useStoreState((state) => state.server.data!);
    const setServer = ServerContext.useStoreActions((actions) => actions.server.setServer);
    const { addError, clearFlashes } = useStoreActions((actions: Actions<ApplicationStore>) => actions.flashes);

    const submit = ({ bg }: Values, { setSubmitting }: FormikHelpers<Values>) => {
        clearFlashes('settings');
        changeBackground(server.uuid, bg)
            .then(() => setServer({ ...server, bg }))
            .catch((error) => {
                console.error(error);
                addError({ key: 'settings', message: httpErrorToHuman(error) });
            })
            .then(() => setSubmitting(false));
    };

    return (
        <Formik
            onSubmit={submit}
            initialValues={{
                bg: server.bg,
            }}
            validationSchema={object().shape({
                bg: string().nullable().url(),
            })}
        >
            <ChangeBackgroundBox />
        </Formik>
    );
};
</file>

<file path="resources/scripts/components/server/settings/DeleteServerBox.tsx">
import React, { useState } from 'react';
import useFlash from '@/plugins/useFlash';
import Code from '@/components/elements/Code';
import { ServerContext } from '@/state/server';
import Input from '@/components/elements/Input';
import deleteServer from '@/api/server/deleteServer';
import { Dialog } from '@/components/elements/dialog';
import { Button } from '@/components/elements/button/index';
import TitledGreyBox from '@/components/elements/TitledGreyBox';

export default () => {
    const [name, setName] = useState('');
    const [warn, setWarn] = useState(false);
    const [confirm, setConfirm] = useState(false);

    const { addFlash, clearFlashes, clearAndAddHttpError } = useFlash();

    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const serverName = ServerContext.useStoreState((state) => state.server.data!.name);

    const submit = (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();
        e.stopPropagation();
        clearFlashes('settings');

        deleteServer(uuid, name)
            .then(() => {
                setConfirm(false);
                addFlash({
                    key: 'settings',
                    type: 'success',
                    message: 'Your server has been deleted.',
                });
                // @ts-expect-error this is valid
                window.location = '/';
            })
            .catch((error) => clearAndAddHttpError({ key: 'settings', error }));
    };

    return (
        <TitledGreyBox title={'Delete Server'} className={'relative mb-12'}>
            <Dialog.Confirm
                open={warn}
                title={'Confirm server deletion'}
                confirm={'Yes, delete server'}
                onClose={() => setWarn(false)}
                onConfirmed={() => {
                    setConfirm(true);
                    setWarn(false);
                }}
            >
                Your server will be deleted, with all files being purged and the server&apos;s resources being returned
                to your account. Are you sure you wish to continue?
            </Dialog.Confirm>
            <form id={'delete-server-form'} onSubmit={submit}>
                <Dialog
                    open={confirm}
                    title={'Confirm server deletion'}
                    onClose={() => {
                        setConfirm(false);
                        setName('');
                    }}
                >
                    {name !== serverName && (
                        <>
                            <p className={'my-2 text-gray-400'}>
                                Type <Code>{serverName}</Code> below.
                            </p>
                            <Input type={'text'} value={name} onChange={(n) => setName(n.target.value)} />
                        </>
                    )}
                    <Button
                        disabled={name !== serverName}
                        type={'submit'}
                        className={'mt-2'}
                        form={'delete-server-form'}
                    >
                        Yes, delete server
                    </Button>
                </Dialog>
            </form>
            <p className={'text-sm'}>
                Deleting your server will shut down any processes, return the resources to your account and delete all
                files associated with the instance - as well as backups, databases and settings.{' '}
                <strong className={'font-medium'}>
                    All data will be permenantly lost if you continue with this action.
                </strong>
            </p>
            <div className={'mt-6 font-medium text-right'}>
                <Button.Danger variant={Button.Variants.Secondary} onClick={() => setWarn(true)}>
                    Delete Server
                </Button.Danger>
            </div>
        </TitledGreyBox>
    );
};
</file>

<file path="resources/scripts/components/server/settings/ReinstallServerBox.tsx">
import tw from 'twin.macro';
import { ApplicationStore } from '@/state';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import React, { useEffect, useState } from 'react';
import { Actions, useStoreActions } from 'easy-peasy';
import { Dialog } from '@/components/elements/dialog';
import reinstallServer from '@/api/server/reinstallServer';
import { Button } from '@/components/elements/button/index';
import TitledGreyBox from '@/components/elements/TitledGreyBox';

export default () => {
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const [modalVisible, setModalVisible] = useState(false);
    const { addFlash, clearFlashes } = useStoreActions((actions: Actions<ApplicationStore>) => actions.flashes);

    const reinstall = () => {
        clearFlashes('settings');
        reinstallServer(uuid)
            .then(() => {
                addFlash({
                    key: 'settings',
                    type: 'success',
                    message: 'Your server has begun the reinstallation process.',
                });
            })
            .catch((error) => {
                console.error(error);

                addFlash({ key: 'settings', type: 'danger', message: httpErrorToHuman(error) });
            })
            .then(() => setModalVisible(false));
    };

    useEffect(() => {
        clearFlashes();
    }, []);

    return (
        <TitledGreyBox title={'Reinstall Server'} css={tw`relative`}>
            <Dialog.Confirm
                open={modalVisible}
                title={'Confirm server reinstallation'}
                confirm={'Yes, reinstall server'}
                onClose={() => setModalVisible(false)}
                onConfirmed={reinstall}
            >
                Your server will be stopped and some files may be deleted or modified during this process, are you sure
                you wish to continue?
            </Dialog.Confirm>
            <p css={tw`text-sm`}>
                Reinstalling your server will stop it, and then re-run the installation script that initially set it
                up.&nbsp;
                <strong css={tw`font-medium`}>
                    Some files may be deleted or modified during this process, please back up your data before
                    continuing.
                </strong>
            </p>
            <div css={tw`mt-6 text-right`}>
                <Button.Danger variant={Button.Variants.Secondary} onClick={() => setModalVisible(true)}>
                    Reinstall Server
                </Button.Danger>
            </div>
        </TitledGreyBox>
    );
};
</file>

<file path="resources/scripts/components/server/settings/RenameServerBox.tsx">
import React from 'react';
import tw from 'twin.macro';
import { object, string } from 'yup';
import { ApplicationStore } from '@/state';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import Field from '@/components/elements/Field';
import Label from '@/components/elements/Label';
import renameServer from '@/api/server/renameServer';
import { Actions, useStoreActions } from 'easy-peasy';
import { Textarea } from '@/components/elements/Input';
import { Button } from '@/components/elements/button/index';
import TitledGreyBox from '@/components/elements/TitledGreyBox';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import FormikFieldWrapper from '@/components/elements/FormikFieldWrapper';
import { Field as FormikField, Form, Formik, FormikHelpers, useFormikContext } from 'formik';

interface Values {
    name: string;
    description: string;
}

const RenameServerBox = () => {
    const { isSubmitting } = useFormikContext<Values>();

    return (
        <TitledGreyBox title={'Change Server Details'} css={tw`relative`}>
            <SpinnerOverlay visible={isSubmitting} />
            <Form css={tw`mb-0`}>
                <Field id={'name'} name={'name'} label={'Server Name'} type={'text'} />
                <div css={tw`mt-6`}>
                    <Label>Server Description</Label>
                    <FormikFieldWrapper name={'description'}>
                        <FormikField as={Textarea} name={'description'} rows={3} />
                    </FormikFieldWrapper>
                </div>
                <div css={tw`mt-6 text-right`}>
                    <Button type={'submit'}>Save</Button>
                </div>
            </Form>
        </TitledGreyBox>
    );
};

export default () => {
    const server = ServerContext.useStoreState((state) => state.server.data!);
    const setServer = ServerContext.useStoreActions((actions) => actions.server.setServer);
    const { addError, clearFlashes } = useStoreActions((actions: Actions<ApplicationStore>) => actions.flashes);

    const submit = ({ name, description }: Values, { setSubmitting }: FormikHelpers<Values>) => {
        clearFlashes('settings');
        renameServer(server.uuid, name, description)
            .then(() => setServer({ ...server, name, description }))
            .catch((error) => {
                console.error(error);
                addError({ key: 'settings', message: httpErrorToHuman(error) });
            })
            .then(() => setSubmitting(false));
    };

    return (
        <Formik
            onSubmit={submit}
            initialValues={{
                name: server.name,
                description: server.description,
            }}
            validationSchema={object().shape({
                name: string().required().min(1),
                description: string().nullable(),
            })}
        >
            <RenameServerBox />
        </Formik>
    );
};
</file>

<file path="resources/scripts/components/server/settings/SettingsContainer.tsx">
import React from 'react';
import tw from 'twin.macro';
import Can from '@/components/elements/Can';
import { ServerContext } from '@/state/server';
import CopyOnClick from '@/components/elements/CopyOnClick';
import TitledGreyBox from '@/components/elements/TitledGreyBox';
import ServerContentBlock from '@/components/elements/ServerContentBlock';
import RenameServerBox from '@/components/server/settings/RenameServerBox';
import DeleteServerBox from '@/components/server/settings/DeleteServerBox';
import ReinstallServerBox from '@/components/server/settings/ReinstallServerBox';
import ChangeBackgroundBox from '@/components/server/settings/ChangeBackgroundBox';
import { useStoreState } from 'easy-peasy';

export default () => {
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const node = ServerContext.useStoreState((state) => state.server.data!.node);
    const deletion = useStoreState((state) => state.storefront.data!.deletion.enabled);
    return (
        <ServerContentBlock
            title={'Settings'}
            description={'Control important settings for your server.'}
            showFlashKey={'settings'}
        >
            <div className={'md:flex'}>
                <div className={'w-full md:flex-1 md:mr-10'}>
                    <TitledGreyBox title={'Debug Information'} css={tw`mb-6 md:mb-10`}>
                        <div css={tw`flex items-center justify-between text-sm`}>
                            <p>Node</p>
                            <code css={tw`font-mono bg-neutral-900 rounded py-1 px-2`}>{node}</code>
                        </div>
                        <CopyOnClick text={uuid}>
                            <div css={tw`flex items-center justify-between mt-2 text-sm`}>
                                <p>Server ID</p>
                                <code css={tw`font-mono bg-neutral-900 rounded py-1 px-2`}>{uuid}</code>
                            </div>
                        </CopyOnClick>
                    </TitledGreyBox>
                    {deletion && <DeleteServerBox />}
                    <ChangeBackgroundBox />
                </div>
                <div className={'w-full mt-6 md:flex-1 md:mt-0'}>
                    <Can action={'settings.rename'}>
                        <div css={tw`mb-6 md:mb-10`}>
                            <RenameServerBox />
                        </div>
                    </Can>
                    <Can action={'settings.reinstall'}>
                        <ReinstallServerBox />
                    </Can>
                </div>
            </div>
        </ServerContentBlock>
    );
};
</file>

<file path="resources/scripts/components/server/startup/StartupContainer.tsx">
import tw from 'twin.macro';
import isEqual from 'react-fast-compare';
import useFlash from '@/plugins/useFlash';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import Input from '@/components/elements/Input';
import Select from '@/components/elements/Select';
import Spinner from '@/components/elements/Spinner';
import getServerStartup from '@/api/swr/getServerStartup';
import InputSpinner from '@/components/elements/InputSpinner';
import React, { useCallback, useEffect, useState } from 'react';
import TitledGreyBox from '@/components/elements/TitledGreyBox';
import { ServerError } from '@/components/elements/ScreenBlock';
import VariableBox from '@/components/server/startup/VariableBox';
import { useDeepCompareEffect } from '@/plugins/useDeepCompareEffect';
import setSelectedDockerImage from '@/api/server/setSelectedDockerImage';
import ServerContentBlock from '@/components/elements/ServerContentBlock';

const StartupContainer = () => {
    const [loading, setLoading] = useState(false);
    const { clearFlashes, clearAndAddHttpError } = useFlash();

    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const variables = ServerContext.useStoreState(
        ({ server }) => ({
            variables: server.data!.variables,
            invocation: server.data!.invocation,
            dockerImage: server.data!.dockerImage,
        }),
        isEqual
    );

    const { data, error, isValidating, mutate } = getServerStartup(uuid, {
        ...variables,
        dockerImages: { [variables.dockerImage]: variables.dockerImage },
    });

    const setServerFromState = ServerContext.useStoreActions((actions) => actions.server.setServerFromState);
    const isCustomImage =
        data &&
        !Object.values(data.dockerImages)
            .map((v) => v.toLowerCase())
            .includes(variables.dockerImage.toLowerCase());

    useEffect(() => {
        // Since we're passing in initial data this will not trigger on mount automatically. We
        // want to always fetch fresh information from the API however when we're loading the startup
        // information.
        mutate();
    }, []);

    useDeepCompareEffect(() => {
        if (!data) return;

        setServerFromState((s) => ({
            ...s,
            invocation: data.invocation,
            variables: data.variables,
        }));
    }, [data]);

    const updateSelectedDockerImage = useCallback(
        (v: React.ChangeEvent<HTMLSelectElement>) => {
            setLoading(true);
            clearFlashes('startup:image');

            const image = v.currentTarget.value;
            setSelectedDockerImage(uuid, image)
                .then(() => setServerFromState((s) => ({ ...s, dockerImage: image })))
                .catch((error) => {
                    console.error(error);
                    clearAndAddHttpError({ key: 'startup:image', error });
                })
                .then(() => setLoading(false));
        },
        [uuid]
    );

    return !data ? (
        !error || (error && isValidating) ? (
            <Spinner centered size={Spinner.Size.LARGE} />
        ) : (
            <ServerError title={'Oops!'} message={httpErrorToHuman(error)} onRetry={() => mutate()} />
        )
    ) : (
        <ServerContentBlock
            title={'Startup Settings'}
            description={'Fine-tune variables for your server during startup.'}
            showFlashKey={'startup:image'}
        >
            <div className={'md:flex j-up'}>
                <TitledGreyBox title={'Startup Command'} css={tw`flex-1`}>
                    <div css={tw`px-1 py-2`}>
                        <p css={tw`font-mono bg-neutral-900 rounded py-2 px-4`}>{data.invocation}</p>
                    </div>
                </TitledGreyBox>
                <TitledGreyBox title={'Docker Image'} css={tw`flex-1 lg:flex-none lg:w-1/3 mt-8 md:mt-0 md:ml-10`}>
                    {Object.keys(data.dockerImages).length > 1 && !isCustomImage ? (
                        <>
                            <InputSpinner visible={loading}>
                                <Select
                                    disabled={Object.keys(data.dockerImages).length < 2}
                                    onChange={updateSelectedDockerImage}
                                    defaultValue={variables.dockerImage}
                                >
                                    {Object.keys(data.dockerImages).map((key) => (
                                        <option key={data.dockerImages[key]} value={data.dockerImages[key]}>
                                            {key}
                                        </option>
                                    ))}
                                </Select>
                            </InputSpinner>
                            <p css={tw`text-xs text-neutral-300 mt-2`}>
                                This is an advanced feature allowing you to select a Docker image to use when running
                                this server instance.
                            </p>
                        </>
                    ) : (
                        <>
                            <Input disabled readOnly value={variables.dockerImage} />
                            {isCustomImage && (
                                <p css={tw`text-xs text-neutral-300 mt-2`}>
                                    This {"server's"} Docker image has been manually set by an administrator and cannot
                                    be changed through this UI.
                                </p>
                            )}
                        </>
                    )}
                </TitledGreyBox>
            </div>
            <h3 css={tw`mt-8 mb-2 text-2xl`}>Variables</h3>
            <div className={'grid gap-8 md:grid-cols-2'}>
                {data.variables.map((variable) => (
                    <VariableBox key={variable.envVariable} variable={variable} />
                ))}
            </div>
        </ServerContentBlock>
    );
};

export default StartupContainer;
</file>

<file path="resources/scripts/components/server/startup/VariableBox.tsx">
import tw from 'twin.macro';
import { debounce } from 'debounce';
import isEqual from 'react-fast-compare';
import useFlash from '@/plugins/useFlash';
import React, { memo, useState } from 'react';
import { ServerContext } from '@/state/server';
import Input from '@/components/elements/Input';
import Switch from '@/components/elements/Switch';
import Select from '@/components/elements/Select';
import { ServerEggVariable } from '@/api/server/types';
import { usePermissions } from '@/plugins/usePermissions';
import getServerStartup from '@/api/swr/getServerStartup';
import InputSpinner from '@/components/elements/InputSpinner';
import TitledGreyBox from '@/components/elements/TitledGreyBox';
import FlashMessageRender from '@/components/FlashMessageRender';
import updateStartupVariable from '@/api/server/updateStartupVariable';

interface Props {
    variable: ServerEggVariable;
}

const VariableBox = ({ variable }: Props) => {
    const FLASH_KEY = `server:startup:${variable.envVariable}`;

    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const [loading, setLoading] = useState(false);
    const [canEdit] = usePermissions(['startup.update']);
    const { clearFlashes, clearAndAddHttpError } = useFlash();
    const { mutate } = getServerStartup(uuid);

    const setVariableValue = debounce((value: string) => {
        setLoading(true);
        clearFlashes(FLASH_KEY);

        updateStartupVariable(uuid, variable.envVariable, value)
            .then(([response, invocation]) =>
                mutate(
                    (data) => ({
                        ...data,
                        invocation,
                        variables: (data.variables || []).map((v) =>
                            v.envVariable === response.envVariable ? response : v
                        ),
                    }),
                    false
                )
            )
            .catch((error) => {
                console.error(error);
                clearAndAddHttpError({ error, key: FLASH_KEY });
            })
            .then(() => setLoading(false));
    }, 500);

    const useSwitch = variable.rules.some(
        (v) => v === 'boolean' || v === 'in:0,1' || v === 'in:1,0' || v === 'in:true,false' || v === 'in:false,true'
    );
    const isStringSwitch = variable.rules.some((v) => v === 'string');
    const selectValues = variable.rules.find((v) => v.startsWith('in:'))?.split(',') || [];

    return (
        <TitledGreyBox
            title={
                <p css={tw`text-sm uppercase`}>
                    {!variable.isEditable && (
                        <span css={tw`bg-neutral-700 text-xs py-1 px-2 rounded-full mr-2 mb-1`}>Read Only</span>
                    )}
                    {variable.name}
                </p>
            }
        >
            <FlashMessageRender byKey={FLASH_KEY} css={tw`mb-2 md:mb-4`} />
            <InputSpinner visible={loading}>
                {useSwitch ? (
                    <>
                        <Switch
                            readOnly={!canEdit || !variable.isEditable}
                            name={variable.envVariable}
                            defaultChecked={
                                isStringSwitch ? variable.serverValue === 'true' : variable.serverValue === '1'
                            }
                            onChange={() => {
                                if (canEdit && variable.isEditable) {
                                    if (isStringSwitch) {
                                        setVariableValue(variable.serverValue === 'true' ? 'false' : 'true');
                                    } else {
                                        setVariableValue(variable.serverValue === '1' ? '0' : '1');
                                    }
                                }
                            }}
                        />
                    </>
                ) : (
                    <>
                        {selectValues.length > 0 ? (
                            <>
                                <Select
                                    onChange={(e) => setVariableValue(e.target.value)}
                                    name={variable.envVariable}
                                    defaultValue={variable.serverValue}
                                    disabled={!canEdit || !variable.isEditable}
                                >
                                    {selectValues.map((selectValue) => (
                                        <option
                                            key={selectValue.replace('in:', '')}
                                            value={selectValue.replace('in:', '')}
                                        >
                                            {selectValue.replace('in:', '')}
                                        </option>
                                    ))}
                                </Select>
                            </>
                        ) : (
                            <>
                                <Input
                                    onKeyUp={(e) => {
                                        if (canEdit && variable.isEditable) {
                                            setVariableValue(e.currentTarget.value);
                                        }
                                    }}
                                    readOnly={!canEdit || !variable.isEditable}
                                    name={variable.envVariable}
                                    defaultValue={variable.serverValue}
                                    placeholder={variable.defaultValue}
                                />
                            </>
                        )}
                    </>
                )}
            </InputSpinner>
            <p css={tw`mt-1 text-xs text-neutral-300`}>{variable.description}</p>
        </TitledGreyBox>
    );
};

export default memo(VariableBox, isEqual);
</file>

<file path="resources/scripts/components/server/users/AddSubuserButton.tsx">
import React, { useState } from 'react';
import { Button } from '@/components/elements/button/index';
import EditSubuserModal from '@/components/server/users/EditSubuserModal';

export default () => {
    const [visible, setVisible] = useState(false);

    return (
        <>
            <EditSubuserModal visible={visible} onModalDismissed={() => setVisible(false)} />
            <Button onClick={() => setVisible(true)}>New User</Button>
        </>
    );
};
</file>

<file path="resources/scripts/components/server/users/EditSubuserModal.tsx">
import tw from 'twin.macro';
import asModal from '@/hoc/asModal';
import { Form, Formik } from 'formik';
import { ApplicationStore } from '@/state';
import { array, object, string } from 'yup';
import Can from '@/components/elements/Can';
import { ServerContext } from '@/state/server';
import Field from '@/components/elements/Field';
import { Subuser } from '@/state/server/subusers';
import ModalContext from '@/context/ModalContext';
import { usePermissions } from '@/plugins/usePermissions';
import { Button } from '@/components/elements/button/index';
import React, { useContext, useEffect, useRef } from 'react';
import FlashMessageRender from '@/components/FlashMessageRender';
import { useDeepCompareMemo } from '@/plugins/useDeepCompareMemo';
import PermissionRow from '@/components/server/users/PermissionRow';
import { Actions, useStoreActions, useStoreState } from 'easy-peasy';
import createOrUpdateSubuser from '@/api/server/users/createOrUpdateSubuser';
import PermissionTitleBox from '@/components/server/users/PermissionTitleBox';
import SelectAllPermissions from '@/components/server/users/SelectAllPermissions';

type Props = {
    subuser?: Subuser;
};

interface Values {
    email: string;
    permissions: string[];
}

const EditSubuserModal = ({ subuser }: Props) => {
    const ref = useRef<HTMLHeadingElement>(null);
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const appendSubuser = ServerContext.useStoreActions((actions) => actions.subusers.appendSubuser);
    const { clearFlashes, clearAndAddHttpError } = useStoreActions(
        (actions: Actions<ApplicationStore>) => actions.flashes
    );
    const { dismiss, setPropOverrides } = useContext(ModalContext);

    const isRootAdmin = useStoreState((state) => state.user.data!.rootAdmin);
    const permissions = useStoreState((state) => state.permissions.data);
    // The currently logged in user's permissions. We're going to filter out any permissions
    // that they should not need.
    const loggedInPermissions = ServerContext.useStoreState((state) => state.server.permissions);
    const [canEditUser] = usePermissions(subuser ? ['user.update'] : ['user.create']);

    // The permissions that can be modified by this user.
    const editablePermissions = useDeepCompareMemo(() => {
        const cleaned = Object.keys(permissions).map((key) =>
            Object.keys(permissions[key].keys).map((pkey) => `${key}.${pkey}`)
        );

        const list: string[] = ([] as string[]).concat.apply([], Object.values(cleaned));

        if (isRootAdmin || (loggedInPermissions.length === 1 && loggedInPermissions[0] === '*')) {
            return list;
        }

        return list.filter((key) => loggedInPermissions.indexOf(key) >= 0);
    }, [isRootAdmin, permissions, loggedInPermissions]);

    const submit = (values: Values) => {
        setPropOverrides({ showSpinnerOverlay: true });
        clearFlashes('user:edit');

        createOrUpdateSubuser(uuid, values, subuser)
            .then((subuser) => {
                appendSubuser(subuser);
                dismiss();
            })
            .catch((error) => {
                console.error(error);
                setPropOverrides(null);
                clearAndAddHttpError({ key: 'user:edit', error });

                if (ref.current) {
                    ref.current.scrollIntoView();
                }
            });
    };

    useEffect(
        () => () => {
            clearFlashes('user:edit');
        },
        []
    );

    return (
        <Formik
            onSubmit={submit}
            initialValues={
                {
                    email: subuser?.email || '',
                    permissions: subuser?.permissions || [],
                } as Values
            }
            validationSchema={object().shape({
                email: string()
                    .max(191, 'Email addresses must not exceed 191 characters.')
                    .email('A valid email address must be provided.')
                    .required('A valid email address must be provided.'),
                permissions: array().of(string()),
            })}
        >
            <Form>
                <div css={tw`flex justify-between`}>
                    <h2 css={tw`text-2xl`} ref={ref}>
                        {subuser
                            ? `${canEditUser ? 'Modify' : 'View'} permissions for ${subuser.email}`
                            : 'Create new subuser'}
                    </h2>
                    <div>
                        <Button type={'submit'} css={tw`w-full sm:w-auto`}>
                            {subuser ? 'Save' : 'Invite User'}
                        </Button>
                    </div>
                </div>
                <FlashMessageRender byKey={'user:edit'} css={tw`mt-4`} />
                {!isRootAdmin && loggedInPermissions[0] !== '*' && (
                    <div css={tw`mt-4 pl-4 py-2 border-l-4 border-cyan-400`}>
                        <p css={tw`text-sm text-neutral-300`}>
                            Only permissions which your account is currently assigned may be selected when creating or
                            modifying other users.
                        </p>
                    </div>
                )}
                {!subuser && (
                    <div css={tw`mt-6`}>
                        <Field
                            name={'email'}
                            label={'User Email'}
                            description={
                                'Enter the email address of the user you wish to invite as a subuser for this server.'
                            }
                        />
                    </div>
                )}
                <div css={tw`my-6`}>
                    <div css={tw`flex items-center mb-4 p-2 bg-gray-800 rounded shadow-sm`}>
                        <p css={tw`flex-1 ml-1`}>Select all permissions?</p>
                        {canEditUser && (
                            <SelectAllPermissions isEditable={canEditUser} permissions={editablePermissions} />
                        )}
                    </div>
                    {Object.keys(permissions)
                        .filter((key) => key !== 'websocket')
                        .map((key, index) => (
                            <PermissionTitleBox
                                key={`permission_${key}`}
                                title={key}
                                isEditable={canEditUser}
                                permissions={Object.keys(permissions[key].keys).map((pkey) => `${key}.${pkey}`)}
                                css={index > 0 ? tw`mt-4` : undefined}
                            >
                                <p css={tw`text-sm text-neutral-400 mb-4`}>{permissions[key].description}</p>
                                {Object.keys(permissions[key].keys).map((pkey) => (
                                    <PermissionRow
                                        key={`permission_${key}.${pkey}`}
                                        permission={`${key}.${pkey}`}
                                        disabled={!canEditUser || editablePermissions.indexOf(`${key}.${pkey}`) < 0}
                                    />
                                ))}
                            </PermissionTitleBox>
                        ))}
                </div>
                <Can action={subuser ? 'user.update' : 'user.create'}>
                    <div css={tw`pb-6 flex justify-end`}>
                        <Button type={'submit'} css={tw`w-full sm:w-auto`}>
                            {subuser ? 'Save' : 'Invite User'}
                        </Button>
                    </div>
                </Can>
            </Form>
        </Formik>
    );
};

export default asModal<Props>({
    top: false,
})(EditSubuserModal);
</file>

<file path="resources/scripts/components/server/users/PermissionRow.tsx">
import React from 'react';
import tw from 'twin.macro';
import { useStoreState } from 'easy-peasy';
import styled from 'styled-components/macro';
import Label from '@/components/elements/Label';
import Checkbox from '@/components/elements/Checkbox';

const Container = styled.label`
    ${tw`flex items-center border border-transparent rounded md:p-2 transition-colors duration-75`};
    text-transform: none;

    &:not(.disabled) {
        ${tw`cursor-pointer`};

        &:hover {
            ${tw`border-neutral-500 bg-neutral-800`};
        }
    }

    &:not(:first-of-type) {
        ${tw`mt-4 sm:mt-2`};
    }

    &.disabled {
        ${tw`opacity-50`};

        & input[type='checkbox']:not(:checked) {
            ${tw`border-0`};
        }
    }
`;

interface Props {
    permission: string;
    disabled: boolean;
}

const PermissionRow = ({ permission, disabled }: Props) => {
    const [key, pkey] = permission.split('.', 2);
    const permissions = useStoreState((state) => state.permissions.data);

    return (
        <Container htmlFor={`permission_${permission}`} className={disabled ? 'disabled' : undefined}>
            <div css={tw`p-2`}>
                <Checkbox
                    id={`permission_${permission}`}
                    name={'permissions'}
                    value={permission}
                    css={tw`w-5 h-5 mr-2`}
                    disabled={disabled}
                />
            </div>
            <div css={tw`flex-1`}>
                <Label as={'p'} css={tw`font-medium`}>
                    {pkey}
                </Label>
                {permissions[key].keys[pkey].length > 0 && (
                    <p css={tw`text-xs text-neutral-400 mt-1`}>{permissions[key].keys[pkey]}</p>
                )}
            </div>
        </Container>
    );
};

export default PermissionRow;
</file>

<file path="resources/scripts/components/server/users/PermissionTitleBox.tsx">
import tw from 'twin.macro';
import { useField } from 'formik';
import isEqual from 'react-fast-compare';
import Input from '@/components/elements/Input';
import React, { memo, useCallback } from 'react';
import TitledGreyBox from '@/components/elements/TitledGreyBox';

interface Props {
    isEditable: boolean;
    title: string;
    permissions: string[];
    className?: string;
}

const PermissionTitleBox: React.FC<Props> = memo(({ isEditable, title, permissions, className, children }) => {
    const [{ value }, , { setValue }] = useField<string[]>('permissions');

    const onCheckboxClicked = useCallback(
        (e: React.ChangeEvent<HTMLInputElement>) => {
            if (e.currentTarget.checked) {
                setValue([...value, ...permissions.filter((p) => !value.includes(p))]);
            } else {
                setValue(value.filter((p) => !permissions.includes(p)));
            }
        },
        [permissions, value]
    );

    return (
        <TitledGreyBox
            title={
                <div css={tw`flex items-center`}>
                    <p css={tw`text-sm uppercase flex-1`}>{title}</p>
                    {isEditable && (
                        <Input
                            type={'checkbox'}
                            checked={permissions.every((p) => value.includes(p))}
                            onChange={onCheckboxClicked}
                        />
                    )}
                </div>
            }
            className={className}
        >
            {children}
        </TitledGreyBox>
    );
}, isEqual);

export default PermissionTitleBox;
</file>

<file path="resources/scripts/components/server/users/RemoveSubuserButton.tsx">
import tw from 'twin.macro';
import * as Icon from 'react-feather';
import React, { useState } from 'react';
import { ApplicationStore } from '@/state';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import { Subuser } from '@/state/server/subusers';
import { Actions, useStoreActions } from 'easy-peasy';
import { Dialog } from '@/components/elements/dialog';
import deleteSubuser from '@/api/server/users/deleteSubuser';

export default ({ subuser }: { subuser: Subuser }) => {
    const [showConfirmation, setShowConfirmation] = useState(false);

    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const removeSubuser = ServerContext.useStoreActions((actions) => actions.subusers.removeSubuser);
    const { addError, clearFlashes } = useStoreActions((actions: Actions<ApplicationStore>) => actions.flashes);

    const doDeletion = () => {
        clearFlashes('users');
        deleteSubuser(uuid, subuser.uuid)
            .then(() => {
                removeSubuser(subuser.uuid);
            })
            .catch((error) => {
                console.error(error);
                addError({ key: 'users', message: httpErrorToHuman(error) });
                setShowConfirmation(false);
            });
    };

    return (
        <>
            <Dialog.Confirm
                open={showConfirmation}
                onClose={() => setShowConfirmation(false)}
                title={'Confirm task deletion'}
                confirm={'Yes, delete subuser'}
                onConfirmed={doDeletion}
            >
                Are you sure you wish to remove this subuser? They will have all access to this server revoked
                immediately.
            </Dialog.Confirm>
            <button
                type={'button'}
                aria-label={'Delete subuser'}
                css={tw`block text-sm p-2 text-neutral-500 hover:text-red-600 transition-colors duration-150`}
                onClick={() => setShowConfirmation(true)}
            >
                <Icon.Trash />
            </button>
        </>
    );
};
</file>

<file path="resources/scripts/components/server/users/SelectAllPermissions.tsx">
import tw from 'twin.macro';
import { useField } from 'formik';
import isEqual from 'react-fast-compare';
import Input from '@/components/elements/Input';
import React, { memo, useCallback } from 'react';

interface Props {
    isEditable: boolean;
    permissions: string[];
}

const SelectAllPermissions: React.FC<Props> = memo(({ isEditable, permissions }) => {
    const [{ value }, , { setValue }] = useField<string[]>('permissions');

    const onCheckboxClicked = useCallback(
        (e: React.ChangeEvent<HTMLInputElement>) => {
            if (e.currentTarget.checked) {
                setValue([...value, ...permissions.filter((p) => !value.includes(p))]);
            } else {
                setValue(value.filter((p) => !permissions.includes(p)));
            }
        },
        [permissions, value]
    );

    return (
        <>
            {isEditable && (
                <Input
                    css={tw`mr-1`}
                    type={'checkbox'}
                    checked={permissions.every((p) => value.includes(p))}
                    onChange={onCheckboxClicked}
                />
            )}
        </>
    );
}, isEqual);

export default SelectAllPermissions;
</file>

<file path="resources/scripts/components/server/users/UserRow.tsx">
import tw from 'twin.macro';
import * as Icon from 'react-feather';
import React, { useState } from 'react';
import { useStoreState } from 'easy-peasy';
import Can from '@/components/elements/Can';
import { Subuser } from '@/state/server/subusers';
import GreyRowBox from '@/components/elements/GreyRowBox';
import EditSubuserModal from '@/components/server/users/EditSubuserModal';
import RemoveSubuserButton from '@/components/server/users/RemoveSubuserButton';

interface Props {
    subuser: Subuser;
}

export default ({ subuser }: Props) => {
    const uuid = useStoreState((state) => state.user!.data!.uuid);
    const [visible, setVisible] = useState(false);

    return (
        <GreyRowBox css={tw`mb-2`}>
            <EditSubuserModal subuser={subuser} visible={visible} onModalDismissed={() => setVisible(false)} />
            <div css={tw`w-10 h-10 rounded-full bg-white border-2 border-neutral-800 overflow-hidden hidden md:block`}>
                <img css={tw`w-full h-full`} src={`${subuser.image}?s=400`} />
            </div>
            <div css={tw`ml-4 flex-1 overflow-hidden`}>
                <p css={tw`text-sm truncate`}>{subuser.email}</p>
            </div>
            <div css={tw`ml-4`}>
                <p css={tw`font-medium text-center`}>
                    &nbsp;
                    {subuser.twoFactorEnabled ? (
                        <Icon.Lock css={!subuser.twoFactorEnabled ? tw`text-red-400` : undefined} />
                    ) : (
                        <Icon.Unlock css={!subuser.twoFactorEnabled ? tw`text-red-400` : undefined} />
                    )}
                    &nbsp;
                </p>
                <p css={tw`text-2xs text-neutral-500 uppercase hidden md:block`}>2FA Enabled</p>
            </div>
            <div css={tw`ml-4 hidden md:block`}>
                <p css={tw`font-medium text-center`}>
                    {subuser.permissions.filter((permission) => permission !== 'websocket.connect').length}
                </p>
                <p css={tw`text-2xs text-neutral-500 uppercase`}>Permissions</p>
            </div>
            {subuser.uuid !== uuid && (
                <>
                    <Can action={'user.update'}>
                        <button
                            type={'button'}
                            aria-label={'Edit subuser'}
                            css={tw`block text-sm p-1 md:p-2 text-neutral-500 hover:text-neutral-100 transition-colors duration-150 mx-4`}
                            onClick={() => setVisible(true)}
                        >
                            <Icon.PenTool />
                        </button>
                    </Can>
                    <Can action={'user.delete'}>
                        <RemoveSubuserButton subuser={subuser} />
                    </Can>
                </>
            )}
        </GreyRowBox>
    );
};
</file>

<file path="resources/scripts/components/server/users/UsersContainer.tsx">
import tw from 'twin.macro';
import { ApplicationStore } from '@/state';
import Can from '@/components/elements/Can';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import React, { useEffect, useState } from 'react';
import Spinner from '@/components/elements/Spinner';
import UserRow from '@/components/server/users/UserRow';
import { Actions, useStoreActions, useStoreState } from 'easy-peasy';
import getServerSubusers from '@/api/server/users/getServerSubusers';
import AddSubuserButton from '@/components/server/users/AddSubuserButton';
import ServerContentBlock from '@/components/elements/ServerContentBlock';

export default () => {
    const [loading, setLoading] = useState(true);

    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const subusers = ServerContext.useStoreState((state) => state.subusers.data);
    const setSubusers = ServerContext.useStoreActions((actions) => actions.subusers.setSubusers);

    const permissions = useStoreState((state: ApplicationStore) => state.permissions.data);
    const getPermissions = useStoreActions((actions: Actions<ApplicationStore>) => actions.permissions.getPermissions);
    const { addError, clearFlashes } = useStoreActions((actions: Actions<ApplicationStore>) => actions.flashes);

    useEffect(() => {
        clearFlashes('users');
        getServerSubusers(uuid)
            .then((subusers) => {
                setSubusers(subusers);
                setLoading(false);
            })
            .catch((error) => {
                console.error(error);
                addError({ key: 'users', message: httpErrorToHuman(error) });
            });
    }, []);

    useEffect(() => {
        getPermissions().catch((error) => {
            addError({ key: 'users', message: httpErrorToHuman(error) });
            console.error(error);
        });
    }, []);

    if (!subusers.length && (loading || !Object.keys(permissions).length)) {
        return <Spinner size={'large'} centered />;
    }

    return (
        <ServerContentBlock
            title={'Users'}
            description={'Add and remove users from your server.'}
            showFlashKey={'users'}
        >
            {!subusers.length ? (
                <p css={tw`text-center text-sm text-neutral-300`}>It looks like you don&apos;t have any subusers.</p>
            ) : (
                subusers.map((subuser) => <UserRow key={subuser.uuid} subuser={subuser} />)
            )}
            <Can action={'user.create'}>
                <div css={tw`flex justify-end mt-6`}>
                    <AddSubuserButton />
                </div>
            </Can>
        </ServerContentBlock>
    );
};
</file>

<file path="resources/scripts/components/server/ConflictStateRenderer.tsx">
import React from 'react';
import { ServerContext } from '@/state/server';
import ScreenBlock from '@/components/elements/ScreenBlock';
import ServerInstallSvg from '@/assets/images/server_installing.svg';
import ServerErrorSvg from '@/assets/images/server_error.svg';
import ServerRestoreSvg from '@/assets/images/server_restore.svg';

export default () => {
    const status = ServerContext.useStoreState((state) => state.server.data?.status || null);
    const isTransferring = ServerContext.useStoreState((state) => state.server.data?.isTransferring || false);
    const isNodeUnderMaintenance = ServerContext.useStoreState(
        (state) => state.server.data?.isNodeUnderMaintenance || false
    );

    return status === 'installing' || status === 'install_failed' || status === 'reinstall_failed' ? (
        <ScreenBlock
            title={'Running Installer'}
            image={ServerInstallSvg}
            message={'Your server should be ready soon, please try again in a few minutes.'}
        />
    ) : status === 'suspended' ? (
        <ScreenBlock
            title={'Server Suspended'}
            image={ServerErrorSvg}
            message={'This server is suspended and cannot be accessed.'}
        />
    ) : isNodeUnderMaintenance ? (
        <ScreenBlock
            title={'Node under Maintenance'}
            image={ServerErrorSvg}
            message={'The node of this server is currently under maintenance.'}
        />
    ) : (
        <ScreenBlock
            title={isTransferring ? 'Transferring' : 'Restoring from Backup'}
            image={ServerRestoreSvg}
            message={
                isTransferring
                    ? 'Your server is being transferred to a new node, please check back later.'
                    : 'Your server is currently being restored from a backup, please check back in a few minutes.'
            }
        />
    );
};
</file>

<file path="resources/scripts/components/server/events.ts">
export enum SocketEvent {
    DAEMON_MESSAGE = 'daemon message',
    DAEMON_ERROR = 'daemon error',
    INSTALL_OUTPUT = 'install output',
    INSTALL_STARTED = 'install started',
    INSTALL_COMPLETED = 'install completed',
    CONSOLE_OUTPUT = 'console output',
    STATUS = 'status',
    STATS = 'stats',
    TRANSFER_LOGS = 'transfer logs',
    TRANSFER_STATUS = 'transfer status',
    BACKUP_COMPLETED = 'backup completed',
    BACKUP_RESTORE_COMPLETED = 'backup restore completed',
}

export enum SocketRequest {
    SEND_LOGS = 'send logs',
    SEND_STATS = 'send stats',
    SET_STATE = 'set state',
}
</file>

<file path="resources/scripts/components/server/ExternalConsole.tsx">
import tw from 'twin.macro';
import React, { memo } from 'react';
import isEqual from 'react-fast-compare';
import Features from '@feature/Features';
import { ServerContext } from '@/state/server';
import Spinner from '@/components/elements/Spinner';
import Console from '@/components/server/console/Console';
import ErrorBoundary from '@/components/elements/ErrorBoundary';
import ServerContentBlock from '@/components/elements/ServerContentBlock';

const ExternalConsole = () => {
    const eggFeatures = ServerContext.useStoreState((state) => state.server.data!.eggFeatures, isEqual);

    return (
        <ServerContentBlock title={'Console'}>
            <div css={tw`absolute h-full w-full max-w-full left-0 top-0 p-0 m-0`}>
                <Spinner.Suspense>
                    <ErrorBoundary>
                        <Console css={tw`flex flex-wrap h-full`} />
                    </ErrorBoundary>
                </Spinner.Suspense>
                <Features enabled={eggFeatures} />
            </div>
        </ServerContentBlock>
    );
};

export default memo(ExternalConsole, isEqual);
</file>

<file path="resources/scripts/components/server/InstallListener.tsx">
import { mutate } from 'swr';
import { ServerContext } from '@/state/server';
import { SocketEvent } from '@/components/server/events';
import useWebsocketEvent from '@/plugins/useWebsocketEvent';
import { getDirectorySwrKey } from '@/plugins/useFileManagerSwr';

const InstallListener = () => {
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const getServer = ServerContext.useStoreActions((actions) => actions.server.getServer);
    const setServerFromState = ServerContext.useStoreActions((actions) => actions.server.setServerFromState);

    useWebsocketEvent(SocketEvent.BACKUP_RESTORE_COMPLETED, () => {
        mutate(getDirectorySwrKey(uuid, '/'), undefined);
        setServerFromState((s) => ({ ...s, status: null }));
    });

    // Listen for the installation completion event and then fire off a request to fetch the updated
    // server information. This allows the server to automatically become available to the user if they
    // just sit on the page.
    useWebsocketEvent(SocketEvent.INSTALL_COMPLETED, () => {
        getServer(uuid).catch((error) => console.error(error));
    });

    // When we see the install started event immediately update the state to indicate such so that the
    // screens automatically update.
    useWebsocketEvent(SocketEvent.INSTALL_STARTED, () => {
        setServerFromState((s) => ({ ...s, status: 'installing' }));
    });

    return null;
};

export default InstallListener;
</file>

<file path="resources/scripts/components/server/PluginContainer.tsx">
import useSWR from 'swr';
import { object, string } from 'yup';
import * as Icon from 'react-feather';
import useFlash from '@/plugins/useFlash';
import { ServerContext } from '@/state/server';
import React, { useEffect, useState } from 'react';
import { Dialog } from '@/components/elements/dialog';
import { Button } from '@/components/elements/button';
import { Field, Form, Formik, FormikHelpers } from 'formik';
import installPlugin from '@/api/server/plugins/installPlugin';
import TitledGreyBox from '@/components/elements/TitledGreyBox';
import getPlugins, { Plugin } from '@/api/server/plugins/getPlugins';
import ServerContentBlock from '@/components/elements/ServerContentBlock';

interface Values {
    query: string;
}

export default () => {
    const [query, setQuery] = useState('');
    const [open, setOpen] = useState(false);
    const { clearFlashes, addFlash, clearAndAddHttpError } = useFlash();
    const [pluginId, setPluginId] = useState<number>(0);
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);

    const { data, error } = useSWR<Plugin>([uuid, query, '/plugins'], (uuid, query) => getPlugins(uuid, query));

    console.log(data);

    useEffect(() => {
        if (!error) {
            clearFlashes('server:plugins');
        } else {
            clearAndAddHttpError({ key: 'server:plugins', error });
        }
    }, [error]);

    const submit = ({ query }: Values, { setSubmitting }: FormikHelpers<Values>) => {
        setQuery(query);
        setSubmitting(false);
    };

    const doDownload = (id: number) => {
        console.log('Installing plugin with ID ' + id);
        installPlugin(uuid, id)
            .then(() => setOpen(false))
            .then(() =>
                addFlash({
                    key: 'server:plugins',
                    type: 'success',
                    message: 'Plugin installed successfully.',
                })
            )
            .catch((error) => clearAndAddHttpError(error));
    };

    return (
        <ServerContentBlock
            title={'Plugins'}
            description={'Search and download Spigot plugins.'}
            showFlashKey={'server:plugins'}
        >
            <Formik
                onSubmit={submit}
                initialValues={{ query: '' }}
                validationSchema={object().shape({
                    query: string().required(),
                })}
            >
                <Form className={'j-up'}>
                    <div className={'grid grid-cols-12 mb-10'}>
                        <div className={'col-span-11 mr-4'}>
                            <Field
                                name={'query'}
                                placeholder={'Type to search...'}
                                className={'p-3 text-sm w-full bg-gray-800 rounded'}
                            />
                        </div>
                        <Button type={'submit'}>
                            Search <Icon.Search size={18} className={'ml-1'} />
                        </Button>
                    </div>
                </Form>
            </Formik>
            <Dialog.Confirm
                open={open}
                onClose={() => setOpen(false)}
                title={'Plugin Installation'}
                onConfirmed={() => doDownload(pluginId)}
            >
                Are you sure you wish to download this plugin?
            </Dialog.Confirm>
            {!data ? null : (
                <>
                    {!data.plugins ? (
                        <p className={'text-gray-400 text-center'}>Waiting for a search query to be provided...</p>
                    ) : (
                        <>
                            {data.plugins.length < 1 ? (
                                <p>Couldn&apos;t find any plugins.</p>
                            ) : (
                                <div className={'lg:grid lg:grid-cols-3 p-2'}>
                                    {data.plugins.map((plugin, key) => (
                                        <>
                                            <TitledGreyBox title={plugin.name} key={key} className={'m-2'}>
                                                <div className={'lg:grid lg:grid-cols-5'}>
                                                    <div className={'lg:col-span-4'}>
                                                        <p className={'text-sm line-clamp-1'}>{plugin.tag}</p>
                                                        <p className={'text-xs text-gray-400'}>
                                                            {`https://api.spiget.org/v2/resources/${plugin.id}/go`}
                                                        </p>
                                                    </div>
                                                    <div>
                                                        {plugin.premium ? (
                                                            <Button.Text className={'m-1'} disabled>
                                                                <Icon.DownloadCloud size={18} />
                                                            </Button.Text>
                                                        ) : (
                                                            <Button
                                                                className={'m-1'}
                                                                onClick={() => {
                                                                    setPluginId(plugin.id);
                                                                    setOpen(true);
                                                                }}
                                                            >
                                                                <Icon.DownloadCloud size={18} />
                                                            </Button>
                                                        )}
                                                        <a href={`https://api.spiget.org/v2/resources/${plugin.id}/go`}>
                                                            <Button className={'m-1'}>
                                                                <Icon.ExternalLink size={18} />
                                                            </Button>
                                                        </a>
                                                    </div>
                                                </div>
                                            </TitledGreyBox>
                                        </>
                                    ))}
                                </div>
                            )}
                        </>
                    )}
                </>
            )}
        </ServerContentBlock>
    );
};
</file>

<file path="resources/scripts/components/server/ServerActivityLogContainer.tsx">
import classNames from 'classnames';
import * as Icon from 'react-feather';
import { Link } from 'react-router-dom';
import { useFlashKey } from '@/plugins/useFlash';
import React, { useEffect, useState } from 'react';
import Spinner from '@/components/elements/Spinner';
import useLocationHash from '@/plugins/useLocationHash';
import { useActivityLogs } from '@/api/server/activity';
import { ActivityLogFilters } from '@/api/account/activity';
import { styles as btnStyles } from '@/components/elements/button/index';
import ServerContentBlock from '@/components/elements/ServerContentBlock';
import PaginationFooter from '@/components/elements/table/PaginationFooter';
import ActivityLogEntry from '@/components/elements/activity/ActivityLogEntry';

export default () => {
    const { hash } = useLocationHash();
    const { clearAndAddHttpError } = useFlashKey('server:activity');
    const [filters, setFilters] = useState<ActivityLogFilters>({ page: 1, sorts: { timestamp: -1 } });

    const { data, isValidating, error } = useActivityLogs(filters, {
        revalidateOnMount: true,
        revalidateOnFocus: false,
    });

    useEffect(() => {
        setFilters((value) => ({ ...value, filters: { ip: hash.ip, event: hash.event } }));
    }, [hash]);

    useEffect(() => {
        clearAndAddHttpError(error);
    }, [error]);

    return (
        <ServerContentBlock
            title={'Server Activity'}
            description={'View activity on this server.'}
            showFlashKey={'server:activity'}
        >
            {(filters.filters?.event || filters.filters?.ip) && (
                <div className={'flex justify-end mb-2'}>
                    <Link
                        to={'#'}
                        className={classNames(btnStyles.button, btnStyles.text, 'w-full sm:w-auto')}
                        onClick={() => setFilters((value) => ({ ...value, filters: {} }))}
                    >
                        Clear Filters <Icon.XCircle className={'w-4 h-4 ml-2'} />
                    </Link>
                </div>
            )}
            {!data && isValidating ? (
                <Spinner centered />
            ) : !data?.items.length ? (
                <p className={'text-sm text-center text-gray-400'}>No activity logs available for this server.</p>
            ) : (
                <div className={'bg-neutral-900 j-up'}>
                    {data?.items.map((activity) => (
                        <ActivityLogEntry key={activity.id} activity={activity}>
                            <span />
                        </ActivityLogEntry>
                    ))}
                </div>
            )}
            {data && (
                <PaginationFooter
                    pagination={data.pagination}
                    onPageSelect={(page) => setFilters((value) => ({ ...value, page }))}
                />
            )}
        </ServerContentBlock>
    );
};
</file>

<file path="resources/scripts/components/server/ServerConfigurationBlock.tsx">
import React from 'react';
import tw from 'twin.macro';
import * as Icon from 'react-feather';
import { ServerContext } from '@/state/server';
import TitledGreyBox from '@/components/elements/TitledGreyBox';

const ServerConfigurationBlock = () => {
    const server = ServerContext.useStoreState((state) => state.server.data!);

    return (
        <TitledGreyBox css={tw`break-words mt-4`} title={'Server Information'}>
            <p css={tw`text-xs mt-2`}>
                <div css={tw`flex flex-row`}>
                    <Icon.List css={tw`mr-1`} size={16} />
                    {server.id}
                </div>
            </p>
            <p css={tw`text-xs mt-2`}>
                <div css={tw`flex flex-row truncate`}>
                    <Icon.Layers css={tw`mr-1`} size={16} />
                    {server.node}
                </div>
            </p>
            <p css={tw`text-xs mt-2`}>
                <div css={tw`flex flex-row truncate`}>
                    <Icon.Disc css={tw`mr-1`} size={16} />
                    {server.dockerImage}
                </div>
            </p>
        </TitledGreyBox>
    );
};

export default ServerConfigurationBlock;
</file>

<file path="resources/scripts/components/server/TransferListener.tsx">
import { ServerContext } from '@/state/server';
import { SocketEvent } from '@/components/server/events';
import useWebsocketEvent from '@/plugins/useWebsocketEvent';

const TransferListener = () => {
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const getServer = ServerContext.useStoreActions((actions) => actions.server.getServer);
    const setServerFromState = ServerContext.useStoreActions((actions) => actions.server.setServerFromState);

    // Listen for the transfer status event, so we can update the state of the server.
    useWebsocketEvent(SocketEvent.TRANSFER_STATUS, (status: string) => {
        if (status === 'pending' || status === 'processing') {
            setServerFromState((s) => ({ ...s, isTransferring: true }));
            return;
        }

        if (status === 'failed') {
            setServerFromState((s) => ({ ...s, isTransferring: false }));
            return;
        }

        if (status !== 'completed') {
            return;
        }

        // Refresh the server's information as it's node and allocations were just updated.
        getServer(uuid).catch((error) => console.error(error));
    });

    return null;
};

export default TransferListener;
</file>

<file path="resources/scripts/components/server/UptimeDuration.tsx">
import React from 'react';

export default ({ uptime }: { uptime: number }) => {
    const days = Math.floor(uptime / (24 * 60 * 60));
    const hours = Math.floor((Math.floor(uptime) / 60 / 60) % 24);
    const remainder = Math.floor(uptime - hours * 60 * 60);
    const minutes = Math.floor((remainder / 60) % 60);
    const seconds = remainder % 60;

    if (days > 0) {
        return (
            <>
                {days}d {hours}h {minutes}m
            </>
        );
    }

    return (
        <>
            {hours}h {minutes}m {seconds}s
        </>
    );
};
</file>

<file path="resources/scripts/components/server/WebsocketHandler.tsx">
import tw from 'twin.macro';
import { ServerContext } from '@/state/server';
import { Websocket } from '@/plugins/Websocket';
import React, { useEffect, useState } from 'react';
import Spinner from '@/components/elements/Spinner';
import { CSSTransition } from 'react-transition-group';
import getWebsocketToken from '@/api/server/getWebsocketToken';
import ContentContainer from '@/components/elements/ContentContainer';

const reconnectErrors = ['jwt: exp claim is invalid', 'jwt: created too far in past (denylist)'];

export default () => {
    let updatingToken = false;
    const [error, setError] = useState<'connecting' | string>('');
    const { connected, instance } = ServerContext.useStoreState((state) => state.socket);
    const uuid = ServerContext.useStoreState((state) => state.server.data?.uuid);
    const setServerStatus = ServerContext.useStoreActions((actions) => actions.status.setServerStatus);
    const { setInstance, setConnectionState } = ServerContext.useStoreActions((actions) => actions.socket);

    const updateToken = (uuid: string, socket: Websocket) => {
        if (updatingToken) return;

        updatingToken = true;
        getWebsocketToken(uuid)
            .then((data) => socket.setToken(data.token, true))
            .catch((error) => console.error(error))
            .then(() => {
                updatingToken = false;
            });
    };

    const connect = (uuid: string) => {
        const socket = new Websocket();

        socket.on('auth success', () => setConnectionState(true));
        socket.on('SOCKET_CLOSE', () => setConnectionState(false));
        socket.on('SOCKET_ERROR', () => {
            setError('connecting');
            setConnectionState(false);
        });
        socket.on('status', (status) => setServerStatus(status));

        socket.on('daemon error', (message) => {
            console.warn('Got error message from daemon socket:', message);
        });

        socket.on('token expiring', () => updateToken(uuid, socket));
        socket.on('token expired', () => updateToken(uuid, socket));
        socket.on('jwt error', (error: string) => {
            setConnectionState(false);
            console.warn('JWT validation error from wings:', error);

            if (reconnectErrors.find((v) => error.toLowerCase().indexOf(v) >= 0)) {
                updateToken(uuid, socket);
            } else {
                setError(
                    'There was an error validating the credentials provided for the websocket. Please refresh the page.'
                );
            }
        });

        socket.on('transfer status', (status: string) => {
            if (status === 'starting' || status === 'success') {
                return;
            }

            // This code forces a reconnection to the websocket which will connect us to the target node instead of the source node
            // in order to be able to receive transfer logs from the target node.
            socket.close();
            setError('connecting');
            setConnectionState(false);
            setInstance(null);
            connect(uuid);
        });

        getWebsocketToken(uuid)
            .then((data) => {
                // Connect and then set the authentication token.
                socket.setToken(data.token).connect(data.socket);

                // Once that is done, set the instance.
                setInstance(socket);
            })
            .catch((error) => console.error(error));
    };

    useEffect(() => {
        connected && setError('');
    }, [connected]);

    useEffect(() => {
        return () => {
            instance && instance.close();
        };
    }, [instance]);

    useEffect(() => {
        // If there is already an instance or there is no server, just exit out of this process
        // since we don't need to make a new connection.
        if (instance || !uuid) {
            return;
        }

        connect(uuid);
    }, [uuid]);

    return error ? (
        <CSSTransition timeout={150} in appear classNames={'fade'}>
            <div css={tw`bg-yellow-500`}>
                <ContentContainer css={tw`flex items-center justify-center`}>
                    {error === 'connecting' ? (
                        <>
                            <Spinner size={'small'} />
                            <p css={tw`ml-2 text-sm text-red-100`}>Please wait while we connect to your instance.</p>
                        </>
                    ) : (
                        <p css={tw`ml-2 text-sm text-white`}>{error}</p>
                    )}
                </ContentContainer>
            </div>
        </CSSTransition>
    ) : null;
};
</file>

<file path="resources/scripts/components/store/forms/PaypalPurchaseForm.tsx">
import tw from 'twin.macro';
import { Form, Formik } from 'formik';
import React, { useState } from 'react';
import useFlash from '@/plugins/useFlash';
import paypal from '@/api/store/gateways/paypal';
import Select from '@/components/elements/Select';
import { Dialog } from '@/components/elements/dialog';
import { Button } from '@/components/elements/button/index';
import TitledGreyBox from '@/components/elements/TitledGreyBox';
import FlashMessageRender from '@/components/FlashMessageRender';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';

export default () => {
    const { clearAndAddHttpError } = useFlash();
    const [amount, setAmount] = useState(0);
    const [submitting, setSubmitting] = useState(false);

    const submit = () => {
        setSubmitting(true);

        paypal(amount)
            .then((url) => {
                setSubmitting(false);

                // @ts-expect-error this is valid
                window.location.href = url;
            })
            .catch((error) => {
                setSubmitting(false);

                clearAndAddHttpError({ key: 'store:paypal', error });
            });
    };

    return (
        <TitledGreyBox title={'Purchase via PayPal'}>
            <Dialog open={submitting} hideCloseIcon onClose={() => undefined}>
                You are now being taken to the PayPal gateway to complete this transaction.
            </Dialog>
            <FlashMessageRender byKey={'store:paypal'} css={tw`mb-2`} />
            <Formik
                onSubmit={submit}
                initialValues={{
                    amount: 100,
                }}
            >
                <Form>
                    <SpinnerOverlay size={'large'} visible={submitting} />
                    <Select name={'amount'} disabled={submitting} onChange={(e) => setAmount(parseInt(e.target.value))}>
                        <option key={'paypal:placeholder'} hidden>
                            Choose an amount...
                        </option>
                        <option key={'paypal:buy:100'} value={100}>
                            Purchase 100 credits
                        </option>
                        <option key={'paypal:buy:200'} value={200}>
                            Purchase 200 credits
                        </option>
                        <option key={'paypal:buy:500'} value={500}>
                            Purchase 500 credits
                        </option>
                        <option key={'paypal:buy:1000'} value={1000}>
                            Purchase 1000 credits
                        </option>
                    </Select>
                    <div css={tw`mt-6`}>
                        <Button type={'submit'} disabled={submitting}>
                            Purchase via PayPal
                        </Button>
                    </div>
                </Form>
            </Formik>
        </TitledGreyBox>
    );
};
</file>

<file path="resources/scripts/components/store/forms/StripePurchaseForm.tsx">
import tw from 'twin.macro';
import { Form, Formik } from 'formik';
import React, { useState } from 'react';
import useFlash from '@/plugins/useFlash';
import stripe from '@/api/store/gateways/stripe';
import Select from '@/components/elements/Select';
import { Dialog } from '@/components/elements/dialog';
import { Button } from '@/components/elements/button/index';
import TitledGreyBox from '@/components/elements/TitledGreyBox';
import FlashMessageRender from '@/components/FlashMessageRender';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';

export default () => {
    const { clearAndAddHttpError } = useFlash();
    const [amount, setAmount] = useState(0);
    const [submitting, setSubmitting] = useState(false);

    const submit = () => {
        setSubmitting(true);

        stripe(amount)
            .then((url) => {
                setSubmitting(false);

                // @ts-expect-error this is valid
                window.location.href = url;
            })
            .catch((error) => {
                setSubmitting(false);

                clearAndAddHttpError({ key: 'store:stripe', error });
            });
    };

    return (
        <TitledGreyBox title={'Purchase via Stripe'}>
            <Dialog open={submitting} hideCloseIcon onClose={() => undefined}>
                You are now being taken to the Stripe gateway to complete this transaction.
            </Dialog>
            <FlashMessageRender byKey={'store:stripe'} css={tw`mb-2`} />
            <Formik
                onSubmit={submit}
                initialValues={{
                    amount: 100,
                }}
            >
                <Form>
                    <SpinnerOverlay size={'large'} visible={submitting} />
                    <Select name={'amount'} disabled={submitting} onChange={(e) => setAmount(parseInt(e.target.value))}>
                        <option key={'stripe:placeholder'} hidden>
                            Choose an amount...
                        </option>
                        <option key={'stripe:buy:100'} value={100}>
                            Purchase 100 credits
                        </option>
                        <option key={'stripe:buy:200'} value={200}>
                            Purchase 200 credits
                        </option>
                        <option key={'stripe:buy:500'} value={500}>
                            Purchase 500 credits
                        </option>
                        <option key={'stripe:buy:1000'} value={1000}>
                            Purchase 1000 credits
                        </option>
                    </Select>
                    <div css={tw`mt-6`}>
                        <Button type={'submit'} disabled={submitting}>
                            Purchase via Stripe
                        </Button>
                    </div>
                </Form>
            </Formik>
        </TitledGreyBox>
    );
};
</file>

<file path="resources/scripts/components/store/OverviewContainer.tsx">
import React from 'react';
import { useStoreState } from 'easy-peasy';
import useWindowDimensions from '@/plugins/useWindowDimensions';
import ResourceBar from '@/components/elements/store/ResourceBar';
import StoreBanner from '@/components/elements/store/StoreBanner';
import PageContentBlock from '@/components/elements/PageContentBlock';

export default () => {
    const { width } = useWindowDimensions();
    const username = useStoreState((state) => state.user.data!.username);

    return (
        <PageContentBlock title={'Storefront Overview'}>
            <div className={'flex flex-row items-center justify-between mt-10'}>
                {width >= 1280 && (
                    <div>
                        <h1 className={'text-6xl'}>Hey, {username}!</h1>
                        <h3 className={'text-2xl mt-2 text-neutral-500'}> Welcome to the store.</h3>
                    </div>
                )}
                <ResourceBar className={'w-full lg:w-3/4'} />
            </div>
            <div className={'lg:grid lg:grid-cols-3 gap-8 my-10'}>
                <StoreBanner
                    title={'Want to create a server?'}
                    className={'bg-storeone'}
                    action={'Create'}
                    link={'create'}
                />
                <StoreBanner
                    title={'Need more resources?'}
                    className={'bg-storetwo'}
                    action={'Buy Resources'}
                    link={'resources'}
                />
                <StoreBanner
                    title={'Run out of credits?'}
                    className={'bg-storethree'}
                    action={'Buy Credits'}
                    link={'credits'}
                />
            </div>
        </PageContentBlock>
    );
};
</file>

<file path="resources/scripts/components/tickets/forms/NewMessageDialog.tsx">
import React from 'react';
import tw from 'twin.macro';
import { object, string } from 'yup';
import styled from 'styled-components';
import useFlash from '@/plugins/useFlash';
import { useRouteMatch } from 'react-router';
import { httpErrorToHuman } from '@/api/http';
import { createMessage } from '@/api/account/tickets';
import { Textarea } from '@/components/elements/Input';
import { Field, Form, Formik, FormikHelpers } from 'formik';
import { Button } from '@/components/elements/button/index';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import { Dialog, DialogProps } from '@/components/elements/dialog';
import FormikFieldWrapper from '@/components/elements/FormikFieldWrapper';

interface Values {
    description: string;
}

const CustomTextarea = styled(Textarea)`
    ${tw`h-32`}
`;

export default ({ open, onClose }: DialogProps) => {
    const match = useRouteMatch<{ id: string }>();
    const id = parseInt(match.params.id);

    const { addError, clearFlashes, addFlash } = useFlash();

    const submit = (values: Values, { setSubmitting, resetForm }: FormikHelpers<Values>) => {
        clearFlashes('tickets');

        createMessage(id, values.description)
            .then(() => {
                resetForm();
                setSubmitting(false);

                addFlash({
                    key: 'tickets',
                    type: 'success',
                    message: 'Your message has been sent successfully.',
                });
            })
            .catch((error) => {
                setSubmitting(false);

                addError({ key: 'tickets', message: httpErrorToHuman(error) });
            });
    };

    return (
        <Dialog
            open={open}
            onClose={onClose}
            title={'Add a message'}
            description={'This message will be visible to both you and the administrators on this Panel.'}
        >
            <Formik
                onSubmit={submit}
                initialValues={{ description: '' }}
                validationSchema={object().shape({
                    description: string().required().min(4),
                })}
            >
                {({ isSubmitting }) => (
                    <Form className={'mt-6'}>
                        <SpinnerOverlay visible={isSubmitting} />
                        <FormikFieldWrapper
                            label={'Description'}
                            name={'description'}
                            description={
                                'Provide additional information, images and other content in order to help us fix your issue faster.'
                            }
                        >
                            <Field name={'description'} as={CustomTextarea} />
                        </FormikFieldWrapper>
                        <div className={'flex justify-end mt-6'}>
                            <Button type={'submit'}>Send</Button>
                        </div>
                    </Form>
                )}
            </Formik>
        </Dialog>
    );
};
</file>

<file path="resources/scripts/components/tickets/forms/NewTicketDialog.tsx">
import React from 'react';
import tw from 'twin.macro';
import { object, string } from 'yup';
import styled from 'styled-components';
import useFlash from '@/plugins/useFlash';
import { httpErrorToHuman } from '@/api/http';
import { createTicket } from '@/api/account/tickets';
import { Field, Form, Formik, FormikHelpers } from 'formik';
import { Button } from '@/components/elements/button/index';
import Input, { Textarea } from '@/components/elements/Input';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import { Dialog, DialogProps } from '@/components/elements/dialog';
import FormikFieldWrapper from '@/components/elements/FormikFieldWrapper';

interface Values {
    title: string;
    description: string;
}

const CustomTextarea = styled(Textarea)`
    ${tw`h-32`}
`;

export default ({ open, onClose }: DialogProps) => {
    const { addError, clearFlashes } = useFlash();

    const submit = (values: Values, { setSubmitting, resetForm }: FormikHelpers<Values>) => {
        clearFlashes('tickets');

        createTicket(values.title, values.description)
            .then((data) => {
                resetForm();
                setSubmitting(false);

                // @ts-expect-error this is valid
                window.location = `/tickets/${data.id}`;
            })
            .catch((error) => {
                setSubmitting(false);

                addError({ key: 'tickets', message: httpErrorToHuman(error) });
            });
    };

    return (
        <Dialog
            open={open}
            onClose={onClose}
            title={'Create a new ticket'}
            description={
                'This ticket will be registered under your account and accessible to all administrators on the Panel.'
            }
        >
            <Formik
                onSubmit={submit}
                initialValues={{ title: '', description: '' }}
                validationSchema={object().shape({
                    allowedIps: string(),
                    description: string().required().min(4),
                })}
            >
                {({ isSubmitting }) => (
                    <Form className={'mt-6'}>
                        <SpinnerOverlay visible={isSubmitting} />
                        <FormikFieldWrapper
                            label={'Title'}
                            name={'title'}
                            description={'A title for this ticket.'}
                            className={'mb-6'}
                        >
                            <Field name={'title'} as={Input} />
                        </FormikFieldWrapper>
                        <FormikFieldWrapper
                            label={'Description'}
                            name={'description'}
                            description={
                                'Provide additional information, images and other content in order to help us fix your issue faster.'
                            }
                        >
                            <Field name={'description'} as={CustomTextarea} />
                        </FormikFieldWrapper>
                        <div className={'flex justify-end mt-6'}>
                            <Button type={'submit'}>Create</Button>
                        </div>
                    </Form>
                )}
            </Formik>
        </Dialog>
    );
};
</file>

<file path="resources/scripts/components/tickets/OverviewContainer.tsx">
import { Link } from 'react-router-dom';
import { MoreHorizontal } from 'react-feather';
import React, { useEffect, useState } from 'react';
import Spinner from '@/components/elements/Spinner';
import { Button } from '@/components/elements/button';
import { format, formatDistanceToNow } from 'date-fns';
import GreyRowBox from '@/components/elements/GreyRowBox';
import { getTickets, Ticket } from '@/api/account/tickets';
import PageContentBlock from '@/components/elements/PageContentBlock';
import NewTicketDialog from '@/components/tickets/forms/NewTicketDialog';

export default () => {
    const [visible, setVisible] = useState(false);
    const [tickets, setTickets] = useState<Ticket[]>();

    useEffect(() => {
        getTickets().then((d) => setTickets(d));
    }, []);

    if (!tickets) return <Spinner centered />;

    return (
        <PageContentBlock
            title={'Support Tickets'}
            description={'Create or reply to a support ticket.'}
            showFlashKey={'tickets'}
        >
            <NewTicketDialog open={visible} onClose={() => setVisible(false)} />
            <div className={'my-10'}>
                {tickets.map((ticket) => (
                    <Link to={`/tickets/${ticket.id}`} key={ticket.id}>
                        <GreyRowBox className={'flex-wrap md:flex-nowrap items-center my-1'}>
                            <div className={'flex items-center truncate w-full md:flex-1'}>
                                <p className={'mr-4 text-xl font-bold'}>#{ticket.id}</p>
                                <div className={'flex flex-col truncate'}>
                                    <div className={'flex items-center mb-1'}>
                                        <p className={'break-words truncate text-lg'}>{ticket.title}</p>
                                        <span className={'ml-3 text-gray-500 text-xs font-extralight hidden sm:inline'}>
                                            {ticket.status}
                                        </span>
                                    </div>
                                    <p className={'mt-1 md:mt-0 text-xs text-neutral-300 font-mono truncate'}>
                                        {ticket.content}
                                    </p>
                                </div>
                            </div>
                            {ticket.createdAt && (
                                <div className={'flex-1 md:flex-none md:w-48 mt-4 md:mt-0 md:ml-8 md:text-center'}>
                                    <p className={'text-sm'}>{format(ticket.createdAt, 'MMMM do, yyyy')}</p>
                                    <p className={'text-2xs text-neutral-500 uppercase mt-1'}>
                                        {formatDistanceToNow(ticket.createdAt, {
                                            includeSeconds: true,
                                            addSuffix: true,
                                        })}
                                    </p>
                                </div>
                            )}
                            <div className={'mt-4 md:mt-0 ml-6'} style={{ marginRight: '-0.5rem' }}>
                                <MoreHorizontal />
                            </div>
                        </GreyRowBox>
                    </Link>
                ))}
            </div>
            <div className={'w-full flex lg:justify-end lg:items-end mt-2'}>
                <Button onClick={() => setVisible(true)}>Create New Ticket</Button>
            </div>
        </PageContentBlock>
    );
};
</file>

<file path="resources/scripts/components/tickets/ViewContainer.tsx">
import { format } from 'date-fns';
import useFlash from '@/plugins/useFlash';
import { useRouteMatch } from 'react-router';
import React, { useEffect, useState } from 'react';
import { Alert } from '@/components/elements/alert';
import Spinner from '@/components/elements/Spinner';
import { Button } from '@/components/elements/button';
import TitledGreyBox from '@/components/elements/TitledGreyBox';
import PageContentBlock from '@/components/elements/PageContentBlock';
import NewMessageDialog from '@/components/tickets/forms/NewMessageDialog';
import { Ticket, getTicket, getMessages, deleteTicket, TicketMessage } from '@/api/account/tickets';

export default () => {
    const { clearFlashes } = useFlash();
    const match = useRouteMatch<{ id: string }>();
    const id = parseInt(match.params.id);

    const [visible, setVisible] = useState(false);
    const [ticket, setTicket] = useState<Ticket>();
    const [messages, setMessages] = useState<TicketMessage[]>();

    const doRedirect = () => {
        clearFlashes('tickets');

        // @ts-expect-error this is valid
        window.location = '/tickets';
    };

    const doRefresh = () => {
        clearFlashes('tickets');

        getTicket(id).then((data) => setTicket(data));
        getMessages(id).then((data) => setMessages(data));
    };

    const doDeletion = () => {
        clearFlashes('tickets');

        deleteTicket(id).then(() => doRedirect());
    };

    useEffect(() => {
        clearFlashes('tickets');

        doRefresh();
    }, []);

    if (!ticket) return <Spinner centered />;

    return (
        <PageContentBlock title={'View Ticket'} showFlashKey={'tickets'}>
            <NewMessageDialog open={visible} onClose={() => setVisible(false)} />
            <div className={'mt-6 grid grid-cols-1 sm:grid-cols-2 lg:w-1/4 gap-4'}>
                <Button.Text className={'w-full'} onClick={doRedirect}>
                    View All Tickets
                </Button.Text>
                <Button.Danger className={'w-full'} onClick={doDeletion}>
                    Delete Ticket
                </Button.Danger>
            </div>
            <Alert
                type={
                    ticket.status === 'pending'
                        ? 'info'
                        : ticket.status === 'in-progress'
                        ? 'info'
                        : ticket.status === 'unresolved'
                        ? 'danger'
                        : ticket.status === 'resolved'
                        ? 'success'
                        : 'warning'
                }
                className={'my-4 w-full'}
            >
                This ticket is marked as&nbsp;<p className={'font-bold'}>{ticket.status ?? 'unknown'}</p>.
            </Alert>
            <TitledGreyBox title={ticket.title}>
                <p className={'line-clamp-5 truncate'}>{ticket.content}</p>
                {ticket.createdAt && (
                    <p className={'text-right p-2 text-sm text-gray-400'}>
                        {format(ticket.createdAt, "MMM do 'at' h:mma")}
                    </p>
                )}
            </TitledGreyBox>
            {!messages ? (
                <p className={'text-gray-400 text-center'}>No one has replied to this ticket yet.</p>
            ) : (
                <>
                    {messages.map((message) => (
                        <div key={message.id}>
                            {message.content === ticket.content ? undefined : (
                                <>
                                    {message.userEmail === 'system' ? (
                                        <div className={'my-4 p-2 bg-gray-800 opacity-25'}>
                                            <p className={'text-lg text-center text-gray-400'}>{message.content}</p>
                                        </div>
                                    ) : (
                                        <TitledGreyBox title={`Response from ${message.userEmail}`} className={'mt-4'}>
                                            <p className={'line-clamp-5 truncate'}>{message.content}</p>
                                            {message.createdAt && (
                                                <p className={'text-right p-2 text-sm text-gray-400'}>
                                                    {format(message.createdAt, "MMM do 'at' h:mma")}
                                                </p>
                                            )}
                                        </TitledGreyBox>
                                    )}
                                </>
                            )}
                        </div>
                    ))}
                </>
            )}
            <div className={'flex justify-center items-center mt-6'}>
                <Button onClick={() => setVisible(true)}>Create Message</Button>
            </div>
        </PageContentBlock>
    );
};
</file>

<file path="resources/scripts/components/App.tsx">
import React from 'react';
import tw from 'twin.macro';
import '@/assets/tailwind.css';
import { store } from '@/state';
import { StoreProvider } from 'easy-peasy';
import { hot } from 'react-hot-loader/root';
import { history } from '@/components/history';
import { SiteSettings } from '@/state/settings';
import IndexRouter from '@/routers/IndexRouter';
import earnCredits from '@/api/account/earnCredits';
import { setupInterceptors } from '@/api/interceptors';
import { StorefrontSettings } from '@/state/storefront';
import GlobalStylesheet from '@/assets/css/GlobalStylesheet';

interface ExtendedWindow extends Window {
    SiteConfiguration?: SiteSettings;
    StoreConfiguration?: StorefrontSettings;
    JexactylUser?: {
        uuid: string;
        username: string;
        email: string;
        approved: boolean;
        verified: boolean;
        /* eslint-disable camelcase */
        discord_id: string;
        root_admin: boolean;
        use_totp: boolean;
        referral_code: string;
        language: string;
        updated_at: string;
        created_at: string;
        /* eslint-enable camelcase */
    };
}

setupInterceptors(history);

const App = () => {
    const { JexactylUser, SiteConfiguration, StoreConfiguration } = window as ExtendedWindow;

    if (JexactylUser && !store.getState().user.data) {
        store.getActions().user.setUserData({
            uuid: JexactylUser.uuid,
            username: JexactylUser.username,
            email: JexactylUser.email,
            approved: JexactylUser.approved,
            verified: JexactylUser.verified,
            discordId: JexactylUser.discord_id,
            language: JexactylUser.language,
            rootAdmin: JexactylUser.root_admin,
            useTotp: JexactylUser.use_totp,
            referralCode: JexactylUser.referral_code,
            createdAt: new Date(JexactylUser.created_at),
            updatedAt: new Date(JexactylUser.updated_at),
        });
    }

    if (!store.getState().settings.data) {
        store.getActions().settings.setSettings(SiteConfiguration!);
    }

    if (!store.getState().storefront.data) {
        store.getActions().storefront.setStorefront(StoreConfiguration!);
    }

    function earn() {
        setTimeout(earn, 61000); // Allow 1 second for time inconsistencies.
        earnCredits().catch(() => console.error('Failed to add credits'));
    }

    earn();

    return (
        <>
            <GlobalStylesheet />
            <StoreProvider store={store}>
                <div css={tw`mx-auto w-auto`}>
                    <IndexRouter />
                </div>
            </StoreProvider>
        </>
    );
};

export default hot(App);
</file>

<file path="resources/scripts/components/Avatar.tsx">
import React from 'react';
import BoringAvatar, { AvatarProps } from 'boring-avatars';
import { useStoreState } from '@/state/hooks';

const palette = ['#FFAD08', '#EDD75A', '#73B06F', '#0C8F8F', '#587291'];

type Props = Omit<AvatarProps, 'colors'>;

const _Avatar = ({ variant = 'beam', ...props }: AvatarProps) => (
    <BoringAvatar colors={palette} variant={variant} {...props} />
);

const _UserAvatar = ({ variant = 'beam', ...props }: Omit<Props, 'name'>) => {
    const uuid = useStoreState((state) => state.user.data?.uuid);

    return <BoringAvatar colors={palette} name={uuid || 'system'} variant={variant} {...props} />;
};

_Avatar.displayName = 'Avatar';
_UserAvatar.displayName = 'Avatar.User';

const Avatar = Object.assign(_Avatar, {
    User: _UserAvatar,
});

export default Avatar;
</file>

<file path="resources/scripts/components/FlashMessageRender.tsx">
import React from 'react';
import tw from 'twin.macro';
import { useStoreState } from 'easy-peasy';
import Alert from '@/components/elements/alert/Alert';

type Props = Readonly<{
    byKey?: string;
    className?: string;
}>;

const FlashMessageRender = ({ byKey, className }: Props) => {
    const flashes = useStoreState((state) =>
        state.flashes.items.filter((flash) => (byKey ? flash.key === byKey : true))
    );

    return flashes.length ? (
        <div className={className}>
            {flashes.map((flash, index) => (
                <React.Fragment key={flash.id || flash.type + flash.message}>
                    {index > 0 && <div css={tw`mt-2`}></div>}
                    <Alert type={flash.type}>{flash.message}</Alert>
                </React.Fragment>
            ))}
        </div>
    ) : null;
};

export default FlashMessageRender;
</file>

<file path="resources/scripts/components/history.ts">
import { createBrowserHistory } from 'history';

export const history = createBrowserHistory({ basename: '/' });
</file>

<file path="resources/scripts/components/MessageBox.tsx">
import * as React from 'react';
import tw, { TwStyle } from 'twin.macro';
import styled from 'styled-components/macro';

export type FlashMessageType = 'success' | 'info' | 'warning' | 'danger';

interface Props {
    title?: string;
    children: string;
    type?: FlashMessageType;
}

const styling = (type?: FlashMessageType): TwStyle | string => {
    switch (type) {
        case 'danger':
            return tw`bg-red-600 border-red-800`;
        case 'info':
            return tw`bg-primary-600 border-primary-800`;
        case 'success':
            return tw`bg-green-600 border-green-800`;
        case 'warning':
            return tw`bg-yellow-600 border-yellow-800`;
        default:
            return '';
    }
};

const getBackground = (type?: FlashMessageType): TwStyle | string => {
    switch (type) {
        case 'danger':
            return tw`bg-red-500`;
        case 'info':
            return tw`bg-primary-500`;
        case 'success':
            return tw`bg-green-500`;
        case 'warning':
            return tw`bg-yellow-500`;
        default:
            return '';
    }
};

const Container = styled.div<{ $type?: FlashMessageType }>`
    ${tw`p-2 border items-center leading-normal rounded flex w-full text-sm text-white`};
    ${(props) => styling(props.$type)};
`;
Container.displayName = 'MessageBox.Container';

const MessageBox = ({ title, children, type }: Props) => (
    <Container css={tw`lg:inline-flex`} $type={type} role={'alert'}>
        {title && (
            <span
                className={'title'}
                css={[
                    tw`flex rounded-full uppercase px-2 py-1 text-xs font-bold mr-3 leading-none`,
                    getBackground(type),
                ]}
            >
                {title}
            </span>
        )}
        <span css={tw`mr-2 text-left flex-auto`}>{children}</span>
    </Container>
);
MessageBox.displayName = 'MessageBox';

export default MessageBox;
</file>

<file path="resources/scripts/components/NavigationBar.tsx">
import * as React from 'react';
import { useState } from 'react';
import { Link, NavLink } from 'react-router-dom';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import { faCogs, faLayerGroup, faSignOutAlt } from '@fortawesome/free-solid-svg-icons';
import { useStoreState } from 'easy-peasy';
import { ApplicationStore } from '@/state';
import SearchContainer from '@/components/dashboard/search/SearchContainer';
import tw, { theme } from 'twin.macro';
import styled from 'styled-components/macro';
import http from '@/api/http';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import Tooltip from '@/components/elements/tooltip/Tooltip';
import Avatar from '@/components/Avatar';

const RightNavigation = styled.div`
    & > a,
    & > button,
    & > .navigation-link {
        ${tw`flex items-center h-full no-underline text-neutral-300 px-6 cursor-pointer transition-all duration-150`};

        &:active,
        &:hover {
            ${tw`text-neutral-100 bg-black`};
        }

        &:active,
        &:hover,
        &.active {
            box-shadow: inset 0 -2px ${theme`colors.cyan.600`.toString()};
        }
    }
`;

export default () => {
    const name = useStoreState((state: ApplicationStore) => state.settings.data!.name);
    const rootAdmin = useStoreState((state: ApplicationStore) => state.user.data!.rootAdmin);
    const [isLoggingOut, setIsLoggingOut] = useState(false);

    const onTriggerLogout = () => {
        setIsLoggingOut(true);
        http.post('/auth/logout').finally(() => {
            // @ts-expect-error this is valid
            window.location = '/';
        });
    };

    return (
        <div
            className='w-full shadow-md overflow-x-auto'
            style={{
                background: 'linear-gradient(90deg, #242424 0%, #000 100%);',
            }}
        >
            <SpinnerOverlay visible={isLoggingOut} />
            <div className={'mx-auto w-full flex items-center h-[3.5rem] max-w-[1200px]'}>
                <div id={'logo'} className={'flex-1 flex items-center'}>
                    <img src={'/assets/logo.png'} alt='logo' className='h-8 w-8 mr-3' />
                    <Link
                        to={'/'}
                        className={
                            'text-2xl font-header px-4 no-underline text-neutral-200 hover:text-neutral-100 transition-colors duration-150'
                        }
                    >
                        {name}
                    </Link>
                </div>
                <RightNavigation className={'flex h-full items-center justify-center'}>
                    <SearchContainer size={20} />
                    <Tooltip placement={'bottom'} content={'Dashboard'}>
                        <NavLink to={'/'} exact>
                            <FontAwesomeIcon icon={faLayerGroup} />
                        </NavLink>
                    </Tooltip>
                    {rootAdmin && (
                        <Tooltip placement={'bottom'} content={'Admin'}>
                            <a href={'/admin'} rel={'noreferrer'}>
                                <FontAwesomeIcon icon={faCogs} />
                            </a>
                        </Tooltip>
                    )}
                    <Tooltip placement={'bottom'} content={'Account Settings'}>
                        <NavLink to={'/account'}>
                            <span className={'flex items-center w-5 h-5'}>
                                <Avatar.User />
                            </span>
                        </NavLink>
                    </Tooltip>
                    <Tooltip placement={'bottom'} content={'Sign Out'}>
                        <button onClick={onTriggerLogout}>
                            <FontAwesomeIcon icon={faSignOutAlt} />
                        </button>
                    </Tooltip>
                </RightNavigation>
            </div>
        </div>
    );
};
</file>

<file path="resources/scripts/components/types.ts">
export interface WithClassname {
    className?: string;
}
</file>

<file path="resources/scripts/context/ModalContext.ts">
import React from 'react';
import { SettableModalProps } from '@/hoc/asModal';

export interface ModalContextValues {
    dismiss: () => void;
    setPropOverrides: (
        value:
            | ((current: Readonly<Partial<SettableModalProps>>) => Partial<SettableModalProps>)
            | Partial<SettableModalProps>
            | null
    ) => void;
}

const ModalContext = React.createContext<ModalContextValues>({
    dismiss: () => null,
    setPropOverrides: () => null,
});

ModalContext.displayName = 'ModalContext';

export default ModalContext;
</file>

<file path="resources/scripts/hoc/asDialog.tsx">
import React, { useState } from 'react';
import { Dialog, DialogProps, DialogWrapperContext, WrapperProps } from '@/components/elements/dialog';

function asDialog(
    initialProps?: WrapperProps
    // eslint-disable-next-line @typescript-eslint/ban-types
): <P extends {}>(C: React.ComponentType<P>) => React.FunctionComponent<P & DialogProps> {
    return function (Component) {
        return function ({ open, onClose, ...rest }) {
            const [props, setProps] = useState<WrapperProps>(initialProps || {});

            return (
                <DialogWrapperContext.Provider value={{ props, setProps, close: onClose }}>
                    <Dialog {...props} open={open} onClose={onClose}>
                        <Component {...(rest as React.ComponentProps<typeof Component>)} />
                    </Dialog>
                </DialogWrapperContext.Provider>
            );
        };
    };
}

export default asDialog;
</file>

<file path="resources/scripts/hoc/asModal.tsx">
import React from 'react';
import isEqual from 'react-fast-compare';
import PortaledModal, { ModalProps } from '@/components/elements/Modal';
import ModalContext, { ModalContextValues } from '@/context/ModalContext';

export interface AsModalProps {
    visible: boolean;
    onModalDismissed?: () => void;
}

export type SettableModalProps = Omit<ModalProps, 'appear' | 'visible' | 'onDismissed'>;

interface State {
    render: boolean;
    visible: boolean;
    propOverrides: Partial<SettableModalProps>;
}

type ExtendedComponentType<T> = (C: React.ComponentType<T>) => React.ComponentType<T & AsModalProps>;

// eslint-disable-next-line @typescript-eslint/ban-types
function asModal<P extends {}>(
    modalProps?: SettableModalProps | ((props: P) => SettableModalProps)
): ExtendedComponentType<P> {
    return function (Component) {
        return class extends React.PureComponent<P & AsModalProps, State> {
            static displayName = `asModal(${Component.displayName})`;

            constructor(props: P & AsModalProps) {
                super(props);

                this.state = {
                    render: props.visible,
                    visible: props.visible,
                    propOverrides: {},
                };
            }

            get computedModalProps(): Readonly<SettableModalProps & { visible: boolean }> {
                return {
                    ...(typeof modalProps === 'function' ? modalProps(this.props) : modalProps),
                    ...this.state.propOverrides,
                    visible: this.state.visible,
                };
            }

            /**
             * @this {React.PureComponent<P & AsModalProps, State>}
             */
            componentDidUpdate(prevProps: Readonly<P & AsModalProps>, prevState: Readonly<State>) {
                if (prevProps.visible && !this.props.visible) {
                    this.setState({ visible: false, propOverrides: {} });
                } else if (!prevProps.visible && this.props.visible) {
                    this.setState({ render: true, visible: true });
                }
                if (!this.state.render && !isEqual(prevState.propOverrides, this.state.propOverrides)) {
                    this.setState({ propOverrides: {} });
                }
            }

            dismiss = () => this.setState({ visible: false });

            setPropOverrides: ModalContextValues['setPropOverrides'] = (value) =>
                this.setState((state) => ({
                    propOverrides: !value ? {} : typeof value === 'function' ? value(state.propOverrides) : value,
                }));

            /**
             * @this {React.PureComponent<P & AsModalProps, State>}
             */
            render() {
                if (!this.state.render) return null;

                return (
                    <PortaledModal
                        appear
                        onDismissed={() =>
                            this.setState({ render: false }, () => {
                                if (typeof this.props.onModalDismissed === 'function') {
                                    this.props.onModalDismissed();
                                }
                            })
                        }
                        {...this.computedModalProps}
                    >
                        <ModalContext.Provider
                            value={{
                                dismiss: this.dismiss.bind(this),
                                setPropOverrides: this.setPropOverrides.bind(this),
                            }}
                        >
                            <Component {...this.props} />
                        </ModalContext.Provider>
                    </PortaledModal>
                );
            }
        };
    };
}

export default asModal;
</file>

<file path="resources/scripts/hoc/RequireServerPermission.tsx">
import React from 'react';
import Can from '@/components/elements/Can';
import { ServerError } from '@/components/elements/ScreenBlock';

export interface RequireServerPermissionProps {
    permissions: string | string[];
}

const RequireServerPermission: React.FC<RequireServerPermissionProps> = ({ children, permissions }) => {
    return (
        <Can
            action={permissions}
            renderOnError={
                <ServerError title={'Access Denied'} message={'You do not have permission to access this page.'} />
            }
        >
            {children}
        </Can>
    );
};

export default RequireServerPermission;
</file>

<file path="resources/scripts/lib/formatters.spec.ts">
import { bytesToString, ip, mbToBytes } from '@/lib/formatters';

describe('@/lib/formatters.ts', function () {
    describe('mbToBytes()', function () {
        it('should convert from MB to Bytes', function () {
            expect(mbToBytes(1)).toBe(1_048_576);
            expect(mbToBytes(0)).toBe(0);
            expect(mbToBytes(0.1)).toBe(104_857);
            expect(mbToBytes(0.001)).toBe(1_048);
            expect(mbToBytes(1024)).toBe(1_073_741_824);
        });
    });

    describe('bytesToString()', function () {
        it.each([
            [0, '0 Bytes'],
            [0.5, '0 Bytes'],
            [0.9, '0 Bytes'],
            [100, '100 Bytes'],
            [100.25, '100.25 Bytes'],
            [100.998, '101 Bytes'],
            [512, '512 Bytes'],
            [1000, '1000 Bytes'],
            [1024, '1 KiB'],
            [5068, '4.95 KiB'],
            [10_000, '9.77 KiB'],
            [10_240, '10 KiB'],
            [11_864, '11.59 KiB'],
            [1_000_000, '976.56 KiB'],
            [1_024_000, '1000 KiB'],
            [1_025_000, '1000.98 KiB'],
            [1_048_576, '1 MiB'],
            [1_356_000, '1.29 MiB'],
            [1_000_000_000, '953.67 MiB'],
            [1_070_000_100, '1020.43 MiB'],
            [1_073_741_824, '1 GiB'],
            [1_678_342_000, '1.56 GiB'],
            [1_000_000_000_000, '931.32 GiB'],
            [1_099_511_627_776, '1 TiB'],
        ])('should format %d bytes as "%s"', function (input, output) {
            expect(bytesToString(input)).toBe(output);
        });
    });

    describe('ip()', function () {
        it('should format an IPv4 address', function () {
            expect(ip('127.0.0.1')).toBe('127.0.0.1');
        });

        it('should format an IPv6 address', function () {
            expect(ip(':::1')).toBe('[:::1]');
            expect(ip('2001:db8::')).toBe('[2001:db8::]');
        });

        it('should handle random inputs', function () {
            expect(ip('1')).toBe('1');
            expect(ip('foobar')).toBe('foobar');
            expect(ip('127.0.0.1:25565')).toBe('[127.0.0.1:25565]');
        });
    });
});
</file>

<file path="resources/scripts/lib/formatters.ts">
const _CONVERSION_UNIT = 1024;

/**
 * Given a value in megabytes converts it back down into bytes.
 */
function mbToBytes(megabytes: number): number {
    return Math.floor(megabytes * _CONVERSION_UNIT * _CONVERSION_UNIT);
}

/**
 * Given an amount of bytes, converts them into a human readable string format
 * using "1024" as the divisor.
 */
function bytesToString(bytes: number, decimals = 2): string {
    const k = _CONVERSION_UNIT;

    if (bytes < 1) return '0 Bytes';

    decimals = Math.floor(Math.max(0, decimals));
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    const value = Number((bytes / Math.pow(k, i)).toFixed(decimals));

    return `${value} ${['Bytes', 'KiB', 'MiB', 'GiB', 'TiB'][i]}`;
}

/**
 * Formats an IPv4 or IPv6 address.
 */
function ip(value: string): string {
    // noinspection RegExpSimplifiable
    return /([a-f0-9:]+:+)+[a-f0-9]+/.test(value) ? `[${value}]` : value;
}

export { ip, mbToBytes, bytesToString };
</file>

<file path="resources/scripts/lib/helpers.spec.ts">
import { hexToRgba } from '@/lib/helpers';

describe('@/lib/helpers.ts', function () {
    describe('hexToRgba()', function () {
        it('should return the expected rgba', function () {
            expect(hexToRgba('#ffffff')).toBe('rgba(255, 255, 255, 1)');
            expect(hexToRgba('#00aabb')).toBe('rgba(0, 170, 187, 1)');
            expect(hexToRgba('#efefef')).toBe('rgba(239, 239, 239, 1)');
        });

        it('should ignore case', function () {
            expect(hexToRgba('#FF00A3')).toBe('rgba(255, 0, 163, 1)');
        });

        it('should allow alpha channel changes', function () {
            expect(hexToRgba('#ece5a8', 0.5)).toBe('rgba(236, 229, 168, 0.5)');
            expect(hexToRgba('#ece5a8', 0.1)).toBe('rgba(236, 229, 168, 0.1)');
            expect(hexToRgba('#000000', 0)).toBe('rgba(0, 0, 0, 0)');
        });

        it('should handle invalid strings', function () {
            expect(hexToRgba('')).toBe('');
            expect(hexToRgba('foobar')).toBe('foobar');
            expect(hexToRgba('#fff')).toBe('#fff');
            expect(hexToRgba('#')).toBe('#');
            expect(hexToRgba('#fffffy')).toBe('#fffffy');
        });
    });
});
</file>

<file path="resources/scripts/lib/helpers.ts">
/**
 * Given a valid six character HEX color code, converts it into its associated
 * RGBA value with a user controllable alpha channel.
 */
function hexToRgba(hex: string, alpha = 1): string {
    // noinspection RegExpSimplifiable
    if (!/#?([a-fA-F0-9]{2}){3}/.test(hex)) {
        return hex;
    }

    // noinspection RegExpSimplifiable
    const [r, g, b] = hex.match(/[a-fA-F0-9]{2}/g)!.map((v) => parseInt(v, 16));

    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

export { hexToRgba };
</file>

<file path="resources/scripts/lib/objects.spec.ts">
import { isObject } from '@/lib/objects';

describe('@/lib/objects.ts', function () {
    describe('isObject()', function () {
        it('should return true for objects', function () {
            expect(isObject({})).toBe(true);
            expect(isObject({ foo: 123 })).toBe(true);
            expect(isObject(Object.freeze({}))).toBe(true);
        });

        it('should return false for null', function () {
            expect(isObject(null)).toBe(false);
        });

        it.each([undefined, 123, 'foobar', () => ({}), Function, String(123), isObject, () => null, [], [1, 2, 3]])(
            'should return false for %p',
            function (value) {
                expect(isObject(value)).toBe(false);
            }
        );
    });
});
</file>

<file path="resources/scripts/lib/objects.ts">
/**
 * Determines if the value provided to the function is an object type that
 * is not null.
 */
function isObject(val: unknown): val is Record<string, unknown> {
    return typeof val === 'object' && val !== null && !Array.isArray(val);
}

/**
 * Determines if an object is truly empty by looking at the keys present
 * and the prototype value.
 */
// eslint-disable-next-line @typescript-eslint/ban-types
function isEmptyObject(val: {}): boolean {
    return Object.keys(val).length === 0 && Object.getPrototypeOf(val) === Object.prototype;
}

/**
 * A helper function for use in TypeScript that returns all of the keys
 * for an object, but in a typed manner to make working with them a little
 * easier.
 */
// eslint-disable-next-line @typescript-eslint/ban-types
function getObjectKeys<T extends {}>(o: T): (keyof T)[] {
    return Object.keys(o) as (keyof typeof o)[];
}

export { isObject, isEmptyObject, getObjectKeys };
</file>

<file path="resources/scripts/lib/strings.spec.ts">
import { capitalize } from '@/lib/strings';

describe('@/lib/strings.ts', function () {
    describe('capitalize()', function () {
        it('should capitalize a string', function () {
            expect(capitalize('foo bar')).toBe('Foo bar');
            expect(capitalize('FOOBAR')).toBe('Foobar');
        });

        it('should handle empty strings', function () {
            expect(capitalize('')).toBe('');
        });
    });
});
</file>

<file path="resources/scripts/lib/strings.ts">
function capitalize(value: string): string {
    return value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
}

export { capitalize };
</file>

<file path="resources/scripts/plugins/useDeepCompareEffect.ts">
import { useDeepMemoize } from './useDeepMemoize';
import { DependencyList, EffectCallback, useEffect } from 'react';

export const useDeepCompareEffect = (callback: EffectCallback, dependencies: DependencyList) =>
    useEffect(callback, useDeepMemoize(dependencies));
</file>

<file path="resources/scripts/plugins/useDeepCompareMemo.ts">
import { DependencyList, useMemo } from 'react';
import { useDeepMemoize } from '@/plugins/useDeepMemoize';

export const useDeepCompareMemo = <T>(callback: () => T, dependencies: DependencyList) =>
    useMemo(callback, useDeepMemoize(dependencies));
</file>

<file path="resources/scripts/plugins/useDeepMemoize.ts">
import isEqual from 'react-fast-compare';
import { DependencyList, MutableRefObject, useRef } from 'react';

export const useDeepMemoize = <T = DependencyList>(value: T): T => {
    const ref: MutableRefObject<T | undefined> = useRef();

    if (!isEqual(value, ref.current)) {
        ref.current = value;
    }

    return ref.current as T;
};
</file>

<file path="resources/scripts/plugins/useEventListener.ts">
import { useEffect, useRef } from 'react';

export default (
    eventName: string,
    handler: (e: Event | CustomEvent | UIEvent | any) => void,
    options?: boolean | EventListenerOptions
) => {
    const savedHandler = useRef<any>(null);

    useEffect(() => {
        savedHandler.current = handler;
    }, [handler]);

    useEffect(() => {
        const isSupported = window && window.addEventListener;
        if (!isSupported) return;

        const eventListener = (event: any) => savedHandler.current(event);
        window.addEventListener(eventName, eventListener, options);
        return () => {
            window.removeEventListener(eventName, eventListener);
        };
    }, [eventName, window]);
};
</file>

<file path="resources/scripts/plugins/useFileManagerSwr.ts">
import useSWR from 'swr';
import { cleanDirectoryPath } from '@/helpers';
import { ServerContext } from '@/state/server';
import loadDirectory, { FileObject } from '@/api/server/files/loadDirectory';

export const getDirectorySwrKey = (uuid: string, directory: string): string => `${uuid}:files:${directory}`;

export default () => {
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const directory = ServerContext.useStoreState((state) => state.files.directory);

    return useSWR<FileObject[]>(
        getDirectorySwrKey(uuid, directory),
        () => loadDirectory(uuid, cleanDirectoryPath(directory)),
        {
            focusThrottleInterval: 30000,
            revalidateOnMount: false,
            refreshInterval: 0,
            errorRetryCount: 2,
        }
    );
};
</file>

<file path="resources/scripts/plugins/useFilteredObject.ts">
/**
 * Similar to "withQueryBuilderParams" except this function filters out any null,
 * undefined, or empty string key values. This allows the parameters to be used for
 * caching without having to account for all of the different data combinations.
 */
import { isEmptyObject, isObject } from '@/lib/objects';

// eslint-disable-next-line @typescript-eslint/ban-types
export default <T extends {}>(data: T): T => {
    const empty = [undefined, null, ''] as unknown[];

    const removeEmptyValues = (input: T): T =>
        Object.entries(input)
            .filter(([_, value]) => !empty.includes(value))
            .reduce((obj, [k, v]) => {
                const parsed = isObject(v) ? removeEmptyValues(v as any) : v;

                return isObject(parsed) && isEmptyObject(parsed) ? obj : { ...obj, [k]: parsed };
            }, {} as T);

    return removeEmptyValues(data);
};
</file>

<file path="resources/scripts/plugins/useFlash.ts">
import { ApplicationStore } from '@/state';
import { FlashStore } from '@/state/flashes';
import { Actions, useStoreActions } from 'easy-peasy';

interface KeyedFlashStore {
    addError: (message: string, title?: string) => void;
    clearFlashes: () => void;
    clearAndAddHttpError: (error?: Error | string | null) => void;
}

const useFlash = (): Actions<FlashStore> => {
    return useStoreActions((actions: Actions<ApplicationStore>) => actions.flashes);
};

const useFlashKey = (key: string): KeyedFlashStore => {
    const { addFlash, clearFlashes, clearAndAddHttpError } = useFlash();

    return {
        addError: (message, title) => addFlash({ key, message, title, type: 'danger' }),
        clearFlashes: () => clearFlashes(key),
        clearAndAddHttpError: (error) => clearAndAddHttpError({ key, error }),
    };
};

export { useFlashKey };
export default useFlash;
</file>

<file path="resources/scripts/plugins/useLocationHash.ts">
import { useLocation } from 'react-router';
import { useMemo } from 'react';

export default () => {
    const location = useLocation();

    const getHashObject = (value: string): Record<string, string> =>
        value
            .substring(1)
            .split('&')
            .reduce((obj, str) => {
                const [key, value = ''] = str.split('=');

                return !str.trim() ? obj : { ...obj, [key]: value };
            }, {});

    const pathTo = (params: Record<string, string>): string => {
        const current = getHashObject(location.hash);

        for (const key in params) {
            current[key] = params[key];
        }

        return Object.keys(current)
            .map((key) => `${key}=${current[key]}`)
            .join('&');
    };

    const hash = useMemo((): Record<string, string> => getHashObject(location.hash), [location.hash]);

    return { hash, pathTo };
};
</file>

<file path="resources/scripts/plugins/usePermissions.ts">
import { ServerContext } from '@/state/server';
import { useDeepCompareMemo } from '@/plugins/useDeepCompareMemo';

export const usePermissions = (action: string | string[]): boolean[] => {
    const userPermissions = ServerContext.useStoreState((state) => state.server.permissions);

    return useDeepCompareMemo(() => {
        if (userPermissions[0] === '*') {
            return Array(Array.isArray(action) ? action.length : 1).fill(true);
        }

        return (Array.isArray(action) ? action : [action]).map(
            (permission) =>
                // Allows checking for any permission matching a name, for example files.*
                // will return if the user has any permission under the file.XYZ namespace.
                (permission.endsWith('.*') &&
                    userPermissions.filter((p) => p.startsWith(permission.split('.')[0])).length > 0) ||
                // Otherwise just check if the entire permission exists in the array or not.
                userPermissions.indexOf(permission) >= 0
        );
    }, [action, userPermissions]);
};
</file>

<file path="resources/scripts/plugins/usePersistedState.ts">
import { Dispatch, SetStateAction, useEffect, useState } from 'react';

export function usePersistedState<S = undefined>(
    key: string,
    defaultValue: S
): [S | undefined, Dispatch<SetStateAction<S | undefined>>] {
    const [state, setState] = useState(() => {
        try {
            const item = localStorage.getItem(key);

            return JSON.parse(item || String(defaultValue));
        } catch (e) {
            console.warn('Failed to retrieve persisted value from store.', e);

            return defaultValue;
        }
    });

    useEffect(() => {
        localStorage.setItem(key, JSON.stringify(state));
    }, [key, state]);

    return [state, setState];
}
</file>

<file path="resources/scripts/plugins/useSWRKey.ts">
import { useDeepCompareMemo } from '@/plugins/useDeepCompareMemo';
import { ServerContext } from '@/state/server';
import { useStoreState } from '@/state/hooks';

// eslint-disable-next-line @typescript-eslint/ban-types
type Context = string | string[] | (string | number | null | {})[];

function useSWRKey(context: Context, prefix: string | null = null): string {
    const key = useDeepCompareMemo((): string => {
        return (Array.isArray(context) ? context : [context]).map((value) => JSON.stringify(value)).join(':');
    }, [context]);

    if (!key.trim().length) {
        throw new Error('Must provide a valid context key to "useSWRKey".');
    }

    return `swr::${prefix ? `${prefix}:` : ''}${key.trim()}`;
}

function useServerSWRKey(context: Context): string {
    const uuid = ServerContext.useStoreState((state) => state.server.data?.uuid);

    return useSWRKey(context, `server:${uuid}`);
}

function useUserSWRKey(context: Context): string {
    const uuid = useStoreState((state) => state.user.data?.uuid);

    return useSWRKey(context, `user:${uuid}`);
}

export default useSWRKey;
export { useServerSWRKey, useUserSWRKey };
</file>

<file path="resources/scripts/plugins/useWebsocketEvent.ts">
import { useEffect, useRef } from 'react';
import { ServerContext } from '@/state/server';
import { SocketEvent } from '@/components/server/events';

const useWebsocketEvent = (event: SocketEvent, callback: (data: string) => void) => {
    const { connected, instance } = ServerContext.useStoreState((state) => state.socket);
    const savedCallback = useRef<any>(null);

    useEffect(() => {
        savedCallback.current = callback;
    }, [callback]);

    return useEffect(() => {
        const eventListener = (event: SocketEvent) => savedCallback.current(event);
        if (connected && instance) {
            instance.addListener(event, eventListener);
        }

        return () => {
            instance && instance.removeListener(event, eventListener);
        };
    }, [event, connected, instance]);
};

export default useWebsocketEvent;
</file>

<file path="resources/scripts/plugins/useWindowDimensions.ts">
import { useState, useEffect } from 'react';

function getWindowDimensions() {
    const { innerWidth: width, innerHeight: height } = window;
    return { width, height };
}

export default function useWindowDimensions() {
    const [windowDimensions, setWindowDimensions] = useState(getWindowDimensions());

    useEffect(() => {
        function handleResize() {
            setWindowDimensions(getWindowDimensions());
        }

        window.addEventListener('resize', handleResize);

        return () => window.removeEventListener('resize', handleResize);
    }, []);

    return windowDimensions;
}
</file>

<file path="resources/scripts/plugins/Websocket.ts">
import Sockette from 'sockette';
import { EventEmitter } from 'events';

export class Websocket extends EventEmitter {
    // Timer instance for this socket.
    private timer: any = null;

    // The backoff for the timer, in milliseconds.
    private backoff = 5000;

    // The socket instance being tracked.
    private socket: Sockette | null = null;

    // The URL being connected to for the socket.
    private url: string | null = null;

    // The authentication token passed along with every request to the Daemon.
    // By default this token expires every 15 minutes and must therefore be
    // refreshed at a pretty continuous interval. The socket server will respond
    // with "token expiring" and "token expired" events when approaching 3 minutes
    // and 0 minutes to expiry.
    private token = '';

    // Connects to the websocket instance and sets the token for the initial request.
    connect(url: string): this {
        this.url = url;

        this.socket = new Sockette(`${this.url}`, {
            onmessage: (e) => {
                try {
                    const { event, args } = JSON.parse(e.data);
                    args ? this.emit(event, ...args) : this.emit(event);
                } catch (ex) {
                    console.warn('Failed to parse incoming websocket message.', ex);
                }
            },
            onopen: () => {
                // Clear the timers, we managed to connect just fine.
                this.timer && clearTimeout(this.timer);
                this.backoff = 5000;

                this.emit('SOCKET_OPEN');
                this.authenticate();
            },
            onreconnect: () => {
                this.emit('SOCKET_RECONNECT');
                this.authenticate();
            },
            onclose: () => this.emit('SOCKET_CLOSE'),
            onerror: (error) => this.emit('SOCKET_ERROR', error),
        });

        this.timer = setTimeout(() => {
            this.backoff = this.backoff + 2500 >= 20000 ? 20000 : this.backoff + 2500;
            this.socket && this.socket.close();
            clearTimeout(this.timer);

            // Re-attempt connecting to the socket.
            this.connect(url);
        }, this.backoff);

        return this;
    }

    // Sets the authentication token to use when sending commands back and forth
    // between the websocket instance.
    setToken(token: string, isUpdate = false): this {
        this.token = token;

        if (isUpdate) {
            this.authenticate();
        }

        return this;
    }

    authenticate() {
        if (this.url && this.token) {
            this.send('auth', this.token);
        }
    }

    close(code?: number, reason?: string) {
        this.url = null;
        this.token = '';
        this.socket && this.socket.close(code, reason);
    }

    open() {
        this.socket && this.socket.open();
    }

    reconnect() {
        this.socket && this.socket.reconnect();
    }

    send(event: string, payload?: string | string[]) {
        this.socket &&
            this.socket.send(
                JSON.stringify({
                    event,
                    args: Array.isArray(payload) ? payload : [payload],
                })
            );
    }
}
</file>

<file path="resources/scripts/plugins/XtermScrollDownHelperAddon.ts">
import { Terminal, ITerminalAddon } from 'xterm';

export class ScrollDownHelperAddon implements ITerminalAddon {
    private terminal: Terminal = new Terminal();
    private element?: HTMLDivElement;

    activate(terminal: Terminal): void {
        this.terminal = terminal;

        this.terminal.onScroll(() => {
            if (this.isScrolledDown()) {
                this.hide();
            }
        });

        this.terminal.onLineFeed(() => {
            if (!this.isScrolledDown()) {
                this.show();
            }
        });

        this.show();
    }

    dispose(): void {
        // ignore
    }

    show(): void {
        if (!this.terminal || !this.terminal.element) {
            return;
        }
        if (this.element) {
            this.element.style.visibility = 'visible';
            return;
        }

        this.terminal.element.style.position = 'relative';

        this.element = document.createElement('div');
        this.element.innerHTML =
            '<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="arrow-down" class="svg-inline--fa fa-bell fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M374.6 310.6l-160 160C208.4 476.9 200.2 480 192 480s-16.38-3.125-22.62-9.375l-160-160c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 370.8V64c0-17.69 14.33-31.1 31.1-31.1S224 46.31 224 64v306.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0S387.1 298.1 374.6 310.6z"/></svg>';
        this.element.style.position = 'absolute';
        this.element.style.right = '1.5rem';
        this.element.style.bottom = '.5rem';
        this.element.style.padding = '.5rem';
        this.element.style.fontSize = '1.25em';
        this.element.style.boxShadow = '0 2px 8px #000';
        this.element.style.backgroundColor = '#252526';
        this.element.style.zIndex = '999';
        this.element.style.cursor = 'pointer';

        this.element.addEventListener('click', () => {
            this.terminal.scrollToBottom();
        });

        this.terminal.element.appendChild(this.element);
    }

    hide(): void {
        if (this.element) {
            this.element.style.visibility = 'hidden';
        }
    }

    isScrolledDown(): boolean {
        return this.terminal.buffer.active.viewportY === this.terminal.buffer.active.baseY;
    }
}
</file>

<file path="resources/scripts/routers/AuthenticationRouter.tsx">
import React from 'react';
import { useStoreState } from '@/state/hooks';
import { useHistory, useLocation } from 'react-router';
import { NotFound } from '@/components/elements/ScreenBlock';
import LoginContainer from '@/components/auth/LoginContainer';
import { Route, Switch, useRouteMatch } from 'react-router-dom';
import DiscordContainer from '@/components/auth/DiscordContainer';
import RegisterContainer from '@/components/auth/RegisterContainer';
import ResetPasswordContainer from '@/components/auth/ResetPasswordContainer';
import ForgotPasswordContainer from '@/components/auth/ForgotPasswordContainer';
import LoginCheckpointContainer from '@/components/auth/LoginCheckpointContainer';

export default () => {
    const history = useHistory();
    const location = useLocation();
    const { path } = useRouteMatch();
    const email = useStoreState((state) => state.settings.data?.registration.email);
    const discord = useStoreState((state) => state.settings.data?.registration.discord);

    return (
        <div className={'pt-8 xl:pt-32'}>
            <Switch location={location}>
                <Route path={`${path}/login`} component={LoginContainer} exact />
                <Route path={`${path}/login/checkpoint`} component={LoginCheckpointContainer} />
                {email && <Route path={`${path}/register`} component={RegisterContainer} />}
                {discord && <Route path={`${path}/discord`} component={DiscordContainer} />}
                <Route path={`${path}/password`} component={ForgotPasswordContainer} exact />
                <Route path={`${path}/password/reset/:token`} component={ResetPasswordContainer} />
                <Route path={`${path}/checkpoint`} />
                <Route path={'*'}>
                    <NotFound onBack={() => history.push('/auth/login')} />
                </Route>
            </Switch>
        </div>
    );
};
</file>

<file path="resources/scripts/routers/DashboardRouter.tsx">
// import React from 'react';
// import tw from 'twin.macro';
// import * as Icon from 'react-feather';
// import { useStoreState } from 'easy-peasy';
// import { useLocation } from 'react-router';
// import TransitionRouter from '@/TransitionRouter';
// import Spinner from '@/components/elements/Spinner';
// import SidePanel from '@/components/elements/SidePanel';
// import { NavLink, Route, Switch } from 'react-router-dom';
// import { NotFound } from '@/components/elements/ScreenBlock';
// import SubNavigation from '@/components/elements/SubNavigation';
// import useWindowDimensions from '@/plugins/useWindowDimensions';
// import MobileNavigation from '@/components/elements/MobileNavigation';
// import ReferralContainer from '@/components/dashboard/ReferralContainer';
// import DashboardContainer from '@/components/dashboard/DashboardContainer';
// import AccountApiContainer from '@/components/dashboard/AccountApiContainer';
// // import InformationContainer from '@/components/elements/InformationContainer';
// import AccountSSHContainer from '@/components/dashboard/ssh/AccountSSHContainer';
// import AccountOverviewContainer from '@/components/dashboard/AccountOverviewContainer';
// import AccountSecurityContainer from '@/components/dashboard/AccountSecurityContainer';
// import CouponContainer from '@/components/dashboard/CouponContainer';

// export default () => {
//     const location = useLocation();
//     const { width } = useWindowDimensions();
//     const coupons = useStoreState((state) => state.settings.data!.coupons);
//     const referrals = useStoreState((state) => state.storefront.data!.referrals.enabled);

//     return (
//         <>
//             {width >= 1280 ? <SidePanel /> : <MobileNavigation />}
//             {location.pathname.startsWith('/account') ? (
//                 <SubNavigation className={'j-down'}>
//                     <div>
//                         <NavLink to={'/account'} exact>
//                             <div css={tw`flex items-center justify-between`}>
//                                 Account <Icon.User css={tw`ml-1`} size={18} />
//                             </div>
//                         </NavLink>
//                         <NavLink to={'/account/security'}>
//                             <div css={tw`flex items-center justify-between`}>
//                                 Security <Icon.Key css={tw`ml-1`} size={18} />
//                             </div>
//                         </NavLink>
//                         {referrals && (
//                             <NavLink to={'/account/referrals'}>
//                                 <div css={tw`flex items-center justify-between`}>
//                                     Referrals <Icon.DollarSign css={tw`ml-1`} size={18} />
//                                 </div>
//                             </NavLink>
//                         )}
//                         <NavLink to={'/account/api'}>
//                             <div css={tw`flex items-center justify-between`}>
//                                 API <Icon.Code css={tw`ml-1`} size={18} />
//                             </div>
//                         </NavLink>
//                         <NavLink to={'/account/ssh'}>
//                             <div css={tw`flex items-center justify-between`}>
//                                 SSH Keys <Icon.Terminal css={tw`ml-1`} size={18} />
//                             </div>
//                         </NavLink>
//                         {coupons && (
//                             <NavLink to={'/account/coupons'}>
//                                 <div className={'flex items-center justify-between'}>
//                                     Coupons <Icon.DollarSign className={'ml-1'} size={18} />
//                                 </div>
//                             </NavLink>
//                         )}
//                     </div>
//                 </SubNavigation>
//             ) : (
//                 <SubNavigation className={'lg:visible invisible'}>
//                     <div>
//                         {/* <InformationContainer /> */}
//                     </div>
//                 </SubNavigation>
//             )}
//             <TransitionRouter>
//                 <React.Suspense fallback={<Spinner centered />}>
//                     <Switch location={location}>
//                         <Route path={'/'} exact>
//                             <DashboardContainer />
//                         </Route>
//                         <Route path={'/account'} exact>
//                             <AccountOverviewContainer />
//                         </Route>
//                         <Route path={'/account/security'} exact>
//                             <AccountSecurityContainer />
//                         </Route>
//                         {referrals && (
//                             <Route path={`/account/referrals`} exact>
//                                 <ReferralContainer />
//                             </Route>
//                         )}
//                         <Route path={'/account/api'} exact>
//                             <AccountApiContainer />
//                         </Route>
//                         <Route path={'/account/ssh'} exact>
//                             <AccountSSHContainer />
//                         </Route>
//                         {coupons && (
//                             <Route path={'/account/coupons'} exact>
//                                 <CouponContainer />
//                             </Route>
//                         )}
//                         <Route path={'*'}>
//                             <NotFound />
//                         </Route>
//                     </Switch>
//                 </React.Suspense>
//             </TransitionRouter>
//         </>
//     );
// };

import React from 'react';
import tw from 'twin.macro';
import * as Icon from 'react-feather';
import { useStoreState } from 'easy-peasy';
import { useLocation } from 'react-router';
import TransitionRouter from '@/TransitionRouter';
import Spinner from '@/components/elements/Spinner';
import SidePanel from '@/components/elements/SidePanel';
import { NavLink, Route, Switch } from 'react-router-dom';
import { NotFound } from '@/components/elements/ScreenBlock';
import SubNavigation from '@/components/elements/SubNavigation';
import useWindowDimensions from '@/plugins/useWindowDimensions';
import MobileNavigation from '@/components/elements/MobileNavigation';
import ReferralContainer from '@/components/dashboard/ReferralContainer';
import DashboardContainer from '@/components/dashboard/DashboardContainer';
import AccountApiContainer from '@/components/dashboard/AccountApiContainer';
import AccountSSHContainer from '@/components/dashboard/ssh/AccountSSHContainer';
import AccountOverviewContainer from '@/components/dashboard/AccountOverviewContainer';
import AccountSecurityContainer from '@/components/dashboard/AccountSecurityContainer';
import CouponContainer from '@/components/dashboard/CouponContainer';

export default () => {
    const location = useLocation();
    const { width } = useWindowDimensions();
    const coupons = useStoreState((state) => state.settings.data!.coupons);
    const referrals = useStoreState((state) => state.storefront.data!.referrals.enabled);

    return (
        <>
            {width >= 1280 ? <SidePanel /> : <MobileNavigation />}
            {location.pathname.startsWith('/account') ? (
                <SubNavigation className={'j-down'}>
                    <div>
                        <NavLink to={'/account'} exact>
                            <div css={tw`flex items-center justify-between`}>
                                Account <Icon.User css={tw`ml-1`} size={18} />
                            </div>
                        </NavLink>
                        <NavLink to={'/account/security'}>
                            <div css={tw`flex items-center justify-between`}>
                                Security <Icon.Key css={tw`ml-1`} size={18} />
                            </div>
                        </NavLink>
                        {referrals && (
                            <NavLink to={'/account/referrals'}>
                                <div css={tw`flex items-center justify-between`}>
                                    Referrals <Icon.DollarSign css={tw`ml-1`} size={18} />
                                </div>
                            </NavLink>
                        )}
                        <NavLink to={'/account/api'}>
                            <div css={tw`flex items-center justify-between`}>
                                API <Icon.Code css={tw`ml-1`} size={18} />
                            </div>
                        </NavLink>
                        <NavLink to={'/account/ssh'}>
                            <div css={tw`flex items-center justify-between`}>
                                SSH Keys <Icon.Terminal css={tw`ml-1`} size={18} />
                            </div>
                        </NavLink>
                        {coupons && (
                            <NavLink to={'/account/coupons'}>
                                <div className={'flex items-center justify-between'}>
                                    Coupons <Icon.DollarSign className={'ml-1'} size={18} />
                                </div>
                            </NavLink>
                        )}
                    </div>
                </SubNavigation>
            ) : (
                <SubNavigation className={'lg:visible invisible'}>
                    <div>{/* <InformationContainer /> */}</div>
                </SubNavigation>
            )}
            <div css={tw`ml-0 xl:ml-32`}>
                <TransitionRouter>
                    <React.Suspense fallback={<Spinner centered />}>
                        <Switch location={location}>
                            <Route path={'/'} exact>
                                <DashboardContainer />
                            </Route>
                            <Route path={'/account'} exact>
                                <AccountOverviewContainer />
                            </Route>
                            <Route path={'/account/security'} exact>
                                <AccountSecurityContainer />
                            </Route>
                            {referrals && (
                                <Route path={`/account/referrals`} exact>
                                    <ReferralContainer />
                                </Route>
                            )}
                            <Route path={'/account/api'} exact>
                                <AccountApiContainer />
                            </Route>
                            <Route path={'/account/ssh'} exact>
                                <AccountSSHContainer />
                            </Route>
                            {coupons && (
                                <Route path={'/account/coupons'} exact>
                                    <CouponContainer />
                                </Route>
                            )}
                            <Route path={'*'}>
                                <NotFound />
                            </Route>
                        </Switch>
                    </React.Suspense>
                </TransitionRouter>
            </div>
        </>
    );
};
</file>

<file path="resources/scripts/routers/IndexRouter.tsx">
import React from 'react';
import { useStoreState } from '@/state/hooks';
import { ServerContext } from '@/state/server';
import { history } from '@/components/history';
import StoreRouter from '@/routers/StoreRouter';
import TicketRouter from '@/routers/TicketRouter';
import ServerRouter from '@/routers/ServerRouter';
import Spinner from '@/components/elements/Spinner';
import { Router, Switch, Route } from 'react-router';
import DashboardRouter from '@/routers/DashboardRouter';
import AuthenticationRouter from '@/routers/AuthenticationRouter';
import { NotApproved, NotFound } from '@/components/elements/ScreenBlock';
import AuthenticatedRoute from '@/components/elements/AuthenticatedRoute';

export default () => {
    const authenticated = useStoreState((state) => state.user?.data);
    const approved = useStoreState((state) => state.user.data?.approved);
    const store = useStoreState((state) => state.storefront.data!.enabled);
    const tickets = useStoreState((state) => state.settings.data!.tickets);
    const approvals = useStoreState((state) => state.settings.data!.approvals);

    if (approvals && !approved && authenticated) {
        return (
            <NotApproved
                title={'Awaiting Approval'}
                message={'Your account is currently pending approval from an administator.'}
            />
        );
    }

    return (
        <Router history={history}>
            <Switch>
                <Route path={'/auth'}>
                    <Spinner.Suspense>
                        <AuthenticationRouter />
                    </Spinner.Suspense>
                </Route>
                <AuthenticatedRoute path={'/server/:id'}>
                    <Spinner.Suspense>
                        <ServerContext.Provider>
                            <ServerRouter />
                        </ServerContext.Provider>
                    </Spinner.Suspense>
                </AuthenticatedRoute>
                {store && (
                    <AuthenticatedRoute path={'/store'}>
                        <Spinner.Suspense>
                            <StoreRouter />
                        </Spinner.Suspense>
                    </AuthenticatedRoute>
                )}
                {tickets && (
                    <AuthenticatedRoute path={'/tickets'}>
                        <Spinner.Suspense>
                            <TicketRouter />
                        </Spinner.Suspense>
                    </AuthenticatedRoute>
                )}
                <AuthenticatedRoute path={'/'}>
                    <Spinner.Suspense>
                        <DashboardRouter />
                    </Spinner.Suspense>
                </AuthenticatedRoute>
                <Route path={'*'} component={NotFound} />
            </Switch>
        </Router>
    );
};
</file>

<file path="resources/scripts/routers/routes.ts">
import React, { lazy } from 'react';
import ServerConsole from '@/components/server/console/ServerConsoleContainer';
import DatabasesContainer from '@/components/server/databases/DatabasesContainer';
import ScheduleContainer from '@/components/server/schedules/ScheduleContainer';
import UsersContainer from '@/components/server/users/UsersContainer';
import BackupContainer from '@/components/server/backups/BackupContainer';
import NetworkContainer from '@/components/server/network/NetworkContainer';
import StartupContainer from '@/components/server/startup/StartupContainer';
import FileManagerContainer from '@/components/server/files/FileManagerContainer';
import SettingsContainer from '@/components/server/settings/SettingsContainer';
import AccountOverviewContainer from '@/components/dashboard/AccountOverviewContainer';
import AccountApiContainer from '@/components/dashboard/AccountApiContainer';
import AccountSSHContainer from '@/components/dashboard/ssh/AccountSSHContainer';
import ActivityLogContainer from '@/components/dashboard/activity/ActivityLogContainer';
import ServerActivityLogContainer from '@/components/server/ServerActivityLogContainer';

// Each of the router files is already code split out appropriately  so
// all of the items above will only be loaded in when that router is loaded.
//
// These specific lazy loaded routes are to avoid loading in heavy screens
// for the server dashboard when they're only needed for specific instances.
const FileEditContainer = lazy(() => import('@/components/server/files/FileEditContainer'));
const ScheduleEditContainer = lazy(() => import('@/components/server/schedules/ScheduleEditContainer'));

interface RouteDefinition {
    path: string;
    // If undefined is passed this route is still rendered into the router itself
    // but no navigation link is displayed in the sub-navigation menu.
    name: string | undefined;
    component: React.ComponentType;
    exact?: boolean;
}

interface ServerRouteDefinition extends RouteDefinition {
    permission: string | string[] | null;
}

interface Routes {
    // All of the routes available under "/account"
    account: RouteDefinition[];
    // All of the routes available under "/server/:id"
    server: ServerRouteDefinition[];
}

export default {
    account: [
        {
            path: '/',
            name: 'Account',
            component: AccountOverviewContainer,
            exact: true,
        },
        {
            path: '/api',
            name: 'API Credentials',
            component: AccountApiContainer,
        },
        {
            path: '/ssh',
            name: 'SSH Keys',
            component: AccountSSHContainer,
        },
        {
            path: '/activity',
            name: 'Activity',
            component: ActivityLogContainer,
        },
    ],
    server: [
        {
            path: '/',
            permission: null,
            name: 'Console',
            component: ServerConsole,
            exact: true,
        },
        {
            path: '/files',
            permission: 'file.*',
            name: 'Files',
            component: FileManagerContainer,
        },
        {
            path: '/files/:action(edit|new)',
            permission: 'file.*',
            name: undefined,
            component: FileEditContainer,
        },
        {
            path: '/databases',
            permission: 'database.*',
            name: 'Databases',
            component: DatabasesContainer,
        },
        {
            path: '/schedules',
            permission: 'schedule.*',
            name: 'Schedules',
            component: ScheduleContainer,
        },
        {
            path: '/schedules/:id',
            permission: 'schedule.*',
            name: undefined,
            component: ScheduleEditContainer,
        },
        {
            path: '/users',
            permission: 'user.*',
            name: 'Users',
            component: UsersContainer,
        },
        {
            path: '/backups',
            permission: 'backup.*',
            name: 'Backups',
            component: BackupContainer,
        },
        {
            path: '/network',
            permission: 'allocation.*',
            name: 'Network',
            component: NetworkContainer,
        },
        {
            path: '/startup',
            permission: 'startup.*',
            name: 'Startup',
            component: StartupContainer,
        },
        {
            path: '/settings',
            permission: ['settings.*', 'file.sftp'],
            name: 'Settings',
            component: SettingsContainer,
        },
        {
            path: '/activity',
            permission: 'activity.*',
            name: 'Activity',
            component: ServerActivityLogContainer,
        },
    ],
} as Routes;
</file>

<file path="resources/scripts/routers/ServerRouter.tsx">
import tw from 'twin.macro';
import * as Icon from 'react-feather';
import { useLocation } from 'react-router';
import { useStoreState } from 'easy-peasy';
import Can from '@/components/elements/Can';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import TransitionRouter from '@/TransitionRouter';
import React, { useEffect, useState } from 'react';
import Spinner from '@/components/elements/Spinner';
import { CSSTransition } from 'react-transition-group';
import SidePanel from '@/components/elements/SidePanel';
import Suspended from '@/components/elements/Suspended';
import useWindowDimensions from '@/plugins/useWindowDimensions';
import SubNavigation from '@/components/elements/SubNavigation';
import ErrorBoundary from '@/components/elements/ErrorBoundary';
import ExternalConsole from '@/components/server/ExternalConsole';
import InstallListener from '@/components/server/InstallListener';
import ServerRestoreSvg from '@/assets/images/server_restore.svg';
import PluginContainer from '@/components/server/PluginContainer';
import EditContainer from '@/components/server/edit/EditContainer';
import TransferListener from '@/components/server/TransferListener';
import WebsocketHandler from '@/components/server/WebsocketHandler';
import RequireServerPermission from '@/hoc/RequireServerPermission';
import ServerInstallSvg from '@/assets/images/server_installing.svg';
import MobileNavigation from '@/components/elements/MobileNavigation';
import UsersContainer from '@/components/server/users/UsersContainer';
import { NavLink, Route, Switch, useRouteMatch } from 'react-router-dom';
import BackupContainer from '@/components/server/backups/BackupContainer';
import FileEditContainer from '@/components/server/files/FileEditContainer';
import NetworkContainer from '@/components/server/network/NetworkContainer';
import StartupContainer from '@/components/server/startup/StartupContainer';
import SettingsContainer from '@/components/server/settings/SettingsContainer';
import ScheduleContainer from '@/components/server/schedules/ScheduleContainer';
import DatabasesContainer from '@/components/server/databases/DatabasesContainer';
import FileManagerContainer from '@/components/server/files/FileManagerContainer';
import AnalyticsContainer from '@/components/server/analytics/AnalyticsContainer';
import ScreenBlock, { NotFound, ServerError } from '@/components/elements/ScreenBlock';
import ServerConsoleContainer from '@/components/server/console/ServerConsoleContainer';
import ScheduleEditContainer from '@/components/server/schedules/ScheduleEditContainer';
import ServerActivityLogContainer from '@/components/server/ServerActivityLogContainer';

const ConflictStateRenderer = () => {
    const status = ServerContext.useStoreState((state) => state.server.data?.status || null);
    const isTransferring = ServerContext.useStoreState((state) => state.server.data?.isTransferring || false);

    return status === 'installing' || status === 'install_failed' ? (
        <ScreenBlock
            title={'Running Installer'}
            image={ServerInstallSvg}
            message={'Your server should be ready soon, please try again in a few minutes.'}
        />
    ) : status === 'suspended' ? (
        <Suspended />
    ) : (
        <ScreenBlock
            title={isTransferring ? 'Transferring' : 'Restoring from Backup'}
            image={ServerRestoreSvg}
            message={
                isTransferring
                    ? 'Your server is being transfered to a new node, please check back later.'
                    : 'Your server is currently being restored from a backup, please check back in a few minutes.'
            }
        />
    );
};

export default () => {
    const match = useRouteMatch<{ id: string }>();
    const location = useLocation();
    const { width } = useWindowDimensions();

    const [error, setError] = useState('');
    const rootAdmin = useStoreState((state) => state.user.data!.rootAdmin);
    const databasesEnabled = useStoreState((state) => state.settings.data!.databases);
    const editEnabled = useStoreState((state) => state.storefront.data!.editing.enabled);

    const id = ServerContext.useStoreState((state) => state.server.data?.id);
    const uuid = ServerContext.useStoreState((state) => state.server.data?.uuid);
    const serverId = ServerContext.useStoreState((state) => state.server.data?.internalId);
    const getServer = ServerContext.useStoreActions((actions) => actions.server.getServer);
    const eggFeatures = ServerContext.useStoreState((state) => state.server.data?.eggFeatures);
    const inConflictState = ServerContext.useStoreState((state) => state.server.inConflictState);
    const clearServerState = ServerContext.useStoreActions((actions) => actions.clearServerState);

    useEffect(() => {
        clearServerState();
    }, []);

    useEffect(() => {
        setError('');

        getServer(match.params.id).catch((error) => {
            console.error(error);
            setError(httpErrorToHuman(error));
        });

        return () => {
            clearServerState();
        };
    }, [match.params.id]);

    return (
        <React.Fragment key={'server-router'}>
            {width >= 1280 ? <SidePanel /> : <MobileNavigation />}
            {!uuid || !id ? (
                error ? (
                    <ServerError message={error} />
                ) : (
                    <Spinner size={'large'} centered />
                )
            ) : (
                <>
                    <CSSTransition timeout={150} classNames={'fade'} appear in>
                        <SubNavigation className={'j-down'}>
                            <div>
                                <NavLink to={match.url} exact>
                                    <div css={tw`flex items-center justify-between`}>
                                        Console <Icon.Terminal css={tw`ml-1`} size={18} />
                                    </div>
                                </NavLink>
                                <NavLink to={`${match.url}/analytics`} exact>
                                    <div css={tw`flex items-center justify-between`}>
                                        Analytics <Icon.BarChart css={tw`ml-1`} size={18} />
                                    </div>
                                </NavLink>
                                <Can action={'activity.*'}>
                                    <NavLink to={`${match.url}/activity`}>
                                        <div css={tw`flex items-center justify-between`}>
                                            Activity <Icon.Eye css={tw`ml-1`} size={18} />
                                        </div>
                                    </NavLink>
                                </Can>
                                {eggFeatures?.includes('eula') && (
                                    <Can action={'plugin.*'}>
                                        <NavLink to={`${match.url}/plugins`}>
                                            <div css={tw`flex items-center justify-between`}>
                                                Plugins <Icon.Box css={tw`ml-1`} size={18} />
                                            </div>
                                        </NavLink>
                                    </Can>
                                )}
                                <Can action={'file.*'}>
                                    <NavLink to={`${match.url}/files`}>
                                        <div css={tw`flex items-center justify-between`}>
                                            Files <Icon.Folder css={tw`ml-1`} size={18} />
                                        </div>
                                    </NavLink>
                                </Can>
                                {databasesEnabled && (
                                    <Can action={'database.*'}>
                                        <NavLink to={`${match.url}/databases`}>
                                            <div css={tw`flex items-center justify-between`}>
                                                Databases <Icon.Database css={tw`ml-1`} size={18} />
                                            </div>
                                        </NavLink>
                                    </Can>
                                )}
                                <Can action={'schedule.*'}>
                                    <NavLink to={`${match.url}/schedules`}>
                                        <div css={tw`flex items-center justify-between`}>
                                            Tasks <Icon.Clock css={tw`ml-1`} size={18} />
                                        </div>
                                    </NavLink>
                                </Can>
                                <Can action={'user.*'}>
                                    <NavLink to={`${match.url}/users`}>
                                        <div css={tw`flex items-center justify-between`}>
                                            Users <Icon.Users css={tw`ml-1`} size={18} />
                                        </div>
                                    </NavLink>
                                </Can>
                                <Can action={'backup.*'}>
                                    <NavLink to={`${match.url}/backups`}>
                                        <div css={tw`flex items-center justify-between`}>
                                            Backups <Icon.Archive css={tw`ml-1`} size={18} />
                                        </div>
                                    </NavLink>
                                </Can>
                                <Can action={'allocation.*'}>
                                    <NavLink to={`${match.url}/network`}>
                                        <div css={tw`flex items-center justify-between`}>
                                            Network <Icon.Share2 css={tw`ml-1`} size={18} />
                                        </div>
                                    </NavLink>
                                </Can>
                                <Can action={'startup.*'}>
                                    <NavLink to={`${match.url}/startup`}>
                                        <div css={tw`flex items-center justify-between`}>
                                            Startup <Icon.Play css={tw`ml-1`} size={18} />
                                        </div>
                                    </NavLink>
                                </Can>
                                <Can action={['settings.*', 'file.sftp']} matchAny>
                                    <NavLink to={`${match.url}/settings`}>
                                        <div css={tw`flex items-center justify-between`}>
                                            Settings <Icon.Settings css={tw`ml-1`} size={18} />
                                        </div>
                                    </NavLink>
                                </Can>
                                {editEnabled && (
                                    <Can action={['settings.*']} matchAny>
                                        <NavLink to={`${match.url}/edit`}>
                                            <div css={tw`flex items-center justify-between`}>
                                                Edit <Icon.Edit css={tw`ml-1`} size={18} />
                                            </div>
                                        </NavLink>
                                    </Can>
                                )}
                                {rootAdmin && (
                                    <a href={'/admin/servers/view/' + serverId} rel='noreferrer' target={'_blank'}>
                                        <div css={tw`flex items-center justify-between`}>
                                            Admin <Icon.ExternalLink css={tw`ml-1`} size={18} />
                                        </div>
                                    </a>
                                )}
                            </div>
                        </SubNavigation>
                    </CSSTransition>
                    <InstallListener />
                    <TransferListener />
                    <WebsocketHandler />
                    {inConflictState && (!rootAdmin || (rootAdmin && !location.pathname.endsWith(`/server/${id}`))) ? (
                        <ConflictStateRenderer />
                    ) : (
                        <ErrorBoundary>
                            <TransitionRouter>
                                <Switch location={location}>
                                    <Route path={`${match.path}`} component={ServerConsoleContainer} exact />
                                    <Route path={`${match.path}/console`} component={ExternalConsole} exact />
                                    <Route path={`${match.path}/analytics`} component={AnalyticsContainer} exact />
                                    <Route path={`${match.path}/activity`} exact>
                                        <RequireServerPermission permissions={'activity.*'}>
                                            <ServerActivityLogContainer />
                                        </RequireServerPermission>
                                    </Route>
                                    {eggFeatures?.includes('eula') && (
                                        <Route path={`${match.path}/plugins`} exact>
                                            <RequireServerPermission permissions={'plugin.*'}>
                                                <PluginContainer />
                                            </RequireServerPermission>
                                        </Route>
                                    )}
                                    <Route path={`${match.path}/files`} exact>
                                        <RequireServerPermission permissions={'file.*'}>
                                            <FileManagerContainer />
                                        </RequireServerPermission>
                                    </Route>
                                    <Route path={`${match.path}/files/:action(edit|new)`} exact>
                                        <Spinner.Suspense>
                                            <FileEditContainer />
                                        </Spinner.Suspense>
                                    </Route>
                                    {databasesEnabled && (
                                        <Route path={`${match.path}/databases`} exact>
                                            <RequireServerPermission permissions={'database.*'}>
                                                <DatabasesContainer />
                                            </RequireServerPermission>
                                        </Route>
                                    )}
                                    <Route path={`${match.path}/schedules`} exact>
                                        <RequireServerPermission permissions={'schedule.*'}>
                                            <ScheduleContainer />
                                        </RequireServerPermission>
                                    </Route>
                                    <Route path={`${match.path}/schedules/:id`} exact>
                                        <ScheduleEditContainer />
                                    </Route>
                                    <Route path={`${match.path}/users`} exact>
                                        <RequireServerPermission permissions={'user.*'}>
                                            <UsersContainer />
                                        </RequireServerPermission>
                                    </Route>
                                    <Route path={`${match.path}/backups`} exact>
                                        <RequireServerPermission permissions={'backup.*'}>
                                            <BackupContainer />
                                        </RequireServerPermission>
                                    </Route>
                                    <Route path={`${match.path}/network`} exact>
                                        <RequireServerPermission permissions={'allocation.*'}>
                                            <NetworkContainer />
                                        </RequireServerPermission>
                                    </Route>
                                    <Route path={`${match.path}/startup`} component={StartupContainer} exact />
                                    <Route path={`${match.path}/settings`} component={SettingsContainer} exact />
                                    {editEnabled && (
                                        <Route path={`${match.path}/edit`} component={EditContainer} exact />
                                    )}
                                    <Route path={'*'} component={NotFound} />
                                </Switch>
                            </TransitionRouter>
                        </ErrorBoundary>
                    )}
                </>
            )}
        </React.Fragment>
    );
};
</file>

<file path="resources/scripts/routers/StoreRouter.tsx">
import React from 'react';
import * as Icon from 'react-feather';
import { useLocation } from 'react-router';
import TransitionRouter from '@/TransitionRouter';
import SidePanel from '@/components/elements/SidePanel';
import { NotFound } from '@/components/elements/ScreenBlock';
import useWindowDimensions from '@/plugins/useWindowDimensions';
import { NavLink, Route, Switch, useRouteMatch } from 'react-router-dom';
import CreateContainer from '@/components/store/CreateContainer';
import PurchaseContainer from '@/components/store/PurchaseContainer';
import OverviewContainer from '@/components/store/OverviewContainer';
import MobileNavigation from '@/components/elements/MobileNavigation';
import ResourcesContainer from '@/components/store/ResourcesContainer';
import SubNavigation from '@/components/elements/SubNavigation';

export default () => {
    const location = useLocation();
    const { width } = useWindowDimensions();
    const match = useRouteMatch<{ id: string }>();

    return (
        <>
            {width >= 1280 ? <SidePanel /> : <MobileNavigation />}
            <SubNavigation className={'j-down'}>
                <div>
                    <NavLink to={match.path} exact>
                        <div className={'flex items-center justify-between'}>
                            Store <Icon.ShoppingCart className={'ml-1'} size={18} />
                        </div>
                    </NavLink>
                    <NavLink to={`${match.path}/resources`}>
                        <div className={'flex items-center justify-between'}>
                            Resources <Icon.Cpu className={'ml-1'} size={18} />
                        </div>
                    </NavLink>
                    <NavLink to={`${match.path}/credits`}>
                        <div className={'flex items-center justify-between'}>
                            Balance <Icon.DollarSign className={'ml-1'} size={18} />
                        </div>
                    </NavLink>
                    <NavLink to={`${match.path}/create`}>
                        <div className={'flex items-center justify-between'}>
                            Create Server <Icon.Server className={'ml-1'} size={18} />
                        </div>
                    </NavLink>
                </div>
            </SubNavigation>
            <TransitionRouter>
                <Switch location={location}>
                    <Route path={`${match.path}`} exact>
                        <OverviewContainer />
                    </Route>
                    <Route path={`${match.path}/credits`} exact>
                        <PurchaseContainer />
                    </Route>
                    <Route path={`${match.path}/resources`} exact>
                        <ResourcesContainer />
                    </Route>
                    <Route path={`${match.path}/create`} exact>
                        <CreateContainer />
                    </Route>
                    <Route path={'*'}>
                        <NotFound />
                    </Route>
                </Switch>
            </TransitionRouter>
        </>
    );
};
</file>

<file path="resources/scripts/routers/TicketRouter.tsx">
import React from 'react';
import { useLocation } from 'react-router';
import TransitionRouter from '@/TransitionRouter';
import SidePanel from '@/components/elements/SidePanel';
import { NotFound } from '@/components/elements/ScreenBlock';
import ViewContainer from '@/components/tickets/ViewContainer';
import useWindowDimensions from '@/plugins/useWindowDimensions';
import { Route, Switch, useRouteMatch } from 'react-router-dom';
import MobileNavigation from '@/components/elements/MobileNavigation';
import OverviewContainer from '@/components/tickets/OverviewContainer';

export default () => {
    const location = useLocation();
    const { width } = useWindowDimensions();
    const match = useRouteMatch<{ id: string }>();

    return (
        <>
            {width >= 1280 ? <SidePanel /> : <MobileNavigation />}
            <TransitionRouter>
                <Switch location={location}>
                    <Route path={match.path} exact>
                        <OverviewContainer />
                    </Route>
                    <Route path={`${match.path}/:id`} exact>
                        <ViewContainer />
                    </Route>
                    <Route path={'*'}>
                        <NotFound />
                    </Route>
                </Switch>
            </TransitionRouter>
        </>
    );
};
</file>

<file path="resources/scripts/state/server/databases.ts">
import { action, Action } from 'easy-peasy';
import { ServerDatabase } from '@/api/server/databases/getServerDatabases';

export interface ServerDatabaseStore {
    data: ServerDatabase[];
    setDatabases: Action<ServerDatabaseStore, ServerDatabase[]>;
    appendDatabase: Action<ServerDatabaseStore, ServerDatabase>;
    removeDatabase: Action<ServerDatabaseStore, string>;
}

const databases: ServerDatabaseStore = {
    data: [],

    setDatabases: action((state, payload) => {
        state.data = payload;
    }),

    appendDatabase: action((state, payload) => {
        if (state.data.find((database) => database.id === payload.id)) {
            state.data = state.data.map((database) => (database.id === payload.id ? payload : database));
        } else {
            state.data = [...state.data, payload];
        }
    }),

    removeDatabase: action((state, payload) => {
        state.data = [...state.data.filter((database) => database.id !== payload)];
    }),
};

export default databases;
</file>

<file path="resources/scripts/state/server/files.ts">
import { action, Action } from 'easy-peasy';
import { cleanDirectoryPath } from '@/helpers';

export interface FileUploadData {
    loaded: number;
    readonly abort: AbortController;
    readonly total: number;
}

export interface ServerFileStore {
    directory: string;
    selectedFiles: string[];
    uploads: Record<string, FileUploadData>;

    setDirectory: Action<ServerFileStore, string>;
    setSelectedFiles: Action<ServerFileStore, string[]>;
    appendSelectedFile: Action<ServerFileStore, string>;
    removeSelectedFile: Action<ServerFileStore, string>;

    pushFileUpload: Action<ServerFileStore, { name: string; data: FileUploadData }>;
    setUploadProgress: Action<ServerFileStore, { name: string; loaded: number }>;
    clearFileUploads: Action<ServerFileStore>;
    removeFileUpload: Action<ServerFileStore, string>;
    cancelFileUpload: Action<ServerFileStore, string>;
}

const files: ServerFileStore = {
    directory: '/',
    selectedFiles: [],
    uploads: {},

    setDirectory: action((state, payload) => {
        state.directory = cleanDirectoryPath(payload);
    }),
    setSelectedFiles: action((state, payload) => {
        state.selectedFiles = payload;
    }),
    appendSelectedFile: action((state, payload) => {
        state.selectedFiles = state.selectedFiles.filter((f) => f !== payload).concat(payload);
    }),
    removeSelectedFile: action((state, payload) => {
        state.selectedFiles = state.selectedFiles.filter((f) => f !== payload);
    }),

    clearFileUploads: action((state) => {
        Object.values(state.uploads).forEach((upload) => upload.abort.abort());

        state.uploads = {};
    }),

    pushFileUpload: action((state, payload) => {
        state.uploads[payload.name] = payload.data;
    }),

    setUploadProgress: action((state, { name, loaded }) => {
        if (state.uploads[name]) {
            state.uploads[name].loaded = loaded;
        }
    }),

    removeFileUpload: action((state, payload) => {
        if (state.uploads[payload]) {
            delete state.uploads[payload];
        }
    }),

    cancelFileUpload: action((state, payload) => {
        if (state.uploads[payload]) {
            // Abort the request if it is still in flight. If it already completed this is
            // a no-op.
            state.uploads[payload].abort.abort();

            delete state.uploads[payload];
        }
    }),
};

export default files;
</file>

<file path="resources/scripts/state/server/index.ts">
import isEqual from 'react-fast-compare';
import socket, { SocketStore } from './socket';
import getServer, { Server } from '@/api/server/getServer';
import files, { ServerFileStore } from '@/state/server/files';
import { composeWithDevTools } from 'redux-devtools-extension';
import subusers, { ServerSubuserStore } from '@/state/server/subusers';
import schedules, { ServerScheduleStore } from '@/state/server/schedules';
import databases, { ServerDatabaseStore } from '@/state/server/databases';
import { action, Action, computed, Computed, createContextStore, thunk, Thunk } from 'easy-peasy';

export type ServerStatus = 'offline' | 'starting' | 'stopping' | 'running' | null;

interface ServerDataStore {
    data?: Server;
    inConflictState: Computed<ServerDataStore, boolean>;
    isInstalling: Computed<ServerDataStore, boolean>;
    permissions: string[];

    getServer: Thunk<ServerDataStore, string, Record<string, unknown>, ServerStore, Promise<void>>;
    setServer: Action<ServerDataStore, Server>;
    setServerFromState: Action<ServerDataStore, (s: Server) => Server>;
    setPermissions: Action<ServerDataStore, string[]>;
}

const server: ServerDataStore = {
    permissions: [],

    inConflictState: computed((state) => {
        if (!state.data) {
            return false;
        }

        return state.data.status !== null || state.data.isTransferring || state.data.isNodeUnderMaintenance;
    }),

    isInstalling: computed((state) => {
        return state.data?.status === 'installing' || state.data?.status === 'install_failed';
    }),

    getServer: thunk(async (actions, payload) => {
        const [server, permissions] = await getServer(payload);

        actions.setServer(server);
        actions.setPermissions(permissions);
    }),

    setServer: action((state, payload) => {
        if (!isEqual(payload, state.data)) {
            state.data = payload;
        }
    }),

    setServerFromState: action((state, payload) => {
        const output = payload(state.data!);
        if (!isEqual(output, state.data)) {
            state.data = output;
        }
    }),

    setPermissions: action((state, payload) => {
        if (!isEqual(payload, state.permissions)) {
            state.permissions = payload;
        }
    }),
};

interface ServerStatusStore {
    value: ServerStatus;
    setServerStatus: Action<ServerStatusStore, ServerStatus>;
}

const status: ServerStatusStore = {
    value: null,
    setServerStatus: action((state, payload) => {
        state.value = payload;
    }),
};

export interface ServerStore {
    server: ServerDataStore;
    subusers: ServerSubuserStore;
    databases: ServerDatabaseStore;
    files: ServerFileStore;
    schedules: ServerScheduleStore;
    socket: SocketStore;
    status: ServerStatusStore;
    clearServerState: Action<ServerStore>;
}

export const ServerContext = createContextStore<ServerStore>(
    {
        server,
        socket,
        status,
        databases,
        files,
        subusers,
        schedules,
        clearServerState: action((state) => {
            state.server.data = undefined;
            state.server.permissions = [];
            state.databases.data = [];
            state.subusers.data = [];
            state.files.directory = '/';
            state.files.selectedFiles = [];
            state.schedules.data = [];

            if (state.socket.instance) {
                state.socket.instance.removeAllListeners();
                state.socket.instance.close();
            }

            state.socket.instance = null;
            state.socket.connected = false;
        }),
    },
    {
        compose: composeWithDevTools({
            name: 'ServerStore',
            trace: true,
        }),
    }
);
</file>

<file path="resources/scripts/state/server/schedules.ts">
import { action, Action } from 'easy-peasy';
import { Schedule } from '@/api/server/schedules/getServerSchedules';

export interface ServerScheduleStore {
    data: Schedule[];
    setSchedules: Action<ServerScheduleStore, Schedule[]>;
    appendSchedule: Action<ServerScheduleStore, Schedule>;
    removeSchedule: Action<ServerScheduleStore, number>;
}

const schedules: ServerScheduleStore = {
    data: [],

    setSchedules: action((state, payload) => {
        state.data = payload;
    }),

    appendSchedule: action((state, payload) => {
        if (state.data.find((schedule) => schedule.id === payload.id)) {
            state.data = state.data.map((schedule) => (schedule.id === payload.id ? payload : schedule));
        } else {
            state.data = [...state.data, payload];
        }
    }),

    removeSchedule: action((state, payload) => {
        state.data = [...state.data.filter((schedule) => schedule.id !== payload)];
    }),
};

export default schedules;
</file>

<file path="resources/scripts/state/server/socket.ts">
import { Action, action } from 'easy-peasy';
import { Websocket } from '@/plugins/Websocket';

export interface SocketStore {
    instance: Websocket | null;
    connected: boolean;
    setInstance: Action<SocketStore, Websocket | null>;
    setConnectionState: Action<SocketStore, boolean>;
}

const socket: SocketStore = {
    instance: null,
    connected: false,
    setInstance: action((state, payload) => {
        state.instance = payload;
    }),
    setConnectionState: action((state, payload) => {
        state.connected = payload;
    }),
};

export default socket;
</file>

<file path="resources/scripts/state/server/subusers.ts">
import { action, Action } from 'easy-peasy';

export type SubuserPermission =
    | 'websocket.connect'
    | 'control.console'
    | 'control.start'
    | 'control.stop'
    | 'control.restart'
    | 'user.create'
    | 'user.read'
    | 'user.update'
    | 'user.delete'
    | 'file.create'
    | 'file.read'
    | 'file.update'
    | 'file.delete'
    | 'file.archive'
    | 'file.sftp'
    | 'allocation.read'
    | 'allocation.update'
    | 'startup.read'
    | 'startup.update'
    | 'database.create'
    | 'database.read'
    | 'database.update'
    | 'database.delete'
    | 'database.view_password'
    | 'schedule.create'
    | 'schedule.read'
    | 'schedule.update'
    | 'schedule.delete';

export interface Subuser {
    uuid: string;
    username: string;
    email: string;
    image: string;
    twoFactorEnabled: boolean;
    createdAt: Date;
    permissions: SubuserPermission[];

    can(permission: SubuserPermission): boolean;
}

export interface ServerSubuserStore {
    data: Subuser[];
    setSubusers: Action<ServerSubuserStore, Subuser[]>;
    appendSubuser: Action<ServerSubuserStore, Subuser>;
    removeSubuser: Action<ServerSubuserStore, string>;
}

const subusers: ServerSubuserStore = {
    data: [],

    setSubusers: action((state, payload) => {
        state.data = payload;
    }),

    appendSubuser: action((state, payload) => {
        let matched = false;
        state.data = [
            ...state.data
                .map((user) => {
                    if (user.uuid === payload.uuid) {
                        matched = true;

                        return payload;
                    }

                    return user;
                })
                .concat(matched ? [] : [payload]),
        ];
    }),

    removeSubuser: action((state, payload) => {
        state.data = [...state.data.filter((user) => user.uuid !== payload)];
    }),
};

export default subusers;
</file>

<file path="resources/scripts/state/flashes.ts">
import { Action, action } from 'easy-peasy';
import { httpErrorToHuman } from '@/api/http';
import { FlashMessageType } from '@/components/MessageBox';

export interface FlashStore {
    items: FlashMessage[];
    addFlash: Action<FlashStore, FlashMessage>;
    addError: Action<FlashStore, { message: string; key?: string }>;
    clearAndAddHttpError: Action<FlashStore, { error?: Error | any | null; key?: string }>;
    clearFlashes: Action<FlashStore, string | void>;
}

export interface FlashMessage {
    id?: string;
    key?: string;
    type: FlashMessageType;
    title?: string;
    message: string;
}

const flashes: FlashStore = {
    items: [],

    addFlash: action((state, payload) => {
        state.items.push(payload);
    }),

    addError: action((state, payload) => {
        state.items.push({ type: 'danger', title: 'Error', ...payload });
    }),

    clearAndAddHttpError: action((state, payload) => {
        if (!payload.error) {
            state.items = [];
        } else {
            console.error(payload.error);

            state.items = [
                {
                    type: 'danger',
                    title: 'Error',
                    key: payload.key,
                    message: httpErrorToHuman(payload.error),
                },
            ];
        }
    }),

    clearFlashes: action((state, payload) => {
        state.items = payload ? state.items.filter((flashes) => flashes.key !== payload) : [];
    }),
};

export default flashes;
</file>

<file path="resources/scripts/state/hooks.ts">
import { createTypedHooks } from 'easy-peasy';
import { ApplicationStore } from '@/state/index';

const hooks = createTypedHooks<ApplicationStore>();

export const useStore = hooks.useStore;
export const useStoreState = hooks.useStoreState;
export const useStoreActions = hooks.useStoreActions;
export const useStoreDispatch = hooks.useStoreDispatch;
</file>

<file path="resources/scripts/state/index.ts">
import { createStore } from 'easy-peasy';
import user, { UserStore } from '@/state/user';
import flashes, { FlashStore } from '@/state/flashes';
import settings, { SettingsStore } from '@/state/settings';
import progress, { ProgressStore } from '@/state/progress';
import permissions, { GloablPermissionsStore } from '@/state/permissions';
import storefront, { StorefrontStore } from '@/state/storefront';

export interface ApplicationStore {
    permissions: GloablPermissionsStore;
    flashes: FlashStore;
    user: UserStore;
    settings: SettingsStore;
    progress: ProgressStore;
    storefront: StorefrontStore;
}

const state: ApplicationStore = {
    permissions,
    flashes,
    user,
    settings,
    progress,
    storefront,
};

export const store = createStore(state);
</file>

<file path="resources/scripts/state/permissions.ts">
import { action, Action, thunk, Thunk } from 'easy-peasy';
import getSystemPermissions from '@/api/getSystemPermissions';

export interface PanelPermissions {
    [key: string]: {
        description: string;
        keys: { [k: string]: string };
    };
}

export interface GloablPermissionsStore {
    data: PanelPermissions;
    setPermissions: Action<GloablPermissionsStore, PanelPermissions>;
    getPermissions: Thunk<GloablPermissionsStore, void, Record<string, unknown>, any, Promise<void>>;
}

const permissions: GloablPermissionsStore = {
    data: {},

    setPermissions: action((state, payload) => {
        state.data = payload;
    }),

    getPermissions: thunk(async (actions) => {
        const permissions = await getSystemPermissions();

        actions.setPermissions(permissions);
    }),
};

export default permissions;
</file>

<file path="resources/scripts/state/progress.ts">
import { action, Action } from 'easy-peasy';

export interface ProgressStore {
    continuous: boolean;
    progress?: number;

    startContinuous: Action<ProgressStore>;
    setProgress: Action<ProgressStore, number | undefined>;
    setComplete: Action<ProgressStore>;
}

const progress: ProgressStore = {
    continuous: false,
    progress: undefined,

    startContinuous: action((state) => {
        state.continuous = true;
    }),

    setProgress: action((state, payload) => {
        state.progress = payload;
    }),

    setComplete: action((state) => {
        if (state.progress) {
            state.progress = 100;
        }

        state.continuous = false;
    }),
};

export default progress;
</file>

<file path="resources/scripts/state/settings.ts">
import { action, Action } from 'easy-peasy';

export interface SiteSettings {
    name: string;
    logo: string;
    locale: string;

    approvals: boolean;
    tickets: boolean;
    coupons: boolean;
    databases: boolean;

    alert: {
        type: 'success' | 'info' | 'warning' | 'danger';
        message: string;
    };

    recaptcha: {
        enabled: boolean;
        siteKey: string;
    };

    registration: {
        email: boolean;
        discord: boolean;
    };
}

export interface SettingsStore {
    data?: SiteSettings;
    setSettings: Action<SettingsStore, SiteSettings>;
}

const settings: SettingsStore = {
    data: undefined,

    setSettings: action((state, payload) => {
        state.data = payload;
    }),
};

export default settings;
</file>

<file path="resources/scripts/state/storefront.ts">
import { action, Action } from 'easy-peasy';

export interface StorefrontSettings {
    enabled: boolean;
    currency: string;
    renewals: {
        cost: number;
        days: number;
    };
    editing: {
        enabled: boolean;
    };
    deletion: {
        enabled: boolean;
    };
    referrals: {
        enabled: boolean;
        reward: number;
        days: number;
    };
    cost: {
        cpu: number;
        memory: number;
        disk: number;
        slot: number;
        port: number;
        backup: number;
        database: number;
    };
    gateways: {
        paypal: boolean;
        stripe: boolean;
    };
    earn: {
        enabled: boolean;
        amount: number;
    };
}

export interface StorefrontStore {
    data?: StorefrontSettings;
    setStorefront: Action<StorefrontStore, StorefrontSettings>;
}

const storefront: StorefrontStore = {
    data: undefined,

    setStorefront: action((state, payload) => {
        state.data = payload;
    }),
};

export default storefront;
</file>

<file path="resources/scripts/state/user.ts">
import { Action, action, Thunk, thunk } from 'easy-peasy';
import updateAccountEmail from '@/api/account/updateAccountEmail';

export interface UserData {
    uuid: string;
    username: string;
    email: string;
    approved: boolean;
    verified: boolean;
    discordId: string;
    language: string;
    rootAdmin: boolean;
    useTotp: boolean;
    referralCode: string;
    createdAt: Date;
    updatedAt: Date;
}

export interface UserStore {
    data?: UserData;
    setUserData: Action<UserStore, UserData>;
    updateUserData: Action<UserStore, Partial<UserData>>;
    updateUserEmail: Thunk<UserStore, { email: string; password: string }, any, UserStore, Promise<void>>;
}

const user: UserStore = {
    data: undefined,
    setUserData: action((state, payload) => {
        state.data = payload;
    }),

    updateUserData: action((state, payload) => {
        // @ts-expect-error limitation of Typescript, can't do much about that currently unfortunately.
        state.data = { ...state.data, ...payload };
    }),

    updateUserEmail: thunk(async (actions, payload) => {
        await updateAccountEmail(payload.email, payload.password);

        actions.updateUserData({ email: payload.email });
    }),
};

export default user;
</file>

<file path="resources/scripts/easy-peasy.d.ts">
// noinspection ES6UnusedImports
import { ApplicationStore } from '@/state';
// eslint-disable-next-line @typescript-eslint/no-unused-vars
import EasyPeasy, { Actions, State } from 'easy-peasy';

declare module 'easy-peasy' {
    export function useStoreState<Result>(mapState: (state: State<ApplicationStore>) => Result): Result;

    export function useStoreActions<Result>(mapActions: (actions: Actions<ApplicationStore>) => Result): Result;
}
</file>

<file path="resources/scripts/globals.d.ts">
declare module '*.jpg';
declare module '*.png';
declare module '*.svg';
declare module '*.css';
</file>

<file path="resources/scripts/helpers.ts">
export const randomInt = (low: number, high: number) => Math.floor(Math.random() * (high - low) + low);

export const megabytesToBytes = (mb: number) => Math.floor(mb * 1024 * 1024);

export function bytesToHuman(bytes: number): string {
    if (bytes === 0) {
        return '0 kB';
    }

    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return `${Number((bytes / Math.pow(1024, i)).toFixed(2))} ${['Bytes', 'kB', 'MB', 'GB', 'TB'][i]}`;
}

export function megabytesToHuman(mb: number): string {
    return bytesToHuman(megabytesToBytes(mb));
}

export const cleanDirectoryPath = (path: string) => path.replace(/(\/(\/*))|(^$)/g, '/');

export function fileBitsToString(mode: string, directory: boolean): string {
    const m = parseInt(mode, 8);

    let buf = '';
    'dalTLDpSugct?'.split('').forEach((c, i) => {
        if ((m & (1 << (32 - 1 - i))) !== 0) {
            buf = buf + c;
        }
    });

    if (buf.length === 0) {
        // If the file is directory, make sure it has the directory flag.
        if (directory) {
            buf = 'd';
        } else {
            buf = '-';
        }
    }

    'rwxrwxrwx'.split('').forEach((c, i) => {
        if ((m & (1 << (9 - 1 - i))) !== 0) {
            buf = buf + c;
        } else {
            buf = buf + '-';
        }
    });

    return buf;
}

/**
 * URL-encodes the segments of a path.
 * This allows to use the path as part of a URL while preserving the slashes.
 * @param path the path to encode
 */
export function encodePathSegments(path: string): string {
    return path
        .split('/')
        .map((s) => encodeURIComponent(s))
        .join('/');
}

export function hashToPath(hash: string): string {
    return hash.length > 0 ? decodeURIComponent(hash.substr(1)) : '/';
}
</file>

<file path="resources/scripts/i18n.ts">
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import I18NextHttpBackend, { BackendOptions } from 'i18next-http-backend';
import I18NextMultiloadBackendAdapter from 'i18next-multiload-backend-adapter';

// If we're using HMR use a unique hash per page reload so that we're always
// doing cache busting. Otherwise just use the builder provided hash value in
// the URL to allow cache busting to occur whenever the front-end is rebuilt.
const hash = module.hot ? Date.now().toString(16) : process.env.WEBPACK_BUILD_HASH;

i18n.use(I18NextMultiloadBackendAdapter)
    .use(initReactI18next)
    .init({
        debug: process.env.DEBUG === 'true',
        lng: 'en',
        fallbackLng: 'en',
        keySeparator: '.',
        backend: {
            backend: I18NextHttpBackend,
            backendOption: {
                loadPath: '/locales/locale.json?locale={{lng}}&namespace={{ns}}',
                queryStringParams: { hash },
                allowMultiLoading: true,
            } as BackendOptions,
        } as Record<string, any>,
        interpolation: {
            // Per i18n-react documentation: this is not needed since React is already
            // handling escapes for us.
            escapeValue: false,
        },
    });

export default i18n;
</file>

<file path="resources/scripts/index.tsx">
import './i18n';
import React from 'react';
import ReactDOM from 'react-dom';
import App from '@/components/App';
import { setConfig } from 'react-hot-loader';

// Prevents page reloads while making component changes which
// also avoids triggering constant loading indicators all over
// the place in development.
//
// @see https://github.com/gaearon/react-hot-loader#hook-support
setConfig({ reloadHooks: false });

ReactDOM.render(<App />, document.getElementById('app'));
</file>

<file path="resources/scripts/macros.d.ts">
import { ComponentType, ReactElement } from 'react';
// eslint-disable-next-line no-restricted-imports
import styledImport, { css as cssImport, CSSProp, StyledComponentProps } from 'styled-components';

declare module 'react' {
    interface Attributes {
        css?: CSSProp;
    }
}

declare module 'styled-components' {
    interface StyledComponentBase<
        C extends string | ComponentType<any>,
        // eslint-disable-next-line @typescript-eslint/ban-types
        T extends object,
        // eslint-disable-next-line @typescript-eslint/ban-types
        O extends object = {},
        A extends keyof any = never
    > extends ForwardRefExoticBase<StyledComponentProps<C, T, O, A>> {
        (
            props: StyledComponentProps<C, T, O, A> & { as?: Element | string; forwardedAs?: never | undefined }
        ): ReactElement<StyledComponentProps<C, T, O, A>>;
    }
}

declare module 'twin.macro' {
    const css: typeof cssImport;
    const styled: typeof styledImport;
}
</file>

<file path="resources/scripts/modes.ts">
export interface Mode {
    name: string;
    mime: string;
    mimes?: string[];
    mode: string;
    ext?: string[];
    alias?: string[];
    file?: RegExp;
}

const modes: Mode[] = [
    { name: 'C', mime: 'text/x-csrc', mode: 'clike', ext: ['c', 'h', 'ino'] },
    {
        name: 'C++',
        mime: 'text/x-c++src',
        mode: 'clike',
        ext: ['cpp', 'c++', 'cc', 'cxx', 'hpp', 'h++', 'hh', 'hxx'],
        alias: ['cpp'],
    },
    { name: 'C#', mime: 'text/x-csharp', mode: 'clike', ext: ['cs'], alias: ['csharp', 'cs'] },
    { name: 'CSS', mime: 'text/css', mode: 'css', ext: ['css'] },
    { name: 'CQL', mime: 'text/x-cassandra', mode: 'sql', ext: ['cql'] },
    { name: 'Diff', mime: 'text/x-diff', mode: 'diff', ext: ['diff', 'patch'] },
    { name: 'Dockerfile', mime: 'text/x-dockerfile', mode: 'dockerfile', file: /^Dockerfile$/ },
    { name: 'Git Markdown', mime: 'text/x-gfm', mode: 'gfm', file: /^(readme|contributing|history|license).md$/i },
    { name: 'Golang', mime: 'text/x-go', mode: 'go', ext: ['go'] },
    { name: 'HTML', mime: 'text/html', mode: 'htmlmixed', ext: ['html', 'htm', 'handlebars', 'hbs'], alias: ['xhtml'] },
    { name: 'HTTP', mime: 'message/http', mode: 'http' },
    {
        name: 'JavaScript',
        mime: 'text/javascript',
        mimes: [
            'text/javascript',
            'text/ecmascript',
            'application/javascript',
            'application/x-javascript',
            'application/ecmascript',
        ],
        mode: 'javascript',
        ext: ['js'],
        alias: ['ecmascript', 'js', 'node'],
    },
    {
        name: 'JSON',
        mime: 'application/json',
        mimes: ['application/json', 'application/x-json'],
        mode: 'javascript',
        ext: ['json', 'map'],
        alias: ['json5'],
    },
    { name: 'Lua', mime: 'text/x-lua', mode: 'lua', ext: ['lua'] },
    { name: 'Markdown', mime: 'text/x-markdown', mode: 'markdown', ext: ['markdown', 'md', 'mkd'] },
    { name: 'MariaDB', mime: 'text/x-mariadb', mode: 'sql' },
    { name: 'MS SQL', mime: 'text/x-mssql', mode: 'sql' },
    { name: 'MySQL', mime: 'text/x-mysql', mode: 'sql' },
    { name: 'Nginx', mime: 'text/x-nginx-conf', mode: 'nginx', file: /nginx.*\.conf$/i },
    {
        name: 'PHP',
        mime: 'text/x-php',
        mimes: ['text/x-php', 'application/x-httpd-php', 'application/x-httpd-php-open'],
        mode: 'php',
        ext: ['php', 'php3', 'php4', 'php5', 'php7', 'phtml'],
    },
    { name: 'Plain Text', mime: 'text/plain', mode: 'null', ext: ['txt', 'text', 'conf', 'def', 'list', 'log'] },
    { name: 'PostgreSQL', mime: 'text/x-pgsql', mode: 'sql' },
    {
        name: 'Properties',
        mime: 'text/x-properties',
        mode: 'properties',
        ext: ['properties', 'ini', 'in'],
        alias: ['ini', 'properties'],
    },
    { name: 'Pug', mime: 'text/x-pug', mimes: ['text/x-pug', 'text/x-jade'], mode: 'null', ext: ['pug'] },
    {
        name: 'Python',
        mime: 'text/x-python',
        mode: 'python',
        ext: ['BUILD', 'bzl', 'py', 'pyw'],
        file: /^(BUCK|BUILD)$/,
    },
    { name: 'Ruby', mime: 'text/x-ruby', mode: 'ruby', ext: ['rb'], alias: ['jruby', 'macruby', 'rake', 'rb', 'rbx'] },
    { name: 'Rust', mime: 'text/x-rustsrc', mode: 'rust', ext: ['rs'] },
    { name: 'Sass', mime: 'text/x-sass', mode: 'sass', ext: ['sass'] },
    { name: 'SCSS', mime: 'text/x-scss', mode: 'css', ext: ['scss'] },
    {
        name: 'Shell',
        mime: 'text/x-sh',
        mimes: ['text/x-sh', 'application/x-sh'],
        mode: 'shell',
        ext: ['sh', 'ksh', 'bash'],
        alias: ['bash', 'sh', 'zsh'],
        file: /^PKGBUILD$/,
    },
    { name: 'SQL', mime: 'text/x-sql', mode: 'sql', ext: ['sql'] },
    { name: 'SQLite', mime: 'text/x-sqlite', mode: 'sql' },
    { name: 'TOML', mime: 'text/x-toml', mode: 'toml', ext: ['toml'] },
    { name: 'TypeScript', mime: 'application/typescript', mode: 'javascript', ext: ['ts'], alias: ['ts'] },
    { name: 'Vue', mime: 'script/x-vue', mimes: ['script/x-vue', 'text/x-vue'], mode: 'vue', ext: ['vue'] },
    {
        name: 'XML',
        mime: 'application/xml',
        mimes: ['application/xml', 'text/xml'],
        mode: 'xml',
        ext: ['xml', 'xsl', 'xsd', 'svg'],
        alias: ['rss', 'wsdl', 'xsd'],
    },
    {
        name: 'YAML',
        mime: 'text/x-yaml',
        mimes: ['text/x-yaml', 'text/yaml'],
        mode: 'yaml',
        ext: ['yaml', 'yml'],
        alias: ['yml'],
    },
];

export default modes;
</file>

<file path="resources/scripts/scan-server.js">
const fs = require('fs');
const path = require('path');

// Import the FileScanner class (you'll need to export it from FileScanner.ts)
// For now, we'll load it as a module

const serverId = process.argv[2];
const serverPath = process.argv[3];

if (!serverId || !serverPath) {
    console.error('Usage: node scan-server.js <serverId> <serverPath>');
    process.exit(1);
}

// Configuration from environment variables
const config = {
    webhookUrl: process.env.DISCORD_WEBHOOK,
    jexactylUrl: process.env.JEXACTYL_URL,
    jexactylApiToken: process.env.JEXACTYL_API_TOKEN,
};

// Suspicious packages for JavaScript/Node.js
const SUSPICIOUS_NPM_PACKAGES = {
    critical: [
        'discord.js-selfbot-v13',
        'discord-selfbot',
        'selfbot',
        'token-logger',
        'discord-token-logger',
        'malicious-discord',
    ],
    high: ['discord.py-self', 'discordselfbot', 'nuker-bot', 'token-stealer', 'keylogger', 'password-stealer'],
};

// Suspicious packages for Python
const SUSPICIOUS_PY_PACKAGES = {
    critical: ['discord-selfbot', 'discord.py-self', 'selfbotpy'],
    high: ['discord-nuker', 'token-grabber', 'keylogger', 'clipper', 'rat', 'stealers'],
};

// Suspicious patterns in code
const SUSPICIOUS_PATTERNS = [
    /token.*=|=.*token/i,
    /password.*logger|log.*password/i,
    /steal.*token|token.*steal/i,
    /discord.*token|token.*discord/i,
    /webhook.*logger|logger.*webhook/i,
    /exfiltrate|exfil/i,
    /keylog/i,
    /clipper/i,
    /process.*inject|inject.*process/i,
];

function findFiles(dir, pattern) {
    const results = [];

    function walk(currentDir) {
        try {
            const files = fs.readdirSync(currentDir);
            for (const file of files) {
                if (['node_modules', '.git', '.env', 'venv', '__pycache__', '.venv'].includes(file)) {
                    continue;
                }

                const fullPath = path.join(currentDir, file);
                const stat = fs.statSync(fullPath);

                if (stat.isDirectory()) {
                    walk(fullPath);
                } else {
                    const matches = typeof pattern === 'string' ? file === pattern : pattern.test(file);
                    if (matches) {
                        results.push(fullPath);
                    }
                }
            }
        } catch (error) {
            // Skip directories we can't read
        }
    }

    walk(dir);
    return results;
}

function scanPackageJson(filePath) {
    const violations = [];

    try {
        const content = fs.readFileSync(filePath, 'utf-8');
        const json = JSON.parse(content);

        const dependencies = {
            ...json.dependencies,
            ...json.devDependencies,
            ...json.optionalDependencies,
        };

        for (const [pkg, version] of Object.entries(dependencies || {})) {
            const pkgLower = pkg.toLowerCase();

            for (const [severity, packages] of Object.entries(SUSPICIOUS_NPM_PACKAGES)) {
                if (packages.some((p) => pkgLower.includes(p.toLowerCase()))) {
                    violations.push({
                        type: 'suspicious_package',
                        file: filePath,
                        severity: severity,
                        description: `Suspicious npm package detected: ${pkg}`,
                        matches: [pkg],
                    });
                }
            }
        }
    } catch (error) {
        // Invalid JSON or file read error
    }

    return violations;
}

function scanRequirementsTxt(filePath) {
    const violations = [];

    try {
        const content = fs.readFileSync(filePath, 'utf-8');
        const lines = content.split('\n');

        for (const line of lines) {
            const pkg = line.split('==')[0].split('>=')[0].split('<=')[0].trim();
            if (!pkg) continue;

            const pkgLower = pkg.toLowerCase();

            for (const [severity, packages] of Object.entries(SUSPICIOUS_PY_PACKAGES)) {
                if (packages.some((p) => pkgLower.includes(p.toLowerCase()))) {
                    violations.push({
                        type: 'suspicious_python_package',
                        file: filePath,
                        severity: severity,
                        description: `Suspicious Python package detected: ${pkg}`,
                        matches: [pkg],
                    });
                }
            }
        }
    } catch (error) {
        // File read error
    }

    return violations;
}

function scanSetupPy(filePath) {
    const violations = [];

    try {
        const content = fs.readFileSync(filePath, 'utf-8');
        const packageMatches = content.match(/['"]([\w\-]+)['"]/g) || [];

        for (const match of packageMatches) {
            const pkg = match.replace(/['"]/g, '').toLowerCase();

            for (const [severity, packages] of Object.entries(SUSPICIOUS_PY_PACKAGES)) {
                if (packages.some((p) => pkg.includes(p.toLowerCase()))) {
                    violations.push({
                        type: 'suspicious_python_package',
                        file: filePath,
                        severity: severity,
                        description: `Suspicious Python package in setup.py: ${pkg}`,
                        matches: [pkg],
                    });
                }
            }
        }
    } catch (error) {
        // File read error
    }

    return violations;
}

function scanPythonFile(filePath) {
    const violations = [];

    try {
        const content = fs.readFileSync(filePath, 'utf-8');
        const matches = [];

        for (const pattern of SUSPICIOUS_PATTERNS) {
            if (pattern.test(content)) {
                const match = content.match(pattern);
                if (match) {
                    matches.push(match[0]);
                }
            }
        }

        if (matches.length > 2) {
            violations.push({
                type: 'suspicious_code_pattern',
                file: filePath,
                severity: 'high',
                description: 'Multiple suspicious patterns detected in Python file',
                matches,
            });
        }
    } catch (error) {
        // File read error
    }

    return violations;
}

function scanJavaScriptFile(filePath) {
    const violations = [];

    try {
        const content = fs.readFileSync(filePath, 'utf-8');
        const matches = [];

        for (const pattern of SUSPICIOUS_PATTERNS) {
            if (pattern.test(content)) {
                const match = content.match(pattern);
                if (match) {
                    matches.push(match[0]);
                }
            }
        }

        const discordPatterns = [
            /client\.token|token.*client/i,
            /user\.token|token.*user/i,
            /message\.author\.token|token.*author/i,
        ];

        for (const pattern of discordPatterns) {
            if (pattern.test(content)) {
                matches.push('Discord token access detected');
            }
        }

        if (matches.length > 1) {
            violations.push({
                type: 'suspicious_code_pattern',
                file: filePath,
                severity: 'high',
                description: 'Multiple suspicious patterns detected in JavaScript file',
                matches,
            });
        }
    } catch (error) {
        // File read error
    }

    return violations;
}

function generateSummary(violations) {
    if (violations.length === 0) {
        return 'No suspicious files detected';
    }

    const bySeverity = {
        critical: violations.filter((v) => v.severity === 'critical').length,
        high: violations.filter((v) => v.severity === 'high').length,
        medium: violations.filter((v) => v.severity === 'medium').length,
        low: violations.filter((v) => v.severity === 'low').length,
    };

    const parts = [];
    if (bySeverity.critical > 0) parts.push(`${bySeverity.critical} critical`);
    if (bySeverity.high > 0) parts.push(`${bySeverity.high} high`);
    if (bySeverity.medium > 0) parts.push(`${bySeverity.medium} medium`);
    if (bySeverity.low > 0) parts.push(`${bySeverity.low} low`);

    return `${violations.length} violations detected: ${parts.join(', ')}`;
}

async function suspendServer(reason) {
    try {
        const response = await fetch(`${config.jexactylUrl}/api/client/servers/${serverId}/suspend`, {
            method: 'POST',
            headers: {
                Authorization: `Bearer ${config.jexactylApiToken}`,
                'Content-Type': 'application/json',
            },
        });

        if (response.ok) {
            console.error(`Server ${serverId} suspended due to malicious content`);
        } else {
            console.error(`Failed to suspend server ${serverId}: ${response.statusText}`);
        }
    } catch (error) {
        console.error(`Error suspending server ${serverId}: ${error.message}`);
    }
}

async function sendWebhook(violations, summary) {
    if (!config.webhookUrl) return;

    const embed = {
        title: ' Malicious Server Detected',
        description: 'Server has been automatically suspended',
        color: 0xff0000,
        fields: [
            {
                name: 'Server ID',
                value: serverId,
                inline: true,
            },
            {
                name: 'Reason',
                value: summary,
                inline: false,
            },
            {
                name: 'Violations Found',
                value: violations.length.toString(),
                inline: true,
            },
            {
                name: 'Critical Issues',
                value: violations.filter((v) => v.severity === 'critical').length.toString(),
                inline: true,
            },
        ],
        timestamp: new Date().toISOString(),
    };

    const topViolations = violations.slice(0, 5);
    if (topViolations.length > 0) {
        const violationList = topViolations
            .map((v) => `**[${v.severity.toUpperCase()}]** ${v.type}\n${v.description}\nFile: \`${v.file}\``)
            .join('\n\n');

        embed.fields.push({
            name: 'Top Violations',
            value: violationList,
            inline: false,
        });
    }

    try {
        await fetch(config.webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ embeds: [embed] }),
        });

        console.error('Webhook notification sent');
    } catch (error) {
        console.error(`Failed to send webhook: ${error.message}`);
    }
}

async function logToJexactylAPI(violations, summary) {
    try {
        const logData = {
            reason: summary,
            detectedAt: new Date().toISOString(),
            violations: violations.map((v) => ({
                type: v.type,
                severity: v.severity,
                file: v.file,
                description: v.description,
                matches: v.matches,
            })),
            violationCount: violations.length,
            criticalCount: violations.filter((v) => v.severity === 'critical').length,
            highCount: violations.filter((v) => v.severity === 'high').length,
        };

        const response = await fetch(`${config.jexactylUrl}/api/application/servers/${serverId}/violations`, {
            method: 'POST',
            headers: {
                Authorization: `Bearer ${config.jexactylApiToken}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(logData),
        });

        if (response.ok) {
            console.error(`Violation logged to Jexactyl API for server ${serverId}`);
        } else {
            console.error(`Failed to log violation to Jexactyl API: ${response.statusText}`);
        }
    } catch (error) {
        console.error(`Failed to log violation to Jexactyl API: ${error.message}`);
    }
}

async function scanServer() {
    const violations = [];

    const packageJsonFiles = findFiles(serverPath, 'package.json');
    for (const file of packageJsonFiles) {
        violations.push(...scanPackageJson(file));
    }

    const requirementsFiles = findFiles(serverPath, 'requirements.txt');
    for (const file of requirementsFiles) {
        violations.push(...scanRequirementsTxt(file));
    }

    const setupFiles = findFiles(serverPath, 'setup.py');
    for (const file of setupFiles) {
        violations.push(...scanSetupPy(file));
    }

    const pythonFiles = findFiles(serverPath, /\.py$/);
    for (const file of pythonFiles) {
        violations.push(...scanPythonFile(file));
    }

    const jsFiles = findFiles(serverPath, /\.(js|ts)$/);
    for (const file of jsFiles) {
        violations.push(...scanJavaScriptFile(file));
    }

    const detected = violations.length > 0;
    const summary = generateSummary(violations);

    if (detected) {
        const reason = `Malicious content detected: ${summary}`;
        await suspendServer(reason);
        await sendWebhook(violations, summary);
        await logToJexactylAPI(violations, summary);
    }

    return {
        detected,
        violations,
        summary,
    };
}

// Run the scan
scanServer()
    .then((result) => {
        console.log(JSON.stringify(result));
        process.exit(result.detected ? 1 : 0);
    })
    .catch((error) => {
        console.error(
            JSON.stringify({
                detected: false,
                violations: [],
                summary: `Scan error: ${error.message}`,
            })
        );
        process.exit(1);
    });
</file>

<file path="resources/scripts/setup-tests.ts">
import '@testing-library/jest-dom';
</file>

<file path="resources/scripts/theme.ts">
import { BreakpointFunction, createBreakpoint } from 'styled-components-breakpoint';

type Breakpoints = 'xs' | 'sm' | 'md' | 'lg' | 'xl';

export const breakpoint: BreakpointFunction<Breakpoints> = createBreakpoint<Breakpoints>({
    xs: 0,
    sm: 640,
    md: 768,
    lg: 1024,
    xl: 1280,
});
</file>

<file path="resources/scripts/TransitionRouter.tsx">
import React from 'react';
import tw from 'twin.macro';
import { Route } from 'react-router';
import styled from 'styled-components/macro';
import Fade from '@/components/elements/Fade';
import { SwitchTransition } from 'react-transition-group';

const StyledSwitchTransition = styled(SwitchTransition)`
    ${tw`relative`};

    & section {
        ${tw`absolute w-full top-0 left-0`};
    }
`;

const TransitionRouter: React.FC = ({ children }) => {
    return (
        <Route
            render={({ location }) => (
                <StyledSwitchTransition>
                    <Fade timeout={150} key={location.pathname + location.search} in appear unmountOnExit>
                        <section>{children}</section>
                    </Fade>
                </StyledSwitchTransition>
            )}
        />
    );
};

export default TransitionRouter;
</file>

<file path="resources/ts/utils/FileScanner.ts">
import fs from 'fs';
import path from 'path';

interface ScanResult {
    detected: boolean;
    violations: Violation[];
    summary: string;
}

interface Violation {
    type: string;
    file: string;
    severity: 'critical' | 'high' | 'medium' | 'low';
    description: string;
    matches: string[];
}

// Suspicious packages for JavaScript/Node.js
const SUSPICIOUS_NPM_PACKAGES = {
    critical: [
        'discord.js-selfbot-v13',
        'discord-selfbot',
        'selfbot',
        'token-logger',
        'discord-token-logger',
        'malicious-discord',
    ],
    high: ['discord.py-self', 'discordselfbot', 'nuker-bot', 'token-stealer', 'keylogger', 'password-stealer'],
};

// Suspicious packages for Python
const SUSPICIOUS_PY_PACKAGES = {
    critical: ['discord-selfbot', 'discord.py-self', 'selfbotpy'],
    high: ['discord-nuker', 'token-grabber', 'keylogger', 'clipper', 'rat', 'stealers'],
};

// Suspicious patterns in code
const SUSPICIOUS_PATTERNS = [
    /token.*=|=.*token/i,
    /password.*logger|log.*password/i,
    /steal.*token|token.*steal/i,
    /discord.*token|token.*discord/i,
    /webhook.*logger|logger.*webhook/i,
    /exfiltrate|exfil/i,
    /keylog/i,
    /clipper/i,
    /process.*inject|inject.*process/i,
];

interface ScannerConfig {
    webhookUrl?: string;
    jexactylUrl: string;
    jexactylApiToken: string;
}

export class FileScanner {
    private serverPath: string;
    private serverId: string;
    private config: ScannerConfig;

    constructor(serverPath: string, serverId: string, config: ScannerConfig) {
        this.serverPath = serverPath;
        this.serverId = serverId;
        this.config = config;
    }

    async scanServer(): Promise<ScanResult> {
        const violations: Violation[] = [];

        // Scan for package.json files
        const packageJsonFiles = this.findFiles('package.json');
        for (const file of packageJsonFiles) {
            violations.push(...this.scanPackageJson(file));
        }

        // Scan for requirements.txt files
        const requirementsFiles = this.findFiles('requirements.txt');
        for (const file of requirementsFiles) {
            violations.push(...this.scanRequirementsTxt(file));
        }

        // Scan for setup.py files
        const setupFiles = this.findFiles('setup.py');
        for (const file of setupFiles) {
            violations.push(...this.scanSetupPy(file));
        }

        // Scan Python files for suspicious patterns
        const pythonFiles = this.findFiles(/\.py$/);
        for (const file of pythonFiles) {
            violations.push(...this.scanPythonFile(file));
        }

        // Scan JavaScript/Node files for suspicious patterns
        const jsFiles = this.findFiles(/\.(js|ts)$/);
        for (const file of jsFiles) {
            violations.push(...this.scanJavaScriptFile(file));
        }

        const detected = violations.length > 0;
        const summary = this.generateSummary(violations);

        if (detected) {
            await this.handleDetection(violations, summary);
        }

        return {
            detected,
            violations,
            summary,
        };
    }

    private async handleDetection(violations: Violation[], summary: string): Promise<void> {
        const reason = `Malicious content detected: ${summary}`;

        // Step 1: Suspend the server via Jexactyl API
        await this.suspendServer(reason);

        // Step 2: Send webhook notification
        if (this.config.webhookUrl) {
            await this.sendWebhook(violations, summary);
        }

        // Step 3: Log to Jexactyl API
        await this.logToJexactylAPI(violations, summary);
    }

    private async suspendServer(reason: string): Promise<void> {
        try {
            const response = await fetch(`${this.config.jexactylUrl}/api/client/servers/${this.serverId}/suspend`, {
                method: 'POST',
                headers: {
                    Authorization: `Bearer ${this.config.jexactylApiToken}`,
                    'Content-Type': 'application/json',
                },
            });

            if (response.ok) {
                console.log(`Server ${this.serverId} suspended due to malicious content`);
            } else {
                console.error(`Failed to suspend server ${this.serverId}:`, response.statusText);
            }
        } catch (error) {
            console.error(`Error suspending server ${this.serverId}:`, error);
        }
    }

    private async sendWebhook(violations: Violation[], summary: string): Promise<void> {
        if (!this.config.webhookUrl) return;

        const embed = {
            title: ' Malicious Server Detected',
            description: `Server has been automatically suspended`,
            color: 0xff0000,
            fields: [
                {
                    name: 'Server ID',
                    value: this.serverId,
                    inline: true,
                },
                {
                    name: 'Reason',
                    value: summary,
                    inline: false,
                },
                {
                    name: 'Violations Found',
                    value: violations.length.toString(),
                    inline: true,
                },
                {
                    name: 'Critical Issues',
                    value: violations.filter((v) => v.severity === 'critical').length.toString(),
                    inline: true,
                },
            ],
            timestamp: new Date().toISOString(),
        };

        // Add top 5 violations to the embed
        const topViolations = violations.slice(0, 5);
        if (topViolations.length > 0) {
            const violationList = topViolations
                .map((v) => `**[${v.severity.toUpperCase()}]** ${v.type}\n${v.description}\nFile: \`${v.file}\``)
                .join('\n\n');

            embed.fields.push({
                name: 'Top Violations',
                value: violationList,
                inline: false,
            });
        }

        try {
            await fetch(this.config.webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ embeds: [embed] }),
            });

            console.log('Webhook notification sent');
        } catch (error) {
            console.error('Failed to send webhook:', error);
        }
    }

    private async logToJexactylAPI(violations: Violation[], summary: string): Promise<void> {
        try {
            const logData = {
                serverId: this.serverId,
                reason: summary,
                detectedAt: new Date().toISOString(),
                violations: violations.map((v) => ({
                    type: v.type,
                    severity: v.severity,
                    file: v.file,
                    description: v.description,
                    matches: v.matches,
                })),
                violationCount: violations.length,
                criticalCount: violations.filter((v) => v.severity === 'critical').length,
                highCount: violations.filter((v) => v.severity === 'high').length,
            };

            const response = await fetch(
                `${this.config.jexactylUrl}/api/application/servers/${this.serverId}/violations`,
                {
                    method: 'POST',
                    headers: {
                        Authorization: `Bearer ${this.config.jexactylApiToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(logData),
                }
            );

            if (response.ok) {
                console.log(`Violation logged to Jexactyl API for server ${this.serverId}`);
            } else {
                console.error(`Failed to log violation to Jexactyl API:`, response.statusText);
            }
        } catch (error) {
            console.error('Failed to log violation to Jexactyl API:', error);
        }
    }

    private findFiles(pattern: string | RegExp): string[] {
        const results: string[] = [];

        const walk = (dir: string) => {
            try {
                const files = fs.readdirSync(dir);
                for (const file of files) {
                    // Skip node_modules and common directories
                    if (['node_modules', '.git', '.env', 'venv', '__pycache__', '.venv'].includes(file)) {
                        continue;
                    }

                    const fullPath = path.join(dir, file);
                    const stat = fs.statSync(fullPath);

                    if (stat.isDirectory()) {
                        walk(fullPath);
                    } else {
                        const matches = typeof pattern === 'string' ? file === pattern : pattern.test(file);
                        if (matches) {
                            results.push(fullPath);
                        }
                    }
                }
            } catch (error) {
                // Skip directories we can't read
            }
        };

        walk(this.serverPath);
        return results;
    }

    private scanPackageJson(filePath: string): Violation[] {
        const violations: Violation[] = [];

        try {
            const content = fs.readFileSync(filePath, 'utf-8');
            const json = JSON.parse(content);

            const dependencies = {
                ...json.dependencies,
                ...json.devDependencies,
                ...json.optionalDependencies,
            };

            for (const [pkg, version] of Object.entries(dependencies)) {
                const pkgLower = pkg.toLowerCase();

                for (const [severity, packages] of Object.entries(SUSPICIOUS_NPM_PACKAGES)) {
                    if (packages.some((p) => pkgLower.includes(p.toLowerCase()))) {
                        violations.push({
                            type: 'suspicious_package',
                            file: filePath,
                            severity: severity as 'critical' | 'high' | 'medium' | 'low',
                            description: `Suspicious npm package detected: ${pkg}`,
                            matches: [pkg],
                        });
                    }
                }
            }
        } catch (error) {
            // Invalid JSON or file read error
        }

        return violations;
    }

    private scanRequirementsTxt(filePath: string): Violation[] {
        const violations: Violation[] = [];

        try {
            const content = fs.readFileSync(filePath, 'utf-8');
            const lines = content.split('\n');

            for (const line of lines) {
                const pkg = line.split('==')[0].split('>=')[0].split('<=')[0].trim();
                if (!pkg) continue;

                const pkgLower = pkg.toLowerCase();

                for (const [severity, packages] of Object.entries(SUSPICIOUS_PY_PACKAGES)) {
                    if (packages.some((p) => pkgLower.includes(p.toLowerCase()))) {
                        violations.push({
                            type: 'suspicious_python_package',
                            file: filePath,
                            severity: severity as 'critical' | 'high' | 'medium' | 'low',
                            description: `Suspicious Python package detected: ${pkg}`,
                            matches: [pkg],
                        });
                    }
                }
            }
        } catch (error) {
            // File read error
        }

        return violations;
    }

    private scanSetupPy(filePath: string): Violation[] {
        const violations: Violation[] = [];

        try {
            const content = fs.readFileSync(filePath, 'utf-8');

            // Look for install_requires and other package lists
            const packageMatches = content.match(/['"]([\w\-]+)['"]/g) || [];

            for (const match of packageMatches) {
                const pkg = match.replace(/['"]/g, '').toLowerCase();

                for (const [severity, packages] of Object.entries(SUSPICIOUS_PY_PACKAGES)) {
                    if (packages.some((p) => pkg.includes(p.toLowerCase()))) {
                        violations.push({
                            type: 'suspicious_python_package',
                            file: filePath,
                            severity: severity as 'critical' | 'high' | 'medium' | 'low',
                            description: `Suspicious Python package in setup.py: ${pkg}`,
                            matches: [pkg],
                        });
                    }
                }
            }
        } catch (error) {
            // File read error
        }

        return violations;
    }

    private scanPythonFile(filePath: string): Violation[] {
        const violations: Violation[] = [];

        try {
            const content = fs.readFileSync(filePath, 'utf-8');
            const matches: string[] = [];

            // Check for suspicious patterns
            for (const pattern of SUSPICIOUS_PATTERNS) {
                if (pattern.test(content)) {
                    const match = content.match(pattern);
                    if (match) {
                        matches.push(match[0]);
                    }
                }
            }

            if (matches.length > 2) {
                violations.push({
                    type: 'suspicious_code_pattern',
                    file: filePath,
                    severity: 'high',
                    description: `Multiple suspicious patterns detected in Python file`,
                    matches,
                });
            }
        } catch (error) {
            // File read error
        }

        return violations;
    }

    private scanJavaScriptFile(filePath: string): Violation[] {
        const violations: Violation[] = [];

        try {
            const content = fs.readFileSync(filePath, 'utf-8');
            const matches: string[] = [];

            // Check for suspicious patterns
            for (const pattern of SUSPICIOUS_PATTERNS) {
                if (pattern.test(content)) {
                    const match = content.match(pattern);
                    if (match) {
                        matches.push(match[0]);
                    }
                }
            }

            // Check for suspicious Discord-related patterns
            const discordPatterns = [
                /client\.token|token.*client/i,
                /user\.token|token.*user/i,
                /message\.author\.token|token.*author/i,
            ];

            for (const pattern of discordPatterns) {
                if (pattern.test(content)) {
                    matches.push('Discord token access detected');
                }
            }

            if (matches.length > 1) {
                violations.push({
                    type: 'suspicious_code_pattern',
                    file: filePath,
                    severity: 'high',
                    description: `Multiple suspicious patterns detected in JavaScript file`,
                    matches,
                });
            }
        } catch (error) {
            // File read error
        }

        return violations;
    }

    private generateSummary(violations: Violation[]): string {
        if (violations.length === 0) {
            return 'No suspicious files detected';
        }

        const bySeverity = {
            critical: violations.filter((v) => v.severity === 'critical').length,
            high: violations.filter((v) => v.severity === 'high').length,
            medium: violations.filter((v) => v.severity === 'medium').length,
            low: violations.filter((v) => v.severity === 'low').length,
        };

        const parts: string[] = [];
        if (bySeverity.critical > 0) parts.push(`${bySeverity.critical} critical`);
        if (bySeverity.high > 0) parts.push(`${bySeverity.high} high`);
        if (bySeverity.medium > 0) parts.push(`${bySeverity.medium} medium`);
        if (bySeverity.low > 0) parts.push(`${bySeverity.low} low`);

        return `${violations.length} violations detected: ${parts.join(', ')}`;
    }
}

// Usage Example
// const scanner = new FileScanner(
//     '/path/to/server',
//     'server-uuid-here',
//     {
//         webhookUrl: 'https://discord.com/api/webhooks/YOUR_WEBHOOK',
//         jexactylUrl: 'https://your-jexactyl-instance.com',
//         jexactylApiToken: 'YOUR_JEXACTYL_API_TOKEN',
//     }
// );
// const result = await scanner.scanServer();
// console.log(result);
</file>

<file path="resources/views/admin/api/index.blade.php">
@extends('layouts.admin')

@section('title')
    Application API
@endsection

@section('content-header')
    <h1>Application API<small>Control access credentials for managing this Panel via the API.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Application API</li>
    </ol>
@endsection

@section('content')
    <div class="row">
        <div class="col-xs-12">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Credentials List</h3>
                    <div class="box-tools">
                        <a href="{{ route('admin.api.new') }}" class="btn btn-sm btn-primary">Create New</a>
                    </div>
                </div>
                <div class="box-body table-responsive no-padding">
                    <table class="table table-hover">
                        <tr>
                            <th>Key</th>
                            <th>Memo</th>
                            <th>Last Used</th>
                            <th>Created</th>
                            <th></th>
                        </tr>
                        @foreach($keys as $key)
                            <tr>
                                <td><code>{{ $key->identifier }}{{ decrypt($key->token) }}</code></td>
                                <td>{{ $key->memo }}</td>
                                <td>
                                    @if(!is_null($key->last_used_at))
                                        @datetimeHuman($key->last_used_at)
                                    @else
                                        &mdash;
                                    @endif
                                </td>
                                <td>@datetimeHuman($key->created_at)</td>
                                <td>
                                    <a href="#" data-action="revoke-key" data-attr="{{ $key->identifier }}">
                                        <i class="fa fa-trash-o text-danger"></i>
                                    </a>
                                </td>
                            </tr>
                        @endforeach
                    </table>
                </div>
            </div>
        </div>
    </div>
@endsection

@section('footer-scripts')
    @parent
    <script>
        $(document).ready(function() {
            $('[data-action="revoke-key"]').click(function (event) {
                var self = $(this);
                event.preventDefault();
                swal({
                    type: 'error',
                    title: 'Revoke API Key',
                    text: 'Once this API key is revoked any applications currently using it will stop working.',
                    showCancelButton: true,
                    allowOutsideClick: true,
                    closeOnConfirm: false,
                    confirmButtonText: 'Revoke',
                    confirmButtonColor: '#d9534f',
                    showLoaderOnConfirm: true
                }, function () {
                    $.ajax({
                        method: 'DELETE',
                        url: '/admin/api/revoke/' + self.data('attr'),
                        headers: {
                            'X-CSRF-TOKEN': '{{ csrf_token() }}'
                        }
                    }).done(function () {
                        swal({
                            type: 'success',
                            title: '',
                            text: 'API Key has been revoked.'
                        });
                        self.parent().parent().slideUp();
                    }).fail(function (jqXHR) {
                        console.error(jqXHR);
                        swal({
                            type: 'error',
                            title: 'Whoops!',
                            text: 'An error occurred while attempting to revoke this key.'
                        });
                    });
                });
            });
        });
    </script>
@endsection
</file>

<file path="resources/views/admin/api/new.blade.php">
@extends('layouts.admin')

@section('title')
    Application API
@endsection

@section('content-header')
    <h1>Application API<small>Create a new application API key.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.api.index') }}">Application API</a></li>
        <li class="active">New Credentials</li>
    </ol>
@endsection

@section('content')
    <div class="row">
        <form method="POST" action="{{ route('admin.api.new') }}">
            <div class="col-sm-8 col-xs-12">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">Select Permissions</h3>
                    </div>
                    <div class="box-body table-responsive no-padding">
                        <table class="table table-hover">
                            @foreach($resources as $resource)
                                <tr>
                                    <td class="col-sm-3 strong">{{ str_replace('_', ' ', title_case($resource)) }}</td>
                                    <td class="col-sm-3 radio radio-primary text-center">
                                        <input type="radio" id="r_{{ $resource }}" name="r_{{ $resource }}" value="{{ $permissions['r'] }}">
                                        <label for="r_{{ $resource }}">Read</label>
                                    </td>
                                    <td class="col-sm-3 radio radio-primary text-center">
                                        <input type="radio" id="rw_{{ $resource }}" name="r_{{ $resource }}" value="{{ $permissions['rw'] }}">
                                        <label for="rw_{{ $resource }}">Read &amp; Write</label>
                                    </td>
                                    <td class="col-sm-3 radio text-center">
                                        <input type="radio" id="n_{{ $resource }}" name="r_{{ $resource }}" value="{{ $permissions['n'] }}" checked>
                                        <label for="n_{{ $resource }}">None</label>
                                    </td>
                                </tr>
                            @endforeach
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-sm-4 col-xs-12">
                <div class="box box-primary">
                    <div class="box-body">
                        <div class="form-group">
                            <label class="control-label" for="memoField">Description <span class="field-required"></span></label>
                            <input id="memoField" type="text" name="memo" class="form-control">
                        </div>
                        <p class="text-muted">Once you have assigned permissions and created this set of credentials you will be unable to come back and edit it. If you need to make changes down the road you will need to create a new set of credentials.</p>
                    </div>
                    <div class="box-footer">
                        {{ csrf_field() }}
                        <button type="submit" class="btn btn-success btn-sm pull-right">Create Credentials</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
@endsection

@section('footer-scripts')
    @parent
    <script>
    </script>
@endsection
</file>

<file path="resources/views/admin/databases/index.blade.php">
@extends('layouts.admin')

@section('title')
    Database Hosts
@endsection

@section('content-header')
    <h1>Database Hosts<small>Database hosts that servers can have databases created on.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Database Hosts</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-xs-12">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">Host List</h3>
                <div class="box-tools">
                    <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#newHostModal">Create New</button>
                </div>
            </div>
            <div class="box-body table-responsive no-padding">
                <table class="table table-hover">
                    <tbody>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Host</th>
                            <th>Port</th>
                            <th>Username</th>
                            <th class="text-center">Databases</th>
                            <th class="text-center">Node</th>
                        </tr>
                        @foreach ($hosts as $host)
                            <tr>
                                <td><code>{{ $host->id }}</code></td>
                                <td><a href="{{ route('admin.databases.view', $host->id) }}">{{ $host->name }}</a></td>
                                <td><code>{{ $host->host }}</code></td>
                                <td><code>{{ $host->port }}</code></td>
                                <td>{{ $host->username }}</td>
                                <td class="text-center">{{ $host->databases_count }}</td>
                                <td class="text-center">
                                    @if(! is_null($host->node))
                                        <a href="{{ route('admin.nodes.view', $host->node->id) }}">{{ $host->node->name }}</a>
                                    @else
                                        <span class="label label-default">None</span>
                                    @endif
                                </td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="newHostModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form action="{{ route('admin.databases') }}" method="POST">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Create New Database Host</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="pName" class="form-label">Name</label>
                        <input type="text" name="name" id="pName" class="form-control" />
                        <p class="text-muted small">A short identifier used to distinguish this location from others. Must be between 1 and 60 characters, for example, <code>us.nyc.lvl3</code>.</p>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="pHost" class="form-label">Host</label>
                            <input type="text" name="host" id="pHost" class="form-control" />
                            <p class="text-muted small">The IP address or FQDN that should be used when attempting to connect to this MySQL host <em>from the panel</em> to add new databases.</p>
                        </div>
                        <div class="col-md-6">
                            <label for="pPort" class="form-label">Port</label>
                            <input type="text" name="port" id="pPort" class="form-control" value="3306"/>
                            <p class="text-muted small">The port that MySQL is running on for this host.</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="pUsername" class="form-label">Username</label>
                            <input type="text" name="username" id="pUsername" class="form-control" />
                            <p class="text-muted small">The username of an account that has enough permissions to create new users and databases on the system.</p>
                        </div>
                        <div class="col-md-6">
                            <label for="pPassword" class="form-label">Password</label>
                            <input type="password" name="password" id="pPassword" class="form-control" />
                            <p class="text-muted small">The password to the account defined.</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="pNodeId" class="form-label">Linked Node</label>
                        <select name="node_id" id="pNodeId" class="form-control">
                            <option value="">None</option>
                            @foreach($locations as $location)
                                <optgroup label="{{ $location->short }}">
                                    @foreach($location->nodes as $node)
                                        <option value="{{ $node->id }}">{{ $node->name }}</option>
                                    @endforeach
                                </optgroup>
                            @endforeach
                        </select>
                        <p class="text-muted small">This setting does nothing other than default to this database host when adding a database to a server on the selected node.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <p class="text-danger small text-left">The account defined for this database host <strong>must</strong> have the <code>WITH GRANT OPTION</code> permission. If the defined account does not have this permission requests to create databases <em>will</em> fail. <strong>Do not use the same account details for MySQL that you have defined for this panel.</strong></p>
                    {!! csrf_field() !!}
                    <button type="button" class="btn btn-default btn-sm pull-left" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success btn-sm">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>
@endsection

@section('footer-scripts')
    @parent
    <script>
        $('#pNodeId').select2();
    </script>
@endsection
</file>

<file path="resources/views/admin/databases/view.blade.php">
@extends('layouts.admin')

@section('title')
    Database Hosts &rarr; View &rarr; {{ $host->name }}
@endsection

@section('content-header')
    <h1>{{ $host->name }}<small>Viewing associated databases and details for this database host.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.databases') }}">Database Hosts</a></li>
        <li class="active">{{ $host->name }}</li>
    </ol>
@endsection

@section('content')
<form action="{{ route('admin.databases.view', $host->id) }}" method="POST">
    <div class="row">
        <div class="col-sm-6">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Host Details</h3>
                </div>
                <div class="box-body">
                    <div class="form-group">
                        <label for="pName" class="form-label">Name</label>
                        <input type="text" id="pName" name="name" class="form-control" value="{{ old('name', $host->name) }}" />
                    </div>
                    <div class="form-group">
                        <label for="pHost" class="form-label">Host</label>
                        <input type="text" id="pHost" name="host" class="form-control" value="{{ old('host', $host->host) }}" />
                        <p class="text-muted small">The IP address or FQDN that should be used when attempting to connect to this MySQL host <em>from the panel</em> to add new databases.</p>
                    </div>
                    <div class="form-group">
                        <label for="pPort" class="form-label">Port</label>
                        <input type="text" id="pPort" name="port" class="form-control" value="{{ old('port', $host->port) }}" />
                        <p class="text-muted small">The port that MySQL is running on for this host.</p>
                    </div>
                    <div class="form-group">
                        <label for="pNodeId" class="form-label">Linked Node</label>
                        <select name="node_id" id="pNodeId" class="form-control">
                            <option value="">None</option>
                            @foreach($locations as $location)
                                <optgroup label="{{ $location->short }}">
                                    @foreach($location->nodes as $node)
                                        <option value="{{ $node->id }}" {{ $host->node_id !== $node->id ?: 'selected' }}>{{ $node->name }}</option>
                                    @endforeach
                                </optgroup>
                            @endforeach
                        </select>
                        <p class="text-muted small">This setting does nothing other than default to this database host when adding a database to a server on the selected node.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">User Details</h3>
                </div>
                <div class="box-body">
                    <div class="form-group">
                        <label for="pUsername" class="form-label">Username</label>
                        <input type="text" name="username" id="pUsername" class="form-control" value="{{ old('username', $host->username) }}" />
                        <p class="text-muted small">The username of an account that has enough permissions to create new users and databases on the system.</p>
                    </div>
                    <div class="form-group">
                        <label for="pPassword" class="form-label">Password</label>
                        <input type="password" name="password" id="pPassword" class="form-control" />
                        <p class="text-muted small">The password to the account defined. Leave blank to continue using the assigned password.</p>
                    </div>
                    <hr />
                    <p class="text-danger small text-left">The account defined for this database host <strong>must</strong> have the <code>WITH GRANT OPTION</code> permission. If the defined account does not have this permission requests to create databases <em>will</em> fail. <strong>Do not use the same account details for MySQL that you have defined for this panel.</strong></p>
                </div>
                <div class="box-footer">
                    {!! csrf_field() !!}
                    <button name="_method" value="PATCH" class="btn btn-sm btn-primary pull-right">Save</button>
                    <button name="_method" value="DELETE" class="btn btn-sm btn-danger pull-left muted muted-hover"><i class="fa fa-trash-o"></i></button>
                </div>
            </div>
        </div>
    </div>
</form>
<div class="row">
    <div class="col-xs-12">
        <div class="box">
            <div class="box-header with-border">
                <h3 class="box-title">Databases</h3>
            </div>
            <div class="box-body table-responsive no-padding">
                <table class="table table-hover">
                    <tr>
                        <th>Server</th>
                        <th>Database Name</th>
                        <th>Username</th>
                        <th>Connections From</th>
                        <th>Max Connections</th>
                        <th></th>
                    </tr>
                    @foreach($databases as $database)
                        <tr>
                            <td class="middle"><a href="{{ route('admin.servers.view', $database->getRelation('server')->id) }}">{{ $database->getRelation('server')->name }}</a></td>
                            <td class="middle">{{ $database->database }}</td>
                            <td class="middle">{{ $database->username }}</td>
                            <td class="middle">{{ $database->remote }}</td>
                            @if($database->max_connections != null)
                                <td class="middle">{{ $database->max_connections }}</td>
                            @else
                                <td class="middle">Unlimited</td>
                            @endif
                            <td class="text-center">
                                <a href="{{ route('admin.servers.view.database', $database->getRelation('server')->id) }}">
                                    <button class="btn btn-xs btn-primary">Manage</button>
                                </a>
                            </td>
                        </tr>
                    @endforeach
                </table>
            </div>
            @if($databases->hasPages())
                <div class="box-footer with-border">
                    <div class="col-md-12 text-center">{!! $databases->render() !!}</div>
                </div>
            @endif
        </div>
    </div>
</div>
@endsection

@section('footer-scripts')
    @parent
    <script>
        $('#pNodeId').select2();
    </script>
@endsection
</file>

<file path="resources/views/admin/eggs/new.blade.php">
@extends('layouts.admin')

@section('title')
    Nests &rarr; New Egg
@endsection

@section('content-header')
    <h1>New Egg<small>Create a new Egg to assign to servers.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.nests') }}">Nests</a></li>
        <li class="active">New Egg</li>
    </ol>
@endsection

@section('content')
<form action="{{ route('admin.nests.egg.new') }}" method="POST">
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Configuration</h3>
                </div>
                <div class="box-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="pNestId" class="form-label">Associated Nest</label>
                                <div>
                                    <select name="nest_id" id="pNestId">
                                        @foreach($nests as $nest)
                                            <option value="{{ $nest->id }}" {{ old('nest_id') != $nest->id ?: 'selected' }}>{{ $nest->name }} &lt;{{ $nest->author }}&gt;</option>
                                        @endforeach
                                    </select>
                                    <p class="text-muted small">Think of a Nest as a category. You can put multiple Eggs in a nest, but consider putting only Eggs that are related to each other in each Nest.</p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="pName" class="form-label">Name</label>
                                <input type="text" id="pName" name="name" value="{{ old('name') }}" class="form-control" />
                                <p class="text-muted small">A simple, human-readable name to use as an identifier for this Egg. This is what users will see as their game server type.</p>
                            </div>
                            <div class="form-group">
                                <label for="pDescription" class="form-label">Description</label>
                                <textarea id="pDescription" name="description" class="form-control" rows="8">{{ old('description') }}</textarea>
                                <p class="text-muted small">A description of this Egg.</p>
                            </div>
                            <div class="form-group">
                                <div class="checkbox checkbox-primary no-margin-bottom">
                                    <input id="pForceOutgoingIp" name="force_outgoing_ip" type="checkbox" value="1" {{ \Jexactyl\Helpers\Utilities::checked('force_outgoing_ip', 0) }} />
                                    <label for="pForceOutgoingIp" class="strong">Force Outgoing IP</label>
                                    <p class="text-muted small">
                                        Forces all outgoing network traffic to have its Source IP NATed to the IP of the server's primary allocation IP.
                                        Required for certain games to work properly when the Node has multiple public IP addresses.
                                        <br>
                                        <strong>
                                            Enabling this option will disable internal networking for any servers using this egg,
                                            causing them to be unable to internally access other servers on the same node.
                                        </strong>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="pDockerImage" class="control-label">Docker Images</label>
                                <textarea id="pDockerImages" name="docker_images" rows="4" placeholder="quay.io/Jexactyl/service" class="form-control">{{ old('docker_images') }}</textarea>
                                <p class="text-muted small">The docker images available to servers using this egg. Enter one per line. Users will be able to select from this list of images if more than one value is provided.</p>
                            </div>
                            <div class="form-group">
                                <label for="pStartup" class="control-label">Startup Command</label>
                                <textarea id="pStartup" name="startup" class="form-control" rows="10">{{ old('startup') }}</textarea>
                                <p class="text-muted small">The default startup command that should be used for new servers created with this Egg. You can change this per-server as needed.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Process Management</h3>
                </div>
                <div class="box-body">
                    <div class="row">
                        <div class="col-xs-12">
                            <div class="alert alert-warning">
                                <p>All fields are required unless you select a separate option from the 'Copy Settings From' dropdown, in which case fields may be left blank to use the values from that option.</p>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="pConfigFrom" class="form-label">Copy Settings From</label>
                                <select name="config_from" id="pConfigFrom" class="form-control">
                                    <option value="">None</option>
                                </select>
                                <p class="text-muted small">If you would like to default to settings from another Egg select it from the dropdown above.</p>
                            </div>
                            <div class="form-group">
                                <label for="pConfigStop" class="form-label">Stop Command</label>
                                <input type="text" id="pConfigStop" name="config_stop" class="form-control" value="{{ old('config_stop') }}" />
                                <p class="text-muted small">The command that should be sent to server processes to stop them gracefully. If you need to send a <code>SIGINT</code> you should enter <code>^C</code> here.</p>
                            </div>
                            <div class="form-group">
                                <label for="pConfigLogs" class="form-label">Log Configuration</label>
                                <textarea data-action="handle-tabs" id="pConfigLogs" name="config_logs" class="form-control" rows="6">{{ old('config_logs') }}</textarea>
                                <p class="text-muted small">This should be a JSON representation of where log files are stored, and whether or not the daemon should be creating custom logs.</p>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="pConfigFiles" class="form-label">Configuration Files</label>
                                <textarea data-action="handle-tabs" id="pConfigFiles" name="config_files" class="form-control" rows="6">{{ old('config_files') }}</textarea>
                                <p class="text-muted small">This should be a JSON representation of configuration files to modify and what parts should be changed.</p>
                            </div>
                            <div class="form-group">
                                <label for="pConfigStartup" class="form-label">Start Configuration</label>
                                <textarea data-action="handle-tabs" id="pConfigStartup" name="config_startup" class="form-control" rows="6">{{ old('config_startup') }}</textarea>
                                <p class="text-muted small">This should be a JSON representation of what values the daemon should be looking for when booting a server to determine completion.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box-footer">
                    {!! csrf_field() !!}
                    <button type="submit" class="btn btn-success btn-sm pull-right">Create</button>
                </div>
            </div>
        </div>
    </div>
</form>
@endsection

@section('footer-scripts')
    @parent
    {!! Theme::js('vendor/lodash/lodash.js') !!}
    <script>
    $(document).ready(function() {
        $('#pNestId').select2().change();
        $('#pConfigFrom').select2();
    });
    $('#pNestId').on('change', function (event) {
        $('#pConfigFrom').html('<option value="">None</option>').select2({
            data: $.map(_.get(Jexactyl.nests, $(this).val() + '.eggs', []), function (item) {
                return {
                    id: item.id,
                    text: item.name + ' <' + item.author + '>',
                };
            }),
        });
    });
    $('textarea[data-action="handle-tabs"]').on('keydown', function(event) {
        if (event.keyCode === 9) {
            event.preventDefault();

            var curPos = $(this)[0].selectionStart;
            var prepend = $(this).val().substr(0, curPos);
            var append = $(this).val().substr(curPos);

            $(this).val(prepend + '    ' + append);
        }
    });
    </script>
@endsection
</file>

<file path="resources/views/admin/eggs/scripts.blade.php">
@extends('layouts.admin')

@section('title')
    Nests &rarr; Egg: {{ $egg->name }} &rarr; Install Script
@endsection

@section('content-header')
    <h1>{{ $egg->name }}<small>Manage the install script for this Egg.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.nests') }}">Nests</a></li>
        <li><a href="{{ route('admin.nests.view', $egg->nest->id) }}">{{ $egg->nest->name }}</a></li>
        <li><a href="{{ route('admin.nests.egg.view', $egg->id) }}">{{ $egg->name }}</a></li>
        <li class="active">{{ $egg->name }}</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-xs-12">
        <div class="nav-tabs-custom nav-tabs-floating">
            <ul class="nav nav-tabs">
                <li><a href="{{ route('admin.nests.egg.view', $egg->id) }}">Configuration</a></li>
                <li><a href="{{ route('admin.nests.egg.variables', $egg->id) }}">Variables</a></li>
                <li class="active"><a href="{{ route('admin.nests.egg.scripts', $egg->id) }}">Install Script</a></li>
            </ul>
        </div>
    </div>
</div>
<form action="{{ route('admin.nests.egg.scripts', $egg->id) }}" method="POST">
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Install Script</h3>
                </div>
                @if(! is_null($egg->copyFrom))
                    <div class="box-body">
                        <div class="callout callout-warning no-margin">
                            This service option is copying installation scripts and container options from <a href="{{ route('admin.nests.egg.view', $egg->copyFrom->id) }}">{{ $egg->copyFrom->name }}</a>. Any changes you make to this script will not apply unless you select "None" from the dropdown box below.
                        </div>
                    </div>
                @endif
                <div class="box-body no-padding">
                    <div id="editor_install"style="height:300px">{{ $egg->script_install }}</div>
                </div>
                <div class="box-body">
                    <div class="row">
                        <div class="form-group col-sm-4">
                            <label class="control-label">Copy Script From</label>
                            <select id="pCopyScriptFrom" name="copy_script_from">
                                <option value="">None</option>
                                @foreach($copyFromOptions as $opt)
                                    <option value="{{ $opt->id }}" {{ $egg->copy_script_from !== $opt->id ?: 'selected' }}>{{ $opt->name }}</option>
                                @endforeach
                            </select>
                            <p class="text-muted small">If selected, script above will be ignored and script from selected option will be used in place.</p>
                        </div>
                        <div class="form-group col-sm-4">
                            <label class="control-label">Script Container</label>
                            <input type="text" name="script_container" class="form-control" value="{{ $egg->script_container }}" />
                            <p class="text-muted small">Docker container to use when running this script for the server.</p>
                        </div>
                        <div class="form-group col-sm-4">
                            <label class="control-label">Script Entrypoint Command</label>
                            <input type="text" name="script_entry" class="form-control" value="{{ $egg->script_entry }}" />
                            <p class="text-muted small">The entrypoint command to use for this script.</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12 text-muted">
                            The following service options rely on this script:
                            @if(count($relyOnScript) > 0)
                                @foreach($relyOnScript as $rely)
                                    <a href="{{ route('admin.nests.egg.view', $rely->id) }}">
                                        <code>{{ $rely->name }}</code>@if(!$loop->last),&nbsp;@endif
                                    </a>
                                @endforeach
                            @else
                                <em>none</em>
                            @endif
                        </div>
                    </div>
                </div>
                <div class="box-footer">
                    {!! csrf_field() !!}
                    <textarea name="script_install" class="hidden"></textarea>
                    <button type="submit" name="_method" value="PATCH" class="btn btn-primary btn-sm pull-right">Save</button>
                </div>
            </div>
        </div>
    </div>
</form>
@endsection

@section('footer-scripts')
    @parent
    {!! Theme::js('vendor/ace/ace.js') !!}
    {!! Theme::js('vendor/ace/ext-modelist.js') !!}
    <script>
    $(document).ready(function () {
        $('#pCopyScriptFrom').select2();

        const InstallEditor = ace.edit('editor_install');
        const Modelist = ace.require('ace/ext/modelist')

        InstallEditor.setTheme('ace/theme/chrome');
        InstallEditor.getSession().setMode('ace/mode/sh');
        InstallEditor.getSession().setUseWrapMode(true);
        InstallEditor.setShowPrintMargin(false);

        $('form').on('submit', function (e) {
            $('textarea[name="script_install"]').val(InstallEditor.getValue());
        });
    });
    </script>

@endsection
</file>

<file path="resources/views/admin/eggs/variables.blade.php">
@extends('layouts.admin')

@section('title')
    Egg &rarr; {{ $egg->name }} &rarr; Variables
@endsection

@section('content-header')
    <h1>{{ $egg->name }}<small>Managing variables for this Egg.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.nests') }}">Nests</a></li>
        <li><a href="{{ route('admin.nests.view', $egg->nest->id) }}">{{ $egg->nest->name }}</a></li>
        <li><a href="{{ route('admin.nests.egg.view', $egg->id) }}">{{ $egg->name }}</a></li>
        <li class="active">Variables</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-xs-12">
        <div class="nav-tabs-custom nav-tabs-floating">
            <ul class="nav nav-tabs">
                <li><a href="{{ route('admin.nests.egg.view', $egg->id) }}">Configuration</a></li>
                <li class="active"><a href="{{ route('admin.nests.egg.variables', $egg->id) }}">Variables</a></li>
                <li><a href="{{ route('admin.nests.egg.scripts', $egg->id) }}">Install Script</a></li>
            </ul>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-xs-12">
        <div class="box no-border">
            <div class="box-body">
                <a href="#" class="btn btn-sm btn-success pull-right" data-toggle="modal" data-target="#newVariableModal">Create New Variable</a>
            </div>
        </div>
    </div>
</div>
<div class="row">
    @foreach($egg->variables as $variable)
        <div class="col-sm-6">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">{{ $variable->name }}</h3>
                </div>
                <form action="{{ route('admin.nests.egg.variables.edit', ['egg' => $egg->id, 'variable' => $variable->id]) }}" method="POST">
                    <div class="box-body">
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" name="name" value="{{ $variable->name }}" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea name="description" class="form-control" rows="3">{{ $variable->description }}</textarea>
                        </div>
                        <div class="row">
                            <div class="form-group col-md-6">
                                <label class="form-label">Environment Variable</label>
                                <input type="text" name="env_variable" value="{{ $variable->env_variable }}" class="form-control" />
                            </div>
                            <div class="form-group col-md-6">
                                <label class="form-label">Default Value</label>
                                <input type="text" name="default_value" value="{{ $variable->default_value }}" class="form-control" />
                            </div>
                            <div class="col-xs-12">
                                <p class="text-muted small">This variable can be accessed in the startup command by using <code>{{ $variable->env_variable }}</code>.</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Permissions</label>
                            <select name="options[]" class="pOptions form-control" multiple>
                                <option value="user_viewable" {{ (! $variable->user_viewable) ?: 'selected' }}>Users Can View</option>
                                <option value="user_editable" {{ (! $variable->user_editable) ?: 'selected' }}>Users Can Edit</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Input Rules</label>
                            <input type="text" name="rules" class="form-control" value="{{ $variable->rules }}" />
                            <p class="text-muted small">These rules are defined using standard <a href="https://laravel.com/docs/5.7/validation#available-validation-rules" target="_blank">Laravel Framework validation rules</a>.</p>
                        </div>
                    </div>
                    <div class="box-footer">
                        {!! csrf_field() !!}
                        <button class="btn btn-sm btn-primary pull-right" name="_method" value="PATCH" type="submit">Save</button>
                        <button class="btn btn-sm btn-danger pull-left muted muted-hover" data-action="delete" name="_method" value="DELETE" type="submit"><i class="fa fa-trash-o"></i></button>
                    </div>
                </form>
            </div>
        </div>
    @endforeach
</div>
<div class="modal fade" id="newVariableModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Create New Egg Variable</h4>
            </div>
            <form action="{{ route('admin.nests.egg.variables', $egg->id) }}" method="POST">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="control-label">Name <span class="field-required"></span></label>
                        <input type="text" name="name" class="form-control" value="{{ old('name') }}"/>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Description</label>
                        <textarea name="description" class="form-control" rows="3">{{ old('description') }}</textarea>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-6">
                            <label class="control-label">Environment Variable <span class="field-required"></span></label>
                            <input type="text" name="env_variable" class="form-control" value="{{ old('env_variable') }}" />
                        </div>
                        <div class="form-group col-md-6">
                            <label class="control-label">Default Value</label>
                            <input type="text" name="default_value" class="form-control" value="{{ old('default_value') }}" />
                        </div>
                        <div class="col-xs-12">
                            <p class="text-muted small">This variable can be accessed in the startup command by entering <code>@{{environment variable value}}</code>.</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Permissions</label>
                        <select name="options[]" class="pOptions form-control" multiple>
                            <option value="user_viewable">Users Can View</option>
                            <option value="user_editable">Users Can Edit</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Input Rules <span class="field-required"></span></label>
                        <input type="text" name="rules" class="form-control" value="{{ old('rules', 'required|string|max:20') }}" placeholder="required|string|max:20" />
                        <p class="text-muted small">These rules are defined using standard <a href="https://laravel.com/docs/5.7/validation#available-validation-rules" target="_blank">Laravel Framework validation rules</a>.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    {!! csrf_field() !!}
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Create Variable</button>
                </div>
            </form>
        </div>
    </div>
</div>
@endsection

@section('footer-scripts')
    @parent
    <script>
        $('.pOptions').select2();
        $('[data-action="delete"]').on('mouseenter', function (event) {
            $(this).find('i').html(' Delete Variable');
        }).on('mouseleave', function (event) {
            $(this).find('i').html('');
        });
    </script>
@endsection
</file>

<file path="resources/views/admin/eggs/view.blade.php">
@extends('layouts.admin')

@section('title')
    Nests &rarr; Egg: {{ $egg->name }}
@endsection

@section('content-header')
    <h1>{{ $egg->name }}<small>{{ str_limit($egg->description, 50) }}</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.nests') }}">Nests</a></li>
        <li><a href="{{ route('admin.nests.view', $egg->nest->id) }}">{{ $egg->nest->name }}</a></li>
        <li class="active">{{ $egg->name }}</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-xs-12">
        <div class="nav-tabs-custom nav-tabs-floating">
            <ul class="nav nav-tabs">
                <li class="active"><a href="{{ route('admin.nests.egg.view', $egg->id) }}">Configuration</a></li>
                <li><a href="{{ route('admin.nests.egg.variables', $egg->id) }}">Variables</a></li>
                <li><a href="{{ route('admin.nests.egg.scripts', $egg->id) }}">Install Script</a></li>
            </ul>
        </div>
    </div>
</div>
<form action="{{ route('admin.nests.egg.view', $egg->id) }}" enctype="multipart/form-data" method="POST">
    <div class="row">
        <div class="col-xs-12">
            <div class="box box-danger">
                <div class="box-body">
                    <div class="row">
                        <div class="col-xs-8">
                            <div class="form-group no-margin-bottom">
                                <label for="pName" class="control-label">Egg File</label>
                                <div>
                                    <input type="file" name="import_file" class="form-control" style="border: 0;margin-left:-10px;" />
                                    <p class="text-muted small no-margin-bottom">If you would like to replace settings for this Egg by uploading a new JSON file, simply select it here and press "Update Egg". This will not change any existing startup strings or Docker images for existing servers.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-4">
                            {!! csrf_field() !!}
                            <button type="submit" name="_method" value="PUT" class="btn btn-sm btn-danger pull-right">Update Egg</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
<form action="{{ route('admin.nests.egg.view', $egg->id) }}" method="POST">
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Configuration</h3>
                </div>
                <div class="box-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="pName" class="control-label">Name <span class="field-required"></span></label>
                                <input type="text" id="pName" name="name" value="{{ $egg->name }}" class="form-control" />
                                <p class="text-muted small">A simple, human-readable name to use as an identifier for this Egg.</p>
                            </div>
                            <div class="form-group">
                                <label for="pUuid" class="control-label">UUID</label>
                                <input type="text" id="pUuid" readonly value="{{ $egg->uuid }}" class="form-control" />
                                <p class="text-muted small">This is the globally unique identifier for this Egg which the Daemon uses as an identifier.</p>
                            </div>
                            <div class="form-group">
                                <label for="pAuthor" class="control-label">Author</label>
                                <input type="text" id="pAuthor" readonly value="{{ $egg->author }}" class="form-control" />
                                <p class="text-muted small">The author of this version of the Egg. Uploading a new Egg configuration from a different author will change this.</p>
                            </div>
                            <div class="form-group">
                                <label for="pDockerImage" class="control-label">Docker Images <span class="field-required"></span></label>
                                <textarea id="pDockerImages" name="docker_images" class="form-control" rows="4">{{ implode(PHP_EOL, $images) }}</textarea>
                                <p class="text-muted small">
                                    The docker images available to servers using this egg. Enter one per line. Users
                                    will be able to select from this list of images if more than one value is provided.
                                    Optionally, a display name may be provided by prefixing the image with the name
                                    followed by a pipe character, and then the image URL. Example: <code>Display Name|ghcr.io/my/egg</code>
                                </p>
                            </div>
                            <div class="form-group">
                                <div class="checkbox checkbox-primary no-margin-bottom">
                                    <input id="pForceOutgoingIp" name="force_outgoing_ip" type="checkbox" value="1" @if($egg->force_outgoing_ip) checked @endif />
                                    <label for="pForceOutgoingIp" class="strong">Force Outgoing IP</label>
                                    <p class="text-muted small">
                                        Forces all outgoing network traffic to have its Source IP NATed to the IP of the server's primary allocation IP.
                                        Required for certain games to work properly when the Node has multiple public IP addresses.
                                        <br>
                                        <strong>
                                            Enabling this option will disable internal networking for any servers using this egg,
                                            causing them to be unable to internally access other servers on the same node.
                                        </strong>
                                    </p>
                                </div>
                            </div>

                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="pDescription" class="control-label">Description</label>
                                <textarea id="pDescription" name="description" class="form-control" rows="8">{{ $egg->description }}</textarea>
                                <p class="text-muted small">A description of this Egg that will be displayed throughout the Panel as needed.</p>
                            </div>
                            <div class="form-group">
                                <label for="pStartup" class="control-label">Startup Command <span class="field-required"></span></label>
                                <textarea id="pStartup" name="startup" class="form-control" rows="8">{{ $egg->startup }}</textarea>
                                <p class="text-muted small">The default startup command that should be used for new servers using this Egg.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Process Management</h3>
                </div>
                <div class="box-body">
                    <div class="row">
                        <div class="col-xs-12">
                            <div class="alert alert-warning">
                                <p>The following configuration options should not be edited unless you understand how this system works. If wrongly modified it is possible for the daemon to break.</p>
                                <p>All fields are required unless you select a separate option from the 'Copy Settings From' dropdown, in which case fields may be left blank to use the values from that Egg.</p>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="pConfigFrom" class="form-label">Copy Settings From</label>
                                <select name="config_from" id="pConfigFrom" class="form-control">
                                    <option value="">None</option>
                                    @foreach($egg->nest->eggs as $o)
                                        <option value="{{ $o->id }}" {{ ($egg->config_from !== $o->id) ?: 'selected' }}>{{ $o->name }} &lt;{{ $o->author }}&gt;</option>
                                    @endforeach
                                </select>
                                <p class="text-muted small">If you would like to default to settings from another Egg select it from the menu above.</p>
                            </div>
                            <div class="form-group">
                                <label for="pConfigStop" class="form-label">Stop Command</label>
                                <input type="text" id="pConfigStop" name="config_stop" class="form-control" value="{{ $egg->config_stop }}" />
                                <p class="text-muted small">The command that should be sent to server processes to stop them gracefully. If you need to send a <code>SIGINT</code> you should enter <code>^C</code> here.</p>
                            </div>
                            <div class="form-group">
                                <label for="pConfigLogs" class="form-label">Log Configuration</label>
                                <textarea data-action="handle-tabs" id="pConfigLogs" name="config_logs" class="form-control" rows="6">{{ ! is_null($egg->config_logs) ? json_encode(json_decode($egg->config_logs), JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES) : '' }}</textarea>
                                <p class="text-muted small">This should be a JSON representation of where log files are stored, and whether or not the daemon should be creating custom logs.</p>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="pConfigFiles" class="form-label">Configuration Files</label>
                                <textarea data-action="handle-tabs" id="pConfigFiles" name="config_files" class="form-control" rows="6">{{ ! is_null($egg->config_files) ? json_encode(json_decode($egg->config_files), JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES) : '' }}</textarea>
                                <p class="text-muted small">This should be a JSON representation of configuration files to modify and what parts should be changed.</p>
                            </div>
                            <div class="form-group">
                                <label for="pConfigStartup" class="form-label">Start Configuration</label>
                                <textarea data-action="handle-tabs" id="pConfigStartup" name="config_startup" class="form-control" rows="6">{{ ! is_null($egg->config_startup) ? json_encode(json_decode($egg->config_startup), JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES) : '' }}</textarea>
                                <p class="text-muted small">This should be a JSON representation of what values the daemon should be looking for when booting a server to determine completion.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box-footer">
                    {!! csrf_field() !!}
                    <button type="submit" name="_method" value="PATCH" class="btn btn-primary btn-sm pull-right">Save</button>
                    <a href="{{ route('admin.nests.egg.export', $egg->id) }}" class="btn btn-sm btn-info pull-right" style="margin-right:10px;">Export</a>
                    <button id="deleteButton" type="submit" name="_method" value="DELETE" class="btn btn-danger btn-sm muted muted-hover">
                        <i class="fa fa-trash-o"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>
@endsection

@section('footer-scripts')
    @parent
    <script>
    $('#pConfigFrom').select2();
    $('#deleteButton').on('mouseenter', function (event) {
        $(this).find('i').html(' Delete Egg');
    }).on('mouseleave', function (event) {
        $(this).find('i').html('');
    });
    $('textarea[data-action="handle-tabs"]').on('keydown', function(event) {
        if (event.keyCode === 9) {
            event.preventDefault();

            var curPos = $(this)[0].selectionStart;
            var prepend = $(this).val().substr(0, curPos);
            var append = $(this).val().substr(curPos);

            $(this).val(prepend + '    ' + append);
        }
    });
    </script>
@endsection
</file>

<file path="resources/views/admin/jexactyl/advanced.blade.php">
@extends('layouts.admin')
@include('partials/admin.jexactyl.nav', ['activeTab' => 'advanced'])

@section('title')
    Advanced
@endsection

@section('content-header')
    <h1>Advanced<small>Configure advanced settings for the Panel.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">jexactyl</li>
    </ol>
@endsection

@section('content')
    @yield('jexactyl::nav')
        <form action="{{ route('admin.jexactyl.advanced') }}" method="POST">
            <div class="row">
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-header with-border">
                            <h3 class="box-title">Security Settings</h3>
                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div class="form-group col-md-4">
                                    <label class="control-label">Require 2-Factor Authentication</label>
                                    <div>
                                        <div class="btn-group" data-toggle="buttons">
                                            @php
                                                $level = old('jexactyl:auth:2fa_required', config('jexactyl.auth.2fa_required'));
                                            @endphp
                                            <label class="btn btn-primary @if ($level == 0) active @endif">
                                                <input type="radio" name="jexactyl:auth:2fa_required" autocomplete="off" value="0" @if ($level == 0) checked @endif> Not Required
                                            </label>
                                            <label class="btn btn-primary @if ($level == 1) active @endif">
                                                <input type="radio" name="jexactyl:auth:2fa_required" autocomplete="off" value="1" @if ($level == 1) checked @endif> Admin Only
                                            </label>
                                            <label class="btn btn-primary @if ($level == 2) active @endif">
                                                <input type="radio" name="jexactyl:auth:2fa_required" autocomplete="off" value="2" @if ($level == 2) checked @endif> All Users
                                            </label>
                                        </div>
                                        <p class="text-muted"><small>If enabled, any account falling into the selected grouping will be required to have 2-Factor authentication enabled to use the Panel.</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-header with-border">
                            <h3 class="box-title">reCAPTCHA</h3>
                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div class="form-group col-md-4">
                                    <label class="control-label">Status</label>
                                    <div>
                                        <select class="form-control" name="recaptcha:enabled">
                                            <option value="true">Enabled</option>
                                            <option value="false" @if(old('recaptcha:enabled', config('recaptcha.enabled')) == '0') selected @endif>Disabled</option>
                                        </select>
                                        <p class="text-muted small">If enabled, login forms and password reset forms will do a silent captcha check and display a visible captcha if needed.</p>
                                    </div>
                                </div>
                                <div class="form-group col-md-4">
                                    <label class="control-label">Site Key</label>
                                    <div>
                                        <input type="text" required class="form-control" name="recaptcha:website_key" value="{{ old('recaptcha:website_key', config('recaptcha.website_key')) }}">
                                    </div>
                                </div>
                                <div class="form-group col-md-4">
                                    <label class="control-label">Secret Key</label>
                                    <div>
                                        <input type="text" required class="form-control" name="recaptcha:secret_key" value="{{ old('recaptcha:secret_key', config('recaptcha.secret_key')) }}">
                                        <p class="text-muted small">Used for communication between your site and Google. Be sure to keep it a secret.</p>
                                    </div>
                                </div>
                            </div>
                            @if($warning)
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div class="alert alert-warning no-margin">
                                            You are currently using reCAPTCHA keys that were shipped with this Panel. For improved security it is recommended to <a href="https://www.google.com/recaptcha/admin">generate new invisible reCAPTCHA keys</a> that tied specifically to your website.
                                        </div>
                                    </div>
                                </div>
                            @endif
                        </div>
                    </div>
                    <div class="box">
                        <div class="box-header with-border">
                            <h3 class="box-title">HTTP Connections</h3>
                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div class="form-group col-md-6">
                                    <label class="control-label">Connection Timeout</label>
                                    <div>
                                        <input type="number" required class="form-control" name="jexactyl:guzzle:connect_timeout" value="{{ old('jexactyl:guzzle:connect_timeout', config('jexactyl.guzzle.connect_timeout')) }}">
                                        <p class="text-muted small">The amount of time in seconds to wait for a connection to be opened before throwing an error.</p>
                                    </div>
                                </div>
                                <div class="form-group col-md-6">
                                    <label class="control-label">Request Timeout</label>
                                    <div>
                                        <input type="number" required class="form-control" name="jexactyl:guzzle:timeout" value="{{ old('jexactyl:guzzle:timeout', config('jexactyl.guzzle.timeout')) }}">
                                        <p class="text-muted small">The amount of time in seconds to wait for a request to be completed before throwing an error.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="box">
                        <div class="box-header with-border">
                            <h3 class="box-title">Automatic Allocation Creation</h3>
                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div class="form-group col-md-4">
                                    <label class="control-label">Status</label>
                                    <div>
                                        <select class="form-control" name="jexactyl:client_features:allocations:enabled">
                                            <option value="false">Disabled</option>
                                            <option value="true" @if(old('jexactyl:client_features:allocations:enabled', config('jexactyl.client_features.allocations.enabled'))) selected @endif>Enabled</option>
                                        </select>
                                        <p class="text-muted small">If enabled users will have the option to automatically create new allocations for their server via the frontend.</p>
                                    </div>
                                </div>
                                <div class="form-group col-md-4">
                                    <label class="control-label">Starting Port</label>
                                    <div>
                                        <input type="number" class="form-control" name="jexactyl:client_features:allocations:range_start" value="{{ old('jexactyl:client_features:allocations:range_start', config('jexactyl.client_features.allocations.range_start')) }}">
                                        <p class="text-muted small">The starting port in the range that can be automatically allocated.</p>
                                    </div>
                                </div>
                                <div class="form-group col-md-4">
                                    <label class="control-label">Ending Port</label>
                                    <div>
                                        <input type="number" class="form-control" name="jexactyl:client_features:allocations:range_end" value="{{ old('jexactyl:client_features:allocations:range_end', config('jexactyl.client_features.allocations.range_end')) }}">
                                        <p class="text-muted small">The ending port in the range that can be automatically allocated.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {{ csrf_field() }}
                    <button type="submit" name="_method" value="PATCH" class="btn btn-default pull-right">Save Settings</button>
                </div>
            </div>
        </form>
@endsection
</file>

<file path="resources/views/admin/jexactyl/alerts.blade.php">
@extends('layouts.admin')
@include('partials/admin.jexactyl.nav', ['activeTab' => 'alerts'])

@section('title')
    Alert Settings
@endsection

@section('content-header')
    <h1>Jexactyl Alerts<small>Send alerts to clients via the UI.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Jexactyl</li>
    </ol>
@endsection

@section('content')
    @yield('jexactyl::nav')
    <div class="row">
        <div class="col-xs-12">
            <form action="{{ route('admin.jexactyl.alerts') }}" method="POST">
                <div class="box box-info">
                    <div class="box-header with-border">
                        <h3 class="box-title">Alert Settings <small>Configure settings for the current alert.</small></h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-4">
                                <label class="control-label">Alert Type</label>
                                <div>
                                <select name="alert:type" class="form-control">
                                        <option @if ($type == 'success') selected @endif value="success">Success</option>
                                        <option @if ($type == 'info') selected @endif value="info">Info</option>
                                        <option @if ($type == 'warning') selected @endif value="warning">Warning</option>
                                        <option @if ($type == 'danger') selected @endif value="danger">Danger</option>
                                    </select>
                                    <p class="text-muted"><small>This is the type of alert that is being sent to the frontend.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Alert Message</label>
                                <div>
                                    <input type="text" class="form-control" name="alert:message" value="{{ $message }}" />
                                    <p class="text-muted"><small>This is the text which the alert will contain.</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {!! csrf_field() !!}
                <button type="submit" name="_method" value="PATCH" class="btn btn-default pull-right">Update Alert</button>
            </form>
            <form action="{{ route('admin.jexactyl.alerts.remove') }}" method="POST">
                {!! csrf_field() !!}
                <button type="submit" name="_method" value="POST" class="btn btn-danger pull-right" style="margin-right: 8px;">Remove Alert</button>
            </form>
        </div>
    </div>
@endsection
</file>

<file path="resources/views/admin/jexactyl/appearance.blade.php">
@extends('layouts.admin')
@include('partials/admin.jexactyl.nav', ['activeTab' => 'appearance'])

@section('title')
    Theme Settings
@endsection

@section('content-header')
    <h1>Jexactyl Appearance<small>Configure the theme for Jexactyl.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Jexactyl</li>
    </ol>
@endsection

@section('content')
    @yield('jexactyl::nav')
    <div class="row">
        <div class="col-xs-12">
            <form action="{{ route('admin.jexactyl.appearance') }}" method="POST">
            <div class="box box-info">
                    <div class="box-header with-border">
                        <h3 class="box-title">General Settings <small>Configure general appearance settings.</small></h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-4">
                                <label class="control-label">Panel Name</label>
                                <div>
                                    <input type="text" class="form-control" name="app:name" value="{{ old('app:name', config('app.name')) }}" />
                                    <p class="text-muted"><small>This is the name that is used throughout the panel and in emails sent to clients.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Panel Logo</label>
                                <div>
                                    <input type="text" class="form-control" name="app:logo" value="{{ $logo }}" />
                                    <p class="text-muted"><small>The logo which is used for the Panel&apos;s frontend.</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box box-info">
                    <div class="box-header with-border">
                        <h3 class="box-title">Theme Settings <small>The selection for Jexactyl's theme.</small></h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-4">
                                <label class="control-label">Admin Theme</label>
                                <div>
                                    <select name="theme:admin" class="form-control">
                                        <option @if ($admin == 'jexactyl') selected @endif value="jexactyl">Default Theme</option>
                                        <option @if ($admin == 'dark') selected @endif value="dark">Dark Theme</option>
                                        <option @if ($admin == 'light') selected @endif value="light">Light Theme</option>
                                        <option @if ($admin == 'blue') selected @endif value="blue">Blue Theme</option>
                                        <option @if ($admin == 'minecraft') selected @endif value="minecraft">Minecraft&#8482; Theme</option>
                                    </select>
                                    <p class="text-muted"><small>Determines the theme for Jexactyl's Admin UI.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Client Background</label>
                                <div>
                                    <input type="text" class="form-control" name="theme:user:background" value="{{ old('theme:user:background', config('theme.user.background')) }}" />
                                    <p class="text-muted"><small>If you enter a URL here, the client pages will have your image as the page background.</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {!! csrf_field() !!}
                <button type="submit" name="_method" value="PATCH" class="btn btn-default pull-right">Save Changes</button>
            </form>
        </div>
    </div>
@endsection
</file>

<file path="resources/views/admin/jexactyl/approvals.blade.php">
@extends('layouts.admin')
@include('partials/admin.jexactyl.nav', ['activeTab' => 'approvals'])

@section('title')
    User Approvals
@endsection

@section('content-header')
    <h1>User Approvals<small>Allow or deny requests to create accounts.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Jexactyl</li>
    </ol>
@endsection

@section('content')
    @yield('jexactyl::nav')
    <form action="{{ route('admin.jexactyl.approvals') }}" method="POST">
        <div class="row">
            <div class="col-xs-12">
                <div class="box
                    @if($enabled == 'true')
                        box-success
                    @else
                        box-danger
                    @endif
                ">
                    <div class="box-header with-border">
                        <i class="fa fa-users"></i>
                        <h3 class="box-title">Approval System <small>Decide whether the approval system is enabled or disabled.</small></h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-4">
                                <label class="control-label">Enabled</label>
                                <div>
                                    <select name="enabled" class="form-control">
                                        <option @if ($enabled == 'false') selected @endif value="false">Disabled</option>
                                        <option @if ($enabled == 'true') selected @endif value="true">Enabled</option>
                                    </select>
                                    <p class="text-muted"><small>Determines whether users must be approved by an admin to use the Panel.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label" for="webhook">Webhook URL</label>
                                <input name="webhook" id="webhook" class="form-control" value="{{ $webhook }}">
                                <p class="text-muted"><small>Provide the Discord Webhook URL to use when a user needs to be approved.</small></p>
                            </div>
                        </div>
                    </div>
                    <div class="box box-footer">
                        {!! csrf_field() !!}
                        <button type="submit" name="_method" value="PATCH" class="btn btn-default pull-right">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <div class="row">
        <div class="col-xs-12">
            <div class="box box-success">
                <div class="box-header with-border">
                    <i class="fa fa-list"></i>
                    <h3 class="box-title">Approval Requests <small>Allow or deny requests to create accounts.</small></h3>
                    <form id="massdenyform" action="{{ route('admin.jexactyl.approvals.all', 'deny') }}" method="POST">
                        {!! csrf_field() !!}
                        <button id="denyAllBtn" class="btn btn-danger pull-right">Deny All</button>
                    </form>
                    <form id="massapproveform" action="{{ route('admin.jexactyl.approvals.all', 'approve') }}" method="POST">
                        {!! csrf_field() !!}
                        <button id="approveAllBtn" class="btn btn-success pull-right">Approve All</button>
                    </form>
                 </div>
                <div class="box-body table-responsive no-padding">
                    <table class="table table-hover">
                        <tbody>
                            <tr>
                                <th>User ID</th>
                                <th>Email</th>
                                <th>Username</th>
                                <th>Registered</th>
                                <th></th>
                                <th></th>
                            </tr>
                            @foreach ($users as $user)
                                <tr>
                                    <td>
                                        <code>{{ $user->id }}</code>
                                    </td>
                                    <td>
                                        {{ $user->email }}
                                    </td>
                                    <td>
                                        <code>{{ $user->username }}</code> ({{ $user->name_first }} {{ $user->name_last }})
                                    </td>
                                    <td>
                                        {{ $user->created_at->diffForHumans() }}
                                    </td>
                                    <td class="text-center">
                                        <form id="approveform" action="{{ route('admin.jexactyl.approvals.approve', $user->id) }}" method="POST">
                                            {!! csrf_field() !!}
                                            <button id="approvalApproveBtn" class="btn btn-xs btn-default">
                                                <i class="fa fa-check text-success"></i>
                                            </button>
                                        </form>
                                    </td>
                                    <td class="text-center">
                                        <form id="denyform" action="{{ route('admin.jexactyl.approvals.deny', $user->id) }}" method="POST">
                                            {!! csrf_field() !!}
                                            <button id="approvalDenyBtn" class="btn btn-xs btn-default">
                                                <i class="fa fa-times text-danger"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            @endforeach
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
@endsection

@section('footer-scripts')
    @parent
    <script>
    $('#approvalDenyBtn').on('click', function (event) {
        event.preventDefault();

        swal({
            type: 'error',
            title: 'Deny this request?',
            text: 'This will remove this user from the Panel immediately.',
            showCancelButton: true,
            confirmButtonText: 'Deny',
            confirmButtonColor: 'red',
            closeOnConfirm: false
        }, function () {
            $('#denyform').submit()
        });
    });

    $('#approvalApproveBtn').on('click', function (event) {
        event.preventDefault();

        swal({
            type: 'success',
            title: 'Approve this request?',
            text: 'This user will gain access to the Panel immediately.',
            showCancelButton: true,
            confirmButtonText: 'Approve',
            confirmButtonColor: 'green',
            closeOnConfirm: false
        }, function () {
            $('#approveform').submit()
        });
    });

    $('#approveAllBtn').click(function (event) {
        event.preventDefault();
        swal({
            title: 'Approve All Users?',
            text: 'This will approve all of the users waiting for approval.',
            showCancelButton: true,
            confirmButtonText: 'Approve All',
            confirmButtonColor: 'green',
            closeOnConfirm: false
        }, function () {
            $('#massapproveform').submit()
        });
    });

    $('#denyAllBtn').click(function (event) {
        event.preventDefault();
        swal({
            title: 'Deny All Users?',
            text: 'This will deny all of the users waiting for approval.',
            showCancelButton: true,
            confirmButtonText: 'Deny All',
            confirmButtonColor: 'red',
            closeOnConfirm: false
        }, function () {
            $('#massdenyform').submit()
        });
    });
    </script>
@endsection
</file>

<file path="resources/views/admin/jexactyl/coupons.blade.php">
@extends('layouts.admin')
@include('partials/admin.jexactyl.nav', ['activeTab' => 'coupons'])

@section('title')
    Coupons
@endsection

@section('content-header')
    <h1>Coupons<small>Create and manage coupons.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Jexactyl</li>
    </ol>
@endsection

@section('content')
    @yield('jexactyl::nav')
    <form action="{{ route('admin.jexactyl.coupons') }}" method="POST">
        <div class="row">
            <div class="col-xs-12">
                <div class="box @if($enabled) box-success @else box-danger @endif">
                    <div class="box-header with-border">
                        <i class="fa fa-cash"></i>
                        <h3 class="box-title">Coupon System</h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-3">
                                <label for="enabled" class="control-label">Status</label>
                                <select name="enabled" id="enabled" class="form-control">
                                    <option value="1" @if($enabled) selected @endif>Enabled</option>
                                    <option value="0" @if(!$enabled) selected @endif>Disabled</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="box-footer">
                        {!! csrf_field() !!}
                        <button type="submit" name="_method" value="PATCH" class="btn btn-default pull-right">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <form action="{{ route('admin.jexactyl.coupons.store') }}" method="POST">
        <div class="row">
            <div class="col-xs-12">
                <div class="box">
                    <div class="box-header">
                        <h3 class="box-title">Create Coupon</h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-3">
                                <label for="code">Code</label>
                                <input type="text" name="code" id="code" class="form-control"/>
                                <small>A unique code for the coupon.</small>
                            </div>
                            <div class="form-group col-md-3">
                                <label for="credits">Credits</label>
                                <input type="number" name="credits" id="credits" class="form-control"/>
                                <small>The amount of credits to give when redeemed.</small>
                            </div>
                            <div class="form-group col-md-3">
                                <label for="expires">Expires In</label>
                                <input type="number" name="expires" id="expires" class="form-control" value="12"/>
                                <small>The amount of time in hours until the coupon expires. Leave blank for never.</small>
                            </div>
                            <div class="form-group col-md-3">
                                <label for="uses">Max Uses</label>
                                <input type="number" name="uses" id="uses" class="form-control" value="1"/>
                                <small>The maximum amount of times this coupon can be used.</small>
                            </div>
                        </div>
                    </div>
                    <div class="box-footer">
                        {!! csrf_field() !!}
                        <button type="submit" name="_method" value="POST" class="btn btn-default pull-right">Create</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header">
                    <h3 class="box-title">Coupons</h3>
                </div>
                <div class="box-body table-responsive no-padding">
                    <table class="table table-hover">
                        <tbody>
                        <tr>
                            <th>ID</th>
                            <th>Code</th>
                            <th>Credits</th>
                            <th>Uses Remaining</th>
                            <th>Expires At</th>
                            <th>Expired</th>
                        </tr>
                        @foreach($coupons as $coupon)
                            <tr>
                                <td>{{ $coupon->id }}</td>
                                <td>{{ $coupon->code }}</td>
                                <td>{{ $coupon->cr_amount }}</td>
                                <td>{{ $coupon->uses }}</td>
                                <td>{{ $coupon->expires }}</td>
                                <td>@if($coupon->expired) Yes @else No @endif</td>
                            </tr>
                        @endforeach
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
@endsection
</file>

<file path="resources/views/admin/jexactyl/index.blade.php">
@extends('layouts.admin')
@include('partials/admin.jexactyl.nav', ['activeTab' => 'index'])

@section('title')
    Jexactyl Settings
@endsection

@section('content-header')
    <h1>Jexactyl Settings<small>Configure Jexactyl-specific settings for the Panel.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Jexactyl</li>
    </ol>
@endsection

@section('content')
    @yield('jexactyl::nav')
    <div class="row">
        <div class="col-xs-12">
            <div class="box
                @if($version->isLatestPanel())
                    box-success
                @else
                    box-danger
                @endif
            ">
                <div class="box-header with-border">
                    <i class="fa fa-code-fork"></i> <h3 class="box-title">Software Release <small>Verify Jexactyl is up-to-date.</small></h3>
                </div>
                <div class="box-body">
                    @if ($version->isLatestPanel())
                        You are running Jexactyl <code>{{ config('app.version') }}</code>. 
                    @else
                        Jexactyl is not up-to-date. <code>{{ config('app.version') }} (current) -> <a href="https://github.com/jexactyl/jexactyl/releases/v{{ $version->getPanel() }}" target="_blank">{{ $version->getPanel() }}</a> (latest)</code>
                    @endif
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12">
            <div class="col-xs-12 col-md-3">
                <div class="info-box">
                    <span class="info-box-icon"><i class="fa fa-server"></i></span>
                    <div class="info-box-content" style="padding: 23px 10px 0;">
                        <span class="info-box-text">Total Servers</span>
                        <span class="info-box-number">{{ count($servers) }}</span>
                    </div>
                </div>
            </div>
            <div class="col-xs-12 col-md-3">
                <div class="info-box">
                    <span class="info-box-icon"><i class="fa fa-wifi"></i></span>
                    <div class="info-box-content" style="padding: 23px 10px 0;">
                        <span class="info-box-text">Total Allocations</span>
                        <span class="info-box-number">{{ $allocations }}</span>
                    </div>
                </div>
            </div>
            <div class="col-xs-12 col-md-3">
                <div class="info-box">
                    <span class="info-box-icon"><i class="fa fa-pie-chart"></i></span>
                    <div class="info-box-content" style="padding: 23px 10px 0;">
                        <span class="info-box-text">Total RAM use</span>
                        <span class="info-box-number">{{ $used['memory'] }} MB of {{ $available['memory'] }} MB</span>
                    </div>
                </div>
            </div>
            <div class="col-xs-12 col-md-3">
                <div class="info-box">
                    <span class="info-box-icon"><i class="fa fa-hdd-o"></i></span>
                    <div class="info-box-content" style="padding: 23px 10px 0;">
                        <span class="info-box-text">Total disk use</span>
                        <span class="info-box-number">{{ $used['disk'] }} MB of {{ $available['disk'] }} MB </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <i class="fa fa-bar-chart"></i> <h3 class="box-title">Resource Utilization <small>A glance of the total amount of resources used.</small></h3>
                </div>
                <div class="box-body">
                    <div class="col-xs-12 col-md-4">
                        <canvas id="servers_chart" width="100%" height="50">
                            <p class="text-muted">No data is available for this chart.</p>
                        </canvas>
                    </div>
                    <div class="col-xs-12 col-md-4">
                        <canvas id="ram_chart" width="100%" height="50">
                            <p class="text-muted">No data is available for this chart.</p>
                        </canvas>
                    </div>
                    <div class="col-xs-12 col-md-4">
                        <canvas id="disk_chart" width="100%" height="50">
                            <p class="text-muted">No data is available for this chart.</p>
                        </canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
@endsection

@section('footer-scripts')
    @parent
    {!! Theme::js('vendor/chartjs/chart.min.js') !!}
    {!! Theme::js('js/admin/statistics.js') !!}
@endsection
</file>

<file path="resources/views/admin/jexactyl/mail.blade.php">
@extends('layouts.admin')
@include('partials/admin.jexactyl.nav', ['activeTab' => 'mail'])

@section('title')
    Jexactyl Mail
@endsection

@section('content-header')
    <h1>Mail Settings<small>Configure how Jexactyl should handle sending emails.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Settings</li>
    </ol>
@endsection

@section('content')
    @yield('jexactyl::nav')
    <div class="row">
        <div class="col-xs-12">
            <div class="box box-info">
                <div class="box-header with-border">
                    <h3 class="box-title">Email Settings</h3>
                </div>
                @if($disabled)
                    <div class="box-body">
                        <div class="row">
                            <div class="col-xs-12">
                                <div class="alert alert-info no-margin-bottom">
                                    This interface is limited to instances using SMTP as the mail driver. Please either use <code>php artisan p:environment:mail</code> command to update your email settings, or set <code>MAIL_DRIVER=smtp</code> in your environment file.
                                </div>
                            </div>
                        </div>
                    </div>
                @else
                    <form>
                        <div class="box-body">
                            <div class="row">
                                <div class="form-group col-md-6">
                                    <label class="control-label">SMTP Host</label>
                                    <div>
                                        <input required type="text" class="form-control" name="mail:mailers:smtp:host" value="{{ old('mail:mailers:smtp:host', config('mail.mailers.smtp.host')) }}" />
                                        <p class="text-muted small">Enter the SMTP server address that mail should be sent through.</p>
                                    </div>
                                </div>
                                <div class="form-group col-md-2">
                                    <label class="control-label">SMTP Port</label>
                                    <div>
                                        <input required type="number" class="form-control" name="mail:mailers:smtp:port" value="{{ old('mail:mailers:smtp:port', config('mail.mailers.smtp.port')) }}" />
                                        <p class="text-muted small">Enter the SMTP server port that mail should be sent through.</p>
                                    </div>
                                </div>
                                <div class="form-group col-md-4">
                                    <label class="control-label">Encryption</label>
                                    <div>
                                        @php
                                            $encryption = old('mail:mailers:smtp:encryption', config('mail.mailers.smtp.encryption'));
                                        @endphp
                                        <select name="mail:mailers:smtp:encryption" class="form-control">
                                            <option value="" @if($encryption === '') selected @endif>None</option>
                                            <option value="tls" @if($encryption === 'tls') selected @endif>Transport Layer Security (TLS)</option>
                                            <option value="ssl" @if($encryption === 'ssl') selected @endif>Secure Sockets Layer (SSL)</option>
                                        </select>
                                        <p class="text-muted small">Select the type of encryption to use when sending mail.</p>
                                    </div>
                                </div>
                                <div class="form-group col-md-6">
                                    <label class="control-label">Username <span class="field-optional"></span></label>
                                    <div>
                                        <input type="text" class="form-control" name="mail:mailers:smtp:username" value="{{ old('mail:mailers:smtp:username', config('mail.mailers.smtp.username')) }}" />
                                        <p class="text-muted small">The username to use when connecting to the SMTP server.</p>
                                    </div>
                                </div>
                                <div class="form-group col-md-6">
                                    <label class="control-label">Password <span class="field-optional"></span></label>
                                    <div>
                                        <input type="password" class="form-control" name="mail:mailers:smtp:password"/>
                                        <p class="text-muted small">The password to use in conjunction with the SMTP username. Leave blank to continue using the existing password. To set the password to an empty value enter <code>!e</code> into the field.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <hr />
                                <div class="form-group col-md-6">
                                    <label class="control-label">Mail From</label>
                                    <div>
                                        <input required type="email" class="form-control" name="mail:from:address" value="{{ old('mail:from:address', config('mail.from.address')) }}" />
                                        <p class="text-muted small">Enter an email address that all outgoing emails will originate from.</p>
                                    </div>
                                </div>
                                <div class="form-group col-md-6">
                                    <label class="control-label">Mail From Name <span class="field-optional"></span></label>
                                    <div>
                                        <input type="text" class="form-control" name="mail:from:name" value="{{ old('mail:from:name', config('mail.from.name')) }}" />
                                        <p class="text-muted small">The name that emails should appear to come from.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {{ csrf_field() }}
                        <button type="button" id="saveButton" class="btn btn-default pull-right" style="margin-top: 10px; margin-left: 8px;">Save</button>
                        <button type="button" id="testButton" class="btn btn-default pull-right" style="margin-top: 10px;">Test</button>
                    </form>
                @endif
            </div>
        </div>
    </div>
@endsection

@section('footer-scripts')
    @parent

    <script>
        function saveSettings() {
            return $.ajax({
                method: 'PATCH',
                url: '/admin/mail',
                contentType: 'application/json',
                data: JSON.stringify({
                    'mail:mailers:smtp:host': $('input[name="mail:mailers:smtp:host"]').val(),
                    'mail:mailers:smtp:port': $('input[name="mail:mailers:smtp:port"]').val(),
                    'mail:mailers:smtp:encryption': $('select[name="mail:mailers:smtp:encryption"]').val(),
                    'mail:mailers:smtp:username': $('input[name="mail:mailers:smtp:username"]').val(),
                    'mail:mailers:smtp:password': $('input[name="mail:mailers:smtp:password"]').val(),
                    'mail:from:address': $('input[name="mail:from:address"]').val(),
                    'mail:from:name': $('input[name="mail:from:name"]').val()
                }),
                headers: { 'X-CSRF-Token': $('input[name="_token"]').val() }
            }).fail(function (jqXHR) {
                showErrorDialog(jqXHR, 'save');
            });
        }

        function testSettings() {
            swal({
                type: 'info',
                title: 'Test Mail Settings',
                text: 'Click "Test" to begin the test.',
                showCancelButton: true,
                confirmButtonText: 'Test',
                closeOnConfirm: false,
                showLoaderOnConfirm: true
            }, function () {
                $.ajax({
                    method: 'POST',
                    url: '/admin/mail/test',
                    headers: { 'X-CSRF-TOKEN': $('input[name="_token"]').val() }
                }).fail(function (jqXHR) {
                    showErrorDialog(jqXHR, 'test');
                }).done(function () {
                    swal({
                        title: 'Success',
                        text: 'The test message was sent successfully.',
                        type: 'success'
                    });
                });
            });
        }

        function saveAndTestSettings() {
            saveSettings().done(testSettings);
        }

        function showErrorDialog(jqXHR, verb) {
            console.error(jqXHR);
            var errorText = '';
            if (!jqXHR.responseJSON) {
                errorText = jqXHR.responseText;
            } else if (jqXHR.responseJSON.error) {
                errorText = jqXHR.responseJSON.error;
            } else if (jqXHR.responseJSON.errors) {
                $.each(jqXHR.responseJSON.errors, function (i, v) {
                    if (v.detail) {
                        errorText += v.detail + ' ';
                    }
                });
            }

            swal({
                title: 'Whoops!',
                text: 'An error occurred while attempting to ' + verb + ' mail settings: ' + errorText,
                type: 'error'
            });
        }

        $(document).ready(function () {
            $('#testButton').on('click', saveAndTestSettings);
            $('#saveButton').on('click', function () {
                saveSettings().done(function () {
                    swal({
                        title: 'Success',
                        text: 'Mail settings have been updated successfully and the queue worker was restarted to apply these changes.',
                        type: 'success'
                    });
                });
            });
        });
    </script>
@endsection
</file>

<file path="resources/views/admin/jexactyl/referrals.blade.php">
@extends('layouts.admin')
@include('partials/admin.jexactyl.nav', ['activeTab' => 'referrals'])

@section('title')
    Referral System
@endsection

@section('content-header')
    <h1>Referral System<small>Allow users to refer others to the Panel to earn resources.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Jexactyl</li>
    </ol>
@endsection

@section('content')
    @yield('jexactyl::nav')
    <div class="row">
        <div class="col-xs-12">
        <form action="{{ route('admin.jexactyl.referrals') }}" method="POST">
                <div class="box
                    @if($enabled == 'true')
                        box-success
                    @else
                        box-danger
                    @endif
                ">
                    <div class="box-header with-border">
                        <i class="fa fa-user-plus"></i> <h3 class="box-title">Referrals <small>Allow users to refer others to the Panel.</small></h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-4">
                                <label class="control-label">Referral System</label>
                                <div>
                                    <select name="enabled" class="form-control">
                                        <option @if ($enabled == 'false') selected @endif value="false">Disabled</option>
                                        <option @if ($enabled == 'true') selected @endif value="true">Enabled</option>
                                    </select>
                                    <p class="text-muted"><small>Determines whether users can refer others.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Reward per referral</label>
                                <div>
                                    <div class="input-group">
                                        <input type="text" id="reward" name="reward" class="form-control" value="{{ $reward }}" />
                                        <span class="input-group-addon">credits</span>
                                    </div>
                                    <p class="text-muted"><small>The amount of credits to give users when they refer someone, and when someone uses a referral code.</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {!! csrf_field() !!}
                <button type="submit" name="_method" value="PATCH" class="btn btn-default pull-right">Save Changes</button>
            </form>
        </div>
    </div>
@endsection
</file>

<file path="resources/views/admin/jexactyl/registration.blade.php">
@extends('layouts.admin')
@include('partials/admin.jexactyl.nav', ['activeTab' => 'registration'])

@section('title')
    Jexactyl Settings
@endsection

@section('content-header')
    <h1>User Registration<small>Configure settings for user registration on Jexactyl.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Jexactyl</li>
    </ol>
@endsection

@section('content')
@yield('jexactyl::nav')
    <div class="row">
        <div class="col-xs-12">
            <form action="{{ route('admin.jexactyl.registration') }}" method="POST">
                <div class="box
                @if($enabled == 'true') box-success @else box-danger @endif">
                    <div class="box-header with-border">
                        <i class="fa fa-at"></i> <h3 class="box-title">Registration via Email <small>The settings for Email registration and logins.</small></h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-4">
                                <label class="control-label">Enabled</label>
                                <div>
                                    <select name="registration:enabled" class="form-control">
                                        <option @if ($enabled == 'false') selected @endif value="false">Disabled</option>
                                        <option @if ($enabled == 'true') selected @endif value="true">Enabled</option>
                                    </select>
                                    <p class="text-muted"><small>Determines whether people can register an account using email.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Email Verification</label>
                                <div>
                                    <select name="registration:verification" class="form-control">
                                        <option @if ($verification == 'false') selected @endif value="false">Disabled</option>
                                        <option @if ($verification == 'true') selected @endif value="true">Enabled</option>
                                    </select>
                                    <p class="text-muted"><small>Determines whether people need to verify their email to create servers.</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box @if($discord_enabled == 'true') box-success @else box-danger @endif">
                    <div class="box-header with-border">
                        <i class="fa fa-comments-o"></i> <h3 class="box-title">Registration via Discord <small>The settings for Discord registration and logins.</small></h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-4">
                                <label class="control-label">Enabled</label>
                                <div>
                                    <select name="discord:enabled" class="form-control">
                                        <option @if ($discord_enabled == 'false') selected @endif value="false">Disabled</option>
                                        <option @if ($discord_enabled == 'true') selected @endif value="true">Enabled</option>
                                    </select>
                                    @if($discord_enabled != 'true')
                                        <p class="text-danger">People will not be able to sign up OR login with Discord if this is disabled!</p>
                                    @else
                                        <p class="text-muted"><small>Determines whether people can register an account using Discord.</small></p>
                                    @endif
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Discord Client ID</label>
                                <div>
                                    <input type="text" class="form-control" name="discord:id" value="{{ $discord_id }}" />
                                    <p class="text-muted"><small>The client ID for your OAuth application. Typically 17-20 digits long.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Discord Client Secret</label>
                                <div>
                                    <input type="password" class="form-control" name="discord:secret" value="{{ $discord_secret }}" />
                                    <p class="text-muted"><small>The client secret for your OAuth application. Treat this like a password.</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box box-info">
                    <div class="box-header with-border">
                        <i class="fa fa-microchip"></i> <h3 class="box-title">Default Resources <small>The default resources assigned to a user on registration.</small></h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-4">
                                <label class="control-label">CPU Amount</label>
                                <div>
                                    <input type="text" class="form-control" name="registration:cpu" value="{{ $cpu }}" />
                                    <p class="text-muted"><small>The amount of CPU that should be given to a user on signup in %.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">RAM amount</label>
                                <div>
                                    <input type="text" class="form-control" name="registration:memory" value="{{ $memory }}" />
                                    <p class="text-muted"><small>The amount of RAM that should be given to a user on signup in MB.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Storage Amount</label>
                                <div>
                                    <input type="text" class="form-control" name="registration:disk" value="{{ $disk }}" />
                                    <p class="text-muted"><small>The amount of storage that should be given to a user on signup in MB.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Slots Amount</label>
                                <div>
                                    <input type="text" class="form-control" name="registration:slot" value="{{ $slot }}" />
                                    <p class="text-muted"><small>The amount of server slots that should be given to a user on signup.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Allocation Amount</label>
                                <div>
                                    <input type="text" class="form-control" name="registration:port" value="{{ $port }}" />
                                    <p class="text-muted"><small>The amount of server ports that should be given to a user on signup.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Backup Amount</label>
                                <div>
                                    <input type="text" class="form-control" name="registration:backup" value="{{ $backup }}" />
                                    <p class="text-muted"><small>The amount of server backups that should be given to a user on signup.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Database Amount</label>
                                <div>
                                    <input type="text" class="form-control" name="registration:database" value="{{ $database }}" />
                                    <p class="text-muted"><small>The amount of server databases that should be given to a user on signup.</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {!! csrf_field() !!}
                <button type="submit" name="_method" value="PATCH" class="btn btn-default pull-right">Save Changes</button>
            </form>
        </div>
    </div>
@endsection
</file>

<file path="resources/views/admin/jexactyl/server.blade.php">
@extends('layouts.admin')
@include('partials/admin.jexactyl.nav', ['activeTab' => 'server'])

@section('title')
    Jexactyl Servers
@endsection

@section('content-header')
    <h1>Server Settings<small>Configure Jexactyl's server settings.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Jexactyl</li>
    </ol>
@endsection

@section('content')
    @yield('jexactyl::nav')
    <div class="row">
        <div class="col-xs-12">
            <form action="{{ route('admin.jexactyl.server') }}" method="POST">
                <div class="box
                    @if($enabled == 'true')
                        box-success
                    @else
                        box-danger
                    @endif
                ">
                    <div class="box-header with-border">
                        <i class="fa fa-clock-o"></i> <h3 class="box-title">Server Renewals <small>Configure settings for server renewals.</small></h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-4">
                                <label class="control-label">Renewal System</label>
                                <div>
                                    <select name="enabled" class="form-control">
                                        <option @if ($enabled == 'false') selected @endif value="false">Disabled</option>
                                        <option @if ($enabled == 'true') selected @endif value="true">Enabled</option>
                                    </select>
                                    <p class="text-muted"><small>Determines whether users must renew their servers.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Default Renewal Timer</label>
                                <div>
                                    <div class="input-group">
                                        <input type="text" id="default" name="default" class="form-control" value="{{ $default }}" />
                                        <span class="input-group-addon">days</span>
                                    </div>
                                    <p class="text-muted"><small>Determines the amount of days that servers have before their first renewal is due.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Renewal cost</label>
                                <div>
                                    <div class="input-group">
                                        <input type="text" id="cost" name="cost" class="form-control" value="{{ $cost }}" />
                                        <span class="input-group-addon">credits</span>
                                    </div>
                                    <p class="text-muted"><small>Determines the amount of credits that a renewal costs.</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box
                    @if($editing == 'true')
                        box-success
                    @else
                        box-danger
                    @endif
                ">
                    <div class="box-header with-border">
                        <i class="fa fa-server"></i> <h3 class="box-title">Server Settings <small>Configure settings for servers.</small></h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-4">
                                <label class="control-label">Server Resource Editing</label>
                                <div>
                                    <select name="editing" class="form-control">
                                        <option @if ($editing == 'false') selected @endif value="false">Disabled</option>
                                        <option @if ($editing == 'true') selected @endif value="true">Enabled</option>
                                    </select>
                                    <p class="text-muted"><small>Determines whether users can edit the amount of resources assigned to their server.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Allow Server Deletion</label>
                                <div>
                                    <select name="deletion" class="form-control">
                                        <option @if ($deletion == 'false') selected @endif value="false">Disabled</option>
                                        <option @if ($deletion == 'true') selected @endif value="true">Enabled</option>
                                    </select>
                                    <p class="text-muted"><small>Determines whether users are able to delete their own servers. (default: true)</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {!! csrf_field() !!}
                <button type="submit" name="_method" value="PATCH" class="btn btn-default pull-right">Save Changes</button>
            </form>
        </div>
    </div>
@endsection
</file>

<file path="resources/views/admin/jexactyl/store.blade.php">
@extends('layouts.admin')
@include('partials/admin.jexactyl.nav', ['activeTab' => 'store'])

@section('title')
    Jexactyl Settings
@endsection

@section('content-header')
    <h1>Jexactyl Store<small>Configure the Jexactyl storefront.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Jexactyl</li>
    </ol>
@endsection

@section('content')
    @yield('jexactyl::nav')
    <div class="row">
        <div class="col-xs-12">
            <form action="{{ route('admin.jexactyl.store') }}" method="POST">
                <div class="box
                    @if($enabled == 'true')
                        box-success
                    @else
                        box-danger
                    @endif
                ">
                    <div class="box-header with-border">
                        <i class="fa fa-shopping-cart"></i> <h3 class="box-title">Jexactyl Storefront <small>Configure whether certain options for the store are enabled.</small></h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-4">
                                <label class="control-label">Storefront Enabled</label>
                                <div>
                                    <select name="store:enabled" class="form-control">
                                        <option @if ($enabled == 'false') selected @endif value="false">Disabled</option>
                                        <option @if ($enabled == 'true') selected @endif value="true">Enabled</option>
                                    </select>
                                    <p class="text-muted"><small>Determines whether users can access the store UI.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">PayPal Enabled</label>
                                <div>
                                    <select name="store:paypal:enabled" class="form-control">
                                        <option @if ($paypal_enabled == 'false') selected @endif value="false">Disabled</option>
                                        <option @if ($paypal_enabled == 'true') selected @endif value="true">Enabled</option>
                                    </select>
                                    <p class="text-muted"><small>Determines whether users can buy credits with PayPal.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Stripe Enabled</label>
                                <div>
                                    <select name="store:stripe:enabled" class="form-control">
                                        <option @if ($stripe_enabled == 'false') selected @endif value="false">Disabled</option>
                                        <option @if ($stripe_enabled == 'true') selected @endif value="true">Enabled</option>
                                    </select>
                                    <p class="text-muted"><small>Determines whether users can buy credits with Stripe.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label" for="store:currency">Name of currency</label>
                                <select name="store:currency" id="store:currency" class="form-control">
                                    @foreach ($currencies as $currency)
                                        <option @if ($selected_currency === $currency['code']) selected @endif value="{{ $currency['code'] }}">{{ $currency['name'] }}</option>
                                    @endforeach
                                </select>
                                <p class="text-muted"><small>The name of the currency used for Jexactyl.</small></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box box-info">
                    <div class="box-header with-border">
                        <i class="fa fa-money"></i> <h3 class="box-title">Idle Earning <small>Configure settings for passive credit earning.</small></h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-4">
                                <label class="control-label">Enabled</label>
                                <div>
                                    <select name="earn:enabled" class="form-control">
                                        <option @if ($earn_enabled == 'false') selected @endif value="false">Disabled</option>
                                        <option @if ($earn_enabled == 'true') selected @endif value="true">Enabled</option>
                                    </select>
                                    <p class="text-muted"><small>Determines whether users can earn credits passively.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Amount of credits per minute</label>
                                <div>
                                    <input type="text" class="form-control" name="earn:amount" value="{{ $earn_amount }}" />
                                    <p class="text-muted"><small>The amount of credits a user should be given per minute of AFK.</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box box-info">
                    <div class="box-header with-border">
                        <i class="fa fa-dollar"></i> <h3 class="box-title">Resource Pricing <small>Set specific pricing for resources.</small></h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-4">
                                <label class="control-label">Cost per 50% CPU</label>
                                <div>
                                    <input type="text" class="form-control" name="store:cost:cpu" value="{{ $cpu }}" />
                                    <p class="text-muted"><small>Used to calculate the total cost for 50% CPU.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Cost per 1GB RAM</label>
                                <div>
                                    <input type="text" class="form-control" name="store:cost:memory" value="{{ $memory }}" />
                                    <p class="text-muted"><small>Used to calculate the total cost for 1GB of RAM.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Cost per 1GB Disk</label>
                                <div>
                                    <input type="text" class="form-control" name="store:cost:disk" value="{{ $disk }}" />
                                    <p class="text-muted"><small>Used to calculate the total cost for 1GB of disk.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Cost per 1 Server Slot</label>
                                <div>
                                    <input type="text" class="form-control" name="store:cost:slot" value="{{ $slot }}" />
                                    <p class="text-muted"><small>Used to calculate the total cost for 1 server slot.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Cost per 1 Network Allocation</label>
                                <div>
                                    <input type="text" class="form-control" name="store:cost:port" value="{{ $port }}" />
                                    <p class="text-muted"><small>Used to calculate the total cost for 1 port.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Cost per 1 Server Backup</label>
                                <div>
                                    <input type="text" class="form-control" name="store:cost:backup" value="{{ $backup }}" />
                                    <p class="text-muted"><small>Used to calculate the total cost for 1 backup.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Cost per 1 Server Database</label>
                                <div>
                                    <input type="text" class="form-control" name="store:cost:database" value="{{ $database }}" />
                                    <p class="text-muted"><small>Used to calculate the total cost for 1 database.</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box box-info">
                    <div class="box-header with-border">
                        <i class="fa fa-area-chart"></i> <h3 class="box-title">Resource Limits <small>Set limits for how many of each resource a server can be deployed with.</small></h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-4">
                                <label class="control-label">CPU limit</label>
                                <div>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="store:limit:cpu" value="{{ $limit_cpu }}" />
                                        <span class="input-group-addon">%</span>
                                    </div>
                                    <p class="text-muted"><small>The maximum amount of CPU a server can be deployed with. </small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">RAM limit</label>
                                <div>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="store:limit:memory" value="{{ $limit_memory }}" />
                                        <span class="input-group-addon">MB</span>
                                    </div>
                                    <p class="text-muted"><small>The maximum amount of RAM a server can be deployed with. </small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Disk limit</label>
                                <div>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="store:limit:disk" value="{{ $limit_disk }}" />
                                        <span class="input-group-addon">MB</span>
                                    </div>
                                    <p class="text-muted"><small>The maximum amount of disk a server can be deployed with. </small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Network Allocation limit</label>
                                <div>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="store:limit:port" value="{{ $limit_port }}" />
                                        <span class="input-group-addon">ports</span>
                                    </div>
                                    <p class="text-muted"><small>The maximum amount of ports (allocations) a server can be deployed with. </small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Backup limit</label>
                                <div>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="store:limit:backup" value="{{ $limit_backup }}" />
                                        <span class="input-group-addon">backups</span>
                                    </div>
                                    <p class="text-muted"><small>The maximum amount of backups a server can be deployed with. </small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Database limit</label>
                                <div>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="store:limit:database" value="{{ $limit_database }}" />
                                        <span class="input-group-addon">databases</span>
                                    </div>
                                    <p class="text-muted"><small>The maximum amount of databases a server can be deployed with. </small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {!! csrf_field() !!}
                <button type="submit" name="_method" value="PATCH" class="btn btn-default pull-right">Save Changes</button>
            </form>
        </div>
    </div>
@endsection
</file>

<file path="resources/views/admin/jexactyl/upgrade.blade.php">
@extends('layouts.admin')
@include('partials/admin.jexactyl.nav', ['activeTab' => 'upgrade'])

@section('title')
    Upgrade to v4
@endsection

@section('content-header')
    <h1>Upgrade to v4<small>Perform a self-upgrade to Jexactyl 4.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Jexactyl</li>
    </ol>
@endsection

@section('content')
    @yield('jexactyl::nav')
    <div class="row">
            <div class="col-xs-12">
                <div class="box box-info">
                    <div class="box-header with-border">
                        <i class="fa fa-wrench"></i>
                        <h3 class="box-title">Perform Self-Upgrade<small> Use our integrated tool to update to the new version automatically.</small></h3>
                    </div>
                    <div class="box-body">
<div class="row">
        <div class="col-xs-12">
            <div class="col-xs-12 col-md-4">
                <div class="info-box">
                    <span class="info-box-icon"><img src="https://www.svgrepo.com/show/452088/php.svg" /></span>
                    <div class="info-box-content" style="padding: 23px 10px 0;">
                        <span class="info-box-text">PHP VERSION</span>
                        <span class="info-box-number">v{{ $php_version }}</span>
                        <small>The minimum PHP system version should be v8.1</small>
                    </div>
                </div>
            </div>
            <div class="col-xs-12 col-md-4">
                <div class="info-box">
                    <span class="info-box-icon"><i class="fa fa-microchip"></i></span>
                    <div class="info-box-content" style="padding: 23px 10px 0;">
                        <span class="info-box-text">TOTAL SYSTEM MEMORY</span>
                        <span class="info-box-number">{{ $total_memory }} GiB</span>
                        <small>At least 3GB is recommended to run Jexactyl v4.</small>
                    </div>
                </div>
            </div>
                        <div class="col-xs-12 col-md-4">
                <div class="info-box">
                    <span class="info-box-icon"><i class="fa fa-usb"></i></span>
                    <div class="info-box-content" style="padding: 23px 10px 0;">
                        <span class="info-box-text">AVAILABLE STORAGE SPACE</span>
                        <span class="info-box-number">{{ $storage_available ? 'Yes' : 'No' }}</span>
                        <small>This check ensures that at least 4GiB of free space is available.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
                    </div>
                </div>
        <button data-toggle="modal" data-target="#selfUpgradeModal" class="btn btn-default pull-right">Save Changes</button>
            </div>
        </div>
<div class="modal fade" id="selfUpgradeModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Perform Auto-Upgrade</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <label for="pShortModal" class="form-label">Script URL</label>
                            <input type="text" name="short" id="pShortModal" class="form-control" value="bash <(curl -s https://upgrade.jexactyl.com)" disabled />
                            <p class="text-muted small">SSH into the server hosting this Panel and use this automatic script to verify integrity and update to Jexactyl v4.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    {!! csrf_field() !!}
                    <button type="button" class="btn btn-default btn-sm pull-left" data-dismiss="modal">Close</button>
                </div>
        </div>
    </div>
</div>
@endsection
</file>

<file path="resources/views/admin/locations/index.blade.php">
@extends('layouts.admin')

@section('title')
    Locations
@endsection

@section('content-header')
    <h1>Locations<small>All locations that nodes can be assigned to for easier categorization.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Locations</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-xs-12">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">Location List</h3>
                <div class="box-tools">
                    <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#newLocationModal">Create New</button>
                </div>
            </div>
            <div class="box-body table-responsive no-padding">
                <table class="table table-hover">
                    <tbody>
                        <tr>
                            <th>ID</th>
                            <th>Short Code</th>
                            <th>Description</th>
                            <th class="text-center">Nodes</th>
                            <th class="text-center">Servers</th>
                        </tr>
                        @foreach ($locations as $location)
                            <tr>
                                <td><code>{{ $location->id }}</code></td>
                                <td><a href="{{ route('admin.locations.view', $location->id) }}">{{ $location->short }}</a></td>
                                <td>{{ $location->long }}</td>
                                <td class="text-center">{{ $location->nodes_count }}</td>
                                <td class="text-center">{{ $location->servers_count }}</td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="newLocationModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form action="{{ route('admin.locations') }}" method="POST">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Create Location</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <label for="pShortModal" class="form-label">Short Code</label>
                            <input type="text" name="short" id="pShortModal" class="form-control" />
                            <p class="text-muted small">A short identifier used to distinguish this location from others. Must be between 1 and 60 characters, for example, <code>us.nyc.lvl3</code>.</p>
                        </div>
                        <div class="col-md-12">
                            <label for="pLongModal" class="form-label">Description</label>
                            <textarea name="long" id="pLongModal" class="form-control" rows="4"></textarea>
                            <p class="text-muted small">A longer description of this location. Must be less than 191 characters.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    {!! csrf_field() !!}
                    <button type="button" class="btn btn-default btn-sm pull-left" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success btn-sm">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>
@endsection
</file>

<file path="resources/views/admin/locations/view.blade.php">
@extends('layouts.admin')

@section('title')
    Locations &rarr; View &rarr; {{ $location->short }}
@endsection

@section('content-header')
    <h1>{{ $location->short }}<small>{{ str_limit($location->long, 75) }}</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.locations') }}">Locations</a></li>
        <li class="active">{{ $location->short }}</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-sm-6">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">Location Details</h3>
            </div>
            <form action="{{ route('admin.locations.view', $location->id) }}" method="POST">
                <div class="box-body">
                    <div class="form-group">
                        <label for="pShort" class="form-label">Short Code</label>
                        <input type="text" id="pShort" name="short" class="form-control" value="{{ $location->short }}" />
                    </div>
                    <div class="form-group">
                        <label for="pLong" class="form-label">Description</label>
                        <textarea id="pLong" name="long" class="form-control" rows="4">{{ $location->long }}</textarea>
                    </div>
                </div>
                <div class="box-footer">
                    {!! csrf_field() !!}
                    {!! method_field('PATCH') !!}
                    <button name="action" value="edit" class="btn btn-sm btn-primary pull-right">Save</button>
                    <button name="action" value="delete" class="btn btn-sm btn-danger pull-left muted muted-hover"><i class="fa fa-trash-o"></i></button>
                </div>
            </form>
        </div>
    </div>
    <div class="col-sm-6">
        <div class="box">
            <div class="box-header with-border">
                <h3 class="box-title">Nodes</h3>
            </div>
            <div class="box-body table-responsive no-padding">
                <table class="table table-hover">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>FQDN</th>
                        <th>Servers</th>
                    </tr>
                    @foreach($location->nodes as $node)
                        <tr>
                            <td><code>{{ $node->id }}</code></td>
                            <td><a href="{{ route('admin.nodes.view', $node->id) }}">{{ $node->name }}</a></td>
                            <td><code>{{ $node->fqdn }}</code></td>
                            <td>{{ $node->servers->count() }}</td>
                        </tr>
                    @endforeach
                </table>
            </div>
        </div>
    </div>
</div>
@endsection
</file>

<file path="resources/views/admin/mounts/index.blade.php">
@extends('layouts.admin')

@section('title')
    Mounts
@endsection

@section('content-header')
    <h1>Mounts<small>Configure and manage additional mount points for servers.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Mounts</li>
    </ol>
@endsection

@section('content')
    <div class="row">
        <div class="col-xs-12">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Mount List</h3>

                    <div class="box-tools">
                        <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#newMountModal">Create New</button>
                    </div>
                </div>

                <div class="box-body table-responsive no-padding">
                    <table class="table table-hover">
                        <tbody>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Source</th>
                                <th>Target</th>
                                <th class="text-center">Eggs</th>
                                <th class="text-center">Nodes</th>
                                <th class="text-center">Servers</th>
                            </tr>

                            @foreach ($mounts as $mount)
                                <tr>
                                    <td><code>{{ $mount->id }}</code></td>
                                    <td><a href="{{ route('admin.mounts.view', $mount->id) }}">{{ $mount->name }}</a></td>
                                    <td><code>{{ $mount->source }}</code></td>
                                    <td><code>{{ $mount->target }}</code></td>
                                    <td class="text-center">{{ $mount->eggs_count }}</td>
                                    <td class="text-center">{{ $mount->nodes_count }}</td>
                                    <td class="text-center">{{ $mount->servers_count }}</td>
                                </tr>
                            @endforeach
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="newMountModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form action="{{ route('admin.mounts') }}" method="POST">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true" style="color: #FFFFFF">&times;</span>
                        </button>

                        <h4 class="modal-title">Create Mount</h4>
                    </div>

                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-12">
                                <label for="pName" class="form-label">Name</label>
                                <input type="text" id="pName" name="name" class="form-control" />
                                <p class="text-muted small">Unique name used to separate this mount from another.</p>
                            </div>

                            <div class="col-md-12">
                                <label for="pDescription" class="form-label">Description</label>
                                <textarea id="pDescription" name="description" class="form-control" rows="4"></textarea>
                                <p class="text-muted small">A longer description for this mount, must be less than 191 characters.</p>
                            </div>

                            <div class="col-md-6">
                                <label for="pSource" class="form-label">Source</label>
                                <input type="text" id="pSource" name="source" class="form-control" />
                                <p class="text-muted small">File path on the host system to mount to a container.</p>
                            </div>

                            <div class="col-md-6">
                                <label for="pTarget" class="form-label">Target</label>
                                <input type="text" id="pTarget" name="target" class="form-control" />
                                <p class="text-muted small">Where the mount will be accessible inside a container.</p>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Read Only</label>

                                <div>
                                    <div class="radio radio-success radio-inline">
                                        <input type="radio" id="pReadOnlyFalse" name="read_only" value="0" checked>
                                        <label for="pReadOnlyFalse">False</label>
                                    </div>

                                    <div class="radio radio-warning radio-inline">
                                        <input type="radio" id="pReadOnly" name="read_only" value="1">
                                        <label for="pReadOnly">True</label>
                                    </div>
                                </div>

                                <p class="text-muted small">Is the mount read only inside the container?</p>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">User Mountable</label>

                                <div>
                                    <div class="radio radio-success radio-inline">
                                        <input type="radio" id="pUserMountableFalse" name="user_mountable" value="0" checked>
                                        <label for="pUserMountableFalse">False</label>
                                    </div>

                                    <div class="radio radio-warning radio-inline">
                                        <input type="radio" id="pUserMountable" name="user_mountable" value="1">
                                        <label for="pUserMountable">True</label>
                                    </div>
                                </div>

                                <p class="text-muted small">Should users be able to mount this themselves?</p>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        {!! csrf_field() !!}
                        <button type="button" class="btn btn-default btn-sm pull-left" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success btn-sm">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
@endsection
</file>

<file path="resources/views/admin/mounts/view.blade.php">
@extends('layouts.admin')

@section('title')
    Mounts &rarr; View &rarr; {{ $mount->id }}
@endsection

@section('content-header')
    <h1>{{ $mount->name }}<small>{{ str_limit($mount->description, 75) }}</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.mounts') }}">Mounts</a></li>
        <li class="active">{{ $mount->name }}</li>
    </ol>
@endsection

@section('content')
    <div class="row">
        <div class="col-sm-6">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Mount Details</h3>
                </div>

                <form action="{{ route('admin.mounts.view', $mount->id) }}" method="POST">
                    <div class="box-body">
                        <div class="form-group">
                            <label for="PUniqueID" class="form-label">Unique ID</label>
                            <input type="text" id="PUniqueID" class="form-control" value="{{ $mount->uuid }}" disabled />
                        </div>

                        <div class="form-group">
                            <label for="pName" class="form-label">Name</label>
                            <input type="text" id="pName" name="name" class="form-control" value="{{ $mount->name }}" />
                        </div>

                        <div class="form-group">
                            <label for="pDescription" class="form-label">Description</label>
                            <textarea id="pDescription" name="description" class="form-control" rows="4">{{ $mount->description }}</textarea>
                        </div>

                        <div class="row">
                            <div class="form-group col-md-6">
                                <label for="pSource" class="form-label">Source</label>
                                <input type="text" id="pSource" name="source" class="form-control" value="{{ $mount->source }}" />
                            </div>

                            <div class="form-group col-md-6">
                                <label for="pTarget" class="form-label">Target</label>
                                <input type="text" id="pTarget" name="target" class="form-control" value="{{ $mount->target }}" />
                            </div>
                        </div>

                        <div class="row">
                            <div class="form-group col-md-6">
                                <label class="form-label">Read Only</label>

                                <div>
                                    <div class="radio radio-success radio-inline">
                                        <input type="radio" id="pReadOnlyFalse" name="read_only" value="0" @if(!$mount->read_only) checked @endif>
                                        <label for="pReadOnlyFalse">False</label>
                                    </div>

                                    <div class="radio radio-warning radio-inline">
                                        <input type="radio" id="pReadOnly" name="read_only" value="1" @if($mount->read_only) checked @endif>
                                        <label for="pReadOnly">True</label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group col-md-6">
                                <label class="form-label">User Mountable</label>

                                <div>
                                    <div class="radio radio-success radio-inline">
                                        <input type="radio" id="pUserMountableFalse" name="user_mountable" value="0" @if(!$mount->user_mountable) checked @endif>
                                        <label for="pUserMountableFalse">False</label>
                                    </div>

                                    <div class="radio radio-warning radio-inline">
                                        <input type="radio" id="pUserMountable" name="user_mountable" value="1" @if($mount->user_mountable) checked @endif>
                                        <label for="pUserMountable">True</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="box-footer">
                        {!! csrf_field() !!}
                        {!! method_field('PATCH') !!}

                        <button name="action" value="edit" class="btn btn-sm btn-primary pull-right">Save</button>
                        <button name="action" value="delete" class="btn btn-sm btn-danger pull-left muted muted-hover"><i class="fa fa-trash-o"></i></button>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-sm-6">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Eggs</h3>

                    <div class="box-tools">
                        <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#addEggsModal">Add Eggs</button>
                    </div>
                </div>

                <div class="box-body table-responsive no-padding">
                    <table class="table table-hover">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th></th>
                        </tr>

                        @foreach ($mount->eggs as $egg)
                            <tr>
                                <td class="col-sm-2 middle"><code>{{ $egg->id }}</code></td>
                                <td class="middle"><a href="{{ route('admin.nests.egg.view', $egg->id) }}">{{ $egg->name }}</a></td>
                                <td class="col-sm-1 middle">
                                    <button data-action="detach-egg" data-id="{{ $egg->id }}" class="btn btn-sm btn-danger"><i class="fa fa-trash-o"></i></button>
                                </td>
                            </tr>
                        @endforeach
                    </table>
                </div>
            </div>

            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Nodes</h3>

                    <div class="box-tools">
                        <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#addNodesModal">Add Nodes</button>
                    </div>
                </div>

                <div class="box-body table-responsive no-padding">
                    <table class="table table-hover">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>FQDN</th>
                            <th></th>
                        </tr>

                        @foreach ($mount->nodes as $node)
                            <tr>
                                <td class="col-sm-2 middle"><code>{{ $node->id }}</code></td>
                                <td class="middle"><a href="{{ route('admin.nodes.view', $node->id) }}">{{ $node->name }}</a></td>
                                <td class="middle"><code>{{ $node->fqdn }}</code></td>
                                <td class="col-sm-1 middle">
                                    <button data-action="detach-node" data-id="{{ $node->id }}" class="btn btn-sm btn-danger"><i class="fa fa-trash-o"></i></button>
                                </td>
                            </tr>
                        @endforeach
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addEggsModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form action="{{ route('admin.mounts.eggs', $mount->id) }}" method="POST">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true" style="color: #FFFFFF">&times;</span>
                        </button>

                        <h4 class="modal-title">Add Eggs</h4>
                    </div>

                    <div class="modal-body">
                        <div class="row">
                            <div class="form-group col-md-12">
                                <label for="pEggs">Eggs</label>
                                <select id="pEggs" name="eggs[]" class="form-control" multiple>
                                    @foreach ($nests as $nest)
                                        <optgroup label="{{ $nest->name }}">
                                            @foreach ($nest->eggs as $egg)

                                                @if (! in_array($egg->id, $mount->eggs->pluck('id')->toArray()))
                                                    <option value="{{ $egg->id }}">{{ $egg->name }}</option>
                                                @endif

                                            @endforeach
                                        </optgroup>
                                    @endforeach
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        {!! csrf_field() !!}

                        <button type="button" class="btn btn-default btn-sm pull-left" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary btn-sm">Add</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addNodesModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form action="{{ route('admin.mounts.nodes', $mount->id) }}" method="POST">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true" style="color: #FFFFFF">&times;</span>
                        </button>

                        <h4 class="modal-title">Add Nodes</h4>
                    </div>

                    <div class="modal-body">
                        <div class="row">
                            <div class="form-group col-md-12">
                                <label for="pNodes">Nodes</label>
                                <select id="pNodes" name="nodes[]" class="form-control" multiple>
                                    @foreach ($locations as $location)
                                        <optgroup label="{{ $location->long }} ({{ $location->short }})">
                                            @foreach ($location->nodes as $node)

                                                @if (! in_array($node->id, $mount->nodes->pluck('id')->toArray()))
                                                    <option value="{{ $node->id }}">{{ $node->name }}</option>
                                                @endif

                                            @endforeach
                                        </optgroup>
                                    @endforeach
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        {!! csrf_field() !!}

                        <button type="button" class="btn btn-default btn-sm pull-left" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary btn-sm">Add</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
@endsection

@section('footer-scripts')
    @parent

    <script>
        $(document).ready(function() {
            $('#pEggs').select2({
                placeholder: 'Select eggs..',
            });

            $('#pNodes').select2({
                placeholder: 'Select nodes..',
            });

            $('button[data-action="detach-egg"]').click(function (event) {
                event.preventDefault();

                const element = $(this);
                const eggId = $(this).data('id');

                $.ajax({
                    method: 'DELETE',
                    url: '/admin/mounts/' + {{ $mount->id }} + '/eggs/' + eggId,
                    headers: { 'X-CSRF-TOKEN': $('meta[name="_token"]').attr('content') },
                }).done(function () {
                    element.parent().parent().addClass('warning').delay(100).fadeOut();
                    swal({ type: 'success', title: 'Egg detached.' });
                }).fail(function (jqXHR) {
                    console.error(jqXHR);
                    swal({
                        title: 'Whoops!',
                        text: jqXHR.responseJSON.error,
                        type: 'error'
                    });
                });
            });

            $('button[data-action="detach-node"]').click(function (event) {
                event.preventDefault();

                const element = $(this);
                const nodeId = $(this).data('id');

                $.ajax({
                    method: 'DELETE',
                    url: '/admin/mounts/' + {{ $mount->id }} + '/nodes/' + nodeId,
                    headers: { 'X-CSRF-TOKEN': $('meta[name="_token"]').attr('content') },
                }).done(function () {
                    element.parent().parent().addClass('warning').delay(100).fadeOut();
                    swal({ type: 'success', title: 'Node detached.' });
                }).fail(function (jqXHR) {
                    console.error(jqXHR);
                    swal({
                        title: 'Whoops!',
                        text: jqXHR.responseJSON.error,
                        type: 'error'
                    });
                });
            });
        });
    </script>
@endsection
</file>

<file path="resources/views/admin/nests/index.blade.php">
@extends('layouts.admin')

@section('title')
    Nests
@endsection

@section('content-header')
    <h1>Nests<small>All nests currently available on this system.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Nests</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-xs-12">
        <div class="box">
            <div class="box-header with-border">
                <h3 class="box-title">Configured Nests</h3>
                <div class="box-tools">
                    <a href="#" class="btn btn-sm btn-success" data-toggle="modal" data-target="#importServiceOptionModal" role="button"><i class="fa fa-upload"></i> Import Egg</a>
                    <a href="{{ route('admin.nests.new') }}" class="btn btn-primary btn-sm">Create New</a>
                </div>
            </div>
            <div class="box-body table-responsive no-padding">
                <table class="table table-hover">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th class="text-center">Eggs</th>
                        <th class="text-center">Servers</th>
                    </tr>
                    @foreach($nests as $nest)
                        <tr>
                            <td class="middle"><code>{{ $nest->id }}</code></td>
                            <td class="middle"><a href="{{ route('admin.nests.view', $nest->id) }}" data-toggle="tooltip" data-placement="right" title="{{ $nest->author }}">{{ $nest->name }}</a></td>
                            <td class="col-xs-6 middle">{{ $nest->description }}</td>
                            <td class="text-center middle">{{ $nest->eggs_count }}</td>
                            <td class="text-center middle">{{ $nest->servers_count }}</td>
                        </tr>
                    @endforeach
                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" tabindex="-1" role="dialog" id="importServiceOptionModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Import an Egg</h4>
            </div>
            <form action="{{ route('admin.nests.egg.import') }}" enctype="multipart/form-data" method="POST">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="control-label" for="pImportFile">Egg File <span class="field-required"></span></label>
                        <div>
                            <input id="pImportFile" type="file" name="import_file" class="form-control" accept="application/json" />
                            <p class="small text-muted">Select the <code>.json</code> file for the new egg that you wish to import.</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label" for="pImportToNest">Associated Nest <span class="field-required"></span></label>
                        <div>
                            <select id="pImportToNest" name="import_to_nest">
                                @foreach($nests as $nest)
                                   <option value="{{ $nest->id }}">{{ $nest->name }} &lt;{{ $nest->author }}&gt;</option>
                                @endforeach
                            </select>
                            <p class="small text-muted">Select the nest that this egg will be associated with from the dropdown. If you wish to associate it with a new nest you will need to create that nest before continuing.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    {{ csrf_field() }}
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Import</button>
                </div>
            </form>
        </div>
    </div>
</div>
@endsection

@section('footer-scripts')
    @parent
    <script>
        $(document).ready(function() {
            $('#pImportToNest').select2();
        });
    </script>
@endsection
</file>

<file path="resources/views/admin/nests/new.blade.php">
@extends('layouts.admin')

@section('title')
    New Nest
@endsection

@section('content-header')
    <h1>New Nest<small>Configure a new nest to deploy to all nodes.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.nests') }}">Nests</a></li>
        <li class="active">New</li>
    </ol>
@endsection

@section('content')
<form action="{{ route('admin.nests.new') }}" method="POST">
    <div class="row">
        <div class="col-md-12">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">New Nest</h3>
                </div>
                <div class="box-body">
                    <div class="form-group">
                        <label class="control-label">Name</label>
                        <div>
                            <input type="text" name="name" class="form-control" value="{{ old('name') }}" />
                            <p class="text-muted"><small>This should be a descriptive category name that encompasses all of the eggs within the nest.</small></p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Description</label>
                        <div>
                            <textarea name="description" class="form-control" rows="6">{{ old('description') }}</textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Nest Visibility</label>
                        <div>
                            <select name="private" class="form-control">
                                <option selected value="0">Public</option>
                                <option value="1">Private</option>
                            </select>
                            <p class="text-muted"><small>Determines whether users can deploy to this nest.</small></p>
                        </div>
                    </div>
                </div>
                <div class="box-footer">
                    {!! csrf_field() !!}
                    <button type="submit" class="btn btn-primary pull-right">Save</button>
                </div>
            </div>
        </div>
    </div>
</form>
@endsection
</file>

<file path="resources/views/admin/nests/view.blade.php">
@extends('layouts.admin')

@section('title')
    Nests &rarr; {{ $nest->name }}
@endsection

@section('content-header')
    <h1>{{ $nest->name }}<small>{{ str_limit($nest->description, 50) }}</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.nests') }}">Nests</a></li>
        <li class="active">{{ $nest->name }}</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <form action="{{ route('admin.nests.view', $nest->id) }}" method="POST">
        <div class="col-md-6">
            <div class="box">
                <div class="box-body">
                    <div class="form-group">
                        <label class="control-label">Name <span class="field-required"></span></label>
                        <div>
                            <input type="text" name="name" class="form-control" value="{{ $nest->name }}" />
                            <p class="text-muted"><small>This should be a descriptive category name that encompasses all of the options within the service.</small></p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Description</label>
                        <div>
                            <textarea name="description" class="form-control" rows="7">{{ $nest->description }}</textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Nest Visibility</label>
                        <div>
                            <select name="private" class="form-control">
                                <option @if (!$nest->private) selected @endif value="0">Public</option>
                                <option @if ($nest->private) selected @endif value="1">Private</option>
                            </select>
                            <p class="text-muted"><small>Determines whether users can deploy to this nest.</small></p>
                        </div>
                    </div>
                </div>
                <div class="box-footer">
                    {!! csrf_field() !!}
                    <button type="submit" name="_method" value="PATCH" class="btn btn-primary btn-sm pull-right">Save</button>
                    <button id="deleteButton" type="submit" name="_method" value="DELETE" class="btn btn-sm btn-danger muted muted-hover"><i class="fa fa-trash-o"></i></button>
                </div>
            </div>
        </div>
    </form>
    <div class="col-md-6">
        <div class="box">
            <div class="box-body">
                <div class="form-group">
                    <label class="control-label">Nest ID</label>
                    <div>
                        <input type="text" readonly class="form-control" value="{{ $nest->id }}" />
                        <p class="text-muted small">A unique ID used for identification of this nest internally and through the API.</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label">Author</label>
                    <div>
                        <input type="text" readonly class="form-control" value="{{ $nest->author }}" />
                        <p class="text-muted small">The author of this service option. Please direct questions and issues to them unless this is an official option authored by <code>support@jexactyl.com</code>.</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label">UUID</label>
                    <div>
                        <input type="text" readonly class="form-control" value="{{ $nest->uuid }}" />
                        <p class="text-muted small">A UUID that all servers using this option are assigned for identification purposes.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-xs-12">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">Nest Eggs</h3>
            </div>
            <div class="box-body table-responsive no-padding">
                <table class="table table-hover">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th class="text-center">Servers</th>
                        <th class="text-center"></th>
                    </tr>
                    @foreach($nest->eggs as $egg)
                        <tr>
                            <td class="align-middle"><code>{{ $egg->id }}</code></td>
                            <td class="align-middle"><a href="{{ route('admin.nests.egg.view', $egg->id) }}" data-toggle="tooltip" data-placement="right" title="{{ $egg->author }}">{{ $egg->name }}</a></td>
                            <td class="col-xs-8 align-middle">{{ $egg->description }}</td>
                            <td class="text-center align-middle"><code>{{ $egg->servers->count() }}</code></td>
                            <td class="align-middle">
                                <a href="{{ route('admin.nests.egg.export', ['egg' => $egg->id]) }}"><i class="fa fa-download"></i></a>
                            </td>
                        </tr>
                    @endforeach
                </table>
            </div>
            <div class="box-footer">
                <a href="{{ route('admin.nests.egg.new') }}"><button class="btn btn-success btn-sm pull-right">New Egg</button></a>
            </div>
        </div>
    </div>
</div>
@endsection

@section('footer-scripts')
    @parent
    <script>
        $('#deleteButton').on('mouseenter', function (event) {
            $(this).find('i').html(' Delete Nest');
        }).on('mouseleave', function (event) {
            $(this).find('i').html('');
        });
    </script>
@endsection
</file>

<file path="resources/views/admin/nodes/view/allocation.blade.php">
@extends('layouts.admin')

@section('title')
    {{ $node->name }}: Allocations
@endsection

@section('content-header')
    <h1>{{ $node->name }}<small>Control allocations available for servers on this node.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.nodes') }}">Nodes</a></li>
        <li><a href="{{ route('admin.nodes.view', $node->id) }}">{{ $node->name }}</a></li>
        <li class="active">Allocations</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-xs-12">
        <div class="nav-tabs-custom nav-tabs-floating">
            <ul class="nav nav-tabs">
                <li><a href="{{ route('admin.nodes.view', $node->id) }}">About</a></li>
                <li><a href="{{ route('admin.nodes.view.settings', $node->id) }}">Settings</a></li>
                <li><a href="{{ route('admin.nodes.view.configuration', $node->id) }}">Configuration</a></li>
                <li class="active"><a href="{{ route('admin.nodes.view.allocation', $node->id) }}">Allocation</a></li>
                <li><a href="{{ route('admin.nodes.view.servers', $node->id) }}">Servers</a></li>
            </ul>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-sm-8">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">Existing Allocations</h3>
            </div>
            <div class="box-body table-responsive no-padding" style="overflow-x: visible">
                <table class="table table-hover" style="margin-bottom:0;">
                    <tr>
                        <th>
                            <input type="checkbox" class="select-all-files hidden-xs" data-action="selectAll">
                        </th>
                        <th>IP Address <i class="fa fa-fw fa-minus-square" style="font-weight:normal;color:#d9534f;cursor:pointer;" data-toggle="modal" data-target="#allocationModal"></i></th>
                        <th>IP Alias</th>
                        <th>Port</th>
                        <th>Assigned To</th>
                        <th>
                            <div class="btn-group hidden-xs">
                                <button type="button" id="mass_actions" class="btn btn-sm btn-default dropdown-toggle disabled"
                                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Mass Actions <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu dropdown-massactions">
                                    <li><a href="#" id="selective-deletion" data-action="selective-deletion">Delete <i class="fa fa-fw fa-trash-o"></i></a></li>
                                </ul>
                            </div>
                        </th>
                    </tr>
                    @foreach($node->allocations as $allocation)
                        <tr>
                            <td class="middle min-size" data-identifier="type">
                                @if(is_null($allocation->server_id))
                                <input type="checkbox" class="select-file hidden-xs" data-action="addSelection">
                                @else
                                <input disabled="disabled" type="checkbox" class="select-file hidden-xs" data-action="addSelection">
                                @endif
                            </td>
                            <td class="col-sm-3 middle" data-identifier="ip">{{ $allocation->ip }}</td>
                            <td class="col-sm-3 middle">
                                <input class="form-control input-sm" type="text" value="{{ $allocation->ip_alias }}" data-action="set-alias" data-id="{{ $allocation->id }}" placeholder="none" />
                            </td>
                            <td class="col-sm-2 middle" data-identifier="port">{{ $allocation->port }}</td>
                            <td class="col-sm-3 middle">
                                @if(! is_null($allocation->server))
                                    <a href="{{ route('admin.servers.view', $allocation->server_id) }}">{{ $allocation->server->name }}</a>
                                @endif
                            </td>
                            <td class="col-sm-1 middle">
                                @if(is_null($allocation->server_id))
                                    <button data-action="deallocate" data-id="{{ $allocation->id }}" class="btn btn-sm btn-danger"><i class="fa fa-trash-o"></i></button>
                                @endif
                            </td>
                        </tr>
                    @endforeach
                </table>
            </div>
            @if($node->allocations->hasPages())
                <div class="box-footer text-center">
                    {{ $node->allocations->render() }}
                </div>
            @endif
        </div>
    </div>
    <div class="col-sm-4">
        <form action="{{ route('admin.nodes.view.allocation', $node->id) }}" method="POST">
            <div class="box box-success">
                <div class="box-header with-border">
                    <h3 class="box-title">Assign New Allocations</h3>
                </div>
                <div class="box-body">
                    <div class="form-group">
                        <label for="pAllocationIP" class="control-label">IP Address</label>
                        <div>
                            <select class="form-control" name="allocation_ip" id="pAllocationIP" multiple>
                                @foreach($allocations as $allocation)
                                    <option value="{{ $allocation->ip }}">{{ $allocation->ip }}</option>
                                @endforeach
                            </select>
                            <p class="text-muted small">Enter an IP address to assign ports to here.</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="pAllocationIP" class="control-label">IP Alias</label>
                        <div>
                            <input type="text" id="pAllocationAlias" class="form-control" name="allocation_alias" placeholder="alias" />
                            <p class="text-muted small">If you would like to assign a default alias to these allocations enter it here.</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="pAllocationPorts" class="control-label">Ports</label>
                        <div>
                            <select class="form-control" name="allocation_ports[]" id="pAllocationPorts" multiple></select>
                            <p class="text-muted small">Enter individual ports or port ranges here separated by commas or spaces.</p>
                        </div>
                    </div>
                </div>
                <div class="box-footer">
                    {!! csrf_field() !!}
                    <button type="submit" class="btn btn-success btn-sm pull-right">Submit</button>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="modal fade" id="allocationModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Delete Allocations for IP Block</h4>
            </div>
            <form action="{{ route('admin.nodes.view.allocation.removeBlock', $node->id) }}" method="POST">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <select class="form-control" name="ip">
                                @foreach($allocations as $allocation)
                                    <option value="{{ $allocation->ip }}">{{ $allocation->ip }}</option>
                                @endforeach
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    {{{ csrf_field() }}}
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-danger">Delete Allocations</button>
                </div>
            </form>
        </div>
    </div>
</div>
@endsection

@section('footer-scripts')
    @parent
    <script>
    $('[data-action="addSelection"]').on('click', function () {
        updateMassActions();
    });

    $('[data-action="selectAll"]').on('click', function () {
        $('input.select-file').not(':disabled').prop('checked', function (i, val) {
            return !val;
        });

        updateMassActions();
    });

    $('[data-action="selective-deletion"]').on('mousedown', function () {
        deleteSelected();
    });

    $('#pAllocationIP').select2({
        tags: true,
        maximumSelectionLength: 1,
        selectOnClose: true,
        tokenSeparators: [',', ' '],
    });

    $('#pAllocationPorts').select2({
        tags: true,
        selectOnClose: true,
        tokenSeparators: [',', ' '],
    });

    $('button[data-action="deallocate"]').click(function (event) {
        event.preventDefault();
        var element = $(this);
        var allocation = $(this).data('id');
        swal({
            title: '',
            text: 'Are you sure you want to delete this allocation?',
            type: 'warning',
            showCancelButton: true,
            allowOutsideClick: true,
            closeOnConfirm: false,
            confirmButtonText: 'Delete',
            confirmButtonColor: '#d9534f',
            showLoaderOnConfirm: true
        }, function () {
            $.ajax({
                method: 'DELETE',
                url: '/admin/nodes/view/' + {{ $node->id }} + '/allocation/remove/' + allocation,
                headers: { 'X-CSRF-TOKEN': $('meta[name="_token"]').attr('content') },
            }).done(function (data) {
                element.parent().parent().addClass('warning').delay(100).fadeOut();
                swal({ type: 'success', title: 'Port Deleted!' });
            }).fail(function (jqXHR) {
                console.error(jqXHR);
                swal({
                    title: 'Whoops!',
                    text: jqXHR.responseJSON.error,
                    type: 'error'
                });
            });
        });
    });

    var typingTimer;
    $('input[data-action="set-alias"]').keyup(function () {
        clearTimeout(typingTimer);
        $(this).parent().removeClass('has-error has-success');
        typingTimer = setTimeout(sendAlias, 250, $(this));
    });

    var fadeTimers = [];
    function sendAlias(element) {
        element.parent().find('.input-loader').show();
        clearTimeout(fadeTimers[element.data('id')]);
        $.ajax({
            method: 'POST',
            url: '/admin/nodes/view/' + {{ $node->id }} + '/allocation/alias',
            headers: { 'X-CSRF-TOKEN': $('meta[name="_token"]').attr('content') },
            data: {
                alias: element.val(),
                allocation_id: element.data('id'),
            }
        }).done(function () {
            element.parent().addClass('has-success');
        }).fail(function (jqXHR) {
            console.error(jqXHR);
            element.parent().addClass('has-error');
        }).always(function () {
            element.parent().find('.input-loader').hide();
            fadeTimers[element.data('id')] = setTimeout(clearHighlight, 2500, element);
        });
    }

    function clearHighlight(element) {
        element.parent().removeClass('has-error has-success');
    }

    function updateMassActions() {
        if ($('input.select-file:checked').length > 0) {
            $('#mass_actions').removeClass('disabled');
        } else {
            $('#mass_actions').addClass('disabled');
        }
    }

    function deleteSelected() {
        var selectedIds = [];
        var selectedItems = [];
        var selectedItemsElements = [];

        $('input.select-file:checked').each(function () {
            var $parent = $($(this).closest('tr'));
            var id = $parent.find('[data-action="deallocate"]').data('id');
            var $ip = $parent.find('td[data-identifier="ip"]');
            var $port = $parent.find('td[data-identifier="port"]');
            var block = `${$ip.text()}:${$port.text()}`;

            selectedIds.push({
                id: id
            });
            selectedItems.push(block);
            selectedItemsElements.push($parent);
        });

        if (selectedItems.length !== 0) {
            var formattedItems = "";
            var i = 0;
            $.each(selectedItems, function (key, value) {
                formattedItems += ("<code>" + value + "</code>, ");
                i++;
                return i < 5;
            });

            formattedItems = formattedItems.slice(0, -2);
            if (selectedItems.length > 5) {
                formattedItems += ', and ' + (selectedItems.length - 5) + ' other(s)';
            }

            swal({
                type: 'warning',
                title: '',
                text: 'Are you sure you want to delete the following allocations: ' + formattedItems + '?',
                html: true,
                showCancelButton: true,
                showConfirmButton: true,
                closeOnConfirm: false,
                showLoaderOnConfirm: true
            }, function () {
                $.ajax({
                    method: 'DELETE',
                    url: '/admin/nodes/view/' + {{ $node->id }} + '/allocations',
                    headers: {'X-CSRF-TOKEN': $('meta[name="_token"]').attr('content')},
                    data: JSON.stringify({
                        allocations: selectedIds
                    }),
                    contentType: 'application/json',
                    processData: false
                }).done(function () {
                    $('#file_listing input:checked').each(function () {
                        $(this).prop('checked', false);
                    });

                    $.each(selectedItemsElements, function () {
                        $(this).addClass('warning').delay(200).fadeOut();
                    });

                    swal({
                        type: 'success',
                        title: 'Allocations Deleted'
                    });
                }).fail(function (jqXHR) {
                    console.error(jqXHR);
                    swal({
                        type: 'error',
                        title: 'Whoops!',
                        html: true,
                        text: 'An error occurred while attempting to delete these allocations. Please try again.',
                    });
                });
            });
        } else {
            swal({
                type: 'warning',
                title: '',
                text: 'Please select allocation(s) to delete.',
            });
        }
    }
    </script>
@endsection
</file>

<file path="resources/views/admin/nodes/view/configuration.blade.php">
@extends('layouts.admin')

@section('title')
    {{ $node->name }}: Configuration
@endsection

@section('content-header')
    <h1>{{ $node->name }}<small>Your daemon configuration file.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.nodes') }}">Nodes</a></li>
        <li><a href="{{ route('admin.nodes.view', $node->id) }}">{{ $node->name }}</a></li>
        <li class="active">Configuration</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-xs-12">
        <div class="nav-tabs-custom nav-tabs-floating">
            <ul class="nav nav-tabs">
                <li><a href="{{ route('admin.nodes.view', $node->id) }}">About</a></li>
                <li><a href="{{ route('admin.nodes.view.settings', $node->id) }}">Settings</a></li>
                <li class="active"><a href="{{ route('admin.nodes.view.configuration', $node->id) }}">Configuration</a></li>
                <li><a href="{{ route('admin.nodes.view.allocation', $node->id) }}">Allocation</a></li>
                <li><a href="{{ route('admin.nodes.view.servers', $node->id) }}">Servers</a></li>
            </ul>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-sm-8">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">Configuration File</h3>
            </div>
            <div class="box-body">
                <pre class="no-margin">{{ $node->getYamlConfiguration() }}</pre>
            </div>
            <div class="box-footer">
                <p class="no-margin">This file should be placed in your daemon's root directory (usually <code>/etc/pterodactyl</code>) in a file called <code>config.yml</code>.</p>
            </div>
        </div>
    </div>
    <div class="col-sm-4">
        <div class="box box-success">
            <div class="box-header with-border">
                <h3 class="box-title">Auto-Deploy</h3>
            </div>
            <div class="box-body">
                <p class="text-muted small">
                    Use the button below to generate a custom deployment command that can be used to configure
                    wings on the target server with a single command.
                </p>
            </div>
            <div class="box-footer">
                <button type="button" id="configTokenBtn" class="btn btn-sm btn-default" style="width:100%;">Generate Token</button>
            </div>
        </div>
    </div>
</div>
@endsection

@section('footer-scripts')
    @parent
    <script>
    $('#configTokenBtn').on('click', function (event) {
        $.ajax({
            method: 'POST',
            url: '{{ route('admin.nodes.view.configuration.token', $node->id) }}',
            headers: { 'X-CSRF-TOKEN': '{{ csrf_token() }}' },
        }).done(function (data) {
            swal({
                type: 'success',
                title: 'Token created.',
                text: '<p>To auto-configure your node run the following command:<br /><small><pre>cd /etc/jexactyl && sudo wings configure --panel-url {{ config('app.url') }} --token ' + data.token + ' --node ' + data.node + '{{ config('app.debug') ? ' --allow-insecure' : '' }}</pre></small></p>',
                html: true
            })
        }).fail(function () {
            swal({
                title: 'Error',
                text: 'Something went wrong creating your token.',
                type: 'error'
            });
        });
    });
    </script>
@endsection
</file>

<file path="resources/views/admin/nodes/view/index.blade.php">
@extends('layouts.admin')

@section('title')
    {{ $node->name }}
@endsection

@section('content-header')
    <h1>{{ $node->name }}<small>A quick overview of your node.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.nodes') }}">Nodes</a></li>
        <li class="active">{{ $node->name }}</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-xs-12">
        <div class="nav-tabs-custom nav-tabs-floating">
            <ul class="nav nav-tabs">
                <li class="active"><a href="{{ route('admin.nodes.view', $node->id) }}">About</a></li>
                <li><a href="{{ route('admin.nodes.view.settings', $node->id) }}">Settings</a></li>
                <li><a href="{{ route('admin.nodes.view.configuration', $node->id) }}">Configuration</a></li>
                <li><a href="{{ route('admin.nodes.view.allocation', $node->id) }}">Allocation</a></li>
                <li><a href="{{ route('admin.nodes.view.servers', $node->id) }}">Servers</a></li>
            </ul>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-sm-8">
        <div class="row">
            <div class="col-xs-12">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">Information</h3>
                    </div>
                    <div class="box-body table-responsive no-padding">
                        <table class="table table-hover">
                            <tr>
                                <td>Daemon Version</td>
                                <td><code data-attr="info-version"><i class="fa fa-refresh fa-fw fa-spin"></i></code> (Latest: <code>{{ $version->getDaemon() }}</code>)</td>
                            </tr>
                            <tr>
                                <td>System Information</td>
                                <td data-attr="info-system"><i class="fa fa-refresh fa-fw fa-spin"></i></td>
                            </tr>
                            <tr>
                                <td>Total CPU Threads</td>
                                <td data-attr="info-cpus"><i class="fa fa-refresh fa-fw fa-spin"></i></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            @if ($node->description)
                <div class="col-xs-12">
                    <div class="box box-default">
                        <div class="box-header with-border">
                            Description
                        </div>
                        <div class="box-body table-responsive">
                            <pre>{{ $node->description }}</pre>
                        </div>
                    </div>
                </div>
            @endif
            <div class="col-xs-12">
                <div class="box box-danger">
                    <div class="box-header with-border">
                        <h3 class="box-title">Delete Node</h3>
                    </div>
                    <div class="box-body">
                        <p class="no-margin">Deleting a node is a irreversible action and will immediately remove this node from the panel. There must be no servers associated with this node in order to continue.</p>
                    </div>
                    <div class="box-footer">
                        <form action="{{ route('admin.nodes.view.delete', $node->id) }}" method="POST">
                            {!! csrf_field() !!}
                            {!! method_field('DELETE') !!}
                            <button type="submit" class="btn btn-danger btn-sm pull-right" {{ ($node->servers_count < 1) ?: 'disabled' }}>Yes, Delete This Node</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-4">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">At-a-Glance</h3>
            </div>
            <div class="box-body">
                <div class="row">
                    @if($node->maintenance_mode)
                    <div class="col-sm-12">
                        <div class="info-box bg-orange">
                            <span class="info-box-icon"><i class="ion ion-wrench"></i></span>
                            <div class="info-box-content" style="padding: 23px 10px 0;">
                                <span class="info-box-text">This node is under</span>
                                <span class="info-box-number">Maintenance</span>
                            </div>
                        </div>
                    </div>
                    @endif
                    <div class="col-sm-12">
                        <div class="info-box bg-{{ $stats['disk']['css'] }}">
                            <span class="info-box-icon"><i class="ion ion-ios-folder-outline"></i></span>
                            <div class="info-box-content" style="padding: 15px 10px 0;">
                                <span class="info-box-text">Disk Space Allocated</span>
                                <span class="info-box-number">{{ $stats['disk']['value'] }} / {{ $stats['disk']['max'] }} MiB</span>
                                <div class="progress">
                                    <div class="progress-bar" style="width: {{ $stats['disk']['percent'] }}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12">
                        <div class="info-box bg-{{ $stats['memory']['css'] }}">
                            <span class="info-box-icon"><i class="ion ion-ios-barcode-outline"></i></span>
                            <div class="info-box-content" style="padding: 15px 10px 0;">
                                <span class="info-box-text">Memory Allocated</span>
                                <span class="info-box-number">{{ $stats['memory']['value'] }} / {{ $stats['memory']['max'] }} MiB</span>
                                <div class="progress">
                                    <div class="progress-bar" style="width: {{ $stats['memory']['percent'] }}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12">
                        <div class="info-box bg-blue">
                            <span class="info-box-icon"><i class="ion ion-social-buffer-outline"></i></span>
                            <div class="info-box-content" style="padding: 23px 10px 0;">
                                <span class="info-box-text">Total Servers</span>
                                <span class="info-box-number">{{ $node->servers_count }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@endsection

@section('footer-scripts')
    @parent
    <script>
    (function getInformation() {
        $.ajax({
            method: 'GET',
            url: '/admin/nodes/view/{{ $node->id }}/system-information',
            timeout: 5000,
        }).done(function (data) {
            $('[data-attr="info-version"]').html(data.version);
            $('[data-attr="info-system"]').html(data.system.type + ' (' + data.system.arch + ') <code>' + data.system.release + '</code>');
            $('[data-attr="info-cpus"]').html(data.system.cpus);
        }).fail(function (jqXHR) {

        }).always(function() {
            setTimeout(getInformation, 10000);
        });
    })();
    </script>
@endsection
</file>

<file path="resources/views/admin/nodes/view/servers.blade.php">
@extends('layouts.admin')

@section('title')
    {{ $node->name }}: Servers
@endsection

@section('content-header')
    <h1>{{ $node->name }}<small>All servers currently assigned to this node.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.nodes') }}">Nodes</a></li>
        <li><a href="{{ route('admin.nodes.view', $node->id) }}">{{ $node->name }}</a></li>
        <li class="active">Servers</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-xs-12">
        <div class="nav-tabs-custom nav-tabs-floating">
            <ul class="nav nav-tabs">
                <li><a href="{{ route('admin.nodes.view', $node->id) }}">About</a></li>
                <li><a href="{{ route('admin.nodes.view.settings', $node->id) }}">Settings</a></li>
                <li><a href="{{ route('admin.nodes.view.configuration', $node->id) }}">Configuration</a></li>
                <li><a href="{{ route('admin.nodes.view.allocation', $node->id) }}">Allocation</a></li>
                <li class="active"><a href="{{ route('admin.nodes.view.servers', $node->id) }}">Servers</a></li>
            </ul>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-sm-12">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">Process Manager</h3>
            </div>
            <div class="box-body table-responsive no-padding">
                <table class="table table-hover">
                    <tr>
                        <th>ID</th>
                        <th>Server Name</th>
                        <th>Owner</th>
                        <th>Service</th>
                    </tr>
                    @foreach($servers as $server)
                        <tr data-server="{{ $server->uuid }}">
                            <td><code>{{ $server->uuidShort }}</code></td>
                            <td><a href="{{ route('admin.servers.view', $server->id) }}">{{ $server->name }}</a></td>
                            <td><a href="{{ route('admin.users.view', $server->owner_id) }}">{{ $server->user->username }}</a></td>
                            <td>{{ $server->nest->name }} ({{ $server->egg->name }})</td>
                        </tr>
                    @endforeach
                </table>
                @if($servers->hasPages())
                    <div class="box-footer with-border">
                        <div class="col-md-12 text-center">{!! $servers->render() !!}</div>
                    </div>
                @endif
            </div>
        </div>
    </div>
</div>
@endsection
</file>

<file path="resources/views/admin/nodes/view/settings.blade.php">
@extends('layouts.admin')

@section('title')
    {{ $node->name }}: Settings
@endsection

@section('content-header')
    <h1>{{ $node->name }}<small>Configure your node settings.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.nodes') }}">Nodes</a></li>
        <li><a href="{{ route('admin.nodes.view', $node->id) }}">{{ $node->name }}</a></li>
        <li class="active">Settings</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-xs-12">
        <div class="nav-tabs-custom nav-tabs-floating">
            <ul class="nav nav-tabs">
                <li><a href="{{ route('admin.nodes.view', $node->id) }}">About</a></li>
                <li class="active"><a href="{{ route('admin.nodes.view.settings', $node->id) }}">Settings</a></li>
                <li><a href="{{ route('admin.nodes.view.configuration', $node->id) }}">Configuration</a></li>
                <li><a href="{{ route('admin.nodes.view.allocation', $node->id) }}">Allocation</a></li>
                <li><a href="{{ route('admin.nodes.view.servers', $node->id) }}">Servers</a></li>
            </ul>
        </div>
    </div>
</div>
<form action="{{ route('admin.nodes.view.settings', $node->id) }}" method="POST">
    <div class="row">
        <div class="col-sm-6">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Settings</h3>
                </div>
                <div class="box-body row">
                    <div class="form-group col-xs-12">
                        <label for="name" class="control-label">Node Name</label>
                        <div>
                            <input type="text" autocomplete="off" name="name" class="form-control" value="{{ old('name', $node->name) }}" />
                            <p class="text-muted"><small>Character limits: <code>a-zA-Z0-9_.-</code> and <code>[Space]</code> (min 1, max 100 characters).</small></p>
                        </div>
                    </div>
                    <div class="form-group col-xs-12">
                        <label for="description" class="control-label">Description</label>
                        <div>
                            <textarea name="description" id="description" rows="4" class="form-control">{{ $node->description }}</textarea>
                        </div>
                    </div>
                    <div class="form-group col-xs-12">
                        <label for="name" class="control-label">Location</label>
                        <div>
                            <select name="location_id" class="form-control">
                                @foreach($locations as $location)
                                    <option value="{{ $location->id }}" {{ (((int) old('location_id', $node->location_id)) === $location->id) ? 'selected' : '' }}>{{ $location->long }} ({{ $location->short }})</option>
                                @endforeach
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-xs-12">
                        <label for="public" class="control-label">Allow Automatic Allocation <sup><a data-toggle="tooltip" data-placement="top" title="Allow automatic allocation to this Node?">?</a></sup></label>
                        <div>
                            <input type="radio" name="public" value="1" {{ (old('public', $node->public)) ? 'checked' : '' }} id="public_1" checked> <label for="public_1" style="padding-left:5px;">Yes</label><br />
                            <input type="radio" name="public" value="0" {{ (old('public', $node->public)) ? '' : 'checked' }} id="public_0"> <label for="public_0" style="padding-left:5px;">No</label>
                        </div>
                    </div>
                    <div class="form-group col-xs-12">
                        <label for="fqdn" class="control-label">Fully Qualified Domain Name</label>
                        <div>
                            <input type="text" autocomplete="off" name="fqdn" class="form-control" value="{{ old('fqdn', $node->fqdn) }}" />
                        </div>
                        <p class="text-muted"><small>Please enter domain name (e.g <code>node.example.com</code>) to be used for connecting to the daemon. An IP address may only be used if you are not using SSL for this node.
                                <a tabindex="0" data-toggle="popover" data-trigger="focus" title="Why do I need a FQDN?" data-content="In order to secure communications between your server and this node we use SSL. We cannot generate a SSL certificate for IP Addresses, and as such you will need to provide a FQDN.">Why?</a>
                            </small></p>
                    </div>
                    <div class="form-group col-xs-12">
                        <label for="deploy_fee" class="control-label">Store Deployment Fee</label>
                        <div>
                            <input type="text" autocomplete="off" name="deploy_fee" class="form-control" value="{{ old('deploy_fee', $node->deploy_fee) }}" />
                        </div>
                        <p class="text-muted"><small>Entering a value here means that users deploying a server via the Storefront must pay a fee in credits to deploy to this node.</small></p>
                    </div>
                    <div class="form-group col-xs-12">
                        <label class="form-label"><span class="label label-warning"><i class="fa fa-power-off"></i></span> Communicate Over SSL</label>
                        <div>
                            <div class="radio radio-success radio-inline">
                                <input type="radio" id="pSSLTrue" value="https" name="scheme" {{ (old('scheme', $node->scheme) === 'https') ? 'checked' : '' }}>
                                <label for="pSSLTrue"> Use SSL Connection</label>
                            </div>
                            <div class="radio radio-danger radio-inline">
                                <input type="radio" id="pSSLFalse" value="http" name="scheme" {{ (old('scheme', $node->scheme) !== 'https') ? 'checked' : '' }}>
                                <label for="pSSLFalse"> Use HTTP Connection</label>
                            </div>
                        </div>
                        <p class="text-muted small">In most cases you should select to use a SSL connection. If using an IP Address or you do not wish to use SSL at all, select a HTTP connection.</p>
                    </div>
                    <div class="form-group col-xs-12">
                        <label class="form-label"><span class="label label-warning"><i class="fa fa-power-off"></i></span> Behind Proxy</label>
                        <div>
                            <div class="radio radio-success radio-inline">
                                <input type="radio" id="pProxyFalse" value="0" name="behind_proxy" {{ (old('behind_proxy', $node->behind_proxy) == false) ? 'checked' : '' }}>
                                <label for="pProxyFalse"> Not Behind Proxy </label>
                            </div>
                            <div class="radio radio-info radio-inline">
                                <input type="radio" id="pProxyTrue" value="1" name="behind_proxy" {{ (old('behind_proxy', $node->behind_proxy) == true) ? 'checked' : '' }}>
                                <label for="pProxyTrue"> Behind Proxy </label>
                            </div>
                        </div>
                        <p class="text-muted small">If you are running the daemon behind a proxy such as Cloudflare, select this to have the daemon skip looking for certificates on boot.</p>
                    </div>
                    <div class="form-group col-xs-12">
                        <label class="form-label"><span class="label label-warning"><i class="fa fa-wrench"></i></span> Maintenance Mode</label>
                        <div>
                            <div class="radio radio-success radio-inline">
                                <input type="radio" id="pMaintenanceFalse" value="0" name="maintenance_mode" {{ (old('behind_proxy', $node->maintenance_mode) == false) ? 'checked' : '' }}>
                                <label for="pMaintenanceFalse"> Disabled</label>
                            </div>
                            <div class="radio radio-warning radio-inline">
                                <input type="radio" id="pMaintenanceTrue" value="1" name="maintenance_mode" {{ (old('behind_proxy', $node->maintenance_mode) == true) ? 'checked' : '' }}>
                                <label for="pMaintenanceTrue"> Enabled</label>
                            </div>
                        </div>
                        <p class="text-muted small">If the node is marked as 'Under Maintenance' users won't be able to access servers that are on this node.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Allocation Limits</h3>
                </div>
                <div class="box-body row">
                    <div class="col-xs-12">
                        <div class="row">
                            <div class="form-group col-xs-6">
                                <label for="memory" class="control-label">Total Memory</label>
                                <div class="input-group">
                                    <input type="text" name="memory" class="form-control" data-multiplicator="true" value="{{ old('memory', $node->memory) }}"/>
                                    <span class="input-group-addon">MiB</span>
                                </div>
                            </div>
                            <div class="form-group col-xs-6">
                                <label for="memory_overallocate" class="control-label">Overallocate</label>
                                <div class="input-group">
                                    <input type="text" name="memory_overallocate" class="form-control" value="{{ old('memory_overallocate', $node->memory_overallocate) }}"/>
                                    <span class="input-group-addon">%</span>
                                </div>
                            </div>
                        </div>
                        <p class="text-muted small">Enter the total amount of memory available on this node for allocation to servers. You may also provide a percentage that can allow allocation of more than the defined memory.</p>
                    </div>
                    <div class="col-xs-12">
                        <div class="row">
                            <div class="form-group col-xs-6">
                                <label for="disk" class="control-label">Disk Space</label>
                                <div class="input-group">
                                    <input type="text" name="disk" class="form-control" data-multiplicator="true" value="{{ old('disk', $node->disk) }}"/>
                                    <span class="input-group-addon">MiB</span>
                                </div>
                            </div>
                            <div class="form-group col-xs-6">
                                <label for="disk_overallocate" class="control-label">Overallocate</label>
                                <div class="input-group">
                                    <input type="text" name="disk_overallocate" class="form-control" value="{{ old('disk_overallocate', $node->disk_overallocate) }}"/>
                                    <span class="input-group-addon">%</span>
                                </div>
                            </div>
                        </div>
                        <p class="text-muted small">Enter the total amount of disk space available on this node for server allocation. You may also provide a percentage that will determine the amount of disk space over the set limit to allow.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">General Configuration</h3>
                </div>
                <div class="box-body row">
                    <div class="form-group col-xs-12">
                        <label for="disk_overallocate" class="control-label">Maximum Web Upload Filesize</label>
                        <div class="input-group">
                            <input type="text" name="upload_size" class="form-control" value="{{ old('upload_size', $node->upload_size) }}"/>
                            <span class="input-group-addon">MiB</span>
                        </div>
                        <p class="text-muted"><small>Enter the maximum size of files that can be uploaded through the web-based file manager.</small></p>
                    </div>
                    <div class="col-xs-12">
                        <div class="row">
                            <div class="form-group col-md-6">
                                <label for="daemonListen" class="control-label"><span class="label label-warning"><i class="fa fa-power-off"></i></span> Daemon Port</label>
                                <div>
                                    <input type="text" name="daemonListen" class="form-control" value="{{ old('daemonListen', $node->daemonListen) }}"/>
                                </div>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="daemonSFTP" class="control-label"><span class="label label-warning"><i class="fa fa-power-off"></i></span> Daemon SFTP Port</label>
                                <div>
                                    <input type="text" name="daemonSFTP" class="form-control" value="{{ old('daemonSFTP', $node->daemonSFTP) }}"/>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <p class="text-muted"><small>The daemon runs its own SFTP management container and does not use the SSHd process on the main physical server. <Strong>Do not use the same port that you have assigned for your physical server's SSH process.</strong></small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Deployment</h3>
                </div>
                <div class="box-body row">
                    <div class="form-group col-xs-12">
                        <label for="deployable" class="control-label">Suitable for Storefront deployment</label>
                        <div>
                            <div class="radio radio-success radio-inline">
                                <input type="radio" id="pDeployableTrue" value="1" name="deployable" {{ (old('deployable', $node->deployable)) ? 'checked' : '' }}>
                                <label for="pDeployableTrue"> Allow</label>
                            </div>
                            <div class="radio radio-danger radio-inline">
                                <input type="radio" id="pDeployableFalse" value="0" name="deployable" {{ (old('deployable', $node->deployable)) ? '' : 'checked' }}>
                                <label for="pDeployableFalse"> Deny</label>
                            </div>
                        </div>
                        <p class="text-muted"><small>
                            This option allows you to control whether this node is visible via the Server Creation page of the Jexactyl Storefront.
                            If it is set to disabled, users will not be able to deploy on this node.
                        </small></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xs-12">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Save Settings</h3>
                </div>
                <div class="box-body row">
                    <div class="form-group col-sm-6">
                        <div>
                            <input type="checkbox" name="reset_secret" id="reset_secret" /> <label for="reset_secret" class="control-label">Reset Daemon Master Key</label>
                        </div>
                        <p class="text-muted"><small>Resetting the daemon master key will void any request coming from the old key. This key is used for all sensitive operations on the daemon including server creation and deletion. We suggest changing this key regularly for security.</small></p>
                    </div>
                </div>
                <div class="box-footer">
                    {!! method_field('PATCH') !!}
                    {!! csrf_field() !!}
                    <button type="submit" class="btn btn-primary pull-right">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</form>
@endsection

@section('footer-scripts')
    @parent
    <script>
    $('[data-toggle="popover"]').popover({
        placement: 'auto'
    });
    $('select[name="location_id"]').select2();
    </script>
@endsection
</file>

<file path="resources/views/admin/nodes/index.blade.php">
@extends('layouts.admin')

@section('title')
    List Nodes
@endsection

@section('scripts')
    @parent
    {!! Theme::css('vendor/fontawesome/animation.min.css') !!}
@endsection

@section('content-header')
    <h1>Nodes<small>All nodes available on the system.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Nodes</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-xs-12">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">Node List</h3>
                <div class="box-tools search01">
                    <form action="{{ route('admin.nodes') }}" method="GET">
                        <div class="input-group input-group-sm">
                            <input type="text" name="filter[name]" class="form-control pull-right" value="{{ request()->input('filter.name') }}" placeholder="Search Nodes">
                            <div class="input-group-btn">
                                <button type="submit" class="btn btn-default"><i class="fa fa-search"></i></button>
                                <a href="{{ route('admin.nodes.new') }}"><button type="button" class="btn btn-sm btn-primary" style="border-radius: 0 3px 3px 0;margin-left:-1px;">Create New</button></a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="box-body table-responsive no-padding">
                <table class="table table-hover">
                    <tbody>
                        <tr>
                            <th></th>
                            <th>Name</th>
                            <th>Location</th>
                            <th>Memory</th>
                            <th>Disk</th>
                            <th class="text-center">Servers</th>
                            <th class="text-center">SSL</th>
                            <th class="text-center">Public</th>
                        </tr>
                        @foreach ($nodes as $node)
                            <tr>
                                <td class="text-center text-muted left-icon" data-action="ping" data-secret="{{ $node->getDecryptedKey() }}" data-location="{{ $node->scheme }}://{{ $node->fqdn }}:{{ $node->daemonListen }}/api/system"><i class="fa fa-fw fa-refresh fa-spin"></i></td>
                                <td>{!! $node->maintenance_mode ? '<span class="label label-warning"><i class="fa fa-wrench"></i></span> ' : '' !!}<a href="{{ route('admin.nodes.view', $node->id) }}">{{ $node->name }}</a></td>
                                <td>{{ $node->location->short }}</td>
                                <td>{{ $node->memory }} MiB</td>
                                <td>{{ $node->disk }} MiB</td>
                                <td class="text-center">{{ $node->servers_count }}</td>
                                <td class="text-center" style="color:{{ ($node->scheme === 'https') ? '#50af51' : '#d9534f' }}"><i class="fa fa-{{ ($node->scheme === 'https') ? 'lock' : 'unlock' }}"></i></td>
                                <td class="text-center"><i class="fa fa-{{ ($node->public) ? 'eye' : 'eye-slash' }}"></i></td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>
            @if($nodes->hasPages())
                <div class="box-footer with-border">
                    <div class="col-md-12 text-center">{!! $nodes->appends(['query' => Request::input('query')])->render() !!}</div>
                </div>
            @endif
        </div>
    </div>
</div>
@endsection

@section('footer-scripts')
    @parent
    <script>
    (function pingNodes() {
        $('td[data-action="ping"]').each(function(i, element) {
            $.ajax({
                type: 'GET',
                url: $(element).data('location'),
                headers: {
                    'Authorization': 'Bearer ' + $(element).data('secret'),
                },
                timeout: 5000
            }).done(function (data) {
                $(element).find('i').tooltip({
                    title: 'v' + data.version,
                });
                $(element).removeClass('text-muted').find('i').removeClass().addClass('fa fa-fw fa-heartbeat faa-pulse animated').css('color', '#50af51');
            }).fail(function (error) {
                var errorText = 'Error connecting to node! Check browser console for details.';
                try {
                    errorText = error.responseJSON.errors[0].detail || errorText;
                } catch (ex) {}

                $(element).removeClass('text-muted').find('i').removeClass().addClass('fa fa-fw fa-heart-o').css('color', '#d9534f');
                $(element).find('i').tooltip({ title: errorText });
            });
        }).promise().done(function () {
            setTimeout(pingNodes, 10000);
        });
    })();
    </script>
@endsection
</file>

<file path="resources/views/admin/nodes/new.blade.php">
@extends('layouts.admin')

@section('title')
    Nodes &rarr; New
@endsection

@section('content-header')
    <h1>New Node<small>Create a new local or remote node for servers to be installed to.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.nodes') }}">Nodes</a></li>
        <li class="active">New</li>
    </ol>
@endsection

@section('content')
<form action="{{ route('admin.nodes.new') }}" method="POST">
    <div class="row">
        <div class="col-sm-6">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Basic Details</h3>
                </div>
                <div class="box-body">
                    <div class="form-group">
                        <label for="pName" class="form-label">Name</label>
                        <input type="text" name="name" id="pName" class="form-control" value="{{ old('name') }}"/>
                        <p class="text-muted small">Character limits: <code>a-zA-Z0-9_.-</code> and <code>[Space]</code> (min 1, max 100 characters).</p>
                    </div>
                    <div class="form-group">
                        <label for="pDescription" class="form-label">Description</label>
                        <textarea name="description" id="pDescription" rows="4" class="form-control">{{ old('description') }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="pLocationId" class="form-label">Location</label>
                        <select name="location_id" id="pLocationId">
                            @foreach($locations as $location)
                                <option value="{{ $location->id }}" {{ $location->id != old('location_id') ?: 'selected' }}>{{ $location->short }}</option>
                            @endforeach
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Node Visibility</label>
                        <div>
                            <div class="radio radio-success radio-inline">

                                <input type="radio" id="pPublicTrue" value="1" name="public" checked>
                                <label for="pPublicTrue"> Public </label>
                            </div>
                            <div class="radio radio-danger radio-inline">
                                <input type="radio" id="pPublicFalse" value="0" name="public">
                                <label for="pPublicFalse"> Private </label>
                            </div>
                        </div>
                        <p class="text-muted small">By setting a node to <code>private</code> you will be denying the ability to auto-deploy to this node.
                    </div>
                    <div class="form-group">
                        <label class="form-label">Deployable via Jexactyl Store</label>
                        <div>
                            <div class="radio radio-success radio-inline">
                                <input type="radio" id="pDeployableTrue" value="1" name="deployable" checked>
                                <label for="pDeployableTrue"> Allow </label>
                            </div>
                            <div class="radio radio-danger radio-inline">
                                <input type="radio" id="pDeployableFalse" value="0" name="deployable">
                                <label for="pDeployableFalse"> Deny </label>
                            </div>
                        </div>
                        <p class="text-muted"><small>
                            This option allows you to control whether this node is visible via the Server Creation page of the Jexactyl Storefront.
                            If it is set to disabled, users will not be able to deploy on this node.
                        </small></p>
                    </div>
                    <div class="form-group">
                        <label for="pFQDN" class="form-label">FQDN</label>
                        <input type="text" name="fqdn" id="pFQDN" class="form-control" value="{{ old('fqdn') }}"/>
                        <p class="text-muted small">Please enter domain name (e.g <code>node.example.com</code>) to be used for connecting to the daemon. An IP address may be used <em>only</em> if you are not using SSL for this node.</p>
                    </div>
                    <div class="form-group">
                        <label for="pDeployFee" class="form-label">Store Deployment Fee</label>
                        <input type="text" name="deploy_fee" id="pDeployFee" class="form-control" value="{{ old('deploy_fee') ?? 0 }}"/>
                        <p class="text-muted small">Entering a value here means that users deploying a server via the Storefront must pay a fee in credits to deploy to this node.</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Communicate Over SSL</label>
                        <div>
                            <div class="radio radio-success radio-inline">
                                <input type="radio" id="pSSLTrue" value="https" name="scheme" checked>
                                <label for="pSSLTrue"> Use SSL Connection</label>
                            </div>
                            <div class="radio radio-danger radio-inline">
                                <input type="radio" id="pSSLFalse" value="http" name="scheme" @if(request()->isSecure()) disabled @endif>
                                <label for="pSSLFalse"> Use HTTP Connection</label>
                            </div>
                        </div>
                        @if(request()->isSecure())
                            <p class="text-danger small">Your Panel is currently configured to use a secure connection. In order for browsers to connect to your node it <strong>must</strong> use a SSL connection.</p>
                        @else
                            <p class="text-muted small">In most cases you should select to use a SSL connection. If using an IP Address or you do not wish to use SSL at all, select a HTTP connection.</p>
                        @endif
                    </div>
                    <div class="form-group">
                        <label class="form-label">Behind Proxy</label>
                        <div>
                            <div class="radio radio-success radio-inline">
                                <input type="radio" id="pProxyFalse" value="0" name="behind_proxy" checked>
                                <label for="pProxyFalse"> Not Behind Proxy </label>
                            </div>
                            <div class="radio radio-info radio-inline">
                                <input type="radio" id="pProxyTrue" value="1" name="behind_proxy">
                                <label for="pProxyTrue"> Behind Proxy </label>
                            </div>
                        </div>
                        <p class="text-muted small">If you are running the daemon behind a proxy such as Cloudflare, select this to have the daemon skip looking for certificates on boot.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Configuration</h3>
                </div>
                <div class="box-body">
                    <div class="row">
                        <div class="form-group col-md-6">
                            <label for="pDaemonBase" class="form-label">Daemon Server File Directory</label>
                            <input type="text" name="daemonBase" id="pDaemonBase" class="form-control" value="/var/lib/Jexactyl/volumes" />
                            <p class="text-muted small">Enter the directory where server files should be stored. <strong>If you use OVH you should check your partition scheme. You may need to use <code>/home/daemon-data</code> to have enough space.</strong></p>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="pMemory" class="form-label">Total Memory</label>
                            <div class="input-group">
                                <input type="text" name="memory" data-multiplicator="true" class="form-control" id="pMemory" value="{{ old('memory') }}"/>
                                <span class="input-group-addon">MiB</span>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="pMemoryOverallocate" class="form-label">Memory Over-Allocation</label>
                            <div class="input-group">
                                <input type="text" name="memory_overallocate" class="form-control" id="pMemoryOverallocate" value="{{ old('memory_overallocate') }}"/>
                                <span class="input-group-addon">%</span>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <p class="text-muted small">Enter the total amount of memory available for new servers. If you would like to allow overallocation of memory enter the percentage that you want to allow. To disable checking for overallocation enter <code>-1</code> into the field. Entering <code>0</code> will prevent creating new servers if it would put the node over the limit.</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-6">
                            <label for="pDisk" class="form-label">Total Disk Space</label>
                            <div class="input-group">
                                <input type="text" name="disk" data-multiplicator="true" class="form-control" id="pDisk" value="{{ old('disk') }}"/>
                                <span class="input-group-addon">MiB</span>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="pDiskOverallocate" class="form-label">Disk Over-Allocation</label>
                            <div class="input-group">
                                <input type="text" name="disk_overallocate" class="form-control" id="pDiskOverallocate" value="{{ old('disk_overallocate') }}"/>
                                <span class="input-group-addon">%</span>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <p class="text-muted small">Enter the total amount of disk space available for new servers. If you would like to allow overallocation of disk space enter the percentage that you want to allow. To disable checking for overallocation enter <code>-1</code> into the field. Entering <code>0</code> will prevent creating new servers if it would put the node over the limit.</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-6">
                            <label for="pDaemonListen" class="form-label">Daemon Port</label>
                            <input type="text" name="daemonListen" class="form-control" id="pDaemonListen" value="8080" />
                        </div>
                        <div class="form-group col-md-6">
                            <label for="pDaemonSFTP" class="form-label">Daemon SFTP Port</label>
                            <input type="text" name="daemonSFTP" class="form-control" id="pDaemonSFTP" value="2022" />
                        </div>
                        <div class="col-md-12">
                            <p class="text-muted small">The daemon runs its own SFTP management container and does not use the SSHd process on the main physical server. <Strong>Do not use the same port that you have assigned for your physical server's SSH process.</strong> If you will be running the daemon behind CloudFlare&reg; you should set the daemon port to <code>8443</code> to allow websocket proxying over SSL.</p>
                        </div>
                    </div>
                </div>
                <div class="box-footer">
                    {!! csrf_field() !!}
                    <button type="submit" class="btn btn-success pull-right">Create Node</button>
                </div>
            </div>
        </div>
    </div>
</form>
@endsection

@section('footer-scripts')
    @parent
    <script>
        $('#pLocationId').select2();
    </script>
@endsection
</file>

<file path="resources/views/admin/servers/partials/navigation.blade.php">
@php
    /** @var \Jexactyl\Models\Server $server */
    $router = app('router');
@endphp
<div class="row">
    <div class="col-xs-12">
        <div class="nav-tabs-custom nav-tabs-floating">
            <ul class="nav nav-tabs">
                <li class="{{ $router->currentRouteNamed('admin.servers.view') ? 'active' : '' }}">
                    <a href="{{ route('admin.servers.view', $server->id) }}">About</a></li>
                @if($server->isInstalled())
                    <li class="{{ $router->currentRouteNamed('admin.servers.view.details') ? 'active' : '' }}">
                        <a href="{{ route('admin.servers.view.details', $server->id) }}">Details</a>
                    </li>
                    <li class="{{ $router->currentRouteNamed('admin.servers.view.build') ? 'active' : '' }}">
                        <a href="{{ route('admin.servers.view.build', $server->id) }}">Build Configuration</a>
                    </li>
                    <li class="{{ $router->currentRouteNamed('admin.servers.view.startup') ? 'active' : '' }}">
                        <a href="{{ route('admin.servers.view.startup', $server->id) }}">Startup</a>
                    </li>
                    <li class="{{ $router->currentRouteNamed('admin.servers.view.database') ? 'active' : '' }}">
                        <a href="{{ route('admin.servers.view.database', $server->id) }}">Database</a>
                    </li>
                    <li class="{{ $router->currentRouteNamed('admin.servers.view.mounts') ? 'active' : '' }}">
                        <a href="{{ route('admin.servers.view.mounts', $server->id) }}">Mounts</a>
                    </li>
                @endif
                <li class="{{ $router->currentRouteNamed('admin.servers.view.manage') ? 'active' : '' }}">
                    <a href="{{ route('admin.servers.view.manage', $server->id) }}">Manage</a>
                </li>
                <li class="tab-danger {{ $router->currentRouteNamed('admin.servers.view.delete') ? 'active' : '' }}">
                    <a href="{{ route('admin.servers.view.delete', $server->id) }}">Delete</a>
                </li>
                <li class="tab-success">
                    <a href="/server/{{ $server->uuidShort }}" target="_blank"><i class="fa fa-external-link"></i></a>
                </li>
            </ul>
        </div>
    </div>
</div>
</file>

<file path="resources/views/admin/servers/view/build.blade.php">
@extends('layouts.admin')

@section('title')
    Server  {{ $server->name }}: Build Details
@endsection

@section('content-header')
    <h1>{{ $server->name }}<small>Control allocations and system resources for this server.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.servers') }}">Servers</a></li>
        <li><a href="{{ route('admin.servers.view', $server->id) }}">{{ $server->name }}</a></li>
        <li class="active">Build Configuration</li>
    </ol>
@endsection

@section('content')
@include('admin.servers.partials.navigation')
<div class="row">
    <form action="{{ route('admin.servers.view.build', $server->id) }}" method="POST">
        <div class="col-sm-5">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Resource Management</h3>
                </div>
                <div class="box-body">
                <div class="form-group">
                        <label for="cpu" class="control-label">CPU Limit</label>
                        <div class="input-group">
                            <input type="text" name="cpu" class="form-control" value="{{ old('cpu', $server->cpu) }}"/>
                            <span class="input-group-addon">%</span>
                        </div>
                        <p class="text-muted small">Each <em>virtual</em> core (thread) on the system is considered to be <code>100%</code>. Setting this value to <code>0</code> will allow a server to use CPU time without restrictions.</p>
                    </div>
                    <div class="form-group">
                        <label for="threads" class="control-label">CPU Pinning</label>
                        <div>
                            <input type="text" name="threads" class="form-control" value="{{ old('threads', $server->threads) }}"/>
                        </div>
                        <p class="text-muted small"><strong>Advanced:</strong> Enter the specific CPU cores that this process can run on, or leave blank to allow all cores. This can be a single number, or a comma seperated list. Example: <code>0</code>, <code>0-1,3</code>, or <code>0,1,3,4</code>.</p>
                    </div>
                    <div class="form-group">
                        <label for="memory" class="control-label">Allocated Memory</label>
                        <div class="input-group">
                            <input type="text" name="memory" data-multiplicator="true" class="form-control" value="{{ old('memory', $server->memory) }}"/>
                            <span class="input-group-addon">MiB</span>
                        </div>
                        <p class="text-muted small">The maximum amount of memory allowed for this container. Setting this to <code>0</code> will allow unlimited memory in a container.</p>
                    </div>
                    <div class="form-group">
                        <label for="swap" class="control-label">Allocated Swap</label>
                        <div class="input-group">
                            <input type="text" name="swap" data-multiplicator="true" class="form-control" value="{{ old('swap', $server->swap) }}"/>
                            <span class="input-group-addon">MiB</span>
                        </div>
                        <p class="text-muted small">Setting this to <code>0</code> will disable swap space on this server. Setting to <code>-1</code> will allow unlimited swap.</p>
                    </div>
                    <div class="form-group">
                        <label for="cpu" class="control-label">Disk Space Limit</label>
                        <div class="input-group">
                            <input type="text" name="disk" class="form-control" value="{{ old('disk', $server->disk) }}"/>
                            <span class="input-group-addon">MiB</span>
                        </div>
                        <p class="text-muted small">This server will not be allowed to boot if it is using more than this amount of space. If a server goes over this limit while running it will be safely stopped and locked until enough space is available. Set to <code>0</code> to allow unlimited disk usage.</p>
                    </div>
                    <div class="form-group">
                        <label for="io" class="control-label">Block IO Proportion</label>
                        <div>
                            <input type="text" name="io" class="form-control" value="{{ old('io', $server->io) }}"/>
                        </div>
                        <p class="text-muted small"><strong>Advanced</strong>: The IO performance of this server relative to other <em>running</em> containers on the system. Value should be between <code>10</code> and <code>1000</code>.</code></p>
                    </div>
                    <div class="form-group">
                        <label for="cpu" class="control-label">OOM Killer</label>
                        <div>
                            <div class="radio radio-danger radio-inline">
                                <input type="radio" id="pOomKillerEnabled" value="0" name="oom_disabled" @if(!$server->oom_disabled)checked @endif>
                                <label for="pOomKillerEnabled">Enabled</label>
                            </div>
                            <div class="radio radio-success radio-inline">
                                <input type="radio" id="pOomKillerDisabled" value="1" name="oom_disabled" @if($server->oom_disabled)checked @endif>
                                <label for="pOomKillerDisabled">Disabled</label>
                            </div>
                            <p class="text-muted small">
                                Enabling OOM killer may cause server processes to exit unexpectedly.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-7">
            <div class="row">
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-header with-border">
                            <h3 class="box-title">Application Feature Limits</h3>
                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div class="form-group col-xs-6">
                                    <label for="database_limit" class="control-label">Database Limit</label>
                                    <div>
                                        <input type="text" name="database_limit" class="form-control" value="{{ old('database_limit', $server->database_limit) }}"/>
                                    </div>
                                    <p class="text-muted small">The total number of databases a user is allowed to create for this server.</p>
                                </div>
                                <div class="form-group col-xs-6">
                                    <label for="allocation_limit" class="control-label">Allocation Limit</label>
                                    <div>
                                        <input type="text" name="allocation_limit" class="form-control" value="{{ old('allocation_limit', $server->allocation_limit) }}"/>
                                    </div>
                                    <p class="text-muted small">The total number of allocations a user is allowed to create for this server.</p>
                                </div>
                                <div class="form-group col-xs-6">
                                    <label for="backup_limit" class="control-label">Backup Limit</label>
                                    <div>
                                        <input type="text" name="backup_limit" class="form-control" value="{{ old('backup_limit', $server->backup_limit) }}"/>
                                    </div>
                                    <p class="text-muted small">The total number of backups that can be created for this server.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-header with-border">
                            <h3 class="box-title">Allocation Management</h3>
                        </div>
                        <div class="box-body">
                            <div class="form-group">
                                <label for="pAllocation" class="control-label">Game Port</label>
                                <select id="pAllocation" name="allocation_id" class="form-control">
                                    @foreach ($assigned as $assignment)
                                        <option value="{{ $assignment->id }}"
                                            @if($assignment->id === $server->allocation_id)
                                                selected="selected"
                                            @endif
                                        >{{ $assignment->alias }}:{{ $assignment->port }}</option>
                                    @endforeach
                                </select>
                                <p class="text-muted small">The default connection address that will be used for this game server.</p>
                            </div>
                            <div class="form-group">
                                <label for="pAddAllocations" class="control-label">Assign Additional Ports</label>
                                <div>
                                    <select name="add_allocations[]" class="form-control" multiple id="pAddAllocations">
                                        @foreach ($unassigned as $assignment)
                                            <option value="{{ $assignment->id }}">{{ $assignment->alias }}:{{ $assignment->port }}</option>
                                        @endforeach
                                    </select>
                                </div>
                                <p class="text-muted small">Please note that due to software limitations you cannot assign identical ports on different IPs to the same server.</p>
                            </div>
                            <div class="form-group">
                                <label for="pRemoveAllocations" class="control-label">Remove Additional Ports</label>
                                <div>
                                    <select name="remove_allocations[]" class="form-control" multiple id="pRemoveAllocations">
                                        @foreach ($assigned as $assignment)
                                            <option value="{{ $assignment->id }}">{{ $assignment->alias }}:{{ $assignment->port }}</option>
                                        @endforeach
                                    </select>
                                </div>
                                <p class="text-muted small">Simply select which ports you would like to remove from the list above. If you want to assign a port on a different IP that is already in use you can select it from the left and delete it here.</p>
                            </div>
                        </div>
                        <div class="box-footer">
                            {!! csrf_field() !!}
                            <button type="submit" class="btn btn-primary pull-right">Update Build Configuration</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
@endsection

@section('footer-scripts')
    @parent
    <script>
    $('#pAddAllocations').select2();
    $('#pRemoveAllocations').select2();
    $('#pAllocation').select2();
    </script>
@endsection
</file>

<file path="resources/views/admin/servers/view/database.blade.php">
@extends('layouts.admin')

@section('title')
    Server  {{ $server->name }}: Databases
@endsection

@section('content-header')
    <h1>{{ $server->name }}<small>Manage server databases.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.servers') }}">Servers</a></li>
        <li><a href="{{ route('admin.servers.view', $server->id) }}">{{ $server->name }}</a></li>
        <li class="active">Databases</li>
    </ol>
@endsection

@section('content')
@include('admin.servers.partials.navigation')
<div class="row">
    <div class="col-sm-7">
        <div class="alert alert-info">
            Database passwords can be viewed when <a href="/server/{{ $server->uuidShort }}/databases">visiting this server</a> on the front-end.
        </div>
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">Active Databases</h3>
            </div>
            <div class="box-body table-responsible no-padding">
                <table class="table table-hover">
                    <tr>
                        <th>Database</th>
                        <th>Username</th>
                        <th>Connections From</th>
                        <th>Host</th>
                        <th>Max Connections</th>
                        <th></th>
                    </tr>
                    @foreach($server->databases as $database)
                        <tr>
                            <td>{{ $database->database }}</td>
                            <td>{{ $database->username }}</td>
                            <td>{{ $database->remote }}</td>
                            <td><code>{{ $database->host->host }}:{{ $database->host->port }}</code></td>
                            @if($database->max_connections != null)
                                <td>{{ $database->max_connections }}</td>
                            @else
                                <td>Unlimited</td>
                            @endif
                            <td class="text-center">
                                <button data-action="reset-password" data-id="{{ $database->id }}" class="btn btn-xs btn-primary"><i class="fa fa-refresh"></i></button>
                                <button data-action="remove" data-id="{{ $database->id }}" class="btn btn-xs btn-danger"><i class="fa fa-trash"></i></button>
                            </td>
                        </tr>
                    @endforeach
                </table>
            </div>
        </div>
    </div>
    <div class="col-sm-5">
        <div class="box box-success">
            <div class="box-header with-border">
                <h3 class="box-title">Create New Database</h3>
            </div>
            <form action="{{ route('admin.servers.view.database', $server->id) }}" method="POST">
                <div class="box-body">
                    <div class="form-group">
                        <label for="pDatabaseHostId" class="control-label">Database Host</label>
                        <select id="pDatabaseHostId" name="database_host_id" class="form-control">
                            @foreach($hosts as $host)
                                <option value="{{ $host->id }}">{{ $host->name }}</option>
                            @endforeach
                        </select>
                        <p class="text-muted small">Select the host database server that this database should be created on.</p>
                    </div>
                    <div class="form-group">
                        <label for="pDatabaseName" class="control-label">Database</label>
                        <div class="input-group">
                            <span class="input-group-addon">s{{ $server->id }}_</span>
                            <input id="pDatabaseName" type="text" name="database" class="form-control" placeholder="database" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="pRemote" class="control-label">Connections</label>
                        <input id="pRemote" type="text" name="remote" class="form-control" value="%" />
                        <p class="text-muted small">This should reflect the IP address that connections are allowed from. Uses standard MySQL notation. If unsure leave as <code>%</code>.</p>
                    </div>
                    <div class="form-group">
                        <label for="pmax_connections" class="control-label">Concurrent Connections</label>
                        <input id="pmax_connections" type="text" name="max_connections" class="form-control"/>
                        <p class="text-muted small">This should reflect the max number of concurrent connections from this user to the database. Leave empty for unlimited.</p>
                    </div>
                </div>
                <div class="box-footer">
                    {!! csrf_field() !!}
                    <p class="text-muted small no-margin">A username and password for this database will be randomly generated after form submission.</p>
                    <input type="submit" class="btn btn-sm btn-success pull-right" value="Create Database" />
                </div>
            </form>
        </div>
    </div>
</div>
@endsection

@section('footer-scripts')
    @parent
    <script>
    $('#pDatabaseHost').select2();
    $('[data-action="remove"]').click(function (event) {
        event.preventDefault();
        var self = $(this);
        swal({
            title: '',
            type: 'warning',
            text: 'Are you sure that you want to delete this database? There is no going back, all data will immediately be removed.',
            showCancelButton: true,
            confirmButtonText: 'Delete',
            confirmButtonColor: '#d9534f',
            closeOnConfirm: false,
            showLoaderOnConfirm: true,
        }, function () {
            $.ajax({
                method: 'DELETE',
                url: '/admin/servers/view/{{ $server->id }}/database/' + self.data('id') + '/delete',
                headers: { 'X-CSRF-TOKEN': $('meta[name="_token"]').attr('content') },
            }).done(function () {
                self.parent().parent().slideUp();
                swal.close();
            }).fail(function (jqXHR) {
                console.error(jqXHR);
                swal({
                    type: 'error',
                    title: 'Whoops!',
                    text: (typeof jqXHR.responseJSON.error !== 'undefined') ? jqXHR.responseJSON.error : 'An error occurred while processing this request.'
                });
            });
        });
    });
    $('[data-action="reset-password"]').click(function (e) {
        e.preventDefault();
        var block = $(this);
        $(this).addClass('disabled').find('i').addClass('fa-spin');
        $.ajax({
            type: 'PATCH',
            url: '/admin/servers/view/{{ $server->id }}/database',
            headers: { 'X-CSRF-TOKEN': $('meta[name="_token"]').attr('content') },
            data: { database: $(this).data('id') },
        }).done(function (data) {
            swal({
                type: 'success',
                title: '',
                text: 'The password for this database has been reset.',
            });
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error(jqXHR);
            var error = 'An error occurred while trying to process this request.';
            if (typeof jqXHR.responseJSON !== 'undefined' && typeof jqXHR.responseJSON.error !== 'undefined') {
                error = jqXHR.responseJSON.error;
            }
            swal({
                type: 'error',
                title: 'Whoops!',
                text: error
            });
        }).always(function () {
            block.removeClass('disabled').find('i').removeClass('fa-spin');
        });
    });
    </script>
@endsection
</file>

<file path="resources/views/admin/servers/view/delete.blade.php">
@extends('layouts.admin')

@section('title')
    Server  {{ $server->name }}: Delete
@endsection

@section('content-header')
    <h1>{{ $server->name }}<small>Delete this server from the panel.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.servers') }}">Servers</a></li>
        <li><a href="{{ route('admin.servers.view', $server->id) }}">{{ $server->name }}</a></li>
        <li class="active">Delete</li>
    </ol>
@endsection

@section('content')
@include('admin.servers.partials.navigation')
<div class="row">
    <form id="deleteform" action="{{ route('admin.servers.view.delete', $server->id) }}" method="POST">
        <div class="col-md-6">
            <div class="box box-warning">
                <div class="box-header with-border">
                    <h3 class="box-title">Safely Delete Server</h3>
                </div>
                <div class="box-body">
                    <p>This will attempt to remove the server from the associated node and remove data linked to it.</p>
                    <div class="checkbox checkbox-primary no-margin-bottom">
                        <input id="pReturnResourcesSafe" name="return_resources" type="checkbox" value="1" />
                        <label for="pReturnResourcesSafe">Return resources to user on server deletion?</label>
                    </div>
                </div>
                <div class="box-footer">
                    {!! csrf_field() !!}
                    <button id="deletebtn" class="btn btn-warning">Safely Delete This Server</button>
                </div>
            </div>
        </div>
    </form>
    <form id="forcedeleteform" action="{{ route('admin.servers.view.delete', $server->id) }}" method="POST">
        <div class="col-md-6">
            <div class="box box-danger">
                <div class="box-header with-border">
                    <h3 class="box-title">Forcibly Delete Server</h3>
                </div>
                <div class="box-body">
                    <p>This will remove all server data from the Panel regardless of whether Wings is able to delete the server from the system.</p>
                    <div class="checkbox checkbox-primary no-margin-bottom">
                        <input id="pReturnResources" name="return_resources" type="checkbox" value="1" />
                        <label for="pReturnResources">Return resources to user on server deletion?</label>
                    </div>
                </div>
                <div class="box-footer">
                    {!! csrf_field() !!}
                    <input type="hidden" name="force_delete" value="1" />
                    <button id="forcedeletebtn"" class="btn btn-danger">Forcibly Delete This Server</button>
                </div>
            </div>
        </div>
    </form>
</div>
@endsection

@section('footer-scripts')
    @parent
    <script>
    $('#deletebtn').click(function (event) {
        event.preventDefault();
        swal({
            title: 'Delete Server',
            text: 'All data will be removed from the Panel and your node.',
            showCancelButton: true,
            confirmButtonText: 'Delete',
            confirmButtonColor: 'orange',
            closeOnConfirm: false
        }, function () {
            $('#deleteform').submit()
        });
    });

    $('#forcedeletebtn').click(function (event) {
        event.preventDefault();
        swal({
            title: 'Delete Server',
            text: 'All data will be removed from the Panel and your node.',
            showCancelButton: true,
            confirmButtonText: 'Delete',
            confirmButtonColor: 'red',
            closeOnConfirm: false
        }, function () {
            $('#forcedeleteform').submit()
        });
    });
    </script>
@endsection
</file>

<file path="resources/views/admin/servers/view/details.blade.php">
@extends('layouts.admin')

@section('title')
    Server  {{ $server->name }}: Details
@endsection

@section('content-header')
    <h1>{{ $server->name }}<small>Edit details for this server including owner and container.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.servers') }}">Servers</a></li>
        <li><a href="{{ route('admin.servers.view', $server->id) }}">{{ $server->name }}</a></li>
        <li class="active">Details</li>
    </ol>
@endsection

@section('content')
@include('admin.servers.partials.navigation')
<div class="row">
    <div class="col-xs-12">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">Base Information</h3>
            </div>
            <form action="{{ route('admin.servers.view.details', $server->id) }}" method="POST">
                <div class="box-body">
                    <div class="form-group">
                        <label for="name" class="control-label">Server Name <span class="field-required"></span></label>
                        <input type="text" name="name" value="{{ old('name', $server->name) }}" class="form-control" />
                        <p class="text-muted small">Character limits: <code>a-zA-Z0-9_-</code> and <code>[Space]</code>.</p>
                    </div>
                    <div class="form-group">
                        <label for="external_id" class="control-label">External Identifier</label>
                        <input type="text" name="external_id" value="{{ old('external_id', $server->external_id) }}" class="form-control" />
                        <p class="text-muted small">Leave empty to not assign an external identifier for this server. The external ID should be unique to this server and not be in use by any other servers.</p>
                    </div>
                    <div class="form-group">
                        <label for="pUserId" class="control-label">Server Owner <span class="field-required"></span></label>
                        <select name="owner_id" class="form-control" id="pUserId">
                            <option value="{{ $server->owner_id }}" selected>{{ $server->user->email }}</option>
                        </select>
                        <p class="text-muted small">You can change the owner of this server by changing this field to an email matching another use on this system. If you do this a new daemon security token will be generated automatically.</p>
                    </div>
                    <div class="form-group">
                        <label for="description" class="control-label">Server Description</label>
                        <textarea name="description" rows="3" class="form-control">{{ old('description', $server->description) }}</textarea>
                        <p class="text-muted small">A brief description of this server.</p>
                    </div>
                    <div class="form-group">
                        <label for="renewable" class="control-label">Renewable <span class="field-required"></span></label>
                        <select name="renewable" class="form-control">
                            <option @if (!$server->renewable) selected @endif value="0">Disabled</option>
                            <option @if ($server->renewable) selected @endif value="1">Enabled</option>
                        </select>
                        <p class="text-muted small">Determines whether this server is renewed by the renewal system or not.</p>
                    </div>
                    <div class="form-group">
                        <label for="renewal" class="control-label">Days until renewal <span class="field-required"></span></label>
                        <input type="text" name="renewal" value="{{ $server->renewal }}" class="form-control" />
                        <p class="text-muted small">Set the amount of days until the server must be renewed.</p>
                    </div>
                </div>
                <div class="box-footer">
                    {!! csrf_field() !!}
                    {!! method_field('PATCH') !!}
                    <input type="submit" class="btn btn-sm btn-primary" value="Update Details" />
                </div>
            </form>
        </div>
    </div>
</div>
@endsection

@section('footer-scripts')
    @parent
    <script>
    function escapeHtml(str) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    $('#pUserId').select2({
        ajax: {
            url: '/admin/users/accounts.json',
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    filter: { email: params.term },
                    page: params.page,
                };
            },
            processResults: function (data, params) {
                return { results: data };
            },
            cache: true,
        },
        escapeMarkup: function (markup) { return markup; },
        minimumInputLength: 2,
        templateResult: function (data) {
            if (data.loading) return escapeHtml(data.text);

            return '<div class="user-block"> \
                <img class="img-circle img-bordered-xs" src="https://www.gravatar.com/avatar/' + escapeHtml(data.md5) + '?s=120" alt="User Image"> \
                <span class="username"> \
                    <a href="#">' + escapeHtml(data.name_first) + ' ' + escapeHtml(data.name_last) +'</a> \
                </span> \
                <span class="description"><strong>' + escapeHtml(data.email) + '</strong> - ' + escapeHtml(data.username) + '</span> \
            </div>';
        },
        templateSelection: function (data) {
            if (typeof data.name_first === 'undefined') {
                data = {
                    md5: '{{ md5(strtolower($server->user->email)) }}',
                    name_first: '{{ $server->user->name_first }}',
                    name_last: '{{ $server->user->name_last }}',
                    email: '{{ $server->user->email }}',
                    id: {{ $server->owner_id }}
                };
            }

            return '<div> \
                <span> \
                    <img class="img-rounded img-bordered-xs" src="https://www.gravatar.com/avatar/' + escapeHtml(data.md5) + '?s=120" style="height:28px;margin-top:-4px;" alt="User Image"> \
                </span> \
                <span style="padding-left:5px;"> \
                    ' + escapeHtml(data.name_first) + ' ' + escapeHtml(data.name_last) + ' (<strong>' + escapeHtml(data.email) + '</strong>) \
                </span> \
            </div>';
        }
    });
    </script>
@endsection
</file>

<file path="resources/views/admin/servers/view/index.blade.php">
@extends('layouts.admin')

@section('title')
    Server  {{ $server->name }}
@endsection

@section('content-header')
    <h1>{{ $server->name }}<small>{{ str_limit($server->description) }}</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.servers') }}">Servers</a></li>
        <li class="active">{{ $server->name }}</li>
    </ol>
@endsection

@section('content')
@include('admin.servers.partials.navigation')
<div class="row">
    <div class="col-sm-8">
        <div class="row">
            <div class="col-xs-12">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">Information</h3>
                    </div>
                    <div class="box-body table-responsive no-padding">
                        <table class="table table-hover">
                            <tr>
                                <td>Internal Identifier</td>
                                <td><code>{{ $server->id }}</code></td>
                            </tr>
                            <tr>
                                <td>External Identifier</td>
                                @if(is_null($server->external_id))
                                    <td><span class="label label-default">Not Set</span></td>
                                @else
                                    <td><code>{{ $server->external_id }}</code></td>
                                @endif
                            </tr>
                            <tr>
                                <td>UUID / Docker Container ID</td>
                                <td><code>{{ $server->uuid }}</code></td>
                            </tr>
                            <tr>
                                <td>Current Egg</td>
                                <td>
                                    <a href="{{ route('admin.nests.view', $server->nest_id) }}">{{ $server->nest->name }}</a> ::
                                    <a href="{{ route('admin.nests.egg.view', $server->egg_id) }}">{{ $server->egg->name }}</a>
                                </td>
                            </tr>
                            <tr>
                                <td>Server Name</td>
                                <td>{{ $server->name }}</td>
                            </tr>
                            <tr>
                                <td>CPU Limit</td>
                                <td>
                                    @if($server->cpu === 0)
                                        <code>Unlimited</code>
                                    @else
                                        <code>{{ $server->cpu }}%</code>
                                    @endif
                                </td>
                            </tr>
                            <tr>
                                <td>CPU Pinning</td>
                                <td>
                                    @if($server->threads != null)
                                        <code>{{ $server->threads }}</code>
                                    @else
                                        <span class="label label-default">Not Set</span>
                                    @endif
                                </td>
                            </tr>
                            <tr>
                                <td>Memory</td>
                                <td>
                                    @if($server->memory === 0)
                                        <code>Unlimited</code>
                                    @else
                                        <code>{{ $server->memory }}MiB</code>
                                    @endif
                                    /
                                    @if($server->swap === 0)
                                        <code data-toggle="tooltip" data-placement="top" title="Swap Space">Not Set</code>
                                    @elseif($server->swap === -1)
                                        <code data-toggle="tooltip" data-placement="top" title="Swap Space">Unlimited</code>
                                    @else
                                        <code data-toggle="tooltip" data-placement="top" title="Swap Space"> {{ $server->swap }}MiB</code>
                                    @endif
                                </td>
                            </tr>
                            <tr>
                                <td>Disk Space</td>
                                <td>
                                    @if($server->disk === 0)
                                        <code>Unlimited</code>
                                    @else
                                        <code>{{ $server->disk }}MiB</code>
                                    @endif
                                </td>
                            </tr>
                            <tr>
                                <td>Block IO Weight</td>
                                <td><code>{{ $server->io }}</code></td>
                            </tr>
                            <tr>
                                <td>Default Connection</td>
                                <td><code>{{ $server->allocation->ip }}:{{ $server->allocation->port }}</code></td>
                            </tr>
                            <tr>
                                <td>Connection Alias</td>
                                <td>
                                    @if($server->allocation->alias !== $server->allocation->ip)
                                        <code>{{ $server->allocation->alias }}:{{ $server->allocation->port }}</code>
                                    @else
                                        <span class="label label-default">No Alias Assigned</span>
                                    @endif
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-4">
        <div class="box box-primary">
            <div class="box-body" style="padding-bottom: 0px;">
                <div class="row">
                    @if($server->isSuspended())
                        <div class="col-sm-12">
                            <div class="small-box bg-yellow">
                                <div class="inner">
                                    <h3 class="no-margin">Suspended</h3>
                                </div>
                            </div>
                        </div>
                    @endif
                    @if(!$server->isInstalled())
                        <div class="col-sm-12">
                            <div class="small-box {{ (! $server->isInstalled()) ? 'bg-blue' : 'bg-maroon' }}">
                                <div class="inner">
                                    <h3 class="no-margin">{{ (! $server->isInstalled()) ? 'Installing' : 'Install Failed' }}</h3>
                                </div>
                            </div>
                        </div>
                    @endif
                    <div class="col-sm-12">
                        <div class="small-box bg-gray">
                            <div class="inner">
                                <h3>{{ str_limit($server->user->username, 16) }}</h3>
                                <p>Server Owner</p>
                            </div>
                            <div class="icon"><i class="fa fa-user"></i></div>
                            <a href="{{ route('admin.users.view', $server->user->id) }}" class="small-box-footer">
                                More info <i class="fa fa-arrow-circle-right"></i>
                            </a>
                        </div>
                    </div>
                    <div class="col-sm-12">
                        <div class="small-box bg-gray">
                            <div class="inner">
                                <h3>{{ str_limit($server->node->name, 16) }}</h3>
                                <p>Server Node</p>
                            </div>
                            <div class="icon"><i class="fa fa-codepen"></i></div>
                            <a href="{{ route('admin.nodes.view', $server->node->id) }}" class="small-box-footer">
                                More info <i class="fa fa-arrow-circle-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@endsection
</file>

<file path="resources/views/admin/servers/view/manage.blade.php">
@extends('layouts.admin')

@section('title')
    Server  {{ $server->name }}: Manage
@endsection

@section('content-header')
    <h1>{{ $server->name }}<small>Additional actions to control this server.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.servers') }}">Servers</a></li>
        <li><a href="{{ route('admin.servers.view', $server->id) }}">{{ $server->name }}</a></li>
        <li class="active">Manage</li>
    </ol>
@endsection

@section('content')
    @include('admin.servers.partials.navigation')
    <div class="row">
        <div class="col-sm-4">
            <div class="box box-danger">
                <div class="box-header with-border">
                    <h3 class="box-title">Reinstall Server</h3>
                </div>
                <div class="box-body">
                    <p>This will reinstall the server with the assigned service scripts. <strong>Danger!</strong> This could overwrite server data.</p>
                </div>
                <div class="box-footer">
                    @if($server->isInstalled())
                        <form action="{{ route('admin.servers.view.manage.reinstall', $server->id) }}" method="POST">
                            {!! csrf_field() !!}
                            <button type="submit" class="btn btn-danger">Reinstall Server</button>
                        </form>
                    @else
                        <button class="btn btn-danger disabled">Server Must Install Properly to Reinstall</button>
                    @endif
                </div>
            </div>
        </div>
        <div class="col-sm-4">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Install Status</h3>
                </div>
                <div class="box-body">
                    <p>If you need to change the install status from uninstalled to installed, or vice versa, you may do so with the button below.</p>
                </div>
                <div class="box-footer">
                    <form action="{{ route('admin.servers.view.manage.toggle', $server->id) }}" method="POST">
                        {!! csrf_field() !!}
                        <button type="submit" class="btn btn-primary">Toggle Install Status</button>
                    </form>
                </div>
            </div>
        </div>

        @if(! $server->isSuspended())
            <div class="col-sm-4">
                <div class="box box-warning">
                    <div class="box-header with-border">
                        <h3 class="box-title">Suspend Server</h3>
                    </div>
                    <div class="box-body">
                        <p>This will suspend the server, stop any running processes, and immediately block the user from being able to access their files or otherwise manage the server through the panel or API.</p>
                    </div>
                    <div class="box-footer">
                        <form action="{{ route('admin.servers.view.manage.suspension', $server->id) }}" method="POST">
                            {!! csrf_field() !!}
                            <input type="hidden" name="action" value="suspend" />
                            <button type="submit" class="btn btn-warning @if(! is_null($server->transfer)) disabled @endif">Suspend Server</button>
                        </form>
                    </div>
                </div>
            </div>
        @else
            <div class="col-sm-4">
                <div class="box box-success">
                    <div class="box-header with-border">
                        <h3 class="box-title">Unsuspend Server</h3>
                    </div>
                    <div class="box-body">
                        <p>This will unsuspend the server and restore normal user access.</p>
                    </div>
                    <div class="box-footer">
                        <form action="{{ route('admin.servers.view.manage.suspension', $server->id) }}" method="POST">
                            {!! csrf_field() !!}
                            <input type="hidden" name="action" value="unsuspend" />
                            <button type="submit" class="btn btn-success">Unsuspend Server</button>
                        </form>
                    </div>
                </div>
            </div>
        @endif

        @if(is_null($server->transfer))
            <div class="col-sm-4">
                <div class="box box-success">
                    <div class="box-header with-border">
                        <h3 class="box-title">Transfer Server</h3>
                    </div>
                    <div class="box-body">
                        <p>
                            Transfer this server to another node connected to this panel.
                            <strong>Warning!</strong> This feature has not been fully tested and may have bugs.
                        </p>
                    </div>

                    <div class="box-footer">
                        @if($canTransfer)
                            <button class="btn btn-success" data-toggle="modal" data-target="#transferServerModal">Transfer Server</button>
                        @else
                            <button class="btn btn-success disabled">Transfer Server</button>
                            <p style="padding-top: 1rem;">Transferring a server requires more than one node to be configured on your panel.</p>
                        @endif
                    </div>
                </div>
            </div>
        @else
            <div class="col-sm-4">
                <div class="box box-success">
                    <div class="box-header with-border">
                        <h3 class="box-title">Transfer Server</h3>
                    </div>
                    <div class="box-body">
                        <p>
                            This server is currently being transferred to another node.
                            Transfer was initiated at <strong>{{ $server->transfer->created_at }}</strong>
                        </p>
                    </div>

                    <div class="box-footer">
                        <button class="btn btn-success disabled">Transfer Server</button>
                    </div>
                </div>
            </div>
        @endif
    </div>

    <div class="modal fade" id="transferServerModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form action="{{ route('admin.servers.view.manage.transfer', $server->id) }}" method="POST">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Transfer Server</h4>
                    </div>

                    <div class="modal-body">
                        <div class="row">
                            <div class="form-group col-md-12">
                                <label for="pNodeId">Node</label>
                                <select name="node_id" id="pNodeId" class="form-control">
                                    @foreach($locations as $location)
                                        <optgroup label="{{ $location->long }} ({{ $location->short }})">
                                            @foreach($location->nodes as $node)

                                                @if($node->id != $server->node_id)
                                                    <option value="{{ $node->id }}"
                                                            @if($location->id === old('location_id')) selected @endif
                                                    >{{ $node->name }}</option>
                                                @endif

                                            @endforeach
                                        </optgroup>
                                    @endforeach
                                </select>
                                <p class="small text-muted no-margin">The node which this server will be transferred to.</p>
                            </div>

                            <div class="form-group col-md-12">
                                <label for="pAllocation">Default Allocation</label>
                                <select name="allocation_id" id="pAllocation" class="form-control"></select>
                                <p class="small text-muted no-margin">The main allocation that will be assigned to this server.</p>
                            </div>

                            <div class="form-group col-md-12">
                                <label for="pAllocationAdditional">Additional Allocation(s)</label>
                                <select name="allocation_additional[]" id="pAllocationAdditional" class="form-control" multiple></select>
                                <p class="small text-muted no-margin">Additional allocations to assign to this server on creation.</p>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        {!! csrf_field() !!}
                        <button type="button" class="btn btn-default btn-sm pull-left" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success btn-sm">Confirm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
@endsection

@section('footer-scripts')
    @parent
    {!! Theme::js('vendor/lodash/lodash.js') !!}

    @if($canTransfer)
        {!! Theme::js('js/admin/server/transfer.js') !!}
    @endif
@endsection
</file>

<file path="resources/views/admin/servers/view/mounts.blade.php">
@extends('layouts.admin')

@section('title')
    Server  {{ $server->name }}: Mounts
@endsection

@section('content-header')
    <h1>{{ $server->name }}<small>Manage server mounts.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.servers') }}">Servers</a></li>
        <li><a href="{{ route('admin.servers.view', $server->id) }}">{{ $server->name }}</a></li>
        <li class="active">Mounts</li>
    </ol>
@endsection

@section('content')
    @include('admin.servers.partials.navigation')

    <div class="row">
        <div class="col-sm-12">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Available Mounts</h3>
                </div>

                <div class="box-body table-responsible no-padding">
                    <table class="table table-hover">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Source</th>
                            <th>Target</th>
                            <th>Status</th>
                            <th></th>
                        </tr>

                        @foreach ($mounts as $mount)
                            <tr>
                                <td class="col-sm-1 middle"><code>{{ $mount->id }}</code></td>
                                <td class="middle"><a href="{{ route('admin.mounts.view', $mount->id) }}">{{ $mount->name }}</a></td>
                                <td class="middle"><code>{{ $mount->source }}</code></td>
                                <td class="col-sm-2 middle"><code>{{ $mount->target }}</code></td>

                                @if (! in_array($mount->id, $server->mounts->pluck('id')->toArray()))
                                    <td class="col-sm-2 middle">
                                        <span class="label label-primary">Unmounted</span>
                                    </td>

                                    <td class="col-sm-1 middle">
                                        <form action="{{ route('admin.servers.view.mounts.store', [ 'server' => $server->id ]) }}" method="POST">
                                            {!! csrf_field() !!}
                                            <input type="hidden" value="{{ $mount->id }}" name="mount_id" />
                                            <button type="submit" class="btn btn-xs btn-success"><i class="fa fa-plus"></i></button>
                                        </form>
                                    </td>
                                @else
                                    <td class="col-sm-2 middle">
                                        <span class="label label-success">Mounted</span>
                                    </td>

                                    <td class="col-sm-1 middle">
                                        <form action="{{ route('admin.servers.view.mounts.delete', [ 'server' => $server->id, 'mount' => $mount->id ]) }}" method="POST">
                                            @method('DELETE')
                                            {!! csrf_field() !!}

                                            <button type="submit" class="btn btn-xs btn-danger"><i class="fa fa-times"></i></button>
                                        </form>
                                    </td>
                                @endif
                            </tr>
                        @endforeach
                    </table>
                </div>
            </div>
        </div>
    </div>
@endsection
</file>

<file path="resources/views/admin/servers/view/startup.blade.php">
@extends('layouts.admin')

@section('title')
    Server  {{ $server->name }}: Startup
@endsection

@section('content-header')
    <h1>{{ $server->name }}<small>Control startup command as well as variables.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.servers') }}">Servers</a></li>
        <li><a href="{{ route('admin.servers.view', $server->id) }}">{{ $server->name }}</a></li>
        <li class="active">Startup</li>
    </ol>
@endsection

@section('content')
@include('admin.servers.partials.navigation')
<form action="{{ route('admin.servers.view.startup', $server->id) }}" method="POST">
    <div class="row">
        <div class="col-xs-12">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Startup Command Modification</h3>
                </div>
                <div class="box-body">
                    <label for="pStartup" class="form-label">Startup Command</label>
                    <input id="pStartup" name="startup" class="form-control" type="text" value="{{ old('startup', $server->startup) }}" />
                    <p class="small text-muted">Edit your server's startup command here. The following variables are available by default: <code>@{{SERVER_MEMORY}}</code>, <code>@{{SERVER_IP}}</code>, and <code>@{{SERVER_PORT}}</code>.</p>
                </div>
                <div class="box-body">
                    <label for="pDefaultStartupCommand" class="form-label">Default Service Start Command</label>
                    <input id="pDefaultStartupCommand" class="form-control" type="text" readonly />
                </div>
                <div class="box-footer">
                    {!! csrf_field() !!}
                    <button type="submit" class="btn btn-primary btn-sm pull-right">Save Modifications</button>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Service Configuration</h3>
                </div>
                <div class="box-body row">
                    <div class="col-xs-12">
                        <p class="small text-danger">
                            Changing any of the below values will result in the server processing a re-install command. The server will be stopped and will then proceed.
                            If you would like the service scripts to not run, ensure the box is checked at the bottom.
                        </p>
                        <p class="small text-danger">
                            <strong>This is a destructive operation in many cases. This server will be stopped immediately in order for this action to proceed.</strong>
                        </p>
                    </div>
                    <div class="form-group col-xs-12">
                        <label for="pNestId">Nest</label>
                        <select name="nest_id" id="pNestId" class="form-control">
                            @foreach($nests as $nest)
                                <option value="{{ $nest->id }}"
                                    @if($nest->id === $server->nest_id)
                                        selected
                                    @endif
                                >{{ $nest->name }}</option>
                            @endforeach
                        </select>
                        <p class="small text-muted no-margin">Select the Nest that this server will be grouped into.</p>
                    </div>
                    <div class="form-group col-xs-12">
                        <label for="pEggId">Egg</label>
                        <select name="egg_id" id="pEggId" class="form-control"></select>
                        <p class="small text-muted no-margin">Select the Egg that will provide processing data for this server.</p>
                    </div>
                    <div class="form-group col-xs-12">
                        <div class="checkbox checkbox-primary no-margin-bottom">
                            <input id="pSkipScripting" name="skip_scripts" type="checkbox" value="1" @if($server->skip_scripts) checked @endif />
                            <label for="pSkipScripting" class="strong">Skip Egg Install Script</label>
                        </div>
                        <p class="small text-muted no-margin">If the selected Egg has an install script attached to it, the script will run during install. If you would like to skip this step, check this box.</p>
                    </div>
                </div>
            </div>
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Docker Image Configuration</h3>
                </div>
                <div class="box-body">
                    <div class="form-group">
                        <label for="pDockerImage">Image</label>
                        <select id="pDockerImage" name="docker_image" class="form-control"></select>
                        <input id="pDockerImageCustom" name="custom_docker_image" value="{{ old('custom_docker_image') }}" class="form-control" placeholder="Or enter a custom image..." style="margin-top:1rem"/>
                        <p class="small text-muted no-margin">This is the Docker image that will be used to run this server. Select an image from the dropdown or enter a custom image in the text field above.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="row" id="appendVariablesTo"></div>
        </div>
    </div>
</form>
@endsection

@section('footer-scripts')
    @parent
    {!! Theme::js('vendor/lodash/lodash.js') !!}
    <script>
    $(document).ready(function () {
        $('#pEggId').select2({placeholder: 'Select a Nest Egg'}).on('change', function () {
            var selectedEgg = _.isNull($(this).val()) ? $(this).find('option').first().val() : $(this).val();
            var parentChain = _.get(Jexactyl.nests, $("#pNestId").val());
            var objectChain = _.get(parentChain, 'eggs.' + selectedEgg);

            const images = _.get(objectChain, 'docker_images', [])
            $('#pDockerImage').html('');
            const keys = Object.keys(images);
            for (let i = 0; i < keys.length; i++) {
                let opt = document.createElement('option');
                opt.value = images[keys[i]];
                opt.innerHTML = keys[i] + " (" + images[keys[i]] + ")";
                if (objectChain.id === parseInt(Jexactyl.server.egg_id) && Jexactyl.server.image == opt.value) {
                    opt.selected = true
                }
                $('#pDockerImage').append(opt);
            }
            $('#pDockerImage').on('change', function () {
                $('#pDockerImageCustom').val('');
            })

            if (objectChain.id === parseInt(Jexactyl.server.egg_id)) {
                if ($('#pDockerImage').val() != Jexactyl.server.image) {
                    $('#pDockerImageCustom').val(Jexactyl.server.image);
                }
            }

            if (!_.get(objectChain, 'startup', false)) {
                $('#pDefaultStartupCommand').val(_.get(parentChain, 'startup', 'ERROR: Startup Not Defined!'));
            } else {
                $('#pDefaultStartupCommand').val(_.get(objectChain, 'startup'));
            }

            $('#appendVariablesTo').html('');
            $.each(_.get(objectChain, 'variables', []), function (i, item) {
                var setValue = _.get(Jexactyl.server_variables, item.env_variable, item.default_value);
                var isRequired = (item.required === 1) ? '<span class="label label-danger">Required</span> ' : '';
                var dataAppend = ' \
                    <div class="col-xs-12"> \
                        <div class="box"> \
                            <div class="box-header with-border"> \
                                <h3 class="box-title">' + isRequired + item.name + '</h3> \
                            </div> \
                            <div class="box-body"> \
                                <input name="environment[' + item.env_variable + ']" class="form-control" type="text" id="egg_variable_' + item.env_variable + '" /> \
                                <p class="no-margin small text-muted">' + item.description + '</p> \
                            </div> \
                            <div class="box-footer"> \
                                <p class="no-margin text-muted small"><strong>Startup Command Variable:</strong> <code>' + item.env_variable + '</code></p> \
                                <p class="no-margin text-muted small"><strong>Input Rules:</strong> <code>' + item.rules + '</code></p> \
                            </div> \
                        </div> \
                    </div>';
                $('#appendVariablesTo').append(dataAppend).find('#egg_variable_' + item.env_variable).val(setValue);
            });
        });

        $('#pNestId').select2({placeholder: 'Select a Nest'}).on('change', function () {
            $('#pEggId').html('').select2({
                data: $.map(_.get(Jexactyl.nests, $(this).val() + '.eggs', []), function (item) {
                    return {
                        id: item.id,
                        text: item.name,
                    };
                }),
            });

            if (_.isObject(_.get(Jexactyl.nests, $(this).val() + '.eggs.' + Jexactyl.server.egg_id))) {
                $('#pEggId').val(Jexactyl.server.egg_id);
            }

            $('#pEggId').change();
        }).change();
    });
    </script>
@endsection
</file>

<file path="resources/views/admin/servers/index.blade.php">
@extends('layouts.admin')

@section('title')
    List Servers
@endsection

@section('content-header')
    <h1>Servers<small>All servers available on the system.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Servers</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-xs-12">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">Server List</h3>
                <div class="box-tools search01">
                    <form action="{{ route('admin.servers') }}" method="GET">
                        <div class="input-group input-group-sm">
                            <input type="text" name="filter[*]" class="form-control pull-right" value="{{ request()->input()['filter']['*'] ?? '' }}" placeholder="Search Servers">
                            <div class="input-group-btn">
                                <button type="submit" class="btn btn-default"><i class="fa fa-search"></i></button>
                                <a href="{{ route('admin.servers.new') }}"><button type="button" class="btn btn-sm btn-primary" style="border-radius: 0 3px 3px 0;margin-left:-1px;">Create New</button></a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="box-body table-responsive no-padding">
                <table class="table table-hover">
                    <tbody>
                        <tr>
                            <th>Server Name</th>
                            <th>UUID</th>
                            <th>Owner</th>
                            <th>Node</th>
                            <th>Connection</th>
                            <th></th>
                            <th></th>
                        </tr>
                        @foreach ($servers as $server)
                            <tr data-server="{{ $server->uuidShort }}">
                                <td><a href="{{ route('admin.servers.view', $server->id) }}">{{ $server->name }}</a></td>
                                <td><code title="{{ $server->uuid }}">{{ $server->uuid }}</code></td>
                                <td><a href="{{ route('admin.users.view', $server->user->id) }}">{{ $server->user->username }}</a></td>
                                <td><a href="{{ route('admin.nodes.view', $server->node->id) }}">{{ $server->node->name }}</a></td>
                                <td>
                                    <code>{{ $server->allocation->alias }}:{{ $server->allocation->port }}</code>
                                </td>
                                <td class="text-center">
                                    @if($server->isSuspended())
                                        <span class="label bg-maroon">Suspended</span>
                                    @elseif(! $server->isInstalled())
                                        <span class="label label-warning">Installing</span>
                                    @else
                                        <span class="label label-success">Active</span>
                                    @endif
                                </td>
                                <td class="text-center">
                                    <a class="btn btn-xs btn-default" href="/server/{{ $server->uuidShort }}"><i class="fa fa-wrench"></i></a>
                                </td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>
            @if($servers->hasPages())
                <div class="box-footer with-border">
                    <div class="col-md-12 text-center">{!! $servers->appends(['filter' => Request::input('filter')])->render() !!}</div>
                </div>
            @endif
        </div>
    </div>
</div>
@endsection

@section('footer-scripts')
    @parent
    <script>
        $('.console-popout').on('click', function (event) {
            event.preventDefault();
            window.open($(this).attr('href'), 'Jexactyl Console', 'width=800,height=400');
        });
    </script>
@endsection
</file>

<file path="resources/views/admin/servers/new.blade.php">
@extends('layouts.admin')

@section('title')
    New Server
@endsection

@section('content-header')
    <h1>Create Server<small>Add a new server to the panel.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.servers') }}">Servers</a></li>
        <li class="active">Create Server</li>
    </ol>
@endsection

@section('content')
<form action="{{ route('admin.servers.new') }}" method="POST">
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Core Details</h3>
                </div>

                <div class="box-body row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="pName">Server Name</label>
                            <input type="text" class="form-control" id="pName" name="name" value="{{ old('name') }}" placeholder="Server Name">
                            <p class="small text-muted no-margin">Character limits: <code>a-z A-Z 0-9 _ - .</code> and <code>[Space]</code>.</p>
                        </div>

                        <div class="form-group">
                            <label for="pUserId">Server Owner</label>
                            <select id="pUserId" name="owner_id" class="form-control" style="padding-left:0;"></select>
                            <p class="small text-muted no-margin">Email address of the Server Owner.</p>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="pDescription" class="control-label">Server Description</label>
                            <textarea id="pDescription" name="description" rows="3" class="form-control">{{ old('description') }}</textarea>
                            <p class="text-muted small">A brief description of this server.</p>
                        </div>

                        <div class="form-group">
                            <div class="checkbox checkbox-primary no-margin-bottom">
                                <input id="pStartOnCreation" name="start_on_completion" type="checkbox" {{ \Jexactyl\Helpers\Utilities::checked('start_on_completion', 1) }} />
                                <label for="pStartOnCreation" class="strong">Start Server when Installed</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="overlay" id="allocationLoader" style="display:none;"><i class="fa fa-refresh fa-spin"></i></div>
                <div class="box-header with-border">
                    <h3 class="box-title">Allocation Management</h3>
                </div>

                <div class="box-body row">
                    <div class="form-group col-sm-4">
                        <label for="pNodeId">Node</label>
                        <select name="node_id" id="pNodeId" class="form-control">
                            @foreach($locations as $location)
                                <optgroup label="{{ $location->long }} ({{ $location->short }})">
                                @foreach($location->nodes as $node)

                                <option value="{{ $node->id }}"
                                    @if($location->id === old('location_id')) selected @endif
                                >{{ $node->name }}</option>

                                @endforeach
                                </optgroup>
                            @endforeach
                        </select>

                        <p class="small text-muted no-margin">The node which this server will be deployed to.</p>
                    </div>

                    <div class="form-group col-sm-4">
                        <label for="pAllocation">Default Allocation</label>
                        <select id="pAllocation" name="allocation_id" class="form-control"></select>
                        <p class="small text-muted no-margin">The main allocation that will be assigned to this server.</p>
                    </div>

                    <div class="form-group col-sm-4">
                        <label for="pAllocationAdditional">Additional Allocation(s)</label>
                        <select id="pAllocationAdditional" name="allocation_additional[]" class="form-control" multiple></select>
                        <p class="small text-muted no-margin">Additional allocations to assign to this server on creation.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="overlay" id="allocationLoader" style="display:none;"><i class="fa fa-refresh fa-spin"></i></div>
                <div class="box-header with-border">
                    <h3 class="box-title">Application Feature Limits</h3>
                </div>

                <div class="box-body row">
                    <div class="form-group col-xs-6">
                        <label for="pDatabaseLimit" class="control-label">Database Limit</label>
                        <div>
                            <input type="text" id="pDatabaseLimit" name="database_limit" class="form-control" value="{{ old('database_limit', 0) }}"/>
                        </div>
                        <p class="text-muted small">The total number of databases a user is allowed to create for this server.</p>
                    </div>
                    <div class="form-group col-xs-6">
                        <label for="pAllocationLimit" class="control-label">Allocation Limit</label>
                        <div>
                            <input type="text" id="pAllocationLimit" name="allocation_limit" class="form-control" value="{{ old('allocation_limit', 0) }}"/>
                        </div>
                        <p class="text-muted small">The total number of allocations a user is allowed to create for this server.</p>
                    </div>
                    <div class="form-group col-xs-6">
                        <label for="pBackupLimit" class="control-label">Backup Limit</label>
                        <div>
                            <input type="text" id="pBackupLimit" name="backup_limit" class="form-control" value="{{ old('backup_limit', 0) }}"/>
                        </div>
                        <p class="text-muted small">The total number of backups that can be created for this server.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Resource Management</h3>
                </div>

                <div class="box-body row">
                    <div class="form-group col-xs-6">
                        <label for="pCPU">CPU Limit</label>

                        <div class="input-group">
                            <input type="text" id="pCPU" name="cpu" class="form-control" value="{{ old('cpu', 0) }}" />
                            <span class="input-group-addon">%</span>
                        </div>

                        <p class="text-muted small">If you do not want to limit CPU usage, set the value to <code>0</code>. To determine a value, take the number of threads and multiply it by 100. For example, on a quad core system without hyperthreading <code>(4 * 100 = 400)</code> there is <code>400%</code> available. To limit a server to using half of a single thread, you would set the value to <code>50</code>. To allow a server to use up to two threads, set the value to <code>200</code>.<p>
                    </div>

                    <div class="form-group col-xs-6">
                        <label for="pThreads">CPU Pinning</label>

                        <div>
                            <input type="text" id="pThreads" name="threads" class="form-control" value="{{ old('threads') }}" />
                        </div>

                        <p class="text-muted small"><strong>Advanced:</strong> Enter the specific CPU threads that this process can run on, or leave blank to allow all threads. This can be a single number, or a comma separated list. Example: <code>0</code>, <code>0-1,3</code>, or <code>0,1,3,4</code>.</p>
                    </div>
                </div>

                <div class="box-body row">
                    <div class="form-group col-xs-6">
                        <label for="pMemory">Memory</label>

                        <div class="input-group">
                            <input type="text" id="pMemory" name="memory" class="form-control" value="{{ old('memory') }}" />
                            <span class="input-group-addon">MiB</span>
                        </div>

                        <p class="text-muted small">The maximum amount of memory allowed for this container. Setting this to <code>0</code> will allow unlimited memory in a container.</p>
                    </div>

                    <div class="form-group col-xs-6">
                        <label for="pSwap">Swap</label>

                        <div class="input-group">
                            <input type="text" id="pSwap" name="swap" class="form-control" value="{{ old('swap', 0) }}" />
                            <span class="input-group-addon">MiB</span>
                        </div>

                        <p class="text-muted small">Setting this to <code>0</code> will disable swap space on this server. Setting to <code>-1</code> will allow unlimited swap.</p>
                    </div>
                </div>

                <div class="box-body row">
                    <div class="form-group col-xs-6">
                        <label for="pDisk">Disk Space</label>

                        <div class="input-group">
                            <input type="text" id="pDisk" name="disk" class="form-control" value="{{ old('disk') }}" />
                            <span class="input-group-addon">MiB</span>
                        </div>

                        <p class="text-muted small">This server will not be allowed to boot if it is using more than this amount of space. If a server goes over this limit while running it will be safely stopped and locked until enough space is available. Set to <code>0</code> to allow unlimited disk usage.</p>
                    </div>

                    <div class="form-group col-xs-6">
                        <label for="pIO">Block IO Weight</label>

                        <div>
                            <input type="text" id="pIO" name="io" class="form-control" value="{{ old('io', 500) }}" />
                        </div>

                        <p class="text-muted small"><strong>Advanced</strong>: The IO performance of this server relative to other <em>running</em> containers on the system. Value should be between <code>10</code> and <code>1000</code>. Please see <a href="https://docs.docker.com/engine/reference/run/#block-io-bandwidth-blkio-constraint" target="_blank">this documentation</a> for more information about it.</p>
                    </div>
                    <div class="form-group col-xs-12">
                        <div class="checkbox checkbox-primary no-margin-bottom">
                            <input type="checkbox" id="pOomDisabled" name="oom_disabled" value="0" {{ \Jexactyl\Helpers\Utilities::checked('oom_disabled', 0) }} />
                            <label for="pOomDisabled" class="strong">Enable OOM Killer</label>
                        </div>

                        <p class="small text-muted no-margin">Terminates the server if it breaches the memory limits. Enabling OOM killer may cause server processes to exit unexpectedly.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Nest Configuration</h3>
                </div>

                <div class="box-body row">
                    <div class="form-group col-xs-12">
                        <label for="pNestId">Nest</label>

                        <select id="pNestId" name="nest_id" class="form-control">
                            @foreach($nests as $nest)
                                <option value="{{ $nest->id }}"
                                    @if($nest->id === old('nest_id'))
                                        selected="selected"
                                    @endif
                                >{{ $nest->name }}</option>
                            @endforeach
                        </select>

                        <p class="small text-muted no-margin">Select the Nest that this server will be grouped under.</p>
                    </div>

                    <div class="form-group col-xs-12">
                        <label for="pEggId">Egg</label>
                        <select id="pEggId" name="egg_id" class="form-control"></select>
                        <p class="small text-muted no-margin">Select the Egg that will define how this server should operate.</p>
                    </div>
                    <div class="form-group col-xs-12">
                        <div class="checkbox checkbox-primary no-margin-bottom">
                            <input type="checkbox" id="pSkipScripting" name="skip_scripts" value="1" {{ \Jexactyl\Helpers\Utilities::checked('skip_scripts', 0) }} />
                            <label for="pSkipScripting" class="strong">Skip Egg Install Script</label>
                        </div>

                        <p class="small text-muted no-margin">If the selected Egg has an install script attached to it, the script will run during the install. If you would like to skip this step, check this box.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Docker Configuration</h3>
                </div>

                <div class="box-body row">
                    <div class="form-group col-xs-12">
                        <label for="pDefaultContainer">Docker Image</label>
                        <select id="pDefaultContainer" name="image" class="form-control"></select>
                        <input id="pDefaultContainerCustom" name="custom_image" value="{{ old('custom_image') }}" class="form-control" placeholder="Or enter a custom image..." style="margin-top:1rem"/>
                        <p class="small text-muted no-margin">This is the default Docker image that will be used to run this server. Select an image from the dropdown above, or enter a custom image in the text field above.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Startup Configuration</h3>
                </div>

                <div class="box-body row">
                    <div class="form-group col-xs-12">
                        <label for="pStartup">Startup Command</label>
                        <input type="text" id="pStartup" name="startup" value="{{ old('startup') }}" class="form-control" />
                        <p class="small text-muted no-margin">The following data substitutes are available for the startup command: <code>@{{SERVER_MEMORY}}</code>, <code>@{{SERVER_IP}}</code>, and <code>@{{SERVER_PORT}}</code>. They will be replaced with the allocated memory, server IP, and server port respectively.</p>
                    </div>
                </div>

                <div class="box-header with-border" style="margin-top:-10px;">
                    <h3 class="box-title">Service Variables</h3>
                </div>

                <div class="box-body row" id="appendVariablesTo"></div>

                <div class="box-footer">
                    {!! csrf_field() !!}
                    <input type="submit" class="btn btn-success pull-right" value="Create Server" />
                </div>
            </div>
        </div>
    </div>
</form>
@endsection

@section('footer-scripts')
    @parent
    {!! Theme::js('vendor/lodash/lodash.js') !!}

    <script type="application/javascript">
        // Persist 'Service Variables'
        function serviceVariablesUpdated(eggId, ids) {
            @if (old('egg_id'))
                // Check if the egg id matches.
                if (eggId != '{{ old('egg_id') }}') {
                    return;
                }

                @if (old('environment'))
                    @foreach (old('environment') as $key => $value)
                        $('#' + ids['{{ $key }}']).val('{{ $value }}');
                    @endforeach
                @endif
            @endif
            @if(old('image'))
                $('#pDefaultContainer').val('{{ old('image') }}');
            @endif
        }
        // END Persist 'Service Variables'
    </script>

    {!! Theme::js('js/admin/new-server.js?v=20220530') !!}

    <script type="application/javascript">
        $(document).ready(function() {
            // Persist 'Server Owner' select2
            @if (old('owner_id'))
                $.ajax({
                    url: '/admin/users/accounts.json?user_id={{ old('owner_id') }}',
                    dataType: 'json',
                }).then(function (data) {
                    initUserIdSelect([ data ]);
                });
            @else
                initUserIdSelect();
            @endif
            // END Persist 'Server Owner' select2

            // Persist 'Node' select2
            @if (old('node_id'))
                $('#pNodeId').val('{{ old('node_id') }}').change();

                // Persist 'Default Allocation' select2
                @if (old('allocation_id'))
                    $('#pAllocation').val('{{ old('allocation_id') }}').change();
                @endif
                // END Persist 'Default Allocation' select2

                // Persist 'Additional Allocations' select2
                @if (old('allocation_additional'))
                    const additional_allocations = [];

                    @for ($i = 0; $i < count(old('allocation_additional')); $i++)
                        additional_allocations.push('{{ old('allocation_additional.'.$i)}}');
                    @endfor

                    $('#pAllocationAdditional').val(additional_allocations).change();
                @endif
                // END Persist 'Additional Allocations' select2
            @endif
            // END Persist 'Node' select2

            // Persist 'Nest' select2
            @if (old('nest_id'))
                $('#pNestId').val('{{ old('nest_id') }}').change();

                // Persist 'Egg' select2
                @if (old('egg_id'))
                    $('#pEggId').val('{{ old('egg_id') }}').change();
                @endif
                // END Persist 'Egg' select2
            @endif
            // END Persist 'Nest' select2
        });
    </script>
@endsection
</file>

<file path="resources/views/admin/settings/advanced.blade.php">
@extends('layouts.admin')
@include('partials/admin.settings.nav', ['activeTab' => 'advanced'])

@section('title')
    Advanced Settings
@endsection

@section('content-header')
    <h1>Advanced Settings<small>Configure advanced settings for Pterodactyl.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Settings</li>
    </ol>
@endsection

@section('content')
    @yield('settings::nav')
    <div class="row">
        <div class="col-xs-12">
            <form action="" method="POST">
                <div class="box">
                    <div class="box-header with-border">
                        <h3 class="box-title">reCAPTCHA</h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-4">
                                <label class="control-label">Status</label>
                                <div>
                                    <select class="form-control" name="recaptcha:enabled">
                                        <option value="true">Enabled</option>
                                        <option value="false" @if(old('recaptcha:enabled', config('recaptcha.enabled')) == '0') selected @endif>Disabled</option>
                                    </select>
                                    <p class="text-muted small">If enabled, login forms and password reset forms will do a silent captcha check and display a visible captcha if needed.</p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Site Key</label>
                                <div>
                                    <input type="text" required class="form-control" name="recaptcha:website_key" value="{{ old('recaptcha:website_key', config('recaptcha.website_key')) }}">
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Secret Key</label>
                                <div>
                                    <input type="text" required class="form-control" name="recaptcha:secret_key" value="{{ old('recaptcha:secret_key', config('recaptcha.secret_key')) }}">
                                    <p class="text-muted small">Used for communication between your site and Google. Be sure to keep it a secret.</p>
                                </div>
                            </div>
                        </div>
                        @if($showRecaptchaWarning)
                            <div class="row">
                                <div class="col-xs-12">
                                    <div class="alert alert-warning no-margin">
                                        You are currently using reCAPTCHA keys that were shipped with this Panel. For improved security it is recommended to <a href="https://www.google.com/recaptcha/admin">generate new invisible reCAPTCHA keys</a> that tied specifically to your website.
                                    </div>
                                </div>
                            </div>
                        @endif
                    </div>
                </div>
                <div class="box">
                    <div class="box-header with-border">
                        <h3 class="box-title">HTTP Connections</h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-6">
                                <label class="control-label">Connection Timeout</label>
                                <div>
                                    <input type="number" required class="form-control" name="pterodactyl:guzzle:connect_timeout" value="{{ old('pterodactyl:guzzle:connect_timeout', config('pterodactyl.guzzle.connect_timeout')) }}">
                                    <p class="text-muted small">The amount of time in seconds to wait for a connection to be opened before throwing an error.</p>
                                </div>
                            </div>
                            <div class="form-group col-md-6">
                                <label class="control-label">Request Timeout</label>
                                <div>
                                    <input type="number" required class="form-control" name="pterodactyl:guzzle:timeout" value="{{ old('pterodactyl:guzzle:timeout', config('pterodactyl.guzzle.timeout')) }}">
                                    <p class="text-muted small">The amount of time in seconds to wait for a request to be completed before throwing an error.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box">
                    <div class="box-header with-border">
                        <h3 class="box-title">Automatic Allocation Creation</h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-4">
                                <label class="control-label">Status</label>
                                <div>
                                    <select class="form-control" name="pterodactyl:client_features:allocations:enabled">
                                        <option value="false">Disabled</option>
                                        <option value="true" @if(old('pterodactyl:client_features:allocations:enabled', config('pterodactyl.client_features.allocations.enabled'))) selected @endif>Enabled</option>
                                    </select>
                                    <p class="text-muted small">If enabled users will have the option to automatically create new allocations for their server via the frontend.</p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Starting Port</label>
                                <div>
                                    <input type="number" class="form-control" name="pterodactyl:client_features:allocations:range_start" value="{{ old('pterodactyl:client_features:allocations:range_start', config('pterodactyl.client_features.allocations.range_start')) }}">
                                    <p class="text-muted small">The starting port in the range that can be automatically allocated.</p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Ending Port</label>
                                <div>
                                    <input type="number" class="form-control" name="pterodactyl:client_features:allocations:range_end" value="{{ old('pterodactyl:client_features:allocations:range_end', config('pterodactyl.client_features.allocations.range_end')) }}">
                                    <p class="text-muted small">The ending port in the range that can be automatically allocated.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box box-primary">
                    <div class="box-footer">
                        {{ csrf_field() }}
                        <button type="submit" name="_method" value="PATCH" class="btn btn-sm btn-primary pull-right">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
@endsection
</file>

<file path="resources/views/admin/settings/index.blade.php">
@extends('layouts.admin')
@include('partials/admin.settings.nav', ['activeTab' => 'basic'])

@section('title')
    Settings
@endsection

@section('content-header')
    <h1>Panel Settings<small>Configure Pterodactyl to your liking.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Settings</li>
    </ol>
@endsection

@section('content')
    @yield('settings::nav')
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Panel Settings</h3>
                </div>
                <form action="{{ route('admin.settings') }}" method="POST">
                    <div class="box-body">
                        <div class="row">
                            <div class="form-group col-md-4">
                                <label class="control-label">Company Name</label>
                                <div>
                                    <input type="text" class="form-control" name="app:name" value="{{ old('app:name', config('app.name')) }}" />
                                    <p class="text-muted"><small>This is the name that is used throughout the panel and in emails sent to clients.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Require 2-Factor Authentication</label>
                                <div>
                                    <div class="btn-group" data-toggle="buttons">
                                        @php
                                            $level = old('pterodactyl:auth:2fa_required', config('pterodactyl.auth.2fa_required'));
                                        @endphp
                                        <label class="btn btn-primary @if ($level == 0) active @endif">
                                            <input type="radio" name="pterodactyl:auth:2fa_required" autocomplete="off" value="0" @if ($level == 0) checked @endif> Not Required
                                        </label>
                                        <label class="btn btn-primary @if ($level == 1) active @endif">
                                            <input type="radio" name="pterodactyl:auth:2fa_required" autocomplete="off" value="1" @if ($level == 1) checked @endif> Admin Only
                                        </label>
                                        <label class="btn btn-primary @if ($level == 2) active @endif">
                                            <input type="radio" name="pterodactyl:auth:2fa_required" autocomplete="off" value="2" @if ($level == 2) checked @endif> All Users
                                        </label>
                                    </div>
                                    <p class="text-muted"><small>If enabled, any account falling into the selected grouping will be required to have 2-Factor authentication enabled to use the Panel.</small></p>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="control-label">Default Language</label>
                                <div>
                                    <select name="app:locale" class="form-control">
                                        @foreach($languages as $key => $value)
                                            <option value="{{ $key }}" @if(config('app.locale') === $key) selected @endif>{{ $value }}</option>
                                        @endforeach
                                    </select>
                                    <p class="text-muted"><small>The default language to use when rendering UI components.</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="box-footer">
                        {!! csrf_field() !!}
                        <button type="submit" name="_method" value="PATCH" class="btn btn-sm btn-primary pull-right">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
@endsection
</file>

<file path="resources/views/admin/settings/mail.blade.php">
@extends('layouts.admin')
@include('partials/admin.settings.nav', ['activeTab' => 'mail'])

@section('title')
    Mail Settings
@endsection

@section('content-header')
    <h1>Mail Settings<small>Configure how Pterodactyl should handle sending emails.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Settings</li>
    </ol>
@endsection

@section('content')
    @yield('settings::nav')
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Email Settings</h3>
                </div>
                @if($disabled)
                    <div class="box-body">
                        <div class="row">
                            <div class="col-xs-12">
                                <div class="alert alert-info no-margin-bottom">
                                    This interface is limited to instances using SMTP as the mail driver. Please either use <code>php artisan p:environment:mail</code> command to update your email settings, or set <code>MAIL_DRIVER=smtp</code> in your environment file.
                                </div>
                            </div>
                        </div>
                    </div>
                @else
                    <form>
                        <div class="box-body">
                            <div class="row">
                                <div class="form-group col-md-6">
                                    <label class="control-label">SMTP Host</label>
                                    <div>
                                        <input required type="text" class="form-control" name="mail:mailers:smtp:host" value="{{ old('mail:mailers:smtp:host', config('mail.mailers.smtp.host')) }}" />
                                        <p class="text-muted small">Enter the SMTP server address that mail should be sent through.</p>
                                    </div>
                                </div>
                                <div class="form-group col-md-2">
                                    <label class="control-label">SMTP Port</label>
                                    <div>
                                        <input required type="number" class="form-control" name="mail:mailers:smtp:port" value="{{ old('mail:mailers:smtp:port', config('mail.mailers.smtp.port')) }}" />
                                        <p class="text-muted small">Enter the SMTP server port that mail should be sent through.</p>
                                    </div>
                                </div>
                                <div class="form-group col-md-4">
                                    <label class="control-label">Encryption</label>
                                    <div>
                                        @php
                                            $encryption = old('mail:mailers:smtp:encryption', config('mail.mailers.smtp.encryption'));
                                        @endphp
                                        <select name="mail:mailers:smtp:encryption" class="form-control">
                                            <option value="" @if($encryption === '') selected @endif>None</option>
                                            <option value="tls" @if($encryption === 'tls') selected @endif>Transport Layer Security (TLS)</option>
                                            <option value="ssl" @if($encryption === 'ssl') selected @endif>Secure Sockets Layer (SSL)</option>
                                        </select>
                                        <p class="text-muted small">Select the type of encryption to use when sending mail.</p>
                                    </div>
                                </div>
                                <div class="form-group col-md-6">
                                    <label class="control-label">Username <span class="field-optional"></span></label>
                                    <div>
                                        <input type="text" class="form-control" name="mail:mailers:smtp:username" value="{{ old('mail:mailers:smtp:username', config('mail.mailers.smtp.username')) }}" />
                                        <p class="text-muted small">The username to use when connecting to the SMTP server.</p>
                                    </div>
                                </div>
                                <div class="form-group col-md-6">
                                    <label class="control-label">Password <span class="field-optional"></span></label>
                                    <div>
                                        <input type="password" class="form-control" name="mail:mailers:smtp:password"/>
                                        <p class="text-muted small">The password to use in conjunction with the SMTP username. Leave blank to continue using the existing password. To set the password to an empty value enter <code>!e</code> into the field.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <hr />
                                <div class="form-group col-md-6">
                                    <label class="control-label">Mail From</label>
                                    <div>
                                        <input required type="email" class="form-control" name="mail:from:address" value="{{ old('mail:from:address', config('mail.from.address')) }}" />
                                        <p class="text-muted small">Enter an email address that all outgoing emails will originate from.</p>
                                    </div>
                                </div>
                                <div class="form-group col-md-6">
                                    <label class="control-label">Mail From Name <span class="field-optional"></span></label>
                                    <div>
                                        <input type="text" class="form-control" name="mail:from:name" value="{{ old('mail:from:name', config('mail.from.name')) }}" />
                                        <p class="text-muted small">The name that emails should appear to come from.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="box-footer">
                            {{ csrf_field() }}
                            <div class="pull-right">
                                <button type="button" id="testButton" class="btn btn-sm btn-success">Test</button>
                                <button type="button" id="saveButton" class="btn btn-sm btn-primary">Save</button>
                            </div>
                        </div>
                    </form>
                @endif
            </div>
        </div>
    </div>
@endsection

@section('footer-scripts')
    @parent

    <script>
        function saveSettings() {
            return $.ajax({
                method: 'PATCH',
                url: '/admin/settings/mail',
                contentType: 'application/json',
                data: JSON.stringify({
                    'mail:mailers:smtp:host': $('input[name="mail:mailers:smtp:host"]').val(),
                    'mail:mailers:smtp:port': $('input[name="mail:mailers:smtp:port"]').val(),
                    'mail:mailers:smtp:encryption': $('select[name="mail:mailers:smtp:encryption"]').val(),
                    'mail:mailers:smtp:username': $('input[name="mail:mailers:smtp:username"]').val(),
                    'mail:mailers:smtp:password': $('input[name="mail:mailers:smtp:password"]').val(),
                    'mail:from:address': $('input[name="mail:from:address"]').val(),
                    'mail:from:name': $('input[name="mail:from:name"]').val()
                }),
                headers: { 'X-CSRF-Token': $('input[name="_token"]').val() }
            }).fail(function (jqXHR) {
                showErrorDialog(jqXHR, 'save');
            });
        }

        function testSettings() {
            swal({
                type: 'info',
                title: 'Test Mail Settings',
                text: 'Click "Test" to begin the test.',
                showCancelButton: true,
                confirmButtonText: 'Test',
                closeOnConfirm: false,
                showLoaderOnConfirm: true
            }, function () {
                $.ajax({
                    method: 'POST',
                    url: '/admin/settings/mail/test',
                    headers: { 'X-CSRF-TOKEN': $('input[name="_token"]').val() }
                }).fail(function (jqXHR) {
                    showErrorDialog(jqXHR, 'test');
                }).done(function () {
                    swal({
                        title: 'Success',
                        text: 'The test message was sent successfully.',
                        type: 'success'
                    });
                });
            });
        }

        function saveAndTestSettings() {
            saveSettings().done(testSettings);
        }

        function showErrorDialog(jqXHR, verb) {
            console.error(jqXHR);
            var errorText = '';
            if (!jqXHR.responseJSON) {
                errorText = jqXHR.responseText;
            } else if (jqXHR.responseJSON.error) {
                errorText = jqXHR.responseJSON.error;
            } else if (jqXHR.responseJSON.errors) {
                $.each(jqXHR.responseJSON.errors, function (i, v) {
                    if (v.detail) {
                        errorText += v.detail + ' ';
                    }
                });
            }

            swal({
                title: 'Whoops!',
                text: 'An error occurred while attempting to ' + verb + ' mail settings: ' + errorText,
                type: 'error'
            });
        }

        $(document).ready(function () {
            $('#testButton').on('click', saveAndTestSettings);
            $('#saveButton').on('click', function () {
                saveSettings().done(function () {
                    swal({
                        title: 'Success',
                        text: 'Mail settings have been updated successfully and the queue worker was restarted to apply these changes.',
                        type: 'success'
                    });
                });
            });
        });
    </script>
@endsection
</file>

<file path="resources/views/admin/tickets/index.blade.php">
@extends('layouts.admin')

@section('title')
    List Tickets
@endsection

@section('content-header')
    <h1>Tickets<small>View all of the tickets on the system.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Tickets</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-xs-12">
        <form action="{{ route('admin.tickets.index') }}" method="POST">
            <div class="box @if($enabled == 'true') box-success @else box-danger @endif">
                <div class="box-header with-border">
                    <i class="fa fa-ticket"></i> <h3 class="box-title">Ticket System <small>Toggle whether tickets can be used.</small></h3>
                </div>
                <div class="box-body">
                    <div class="row">
                        <div class="form-group col-md-4">
                            <label class="control-label">Allow ticket creation?</label>
                            <div>
                                <select name="enabled" class="form-control">
                                    <option @if ($enabled == 'false') selected @endif value="false">Disabled</option>
                                    <option @if ($enabled == 'true') selected @endif value="true">Enabled</option>
                                </select>
                                <p class="text-muted"><small>Determines whether people can create tickets via the client UI.</small></p>
                            </div>
                        </div>
                        <div class="form-group col-md-4">
                                <label class="control-label">Maximum ticket amount</label>
                                <div>
                                    <input type="text" class="form-control" name="max" value="{{ $max }}" />
                                    <p class="text-muted"><small>Set the maximum amount of tickets a user can create.</small></p>
                                </div>
                            </div>
                    </div>
                    {!! csrf_field() !!}
                    <button type="submit" name="_method" value="POST" class="btn btn-default pull-right">Save Changes</button>
                </div>
            </div>
        </form>
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">Ticket List</h3>
            </div>
            <div class="box-body table-responsive no-padding">
                <table class="table table-hover">
                    <tbody>
                        <tr>
                            <th>Ticket ID</th>
                            <th>Client Email</th>
                            <th>Title</th>
                            <th>Created At</th>
                            <th></th>
                        </tr>
                        @foreach ($tickets as $ticket)
                            <tr data-ticket="{{ $ticket->id }}">
                                <td><a href="{{ route('admin.tickets.view', $ticket->id) }}">{{ $ticket->id }}</a></td>
                                <td><a href="{{ route('admin.users.view', $ticket->client_id) }}">{{ $ticket->user->email ?? 'N/A' }}</a></td>
                                <td style="
                                    white-space: nowrap;
                                    overflow: hidden;
                                    text-overflow: ellipsis;
                                    max-width: 32ch;
                                "><code title="{{ $ticket->title }}">{{ $ticket->title }}</code></td>
                                <td>{{ $ticket->created_at->diffForHumans() }}</td>
                                <td class="text-center">
                                    @if($ticket->status == 'pending')
                                        <span class="label label-warning">Pending</span>
                                    @elseif($ticket->status == 'in-progress')
                                        <span class="label label-primary">In Progress</span>
                                    @elseif($ticket->status == 'unresolved')
                                        <span class="label label-danger">Unresolved</span>
                                    @else
                                        <span class="label label-success">Resolved</span>
                                    @endif
                                </td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
@endsection
</file>

<file path="resources/views/admin/tickets/view.blade.php">
@extends('layouts.admin')

@section('title')
    View ticket {{ $ticket->id }}
@endsection

@section('content-header')
    <h1>Ticket #{{ $ticket->id }}<small>{{ $ticket->title }}</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.tickets.index') }}">Tickets</a></li>
        <li class="active">View Ticket {{ $ticket->id }}</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-xs-12">
        <div class="alert
            @if($ticket->status == 'pending')
                alert-warning
            @elseif($ticket->status == 'in-progress')
                bg-primary
            @elseif($ticket->status == 'unresolved')
                alert-danger
            @else
                alert-success
            @endif
        ">
            This ticket is currently marked as <code>{{ $ticket->status }}</code>
        </div>
    </div>
</div>
<div class="row">
        <div class="col-xs-12">
            <div class="box box-success">
                <div class="box-header with-border">
                    <form id="deleteform" action="{{ route('admin.tickets.delete', $ticket->id) }}" method="POST">
                        <div class="pull-left">
                            {!! csrf_field() !!}
                            <button class="btn btn-danger">Delete Ticket</button>
                        </div>
                    </form>
                    <form id="statusform" action="{{ route('admin.tickets.status', $ticket->id) }}" method="POST">
                        {!! csrf_field() !!}
                        <div class="pull-right">
                            <button id="unresolvedButton" class="btn btn-danger" name="status" value="unresolved">Mark as Unresolved</button>
                            <button id="pendingButton" class="btn btn-warning" style="margin-left: 8px;" name="status" value="pending">Mark as Pending</button>
                            <button id="resolvedButton" class="btn btn-success" style="margin-left: 8px;" name="status" value="resolved">Mark as Resolved</button>
                            <button id="inProgressButton" class="btn btn-info" style="margin-left: 8px;" name="status" value="in-progress">Mark as In Progress</button>
                        </div>
                    </form>
                 </div>
                <div class="box-body table-responsive no-padding">
                    <table class="table table-hover">
                        <tbody>
                            <tr>
                                <th>Author</th>
                                <th>Content</th>
                                <th></th>
                                <th></th>
                                <th>Message Sent</th>
                            </tr>
                            @foreach ($messages as $message)
                                <tr>
                                @if($message->user_id == 0)
                                    <td>System Message <i class="fa fa-cog text-white"></i></td>
                                @else
                                    <td><a href="{{ route('admin.users.view', $message->user->id) }}">{{ $message->user->email }}</a> @if($message->user->root_admin)<i class="fa fa-star text-yellow"></i>@endif</td>
                                @endif
                                    <td>{{ $message->content }}</td>
                                    <td></td>
                                    <td></td>
                                    <td>{{ $message->created_at->diffForHumans() }}</td>
                                </tr>
                            @endforeach
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
<div class="row">
        <div class="col-xs-12">
            <div class="box box-success">
                <div class="box-header with-border">
                    <h3 class="box-title">Send a Message</h3>
                    <form id="messageform" action="{{ route('admin.tickets.message', $ticket->id) }}" method="POST">
                        <div class="box-body">
                            <div class="row">
                                <div class="form-group col-md-12">
                                    <div>
                                        <input type="text" class="form-control" name="content" />
                                        <p class="text-muted"><small>Send a message to the ticket which can be viewed by the client.</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {!! csrf_field() !!}
                        <button type="submit" name="_method" value="POST" class="btn btn-default pull-right">Send Message</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
@endsection
</file>

<file path="resources/views/admin/users/index.blade.php">
@extends('layouts.admin')

@section('title')
    List Users
@endsection

@section('content-header')
    <h1>Users<small>All registered users on the system.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Users</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-xs-12">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">User List</h3>
                <div class="box-tools search01">
                    <form action="{{ route('admin.users') }}" method="GET">
                        <div class="input-group input-group-sm">
                            <input type="text" name="filter[email]" class="form-control pull-right" value="{{ request()->input('filter.email') }}" placeholder="Search">
                            <div class="input-group-btn">
                                <button type="submit" class="btn btn-default"><i class="fa fa-search"></i></button>
                                <a href="{{ route('admin.users.new') }}"><button type="button" class="btn btn-sm btn-primary" style="border-radius: 0 3px 3px 0;margin-left:-1px;">Create New</button></a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="box-body table-responsive no-padding">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Client Name</th>
                            <th>Username</th>
                            <th class="text-center">2FA</th>
                            <th class="text-center">Approved</th>
                            <th class="text-center"><span data-toggle="tooltip" data-placement="top" title="Servers that this user is marked as the owner of.">Servers Owned</span></th>
                            <th class="text-center"><span data-toggle="tooltip" data-placement="top" title="Servers that this user can access because they are marked as a subuser.">Can Access</span></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach ($users as $user)
                            <tr class="align-middle">
                                <td><code>{{ $user->id }}</code></td>
                                <td><a href="{{ route('admin.users.view', $user->id) }}">{{ $user->email }}</a> @if($user->root_admin)<i class="fa fa-star text-yellow"></i>@endif</td>
                                <td>{{ $user->name_last }}, {{ $user->name_first }}</td>
                                <td>{{ $user->username }}</td>
                                <td class="text-center">
                                    @if($user->use_totp)
                                        <i class="fa fa-lock text-green"></i>
                                    @else
                                        <i class="fa fa-unlock text-red"></i>
                                    @endif
                                </td>
                                <td class="text-center">
                                    @if($user->approved)
                                        <i class="fa fa-check text-green"></i>
                                    @else
                                        <i class="fa fa-times text-red"></i>
                                    @endif
                                </td>
                                <td class="text-center">
                                    <a href="{{ route('admin.servers', ['filter[owner_id]' => $user->id]) }}">{{ $user->servers_count }}</a>
                                </td>
                                <td class="text-center">{{ $user->subuser_of_count }}</td>
                                <td class="text-center"><img src="https://www.gravatar.com/avatar/{{ md5(strtolower($user->email)) }}?s=100" style="height:20px;" class="img-circle" /></td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>
            @if($users->hasPages())
                <div class="box-footer with-border">
                    <div class="col-md-12 text-center">{!! $users->appends(['query' => Request::input('query')])->render() !!}</div>
                </div>
            @endif
        </div>
    </div>
</div>
@endsection
</file>

<file path="resources/views/admin/users/new.blade.php">
@extends('layouts.admin')

@section('title')
    Create User
@endsection

@section('content-header')
    <h1>Create User<small>Add a new user to the system.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.users') }}">Users</a></li>
        <li class="active">Create</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <form method="post">
        <div class="col-md-6">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Identity</h3>
                </div>
                <div class="box-body">
                    <div class="form-group">
                        <label for="email" class="control-label">Email</label>
                        <div>
                            <input type="text" autocomplete="off" name="email" value="{{ old('email') }}" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="username" class="control-label">Username</label>
                        <div>
                            <input type="text" autocomplete="off" name="username" value="{{ old('username') }}" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="name_first" class="control-label">Client First Name</label>
                        <div>
                            <input type="text" autocomplete="off" name="name_first" value="{{ old('name_first') }}" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="name_last" class="control-label">Client Last Name</label>
                        <div>
                            <input type="text" autocomplete="off" name="name_last" value="{{ old('name_last') }}" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Default Language</label>
                        <div>
                            <select name="language" class="form-control">
                                @foreach($languages as $key => $value)
                                    <option value="{{ $key }}" @if(config('app.locale') === $key) selected @endif>{{ $value }}</option>
                                @endforeach
                            </select>
                            <p class="text-muted"><small>The default language to use when rendering the Panel for this user.</small></p>
                        </div>
                    </div>
                </div>
                <div class="box-footer">
                    {!! csrf_field() !!}
                    <input type="submit" value="Create User" class="btn btn-success btn-sm">
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Permissions</h3>
                </div>
                <div class="box-body">
                    <div class="form-group col-md-12">
                        <label for="root_admin" class="control-label">Administrator</label>
                        <div>
                            <select name="root_admin" class="form-control">
                                <option value="0">@lang('strings.no')</option>
                                <option value="1">@lang('strings.yes')</option>
                            </select>
                            <p class="text-muted"><small>Setting this to 'Yes' gives a user full administrative access.</small></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Password</h3>
                </div>
                <div class="box-body">
                    <div class="alert alert-info">
                        <p>Providing a user password is optional. New user emails prompt users to create a password the first time they login. If a password is provided here you will need to find a different method of providing it to the user.</p>
                    </div>
                    <div id="gen_pass" class=" alert alert-success" style="display:none;margin-bottom: 10px;"></div>
                    <div class="form-group">
                        <label for="pass" class="control-label">Password</label>
                        <div>
                            <input type="password" name="password" class="form-control" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
@endsection

@section('footer-scripts')
    @parent
    <script>$("#gen_pass_bttn").click(function (event) {
            event.preventDefault();
            $.ajax({
                type: "GET",
                url: "/password-gen/12",
                headers: {
                    'X-CSRF-TOKEN': '{{ csrf_token() }}'
               },
                success: function(data) {
                    $("#gen_pass").html('<strong>Generated Password:</strong> ' + data).slideDown();
                    $('input[name="password"], input[name="password_confirmation"]').val(data);
                    return false;
                }
            });
            return false;
        });
    </script>
@endsection
</file>

<file path="resources/views/admin/users/resources.blade.php">
@extends('layouts.admin')
@include('partials/admin.users.nav', ['activeTab' => 'resources', 'user' => $user])

@section('title')
    Resources: {{ $user->username }}
@endsection

@section('content-header')
    <h1>{{ $user->name_first }} {{ $user->name_last}}<small>{{ $user->username }}</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.users') }}">Users</a></li>
        <li class="{{ route('admin.users.view', ['user' => $user]) }}">{{ $user->username }}</li>
        <li class="active">Resources</li>
    </ol>
@endsection

@section('content')
    @yield('users::nav')
    <div class="row">
            <div class="col-xs-12">
                <div class="box box-info">
                    <div class="box-header with-border">
                        <h3 class="box-title">User Resources</h3>
                    </div>
                    <form action="{{ route('admin.users.resources', $user->id) }}" method="POST">
                        <div class="box-body">
                            <div class="row">
                                <div class="form-group col-md-3">
                                    <label for="store_balance" class="control-label">Total balance</label>
                                    <div class="input-group">
                                        <input type="text" id="store_balance" value="{{ $user->store_balance }}" name="store_balance" class="form-control form-autocomplete-stop">
                                        <span class="input-group-addon">credits</span>
                                    </div>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="store_cpu" class="control-label">Total CPU available</label>
                                    <div class="input-group">
                                        <input type="text" id="store_cpu" value="{{ $user->store_cpu }}" name="store_cpu" class="form-control form-autocomplete-stop">
                                        <span class="input-group-addon">%</span>
                                    </div>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="store_memory" class="control-label">Total Memory available</label>
                                    <div class="input-group">
                                        <input type="text" id="store_memory" value="{{ $user->store_memory }}" name="store_memory" class="form-control form-autocomplete-stop">
                                        <span class="input-group-addon">MB</span>
                                    </div>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="store_disk" class="control-label">Total Disk available</label>
                                    <div class="input-group">
                                        <input type="text" id="store_disk" value="{{ $user->store_disk }}" name="store_disk" class="form-control form-autocomplete-stop">
                                        <span class="input-group-addon">MB</span>
                                    </div>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="store_slots" class="control-label">Total Slots available</label>
                                    <div class="input-group">
                                        <input type="text" id="store_slots" value="{{ $user->store_slots }}" name="store_slots" class="form-control form-autocomplete-stop">
                                        <span class="input-group-addon">slots</span>
                                    </div>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="store_ports" class="control-label">Total Ports available</label>
                                    <div class="input-group">
                                        <input type="text" id="store_ports" value="{{ $user->store_ports }}" name="store_ports" class="form-control form-autocomplete-stop">
                                        <span class="input-group-addon">ports</span>
                                    </div>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="store_backups" class="control-label">Total Backups available</label>
                                    <div class="input-group">
                                        <input type="text" id="store_backups" value="{{ $user->store_backups }}" name="store_backups" class="form-control form-autocomplete-stop">
                                        <span class="input-group-addon">backups</span>
                                    </div>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="store_databases" class="control-label">Total Databases available</label>
                                    <div class="input-group">
                                        <input type="text" id="store_databases" value="{{ $user->store_databases }}" name="store_databases" class="form-control form-autocomplete-stop">
                                        <span class="input-group-addon">databases</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="box-footer">
                            {!! csrf_field() !!}
                            <button type="submit" name="_method" value="PATCH" class="btn btn-sm btn-primary pull-right">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
@endsection
</file>

<file path="resources/views/admin/users/view.blade.php">
@extends('layouts.admin')
@include('partials/admin.users.nav', ['activeTab' => 'overview', 'user' => $user])

@section('title')
    Manage User: {{ $user->username }}
@endsection

@section('content-header')
    <h1>{{ $user->name_first }} {{ $user->name_last}}<small>{{ $user->username }}</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li><a href="{{ route('admin.users') }}">Users</a></li>
        <li class="active">{{ $user->username }}</li>
    </ol>
@endsection

@section('content')
    @yield('users::nav')
    <div class="row">
        <form action="{{ route('admin.users.view', $user->id) }}" method="post">
            <div class="col-md-6">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">Identity</h3>
                    </div>
                    <div class="box-body">
                        <div class="form-group">
                            <label for="email" class="control-label">Email</label>
                            <div>
                                <input type="email" name="email" value="{{ $user->email }}" class="form-control form-autocomplete-stop">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="registered" class="control-label">Username</label>
                            <div>
                                <input type="text" name="username" value="{{ $user->username }}" class="form-control form-autocomplete-stop">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="registered" class="control-label">Client First Name</label>
                            <div>
                                <input type="text" name="name_first" value="{{ $user->name_first }}" class="form-control form-autocomplete-stop">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="registered" class="control-label">Client Last Name</label>
                            <div>
                                <input type="text" name="name_last" value="{{ $user->name_last }}" class="form-control form-autocomplete-stop">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label">Default Language</label>
                            <div>
                                <select name="language" class="form-control">
                                    @foreach($languages as $key => $value)
                                        <option value="{{ $key }}" @if($user->language === $key) selected @endif>{{ $value }}</option>
                                    @endforeach
                                </select>
                                <p class="text-muted"><small>The default language to use when rendering the Panel for this user.</small></p>
                            </div>
                        </div>
                    </div>
                    <div class="box-footer">
                        {!! csrf_field() !!}
                        {!! method_field('PATCH') !!}
                        <input type="submit" value="Update User" class="btn btn-primary btn-sm">
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="box">
                    <div class="box-header with-border">
                        <h3 class="box-title">Password</h3>
                    </div>
                    <div class="box-body">
                        <div class="alert alert-success" style="display:none;margin-bottom:10px;" id="gen_pass"></div>
                        <div class="form-group no-margin-bottom">
                            <label for="password" class="control-label">Password <span class="field-optional"></span></label>
                            <div>
                                <input type="password" id="password" name="password" class="form-control form-autocomplete-stop">
                                <p class="text-muted small">Leave blank to keep this user's password the same. User will not receive any notification if password is changed.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="box">
                    <div class="box-header with-border">
                        <h3 class="box-title">Permissions</h3>
                    </div>
                    <div class="box-body">
                        <div class="form-group">
                            <label for="root_admin" class="control-label">Administrator</label>
                            <div>
                                <select name="root_admin" class="form-control">
                                    <option value="0">@lang('strings.no')</option>
                                    <option value="1" {{ $user->root_admin ? 'selected="selected"' : '' }}>@lang('strings.yes')</option>
                                </select>
                                <p class="text-muted"><small>Setting this to 'Yes' gives a user full administrative access.</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <div class="col-xs-12">
            <div class="box box-danger">
                <div class="box-header with-border">
                    <h3 class="box-title">Delete User</h3>
                </div>
                <div class="box-body">
                    <p class="no-margin">There must be no servers associated with this account in order for it to be deleted.</p>
                </div>
                <div class="box-footer">
                    <form action="{{ route('admin.users.view', $user->id) }}" method="POST">
                        {!! csrf_field() !!}
                        {!! method_field('DELETE') !!}
                        <input id="delete" type="submit" class="btn btn-sm btn-danger pull-right" {{ $user->servers->count() < 1 ?: 'disabled' }} value="Delete User" />
                    </form>
                </div>
            </div>
        </div>
    </div>
@endsection
</file>

<file path="resources/views/admin/index.blade.php">
@extends('layouts.admin')

@section('title')
    Administration
@endsection

@section('content-header')
    <h1>Administrative Overview<small>A quick glance at your system.</small></h1>
    <ol class="breadcrumb">
        <li><a href="{{ route('admin.index') }}">Admin</a></li>
        <li class="active">Index</li>
    </ol>
@endsection

@section('content')
<div class="row">
    <div class="col-xs-12">
        <div class="box
            @if($version->isLatestPanel())
                box-success
            @else
                box-danger
            @endif
        ">
            <div class="box-header with-border">
                <h3 class="box-title">System Information</h3>
            </div>
            <div class="box-body">
                @if ($version->isLatestPanel())
                    You are running Pterodactyl Panel version <code>{{ config('app.version') }}</code>. Your panel is up-to-date!
                @else
                    Your panel is <strong>not up-to-date!</strong> The latest version is <a href="https://github.com/Pterodactyl/Panel/releases/v{{ $version->getPanel() }}" target="_blank"><code>{{ $version->getPanel() }}</code></a> and you are currently running version <code>{{ config('app.version') }}</code>.
                @endif
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-xs-6 col-sm-3 text-center">
        <a href="{{ $version->getDiscord() }}"><button class="btn btn-warning" style="width:100%;"><i class="fa fa-fw fa-support"></i> Get Help <small>(via Discord)</small></button></a>
    </div>
    <div class="col-xs-6 col-sm-3 text-center">
        <a href="https://pterodactyl.io"><button class="btn btn-primary" style="width:100%;"><i class="fa fa-fw fa-link"></i> Documentation</button></a>
    </div>
    <div class="clearfix visible-xs-block">&nbsp;</div>
    <div class="col-xs-6 col-sm-3 text-center">
        <a href="https://github.com/pterodactyl/panel"><button class="btn btn-primary" style="width:100%;"><i class="fa fa-fw fa-support"></i> Github</button></a>
    </div>
    <div class="col-xs-6 col-sm-3 text-center">
        <a href="{{ $version->getDonations() }}"><button class="btn btn-success" style="width:100%;"><i class="fa fa-fw fa-money"></i> Support the Project</button></a>
    </div>
</div>
@endsection
</file>

<file path="resources/views/errors/401.blade.php">
@extends('errors::minimal')

@section('title', __('Unauthorized'))
@section('code', '401')
@section('message', __('Unauthorized'))
</file>

<file path="resources/views/errors/402.blade.php">
@extends('errors::minimal')

@section('title', __('Payment Required'))
@section('code', '402')
@section('message', __('Payment Required'))
</file>

<file path="resources/views/errors/403.blade.php">
@extends('errors::minimal')

@section('title', __('Forbidden'))
@section('code', '403')
@section('message', __($exception->getMessage() ?: 'Forbidden'))
</file>

<file path="resources/views/errors/404.blade.php">
@extends('errors::minimal')

@section('title', __('Not Found'))
@section('code', '404')
@section('message', __('Not Found'))
</file>

<file path="resources/views/errors/419.blade.php">
@extends('errors::minimal')

@section('title', __('Page Expired'))
@section('code', '419')
@section('message', __('Page Expired'))
</file>

<file path="resources/views/errors/429.blade.php">
@extends('errors::minimal')

@section('title', __('Too Many Requests'))
@section('code', '429')
@section('message', __('Too Many Requests'))
</file>

<file path="resources/views/errors/500.blade.php">
@extends('errors::minimal')

@section('title', __('Server Error'))
@section('code', '500')
@section('message', __('Server Error'))
</file>

<file path="resources/views/errors/503.blade.php">
@extends('errors::minimal')
<link rel="icon" type="image/png" href="/assets/logo.png">
@section('title', __('Panel Under Maintenance'))

@section('message')
<div style="
    background:rgba(0, 0, 0, 0.4);
    border: 2px solid #e5e7eb;
    border-radius: 16px;
    padding: 40px;
    max-width: 90vw;
    margin: 20px auto;
    text-align: center;
">
    <img src="/assets/logo.png" alt="Logo" style="max-width: 150px; margin-bottom: 20px;">
    <h1 style="color:rgb(255, 255, 255); font-size: 32px; font-weight: bold; margin-bottom: 20px;">Panel Under Maintenance</h1>    
    <p style="color: #6b7280; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        Were performing panel maintenance that wont affect your hosting services. Check our Discord for updates on progress and timing.
    </p>
    
    <a href="https://discord.gg/neodesigns" style="
        background: #5865f2;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
    ">Join Discord</a>
</div>
@endsection
</file>

<file path="resources/views/errors/layout.blade.php">
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>@yield('title')</title>

        <!-- Styles -->
        <style>
            html, body {
                background-color: #fff;
                color: #636b6f;
                font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
                font-weight: 100;
                height: 100vh;
                margin: 0;
            }

            .full-height {
                height: 100vh;
            }

            .flex-center {
                align-items: center;
                display: flex;
                justify-content: center;
            }

            .position-ref {
                position: relative;
            }

            .content {
                text-align: center;
            }

            .title {
                font-size: 36px;
                padding: 20px;
            }
        </style>
    </head>
    <body>
        <div class="flex-center position-ref full-height">
            <div class="content">
                <div class="title">
                    @yield('message')
                </div>
            </div>
        </div>
    </body>
</html>
</file>

<file path="resources/views/errors/minimal.blade.php">
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>@yield('title')</title>

        <style>
            /*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}a{background-color:transparent}code{font-family:monospace,monospace;font-size:1em}[hidden]{display:none}html{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}*,:after,:before{box-sizing:border-box;border:0 solid #e2e8f0}a{color:inherit;text-decoration:inherit}code{font-family:Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}svg,video{display:block;vertical-align:middle}video{max-width:100%;height:auto}.bg-white{--bg-opacity:1;background-color:#fff;background-color:rgba(255,255,255,var(--bg-opacity))}.bg-gray-100{--bg-opacity:1;background-color:#f7fafc;background-color:rgba(247,250,252,var(--bg-opacity))}.border-gray-200{--border-opacity:1;border-color:#edf2f7;border-color:rgba(237,242,247,var(--border-opacity))}.border-gray-400{--border-opacity:1;border-color:#cbd5e0;border-color:rgba(203,213,224,var(--border-opacity))}.border-t{border-top-width:1px}.border-r{border-right-width:1px}.flex{display:flex}.grid{display:grid}.hidden{display:none}.items-center{align-items:center}.justify-center{justify-content:center}.font-semibold{font-weight:600}.h-5{height:1.25rem}.h-8{height:2rem}.h-16{height:4rem}.text-sm{font-size:.875rem}.text-lg{font-size:1.125rem}.leading-7{line-height:1.75rem}.mx-auto{margin-left:auto;margin-right:auto}.ml-1{margin-left:.25rem}.mt-2{margin-top:.5rem}.mr-2{margin-right:.5rem}.ml-2{margin-left:.5rem}.mt-4{margin-top:1rem}.ml-4{margin-left:1rem}.mt-8{margin-top:2rem}.ml-12{margin-left:3rem}.-mt-px{margin-top:-1px}.max-w-xl{max-width:36rem}.max-w-6xl{max-width:72rem}.min-h-screen{min-height:100vh}.overflow-hidden{overflow:hidden}.p-6{padding:1.5rem}.py-4{padding-top:1rem;padding-bottom:1rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.pt-8{padding-top:2rem}.fixed{position:fixed}.relative{position:relative}.top-0{top:0}.right-0{right:0}.shadow{box-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06)}.text-center{text-align:center}.text-gray-200{--text-opacity:1;color:#edf2f7;color:rgba(237,242,247,var(--text-opacity))}.text-gray-300{--text-opacity:1;color:#e2e8f0;color:rgba(226,232,240,var(--text-opacity))}.text-gray-400{--text-opacity:1;color:#cbd5e0;color:rgba(203,213,224,var(--text-opacity))}.text-gray-500{--text-opacity:1;color:#a0aec0;color:rgba(160,174,192,var(--text-opacity))}.text-gray-600{--text-opacity:1;color:#718096;color:rgba(113,128,150,var(--text-opacity))}.text-gray-700{--text-opacity:1;color:#4a5568;color:rgba(74,85,104,var(--text-opacity))}.text-gray-900{--text-opacity:1;color:#1a202c;color:rgba(26,32,44,var(--text-opacity))}.uppercase{text-transform:uppercase}.underline{text-decoration:underline}.antialiased{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.tracking-wider{letter-spacing:.05em}.w-5{width:1.25rem}.w-8{width:2rem}.w-auto{width:auto}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}@-webkit-keyframes spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}@keyframes spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}@-webkit-keyframes ping{0%{transform:scale(1);opacity:1}75%,to{transform:scale(2);opacity:0}}@keyframes ping{0%{transform:scale(1);opacity:1}75%,to{transform:scale(2);opacity:0}}@-webkit-keyframes pulse{0%,to{opacity:1}50%{opacity:.5}}@keyframes pulse{0%,to{opacity:1}50%{opacity:.5}}@-webkit-keyframes bounce{0%,to{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:translateY(0);-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}@keyframes bounce{0%,to{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:translateY(0);-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}@media (min-width:640px){.sm\:rounded-lg{border-radius:.5rem}.sm\:block{display:block}.sm\:items-center{align-items:center}.sm\:justify-start{justify-content:flex-start}.sm\:justify-between{justify-content:space-between}.sm\:h-20{height:5rem}.sm\:ml-0{margin-left:0}.sm\:px-6{padding-left:1.5rem;padding-right:1.5rem}.sm\:pt-0{padding-top:0}.sm\:text-left{text-align:left}.sm\:text-right{text-align:right}}@media (min-width:768px){.md\:border-t-0{border-top-width:0}.md\:border-l{border-left-width:1px}.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (min-width:1024px){.lg\:px-8{padding-left:2rem;padding-right:2rem}}@media (prefers-color-scheme:dark){.dark\:bg-gray-800{--bg-opacity:1;background-color:#2d3748;background-color:rgba(45,55,72,var(--bg-opacity))}.dark\:bg-gray-900{--bg-opacity:1;background-color:#1a202c;background-color:rgba(26,32,44,var(--bg-opacity))}.dark\:border-gray-700{--border-opacity:1;border-color:#4a5568;border-color:rgba(74,85,104,var(--border-opacity))}.dark\:text-white{--text-opacity:1;color:#fff;color:rgba(255,255,255,var(--text-opacity))}.dark\:text-gray-400{--text-opacity:1;color:#cbd5e0;color:rgba(203,213,224,var(--text-opacity))}}
        </style>

        <style>
            body {
                font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            }
        </style>
    </head>
    <body class="antialiased">
        <div class="relative flex items-top justify-center min-h-screen bg-gray-100 dark:bg-gray-900 sm:items-center sm:pt-0">
            <div class="max-w-xl mx-auto sm:px-6 lg:px-8">
                <div class="flex items-center pt-8 sm:justify-start sm:pt-0">
                    <div class="px-4 text-lg text-gray-500 border-r border-gray-400 tracking-wider">
                        @yield('code')
                    </div>

                    <div class="ml-4 text-lg text-gray-500 uppercase tracking-wider">
                        @yield('message')
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
</file>

<file path="resources/views/layouts/admin.blade.php">
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>{{ config('app.name', 'Jexactyl') }} - @yield('title')</title>
        <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
        <meta name="_token" content="{{ csrf_token() }}">

        <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="/favicons/manifest.json">
        <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#bc6e3c">
        <link rel="shortcut icon" href="/favicons/favicon.ico">
        <meta name="msapplication-config" content="/favicons/browserconfig.xml">
        <meta name="theme-color" content="#0e4688">

        <script src="https://unpkg.com/feather-icons"></script>

        @include('layouts.scripts')

        @section('scripts')
            {!! Theme::css('vendor/select2/select2.min.css?t={cache-version}') !!}
            {!! Theme::css('vendor/bootstrap/bootstrap.min.css?t={cache-version}') !!}
            {!! Theme::css('vendor/adminlte/admin.min.css?t={cache-version}') !!}
            {!! Theme::css('vendor/adminlte/colors/skin-blue.min.css?t={cache-version}') !!}
            {!! Theme::css('vendor/sweetalert/sweetalert.min.css?t={cache-version}') !!}
            {!! Theme::css('vendor/animate/animate.min.css?t={cache-version}') !!}
            <!-- Ability to customize Jexactyl theme -->
            <link rel="stylesheet" href="/themes/{{ config('theme.admin', 'jexactyl') }}/css/{{ config('theme.admin', 'jexactyl') }}.css">

            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
        @show
    </head>
    <body class="skin-blue fixed">
        <div class="wrapper">
            <header class="main-header">
                <a href="{{ route('index') }}" class="logo">
                    <img src="{{ config('app.logo') }}" width="48" height="48" />
                </a>
            </header>
            <aside class="main-sidebar">
                <section class="sidebar">
                    <ul class="sidebar-menu">
                        <li class="{{ ! starts_with(Route::currentRouteName(), 'admin.index') ?: 'active' }}">
                            <a href="{{ route('admin.index')}}">
                                <i data-feather="tool" style="margin-left: 12px;"></i> 
                            </a>
                        </li>
                        <li class="{{ ! starts_with(Route::currentRouteName(), 'admin.tickets') ?: 'active' }}">
                            <a href="{{ route('admin.tickets.index')}}">
                                <i data-feather="help-circle" style="margin-left: 12px;"></i>
                            </a>
                        </li>
                        <li class="{{ ! starts_with(Route::currentRouteName(), 'admin.api') ?: 'active' }}">
                            <a href="{{ route('admin.api.index')}}">
                                <i data-feather="git-branch" style="margin-left: 12px;"></i>
                            </a>
                        </li>
                        <li class="{{ ! starts_with(Route::currentRouteName(), 'admin.databases') ?: 'active' }}">
                            <a href="{{ route('admin.databases') }}">
                                <i data-feather="database" style="margin-left: 12px;"></i>
                            </a>
                        </li>
                        <li class="{{ ! starts_with(Route::currentRouteName(), 'admin.locations') ?: 'active' }}">
                            <a href="{{ route('admin.locations') }}">
                                <i data-feather="navigation" style="margin-left: 12px;"></i>
                            </a>
                        </li>
                        <li class="{{ ! starts_with(Route::currentRouteName(), 'admin.nodes') ?: 'active' }}">
                            <a href="{{ route('admin.nodes') }}">
                                <i data-feather="layers" style="margin-left: 12px;"></i>
                            </a>
                        </li>
                        <li class="{{ ! starts_with(Route::currentRouteName(), 'admin.servers') ?: 'active' }}">
                            <a href="{{ route('admin.servers') }}">
                                <i data-feather="server" style="margin-left: 12px;"></i>
                            </a>
                        </li>
                        <li class="{{ ! starts_with(Route::currentRouteName(), 'admin.users') ?: 'active' }}">
                            <a href="{{ route('admin.users') }}">
                                <i data-feather="users" style="margin-left: 12px;"></i>
                            </a>
                        </li>
                        <li class="{{ ! starts_with(Route::currentRouteName(), 'admin.mounts') ?: 'active' }}">
                            <a href="{{ route('admin.mounts') }}">
                                <i data-feather="hard-drive" style="margin-left: 12px;"></i>
                            </a>
                        </li>
                        <li class="{{ ! starts_with(Route::currentRouteName(), 'admin.nests') ?: 'active' }}">
                            <a href="{{ route('admin.nests') }}">
                                <i data-feather="archive" style="margin-left: 12px;"></i>
                            </a>
                        </li>
                    </ul>
                </section>
            </aside>
            <div class="content-wrapper">
                <section class="content-header">
                    @yield('content-header')
                </section>
                <section class="content">
                    <div class="row">
                        <div class="col-xs-12">
                            @if (count($errors) > 0)
                                <div class="alert alert-danger">
                                    There was an error validating the data provided.<br><br>
                                    <ul>
                                        @foreach ($errors->all() as $error)
                                            <li>{{ $error }}</li>
                                        @endforeach
                                    </ul>
                                </div>
                            @endif
                            @foreach (Alert::getMessages() as $type => $messages)
                                @foreach ($messages as $message)
                                    <div class="alert alert-{{ $type }} alert-dismissable" role="alert">
                                        {!! $message !!}
                                    </div>
                                @endforeach
                            @endforeach
                        </div>
                    </div>
                    @yield('content')
                </section>
            </div>
        </div>
        @section('footer-scripts')
            <script src="/js/keyboard.polyfill.js" type="application/javascript"></script>
            <script>keyboardeventKeyPolyfill.polyfill();</script>

            {!! Theme::js('vendor/jquery/jquery.min.js?t={cache-version}') !!}
            {!! Theme::js('vendor/sweetalert/sweetalert.min.js?t={cache-version}') !!}
            {!! Theme::js('vendor/bootstrap/bootstrap.min.js?t={cache-version}') !!}
            {!! Theme::js('vendor/slimscroll/jquery.slimscroll.min.js?t={cache-version}') !!}
            {!! Theme::js('vendor/adminlte/app.min.js?t={cache-version}') !!}
            {!! Theme::js('vendor/bootstrap-notify/bootstrap-notify.min.js?t={cache-version}') !!}
            {!! Theme::js('vendor/select2/select2.full.min.js?t={cache-version}') !!}
            {!! Theme::js('js/admin/functions.js?t={cache-version}') !!}
            <script src="/js/autocomplete.js" type="application/javascript"></script>

            <script>
                feather.replace()
            </script>

            @if(Auth::user()->root_admin)
                <script>
                    $('#logoutButton').on('click', function (event) {
                        event.preventDefault();

                        var that = this;
                        swal({
                            title: 'Do you want to log out?',
                            type: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d9534f',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Log out'
                        }, function () {
                             $.ajax({
                                type: 'POST',
                                url: '{{ route('auth.logout') }}',
                                data: {
                                    _token: '{{ csrf_token() }}'
                                },complete: function () {
                                    window.location.href = '{{route('auth.login')}}';
                                }
                        });
                    });
                });
                </script>
            @endif

            <script>
                $(function () {
                    $('[data-toggle="tooltip"]').tooltip();
                })
            </script>
        @show
    </body>
</html>
</file>

<file path="resources/views/layouts/scripts.blade.php">
{{-- Just here as a binder for dynamically rendered content. --}}
</file>

<file path="resources/views/partials/admin/jexactyl/nav.blade.php">
@section('jexactyl::nav')
    <div class="row">
        <div class="col-xs-12">
            <div class="nav-tabs-custom">
                <ul class="nav nav-tabs">

                    <li @if($activeTab === 'index') class="active "@endif>
                        <a href="{{ route('admin.index') }}">Home</a>
                    </li>
                    <li @if($activeTab === 'appearance') class="active" @endif>
                        <a href="{{ route('admin.jexactyl.appearance') }}">Appearance</a>
                    </li>
                    <li @if($activeTab === 'mail') class="active" @endif>
                        <a href="{{ route('admin.jexactyl.mail') }}">Mail</a>
                    </li>
                    <li @if($activeTab === 'advanced') class="active" @endif>
                        <a href="{{ route('admin.jexactyl.advanced') }}">Advanced</a>
                    </li>

                    <li style="margin-left: 5px; margin-right: 5px;"><a>-</a></li>

                    <li @if($activeTab === 'store') class="active" @endif>
                        <a href="{{ route('admin.jexactyl.store') }}">Storefront</a>
                    </li>
                    <li @if($activeTab === 'registration') class="active" @endif>
                        <a href="{{ route('admin.jexactyl.registration') }}">Registration</a>
                    </li>
                    <li @if($activeTab === 'approvals') class="active" @endif>
                        <a href="{{ route('admin.jexactyl.approvals') }}">Approvals</a>
                    </li>
                    <li @if($activeTab === 'server') class="active" @endif>
                        <a href="{{ route('admin.jexactyl.server') }}">Server Settings</a>
                    </li>
                    <li @if($activeTab === 'referrals') class="active" @endif>
                        <a href="{{ route('admin.jexactyl.referrals') }}">Referrals</a>
                    </li>
                    <li @if($activeTab === 'alerts') class="active" @endif>
                        <a href="{{ route('admin.jexactyl.alerts') }}">Alerts</a>
                    </li>
                    <li @if($activeTab === 'coupons') class="active" @endif>
                        <a href="{{ route('admin.jexactyl.coupons') }}">Coupons</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
@endsection
</file>

<file path="resources/views/partials/admin/settings/nav.blade.php">
@include('partials/admin.settings.notice')

@section('settings::nav')
    @yield('settings::notice')
    <div class="row">
        <div class="col-xs-12">
            <div class="nav-tabs-custom nav-tabs-floating">
                <ul class="nav nav-tabs">
                    <li @if($activeTab === 'basic')class="active"@endif><a href="{{ route('admin.settings') }}">General</a></li>
                    <li @if($activeTab === 'mail')class="active"@endif><a href="{{ route('admin.settings.mail') }}">Mail</a></li>
                    <li @if($activeTab === 'advanced')class="active"@endif><a href="{{ route('admin.settings.advanced') }}">Advanced</a></li>
                </ul>
            </div>
        </div>
    </div>
@endsection
</file>

<file path="resources/views/partials/admin/settings/notice.blade.php">
@section('settings::notice')
    @if(config('pterodactyl.load_environment_only', false))
        <div class="row">
            <div class="col-xs-12">
                <div class="alert alert-danger">
                    Your Panel is currently configured to read settings from the environment only. You will need to set <code>APP_ENVIRONMENT_ONLY=false</code> in your environment file in order to load settings dynamically.
                </div>
            </div>
        </div>
    @endif
@endsection
</file>

<file path="resources/views/partials/admin/users/nav.blade.php">
@section('users::nav')
    <div class="row">
        <div class="col-xs-12">
            <div class="nav-tabs-custom nav-tabs-floating">
                <ul class="nav nav-tabs">
                    <li @if($activeTab === 'overview')class="active"@endif><a href="{{ route('admin.users.view', ['user' => $user]) }}">Overview</a></li>
                    <li @if($activeTab === 'resources')class="active"@endif><a href="{{ route('admin.users.resources', ['user' => $user]) }}">Resources</a></li>
                </ul>
            </div>
        </div>
    </div>
@endsection
</file>

<file path="resources/views/partials/schedules/task-template.blade.php">
@section('tasks::chain-template')
<div class="box-footer with-border task-list-item" data-target="task-clone">
    <div class="row">
        <div class="form-group col-md-3">
            <label class="control-label">@lang('server.schedule.task.time')</label>
            <div class="row">
                <div class="col-xs-4">
                    <select name="tasks[time_value][]" class="form-control">
                        @foreach(range(0, 59) as $number)
                            <option value="{{ $number }}">{{ $number }}</option>
                        @endforeach
                    </select>
                </div>
                <div class="col-xs-8">
                    <select name="tasks[time_interval][]" class="form-control">
                        <option value="s">@lang('strings.seconds')</option>
                        <option value="m">@lang('strings.minutes')</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="form-group col-md-3">
            <label class="control-label">@lang('server.schedule.task.action')</label>
            <div>
                <select name="tasks[action][]" class="form-control">
                    <option value="command">@lang('server.schedule.actions.command')</option>
                    <option value="power">@lang('server.schedule.actions.power')</option>
                </select>
            </div>
        </div>
        <div class="form-group col-md-6">
            <label class="control-label">@lang('server.schedule.task.payload')</label>
            <div data-attribute="remove-task-element">
                <input type="text" name="tasks[payload][]" class="form-control">
                <div class="input-group-btn hidden">
                    <button type="button" class="btn btn-danger" data-action="remove-task"><i class="fa fa-close"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>
@show
</file>

<file path="resources/views/templates/auth/core.blade.php">
@extends('templates/wrapper', [
    'css' => ['body' => 'bg-neutral-900']
])

@section('container')
    <div id="app"></div>
@endsection
</file>

<file path="resources/views/templates/base/core.blade.php">
@extends('templates/wrapper', [
    'css' => ['body' => 'bg-neutral-800'],
])

@section('container')
    <div id="modal-portal"></div>
    <div id="app"></div>
@endsection
</file>

<file path="resources/views/templates/wrapper.blade.php">
<!DOCTYPE html>
<html>
    <head>
        <title>{{ config('app.name', 'Jexactyl') }}</title>

        @section('meta')
            <meta charset="utf-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
            <meta name="csrf-token" content="{{ csrf_token() }}">
            <meta name="robots" content="noindex">
            <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
            <link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
            <link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
            <link rel="manifest" href="/favicons/manifest.json">
            <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#bc6e3c">
            <link rel="shortcut icon" href="/favicons/favicon.ico">
            <meta name="msapplication-config" content="/favicons/browserconfig.xml">
            <meta name="theme-color" content="#0e4688">
        @show

        @section('user-data')
            @if(!is_null(Auth::user()))
                <script>
                    window.JexactylUser = {!! json_encode(Auth::user()->toVueObject()) !!};
                </script>
            @endif
            @if(!empty($siteConfiguration))
                <script>
                    window.SiteConfiguration = {!! json_encode($siteConfiguration) !!};
                </script>
            @endif
            @if(!empty($storeConfiguration))
                <script>
                    window.StoreConfiguration = {!! json_encode($storeConfiguration) !!};
                </script>
            @endif
        @show

        @if(!empty($siteConfiguration['background']))
            <style>
                body {
                    background-image: url({!! $siteConfiguration['background'] !!});
                    background-repeat: no-repeat;
                    background-attachment: fixed;
                    background-size: cover;
                }
            </style>
        @endif

        <style>
            @import url('//fonts.googleapis.com/css?family=Rubik:300,400,500&display=swap');
            @import url('//fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:500&display=swap');
        </style>

        @yield('assets')

        @include('layouts.scripts')
    </head>
    <body>
        @section('content')
            @yield('above-container')
            @yield('container')
            @yield('below-container')
        @show
        @section('scripts')
            {!! $asset->js('main.js') !!}
        @show
    </body>
</html>
</file>

<file path="routes/admin.php">
<?php

use Jexactyl\Http\Controllers\Admin;
use Illuminate\Support\Facades\Route;
use Jexactyl\Http\Controllers\Admin\Jexactyl;
use Jexactyl\Http\Middleware\Admin\Servers\ServerInstalled;

/*
|--------------------------------------------------------------------------
| Admin Controller Routes
|--------------------------------------------------------------------------
|
| Endpoint: /admin
|
*/
Route::group(['prefix' => '/'], function () {
    Route::get('/', [Jexactyl\IndexController::class, 'index'])->name('admin.index');

    Route::group(['prefix' => '/appearance'], function () {
        Route::get('/', [Jexactyl\AppearanceController::class, 'index']);
        Route::patch('/', [Jexactyl\AppearanceController::class, 'update'])->name('admin.jexactyl.appearance');
    });

    Route::group(['prefix' => '/mail'], function () {
        Route::get('/', [Jexactyl\MailController::class, 'index']);
        Route::patch('/', [Jexactyl\MailController::class, 'update'])->name('admin.jexactyl.mail');
        Route::post('/test', [Jexactyl\MailController::class, 'test'])->name('admin.jexactyl.mail.test');
    });

    Route::group(['prefix' => '/advanced'], function () {
        Route::get('/', [Jexactyl\AdvancedController::class, 'index']);
        Route::patch('/', [Jexactyl\AdvancedController::class, 'update'])->name('admin.jexactyl.advanced');
    });

    Route::group(['prefix' => '/store'], function () {
        Route::get('/', [Jexactyl\StoreController::class, 'index']);
        Route::patch('/', [Jexactyl\StoreController::class, 'update'])->name('admin.jexactyl.store');
    });

    Route::group(['prefix' => '/registration'], function () {
        Route::get('/', [Jexactyl\RegistrationController::class, 'index']);
        Route::patch('/', [Jexactyl\RegistrationController::class, 'update'])->name('admin.jexactyl.registration');
    });

    Route::group(['prefix' => '/approvals'], function () {
        Route::get('/', [Jexactyl\ApprovalsController::class, 'index']);

        Route::patch('/', [Jexactyl\ApprovalsController::class, 'update'])->name('admin.jexactyl.approvals');

        Route::post('/deny/{id}', [Jexactyl\ApprovalsController::class, 'deny'])->name('admin.jexactyl.approvals.deny');
        Route::post('/approve/all', [Jexactyl\ApprovalsController::class, 'bulkAction'])->name('admin.jexactyl.approvals.all');
        Route::post('/approve/{id}', [Jexactyl\ApprovalsController::class, 'approve'])->name('admin.jexactyl.approvals.approve');
    });

    Route::group(['prefix' => '/server'], function () {
        Route::get('/', [Jexactyl\ServerController::class, 'index']);
        Route::patch('/', [Jexactyl\ServerController::class, 'update'])->name('admin.jexactyl.server');
    });

    Route::group(['prefix' => '/referrals'], function () {
        Route::get('/', [Jexactyl\ReferralsController::class, 'index']);
        Route::patch('/', [Jexactyl\ReferralsController::class, 'update'])->name('admin.jexactyl.referrals');
    });

    Route::group(['prefix' => '/alerts'], function () {
        Route::get('/', [Jexactyl\AlertsController::class, 'index']);
        Route::patch('/', [Jexactyl\AlertsController::class, 'update'])->name('admin.jexactyl.alerts');
        Route::post('/remove', [Jexactyl\AlertsController::class, 'remove'])->name('admin.jexactyl.alerts.remove');
    });

    Route::group(['prefix' => '/coupons'], function () {
        Route::get('/', [Jexactyl\CouponsController::class, 'index']);
        Route::patch('/', [Jexactyl\CouponsController::class, 'update'])->name('admin.jexactyl.coupons');
        Route::post('/store', [Jexactyl\CouponsController::class, 'store'])->name('admin.jexactyl.coupons.store');
    });

    Route::group(['prefix' => '/upgrade'], function () {
        Route::get('/', [Jexactyl\UpgradeController::class, 'index'])->name('admin.jexactyl.upgrade');
    });
});

/*
|--------------------------------------------------------------------------
| Ticket Controller Routes
|--------------------------------------------------------------------------
|
| Endpoint: /admin/tickets
|
*/
Route::group(['prefix' => 'tickets'], function () {
    Route::get('/', [Admin\TicketsController::class, 'index'])->name('admin.tickets.index');
    Route::get('/{ticket:id}', [Admin\TicketsController::class, 'view'])->name('admin.tickets.view');

    Route::post('/', [Admin\TicketsController::class, 'toggle'])->name('admin.tickets.index');
    Route::post('/{ticket:id}/status', [Admin\TicketsController::class, 'status'])->name('admin.tickets.status');
    Route::post('/{ticket:id}/delete', [Admin\TicketsController::class, 'delete'])->name('admin.tickets.delete');
    Route::post('/{ticket:id}/message', [Admin\TicketsController::class, 'message'])->name('admin.tickets.message');
});

/*
|--------------------------------------------------------------------------
| Location Controller Routes
|--------------------------------------------------------------------------
|
| Endpoint: /admin/api
|
*/
Route::group(['prefix' => 'api'], function () {
    Route::get('/', [Admin\ApiController::class, 'index'])->name('admin.api.index');
    Route::get('/new', [Admin\ApiController::class, 'create'])->name('admin.api.new');

    Route::post('/new', [Admin\ApiController::class, 'store']);

    Route::delete('/revoke/{identifier}', [Admin\ApiController::class, 'delete'])->name('admin.api.delete');
});

/*
|--------------------------------------------------------------------------
| Location Controller Routes
|--------------------------------------------------------------------------
|
| Endpoint: /admin/locations
|
*/
Route::group(['prefix' => 'locations'], function () {
    Route::get('/', [Admin\LocationController::class, 'index'])->name('admin.locations');
    Route::get('/view/{location:id}', [Admin\LocationController::class, 'view'])->name('admin.locations.view');

    Route::post('/', [Admin\LocationController::class, 'create']);
    Route::patch('/view/{location:id}', [Admin\LocationController::class, 'update']);
});

/*
|--------------------------------------------------------------------------
| Database Controller Routes
|--------------------------------------------------------------------------
|
| Endpoint: /admin/databases
|
*/
Route::group(['prefix' => 'databases'], function () {
    Route::get('/', [Admin\DatabaseController::class, 'index'])->name('admin.databases');
    Route::get('/view/{host:id}', [Admin\DatabaseController::class, 'view'])->name('admin.databases.view');

    Route::post('/', [Admin\DatabaseController::class, 'create']);
    Route::patch('/view/{host:id}', [Admin\DatabaseController::class, 'update']);
    Route::delete('/view/{host:id}', [Admin\DatabaseController::class, 'delete']);
});

/*
|--------------------------------------------------------------------------
| Node Controller Routes
|--------------------------------------------------------------------------
|
| Endpoint: /admin/nodes
|
*/
Route::group(['prefix' => 'nodes'], function () {
    Route::get('/', [Admin\Nodes\NodeController::class, 'index'])->name('admin.nodes');
    Route::get('/new', [Admin\NodesController::class, 'create'])->name('admin.nodes.new');
    Route::get('/view/{node:id}', [Admin\Nodes\NodeViewController::class, 'index'])->name('admin.nodes.view');
    Route::get('/view/{node:id}/settings', [Admin\Nodes\NodeViewController::class, 'settings'])->name('admin.nodes.view.settings');
    Route::get('/view/{node:id}/configuration', [Admin\Nodes\NodeViewController::class, 'configuration'])->name('admin.nodes.view.configuration');
    Route::get('/view/{node:id}/allocation', [Admin\Nodes\NodeViewController::class, 'allocations'])->name('admin.nodes.view.allocation');
    Route::get('/view/{node:id}/servers', [Admin\Nodes\NodeViewController::class, 'servers'])->name('admin.nodes.view.servers');
    Route::get('/view/{node:id}/system-information', Admin\Nodes\SystemInformationController::class);

    Route::post('/new', [Admin\NodesController::class, 'store']);
    Route::post('/view/{node:id}/allocation', [Admin\NodesController::class, 'createAllocation']);
    Route::post('/view/{node:id}/allocation/remove', [Admin\NodesController::class, 'allocationRemoveBlock'])->name('admin.nodes.view.allocation.removeBlock');
    Route::post('/view/{node:id}/allocation/alias', [Admin\NodesController::class, 'allocationSetAlias'])->name('admin.nodes.view.allocation.setAlias');
    Route::post('/view/{node:id}/settings/token', Admin\NodeAutoDeployController::class)->name('admin.nodes.view.configuration.token');

    Route::patch('/view/{node:id}/settings', [Admin\NodesController::class, 'updateSettings']);

    Route::delete('/view/{node:id}/delete', [Admin\NodesController::class, 'delete'])->name('admin.nodes.view.delete');
    Route::delete('/view/{node:id}/allocation/remove/{allocation:id}', [Admin\NodesController::class, 'allocationRemoveSingle'])->name('admin.nodes.view.allocation.removeSingle');
    Route::delete('/view/{node:id}/allocations', [Admin\NodesController::class, 'allocationRemoveMultiple'])->name('admin.nodes.view.allocation.removeMultiple');
});

/*
|--------------------------------------------------------------------------
| Server Controller Routes
|--------------------------------------------------------------------------
|
| Endpoint: /admin/servers
|
*/
Route::group(['prefix' => 'servers'], function () {
    Route::get('/', [Admin\Servers\ServerController::class, 'index'])->name('admin.servers');
    Route::get('/new', [Admin\Servers\CreateServerController::class, 'index'])->name('admin.servers.new');
    Route::get('/view/{server:id}', [Admin\Servers\ServerViewController::class, 'index'])->name('admin.servers.view');

    Route::group(['middleware' => [ServerInstalled::class]], function () {
        Route::get('/view/{server:id}/details', [Admin\Servers\ServerViewController::class, 'details'])->name('admin.servers.view.details');
        Route::get('/view/{server:id}/build', [Admin\Servers\ServerViewController::class, 'build'])->name('admin.servers.view.build');
        Route::get('/view/{server:id}/startup', [Admin\Servers\ServerViewController::class, 'startup'])->name('admin.servers.view.startup');
        Route::get('/view/{server:id}/database', [Admin\Servers\ServerViewController::class, 'database'])->name('admin.servers.view.database');
        Route::get('/view/{server:id}/mounts', [Admin\Servers\ServerViewController::class, 'mounts'])->name('admin.servers.view.mounts');
    });

    Route::get('/view/{server:id}/manage', [Admin\Servers\ServerViewController::class, 'manage'])->name('admin.servers.view.manage');
    Route::get('/view/{server:id}/delete', [Admin\Servers\ServerViewController::class, 'delete'])->name('admin.servers.view.delete');

    Route::post('/new', [Admin\Servers\CreateServerController::class, 'store']);
    Route::post('/view/{server:id}/build', [Admin\ServersController::class, 'updateBuild']);
    Route::post('/view/{server:id}/startup', [Admin\ServersController::class, 'saveStartup']);
    Route::post('/view/{server:id}/database', [Admin\ServersController::class, 'newDatabase']);
    Route::post('/view/{server:id}/mounts', [Admin\ServersController::class, 'addMount'])->name('admin.servers.view.mounts.store');
    Route::post('/view/{server:id}/manage/toggle', [Admin\ServersController::class, 'toggleInstall'])->name('admin.servers.view.manage.toggle');
    Route::post('/view/{server:id}/manage/suspension', [Admin\ServersController::class, 'manageSuspension'])->name('admin.servers.view.manage.suspension');
    Route::post('/view/{server:id}/manage/reinstall', [Admin\ServersController::class, 'reinstallServer'])->name('admin.servers.view.manage.reinstall');
    Route::post('/view/{server:id}/manage/transfer', [Admin\Servers\ServerTransferController::class, 'transfer'])->name('admin.servers.view.manage.transfer');
    Route::post('/view/{server:id}/delete', [Admin\ServersController::class, 'delete']);

    Route::patch('/view/{server:id}/details', [Admin\ServersController::class, 'setDetails']);
    Route::patch('/view/{server:id}/database', [Admin\ServersController::class, 'resetDatabasePassword']);

    Route::delete('/view/{server:id}/database/{database:id}/delete', [Admin\ServersController::class, 'deleteDatabase'])->name('admin.servers.view.database.delete');
    Route::delete('/view/{server:id}/mounts/{mount:id}', [Admin\ServersController::class, 'deleteMount'])
        ->name('admin.servers.view.mounts.delete');
});

/*
|--------------------------------------------------------------------------
| User Controller Routes
|--------------------------------------------------------------------------
|
| Endpoint: /admin/users
|
*/
Route::group(['prefix' => 'users'], function () {
    Route::get('/', [Admin\Users\UserController::class, 'index'])->name('admin.users');
    Route::get('/accounts.json', [Admin\Users\UserController::class, 'json'])->name('admin.users.json');
    Route::get('/new', [Admin\Users\UserController::class, 'create'])->name('admin.users.new');
    Route::get('/view/{user:id}', [Admin\Users\UserController::class, 'view'])->name('admin.users.view');
    Route::get('/view/{user:id}/resources', [Admin\Users\ResourceController::class, 'view'])->name('admin.users.resources');

    Route::post('/new', [Admin\Users\UserController::class, 'store']);

    Route::patch('/view/{user:id}', [Admin\Users\UserController::class, 'update']);
    Route::patch('/view/{user:id}/resources', [Admin\Users\ResourceController::class, 'update']);

    Route::delete('/view/{user:id}', [Admin\Users\UserController::class, 'delete']);
});

/*
|--------------------------------------------------------------------------
| Mount Controller Routes
|--------------------------------------------------------------------------
|
| Endpoint: /admin/mounts
|
*/
Route::group(['prefix' => 'mounts'], function () {
    Route::get('/', [Admin\MountController::class, 'index'])->name('admin.mounts');
    Route::get('/view/{mount:id}', [Admin\MountController::class, 'view'])->name('admin.mounts.view');

    Route::post('/', [Admin\MountController::class, 'create']);
    Route::post('/{mount:id}/eggs', [Admin\MountController::class, 'addEggs'])->name('admin.mounts.eggs');
    Route::post('/{mount:id}/nodes', [Admin\MountController::class, 'addNodes'])->name('admin.mounts.nodes');

    Route::patch('/view/{mount:id}', [Admin\MountController::class, 'update']);

    Route::delete('/{mount:id}/eggs/{egg_id}', [Admin\MountController::class, 'deleteEgg']);
    Route::delete('/{mount:id}/nodes/{node_id}', [Admin\MountController::class, 'deleteNode']);
});

/*
|--------------------------------------------------------------------------
| Nest Controller Routes
|--------------------------------------------------------------------------
|
| Endpoint: /admin/nests
|
*/
Route::group(['prefix' => 'nests'], function () {
    Route::get('/', [Admin\Nests\NestController::class, 'index'])->name('admin.nests');
    Route::get('/new', [Admin\Nests\NestController::class, 'create'])->name('admin.nests.new');
    Route::get('/view/{nest:id}', [Admin\Nests\NestController::class, 'view'])->name('admin.nests.view');
    Route::get('/egg/new', [Admin\Nests\EggController::class, 'create'])->name('admin.nests.egg.new');
    Route::get('/egg/{egg:id}', [Admin\Nests\EggController::class, 'view'])->name('admin.nests.egg.view');
    Route::get('/egg/{egg:id}/export', [Admin\Nests\EggShareController::class, 'export'])->name('admin.nests.egg.export');
    Route::get('/egg/{egg:id}/variables', [Admin\Nests\EggVariableController::class, 'view'])->name('admin.nests.egg.variables');
    Route::get('/egg/{egg:id}/scripts', [Admin\Nests\EggScriptController::class, 'index'])->name('admin.nests.egg.scripts');

    Route::post('/new', [Admin\Nests\NestController::class, 'store']);
    Route::post('/import', [Admin\Nests\EggShareController::class, 'import'])->name('admin.nests.egg.import');
    Route::post('/egg/new', [Admin\Nests\EggController::class, 'store']);
    Route::post('/egg/{egg:id}/variables', [Admin\Nests\EggVariableController::class, 'store']);

    Route::put('/egg/{egg:id}', [Admin\Nests\EggShareController::class, 'update']);

    Route::patch('/view/{nest:id}', [Admin\Nests\NestController::class, 'update']);
    Route::patch('/egg/{egg:id}', [Admin\Nests\EggController::class, 'update']);
    Route::patch('/egg/{egg:id}/scripts', [Admin\Nests\EggScriptController::class, 'update']);
    Route::patch('/egg/{egg:id}/variables/{variable:id}', [Admin\Nests\EggVariableController::class, 'update'])->name('admin.nests.egg.variables.edit');

    Route::delete('/view/{nest:id}', [Admin\Nests\NestController::class, 'destroy']);
    Route::delete('/egg/{egg:id}', [Admin\Nests\EggController::class, 'destroy']);
    Route::delete('/egg/{egg:id}/variables/{variable:id}', [Admin\Nests\EggVariableController::class, 'destroy']);
});
</file>

<file path="routes/api-remote.php">
<?php

use Illuminate\Support\Facades\Route;
use Jexactyl\Http\Controllers\Api\Remote;

// Routes for the Wings daemon.
Route::post('/sftp/auth', Remote\SftpAuthenticationController::class);

Route::get('/servers', [Remote\Servers\ServerDetailsController::class, 'list']);
Route::post('/servers/reset', [Remote\Servers\ServerDetailsController::class, 'resetState']);
Route::post('/activity', Remote\ActivityProcessingController::class);

Route::group(['prefix' => '/servers/{uuid}'], function () {
    Route::get('/', Remote\Servers\ServerDetailsController::class);
    Route::get('/install', [Remote\Servers\ServerInstallController::class, 'index']);
    Route::post('/install', [Remote\Servers\ServerInstallController::class, 'store']);

    Route::get('/transfer/failure', [Remote\Servers\ServerTransferController::class, 'failure']);
    Route::get('/transfer/success', [Remote\Servers\ServerTransferController::class, 'success']);
    Route::post('/transfer/failure', [Remote\Servers\ServerTransferController::class, 'failure']);
    Route::post('/transfer/success', [Remote\Servers\ServerTransferController::class, 'success']);
});

Route::group(['prefix' => '/backups'], function () {
    Route::get('/{backup}', Remote\Backups\BackupRemoteUploadController::class);
    Route::post('/{backup}', [Remote\Backups\BackupStatusController::class, 'index']);
    Route::post('/{backup}/restore', [Remote\Backups\BackupStatusController::class, 'restore']);
});
</file>

<file path="storage/app/.gitignore">
*
!.gitignore
!services/*
packs/**/*
services/.bak/*
!packs/.githold
</file>

<file path="storage/clockwork/.gitignore">
*
!.gitignore
</file>

<file path="storage/debugbar/.gitignore">
*
!.gitignore
</file>

<file path=".editorconfig">
root = true

[*]
indent_style = space
indent_size = 4
tab_width = 4
end_of_line = lf
charset = utf-8
trim_trailing_whitespace = true
insert_final_newline = true

[*.md]
trim_trailing_whitespace = false

[*.{md,nix,yml,yaml}]
indent_size = 2
tab_width = 2
</file>

<file path=".eslintignore">
public
node_modules
resources/views
babel.config.js
tailwind.config.js
webpack.config.js
</file>

<file path=".prettierrc.json">
{
    "printWidth": 120,
    "tabWidth": 4,
    "useTabs": false,
    "semi": true,
    "singleQuote": true,
    "jsxSingleQuote": true,
    "endOfLine": "lf"
}
</file>

<file path="artisan">
#!/usr/bin/env php
<?php

define('LARAVEL_START', microtime(true));

/*
|--------------------------------------------------------------------------
| Register The Auto Loader
|--------------------------------------------------------------------------
|
| Composer provides a convenient, automatically generated class loader
| for our application. We just need to utilize it! We'll require it
| into the script here so that we do not have to worry about the
| loading of our classes manually. It's great to relax.
|
*/

require __DIR__ . '/vendor/autoload.php';

$app = require_once __DIR__ . '/bootstrap/app.php';

/*
|--------------------------------------------------------------------------
| Run The Artisan Application
|--------------------------------------------------------------------------
|
| When we run the console application, the current CLI command will be
| executed in this console and the response sent back to a terminal
| or another output device for the developers. Here goes nothing!
|
*/

$kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);

$status = $kernel->handle(
    $input = new Symfony\Component\Console\Input\ArgvInput(),
    new Symfony\Component\Console\Output\ConsoleOutput()
);

/*
|--------------------------------------------------------------------------
| Shutdown The Application
|--------------------------------------------------------------------------
|
| Once Artisan has finished running, we will fire off the shutdown events
| so that any final work may be done by the application before we shut
| down the process. This is the last thing to happen to the request.
|
*/

$kernel->terminate($input, $status);

exit($status);
</file>

<file path="babel.config.js">
module.exports = function (api) {
    let targets = {};
    const plugins = [
        'babel-plugin-macros',
        'styled-components',
        'react-hot-loader/babel',
        '@babel/transform-runtime',
        '@babel/transform-react-jsx',
        '@babel/proposal-class-properties',
        '@babel/proposal-object-rest-spread',
        '@babel/proposal-optional-chaining',
        '@babel/proposal-nullish-coalescing-operator',
        '@babel/syntax-dynamic-import',
    ];

    if (api.env('test')) {
        targets = { node: 'current' };
        plugins.push('@babel/transform-modules-commonjs');
    }

    return {
        plugins,
        presets: [
            '@babel/typescript',
            [
                '@babel/env',
                {
                    modules: false,
                    useBuiltIns: 'entry',
                    corejs: 3,
                    targets,
                },
            ],
            '@babel/react',
        ],
    };
};
</file>

<file path="build-log.txt">
yarn run v1.22.22
$ yarn run clean && cross-env NODE_ENV=production ./node_modules/.bin/webpack --mode production
$ cd public/assets && find . \( -name "*.js" -o -name "*.map" \) -type f -delete
</file>

<file path="BUILDING.md">
# Local Development

Jexactyl is now powered by React, Typescript, and Tailwindcss using webpack at its core to generate compiled assets.
Release versions of Jexactyl will include pre-compiled, minified, and hashed assets ready-to-go.

However, if you are interested in running custom themes or making modifications to the React files you'll need a build
system in place to generate these compiled assets. To get your environment setup you'll need at minimum:

-   [Node.js](https://nodejs.org/en/) v16.x.x
-   [Yarn](https://classic.yarnpkg.com/lang/en/) v1.x.x
-   [Go](https://golang.org/) 1.17.x

### Install Dependencies

```bash
yarn install
```

The command above will download all of the dependencies necessary to get Jexactyl assets building. After that, its as
simple as running the command below to generate assets while you're developing. Until you've run this command at least
once you'll likely see a 500 error on your Panel about a missing `manifest.json` file. This is generated by the commands
below.

```bash
# Build the compiled set of assets for development.
yarn run build

# Build the assets automatically as they are changed. This allows you to refresh
# the page and see the changes immediately.
yarn run watch
```

### Hot Module Reloading

For more advanced users, we also support 'Hot Module Reloading', allowing you to quickly see changes you're making
to the Vue template files without having to reload the page you're on. To Get started with this, you just need
to run the command below.

```bash
PUBLIC_PATH=http://192.168.1.1:8080 yarn run serve --host 192.168.1.1
```

There are two _very important_ parts of this command to take note of and change for your specific environment. The first
is the `--host` flag, which is required and should point to the machine where the `webpack-serve` server will be running.
The second is the `PUBLIC_PATH` environment variable which is the URL pointing to the HMR server and is appended to all of
the asset URLs used in Jexactyl.

#### Development Environment

If you're using the [`Jexactyl/development`](https://github.com/Jexactyl/development) environments, which are
highly recommended, you can just run `yarn run serve` to run the HMR server, no additional configuration is necessary.

### Building for Production

Once you have your files squared away and ready for the live server, you'll be needing to generate compiled, minified,
and hashed assets to push live. To do so, run the command below:

```bash
yarn run build:production
```

This will generate a production JS bundle and associated assets, all located in `public/assets/` which will need to
be uploaded to your server or CDN for clients to use.

### Running Wings

To run `wings` in development all you need to do is set up the configuration file as normal when adding a new node, and
then you can build and run a local version of Wings by executing `make debug` in the Wings code directory. This must
be run on a Linux VM of some sort, you cannot run this locally on macOS or Windows.
</file>

<file path="CHANGELOG.md">
# Changelog

This file is a running track of new features and fixes to each version of the panel released starting with `v3.0.0`.
</file>

<file path="Dockerfile">
# Stage 0:
# Build the assets that are needed for the frontend. This build stage is then discarded
# since we won't need NodeJS anymore in the future. This Docker image ships a final production
# level distribution of Jexactyl.
FROM node:18-alpine
WORKDIR /app
COPY . ./

# Workaround for ssl not working
ENV NODE_OPTIONS=--openssl-legacy-provider

RUN yarn install --frozen-lockfile \
    && yarn run build:production

# Stage 1:
# Build the actual container with all of the needed PHP dependencies that will run the application.
FROM php:8.1-fpm-alpine
WORKDIR /app
COPY . ./
COPY --from=0 /app/public/assets ./public/assets
RUN apk add --no-cache --update ca-certificates dcron curl git supervisor tar unzip nginx libpng-dev libxml2-dev libzip-dev certbot certbot-nginx \
    && docker-php-ext-configure zip \
    && docker-php-ext-install bcmath gd pdo_mysql zip \
    && curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer \
    && cp .env.example .env \
    && mkdir -p bootstrap/cache/ storage/logs storage/framework/sessions storage/framework/views storage/framework/cache \
    && chmod 777 -R bootstrap storage \
    && composer install --no-dev --optimize-autoloader \
    && rm -rf .env bootstrap/cache/*.php \
    && chown -R nginx:nginx .

RUN rm /usr/local/etc/php-fpm.conf \
    && echo "0 0 * * * /usr/local/bin/php /app/artisan p:schedule:renewal >> /dev/null 2>&1" >> /var/spool/cron/crontabs/root \
    && echo "* * * * * /usr/local/bin/php /app/artisan schedule:run >> /dev/null 2>&1" >> /var/spool/cron/crontabs/root \
    && echo "0 23 * * * certbot renew --nginx --quiet" >> /var/spool/cron/crontabs/root \
    && sed -i s/ssl_session_cache/#ssl_session_cache/g /etc/nginx/nginx.conf \
    && mkdir -p /var/run/php /var/run/nginx

COPY .github/docker/default.conf /etc/nginx/http.d/default.conf
COPY .github/docker/www.conf /usr/local/etc/php-fpm.conf
COPY .github/docker/supervisord.conf /etc/supervisord.conf

EXPOSE 80 443
ENTRYPOINT [ "/bin/ash", ".github/docker/entrypoint.sh" ]
CMD [ "supervisord", "-n", "-c", "/etc/supervisord.conf" ]
</file>

<file path="jest.config.js">
const { pathsToModuleNameMapper } = require('ts-jest');
const { compilerOptions } = require('./tsconfig');

/** @type {import('ts-jest').InitialOptionsTsJest} */
module.exports = {
    preset: 'ts-jest',
    globals: {
        'ts-jest': {
            isolatedModules: true,
        },
    },
    moduleFileExtensions: ['js', 'ts', 'tsx', 'd.ts', 'json', 'node'],
    moduleNameMapper: {
        '\\.(jpe?g|png|gif|svg)$': '<rootDir>/resources/scripts/__mocks__/file.ts',
        '\\.(s?css|less)$': 'identity-obj-proxy',
        ...pathsToModuleNameMapper(compilerOptions.paths, {
            prefix: '<rootDir>/',
        }),
    },
    setupFilesAfterEnv: ['<rootDir>/resources/scripts/setup-tests.ts'],
    transform: {
        '.*\\.[t|j]sx$': 'babel-jest',
        '.*\\.ts$': 'ts-jest',
    },
    testPathIgnorePatterns: ['/node_modules/'],
};
</file>

<file path="postcss.config.js">
module.exports = {
    plugins: [
        require('postcss-import'),
        // We want to make use of nesting following the CSS Nesting spec, and not the
        // SASS style nesting.
        //
        // @see https://github.com/csstools/postcss-plugins/tree/main/plugins/postcss-nesting
        require('tailwindcss/nesting')(require('postcss-nesting')),
        require('tailwindcss'),
        require('autoprefixer'),
        require('postcss-preset-env')({
            features: {
                'nesting-rules': false,
            },
        }),
    ],
};
</file>

<file path="README.md">
[![Logo Image](https://cdn.vervecustoms.com/logo/neo.png)](https://jexactyl.com)

[![Discord](https://img.shields.io/discord/922284031129825280?style=for-the-badge)](https://discord.com/invite/qttGR4Z5Pk)
![Downloads - Total](https://img.shields.io/github/downloads/jexactyl/jexactyl/total?style=for-the-badge)
![Downloads - Latest](https://img.shields.io/github/downloads/jexactyl/jexactyl/latest/total?style=for-the-badge)
![Version](https://img.shields.io/github/v/release/jexactyl/jexactyl?style=for-the-badge)
![Contributors](https://img.shields.io/github/contributors-anon/jexactyl/jexactyl?style=for-the-badge)

<h1 align="center">Jexactyl</h1>
<h5 align="center">
    <strong>
        NeoDesigns is a fast, advanced and customisable game management panel and billing system in one.
        Give your users the edge in terms of performance, reliability and pure functionality.
    </strong>
</h5>

## Installation

Head over to our [Documentation](https://docs.jexactyl.com) to get started with self-hosting this software.
If you need help at any point during the installation process, please let us know on [Discord](https://discord.com/invite/qttGR4Z5Pk).

## Why use Jexactyl?

-   Billing system which supports [Stripe](https://stripe.com) and [PayPal](https://paypal.com) out of the box.
-   Full customizability via a simple administrative dashboard.
-   Ticket system in order to provide support to customers.
-   Enhanced customisability and configurations.
-   A fluent UI/UX with an easy-to-use API for both admins and clients.
-   User approvals, server renewals, and much much more.

## Sponsors

_Want to sponsor Jexactyl? [Donate Here.](https://donate.stripe.com/6oE02Zftd9cC34IbIS)_

| Company                                       | About                                                                                                                          | Link                                     |
| --------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------- |
| [**HostEZ**](https://hostez.io)               | Providing North America Valheim, Minecraft and other popular games with low latency, high uptime and maximum availability. EZ! | [Website](https://hostez.io)             |
| [**CXMPUTE**](https://cxmpute.com)            | CXMPUTE provides low-cost VPS and gameserver solutions, starting at $2/month.                                                  | [Website](https://cxmpute.com)           |
| [**ZipCloud**](https://discord.gg/f4rbEmYAXb) | Game & VPS hosting with full DDoS protection and great uptime.                                                                 | [Discord](https://discord.gg/f4rbEmYAXb) |

## Previews

![image](https://user-images.githubusercontent.com/72230943/201116518-af5e3291-74f7-433a-b035-6d80e8c7e8f8.png)
![image](https://user-images.githubusercontent.com/72230943/201116580-ae864e7c-aac7-4766-ab9c-c6cb97d0b015.png)
![image](https://user-images.githubusercontent.com/72230943/201116688-b53d721e-c30f-424e-8a53-025f313ec98f.png)
![image](https://user-images.githubusercontent.com/72230943/201116840-92c00c15-5717-4121-83cd-69397f9bacba.png)
![image](https://user-images.githubusercontent.com/72230943/201116914-8b1c8867-c462-4b25-ae47-803b2e4ea39c.png)
![image](https://user-images.githubusercontent.com/72230943/201116959-a626e6fc-18a9-4c06-869e-2f13b37b8457.png)
![image](https://user-images.githubusercontent.com/72230943/201117028-3db8aa2e-b14b-4679-9f2c-c5afb208767c.png)

## Licensing

Some Javascript and CSS used within the panel are licensed under a `MIT` or `Apache 2.0` license. Please check their
respective header files for more information.

_Jexactyl is not affiliated with [Pterodactyl Software](https://pterodactyl.io)._
</file>

<file path="SECURITY.md">
# Security Policy

## Supported Versions

The following versions of Jexactyl are receiving active support and maintenance. Any security vulnerabilities discovered must be reproducible in supported versions.

| Panel   | Supported          |
| ------- | ------------------ |
| 3.7.x   | :white_check_mark: |
| 3.6.x   | :white_check_mark: |
| < 3.5.x | :x:                |

## Reporting a Vulnerability

Please reach out directly to any project team member on Discord when reporting a security vulnerability, or you can email `cameron@jexactyl.com`.

We make every effort to respond as soon as possible, although it may take a day or two for us to sync internally and determine the severity of the report and its impact. Please, _do not_ use a public facing channel or GitHub issues to report sensitive security issues.

As part of our process, we will create a security advisory for the affected versions and disclose it publicly, usually two to four weeks after a releasing a version that addresses it.
</file>

<file path="tsconfig.json">
{
    "compilerOptions": {
        "target": "es2015",
        "module": "es2020",
        "jsx": "react",
        "moduleResolution": "node",
        "lib": ["es2015", "dom"],
        "strict": true,
        "noEmit": true,
        "sourceMap": true,
        "noImplicitReturns": true,
        "skipLibCheck": true,
        "skipDefaultLibCheck": true,
        "esModuleInterop": true,
        "allowSyntheticDefaultImports": true,
        "baseUrl": ".",
        "importsNotUsedAsValues": "preserve",
        "paths": {
            "@/*": ["./resources/scripts/*"],
            "@definitions/*": ["./resources/scripts/api/definitions/*"],
            "@feature/*": ["./resources/scripts/components/server/features/*"]
        },
        "plugins": [
            {
                "name": "typescript-plugin-tw-template"
            }
        ],
        "typeRoots": ["node_modules/@types"]
    },
    "include": ["./resources/scripts/**/*"],
    "exclude": ["/node_modules/"]
}
</file>

<file path="app/Http/Controllers/Api/Client/Store/StripeController.php">
<?php

namespace Jexactyl\Http\Controllers\Api\Client\Store;

use Stripe\StripeClient;
use Illuminate\Http\JsonResponse;
use Stripe\Exception\ApiErrorException;
use Jexactyl\Exceptions\DisplayException;
use Jexactyl\Http\Controllers\Api\Client\ClientApiController;
use Jexactyl\Http\Requests\Api\Client\Store\Gateways\StripeRequest;

class StripeController extends ClientApiController
{
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * @throws DisplayException|ApiErrorException
     */
    public function purchase(StripeRequest $request): JsonResponse
    {
        if (!$this->settings->get('jexactyl::store:stripe:enabled')) {
            throw new DisplayException('Unable to purchase via Stripe: module not enabled');
        }

        $client = new StripeClient(config('gateways.stripe.secret'));
        $amount = $request->input('amount');
        $cost = number_format(config('gateways.stripe.cost', 1.00) / 100 * $amount, 2);
        $currency = config('gateways.currency', 'USD');

        $checkout = $client->checkout->sessions->create([
            'success_url' => config('app.url') . '/store/credits',
            'cancel_url' => config('app.url'),
            'mode' => 'payment',
            'customer_email' => $request->user()->email,
            'metadata' => ['credit_amount' => $amount, 'user_id' => $request->user()->id],
            'custom_fields' => [
                [
                  'key' => 'discord_username',
                  'label' => ['type' => 'custom', 'custom' => 'Discord Username'],
                  'type' => 'text',
                ],
                [
                  'key' => 'discord_id',
                  'label' => ['type' => 'custom', 'custom' => 'Discord ID'],
                  'type' => 'text',
                ],
             ],
            'line_items' => [
                [
                    'quantity' => 1,
                    'price_data' => [
                        'currency' => $currency,
                        'unit_amount' => str_replace('.', '', $cost),
                        'product_data' => [
                            'name' => $amount . ' Credits | ' . $this->settings->get('settings::app:name'),
                        ],
                    ],
                ],
            ],
        ]);

        return new JsonResponse($checkout->url, 200, [], null, true);
    }
}
</file>

<file path="app/Models/User.php">
<?php

namespace Jexactyl\Models;

use Jexactyl\Rules\Username;
use Jexactyl\Facades\Activity;
use Illuminate\Support\Collection;
use Illuminate\Validation\Rules\In;
use Illuminate\Auth\Authenticatable;
use Illuminate\Notifications\Notifiable;
use Illuminate\Database\Eloquent\Builder;
use Jexactyl\Models\Traits\HasAccessTokens;
use Illuminate\Auth\Passwords\CanResetPassword;
use Jexactyl\Traits\Helpers\AvailableLanguages;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Foundation\Auth\Access\Authorizable;
use Illuminate\Database\Eloquent\Relations\MorphToMany;
use Illuminate\Contracts\Auth\Authenticatable as AuthenticatableContract;
use Illuminate\Contracts\Auth\Access\Authorizable as AuthorizableContract;
use Jexactyl\Notifications\SendPasswordReset as ResetPasswordNotification;
use Illuminate\Contracts\Auth\CanResetPassword as CanResetPasswordContract;

/**
 * Jexactyl\Models\User.
 *
 * @property int $id
 * @property string|null $external_id
 * @property string $uuid
 * @property string $username
 * @property string $email
 * @property string|null $discord_id
 * @property string|null $name_first
 * @property string|null $name_last
 * @property string $password
 * @property string|null $remember_token
 * @property string $language
 * @property bool $root_admin
 * @property bool $use_totp
 * @property string|null $totp_secret
 * @property \Illuminate\Support\Carbon|null $totp_authenticated_at
 * @property bool $gravatar
 * @property \Illuminate\Support\Carbon|null $created_at
 * @property \Illuminate\Support\Carbon|null $updated_at
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\ApiKey[] $apiKeys
 * @property int|null $api_keys_count
 * @property string $name
 * @property \Illuminate\Notifications\DatabaseNotificationCollection|\Illuminate\Notifications\DatabaseNotification[] $notifications
 * @property int|null $notifications_count
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\RecoveryToken[] $recoveryTokens
 * @property int|null $recovery_tokens_count
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\Server[] $servers
 * @property int|null $servers_count
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\UserSSHKey[] $sshKeys
 * @property int|null $ssh_keys_count
 * @property \Illuminate\Database\Eloquent\Collection|\Jexactyl\Models\ApiKey[] $tokens
 * @property int|null $tokens_count
 * @property int $store_balance
 * @property int $store_cpu
 * @property int $store_memory
 * @property int $store_disk
 * @property int $store_slots
 * @property int $store_ports
 * @property int $store_backups
 * @property int $store_databases
 * @property string $referral_code
 * @property bool|null $approved
 * @property bool $verified
 *
 * @method static \Database\Factories\UserFactory factory(...$parameters)
 * @method static Builder|User newModelQuery()
 * @method static Builder|User newQuery()
 * @method static Builder|User query()
 * @method static Builder|User whereCreatedAt($value)
 * @method static Builder|User whereEmail($value)
 * @method static Builder|User whereExternalId($value)
 * @method static Builder|User whereGravatar($value)
 * @method static Builder|User whereId($value)
 * @method static Builder|User whereLanguage($value)
 * @method static Builder|User whereNameFirst($value)
 * @method static Builder|User whereNameLast($value)
 * @method static Builder|User wherePassword($value)
 * @method static Builder|User whereRememberToken($value)
 * @method static Builder|User whereRootAdmin($value)
 * @method static Builder|User whereTotpAuthenticatedAt($value)
 * @method static Builder|User whereTotpSecret($value)
 * @method static Builder|User whereUpdatedAt($value)
 * @method static Builder|User whereUseTotp($value)
 * @method static Builder|User whereUsername($value)
 * @method static Builder|User whereUuid($value)
 *
 * @mixin \Eloquent
 */
class User extends Model implements
    AuthenticatableContract,
    AuthorizableContract,
    CanResetPasswordContract
{
    use Authenticatable;
    use Authorizable;
    use AvailableLanguages;
    use CanResetPassword;
    use HasAccessTokens;
    use Notifiable;

    public const USER_LEVEL_USER = 0;
    public const USER_LEVEL_ADMIN = 1;

    /**
     * The resource name for this model when it is transformed into an
     * API representation using fractal.
     */
    public const RESOURCE_NAME = 'user';

    /**
     * Level of servers to display when using access() on a user.
     */
    protected string $accessLevel = 'all';

    /**
     * The table associated with the model.
     */
    protected $table = 'users';

    /**
     * A list of mass-assignable variables.
     */
    protected $fillable = [
        'external_id',
        'username',
        'email',
        'discord_id',
        'google_id',
        'name_first',
        'name_last',
        'password',
        'language',
        'use_totp',
        'totp_secret',
        'totp_authenticated_at',
        'gravatar',
        'root_admin',
        'store_balance',
        'store_cpu',
        'store_memory',
        'store_disk',
        'store_slots',
        'store_ports',
        'store_backups',
        'store_databases',
        'referral_code',
        'approved',
    ];

    /**
     * Cast values to correct type.
     */
    protected $casts = [
        'root_admin' => 'boolean',
        'use_totp' => 'boolean',
        'gravatar' => 'boolean',
    ];

    protected $dates = ['totp_authenticated_at'];

    /**
     * The attributes excluded from the model's JSON form.
     */
    protected $hidden = ['password', 'remember_token', 'totp_secret', 'totp_authenticated_at'];

    /**
     * Default values for specific fields in the database.
     */
    protected $attributes = [
        'external_id' => null,
        'root_admin' => false,
        'language' => 'en',
        'use_totp' => false,
        'totp_secret' => null,
        'approved' => false,
    ];

    /**
     * Rules verifying that the data being stored matches the expectations of the database.
     */
    public static array $validationRules = [
        'uuid' => 'required|string|size:36|unique:users,uuid',
        'email' => 'required|email|between:1,191|unique:users,email',
        'external_id' => 'sometimes|nullable|string|max:191|unique:users,external_id',
        'discord_id' => 'nullable|string|regex:/^[0-9]{17,20}$/|unique:users,discord_id',
        'username' => 'required|between:1,191|unique:users,username',
        'name_first' => 'required|string|between:1,191',
        'name_last' => 'required|string|between:1,191',
        'password' => 'sometimes|nullable|string',
        'root_admin' => 'boolean',
        'language' => 'string',
        'use_totp' => 'boolean',
        'totp_secret' => 'nullable|string',
        'approved' => 'nullable|boolean',
        'verified' => 'boolean',
        'store_balance' => 'sometimes|int',
        'store_cpu' => 'sometimes|int',
        'store_memory' => 'sometimes|int',
        'store_disk' => 'sometimes|int',
        'store_slots' => 'sometimes|int',
        'store_ports' => 'sometimes|int',
        'store_backups' => 'sometimes|int',
        'store_database' => 'sometimes|int',
    ];

    /**
     * Implement language verification by overriding Eloquence's gather
     * rules function.
     */
    public static function getRules(): array
    {
        $rules = parent::getRules();

        $rules['language'][] = new In(array_keys((new self())->getAvailableLanguages()));
        $rules['username'][] = new Username();

        return $rules;
    }

    /**
     * Return the user model in a format that can be passed over to React templates.
     */
    public function toVueObject(): array
    {
        return Collection::make($this->toArray())->except(['id', 'external_id'])->toArray();
    }

    /**
     * Send the password reset notification.
     *
     * @param string $token
     */
    public function sendPasswordResetNotification($token)
    {
        Activity::event('auth:reset-password')
            ->withRequestMetadata()
            ->subject($this)
            ->log('sending password reset email');

        $this->notify(new ResetPasswordNotification($token));
    }

    /**
     * Store the username as a lowercase string.
     */
    public function setUsernameAttribute(string $value)
    {
        $this->attributes['username'] = mb_strtolower($value);
    }

    /**
     * Return a concatenated result for the accounts full name.
     */
    public function getNameAttribute(): string
    {
        return trim($this->name_first . ' ' . $this->name_last);
    }

    /**
     * Returns all servers that a user owns.
     */
    public function servers(): HasMany
    {
        return $this->hasMany(Server::class, 'owner_id');
    }

    public function apiKeys(): HasMany
    {
        return $this->hasMany(ApiKey::class)
            ->where('key_type', ApiKey::TYPE_ACCOUNT);
    }

    public function recoveryTokens(): HasMany
    {
        return $this->hasMany(RecoveryToken::class);
    }

    public function referralCodes(): HasMany
    {
        return $this->hasMany(ReferralCode::class);
    }

    public function tickets(): HasMany
    {
        return $this->hasMany(Ticket::class, 'client_id');
    }

    public function sshKeys(): HasMany
    {
        return $this->hasMany(UserSSHKey::class);
    }

    /**
     * Returns all the activity logs where this user is the subject  not to
     * be confused by activity logs where this user is the _actor_.
     */
    public function activity(): MorphToMany
    {
        return $this->morphToMany(ActivityLog::class, 'subject', 'activity_log_subjects');
    }

    /**
     * Returns all the servers that a user can access by way of being the owner of the
     * server, or because they are assigned as a subuser for that server.
     */
    public function accessibleServers(): Builder
    {
        return Server::query()
            ->select('servers.*')
            ->leftJoin('subusers', 'subusers.server_id', '=', 'servers.id')
            ->where(function (Builder $builder) {
                $builder->where('servers.owner_id', $this->id)->orWhere('subusers.user_id', $this->id);
            })
            ->groupBy('servers.id');
    }
}
</file>

<file path="resources/scripts/components/auth/DiscordFormContainer.tsx">
// import React from 'react';
// import tw from 'twin.macro';
// import { breakpoint } from '@/theme';
// import styled from 'styled-components/macro';
// import { useStoreState } from '@/state/hooks';
// import FlashMessageRender from '@/components/FlashMessageRender';

// const Wrapper = styled.div`
//     ${breakpoint('sm')`
//         ${tw`w-4/5 mx-auto`}
//     `};
//     ${breakpoint('md')`
//         ${tw`p-10`}
//     `};
//     ${breakpoint('lg')`
//         ${tw`w-3/5`}
//     `};
//     ${breakpoint('xl')`
//         ${tw`w-full`}
//         max-width: 500px;
//     `};
// `;

// const FormWrapper = styled.div`
//     ${tw`w-full bg-gray-800 shadow-2xl rounded-2xl p-8 border border-gray-700`}
// `;

// const DiscordFormContainer = ({ children }: { children: React.ReactNode }) => {
//     // Easy to swap between env and state
//     const siteName = process.env.REACT_APP_SITE_NAME || 'NeoDesigns Hosting';
//     // const siteName = useStoreState((state) => state.settings.data!.name) || 'NeoDesigns Hosting';

//     return (
//         <div css={tw`min-h-screen flex items-center justify-center p-4`} style={{ backgroundColor: '#1a1a1a' }}>
//             <Wrapper>
//                 <FlashMessageRender css={tw`mb-4 px-1`} />
//                 <FormWrapper>
//                     <div css={tw`text-center mb-6`}>
//                         <h2 css={tw`text-3xl text-white font-bold mb-2`}>{siteName}</h2>
//                         <p css={tw`text-gray-400 text-sm`}>Sign in to your account to continue</p>
//                     </div>
//                     {children}
//                 </FormWrapper>
//             </Wrapper>
//         </div>
//     );
// };

// export default DiscordFormContainer;

import React from 'react';
import tw from 'twin.macro';
import { breakpoint } from '@/theme';
import styled from 'styled-components/macro';
import { useStoreState } from '@/state/hooks';
import FlashMessageRender from '@/components/FlashMessageRender';

const Wrapper = styled.div`
    ${breakpoint('sm')`
        ${tw`w-4/5 mx-auto`}
    `};
    ${breakpoint('md')`
        ${tw`p-10`}
    `};
    ${breakpoint('lg')`
        ${tw`w-3/5`}
    `};
    ${breakpoint('xl')`
        ${tw`w-full`}
        max-width: 500px;
    `};
`;

const FormWrapper = styled.div`
    ${tw`w-full bg-gray-800 shadow-2xl rounded-2xl p-8 border border-gray-700`}
`;

const DiscordFormContainer = ({ children }: { children: React.ReactNode }) => {
    // Easy to swap between env and state
    const siteName = process.env.REACT_APP_SITE_NAME || 'NeoDesigns Hosting';
    // const siteName = useStoreState((state) => state.settings.data!.name) || 'NeoDesigns Hosting';

    return (
        <div css={tw`min-h-screen flex items-center justify-center p-4`} style={{ backgroundColor: '#1a1a1a', margin: 0, overflow: 'hidden' }}>
            <Wrapper css={tw`my-auto`}>
                <FlashMessageRender css={tw`mb-4 px-1`} />
                <FormWrapper>
                    <div css={tw`text-center mb-6`}>
                        <h2 css={tw`text-3xl text-white font-bold mb-2`}>{siteName}</h2>
                        <p css={tw`text-gray-400 text-sm`}>Sign in to your account to continue</p>
                    </div>
                    {children}
                </FormWrapper>
            </Wrapper>
        </div>
    );
};

export default DiscordFormContainer;
</file>

<file path="resources/scripts/components/auth/ResetPasswordContainer.tsx">
// // import tw from 'twin.macro';
// // import React, { useState } from 'react';
// // import { Link } from 'react-router-dom';
// // import { object, ref, string } from 'yup';
// // import { ApplicationStore } from '@/state';
// // import { httpErrorToHuman } from '@/api/http';
// // import { Formik, FormikHelpers } from 'formik';
// // import Field from '@/components/elements/Field';
// // import Input from '@/components/elements/Input';
// // import { RouteComponentProps } from 'react-router';
// // import { Actions, useStoreActions } from 'easy-peasy';
// // import { Button } from '@/components/elements/button/index';
// // import performPasswordReset from '@/api/auth/performPasswordReset';
// // import LoginFormContainer from '@/components/auth/LoginFormContainer';

// // interface Values {
// //     password: string;
// //     passwordConfirmation: string;
// // }

// // export default ({ match, location }: RouteComponentProps<{ token: string }>) => {
// //     const [email, setEmail] = useState('');

// //     const { clearFlashes, addFlash } = useStoreActions((actions: Actions<ApplicationStore>) => actions.flashes);

// //     const parsed = new URLSearchParams(location.search);
// //     if (email.length === 0 && parsed.get('email')) {
// //         setEmail(parsed.get('email') || '');
// //     }

// //     const submit = ({ password, passwordConfirmation }: Values, { setSubmitting }: FormikHelpers<Values>) => {
// //         clearFlashes();
// //         performPasswordReset(email, { token: match.params.token, password, passwordConfirmation })
// //             .then(() => {
// //                 // @ts-expect-error this is valid
// //                 window.location = '/';
// //             })
// //             .catch((error) => {
// //                 console.error(error);

// //                 setSubmitting(false);
// //                 addFlash({ type: 'danger', title: 'Error', message: httpErrorToHuman(error) });
// //             });
// //     };

// //     return (
// //         <Formik
// //             onSubmit={submit}
// //             initialValues={{
// //                 password: '',
// //                 passwordConfirmation: '',
// //             }}
// //             validationSchema={object().shape({
// //                 password: string()
// //                     .required('A new password is required.')
// //                     .min(8, 'Your new password should be at least 8 characters in length.'),
// //                 passwordConfirmation: string()
// //                     .required('Your new password does not match.')
// //                     // @ts-expect-error this is valid
// //                     .oneOf([ref('password'), null], 'Your new password does not match.'),
// //             })}
// //         >
// //             {({ isSubmitting }) => (
// //                 <LoginFormContainer title={'Reset Password'} css={tw`w-full flex`}>
// //                     <div>
// //                         <label>Email</label>
// //                         <Input value={email} isLight disabled />
// //                     </div>
// //                     <div css={tw`mt-6`}>
// //                         <Field
// //                             light
// //                             label={'New Password'}
// //                             name={'password'}
// //                             type={'password'}
// //                             description={'Passwords must be at least 8 characters in length.'}
// //                         />
// //                     </div>
// //                     <div css={tw`mt-6`}>
// //                         <Field light label={'Confirm New Password'} name={'passwordConfirmation'} type={'password'} />
// //                     </div>
// //                     <div css={tw`mt-6`}>
// //                         <Button size={Button.Sizes.Large} css={tw`w-full`} type={'submit'} disabled={isSubmitting}>
// //                             Reset Password
// //                         </Button>
// //                     </div>
// //                     <div css={tw`mt-6 text-center`}>
// //                         <Link
// //                             to={'/auth/login'}
// //                             css={tw`text-xs text-neutral-500 tracking-wide no-underline uppercase hover:text-neutral-600`}
// //                         >
// //                             Return to Login
// //                         </Link>
// //                     </div>
// //                 </LoginFormContainer>
// //             )}
// //         </Formik>
// //     );
// // };

// import tw from 'twin.macro';
// import React, { useState } from 'react';
// import { Link } from 'react-router-dom';
// import { object, ref, string } from 'yup';
// import { ApplicationStore } from '@/state';
// import { httpErrorToHuman } from '@/api/http';
// import { Formik, FormikHelpers } from 'formik';
// import Field from '@/components/elements/Field';
// import Input from '@/components/elements/Input';
// import { RouteComponentProps } from 'react-router';
// import { Actions, useStoreActions } from 'easy-peasy';
// import { Button } from '@/components/elements/button/index';
// import performPasswordReset from '@/api/auth/performPasswordReset';
// import LoginFormContainer from '@/components/auth/LoginFormContainer';
// import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
// import { faEye, faEyeSlash } from '@fortawesome/free-solid-svg-icons';
// import { useStoreState } from 'easy-peasy';
// import discordLogin from '@/api/auth/discord';
// import useFlash from '@/plugins/useFlash';

// interface Values {
//     password: string;
//     passwordConfirmation: string;
// }

// export default ({ match, location }: RouteComponentProps<{ token: string }>) => {
//     const [email, setEmail] = useState('');
//     const [showPassword, setShowPassword] = useState(false);
//     const [showConfirmPassword, setShowConfirmPassword] = useState(false);
//     const [discordLoading, setDiscordLoading] = useState(false);

//     const { clearFlashes, addFlash } = useStoreActions((actions: Actions<ApplicationStore>) => actions.flashes);
//     const { clearAndAddHttpError } = useFlash();
//     const name = useStoreState((state) => state.settings.data?.name);
//     const discord = useStoreState((state) => state.settings.data?.registration.discord);

//     const parsed = new URLSearchParams(location.search);
//     if (email.length === 0 && parsed.get('email')) {
//         setEmail(parsed.get('email') || '');
//     }

//     const handleDiscordLogin = () => {
//         clearFlashes();
//         setDiscordLoading(true);

//         discordLogin()
//             .then((data) => {
//                 if (!data) {
//                     clearAndAddHttpError({ error: 'Discord auth failed. Please try again.' });
//                     setDiscordLoading(false);
//                     return;
//                 }
//                 window.location.href = data;
//             })
//             .catch((error) => {
//                 console.error(error);
//                 setDiscordLoading(false);
//                 clearAndAddHttpError({ error });
//             });
//     };

//     const submit = ({ password, passwordConfirmation }: Values, { setSubmitting }: FormikHelpers<Values>) => {
//         clearFlashes();
//         performPasswordReset(email, { token: match.params.token, password, passwordConfirmation })
//             .then(() => {
//                 // @ts-expect-error this is valid
//                 window.location = '/';
//             })
//             .catch((error) => {
//                 console.error(error);
//                 setSubmitting(false);
//                 addFlash({ type: 'danger', title: 'Error', message: httpErrorToHuman(error) });
//             });
//     };

//     return (
//         <Formik
//             onSubmit={submit}
//             initialValues={{
//                 password: '',
//                 passwordConfirmation: '',
//             }}
//             validationSchema={object().shape({
//                 password: string()
//                     .required('A new password is required.')
//                     .min(8, 'Your new password should be at least 8 characters in length.'),
//                 passwordConfirmation: string()
//                     .required('Your new password does not match.')
//                     // @ts-expect-error this is valid
//                     .oneOf([ref('password'), null], 'Your new password does not match.'),
//             })}
//         >
//             {({ isSubmitting }) => (
//                 <LoginFormContainer 
//                     title={name || 'NeoDesigns Hosting'} 
//                     subtitle="Reset your password"
//                 >
//                     <div css={tw`mb-6`}>
//                         <label css={tw`block text-sm font-medium text-gray-300 mb-2`}>Email</label>
//                         <Input 
//                             value={email} 
//                             isLight 
//                             disabled 
//                             css={tw`w-full bg-gray-700 border-gray-600 text-gray-400`}
//                         />
//                     </div>

//                     <div css={tw`space-y-4`}>
//                         <div css={tw`relative`}>
//                             <Field
//                                 light
//                                 label={'New Password'}
//                                 name={'password'}
//                                 type={showPassword ? 'text' : 'password'}
//                                 description={'Passwords must be at least 8 characters in length.'}
//                                 placeholder="Enter your new password"
//                             />
//                             <div css={tw`absolute right-3 top-9 flex items-center space-x-2`}>
//                                 <FontAwesomeIcon icon={faEye} css={tw`text-yellow-400 text-sm`} />
//                                 <button
//                                     type="button"
//                                     onClick={() => setShowPassword(!showPassword)}
//                                     css={tw`text-gray-400 hover:text-gray-300 focus:outline-none`}
//                                 >
//                                     <FontAwesomeIcon icon={showPassword ? faEyeSlash : faEye} css={tw`text-sm`} />
//                                 </button>
//                             </div>
//                         </div>

//                         <div css={tw`relative`}>
//                             <Field 
//                                 light 
//                                 label={'Confirm New Password'} 
//                                 name={'passwordConfirmation'} 
//                                 type={showConfirmPassword ? 'text' : 'password'}
//                                 placeholder="Confirm your new password"
//                             />
//                             <div css={tw`absolute right-3 top-9 flex items-center space-x-2`}>
//                                 <FontAwesomeIcon icon={faEye} css={tw`text-yellow-400 text-sm`} />
//                                 <button
//                                     type="button"
//                                     onClick={() => setShowConfirmPassword(!showConfirmPassword)}
//                                     css={tw`text-gray-400 hover:text-gray-300 focus:outline-none`}
//                                 >
//                                     <FontAwesomeIcon icon={showConfirmPassword ? faEyeSlash : faEye} css={tw`text-sm`} />
//                                 </button>
//                             </div>
//                         </div>
//                     </div>

//                     <div css={tw`mt-6`}>
//                         <Button 
//                             size={Button.Sizes.Large} 
//                             css={tw`w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 rounded-lg transition-colors`} 
//                             type={'submit'} 
//                             disabled={isSubmitting}
//                         >
//                             {isSubmitting ? 'Resetting...' : 'Reset Password'}
//                         </Button>
//                     </div>

//                     {discord && (
//                         <>
//                             <div css={tw`relative my-6`}>
//                                 <div css={tw`absolute inset-0 flex items-center`}>
//                                     <div css={tw`w-full border-t border-gray-600`}></div>
//                                 </div>
//                                 <div css={tw`relative flex justify-center text-sm`}>
//                                     <span css={tw`px-4 bg-gray-800 text-gray-400 uppercase tracking-wide text-xs`}>
//                                         OR CONTINUE WITH
//                                     </span>
//                                 </div>
//                             </div>

//                             <div css={tw`grid grid-cols-2 gap-4`}>
//                                 <button
//                                     type="button"
//                                     onClick={handleDiscordLogin}
//                                     disabled={discordLoading}
//                                     css={tw`flex items-center justify-center px-4 py-3 bg-gray-900 hover:bg-gray-700 text-white rounded-lg transition-colors border border-gray-700`}
//                                 >
//                                     <img 
//                                         src="/assets/svgs/discord.svg" 
//                                         alt="Discord" 
//                                         css={tw`w-5 h-5 mr-2`}
//                                     />
//                                     <span css={tw`font-medium text-sm`}>Discord</span>
//                                 </button>
                                
//                                 <button
//                                     type="button"
//                                     disabled={true}
//                                     css={tw`flex items-center justify-center px-4 py-3 bg-gray-900 text-gray-500 rounded-lg border border-gray-700 cursor-not-allowed opacity-60`}
//                                 >
//                                     <svg css={tw`w-5 h-5 mr-2`} viewBox="0 0 24 24">
//                                         <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
//                                         <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
//                                         <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
//                                         <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
//                                     </svg>
//                                     <span css={tw`font-medium text-sm`}>Google</span>
//                                     <span css={tw`ml-1 text-xs`}>(Coming Soon)</span>
//                                 </button>
//                             </div>
//                         </>
//                     )}

//                     <div css={tw`mt-6 text-center`}>
//                         <Link
//                             to={'/auth/login'}
//                             css={tw`text-sm text-blue-400 hover:text-blue-300 transition-colors`}
//                         >
//                             Return to Login
//                         </Link>
//                     </div>
//                 </LoginFormContainer>
//             )}
//         </Formik>
//     );
// };

import tw from 'twin.macro';
import React, { useState } from 'react';
import { Link } from 'react-router-dom';
import { object, ref, string } from 'yup';
import { ApplicationStore } from '@/state';
import { httpErrorToHuman } from '@/api/http';
import { Formik, FormikHelpers } from 'formik';
import Field from '@/components/elements/Field';
import Input from '@/components/elements/Input';
import { RouteComponentProps } from 'react-router';
import { Actions, useStoreActions } from 'easy-peasy';
import { Button } from '@/components/elements/button/index';
import performPasswordReset from '@/api/auth/performPasswordReset';
import LoginFormContainer from '@/components/auth/LoginFormContainer';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import { faEye, faEyeSlash } from '@fortawesome/free-solid-svg-icons';
import { useStoreState } from 'easy-peasy';
import discordLogin from '@/api/auth/discord';
import useFlash from '@/plugins/useFlash';

interface Values {
    password: string;
    passwordConfirmation: string;
}

export default ({ match, location }: RouteComponentProps<{ token: string }>) => {
    const [email, setEmail] = useState('');
    const [showPassword, setShowPassword] = useState(false);
    const [showConfirmPassword, setShowConfirmPassword] = useState(false);
    const [discordLoading, setDiscordLoading] = useState(false);

    const { clearFlashes, addFlash } = useStoreActions((actions: Actions<ApplicationStore>) => actions.flashes);
    const { clearAndAddHttpError } = useFlash();
    
    // Easy to swap between env and state
    const siteName = process.env.REACT_APP_SITE_NAME || 'NeoDesigns Hosting';
    // const siteName = useStoreState((state) => state.settings.data?.name) || 'NeoDesigns Hosting';
    
    const discord = useStoreState((state) => state.settings.data?.registration.discord);

    const parsed = new URLSearchParams(location.search);
    if (email.length === 0 && parsed.get('email')) {
        setEmail(parsed.get('email') || '');
    }

    const handleDiscordLogin = () => {
        clearFlashes();
        setDiscordLoading(true);

        discordLogin()
            .then((data) => {
                if (!data) {
                    clearAndAddHttpError({ error: 'Discord auth failed. Please try again.' });
                    setDiscordLoading(false);
                    return;
                }
                window.location.href = data;
            })
            .catch((error) => {
                console.error(error);
                setDiscordLoading(false);
                clearAndAddHttpError({ error });
            });
    };

    const submit = ({ password, passwordConfirmation }: Values, { setSubmitting }: FormikHelpers<Values>) => {
        clearFlashes();
        performPasswordReset(email, { token: match.params.token, password, passwordConfirmation })
            .then(() => {
                // @ts-expect-error this is valid
                window.location = '/';
            })
            .catch((error) => {
                console.error(error);
                setSubmitting(false);
                addFlash({ type: 'danger', title: 'Error', message: httpErrorToHuman(error) });
            });
    };

    return (
        <Formik
            onSubmit={submit}
            initialValues={{
                password: '',
                passwordConfirmation: '',
            }}
            validationSchema={object().shape({
                password: string()
                    .required('A new password is required.')
                    .min(8, 'Your new password should be at least 8 characters in length.'),
                passwordConfirmation: string()
                    .required('Your new password does not match.')
                    // @ts-expect-error this is valid
                    .oneOf([ref('password'), null], 'Your new password does not match.'),
            })}
        >
            {({ isSubmitting }) => (
                <LoginFormContainer 
                    title={siteName} 
                    subtitle="Reset your password"
                >
                    <div css={tw`mb-6`}>
                        <label css={tw`block text-sm font-medium text-gray-300 mb-2`}>Email</label>
                        <Input 
                            value={email} 
                            isLight 
                            disabled 
                            css={tw`w-full bg-gray-700 border-gray-600 text-gray-400`}
                        />
                    </div>

                    <div css={tw`space-y-4`}>
                        <div css={tw`relative`}>
                            <Field
                                light
                                label={'New Password'}
                                name={'password'}
                                type={showPassword ? 'text' : 'password'}
                                description={'Passwords must be at least 8 characters in length.'}
                                placeholder="Enter your new password"
                            />
                            <button
                                type="button"
                                onClick={() => setShowPassword(!showPassword)}
                                css={tw`absolute right-3 top-9 text-gray-400 hover:text-gray-300 focus:outline-none`}
                            >
                                <FontAwesomeIcon icon={showPassword ? faEyeSlash : faEye} css={tw`text-sm`} />
                            </button>
                        </div>

                        <div css={tw`relative`}>
                            <Field 
                                light 
                                label={'Confirm New Password'} 
                                name={'passwordConfirmation'} 
                                type={showConfirmPassword ? 'text' : 'password'}
                                placeholder="Confirm your new password"
                            />
                            <button
                                type="button"
                                onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                                css={tw`absolute right-3 top-9 text-gray-400 hover:text-gray-300 focus:outline-none`}
                            >
                                <FontAwesomeIcon icon={showConfirmPassword ? faEyeSlash : faEye} css={tw`text-sm`} />
                            </button>
                        </div>
                    </div>

                    <div css={tw`mt-6`}>
                        <Button 
                            size={Button.Sizes.Large} 
                            css={tw`w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 rounded-lg transition-colors`} 
                            type={'submit'} 
                            disabled={isSubmitting}
                        >
                            {isSubmitting ? 'Resetting...' : 'Reset Password'}
                        </Button>
                    </div>

                    {discord && (
                        <>
                            <div css={tw`relative my-6`}>
                                <div css={tw`absolute inset-0 flex items-center`}>
                                    <div css={tw`w-full border-t border-gray-600`}></div>
                                </div>
                                <div css={tw`relative flex justify-center text-sm`}>
                                    <span css={tw`px-4 bg-gray-800 text-gray-400 uppercase tracking-wide text-xs`}>
                                        OR CONTINUE WITH
                                    </span>
                                </div>
                            </div>

                            <div css={tw`grid grid-cols-2 gap-4`}>
                                <button
                                    type="button"
                                    onClick={handleDiscordLogin}
                                    disabled={discordLoading}
                                    css={tw`flex items-center justify-center px-4 py-3 bg-gray-900 hover:bg-gray-700 text-white rounded-lg transition-colors border border-gray-700`}
                                >
                                    <img 
                                        src="/assets/svgs/discord.svg" 
                                        alt="Discord" 
                                        css={tw`w-5 h-5 mr-2`}
                                    />
                                    <span css={tw`font-medium text-sm`}>Discord</span>
                                </button>
                                
                                <button
                                    type="button"
                                    disabled={true}
                                    title="Coming Soon"
                                    css={tw`flex items-center justify-center px-4 py-3 bg-gray-900 text-gray-500 rounded-lg border border-gray-700 cursor-not-allowed opacity-60`}
                                >
                                    <svg css={tw`w-5 h-5 mr-2`} viewBox="0 0 24 24">
                                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                    </svg>
                                    <span css={tw`font-medium text-sm`}>Google</span>
                                </button>
                            </div>
                        </>
                    )}

                    <div css={tw`mt-6 text-center`}>
                        <Link
                            to={'/auth/login'}
                            css={tw`text-sm text-blue-400 hover:text-blue-300 transition-colors`}
                        >
                            Return to Login
                        </Link>
                    </div>
                </LoginFormContainer>
            )}
        </Formik>
    );
};
</file>

<file path="resources/scripts/components/dashboard/DashboardContainer.tsx">
// // import useSWR from 'swr';
// // import tw from 'twin.macro';
// // import getServers from '@/api/getServers';
// // import useFlash from '@/plugins/useFlash';
// // import { useStoreState } from 'easy-peasy';
// // import { PaginatedResult } from '@/api/http';
// // import { useLocation } from 'react-router-dom';
// // import { Server } from '@/api/server/getServer';
// // import Switch from '@/components/elements/Switch';
// // import React, { useEffect, useState } from 'react';
// // import Spinner from '@/components/elements/Spinner';
// // import ServerRow from '@/components/dashboard/ServerRow';
// // import Pagination from '@/components/elements/Pagination';
// // import { usePersistedState } from '@/plugins/usePersistedState';
// // import PageContentBlock from '@/components/elements/PageContentBlock';

// // export default () => {
// //     const { search } = useLocation();
// //     const defaultPage = Number(new URLSearchParams(search).get('page') || '1');

// //     const [page, setPage] = useState(!isNaN(defaultPage) && defaultPage > 0 ? defaultPage : 1);
// //     const { clearFlashes, clearAndAddHttpError } = useFlash();
// //     const uuid = useStoreState((state) => state.user.data!.uuid);
// //     const username = useStoreState((state) => state.user.data!.username);
// //     const rootAdmin = useStoreState((state) => state.user.data!.rootAdmin);
// //     const [showOnlyAdmin, setShowOnlyAdmin] = usePersistedState(`${uuid}:show_all_servers`, false);

// //     const { data: servers, error } = useSWR<PaginatedResult<Server>>(
// //         ['/api/client/servers', showOnlyAdmin && rootAdmin, page],
// //         () => getServers({ page, type: showOnlyAdmin && rootAdmin ? 'admin' : undefined })
// //     );

// //     useEffect(() => {
// //         if (!servers) return;
// //         if (servers.pagination.currentPage > 1 && !servers.items.length) {
// //             setPage(1);
// //         }
// //     }, [servers?.pagination.currentPage]);

// //     useEffect(() => {
// //         // Don't use react-router to handle changing this part of the URL, otherwise it
// //         // triggers a needless re-render. We just want to track this in the URL incase the
// //         // user refreshes the page.
// //         window.history.replaceState(null, document.title, `/${page <= 1 ? '' : `?page=${page}`}`);
// //     }, [page]);

// //     useEffect(() => {
// //         if (error) clearAndAddHttpError({ key: 'dashboard', error });
// //         if (!error) clearFlashes('dashboard');
// //     }, [error]);

// //     return (
// //         <PageContentBlock title={'Dashboard'} css={tw`mt-4 sm:mt-10`} showFlashKey={'dashboard'}>
// //             <div css={tw`mb-10 flex justify-between items-center`}>
// //                 {rootAdmin ? (
// //                     <>
// //                         <div>
// //                             <h1 className={'text-5xl'}>
// //                                 {showOnlyAdmin ? 'Showing other servers' : 'Showing your servers'}
// //                             </h1>
// //                             <h3 className={'text-2xl mt-2 text-neutral-500'}>
// //                                 Select a server to view, update or modify.
// //                             </h3>
// //                         </div>
// //                         <Switch
// //                             name={'show_all_servers'}
// //                             defaultChecked={showOnlyAdmin}
// //                             onChange={() => setShowOnlyAdmin((s) => !s)}
// //                         />
// //                     </>
// //                 ) : (
// //                     <div>
// //                         <h1 className={'text-5xl'}>Welcome, {username}!</h1>
// //                         <h3 className={'text-2xl mt-2 text-neutral-500'}>
// //                             Select a server from the list of your servers below.
// //                         </h3>
// //                     </div>
// //                 )}
// //             </div>
// //             {!servers ? (
// //                 <Spinner centered size={'large'} />
// //             ) : (
// //                 <Pagination data={servers} onPageSelect={setPage}>
// //                     {({ items }) =>
// //                         items.length > 0 ? (
// //                             <div className={'lg:grid lg:grid-cols-2 gap-4'}>
// //                                 <>
// //                                     {items.map((server) => (
// //                                         <ServerRow
// //                                             key={server.uuid}
// //                                             server={server}
// //                                             className={'j-up'}
// //                                             css={tw`mt-2`}
// //                                         />
// //                                     ))}
// //                                 </>
// //                             </div>
// //                         ) : (
// //                             <p className={'text-gray-400 text-lg font-semibold text-center'}>
// //                                 Doesn&apos;t look like you have any servers here.
// //                             </p>
// //                         )
// //                     }
// //                 </Pagination>
// //             )}
// //         </PageContentBlock>
// //     );
// // };

import useSWR from 'swr';
import tw from 'twin.macro';
import getServers from '@/api/getServers';
import useFlash from '@/plugins/useFlash';
import { useStoreState } from 'easy-peasy';
import { PaginatedResult } from '@/api/http';
import { useLocation } from 'react-router-dom';
import { Server } from '@/api/server/getServer';
import React, { useEffect, useState } from 'react';
import Spinner from '@/components/elements/Spinner';
import ServerRow from '@/components/dashboard/ServerRow';
import Pagination from '@/components/elements/Pagination';
import { usePersistedState } from '@/plugins/usePersistedState';
import PageContentBlock from '@/components/elements/PageContentBlock';

export default () => {
    const { search } = useLocation();
    const defaultPage = Number(new URLSearchParams(search).get('page') || '1');

    const [page, setPage] = useState(!isNaN(defaultPage) && defaultPage > 0 ? defaultPage : 1);
    const { clearFlashes, clearAndAddHttpError } = useFlash();
    const uuid = useStoreState((state) => state.user.data!.uuid);
    const username = useStoreState((state) => state.user.data!.username);
    const rootAdmin = useStoreState((state) => state.user.data!.rootAdmin);
    const [showOnlyAdmin, setShowOnlyAdmin] = usePersistedState(`${uuid}:show_all_servers`, false);

    const { data: servers, error } = useSWR<PaginatedResult<Server>>(
        ['/api/client/servers', showOnlyAdmin && rootAdmin, page],
        () => getServers({ page, type: showOnlyAdmin && rootAdmin ? 'admin' : undefined })
    );

    useEffect(() => {
        if (!servers) return;
        if (servers.pagination.currentPage > 1 && !servers.items.length) {
            setPage(1);
        }
    }, [servers?.pagination.currentPage]);

    useEffect(() => {
        window.history.replaceState(null, document.title, `/${page <= 1 ? '' : `?page=${page}`}`);
    }, [page]);

    useEffect(() => {
        if (error) clearAndAddHttpError({ key: 'dashboard', error });
        if (!error) clearFlashes('dashboard');
    }, [error]);

    return (
        <div css={tw`ml-0 xl:ml-32 min-h-screen`}>
            <PageContentBlock title={'Dashboard'} css={tw`mt-4 sm:mt-10`} showFlashKey={'dashboard'}>
                <div css={tw`mb-12 flex justify-between items-start gap-8 flex-wrap`}>
                    {rootAdmin ? (
                        <>
                            <div css={tw`flex-1`}>
                                <h1 css={tw`text-5xl font-bold mb-2 text-white`}>
                                    {showOnlyAdmin ? 'Showing other servers' : 'Showing your servers'}
                                </h1>
                                <h3 css={tw`text-lg`} style={{ color: 'hsl(0, 0%, 50%)' }}>
                                    Select a server to view, update or modify.
                                </h3>
                            </div>
                            <div css={tw`flex-shrink-0`} style={{ marginTop: 0 }}>
                                <button
                                    onClick={() => setShowOnlyAdmin((s) => !s)}
                                    css={tw`px-4 py-2 rounded-lg font-semibold transition-all duration-200 text-white border-2`}
                                    style={{
                                        backgroundColor: showOnlyAdmin ? 'rgb(220, 38, 38)' : 'transparent',
                                        borderColor: 'rgb(220, 38, 38)',
                                        color: showOnlyAdmin ? 'white' : 'rgb(220, 38, 38)',
                                    }}
                                >
                                    {showOnlyAdmin ? 'Other Servers' : 'Your Servers'}
                                </button>
                            </div>
                        </>
                    ) : (
                        <div css={tw`flex-1`}>
                            <h1 css={tw`text-5xl font-bold mb-2 text-white`}>Welcome, {username}!</h1>
                            <h3 css={tw`text-lg`} style={{ color: 'hsl(0, 0%, 50%)' }}>
                                Select a server from the list of your servers below.
                            </h3>
                        </div>
                    )}
                </div>

                {!servers ? (
                    <Spinner centered size={'large'} />
                ) : (
                    <Pagination data={servers} onPageSelect={setPage}>
                        {({ items }) =>
                            items.length > 0 ? (
                                <div css={tw`grid grid-cols-1 md:grid-cols-2 gap-6 px-6`}>
                                    {items.map((server) => (
                                        <ServerRow
                                            key={server.uuid}
                                            server={server}
                                            className={'j-up'}
                                            css={tw`
                                                border rounded-lg
                                                transition-all duration-200
                                                overflow-hidden
                                            `}
                                        />
                                    ))}
                                </div>
                            ) : (
                                <div css={tw`text-center py-12`}>
                                    <p css={tw`text-lg font-medium`} style={{ color: 'hsl(0, 0%, 50%)' }}>
                                        Doesn&apos;t look like you have any servers here.
                                    </p>
                                </div>
                            )
                        }
                    </Pagination>
                )}
            </PageContentBlock>
        </div>
    );
};
</file>

<file path="resources/scripts/components/elements/PageContentBlock.tsx">
import React, { useEffect, useState } from 'react';
import styled from 'styled-components/macro';

export interface PageContentBlockProps {
    title?: string;
    description?: string | null;
    className?: string;
    logo?: string;
    children?: React.ReactNode;
    showFlashKey?: string;
}

const PageContentBlock: React.FC<PageContentBlockProps> = ({
    title,
    description,
    className,
    logo = 'https://cdn.vervecustoms.com/banners/neo/Neo-002-Transparent-Sized.png',
    children,
}) => {
    const [statusData, setStatusData] = useState({
        state: 'operational',
        loading: true,
    });

    useEffect(() => {
        if (title) {
            document.title = title;
        }
    }, [title]);

    // Fetch status from BetterStack via our backend proxy
    useEffect(() => {
        const fetchStatus = async () => {
            try {
                const response = await fetch('/api/status.php');

                if (response.ok) {
                    const data = await response.json();
                    setStatusData({
                        state: data.status || 'operational',
                        loading: false,
                    });
                } else {
                    // Fallback to operational
                    setStatusData({ state: 'operational', loading: false });
                }
            } catch (error) {
                console.warn('Could not fetch status:', error);
                // Graceful degradation
                setStatusData({ state: 'operational', loading: false });
            }
        };

        fetchStatus();
        // Refresh every 60 seconds
        const interval = setInterval(fetchStatus, 60000);
        return () => clearInterval(interval);
    }, []);

    // Get status display config
    const getStatusConfig = () => {
        switch (statusData.state) {
            case 'operational':
                return {
                    text: 'All services are online',
                    color: '#22c55e',
                    dotColor: '#22c55e',
                    shouldPulse: false,
                };
            case 'degraded_performance':
            case 'degraded':
                return {
                    text: 'Degraded performance',
                    color: '#f59e0b',
                    dotColor: '#f59e0b',
                    shouldPulse: true,
                };
            case 'partial_outage':
                return {
                    text: 'Partial outage',
                    color: '#f59e0b',
                    dotColor: '#f59e0b',
                    shouldPulse: true,
                };
            case 'major_outage':
            case 'downtime':
                return {
                    text: 'Major outage',
                    color: '#ef4444',
                    dotColor: '#ef4444',
                    shouldPulse: true,
                };
            case 'maintenance':
                return {
                    text: 'Under maintenance',
                    color: '#3b82f6',
                    dotColor: '#3b82f6',
                    shouldPulse: true,
                };
            default:
                return {
                    text: 'All systems operational',
                    color: '#22c55e',
                    dotColor: '#22c55e',
                    shouldPulse: false,
                };
        }
    };

    const statusConfig = getStatusConfig();

    // --- Styled Components Definitions ---

    const Container = styled.div`
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    `;

    const Content = styled.div`
        flex: 1;
        padding: 2rem;
        max-width: 80rem;
        margin: 0 auto;
        width: 100%;
        box-sizing: border-box;
    `;

    const TitleSection = styled.div`
        margin-bottom: 2.5rem;
        padding-top: 1rem;
    `;

    const MainTitle = styled.h1`
        font-size: 3rem;
        font-weight: bold;
        color: #f5f5f5;
        margin-bottom: 0.5rem;
    `;

    const SubDescription = styled.h3`
        font-size: 1.5rem;
        color: #a3a3a3;
        font-weight: 300;
    `;

    const FooterContainer = styled.div`
        background-color: transparent;
        color: #a3a3a3;
        padding: 4rem 2rem;
        border-top: 1px solid #404040;
    `;

    const FooterContent = styled.div`
        max-width: 80rem;
        margin: 0 auto;
    `;

    const FooterGrid = styled.div`
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 3rem;
        margin-bottom: 3rem;
    `;

    const FooterSection = styled.div`
        display: flex;
        flex-direction: column;
    `;

    const SectionTitle = styled.h3`
        font-weight: 600;
        color: #f5f5f5;
        margin-bottom: 1rem;
        font-size: 1rem;
    `;

    const SectionLink = styled.a`
        color: #737373;
        text-decoration: none;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
        transition: color 0.3s ease;

        &:hover {
            color: #d4d4d8;
        }
    `;

    const Logo = styled.img`
        height: 3rem;
        margin: 0;
        object-fit: contain;
        display: block;
    `;

    const LogoSection = styled.div`
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 2rem;

        @media (max-width: 640px) {
            flex-direction: column;
            align-items: flex-start;
        }
    `;

    const LogoText = styled.h2`
        font-size: 1.5rem;
        font-weight: bold;
        color: #f5f5f5;
        margin: 0;
    `;

    const Description = styled.p`
        color: #737373;
        font-size: 0.875rem;
        line-height: 1.6;
        max-width: 20rem;
    `;

    const Divider = styled.hr`
        border: none;
        border-top: 1px solid #404040;
        margin: 2rem 0;
    `;

    const BottomBar = styled.div`
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 2rem;
        border-top: 1px solid #404040;
        flex-wrap: wrap;
        gap: 1rem;
    `;

    const Copyright = styled.p`
        color: #737373;
        font-size: 0.875rem;
        margin: 0;
    `;

    const StatusBadgeWrapper = styled.a<{ statusColor: string; shouldPulse: boolean }>`
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border: 1px solid ${(props) => props.statusColor};
        border-radius: 0.5rem;
        color: ${(props) => props.statusColor};
        font-size: 0.875rem;
        text-decoration: none;
        transition: all 0.3s ease;
        cursor: pointer;
        background-color: transparent;

        &:hover {
            opacity: 0.8;
        }

        &::before {
            width: 0.5rem;
            height: 0.5rem;
            background-color: ${(props) => props.statusColor};
            border-radius: 9999px;
            content: '';
            display: block;
            animation: ${(props) => (props.shouldPulse ? 'pulse 2s ease-in-out infinite' : 'none')};
        }

        @keyframes pulse {
            0%,
            100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
    `;

    // --- Component Render ---

    return (
        <Container>
            <Content className={className}>
                {description && (
                    <TitleSection>
                        <MainTitle>{title}</MainTitle>
                        <SubDescription>{description}</SubDescription>
                    </TitleSection>
                )}
                {children}
            </Content>

            <FooterContainer>
                <FooterContent>
                    <FooterGrid>
                        <FooterSection>
                            <LogoSection>
                                <Logo src={logo} alt='NeoDesigns Logo' />
                                <LogoText>NeoDesigns</LogoText>
                            </LogoSection>
                            <Description>
                                NeoDesigns is a collaborative and dynamic design server built to inspire creativity and
                                connection. Explore our range of design services and join a growing creative community.
                            </Description>
                        </FooterSection>

                        <FooterSection>
                            <SectionTitle>NeoDesigns</SectionTitle>
                            <SectionLink href='https://google.com' target='_blank' rel='noopener noreferrer'>
                                Homepage
                            </SectionLink>
                            <SectionLink href='https://discord.gg/neodesigns' target='_blank' rel='noopener noreferrer'>
                                Contact Us
                            </SectionLink>
                            <SectionLink href='https://discord.gg/neodesigns' target='_blank' rel='noopener noreferrer'>
                                Join Our Team
                            </SectionLink>
                        </FooterSection>

                        <FooterSection>
                            <SectionTitle>Legal</SectionTitle>
                            <SectionLink
                                href='https://hosting.vervecustoms.com/docs/terms'
                                target='_blank'
                                rel='noopener noreferrer'
                            >
                                Terms of Service
                            </SectionLink>
                            <SectionLink
                                href='https://hosting.vervecustoms.com/docs/privacy'
                                target='_blank'
                                rel='noopener noreferrer'
                            >
                                Privacy Policy
                            </SectionLink>
                        </FooterSection>
                    </FooterGrid>

                    <BottomBar>
                        <Copyright>
                            <p>Copyright &copy; {new Date().getFullYear()} NeoDesigns. All Rights Reserved</p>
                        </Copyright>
                        <StatusBadgeWrapper
                            href='https://status.vervecustoms.com'
                            target='_blank'
                            rel='noopener noreferrer'
                            statusColor={statusConfig.color}
                            shouldPulse={statusConfig.shouldPulse}
                        >
                            {statusConfig.text}
                        </StatusBadgeWrapper>
                    </BottomBar>
                </FooterContent>
            </FooterContainer>
        </Container>
    );
};

export default PageContentBlock;
// V3 Code - Added dynamic status badge with BetterStack integration via backend proxy.
</file>

<file path="resources/scripts/components/server/files/FileEditContainer.tsx">
import tw from 'twin.macro';
import modes from '@/modes';
import { dirname } from 'path';
import useFlash from '@/plugins/useFlash';
import Can from '@/components/elements/Can';
import { httpErrorToHuman } from '@/api/http';
import { ServerContext } from '@/state/server';
import Select from '@/components/elements/Select';
import React, { useEffect, useState } from 'react';
import { encodePathSegments, hashToPath } from '@/helpers';
import { Button } from '@/components/elements/button/index';
import { ServerError } from '@/components/elements/ScreenBlock';
import ErrorBoundary from '@/components/elements/ErrorBoundary';
import getFileContents from '@/api/server/files/getFileContents';
import FlashMessageRender from '@/components/FlashMessageRender';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import { useHistory, useLocation, useParams } from 'react-router';
import saveFileContents from '@/api/server/files/saveFileContents';
import FileNameModal from '@/components/server/files/FileNameModal';
import PageContentBlock from '@/components/elements/PageContentBlock';
import CodemirrorEditor from '@/components/elements/CodemirrorEditor';
import FileManagerBreadcrumbs from '@/components/server/files/FileManagerBreadcrumbs';

export default () => {
    const [error, setError] = useState('');
    const { action } = useParams<{ action: 'new' | string }>();
    const [loading, setLoading] = useState(action === 'edit');
    const [content, setContent] = useState('');
    const [modalVisible, setModalVisible] = useState(false);
    const [mode, setMode] = useState('text/plain');

    const history = useHistory();
    const { hash } = useLocation();

    const id = ServerContext.useStoreState((state) => state.server.data!.id);
    const uuid = ServerContext.useStoreState((state) => state.server.data!.uuid);
    const setDirectory = ServerContext.useStoreActions((actions) => actions.files.setDirectory);
    const { addError, clearFlashes } = useFlash();

    let fetchFileContent: null | (() => Promise<string>) = null;

    useEffect(() => {
        if (action === 'new') return;

        setError('');
        setLoading(true);
        const path = hashToPath(hash);
        setDirectory(dirname(path));
        getFileContents(uuid, path)
            .then(setContent)
            .catch((error) => {
                console.error(error);
                setError(httpErrorToHuman(error));
            })
            .then(() => setLoading(false));
    }, [action, uuid, hash]);

    const save = (name?: string) => {
        if (!fetchFileContent) {
            return;
        }

        setLoading(true);
        clearFlashes('files:view');
        fetchFileContent()
            .then((content) => saveFileContents(uuid, name || hashToPath(hash), content))
            .then(() => {
                if (name) {
                    history.push(`/server/${id}/files/edit#/${encodePathSegments(name)}`);
                    return;
                }

                return Promise.resolve();
            })
            .catch((error) => {
                console.error(error);
                addError({ message: httpErrorToHuman(error), key: 'files:view' });
            })
            .then(() => setLoading(false));
    };

    if (error) {
        return <ServerError message={error} onBack={() => history.goBack()} />;
    }

    return (
        <PageContentBlock>
            <FlashMessageRender byKey={'files:view'} css={tw`mb-4`} />
            <ErrorBoundary>
                <div className={'mb-4 j-right'}>
                    <FileManagerBreadcrumbs withinFileEditor isNewFile={action !== 'edit'} />
                </div>
            </ErrorBoundary>
            {hash.replace(/^#/, '').endsWith('.pteroignore') && (
                <div css={tw`mb-4 p-4 border-l-4 bg-neutral-900 rounded border-cyan-400`}>
                    <p css={tw`text-neutral-300 text-sm`}>
                        You&apos;re editing a <code css={tw`font-mono bg-black rounded py-px px-1`}>.pteroignore</code>{' '}
                        file. Any files or directories listed in here will be excluded from backups. Wildcards are
                        supported by using an asterisk (<code css={tw`font-mono bg-black rounded py-px px-1`}>*</code>).
                        You can negate a prior rule by prepending an exclamation point (
                        <code css={tw`font-mono bg-black rounded py-px px-1`}>!</code>).
                    </p>
                </div>
            )}
            <FileNameModal
                visible={modalVisible}
                onDismissed={() => setModalVisible(false)}
                onFileNamed={(name) => {
                    setModalVisible(false);
                    save(name);
                }}
            />
            <div css={tw`relative`}>
                <SpinnerOverlay visible={loading} />
                <CodemirrorEditor
                    mode={mode}
                    filename={hash.replace(/^#/, '')}
                    onModeChanged={setMode}
                    initialContent={content}
                    fetchContent={(value) => {
                        fetchFileContent = value;
                    }}
                    onContentSaved={() => {
                        if (action !== 'edit') {
                            setModalVisible(true);
                        } else {
                            save();
                        }
                    }}
                />
            </div>
            <div className={'flex justify-end mt-4'}>
                <div className={'flex-1 sm:flex-none rounded bg-neutral-900 mr-4'}>
                    <Select value={mode} onChange={(e) => setMode(e.currentTarget.value)}>
                        {modes.map((mode) => (
                            <option key={`${mode.name}_${mode.mime}`} value={mode.mime}>
                                {mode.name}
                            </option>
                        ))}
                    </Select>
                </div>
                {action === 'edit' ? (
                    <Can action={'file.update'}>
                        <Button css={tw`flex-1 sm:flex-none`} onClick={() => save()}>
                            Save Content
                        </Button>
                    </Can>
                ) : (
                    <Can action={'file.create'}>
                        <Button css={tw`flex-1 sm:flex-none`} onClick={() => setModalVisible(true)}>
                            Create File
                        </Button>
                    </Can>
                )}
            </div>
        </PageContentBlock>
    );
};
</file>

<file path="resources/scripts/components/store/PurchaseContainer.tsx">
// import tw from 'twin.macro';
// import { breakpoint } from '@/theme';
// import styled from 'styled-components/macro';
// import { useStoreState } from '@/state/hooks';
// import React, { useEffect, useState } from 'react';
// import Spinner from '@/components/elements/Spinner';
// import ContentBox from '@/components/elements/ContentBox';
// import { getResources, Resources } from '@/api/store/getResources';
// import PageContentBlock from '@/components/elements/PageContentBlock';
// import StripePurchaseForm from '@/components/store/forms/StripePurchaseForm';
// import PaypalPurchaseForm from '@/components/store/forms/PaypalPurchaseForm';

// const Container = styled.div`
//     ${tw`flex flex-wrap`};

//     & > div {
//         ${tw`w-full`};

//         ${breakpoint('sm')`
//       width: calc(50% - 1rem);
//     `}

//         ${breakpoint('md')`
//       ${tw`w-auto flex-1`};
//     `}
//     }
// `;

// export default () => {
//     const [resources, setResources] = useState<Resources>();
//     const earn = useStoreState((state) => state.storefront.data!.earn);
//     const paypal = useStoreState((state) => state.storefront.data!.gateways?.paypal);
//     const stripe = useStoreState((state) => state.storefront.data!.gateways?.stripe);

//     useEffect(() => {
//         getResources().then((resources) => setResources(resources));
//     }, []);

//     if (!resources) return <Spinner size={'large'} centered />;

//     return (
//         <PageContentBlock title={'Account Balance'} description={'Purchase credits easily via Stripe or PayPal.'}>
//             <Container className={'lg:grid lg:grid-cols-2 my-10'}>
//                 <ContentBox title={'Account Balance'} showFlashes={'account:balance'} css={tw`sm:mt-0`}>
//                     <h1 css={tw`text-7xl flex justify-center items-center`}>
//                         {resources.balance} <span className={'text-base ml-4'}>credits</span>
//                     </h1>
//                 </ContentBox>
//                 <ContentBox title={'Purchase credits'} showFlashes={'account:balance'} css={tw`mt-8 sm:mt-0 sm:ml-8`}>
//                     {!paypal && !stripe ? (
//                         <p className={'text-gray-400 text-sm text-center'}>
//                             Payment gateways are unavailable at this time.
//                         </p>
//                     ) : (
//                         <>
//                             {paypal && <PaypalPurchaseForm />}
//                             {stripe && <StripePurchaseForm />}
//                         </>
//                     )}
//                 </ContentBox>
//             </Container>
//             {earn.enabled && (
//                 <>
//                     <h1 className={'text-5xl'}>Idle Credit Earning</h1>
//                     <h3 className={'text-2xl text-neutral-500'}>
//                         See how many credits you will recieve per minute of AFK.
//                     </h3>
//                     <Container className={'lg:grid lg:grid-cols-2 my-10'}>
//                         <ContentBox title={'Earn Rate'} showFlashes={'earn:rate'} css={tw`sm:mt-0`}>
//                             <h1 css={tw`text-7xl flex justify-center items-center`}>
//                                 {earn.amount} <span className={'text-base ml-4'}>credits / min</span>
//                             </h1>
//                         </ContentBox>
//                         <ContentBox
//                             title={'How to earn'}
//                             showFlashes={'earn:how'}
//                             css={tw`mt-8 sm:mt-0 sm:ml-8 text-gray-300`}
//                         >
//                             <p>You can earn credits by having any page of this panel open.</p>
//                             <p css={tw`mt-1`}>
//                                 <span css={tw`text-green-500`}>{earn.amount}&nbsp;</span>
//                                 credit(s) per minute will automatically be added to your account, as long as this site
//                                 is open in a browser tab.
//                             </p>
//                         </ContentBox>
//                     </Container>
//                 </>
//             )}
//         </PageContentBlock>
//     );
// };


import tw from 'twin.macro';
import { breakpoint } from '@/theme';
import styled from 'styled-components/macro';
import { useStoreState } from '@/state/hooks';
import React, { useEffect, useState } from 'react';
import Spinner from '@/components/elements/Spinner';
import ContentBox from '@/components/elements/ContentBox';
import { getResources, Resources } from '@/api/store/getResources';
import PageContentBlock from '@/components/elements/PageContentBlock';
import StripePurchaseForm from '@/components/store/forms/StripePurchaseForm';
import PaypalPurchaseForm from '@/components/store/forms/PaypalPurchaseForm';
import RobuxPurchaseForm from '@/components/store/forms/RobuxPurchaseForm';

const Container = styled.div`
    ${tw`flex flex-wrap`};

    & > div {
        ${tw`w-full`};

        ${breakpoint('sm')`
      width: calc(50% - 1rem);
    `}

        ${breakpoint('md')`
      ${tw`w-auto flex-1`};
    `}
    }
`;

export default () => {
    const [resources, setResources] = useState<Resources>();
    const earn = useStoreState((state) => state.storefront.data!.earn);
    const paypal = useStoreState((state) => state.storefront.data!.gateways?.paypal);
    const stripe = useStoreState((state) => state.storefront.data!.gateways?.stripe);
    
    // TODO: Add robux state from store when backend is ready
    const robux = true; // For now, always show Robux option

    useEffect(() => {
        getResources().then((resources) => setResources(resources));
    }, []);

    if (!resources) return <Spinner size={'large'} centered />;

    return (
        <PageContentBlock title={'Account Balance'} description={'Purchase credits easily via Stripe, PayPal, or Robux.'}>
            <Container className={'lg:grid lg:grid-cols-2 my-10'}>
                <ContentBox title={'Account Balance'} showFlashes={'account:balance'} css={tw`sm:mt-0`}>
                    <h1 css={tw`text-7xl flex justify-center items-center`}>
                        {resources.balance} <span className={'text-base ml-4'}>credits</span>
                    </h1>
                </ContentBox>
                <ContentBox title={'Purchase credits'} showFlashes={'account:balance'} css={tw`mt-8 sm:mt-0 sm:ml-8`}>
                    {!paypal && !stripe && !robux ? (
                        <p className={'text-gray-400 text-sm text-center'}>
                            Payment gateways are unavailable at this time.
                        </p>
                    ) : (
                        <>
                            {stripe && (
                                <div css={tw`mb-6`}>
                                    <StripePurchaseForm />
                                </div>
                            )}
                            {paypal && (
                                <div css={tw`mb-6`}>
                                    <h3 css={tw`text-lg font-semibold mb-3 text-white`}>Purchase via PayPal</h3>
                                    <PaypalPurchaseForm />
                                </div>
                            )}
                            {robux && (
                                <div>
                                    <RobuxPurchaseForm />
                                </div>
                            )}
                        </>
                    )}
                </ContentBox>
            </Container>
            {earn.enabled && (
                <>
                    <h1 className={'text-5xl'}>Idle Credit Earning</h1>
                    <h3 className={'text-2xl text-neutral-500'}>
                        See how many credits you will recieve per minute of AFK.
                    </h3>
                    <Container className={'lg:grid lg:grid-cols-2 my-10'}>
                        <ContentBox title={'Earn Rate'} showFlashes={'earn:rate'} css={tw`sm:mt-0`}>
                            <h1 css={tw`text-7xl flex justify-center items-center`}>
                                {earn.amount} <span className={'text-base ml-4'}>credits / min</span>
                            </h1>
                        </ContentBox>
                        <ContentBox
                            title={'How to earn'}
                            showFlashes={'earn:how'}
                            css={tw`mt-8 sm:mt-0 sm:ml-8 text-gray-300`}
                        >
                            <p>You can earn credits by having any page of this panel open.</p>
                            <p css={tw`mt-1`}>
                                <span css={tw`text-green-500`}>{earn.amount}&nbsp;</span>
                                credit(s) per minute will automatically be added to your account, as long as this site
                                is open in a browser tab.
                            </p>
                        </ContentBox>
                    </Container>
                </>
            )}
        </PageContentBlock>
    );
};
</file>

<file path="resources/scripts/components/store/ResourcesContainer.tsx">
// // import tw from 'twin.macro';
// // import { breakpoint } from '@/theme';
// // import * as Icon from 'react-feather';
// // import { Link } from 'react-router-dom';
// // import useFlash from '@/plugins/useFlash';
// // import styled from 'styled-components/macro';
// // import React, { useState, useEffect } from 'react';
// // import Spinner from '@/components/elements/Spinner';
// // import { Button } from '@/components/elements/button';
// // import { Dialog } from '@/components/elements/dialog';
// // import { getCosts, Costs } from '@/api/store/getCosts';
// // import purchaseResource from '@/api/store/purchaseResource';
// // import TitledGreyBox from '@/components/elements/TitledGreyBox';
// // import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
// // import PurchaseBox from '@/components/elements/store/PurchaseBox';
// // import PageContentBlock from '@/components/elements/PageContentBlock';

// // const Container = styled.div`
// //     ${tw`flex flex-wrap`};

// //     & > div {
// //         ${tw`w-full`};

// //         ${breakpoint('sm')`
// //       width: calc(50% - 1rem);
// //     `}

// //         ${breakpoint('md')`
// //       ${tw`w-auto flex-1`};
// //     `}
// //     }
// // `;

// // export default () => {
// //     const [open, setOpen] = useState(false);
// //     const [costs, setCosts] = useState<Costs>();
// //     const [resource, setResource] = useState('');
// //     const { addFlash, clearFlashes, clearAndAddHttpError } = useFlash();

// //     useEffect(() => {
// //         getCosts().then((costs) => setCosts(costs));
// //     }, []);

// //     const purchase = (resource: string) => {
// //         clearFlashes('store:resources');

// //         purchaseResource(resource)
// //             .then(() => {
// //                 setOpen(false);
// //                 addFlash({
// //                     type: 'success',
// //                     key: 'store:resources',
// //                     message: 'Resource has been added to your account.',
// //                 });
// //             })
// //             .catch((error) => clearAndAddHttpError({ key: 'store:resources', error }));
// //     };

// //     if (!costs) return <Spinner size={'large'} centered />;

// //     return (
// //         <PageContentBlock
// //             title={'Buy Resources'}
// //             description={'Buy more resources to add to your server.'}
// //             showFlashKey={'store:resources'}
// //         >
// //             <SpinnerOverlay size={'large'} visible={open} />
// //             <Dialog.Confirm
// //                 open={open}
// //                 onClose={() => setOpen(false)}
// //                 title={'Confirm resource seletion'}
// //                 confirm={'Continue'}
// //                 onConfirmed={() => purchase(resource)}
// //             >
// //                 Are you sure you want to purchase this resource ({resource})? This will take the credits from your
// //                 account and add the resource. This is not a reversible transaction.
// //             </Dialog.Confirm>
// //             <Container className={'lg:grid lg:grid-cols-4 my-10 gap-8'}>
// //                 <PurchaseBox
// //                     type={'CPU'}
// //                     amount={50}
// //                     suffix={'%'}
// //                     cost={costs.cpu}
// //                     setOpen={setOpen}
// //                     icon={<Icon.Cpu />}
// //                     setResource={setResource}
// //                     description={'Buy CPU to improve server load times and performance.'}
// //                 />
// //                 <PurchaseBox
// //                     type={'Memory'}
// //                     amount={1}
// //                     suffix={'GB'}
// //                     cost={costs.memory}
// //                     setOpen={setOpen}
// //                     icon={<Icon.PieChart />}
// //                     setResource={setResource}
// //                     description={'Buy RAM to improve overall server performance.'}
// //                 />
// //                 <PurchaseBox
// //                     type={'Disk'}
// //                     amount={1}
// //                     suffix={'GB'}
// //                     cost={costs.disk}
// //                     setOpen={setOpen}
// //                     icon={<Icon.HardDrive />}
// //                     setResource={setResource}
// //                     description={'Buy disk to store more files.'}
// //                 />
// //                 <PurchaseBox
// //                     type={'Slots'}
// //                     amount={1}
// //                     cost={costs.slots}
// //                     setOpen={setOpen}
// //                     icon={<Icon.Server />}
// //                     setResource={setResource}
// //                     description={'Buy a server slot so you can deploy a new server.'}
// //                 />
// //             </Container>
// //             <Container className={'lg:grid lg:grid-cols-4 my-10 gap-8'}>
// //                 <PurchaseBox
// //                     type={'Ports'}
// //                     amount={1}
// //                     cost={costs.ports}
// //                     setOpen={setOpen}
// //                     icon={<Icon.Share2 />}
// //                     setResource={setResource}
// //                     description={'Buy a network port to add to a server.'}
// //                 />
// //                 <PurchaseBox
// //                     type={'Backups'}
// //                     amount={1}
// //                     cost={costs.backups}
// //                     setOpen={setOpen}
// //                     icon={<Icon.Archive />}
// //                     setResource={setResource}
// //                     description={'Buy a backup to keep your data secure.'}
// //                 />
// //                 <PurchaseBox
// //                     type={'Databases'}
// //                     amount={1}
// //                     cost={costs.databases}
// //                     setOpen={setOpen}
// //                     icon={<Icon.Database />}
// //                     setResource={setResource}
// //                     description={'Buy a database to get and set data.'}
// //                 />
// //                 <TitledGreyBox title={'How to use resources'}>
// //                     <p className={'font-semibold'}>Adding to an existing server</p>
// //                     <p className={'text-xs text-gray-500'}>
// //                         If you have a server that is already deployed, you can add resources to it by going to the
// //                         &apos;edit&apos; tab.
// //                     </p>
// //                     <p className={'font-semibold mt-1'}>Adding to a new server</p>
// //                     <p className={'text-xs text-gray-500'}>
// //                         You can buy resources and add them to a new server in the server creation page, which you can
// //                         access via the store.
// //                     </p>
// //                 </TitledGreyBox>
// //             </Container>
// //             <div className={'flex justify-center items-center'}>
// //                 <div className={'bg-auto bg-center bg-storeone p-4 m-4 rounded-lg'}>
// //                     <div className={'text-center bg-gray-900 bg-opacity-75 p-4'}>
// //                         <h1 className={'text-4xl'}>Ready to get started?</h1>
// //                         <Link to={'/store/create'}>
// //                             <Button.Text className={'w-full mt-4'}>Create a server</Button.Text>
// //                         </Link>
// //                     </div>
// //                 </div>
// //             </div>
// //         </PageContentBlock>
// //     );
// // };

// import * as Icon from 'react-feather';
// import { Link } from 'react-router-dom';
// import useFlash from '@/plugins/useFlash';
// import React, { useState, useEffect } from 'react';
// import Spinner from '@/components/elements/Spinner';
// import { Button } from '@/components/elements/button';
// import { Dialog } from '@/components/elements/dialog';
// import { getCosts, Costs } from '@/api/store/getCosts';
// import purchaseResource from '@/api/store/purchaseResource';
// import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
// import PageContentBlock from '@/components/elements/PageContentBlock';
// import { ChevronRight } from 'lucide-react';

// export default () => {
//     const [rotation, setRotation] = useState(0);
//     const [selectedResource, setSelectedResource] = useState<string | null>(null);
//     const [open, setOpen] = useState(false);
//     const [costs, setCosts] = useState<Costs>();
//     const { addFlash, clearFlashes, clearAndAddHttpError } = useFlash();

//     useEffect(() => {
//         getCosts().then((costs) => setCosts(costs));
//     }, []);

//     const resources = [
//         {
//             id: 'cpu',
//             name: 'CPU',
//             amount: 50,
//             suffix: '%',
//             icon: Icon.Cpu,
//             description: 'Buy CPU to improve server load times and performance.',
//             color: 'from-blue-500 to-cyan-500',
//         },
//         {
//             id: 'memory',
//             name: 'Memory',
//             amount: 1,
//             suffix: 'GB',
//             icon: Icon.PieChart,
//             description: 'Buy RAM to improve overall server performance.',
//             color: 'from-purple-500 to-pink-500',
//         },
//         {
//             id: 'disk',
//             name: 'Disk',
//             amount: 1,
//             suffix: 'GB',
//             icon: Icon.HardDrive,
//             description: 'Buy disk to store more files.',
//             color: 'from-orange-500 to-red-500',
//         },
//         {
//             id: 'slots',
//             name: 'Slots',
//             amount: 1,
//             suffix: '',
//             icon: Icon.Server,
//             description: 'Buy a server slot so you can deploy a new server.',
//             color: 'from-green-500 to-emerald-500',
//         },
//         {
//             id: 'ports',
//             name: 'Ports',
//             amount: 1,
//             suffix: '',
//             icon: Icon.Share2,
//             description: 'Buy a network port to add to a server.',
//             color: 'from-yellow-500 to-amber-500',
//         },
//         {
//             id: 'backups',
//             name: 'Backups',
//             amount: 1,
//             suffix: '',
//             icon: Icon.Archive,
//             description: 'Buy a backup to keep your data secure.',
//             color: 'from-indigo-500 to-blue-500',
//         },
//         {
//             id: 'databases',
//             name: 'Databases',
//             amount: 1,
//             suffix: '',
//             icon: Icon.Database,
//             description: 'Buy a database to get and set data.',
//             color: 'from-rose-500 to-pink-500',
//         },
//     ];

//     const handleRotate = (direction: 'next' | 'prev') => {
//         const step = 360 / resources.length;
//         setRotation((prev) => prev + (direction === 'next' ? step : -step));
//     };

//     const purchase = (resourceId: string) => {
//         clearFlashes('store:resources');

//         purchaseResource(resourceId)
//             .then(() => {
//                 setOpen(false);
//                 setSelectedResource(null);
//                 addFlash({
//                     type: 'success',
//                     key: 'store:resources',
//                     message: 'Resource has been added to your account.',
//                 });
//             })
//             .catch((error) => clearAndAddHttpError({ key: 'store:resources', error }));
//     };

//     const itemsPerPage = 3;
//     const step = 360 / resources.length;
//     const normalizedRotation = (((rotation / step) % resources.length) + resources.length) % resources.length;
//     const startIndex = Math.round(normalizedRotation);
//     const visibleResources: typeof resources = [];
//     for (let i = 0; i < itemsPerPage; i++) {
//         visibleResources.push(resources[(startIndex + i) % resources.length]);
//     }

//     const selectedResourceData = resources.find((r) => r.id === selectedResource);

//     if (!costs) return <Spinner size={'large'} centered />;

//     return (
//         <PageContentBlock
//             title={'Buy Resources'}
//             description={'Buy more resources to add to your server.'}
//             showFlashKey={'store:resources'}
//         >
//             <div className='flex justify-end mb-6'>
//                 <Link to={'/store/create'} className='block'>
//                     <Button.Text>Create a Server</Button.Text>
//                 </Link>
//             </div>

//             <SpinnerOverlay size={'large'} visible={open} />
//             <Dialog.Confirm
//                 open={open}
//                 onClose={() => setOpen(false)}
//                 title={'Confirm resource purchase'}
//                 confirm={'Continue'}
//                 onConfirmed={() => {
//                     if (selectedResource) {
//                         purchase(selectedResource);
//                     }
//                 }}
//             >
//                 Are you sure you want to purchase {selectedResource}? This will take the credits from your account and
//                 add the resource. This is not a reversible transaction.
//             </Dialog.Confirm>

//             <div className='grid grid-cols-1 lg:grid-cols-3 gap-8'>
//                 {/* Left - Wheel Navigation */}
//                 <div className='lg:col-span-1 flex flex-col items-center justify-center'>
//                     <div className='relative w-80 h-80 mb-8'>
//                         {/* Circular Background */}
//                         <div className='absolute inset-0 rounded-full bg-gray-800/40 border border-gray-700/50' />

//                         {/* Animated Orbit */}
//                         <div
//                             className='absolute inset-0 rounded-full border-2 border-gray-700/30'
//                             style={{ animationDuration: '20s' }}
//                         />

//                         {/* Resource Icons Around Circle */}
//                         {resources.map((res, idx) => {
//                             const angle = (idx / resources.length) * Math.PI * 2;
//                             const radius = 120;
//                             const x = Math.cos(angle - Math.PI / 2) * radius;
//                             const y = Math.sin(angle - Math.PI / 2) * radius;
//                             const ResourceIcon = res.icon;
//                             const isVisible = visibleResources.includes(res);

//                             return (
//                                 <button
//                                     key={res.id}
//                                     onClick={() => setSelectedResource(res.id)}
//                                     className='absolute w-16 h-16 rounded-full flex items-center justify-center transition-all duration-300 cursor-pointer'
//                                     style={{
//                                         left: '50%',
//                                         top: '50%',
//                                         transform: `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) scale(${
//                                             isVisible ? 1 : 0.7
//                                         })`,
//                                         opacity: isVisible ? 1 : 0.5,
//                                     }}
//                                 >
//                                     <div
//                                         className={`w-full h-full rounded-full bg-gradient-to-br ${res.color} p-0.5 hover:scale-110 transition-transform`}
//                                     >
//                                         <div className='w-full h-full rounded-full bg-gray-900 flex items-center justify-center'>
//                                             <ResourceIcon className='w-7 h-7 text-white' />
//                                         </div>
//                                     </div>
//                                 </button>
//                             );
//                         })}

//                         {/* Center Info */}
//                         <div className='absolute inset-0 flex flex-col items-center justify-center'>
//                             <div className='text-center'>
//                                 <p className='text-gray-400 text-sm mb-1'>Total Resources</p>
//                                 <p className='text-3xl font-bold text-white'>{resources.length}</p>
//                             </div>
//                         </div>
//                     </div>

//                     {/* Navigation Buttons */}
//                     <div className='flex gap-4'>
//                         <button
//                             onClick={() => handleRotate('prev')}
//                             className='px-6 py-2 bg-gray-700/50 hover:bg-gray-700/70 text-white rounded font-medium transition-colors'
//                         >
//                              Previous
//                         </button>
//                         <button
//                             onClick={() => handleRotate('next')}
//                             className='px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors flex items-center gap-2'
//                         >
//                             Next <ChevronRight className='w-4 h-4' />
//                         </button>
//                     </div>
//                 </div>

//                 {/* Right - Resource Cards */}
//                 <div className='lg:col-span-2 space-y-4'>
//                     {visibleResources.map((res) => {
//                         const ResourceIcon = res.icon;
//                         const isSelected = selectedResource === res.id;
//                         const cost = costs?.[res.id as keyof Costs] || 0;

//                         return (
//                             <div
//                                 key={res.id}
//                                 onClick={() => setSelectedResource(res.id)}
//                                 className={`group p-6 rounded-lg border transition-all duration-300 cursor-pointer transform hover:scale-105 ${
//                                     isSelected
//                                         ? 'bg-gray-700/40 border-blue-500/50'
//                                         : 'bg-gray-800/30 border-gray-700/50 hover:border-gray-600/50'
//                                 }`}
//                             >
//                                 <div className='flex items-start justify-between mb-4'>
//                                     <div className='flex items-center gap-4'>
//                                         <div className={`p-3 rounded-lg bg-gradient-to-br ${res.color}`}>
//                                             <ResourceIcon className='w-6 h-6 text-white' />
//                                         </div>
//                                         <div>
//                                             <h3 className='text-xl font-bold text-white'>{res.name}</h3>
//                                             <p className='text-gray-400 text-sm'>
//                                                 {res.amount}
//                                                 {res.suffix}
//                                             </p>
//                                         </div>
//                                     </div>
//                                     <div className='text-right'>
//                                         <p className='text-2xl font-bold text-white'>{cost}</p>
//                                         <p className='text-gray-400 text-xs'>credits</p>
//                                     </div>
//                                 </div>

//                                 <p className='text-gray-400 text-sm mb-4'>{res.description}</p>

//                                 {isSelected && (
//                                     <div className='pt-4 border-t border-gray-700/50 flex gap-3 animate-in fade-in slide-in-from-bottom-2'>
//                                         <button
//                                             onClick={(e) => {
//                                                 e.stopPropagation();
//                                                 setResource(res.id);
//                                                 setOpen(true);
//                                             }}
//                                             className='flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors'
//                                         >
//                                             Purchase
//                                         </button>
//                                     </div>
//                                 )}
//                             </div>
//                         );
//                     })}
//                 </div>
//             </div>

//             {/* Info Section */}
//             <div className='mt-16 p-8 rounded-lg bg-gray-800/40 border border-gray-700/50'>
//                 <h2 className='text-2xl font-bold text-white mb-4'>How to use resources</h2>
//                 <div className='grid grid-cols-1 md:grid-cols-2 gap-8'>
//                     <div>
//                         <h3 className='text-lg font-semibold text-white mb-2'>Adding to an existing server</h3>
//                         <p className='text-gray-400'>
//                             If you have a server that is already deployed, you can add resources to it by going to the
//                             &apos;edit&apos; tab.
//                         </p>
//                     </div>
//                     <div>
//                         <h3 className='text-lg font-semibold text-white mb-2'>Adding to a new server</h3>
//                         <p className='text-gray-400'>
//                             You can buy resources and add them to a new server in the server creation page, which you
//                             can access via the store.
//                         </p>
//                     </div>
//                 </div>
//             </div>
//         </PageContentBlock>
//     );
// };

import * as Icon from 'react-feather';
import { Link } from 'react-router-dom';
import useFlash from '@/plugins/useFlash';
import React, { useState, useEffect } from 'react';
import Spinner from '@/components/elements/Spinner';
import { Button } from '@/components/elements/button';
import { Dialog } from '@/components/elements/dialog';
import { getCosts, Costs } from '@/api/store/getCosts';
import purchaseResource from '@/api/store/purchaseResource';
import SpinnerOverlay from '@/components/elements/SpinnerOverlay';
import PageContentBlock from '@/components/elements/PageContentBlock';
import { ChevronRight } from 'lucide-react';

export default () => {
    const [rotation, setRotation] = useState(0);
    const [selectedResource, setSelectedResource] = useState<string | null>(null);
    const [open, setOpen] = useState(false);
    const [costs, setCosts] = useState<Costs>();
    const { addFlash, clearFlashes, clearAndAddHttpError } = useFlash();

    useEffect(() => {
        getCosts().then((costs) => setCosts(costs));
    }, []);

    const resources = [
        {
            id: 'cpu',
            name: 'CPU',
            amount: 50,
            suffix: '%',
            icon: Icon.Cpu,
            description: 'Buy CPU to improve server load times and performance.',
            color: 'from-blue-500 to-cyan-500',
        },
        {
            id: 'memory',
            name: 'Memory',
            amount: 1,
            suffix: 'GB',
            icon: Icon.PieChart,
            description: 'Buy RAM to improve overall server performance.',
            color: 'from-purple-500 to-pink-500',
        },
        {
            id: 'disk',
            name: 'Disk',
            amount: 1,
            suffix: 'GB',
            icon: Icon.HardDrive,
            description: 'Buy disk to store more files.',
            color: 'from-orange-500 to-red-500',
        },
        {
            id: 'slots',
            name: 'Slots',
            amount: 1,
            suffix: '',
            icon: Icon.Server,
            description: 'Buy a server slot so you can deploy a new server.',
            color: 'from-green-500 to-emerald-500',
        },
        {
            id: 'ports',
            name: 'Ports',
            amount: 1,
            suffix: '',
            icon: Icon.Share2,
            description: 'Buy a network port to add to a server.',
            color: 'from-yellow-500 to-amber-500',
        },
        {
            id: 'backups',
            name: 'Backups',
            amount: 1,
            suffix: '',
            icon: Icon.Archive,
            description: 'Buy a backup to keep your data secure.',
            color: 'from-indigo-500 to-blue-500',
        },
        {
            id: 'databases',
            name: 'Databases',
            amount: 1,
            suffix: '',
            icon: Icon.Database,
            description: 'Buy a database to get and set data.',
            color: 'from-rose-500 to-pink-500',
        },
    ];

    const handleRotate = (direction: 'next' | 'prev') => {
        const step = 360 / resources.length;
        setRotation((prev) => prev + (direction === 'next' ? step : -step));
    };

    const purchase = (resourceId: string) => {
        clearFlashes('store:resources');

        purchaseResource(resourceId)
            .then(() => {
                setOpen(false);
                setSelectedResource(null);
                addFlash({
                    type: 'success',
                    key: 'store:resources',
                    message: 'Resource has been added to your account.',
                });
            })
            .catch((error) => clearAndAddHttpError({ key: 'store:resources', error }));
    };

    const itemsPerPage = 3;
    const step = 360 / resources.length;
    const normalizedRotation = (((rotation / step) % resources.length) + resources.length) % resources.length;
    const startIndex = Math.round(normalizedRotation);
    const visibleResources: typeof resources = [];
    for (let i = 0; i < itemsPerPage; i++) {
        visibleResources.push(resources[(startIndex + i) % resources.length]);
    }

    const selectedResourceData = resources.find((r) => r.id === selectedResource);

    if (!costs) return <Spinner size={'large'} centered />;

    return (
        <PageContentBlock
            title={'Buy Resources'}
            description={'Buy more resources to add to your server.'}
            showFlashKey={'store:resources'}
        >
            <div className='flex justify-end mb-6'>
                <Link to={'/store/create'} className='block'>
                    <Button.Text>Create a Server</Button.Text>
                </Link>
            </div>

            <SpinnerOverlay size={'large'} visible={open} />
            <Dialog.Confirm
                open={open}
                onClose={() => setOpen(false)}
                title={'Confirm resource purchase'}
                confirm={'Continue'}
                onConfirmed={() => {
                    if (selectedResource) {
                        purchase(selectedResource);
                    }
                }}
            >
                Are you sure you want to purchase {selectedResource}? This will take the credits from your account and
                add the resource. This is not a reversible transaction.
            </Dialog.Confirm>

            <div className='grid grid-cols-1 lg:grid-cols-3 gap-8'>
                {/* Left - Wheel Navigation */}
                <div className='lg:col-span-1 flex flex-col items-center justify-center'>
                    <div className='relative w-80 h-80 mb-8'>
                        {/* Circular Background */}
                        <div className='absolute inset-0 rounded-full bg-gray-800/40 border border-gray-700/50' />

                        {/* Animated Orbit */}
                        <div
                            className='absolute inset-0 rounded-full border-2 border-gray-700/30'
                            style={{ animationDuration: '20s' }}
                        />

                        {/* Resource Icons Around Circle */}
                        {resources.map((res, idx) => {
                            const angle = (idx / resources.length) * Math.PI * 2;
                            const radius = 120;
                            const x = Math.cos(angle - Math.PI / 2) * radius;
                            const y = Math.sin(angle - Math.PI / 2) * radius;
                            const ResourceIcon = res.icon;
                            const isVisible = visibleResources.includes(res);

                            return (
                                <button
                                    key={res.id}
                                    onClick={() => setSelectedResource(res.id)}
                                    className='absolute w-16 h-16 rounded-full flex items-center justify-center transition-all duration-300 cursor-pointer'
                                    style={{
                                        left: '50%',
                                        top: '50%',
                                        transform: `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) scale(${
                                            isVisible ? 1 : 0.7
                                        })`,
                                        opacity: isVisible ? 1 : 0.5,
                                    }}
                                >
                                    <div
                                        className={`w-full h-full rounded-full bg-gradient-to-br ${res.color} p-0.5 hover:scale-110 transition-transform`}
                                    >
                                        <div className='w-full h-full rounded-full bg-gray-900 flex items-center justify-center'>
                                            <ResourceIcon className='w-7 h-7 text-white' />
                                        </div>
                                    </div>
                                </button>
                            );
                        })}

                        {/* Center Info */}
                        <div className='absolute inset-0 flex flex-col items-center justify-center'>
                            <div className='text-center'>
                                <p className='text-gray-400 text-sm mb-1'>Total Resources</p>
                                <p className='text-3xl font-bold text-white'>{resources.length}</p>
                            </div>
                        </div>
                    </div>

                    {/* Navigation Buttons */}
                    <div className='flex gap-4'>
                        <button
                            onClick={() => handleRotate('prev')}
                            className='px-6 py-2 bg-gray-700/50 hover:bg-gray-700/70 text-white rounded font-medium transition-colors'
                        >
                             Previous
                        </button>
                        <button
                            onClick={() => handleRotate('next')}
                            className='px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors flex items-center gap-2'
                        >
                            Next <ChevronRight className='w-4 h-4' />
                        </button>
                    </div>
                </div>

                {/* Right - Resource Cards */}
                <div className='lg:col-span-2 space-y-4'>
                    {visibleResources.map((res) => {
                        const ResourceIcon = res.icon;
                        const isSelected = selectedResource === res.id;
                        const cost = costs?.[res.id as keyof Costs] || 0;

                        return (
                            <div
                                key={res.id}
                                onClick={() => setSelectedResource(res.id)}
                                className={`group p-6 rounded-lg border transition-all duration-300 cursor-pointer transform hover:scale-105 ${
                                    isSelected
                                        ? 'bg-gray-700/40 border-blue-500/50'
                                        : 'bg-gray-800/30 border-gray-700/50 hover:border-gray-600/50'
                                }`}
                            >
                                <div className='flex items-start justify-between mb-4'>
                                    <div className='flex items-center gap-4'>
                                        <div className={`p-3 rounded-lg bg-gradient-to-br ${res.color}`}>
                                            <ResourceIcon className='w-6 h-6 text-white' />
                                        </div>
                                        <div>
                                            <h3 className='text-xl font-bold text-white'>{res.name}</h3>
                                            <p className='text-gray-400 text-sm'>
                                                {res.amount}
                                                {res.suffix}
                                            </p>
                                        </div>
                                    </div>
                                    <div className='text-right'>
                                        <p className='text-2xl font-bold text-white'>{cost}</p>
                                        <p className='text-gray-400 text-xs'>credits</p>
                                    </div>
                                </div>

                                <p className='text-gray-400 text-sm mb-4'>{res.description}</p>

                                {isSelected && (
                                    <div className='pt-4 border-t border-gray-700/50 flex gap-3 animate-in fade-in slide-in-from-bottom-2'>
                                        <button
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                setSelectedResource(res.id);
                                                setOpen(true);
                                            }}
                                            className='flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors'
                                        >
                                            Purchase
                                        </button>
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* Info Section */}
            <div className='mt-16 p-8 rounded-lg bg-gray-800/40 border border-gray-700/50'>
                <h2 className='text-2xl font-bold text-white mb-4'>How to use resources</h2>
                <div className='grid grid-cols-1 md:grid-cols-2 gap-8'>
                    <div>
                        <h3 className='text-lg font-semibold text-white mb-2'>Adding to an existing server</h3>
                        <p className='text-gray-400'>
                            If you have a server that is already deployed, you can add resources to it by going to the
                            &apos;edit&apos; tab.
                        </p>
                    </div>
                    <div>
                        <h3 className='text-lg font-semibold text-white mb-2'>Adding to a new server</h3>
                        <p className='text-gray-400'>
                            You can buy resources and add them to a new server in the server creation page, which you
                            can access via the store.
                        </p>
                    </div>
                </div>
            </div>
        </PageContentBlock>
    );
};
</file>

<file path="routes/api-application.php">
<?php

use Illuminate\Support\Facades\Route;
use Jexactyl\Http\Controllers\Api\Application;

/*
|--------------------------------------------------------------------------
| User Controller Routes
|--------------------------------------------------------------------------
|
| Endpoint: /api/application/users
|
*/

Route::group(['prefix' => '/users'], function () {
    Route::get('/', [Application\Users\UserController::class, 'index'])->name('api.application.users');
    Route::get('/{user:id}', [Application\Users\UserController::class, 'view'])->name('api.application.users.view');
    Route::get('/external/{external_id}', [Application\Users\ExternalUserController::class, 'index'])->name('api.application.users.external');
    Route::get('/{user:id}/resources', [Application\Users\UserResourcesController::class, 'view'])->name('api.application.users.view.resources');

    Route::post('/', [Application\Users\UserController::class, 'store']);
    Route::patch('/{user:id}', [Application\Users\UserController::class, 'update']);
    Route::patch('/{user:id}/resources', [Application\Users\UserResourcesController::class, 'update']);

    Route::delete('/{user:id}', [Application\Users\UserController::class, 'delete']);
});

/*
|--------------------------------------------------------------------------
| Approval Routes
|--------------------------------------------------------------------------
|
| Endpoint: /api/application/approvals
|
*/
Route::group(['prefix' => '/approvals'], function () {
    Route::get('/', [Application\ApprovalsController::class, 'view'])->name('api.application.approvals.view');

    Route::post('/deny/{id}', [Application\ApprovalsController::class, 'deny']);
    Route::post('/approve/{id}', [Application\ApprovalsController::class, 'approve']);
});

/*
|--------------------------------------------------------------------------
| Node Controller Routes
|--------------------------------------------------------------------------
|
| Endpoint: /api/application/nodes
|
*/
Route::group(['prefix' => '/nodes'], function () {
    Route::get('/', [Application\Nodes\NodeController::class, 'index'])->name('api.application.nodes');
    Route::get('/deployable', Application\Nodes\NodeDeploymentController::class);
    Route::get('/{node:id}', [Application\Nodes\NodeController::class, 'view'])->name('api.application.nodes.view');
    Route::get('/{node:id}/configuration', Application\Nodes\NodeConfigurationController::class);

    Route::post('/', [Application\Nodes\NodeController::class, 'store']);
    Route::patch('/{node:id}', [Application\Nodes\NodeController::class, 'update']);

    Route::delete('/{node:id}', [Application\Nodes\NodeController::class, 'delete']);

    Route::group(['prefix' => '/{node:id}/allocations'], function () {
        Route::get('/', [Application\Nodes\AllocationController::class, 'index'])->name('api.application.allocations');
        Route::post('/', [Application\Nodes\AllocationController::class, 'store']);
        Route::delete('/{allocation:id}', [Application\Nodes\AllocationController::class, 'delete'])->name('api.application.allocations.view');
    });
});

/*
|--------------------------------------------------------------------------
| Location Controller Routes
|--------------------------------------------------------------------------
|
| Endpoint: /api/application/locations
|
*/
Route::group(['prefix' => '/locations'], function () {
    Route::get('/', [Application\Locations\LocationController::class, 'index'])->name('api.applications.locations');
    Route::get('/{location:id}', [Application\Locations\LocationController::class, 'view'])->name('api.application.locations.view');

    Route::post('/', [Application\Locations\LocationController::class, 'store']);
    Route::patch('/{location:id}', [Application\Locations\LocationController::class, 'update']);

    Route::delete('/{location:id}', [Application\Locations\LocationController::class, 'delete']);
});

/*
|--------------------------------------------------------------------------
| Server Controller Routes
|--------------------------------------------------------------------------
|
| Endpoint: /api/application/servers
|
*/
Route::group(['prefix' => '/servers'], function () {
    Route::get('/', [Application\Servers\ServerController::class, 'index'])->name('api.application.servers');
    Route::get('/{server:id}', [Application\Servers\ServerController::class, 'view'])->name('api.application.servers.view');
    Route::get('/external/{external_id}', [Application\Servers\ExternalServerController::class, 'index'])->name('api.application.servers.external');

    Route::patch('/{server:id}/details', [Application\Servers\ServerDetailsController::class, 'details'])->name('api.application.servers.details');
    Route::patch('/{server:id}/build', [Application\Servers\ServerDetailsController::class, 'build'])->name('api.application.servers.build');
    Route::patch('/{server:id}/startup', [Application\Servers\StartupController::class, 'index'])->name('api.application.servers.startup');

    Route::post('/', [Application\Servers\ServerController::class, 'store']);
    Route::post('/{server:id}/suspend', [Application\Servers\ServerManagementController::class, 'suspend'])->name('api.application.servers.suspend');
    Route::post('/{server:id}/unsuspend', [Application\Servers\ServerManagementController::class, 'unsuspend'])->name('api.application.servers.unsuspend');
    Route::post('/{server:id}/reinstall', [Application\Servers\ServerManagementController::class, 'reinstall'])->name('api.application.servers.reinstall');

    Route::delete('/{server:id}', [Application\Servers\ServerController::class, 'delete']);
    Route::delete('/{server:id}/{force?}', [Application\Servers\ServerController::class, 'delete']);

    // Database Management Endpoint
    Route::group(['prefix' => '/{server:id}/databases'], function () {
        Route::get('/', [Application\Servers\DatabaseController::class, 'index'])->name('api.application.servers.databases');
        Route::get('/{database:id}', [Application\Servers\DatabaseController::class, 'view'])->name('api.application.servers.databases.view');

        Route::post('/', [Application\Servers\DatabaseController::class, 'store']);
        Route::post('/{database:id}/reset-password', [Application\Servers\DatabaseController::class, 'resetPassword']);

        Route::delete('/{database:id}', [Application\Servers\DatabaseController::class, 'delete']);
    });
});

/*
|--------------------------------------------------------------------------
| Nest Controller Routes
|--------------------------------------------------------------------------
|
| Endpoint: /api/application/nests
|
*/
Route::group(['prefix' => '/nests'], function () {
    Route::get('/', [Application\Nests\NestController::class, 'index'])->name('api.application.nests');
    Route::get('/{nest:id}', [Application\Nests\NestController::class, 'view'])->name('api.application.nests.view');

    // Egg Management Endpoint
    Route::group(['prefix' => '/{nest:id}/eggs'], function () {
        Route::get('/', [Application\Nests\EggController::class, 'index'])->name('api.application.nests.eggs');
        Route::get('/{egg:id}', [Application\Nests\EggController::class, 'view'])->name('api.application.nests.eggs.view');
    });
});
</file>

<file path="routes/auth.php">
<?php

use Jexactyl\Http\Controllers\Auth;
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\Auth\GoogleController;

/*
|--------------------------------------------------------------------------
| Authentication Routes
|--------------------------------------------------------------------------
|
| Endpoint: /auth
|
*/

// These routes are defined so that we can continue to reference them programmatically.
// They all route to the same controller function which passes off to React.
Route::get('/login', [Auth\LoginController::class, 'index'])->name('auth.login');
Route::get('/register', [Auth\LoginController::class, 'index'])->name('auth.register');
Route::get('/password', [Auth\LoginController::class, 'index'])->name('auth.forgot-password');
Route::get('/password/reset/{token}', [Auth\LoginController::class, 'index'])->name('auth.reset');

Route::post('/discord/login', [Auth\DiscordController::class, 'index'])->name('auth.discord.login');
Route::get('/discord/callback', [Auth\DiscordController::class, 'callback'])->name('auth.discord.callback');


/*
|--------------------------------------------------------------------------
| Google OAuth Routes
|--------------------------------------------------------------------------
| 2026 Routes for Google OAuth 
*/

Route::get('/google', [Auth\GoogleController::class, 'index'])->name('auth.google.login');
Route::get('/google/callback', [Auth\GoogleController::class, 'callback'])->name('auth.google.callback');

// Apply a throttle to authentication action endpoints, in addition to the
// recaptcha endpoints to slow down manual attack spammers even more. 
//
// @see \Jexactyl\Providers\RouteServiceProvider
Route::middleware(['throttle:authentication'])->group(function () {
    // Login endpoints.
    Route::post('/login', [Auth\LoginController::class, 'login'])->middleware('recaptcha');
    Route::post('/login/checkpoint', Auth\LoginCheckpointController::class)->name('auth.login-checkpoint');

    // Registration endpoints.
    Route::post('/register', [Auth\RegisterController::class, 'register'])->middleware('recaptcha');

    // Forgot password route. A post to this endpoint will trigger an
    // email to be sent containing a reset token.
    Route::post('/password', [Auth\ForgotPasswordController::class, 'sendResetLinkEmail'])
        ->name('auth.post.forgot-password')
        ->middleware('recaptcha');
});

// Password reset routes. This endpoint is hit after going through
// the forgot password routes to acquire a token (or after an account
// is created).
Route::post('/password/reset', Auth\ResetPasswordController::class)->name('auth.reset-password');
Route::get('/verify/{token}', [Auth\VerifyAccountController::class, 'index'])->withoutMiddleware('guest')->name('auth.verify');

// Remove the guest middleware and apply the authenticated middleware to this endpoint,
// so it cannot be used unless you're already logged in.
Route::post('/logout', [Auth\LoginController::class, 'logout'])
    ->withoutMiddleware('guest')
    ->middleware('auth')
    ->name('auth.logout');

// Catch any other combinations of routes and pass them off to the React component.
Route::fallback([Auth\LoginController::class, 'index']);
</file>

<file path=".eslintrc.js">
/** @type {import('eslint').Linter.Config} */
module.exports = {
    parser: '@typescript-eslint/parser',
    parserOptions: {
        ecmaVersion: 6,
        ecmaFeatures: {
            jsx: true,
        },
        project: './tsconfig.json',
        tsconfigRootDir: './',
    },
    settings: {
        react: {
            pragma: 'React',
            version: 'detect',
        },
        linkComponents: [
            { name: 'Link', linkAttribute: 'to' },
            { name: 'NavLink', linkAttribute: 'to' },
        ],
    },
    env: {
        browser: true,
        es6: true,
    },
    plugins: ['react', 'react-hooks', 'prettier', '@typescript-eslint'],
    extends: [
        // 'standard',
        'eslint:recommended',
        'plugin:react/recommended',
        'plugin:@typescript-eslint/recommended',
        'plugin:jest-dom/recommended',
    ],
    rules: {
        eqeqeq: 'error',
        'prettier/prettier': ['error', {}, { usePrettierrc: true }],
        // TypeScript can infer this significantly better than eslint ever can.
        'react/prop-types': 0,
        'react/display-name': 0,
        '@typescript-eslint/no-explicit-any': 0,
        '@typescript-eslint/no-non-null-assertion': 0,
        // This setup is required to avoid a spam of errors when running eslint about React being
        // used before it is defined.
        //
        // @see https://github.com/typescript-eslint/typescript-eslint/blob/master/packages/eslint-plugin/docs/rules/no-use-before-define.md#how-to-use
        'no-use-before-define': 0,
        '@typescript-eslint/no-use-before-define': 'warn',
        // '@typescript-eslint/no-unused-vars': ['warn', { argsIgnorePattern: '^_', varsIgnorePattern: '^_' }],
        '@typescript-eslint/ban-ts-comment': ['error', { 'ts-expect-error': 'allow-with-description' }],
    },
};
</file>

<file path=".gitignore">
/vendor
*.DS_Store*
!.env.ci
!.env.example
.env*
.vagrant/*
.vscode/*
storage/framework/*
/.idea
/nbproject
/.direnv
node_modules
*.log
_ide_helper.php
_ide_helper_models.php
.phpstorm.meta.php
.yarn
public/assets/manifest.json
.dockerignore
docker-compose.yml
misc
.php-cs-fixer.cache
coverage.xml
resources/lang/locales.js
.phpunit.result.cache

/public/build
/public/hot
result
docker-compose.yaml
.env
.env.*
storage/logs/*
storage/framework/sessions/*
storage/framework/cache/*
storage/app/public/*
node_modules/
vendor/
*.log
database/*.sqlite
public/hot
bootstrap/cache/*
/var/www/jexactyl/storage/framework
</file>

<file path="composer.json">
{
    "name": "jexactyl/jexactyl",
    "description": "A fast, advanced and customisable game management panel and billing system in one. ",
    "license": "MIT",
    "require": {
        "php": "^8.0.2 || ^8.1 || ^8.2",
        "ext-json": "*",
        "ext-mbstring": "*",
        "ext-pdo": "*",
        "ext-pdo_mysql": "*",
        "ext-posix": "*",
        "ext-zip": "*",
        "aws/aws-sdk-php": "~3.238.2",
        "doctrine/dbal": "~3.4.5",
        "guzzlehttp/guzzle": "~7.5.0",
        "hashids/hashids": "~4.1.0",
        "laracasts/utilities": "~3.2.1",
        "laravel/framework": "^9.34.0",
        "laravel/helpers": "~1.5.0",
        "laravel/sanctum": "~2.15.1",
        "laravel/socialite": "^5.24",
        "laravel/tinker": "~2.7.2",
        "laravel/ui": "~3.4.6",
        "lcobucci/jwt": "~4.2.1",
        "league/flysystem-aws-s3-v3": "~3.5.0",
        "league/flysystem-memory": "~3.3.0",
        "matriphe/iso-639": "~1.2",
        "paypal/paypal-checkout-sdk": "^1.0",
        "phpseclib/phpseclib": "~3.0",
        "pragmarx/google2fa": "~5.0.0",
        "predis/predis": "~2.0.2",
        "prologue/alerts": "~1.0.0",
        "psr/cache": "~3.0.0",
        "s1lentium/iptools": "~1.1.1",
        "spatie/laravel-fractal": "~6.0.2",
        "spatie/laravel-query-builder": "~5.0.3",
        "staudenmeir/belongs-to-through": "~2.12.1",
        "stripe/stripe-php": "^8.7",
        "symfony/http-client": "~6.0",
        "symfony/mailgun-mailer": "~6.0",
        "symfony/postmark-mailer": "~6.0",
        "symfony/yaml": "~5.4",
        "webmozart/assert": "~1.11"
    },
    "require-dev": {
        "barryvdh/laravel-ide-helper": "~2.12.3",
        "fakerphp/faker": "~1.20",
        "friendsofphp/php-cs-fixer": "~3.11",
        "itsgoingd/clockwork": "~5.1",
        "laravel/sail": "~1.16",
        "mockery/mockery": "~1.5",
        "nunomaduro/collision": "~6.3",
        "php-mock/php-mock-phpunit": "~2.6",
        "phpunit/phpunit": "~9.5",
        "spatie/laravel-ignition": "~1.5"
    },
    "autoload": {
        "files": [
            "app/helpers.php"
        ],
        "psr-4": {
            "Jexactyl\\": "app/",
            "Database\\Factories\\": "database/Factories/",
            "Database\\Seeders\\": "database/Seeders/"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "Jexactyl\\Tests\\": "tests/"
        }
    },
    "scripts": {
        "cs:fix": "php-cs-fixer fix",
        "cs:check": "php-cs-fixer fix --dry-run --diff --verbose",
        "post-root-package-install": [
            "@php -r \"file_exists('.env') || copy('.env.example', '.env');\""
        ],
        "post-create-project-cmd": [
            "@php artisan key:generate --force"
        ],
        "post-autoload-dump": [
            "Illuminate\\Foundation\\ComposerScripts::postAutoloadDump",
            "@php artisan package:discover || true"
        ]
    },
    "prefer-stable": true,
    "config": {
        "optimize-autoloader": true,
        "preferred-install": "dist",
        "sort-packages": true,
        "platform": {
            "php": "8.0.2"
        }
    }
}
</file>

<file path="docker-compose.example.yml">
version: '3.8'
x-common:
    database: &db-environment
        # Do not remove the "&db-password" from the end of the line below, it is important
        # for Panel functionality.
        MYSQL_USER: &db-user 'jexactyl'
        MYSQL_PASSWORD: &db-password 'CHANGE_ME'
        MYSQL_ROOT_PASSWORD: 'CHANGE_ME_TOO'
    panel: &panel-environment
        APP_URL: 'http://example.com'
        # A list of valid timezones can be found here: http://php.net/manual/en/timezones.php
        APP_TIMEZONE: 'UTC'
        APP_SERVICE_AUTHOR: 'noreply@example.com'
        # Uncomment the line below and set to a non-empty value if you want to use Let's Encrypt
        # to generate an SSL certificate for the Panel.
        # LE_EMAIL: ""
    mail: &mail-environment
        MAIL_FROM: 'noreply@example.com'
        MAIL_DRIVER: 'smtp'
        MAIL_HOST: 'mail'
        MAIL_PORT: '1025'
        MAIL_USERNAME: ''
        MAIL_PASSWORD: ''
        MAIL_ENCRYPTION: 'true'

#
# ------------------------------------------------------------------------------------------
# DANGER ZONE BELOW
#
# The remainder of this file likely does not need to be changed. Please only make modifications
# below if you understand what you are doing.
#
services:
    database:
        image: mariadb:10.5
        restart: always
        command: --default-authentication-plugin=mysql_native_password
        volumes:
            - '/srv/jexactyl/database:/var/lib/mysql'
        environment:
            <<: *db-environment
            MYSQL_DATABASE: 'panel'
            MYSQL_USER: *db-user
    cache:
        image: redis:alpine
        restart: always
    panel:
        #image: ghcr.io/jexactyl/jexactyl:latest
        build:
            context: .
            dockerfile: Dockerfile
        restart: always
        ports:
            - '80:80'
            - '443:443'
        links:
            - database
            - cache
        volumes:
            - '/srv/jexactyl/var/:/app/var/'
            - '/srv/jexactyl/nginx/:/etc/nginx/http.d/'
            - '/srv/jexactyl/certs/:/etc/letsencrypt/'
            - '/srv/jexactyl/logs/:/app/storage/logs'
        environment:
            <<: [*panel-environment, *mail-environment]
            DB_PASSWORD: *db-password
            APP_ENV: 'production'
            APP_ENVIRONMENT_ONLY: 'false'
            CACHE_DRIVER: 'redis'
            SESSION_DRIVER: 'redis'
            QUEUE_DRIVER: 'redis'
            REDIS_HOST: 'cache'
            DB_HOST: 'database'
            DB_PORT: '3306'
            DB_USERNAME: *db-user
networks:
    default:
        ipam:
            config:
                - subnet: 172.20.0.0/16
</file>

<file path="package.json">
{
    "name": "jexactyl",
    "engines": {
        "node": ">=16"
    },
    "dependencies": {
        "@floating-ui/react-dom-interactions": "^0.6.6",
        "@fortawesome/fontawesome-svg-core": "^1.2.32",
        "@fortawesome/free-solid-svg-icons": "^5.15.1",
        "@fortawesome/react-fontawesome": "^0.1.11",
        "@headlessui/react": "^1.6.4",
        "@heroicons/react": "^1.0.6",
        "@hot-loader/react-dom": "^16.14.0",
        "@preact/signals-react": "^1.2.1",
        "@tailwindcss/forms": "^0.5.2",
        "@tailwindcss/line-clamp": "^0.4.0",
        "axios": "^0.30.0",
        "boring-avatars": "^1.7.0",
        "chart.js": "^3.8.0",
        "classnames": "^2.3.1",
        "codemirror": "^5.57.0",
        "copy-to-clipboard": "^3.3.1",
        "date-fns": "^2.28.0",
        "debounce": "^1.2.0",
        "deepmerge-ts": "^4.2.1",
        "easy-peasy": "^4.0.1",
        "events": "^3.0.0",
        "formik": "^2.2.6",
        "framer-motion": "^6.3.10",
        "i18next": "^21.8.9",
        "i18next-http-backend": "^1.4.1",
        "i18next-multiload-backend-adapter": "^1.0.0",
        "lucide-react": "^0.552.0",
        "qrcode.react": "^1.0.1",
        "query-string": "^7.1.1",
        "react": "^16.14.0",
        "react-chartjs-2": "^4.2.0",
        "react-dom": "npm:@hot-loader/react-dom",
        "react-fast-compare": "^3.2.0",
        "react-feather": "^2.0.9",
        "react-google-recaptcha": "^2.0.1",
        "react-hot-loader": "^4.12.21",
        "react-i18next": "^11.2.1",
        "react-router-dom": "^5.1.2",
        "react-transition-group": "^4.4.1",
        "reaptcha": "^1.7.2",
        "sockette": "^2.0.6",
        "strip-ansi": "^7.0.1",
        "styled-components": "^5.2.1",
        "styled-components-breakpoint": "^3.0.0-preview.20",
        "swr": "^0.2.3",
        "tailwindcss": "^3.0.24",
        "use-fit-text": "^2.4.0",
        "uuid": "^8.3.2",
        "xterm": "^4.19.0",
        "xterm-addon-fit": "^0.5.0",
        "xterm-addon-search": "^0.9.0",
        "xterm-addon-search-bar": "^0.2.0",
        "xterm-addon-web-links": "^0.6.0",
        "yup": "^0.29.1"
    },
    "devDependencies": {
        "@babel/core": "^7.12.1",
        "@babel/plugin-proposal-class-properties": "^7.12.1",
        "@babel/plugin-proposal-nullish-coalescing-operator": "^7.12.1",
        "@babel/plugin-proposal-object-rest-spread": "^7.12.1",
        "@babel/plugin-proposal-optional-chaining": "^7.12.1",
        "@babel/plugin-syntax-dynamic-import": "^7.8.3",
        "@babel/plugin-transform-modules-commonjs": "^7.18.2",
        "@babel/plugin-transform-react-jsx": "^7.12.1",
        "@babel/plugin-transform-runtime": "^7.12.1",
        "@babel/preset-env": "^7.12.1",
        "@babel/preset-react": "^7.12.1",
        "@babel/preset-typescript": "^7.12.1",
        "@babel/runtime": "^7.26.10",
        "@testing-library/dom": "^8.14.0",
        "@testing-library/jest-dom": "^5.16.4",
        "@testing-library/react": "12.1.5",
        "@testing-library/user-event": "^14.2.1",
        "@types/codemirror": "^0.0.98",
        "@types/debounce": "^1.2.0",
        "@types/events": "^3.0.0",
        "@types/jest": "^28.1.3",
        "@types/node": "^14.11.10",
        "@types/qrcode.react": "^1.0.1",
        "@types/react": "^16.14.0",
        "@types/react-copy-to-clipboard": "^4.3.0",
        "@types/react-dom": "^16.9.16",
        "@types/react-redux": "^7.1.1",
        "@types/react-router": "^5.1.3",
        "@types/react-router-dom": "^5.1.3",
        "@types/react-transition-group": "^4.4.0",
        "@types/styled-components": "^5.1.7",
        "@types/uuid": "^3.4.5",
        "@types/webpack-env": "^1.15.2",
        "@types/yup": "^0.29.3",
        "@typescript-eslint/eslint-plugin": "^5.29.0",
        "@typescript-eslint/parser": "^5.29.0",
        "autoprefixer": "^10.4.7",
        "babel-jest": "^28.1.1",
        "babel-loader": "^8.2.5",
        "babel-plugin-styled-components": "^2.0.7",
        "cross-env": "^7.0.2",
        "css-loader": "^5.2.7",
        "eslint": "^8.18.0",
        "eslint-config-prettier": "^8.5.0",
        "eslint-plugin-jest-dom": "^4.0.2",
        "eslint-plugin-node": "^11.1.0",
        "eslint-plugin-prettier": "^4.0.0",
        "eslint-plugin-react": "^7.30.1",
        "eslint-plugin-react-hooks": "^4.6.0",
        "fork-ts-checker-webpack-plugin": "^6.2.10",
        "identity-obj-proxy": "^3.0.0",
        "jest": "^28.1.1",
        "postcss": "^8.4.31",
        "postcss-import": "^14.1.0",
        "postcss-loader": "^4.0.0",
        "postcss-nesting": "^10.1.8",
        "postcss-preset-env": "^7.7.1",
        "prettier": "^2.7.1",
        "redux-devtools-extension": "^2.13.8",
        "source-map-loader": "^1.1.3",
        "style-loader": "^2.0.0",
        "svg-url-loader": "^7.1.1",
        "terser-webpack-plugin": "^4.2.3",
        "ts-essentials": "^9.1.2",
        "ts-jest": "^28.0.5",
        "twin.macro": "^2.8.2",
        "typescript": "^4.7.3",
        "webpack": "^4.43.0",
        "webpack-assets-manifest": "^3.1.1",
        "webpack-bundle-analyzer": "^3.8.0",
        "webpack-cli": "^3.3.12",
        "webpack-dev-server": "^3.11.0",
        "yarn-deduplicate": "^1.1.1"
    },
    "scripts": {
        "clean": "cd public/assets && find . \\( -name \"*.js\" -o -name \"*.map\" \\) -type f -delete",
        "test": "jest",
        "lint": "eslint ./resources/scripts/**/*.{ts,tsx} --ext .ts,.tsx",
        "watch": "cross-env NODE_ENV=development ./node_modules/.bin/webpack --watch --progress --hot",
        "build": "cross-env NODE_ENV=development ./node_modules/.bin/webpack --progress",
        "build:production": "yarn run clean && cross-env NODE_ENV=production ./node_modules/.bin/webpack --mode production",
        "serve": "yarn run clean && cross-env WEBPACK_PUBLIC_PATH=/webpack@hmr/ NODE_ENV=development webpack-dev-server --host 0.0.0.0 --port 5050 --public http://209.74.83.71 --hot"
    },
    "browserslist": [
        "> 0.5%",
        "last 2 versions",
        "firefox esr",
        "not dead"
    ],
    "babelMacros": {
        "twin": {
            "preset": "styled-components"
        },
        "styledComponents": {
            "pure": true,
            "displayName": true,
            "fileName": true
        }
    }
}
</file>

<file path="tailwind.config.js">
const { blue, zinc, cyan } = require('tailwindcss/colors');

module.exports = {
    content: ['./resources/scripts/**/*.{js,ts,tsx}'],
    theme: {
        extend: {
            backgroundImage: {
                storeone:
                    "url('https://cdn.vervecustoms.com/icons/jexpanel/ilya-pavlov-OqtafYT5kTw-unsplash.jpg')",
                storetwo:
                    "url('https://cdn.vervecustoms.com/icons/jexpanel/scott-rodgerson-PSpf_XgOM5w-unsplash.jpg')",
                storethree:
                    "url('https://raw.githubusercontent.com/IcecreamplayzYT/verve-cdn/refs/heads/main/albert-stoynov-dyUp7WPu5q4-unsplash.jpg?token=GHSAT0AAAAAADQZ3HBQRGLV7MIYBOZRGH6A2K6SCVA')",
            },
            colors: {
                black: '#000',
                // "primary" and "neutral" are deprecated.
                primary: blue,
                neutral: zinc,

                // Use cyan / gray instead.
                gray: zinc,
                cyan: cyan,
            },
            fontSize: {
                '2xs': '0.625rem',
            },
            transitionDuration: {
                250: '250ms',
            },
            borderColor: (theme) => ({
                default: theme('colors.neutral.400', 'currentColor'),
            }),
        },
    },
    plugins: [
        require('@tailwindcss/line-clamp'),
        require('@tailwindcss/forms')({
            strategy: 'class',
        }),
    ],
};
</file>

<file path="webpack.config.js">
const path = require('path');
const webpack = require('webpack');
const AssetsManifestPlugin = require('webpack-assets-manifest');
const ForkTsCheckerWebpackPlugin = require('fork-ts-checker-webpack-plugin');
const TerserPlugin = require('terser-webpack-plugin');
const BundleAnalyzerPlugin = require('webpack-bundle-analyzer').BundleAnalyzerPlugin;

const isProduction = process.env.NODE_ENV === 'production';

module.exports = {
    cache: true,
    target: 'web',
    mode: process.env.NODE_ENV,
    devtool: isProduction ? false : (process.env.DEVTOOL || 'eval-source-map'),
    performance: {
        hints: false,
    },
    entry: ['react-hot-loader/patch', './resources/scripts/index.tsx'],
    output: {
        path: path.join(__dirname, '/public/assets'),
        filename: isProduction ? 'bundle.[chunkhash:8].js' : 'bundle.[hash:8].js',
        chunkFilename: isProduction ? '[name].[chunkhash:8].js' : '[name].[hash:8].js',
        publicPath: (process.env.WEBPACK_PUBLIC_PATH || '/assets/'),
        crossOriginLoading: 'anonymous',
    },
    module: {
        rules: [
            {
                test: /\.tsx?$/,
                exclude: /node_modules|\.spec\.tsx?$/,
                loader: 'babel-loader',
            },
            {
                test: /\.mjs$/,
                include: /node_modules/,
                type: 'javascript/auto',
            },
            {
                test: /\.css$/,
                use: [
                    { loader: 'style-loader' },
                    {
                        loader: 'css-loader',
                        options: {
                            modules: {
                                auto: true,
                                localIdentName: isProduction ? '[name]_[hash:base64:8]' : '[path][name]__[local]',
                                localIdentContext: path.join(__dirname, 'resources/scripts/components'),
                            },
                            sourceMap: !isProduction,
                            importLoaders: 1,
                        },
                    },
                    {
                        loader: 'postcss-loader',
                        options: { sourceMap: !isProduction },
                    },
                ],
            },
            {
                test: /\.(png|jp(e?)g|gif)$/,
                loader: 'file-loader',
                options: {
                    name: 'images/[name].[hash:8].[ext]',
                },
            },
            {
                test: /\.svg$/,
                loader: 'svg-url-loader',
            },
            {
                test: /\.js$/,
                enforce: 'pre',
                loader: 'source-map-loader',
            }
        ],
    },
    stats: {
        // Ignore warnings emitted by "source-map-loader" when trying to parse source maps from
        // JS plugins we use, namely brace editor.
        warningsFilter: [/Failed to parse source map/],
    },
    resolve: {
        extensions: ['.ts', '.tsx', '.js', '.json'],
        alias: {
            '@': path.join(__dirname, '/resources/scripts'),
            '@definitions': path.join(__dirname, '/resources/scripts/api/definitions'),
            '@feature': path.join(__dirname, '/resources/scripts/components/server/features'),
        },
        symlinks: false,
    },
    externals: {
        // Mark moment as an external to exclude it from the Chart.js build since we don't need to use
        // it for anything.
        moment: 'moment',
    },
    plugins: [
        new webpack.EnvironmentPlugin({
            NODE_ENV: 'development',
            DEBUG: process.env.NODE_ENV !== 'production',
            WEBPACK_BUILD_HASH: Date.now().toString(16),
        }),
        new AssetsManifestPlugin({ writeToDisk: true, publicPath: true, integrity: true, integrityHashes: ['sha384'] }),
        new ForkTsCheckerWebpackPlugin({
            typescript: {
                mode: 'write-references',
                diagnosticOptions: {
                    semantic: true,
                    syntactic: true,
                },
            },
            eslint: isProduction ? undefined : {
                files: `${path.join(__dirname, '/resources/scripts')}/**/*.{ts,tsx}`,
            }
        }),
        process.env.ANALYZE_BUNDLE ? new BundleAnalyzerPlugin({
            analyzerHost: '0.0.0.0',
            analyzerPort: 8081,
        }) : null
    ].filter(p => p),
    optimization: {
        usedExports: true,
        sideEffects: false,
        runtimeChunk: false,
        removeEmptyChunks: true,
        minimize: isProduction,
        minimizer: [
            new TerserPlugin({
                cache: isProduction,
                parallel: true,
                extractComments: false,
                terserOptions: {
                    mangle: true,
                    output: {
                        comments: false,
                    },
                },
            }),
        ],
    },
    watchOptions: {
        poll: 1000,
        ignored: /node_modules/,
    },
    devServer: {
        compress: true,
        contentBase: path.join(__dirname, '/public'),
        publicPath: process.env.WEBPACK_PUBLIC_PATH || '/assets/',
        allowedHosts: [
            '.jexactyl.test',
        ],
        headers: {
            'Access-Control-Allow-Origin': '*',
        },
    },
};
</file>

<file path="app/Providers/RouteServiceProvider.php">
<?php

namespace Jexactyl\Providers;

use Illuminate\Http\Request;
use Jexactyl\Models\Database;
use Illuminate\Support\Facades\Route;
use Illuminate\Cache\RateLimiting\Limit;
use Jexactyl\Http\Middleware\TrimStrings;
use Illuminate\Support\Facades\RateLimiter;
use Jexactyl\Http\Middleware\AdminAuthenticate;
use Jexactyl\Http\Middleware\RequireTwoFactorAuthentication;
use Illuminate\Foundation\Support\Providers\RouteServiceProvider as ServiceProvider;

class RouteServiceProvider extends ServiceProvider
{
    protected const FILE_PATH_REGEX = '/^\/api\/client\/servers\/([a-z0-9-]{36})\/files(\/?$|\/(.)*$)/i';

    /**
     * Define your route model bindings, pattern filters, etc.
     */
    public function boot()
    {
        $this->configureRateLimiting();

        // Disable trimming string values when requesting file information  it isn't helpful
        // and messes up the ability to actually open a directory that ends with a space.
        TrimStrings::skipWhen(function (Request $request) {
            return preg_match(self::FILE_PATH_REGEX, $request->getPathInfo()) === 1;
        });

        // This is needed to make use of the "resolveRouteBinding" functionality in the
        // model. Without it you'll never trigger that logic flow thus resulting in a 404
        // error because we request databases with a HashID, and not with a normal ID.
        Route::model('database', Database::class);

        $this->routes(function () {


            Route::middleware('web')->group(function () {
                Route::middleware(['auth.session', RequireTwoFactorAuthentication::class])
                    ->group(base_path('routes/base.php'));

                Route::middleware(['auth.session', RequireTwoFactorAuthentication::class, AdminAuthenticate::class])
                    ->prefix('/admin')
                    ->group(base_path('routes/admin.php'));

                Route::middleware('guest')->prefix('/auth')->group(base_path('routes/auth.php'));
            });

            Route::middleware(['api', RequireTwoFactorAuthentication::class])->group(function () {
                Route::middleware(['application-api', 'throttle:api.application'])
                    ->prefix('/api/application')
                    ->scopeBindings()
                    ->group(base_path('routes/api-application.php'));

                Route::middleware(['client-api', 'throttle:api.client'])
                    ->prefix('/api/client')
                    ->scopeBindings()
                    ->group(base_path('routes/api-client.php'));
            });

            Route::middleware('daemon')
                ->prefix('/api/remote')
                ->scopeBindings()
                ->group(base_path('routes/api-remote.php'));

        });
    }

    /**
     * Configure the rate limiters for the application.
     */
    protected function configureRateLimiting()
    {
        // Authentication rate limiting. For login and checkpoint endpoints we'll apply
        // a limit of 10 requests per minute, for the forgot password endpoint apply a
        // limit of two per minute for the requester so that there is less ability to
        // trigger email spam.
        RateLimiter::for('authentication', function (Request $request) {
            if ($request->route()->named('auth.post.forgot-password')) {
                return Limit::perMinute(2)->by($request->ip());
            }

            return Limit::perMinute(10);
        });

        // Store & Server Creation rate limiting. Stops users from abusing the endpoint(s)
        // associated with creating/deleting servers as well as resources via Storefront.
        RateLimiter::for('storefront', function (Request $request) {
            return Limit::perMinute(1)->by($request->user()->id);
        });

        // Credit earning ratelimiting.
        RateLimiter::for('earn', function (Request $request) {
            return Limit::perMinute(1)->by($request->user()->id);
        });

        // Stops users from renewing or editing servers many times in quick succession.
        RateLimiter::for('server-edit', function (Request $request) {
            return Limit::perMinute(5)->by($request->user()->id);
        });

        // Configure the throttles for both the application and client APIs below.
        // This is configurable per-instance in "config/http.php". By default this
        // limiter will be tied to the specific request user, and falls back to the
        // request IP if there is no request user present for the key.
        //
        // This means that an authenticated API user cannot use IP switching to get
        // around the limits.
        RateLimiter::for('api.client', function (Request $request) {
            $key = optional($request->user())->uuid ?: $request->ip();

            return Limit::perMinutes(
                config('http.rate_limit.client_period'),
                config('http.rate_limit.client')
            )->by($key);
        });

        RateLimiter::for('api.application', function (Request $request) {
            $key = optional($request->user())->uuid ?: $request->ip();

            return Limit::perMinutes(
                config('http.rate_limit.application_period'),
                config('http.rate_limit.application')
            )->by($key);
        });
    }
}
</file>

<file path="config/logging.php">
<?php

use Monolog\Handler\NullHandler;
use Monolog\Handler\StreamHandler;
use Monolog\Handler\SyslogUdpHandler;

return [
    /*
    |--------------------------------------------------------------------------
    | Default Log Channel
    |--------------------------------------------------------------------------
    |
    | This option defines the default log channel that gets used when writing
    | messages to the logs. The name specified in this option should match
    | one of the channels defined in the "channels" configuration array.
    |
    */

    'default' => env('LOG_CHANNEL', 'daily'),

    /*
    |--------------------------------------------------------------------------
    | Deprecations Log Channel
    |--------------------------------------------------------------------------
    |
    | This option controls the log channel that should be used to log warnings
    | regarding deprecated PHP and library features. This allows you to get
    | your application ready for upcoming major versions of dependencies.
    |
    */

    'deprecations' => [
        'channel' => env('LOG_DEPRECATIONS_CHANNEL', 'null'),
        'trace' => false,
    ],

    /*
    |--------------------------------------------------------------------------
    | Log Channels
    |--------------------------------------------------------------------------
    |
    | Here you may configure the log channels for your application. Out of
    | the box, Laravel uses the Monolog PHP logging library. This gives
    | you a variety of powerful log handlers / formatters to utilize.
    |
    | Available Drivers: "single", "daily", "slack", "syslog",
    |                    "errorlog", "monolog",
    |                    "custom", "stack"
    |
    */

    'channels' => [
        'stack' => [
            'driver' => 'stack',
            'channels' => ['single'],
            'ignore_exceptions' => false,
        ],

        'single' => [
            'driver' => 'single',
            'path' => storage_path('logs/laravel.log'),
            'level' => env('LOG_LEVEL', 'debug'),
        ],

        'daily' => [
            'driver' => 'daily',
            'path' => storage_path('logs/laravel.log'),
            'level' => env('LOG_LEVEL', 'debug'),
            'days' => 7,
        ],

        'slack' => [
            'driver' => 'slack',
            'url' => env('LOG_SLACK_WEBHOOK_URL'),
            'username' => 'Laravel Log',
            'emoji' => ':boom:',
            'level' => env('LOG_LEVEL', 'critical'),
        ],

        'papertrail' => [
            'driver' => 'monolog',
            'level' => env('LOG_LEVEL', 'debug'),
            'handler' => env('LOG_PAPERTRAIL_HANDLER', SyslogUdpHandler::class),
            'handler_with' => [
                'host' => env('PAPERTRAIL_URL'),
                'port' => env('PAPERTRAIL_PORT'),
                'connectionString' => 'tls://' . env('PAPERTRAIL_URL') . ':' . env('PAPERTRAIL_PORT'),
            ],
        ],

        'stderr' => [
            'driver' => 'monolog',
            'level' => env('LOG_LEVEL', 'debug'),
            'handler' => StreamHandler::class,
            'formatter' => env('LOG_STDERR_FORMATTER'),
            'with' => [
                'stream' => 'php://stderr',
            ],
        ],

        'syslog' => [
            'driver' => 'syslog',
            'level' => env('LOG_LEVEL', 'debug'),
        ],

        'errorlog' => [
            'driver' => 'errorlog',
            'level' => env('LOG_LEVEL', 'debug'),
        ],

        'null' => [
            'driver' => 'monolog',
            'handler' => NullHandler::class,
        ],

        'emergency' => [
            'path' => storage_path('logs/laravel.log'),
        ],
    ],
];
</file>

<file path="config/services.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Third Party Services
    |--------------------------------------------------------------------------
    |
    | This file is for storing the credentials for third party services such
    | as Mailgun, Postmark, AWS and more. This file provides the de facto
    | location for this type of information, allowing packages to have
    | a conventional file to locate the various service credentials.
    |
    */

    'mailgun' => [
        'domain' => env('MAILGUN_DOMAIN'),
        'secret' => env('MAILGUN_SECRET'),
        'endpoint' => env('MAILGUN_ENDPOINT', 'api.mailgun.net'),
        'scheme' => 'https',
    ],

    'postmark' => [
        'token' => env('POSTMARK_TOKEN'),
    ],

    'ses' => [
        'key' => env('AWS_ACCESS_KEY_ID'),
        'secret' => env('AWS_SECRET_ACCESS_KEY'),
        'region' => env('AWS_DEFAULT_REGION', 'us-east-1'),
    ],
    
    'google' => [
    'client_id' => env('GOOGLE_CLIENT_ID'),
    'client_secret' => env('GOOGLE_CLIENT_SECRET'),
    'redirect' => env('GOOGLE_REDIRECT_URI'),
    ],
];
</file>

<file path="resources/scripts/components/auth/DiscordContainer.tsx">
import tw from 'twin.macro';
import React, { useState } from 'react';
import { Link } from 'react-router-dom';
import useFlash from '@/plugins/useFlash';
import discordLogin from '@/api/auth/discord';
import { Button } from '@/components/elements/button/index';
import DiscordFormContainer from '@/components/auth/DiscordFormContainer';

const DiscordContainer = () => {
    const { clearFlashes, clearAndAddHttpError } = useFlash();
    const [loading, setLoading] = useState(false);
    const [googleLoading, setGoogleLoading] = useState(false);


    const login = () => {
        clearFlashes();
        setLoading(true);

        discordLogin()
            .then((data) => {
                if (!data) return clearAndAddHttpError({ error: 'Discord auth failed. Please try again.' });
                window.location.href = data;
            })
            .then(() => setLoading(false))
            .catch((error) => {
                console.error(error);
                setLoading(false);
                clearAndAddHttpError({ error });
            });
    };

    const handleGoogleLogin = () => {
        clearFlashes();
        setGoogleLoading(true);
        
        // Simple redirect to your backend route
        // Your backend will handle the OAuth redirect
        window.location.href = '/auth/google';
    };

    return (
        <DiscordFormContainer>
            <div css={tw`flex flex-col items-center`}>
                <div css={tw`mb-6`}>
                    <img 
                        src={'/assets/svgs/discord.svg'} 
                        css={tw`w-32 h-32`} 
                        alt="Discord"
                    />
                </div>
                
                <h3 css={tw`text-xl text-white font-semibold mb-2 text-center`}>
                    Connect with Discord
                </h3>
                <p css={tw`text-gray-400 text-sm text-center mb-6`}>
                    Sign in using your Discord account
                </p>

                <div css={tw`w-full space-y-4`}>
                    <button
                        type="button"
                        onClick={login}
                        disabled={loading}
                        css={tw`flex items-center justify-center w-full px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors border border-indigo-500 font-medium`}
                    >
                        <img 
                            src="/assets/svgs/discord.svg" 
                            alt="Discord" 
                            css={tw`w-5 h-5 mr-2`}
                        />
                        <span>{loading ? 'Connecting...' : 'Connect with Discord'}</span>
                    </button>

                    <button
                        type="button"
                        onClick={handleGoogleLogin}
                        disabled={googleLoading}
                        css={tw`flex items-center justify-center px-4 py-3 bg-gray-900 hover:bg-gray-700 text-white rounded-lg transition-colors border border-gray-700 disabled:opacity-50 disabled:cursor-not-allowed`}
                    >
                        <svg css={tw`w-5 h-5 mr-2`} viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        <span css={tw`font-medium text-sm`}>
                            {googleLoading ? 'Loading...' : 'Google'}
                        </span>
                    </button>
                </div>

                <div css={tw`mt-6 text-center w-full`}>
                    <Link
                        to={'/auth/login'}
                        css={tw`text-sm text-gray-400 hover:text-blue-400 transition-colors`}
                    >
                        Return to login
                    </Link>
                </div>
            </div>
        </DiscordFormContainer>
    );
};

export default DiscordContainer;
</file>

<file path="resources/scripts/components/auth/ForgotPasswordContainer.tsx">
import tw from 'twin.macro';
import * as React from 'react';
import Reaptcha from 'reaptcha';
import { object, string } from 'yup';
import { Link } from 'react-router-dom';
import useFlash from '@/plugins/useFlash';
import { useStoreState } from 'easy-peasy';
import { httpErrorToHuman } from '@/api/http';
import { Formik, FormikHelpers } from 'formik';
import Field from '@/components/elements/Field';
import { useEffect, useRef, useState } from 'react';
import { Button } from '@/components/elements/button/index';
import LoginFormContainer from '@/components/auth/LoginFormContainer';
import requestPasswordResetEmail from '@/api/auth/requestPasswordResetEmail';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import { faEye } from '@fortawesome/free-solid-svg-icons';
import discordLogin from '@/api/auth/discord';

interface Values {
    email: string;
}

export default () => {
    const ref = useRef<Reaptcha>(null);
    const [token, setToken] = useState('');
    const [discordLoading, setDiscordLoading] = useState(false);
    const [googleLoading, setGoogleLoading] = useState(false);

    const { clearFlashes, addFlash, clearAndAddHttpError } = useFlash();
    const { enabled: recaptchaEnabled, siteKey } = useStoreState((state) => state.settings.data!.recaptcha);
    
    // Easy to swap between env and state
    const siteName = process.env.REACT_APP_SITE_NAME || 'NeoDesigns Hosting';
    // const siteName = useStoreState((state) => state.settings.data?.name) || 'NeoDesigns Hosting';
    
    const discord = useStoreState((state) => state.settings.data?.registration.discord);

    useEffect(() => {
        clearFlashes();
    }, []);
    
    const handleGoogleLogin = () => {
        clearFlashes();
        setGoogleLoading(true);
        
        // Simple redirect to your backend route
        // Your backend will handle the OAuth redirect
        window.location.href = '/auth/google';
    };

    const handleDiscordLogin = () => {
        clearFlashes();
        setDiscordLoading(true);

        discordLogin()
            .then((data) => {
                if (!data) {
                    clearAndAddHttpError({ error: 'Discord auth failed. Please try again.' });
                    setDiscordLoading(false);
                    return;
                }
                window.location.href = data;
            })
            .catch((error) => {
                console.error(error);
                setDiscordLoading(false);
                clearAndAddHttpError({ error });
            });
    };

    const handleSubmission = ({ email }: Values, { setSubmitting, resetForm }: FormikHelpers<Values>) => {
        clearFlashes();

        if (recaptchaEnabled && !token) {
            ref.current!.execute().catch((error) => {
                console.error(error);
                setSubmitting(false);
                addFlash({ type: 'danger', title: 'Error', message: httpErrorToHuman(error) });
            });
            return;
        }

        requestPasswordResetEmail(email, token)
            .then((response) => {
                resetForm();
                addFlash({ type: 'success', title: 'Success', message: response });
            })
            .catch((error) => {
                console.error(error);
                addFlash({ type: 'danger', title: 'Error', message: httpErrorToHuman(error) });
            })
            .then(() => {
                setToken('');
                if (ref.current) ref.current.reset();
                setSubmitting(false);
            });
    };

    return (
        <Formik
            onSubmit={handleSubmission}
            initialValues={{ email: '' }}
            validationSchema={object().shape({
                email: string()
                    .email('A valid email address must be provided to continue.')
                    .required('A valid email address must be provided to continue.'),
            })}
        >
            {({ isSubmitting, setSubmitting, submitForm }) => (
                <LoginFormContainer 
                    title={siteName} 
                    subtitle="Request password reset"
                >
                    <div css={tw`mb-6`}>
                        <p css={tw`text-sm text-gray-400 text-center`}>
                            Enter your account email address to receive instructions on resetting your password.
                        </p>
                    </div>

                    <div css={tw`mb-6`}>
                        <Field
                            light
                            label={'Email'}
                            name={'email'}
                            type={'email'}
                            placeholder="Enter your email address"
                        />
                    </div>

                    <div css={tw`mt-6`}>
                        <Button 
                            size={Button.Sizes.Large} 
                            css={tw`w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 rounded-lg transition-colors`} 
                            type={'submit'} 
                            disabled={isSubmitting}
                        >
                            {isSubmitting ? 'Sending...' : 'Send Email'}
                        </Button>
                    </div>

                    {recaptchaEnabled && (
                        <Reaptcha
                            ref={ref}
                            size={'invisible'}
                            sitekey={siteKey || '_invalid_key'}
                            onVerify={(response) => {
                                setToken(response);
                                submitForm();
                            }}
                            onExpire={() => {
                                setSubmitting(false);
                                setToken('');
                            }}
                        />
                    )}

                    {discord && (
                        <>
                            <div css={tw`relative my-6`}>
                                <div css={tw`absolute inset-0 flex items-center`}>
                                    <div css={tw`w-full border-t border-gray-600`}></div>
                                </div>
                                <div css={tw`relative flex justify-center text-sm`}>
                                    <span css={tw`px-4 bg-gray-800 text-gray-400 uppercase tracking-wide text-xs`}>
                                        OR CONTINUE WITH
                                    </span>
                                </div>
                            </div>

                            <div css={tw`grid grid-cols-2 gap-4`}>
                                <button
                                    type="button"
                                    onClick={handleDiscordLogin}
                                    disabled={discordLoading}
                                    css={tw`flex items-center justify-center px-4 py-3 bg-gray-900 hover:bg-gray-700 text-white rounded-lg transition-colors border border-gray-700`}
                                >
                                    <img 
                                        src="/assets/svgs/discord.svg" 
                                        alt="Discord" 
                                        css={tw`w-5 h-5 mr-2`}
                                    />
                                    <span css={tw`font-medium text-sm`}>Discord</span>
                                </button>
                                
                                <button
                                    type="button"
                                    onClick={handleGoogleLogin}
                                    disabled={googleLoading}
                                    css={tw`flex items-center justify-center px-4 py-3 bg-gray-900 hover:bg-gray-700 text-white rounded-lg transition-colors border border-gray-700 disabled:opacity-50 disabled:cursor-not-allowed`}
                                >
                                    <svg css={tw`w-5 h-5 mr-2`} viewBox="0 0 24 24">
                                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                    </svg>
                                    <span css={tw`font-medium text-sm`}>
                                        {googleLoading ? 'Loading...' : 'Google'}
                                    </span>
                                </button>
                            </div>
                        </>
                    )}

                    <div css={tw`mt-6 text-center`}>
                        <Link
                            to={'/auth/login'}
                            css={tw`text-sm text-blue-400 hover:text-blue-300 transition-colors`}
                        >
                            Return to Login
                        </Link>
                    </div>
                </LoginFormContainer>
            )}
        </Formik>
    );
};
</file>

<file path="resources/scripts/components/auth/LoginCheckpointContainer.tsx">
import tw from 'twin.macro';
import React, { useState } from 'react';
import useFlash from '@/plugins/useFlash';
import { ActionCreator } from 'easy-peasy';
import { StaticContext } from 'react-router';
import { FlashStore } from '@/state/flashes';
import Field from '@/components/elements/Field';
import { useFormikContext, withFormik } from 'formik';
import loginCheckpoint from '@/api/auth/loginCheckpoint';
import { Button } from '@/components/elements/button/index';
import { Link, RouteComponentProps } from 'react-router-dom';
import LoginFormContainer from '@/components/auth/LoginFormContainer';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import { faEye } from '@fortawesome/free-solid-svg-icons';
import { useStoreState } from 'easy-peasy';

interface Values {
    code: string;
    recoveryCode: '';
}

type OwnProps = RouteComponentProps<Record<string, string | undefined>, StaticContext, { token?: string }>;

type Props = OwnProps & {
    clearAndAddHttpError: ActionCreator<FlashStore['clearAndAddHttpError']['payload']>;
};

const LoginCheckpointContainer = () => {
    const { isSubmitting, setFieldValue } = useFormikContext<Values>();
    const [isMissingDevice, setIsMissingDevice] = useState(false);
    
    // Easy to swap between env and state
    const siteName = process.env.REACT_APP_SITE_NAME || 'NeoDesigns Hosting';
    // const siteName = useStoreState((state) => state.settings.data?.name) || 'NeoDesigns Hosting';

    return (
        <LoginFormContainer 
            title={siteName} 
            subtitle="Two-Factor Authentication"
        >
            <div css={tw`mb-6`}>
                <p css={tw`text-sm text-gray-400 text-center`}>
                    {isMissingDevice
                        ? 'Enter one of your recovery codes to continue.'
                        : 'Enter the authentication code from your device.'}
                </p>
            </div>

            <div css={tw`mb-6`}>
                <Field
                    light
                    name={isMissingDevice ? 'recoveryCode' : 'code'}
                    label={isMissingDevice ? 'Recovery Code' : 'Authentication Code'}
                    type={'text'}
                    autoComplete={'one-time-code'}
                    autoFocus
                    placeholder={isMissingDevice ? 'Enter recovery code' : 'Enter 6-digit code'}
                />
            </div>

            <div css={tw`mt-6`}>
                <Button
                    size={Button.Sizes.Large}
                    css={[
                        tw`w-full font-medium py-3 rounded-lg transition-colors text-white`,
                        isSubmitting ? tw`bg-blue-500 opacity-75 cursor-not-allowed` : tw`bg-blue-500 hover:bg-blue-600`,
                    ]}
                    type={'submit'}
                    disabled={isSubmitting}
                >
                    {isSubmitting ? 'Verifying...' : 'Continue'}
                </Button>
            </div>

            <div css={tw`mt-6 text-center`}>
                <button
                    type="button"
                    onClick={() => {
                        setFieldValue('code', '');
                        setFieldValue('recoveryCode', '');
                        setIsMissingDevice((s) => !s);
                    }}
                    css={tw`text-sm text-gray-400 hover:text-blue-400 transition-colors cursor-pointer`}
                >
                    {!isMissingDevice ? "I've Lost My Device" : 'I Have My Device'}
                </button>
            </div>

            <div css={tw`mt-4 text-center`}>
                <Link
                    to={'/auth/login'}
                    css={tw`text-sm text-blue-400 hover:text-blue-300 transition-colors`}
                >
                    Return to Login
                </Link>
            </div>
        </LoginFormContainer>
    );
};

const EnhancedForm = withFormik<Props, Values>({
    handleSubmit: ({ code, recoveryCode }, { setSubmitting, props: { clearAndAddHttpError, location } }) => {
        loginCheckpoint(location.state?.token || '', code, recoveryCode)
            .then((response) => {
                if (response.complete) {
                    // @ts-expect-error this is valid
                    window.location = response.intended || '/';
                    return;
                }
                setSubmitting(false);
            })
            .catch((error) => {
                console.error(error);
                setSubmitting(false);
                clearAndAddHttpError({ error });
            });
    },

    mapPropsToValues: () => ({
        code: '',
        recoveryCode: '',
    }),
})(LoginCheckpointContainer);

export default ({ history, location, ...props }: OwnProps) => {
    const { clearAndAddHttpError } = useFlash();

    // Try to get token from location state first, fall back to sessionStorage (set by LoginContainer)
    let token: string | undefined = undefined;
    if (location && (location as any).state && (location as any).state.token) {
        token = (location as any).state.token;
    } else if (typeof window !== 'undefined') {
        token = sessionStorage.getItem('checkpointToken') || undefined;
    }

    if (!token) {
        history.replace('/auth/login');
        return null;
    }

    // Ensure location passed to the form contains the token in state so withFormik handler can access it.
    const locationWithState = (location && (location as any).state && (location as any).state.token)
        ? location
        : { ...location, state: { ...(location as any).state, token } };

    // Clear stored token now that it's consumed
    if (typeof window !== 'undefined') {
        try {
            sessionStorage.removeItem('checkpointToken');
        } catch (e) {
            // ignore
        }
    }

    return (
        <EnhancedForm
            clearAndAddHttpError={clearAndAddHttpError}
            history={history}
            location={locationWithState as any}
            {...props}
        />
    );
};
</file>

<file path="resources/scripts/components/auth/RegisterContainer.tsx">
import tw from 'twin.macro';
import Reaptcha from 'reaptcha';
import { object, string } from 'yup';
import useFlash from '@/plugins/useFlash';
import register from '@/api/auth/register';
import { useStoreState } from 'easy-peasy';
import { Formik, FormikHelpers } from 'formik';
import Field from '@/components/elements/Field';
import React, { useEffect, useRef, useState } from 'react';
import { Button } from '@/components/elements/button/index';
import { Link, RouteComponentProps } from 'react-router-dom';
import FlashMessageRender from '@/components/FlashMessageRender';
import LoginFormContainer from '@/components/auth/LoginFormContainer';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import { faEye, faEyeSlash } from '@fortawesome/free-solid-svg-icons';
import discordLogin from '@/api/auth/discord';

interface Values {
    username: string;
    email: string;
    password: string;
}

const RegisterContainer = ({ history }: RouteComponentProps) => {
    const ref = useRef<Reaptcha>(null);
    const [token, setToken] = useState('');
    const [showPassword, setShowPassword] = useState(false);
    const [discordLoading, setDiscordLoading] = useState(false);
    const [googleLoading, setGoogleLoading] = useState(false);

    // Easy to swap between env and state
    const siteName = process.env.REACT_APP_SITE_NAME || 'NeoDesigns Hosting';
    // const siteName = useStoreState((state) => state.settings.data?.name) || 'NeoDesigns Hosting';
    
    const discord = useStoreState((state) => state.settings.data?.registration.discord);
    const { clearFlashes, clearAndAddHttpError, addFlash } = useFlash();
    const { enabled: recaptchaEnabled, siteKey } = useStoreState((state) => state.settings.data!.recaptcha);

    useEffect(() => {
        clearFlashes();
    }, []);

    const handleGoogleLogin = () => {
        clearFlashes();
        setGoogleLoading(true);
        
        // Simple redirect to your backend route
        // Your backend will handle the OAuth redirect
        window.location.href = '/auth/google';
    };

    const handleDiscordLogin = () => {
        clearFlashes();
        setDiscordLoading(true);

        discordLogin()
            .then((data) => {
                if (!data) {
                    clearAndAddHttpError({ error: 'Discord auth failed. Please try again.' });
                    setDiscordLoading(false);
                    return;
                }
                window.location.href = data;
            })
            .catch((error) => {
                console.error(error);
                setDiscordLoading(false);
                clearAndAddHttpError({ error });
            });
    };

    const onSubmit = (values: Values, { setSubmitting }: FormikHelpers<Values>) => {
        clearFlashes();

        if (recaptchaEnabled && !token) {
            ref.current!.execute().catch((error) => {
                console.error(error);
                setSubmitting(false);
                clearAndAddHttpError({ error });
            });
            return;
        }

        register({ ...values, recaptchaData: token })
            .then((response) => {
                if (response.complete) {
                    history.replace('/auth/login');
                    addFlash({
                        key: 'auth:register',
                        type: 'success',
                        message: 'Account has been successfully created.',
                    });
                    return;
                }
                history.replace('/auth/register');
            })
            .catch((error) => {
                console.error(error);
                setToken('');
                if (ref.current) ref.current.reset();
                setSubmitting(false);
                clearAndAddHttpError({ error });
            });
    };

    return (
        <Formik
            onSubmit={onSubmit}
            initialValues={{ username: '', email: '', password: '' }}
            validationSchema={object().shape({
                username: string().min(3, 'Username must be at least 3 characters').required('Username is required'),
                email: string().email('Please enter a valid email address').required('Email is required'),
                password: string().min(8, 'Password must be at least 8 characters').required('Password is required'),
            })}
        >
            {({ isSubmitting, setSubmitting, submitForm }) => (
                <LoginFormContainer title={siteName} subtitle="Create your account to get started">
                    <FlashMessageRender byKey={'auth:register'} css={tw`mb-4`} />
                    
                    <div css={tw`space-y-4`}>
                        <Field 
                            type={'text'} 
                            label={'Username'} 
                            name={'username'} 
                            disabled={isSubmitting}
                            placeholder="Choose a username"
                        />

                        <Field
                            type={'email'}
                            label={'Email Address'}
                            name={'email'}
                            disabled={isSubmitting}
                            placeholder="Enter your email"
                        />

                        <div css={tw`relative`}>
                            <Field
                                type={showPassword ? 'text' : 'password'}
                                label={'Password'}
                                name={'password'}
                                disabled={isSubmitting}
                                placeholder="Create a strong password"
                            />
                            <button
                                type="button"
                                onClick={() => setShowPassword(!showPassword)}
                                css={tw`absolute right-3 top-9 text-gray-400 hover:text-gray-300 focus:outline-none`}
                            >
                                <FontAwesomeIcon icon={showPassword ? faEyeSlash : faEye} css={tw`text-sm`} />
                            </button>
                        </div>
                    </div>

                    <div css={tw`mt-6`}>
                        <Button 
                            type={'submit'} 
                            css={tw`w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 rounded-lg transition-colors`} 
                            size={Button.Sizes.Large} 
                            disabled={isSubmitting}
                        >
                            {isSubmitting ? 'Creating Account...' : 'Register'}
                        </Button>
                    </div>

                    {recaptchaEnabled && (
                        <Reaptcha
                            ref={ref}
                            size={'invisible'}
                            sitekey={siteKey || '_invalid_key'}
                            onVerify={(response) => {
                                setToken(response);
                                submitForm();
                            }}
                            onExpire={() => {
                                setSubmitting(false);
                                setToken('');
                            }}
                        />
                    )}

                    {discord && (
                        <>
                            <div css={tw`relative my-6`}>
                                <div css={tw`absolute inset-0 flex items-center`}>
                                    <div css={tw`w-full border-t border-gray-600`}></div>
                                </div>
                                <div css={tw`relative flex justify-center text-sm`}>
                                    <span css={tw`px-4 bg-gray-800 text-gray-400 uppercase tracking-wide text-xs`}>
                                        OR CONTINUE WITH
                                    </span>
                                </div>
                            </div>

                            <div css={tw`grid grid-cols-2 gap-4`}>
                                <button
                                    type="button"
                                    onClick={handleDiscordLogin}
                                    disabled={discordLoading}
                                    css={tw`flex items-center justify-center px-4 py-3 bg-gray-900 hover:bg-gray-700 text-white rounded-lg transition-colors border border-gray-700`}
                                >
                                    <img 
                                        src="/assets/svgs/discord.svg" 
                                        alt="Discord" 
                                        css={tw`w-5 h-5 mr-2`}
                                    />
                                    <span css={tw`font-medium text-sm`}>Discord</span>
                                </button>
                                
                                <button
                                    type="button"
                                    onClick={handleGoogleLogin}
                                    disabled={googleLoading}
                                    css={tw`flex items-center justify-center px-4 py-3 bg-gray-900 hover:bg-gray-700 text-white rounded-lg transition-colors border border-gray-700 disabled:opacity-50 disabled:cursor-not-allowed`}
                                >
                                    <svg css={tw`w-5 h-5 mr-2`} viewBox="0 0 24 24">
                                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                    </svg>
                                    <span css={tw`font-medium text-sm`}>
                                        {googleLoading ? 'Loading...' : 'Google'}
                                    </span>
                                </button>
                            </div>
                        </>
                    )}

                    <div css={tw`mt-6 text-center`}>
                        <span css={tw`text-sm text-gray-400`}>Already have an account? </span>
                        <Link
                            to={'/auth/login'}
                            css={tw`text-sm text-blue-400 hover:text-blue-300 font-medium transition-colors`}
                        >
                            Sign In
                        </Link>
                    </div>
                </LoginFormContainer>
            )}
        </Formik>
    );
};

export default RegisterContainer;
</file>

<file path="resources/scripts/components/elements/SidePanel.tsx">
// import React from 'react';
// import tw from 'twin.macro';
// import http from '@/api/http';
// import * as Icon from 'react-feather';
// import { useStoreState } from 'easy-peasy';
// import styled from 'styled-components/macro';
// import { NavLink, Link } from 'react-router-dom';
// import ProgressBar from '@/components/elements/ProgressBar';
// import Tooltip from '@/components/elements/tooltip/Tooltip';
// import SearchContainer from '@/components/dashboard/search/SearchContainer';

// export default () => {
//     const logo = useStoreState((state) => state.settings.data?.logo);
//     const tickets = useStoreState((state) => state.settings.data!.tickets);
//     const store = useStoreState((state) => state.storefront.data!.enabled);
//     const rootAdmin = useStoreState((state) => state.user.data!.rootAdmin);

//     const onTriggerLogout = () => {
//         http.post('/auth/logout').finally(() => {
//             // @ts-expect-error this is valid
//             window.location = '/';
//         });
//     };

//     const PanelDiv = styled.div`
//         ${tw`h-screen sticky bg-neutral-800 flex flex-col w-20 fixed top-0`};

//         & > div {
//             ${tw`mx-auto`};

//             & > a,
//             & > div {
//                 &:hover {
//                     ${tw`text-neutral-100`};
//                 }

//                 &:active,
//                 &.active {
//                     ${tw`text-green-600`};
//                 }
//             }
//         }
//     `;

//     return (
//         <PanelDiv>
//             <ProgressBar />
//             <Link to={'/'}>
//                 <img className={'p-2'} src={logo ?? 'https://avatars.githubusercontent.com/u/91636558'} />
//             </Link>
//             <div>
//                 <div className={'navigation-link'}>
//                     <div className={'bg-gray-700 rounded-lg p-2 my-8'}>
//                         <SearchContainer size={32} />
//                     </div>
//                 </div>
//                 <NavLink to={'/'} className={'navigation-link'} exact>
//                     <Tooltip placement={'bottom'} content={'Servers'}>
//                         <div className={'bg-gray-700 rounded-lg p-2 my-8'}>
//                             <Icon.Server size={32} />
//                         </div>
//                     </Tooltip>
//                 </NavLink>
//                 <NavLink to={'/account'} className={'navigation-link'}>
//                     <Tooltip placement={'bottom'} content={'Account'}>
//                         <div className={'bg-gray-700 rounded-lg p-2 my-8'}>
//                             <Icon.User size={32} />
//                         </div>
//                     </Tooltip>
//                 </NavLink>
//                 {store && (
//                     <NavLink to={'/store'} className={'navigation-link'}>
//                         <Tooltip placement={'bottom'} content={'Store'}>
//                             <div className={'bg-gray-700 rounded-lg p-2 my-8'}>
//                                 <Icon.ShoppingCart size={32} />
//                             </div>
//                         </Tooltip>
//                     </NavLink>
//                 )}
//                 {tickets && (
//                     <NavLink to={'/tickets'} className={'navigation-link'}>
//                         <Tooltip placement={'bottom'} content={'Tickets'}>
//                             <div className={'bg-gray-700 rounded-lg p-2 my-8'}>
//                                 <Icon.HelpCircle size={32} />
//                             </div>
//                         </Tooltip>
//                     </NavLink>
//                 )}
//                 {rootAdmin && (
//                     <a href={'/admin'} className={'navigation-link'}>
//                         <Tooltip placement={'bottom'} content={'Admin'}>
//                             <div className={'bg-gray-700 rounded-lg p-2 my-8'}>
//                                 <Icon.Settings size={32} />
//                             </div>
//                         </Tooltip>
//                     </a>
//                 )}
//                 <div id={'logo'}>
//                     <button onClick={onTriggerLogout} className={'navigation-link'}>
//                         <Tooltip placement={'bottom'} content={'Logout'}>
//                             <div className={'flex flex-row fixed bottom-0 mb-8 bg-gray-700 rounded-lg p-2'}>
//                                 <Icon.LogOut size={32} />
//                             </div>
//                         </Tooltip>
//                     </button>
//                 </div>
//             </div>
//         </PanelDiv>
//     );
// };

import React from 'react';
import tw from 'twin.macro';
import http from '@/api/http';
import * as Icon from 'react-feather';
import { useStoreState } from 'easy-peasy';
import styled from 'styled-components/macro';
import { NavLink, Link } from 'react-router-dom';
import Tooltip from '@/components/elements/tooltip/Tooltip';
import SearchContainer from '@/components/dashboard/search/SearchContainer';

export default () => {
    const logo = useStoreState((state) => state.settings.data?.logo);
    const tickets = useStoreState((state) => state.settings.data!.tickets);
    const store = useStoreState((state) => state.storefront.data!.enabled);
    const rootAdmin = useStoreState((state) => state.user.data!.rootAdmin);

    const onTriggerLogout = () => {
        http.post('/auth/logout').finally(() => {
            // @ts-expect-error this is valid
            window.location = '/';
        });
    };

    const PanelDiv = styled.div`
        ${tw`fixed left-0 top-0 h-screen w-32 flex flex-col items-center py-6 gap-3 z-50`};
        background-color: hsl(0, 0%, 10%);
        border-right: 1px solid hsl(0, 0%, 15%);
    `;

    const LogoBox = styled(Link)`
        ${tw`w-20 h-20 flex items-center justify-center mb-4 transition-all duration-200`};

        & img {
            ${tw`w-20 h-20 rounded object-cover`};
        }

        &:hover {
            opacity: 0.8;
        }
    `;

    const NavContainer = styled.nav`
        ${tw`flex-1 flex flex-col gap-3 w-full px-6 mt-4 items-center`};
    `;

    const NavItemWrapper = styled.div`
        ${tw`relative w-full flex justify-center`};
    `;

    const ActiveAccent = styled.div`
        ${tw`absolute -left-3 w-1 h-8 rounded-r-full transition-all duration-200`};
        background-color: rgb(239, 68, 68);
        opacity: 0;
        top: 50%;
        transform: translateY(-50%);
        box-shadow: 20px 0px 30px rgba(239, 68, 68, 0.7);
    `;

    const NavIconLink = styled(NavLink)`
        ${tw`w-20 h-20 rounded-2xl flex items-center justify-center transition-all duration-200 relative`};
        background-color: transparent;
        color: hsl(0, 0%, 60%);
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;

        &:hover {
            background-color: hsl(0, 0%, 18%);
            color: white;
        }

        &.active {
            background-color: hsl(0, 0%, 18%);
            color: white;

            & ${ActiveAccent} {
                opacity: 1;
            }
        }

        & svg {
            ${tw`transition-all duration-200`};
            stroke-width: 2;
        }

        &:hover svg {
            ${tw`scale-110`};
        }
    `;

    const SearchBox = styled.button`
        ${tw`w-20 h-20 rounded-2xl flex items-center justify-center transition-all duration-200 border-none cursor-pointer`};
        background-color: transparent;
        color: hsl(0, 0%, 60%);
        padding: 0 !important;
        display: flex;
        align-items: center;
        justify-content: center;

        &:hover {
            background-color: hsl(0, 0%, 18%);
            color: white;
        }

        & svg {
            ${tw`transition-all duration-200`};
        }

        &:hover svg {
            ${tw`scale-110`};
        }
    `;

    const LogoutBtn = styled.button`
        ${tw`w-20 h-20 rounded-full flex items-center justify-center transition-all duration-200 border-none cursor-pointer mt-auto mb-2`};
        background-color: hsl(0, 0%, 18%);
        color: hsl(0, 0%, 60%);

        &:hover {
            background-color: hsl(0, 0%, 25%);
            color: white;
        }

        & svg {
            ${tw`transition-all duration-200`};
            stroke-width: 2;
        }

        &:hover svg {
            ${tw`scale-110`};
        }
    `;

    return (
        <PanelDiv>
            <LogoBox to={'/'}>
                <img src="https://cdn.vervecustoms.com/logo/neo.png" alt="Logo" />
            </LogoBox>

            <NavContainer>
                <SearchBox>
                    <SearchContainer size={24} />
                </SearchBox>

                <NavItemWrapper>
                    <Tooltip placement={'right'} content={'Servers'}>
                        <NavIconLink to={'/'} exact>
                            <Icon.Server size={24} />
                            <ActiveAccent />
                        </NavIconLink>
                    </Tooltip>
                </NavItemWrapper>

                <NavItemWrapper>
                    <Tooltip placement={'right'} content={'Account'}>
                        <NavIconLink to={'/account'}>
                            <Icon.User size={24} />
                            <ActiveAccent />
                        </NavIconLink>
                    </Tooltip>
                </NavItemWrapper>

                {store && (
                    <NavItemWrapper>
                        <Tooltip placement={'right'} content={'Store'}>
                            <NavIconLink to={'/store'}>
                                <Icon.ShoppingCart size={24} />
                                <ActiveAccent />
                            </NavIconLink>
                        </Tooltip>
                    </NavItemWrapper>
                )}

                {tickets && (
                    <NavItemWrapper>
                        <Tooltip placement={'right'} content={'Tickets'}>
                            <NavIconLink to={'/tickets'}>
                                <Icon.HelpCircle size={24} />
                                <ActiveAccent />
                            </NavIconLink>
                        </Tooltip>
                    </NavItemWrapper>
                )}

                {rootAdmin && (
                    <NavItemWrapper>
                        <Tooltip placement={'right'} content={'Admin'}>
                            <NavIconLink as='a' href={'/admin'}>
                                <Icon.Settings size={24} />
                            </NavIconLink>
                        </Tooltip>
                    </NavItemWrapper>
                )}
            </NavContainer>

            <Tooltip placement={'right'} content={'Logout'}>
                <LogoutBtn onClick={onTriggerLogout}>
                    <Icon.LogOut size={24} />
                </LogoutBtn>
            </Tooltip>
        </PanelDiv>
    );
};
</file>

<file path="resources/scripts/components/store/CreateContainer.tsx">
import * as Icon from 'react-feather';
import { Form, Formik } from 'formik';
import useFlash from '@/plugins/useFlash';
import { useStoreState } from 'easy-peasy';
import { number, object, string } from 'yup';
import Field from '@/components/elements/Field';
import Select from '@/components/elements/Select';
import { Egg, getEggs } from '@/api/store/getEggs';
import createServer from '@/api/store/createServer';
import Spinner from '@/components/elements/Spinner';
import { getNodes, Node } from '@/api/store/getNodes';
import { getNests, Nest } from '@/api/store/getNests';
import InputSpinner from '@/components/elements/InputSpinner';
import StoreError from '@/components/elements/store/StoreError';
import React, { ChangeEvent, useEffect, useState } from 'react';
import FlashMessageRender from '@/components/FlashMessageRender';
import { getResources, Resources } from '@/api/store/getResources';
import PageContentBlock from '@/components/elements/PageContentBlock';
import { Check, AlertCircle } from 'lucide-react';

interface CreateValues {
    name: string;
    description: string | null;
    cpu: number;
    memory: number;
    disk: number;
    ports: number;
    backups: number | null;
    databases: number | null;
    egg: number;
    nest: number;
    node: number;
}

export default () => {
    const [loading, setLoading] = useState(false);
    const [resources, setResources] = useState<Resources>();
    const [currentStep, setCurrentStep] = useState(1);

    const user = useStoreState((state) => state.user.data!);
    const { clearFlashes, clearAndAddHttpError } = useFlash();

    const [egg, setEgg] = useState<number>(0);
    const [eggs, setEggs] = useState<Egg[]>();
    const [nest, setNest] = useState<number>(0);
    const [nests, setNests] = useState<Nest[]>();
    const [node, setNode] = useState<number>(0);
    const [nodes, setNodes] = useState<Node[]>();

    useEffect(() => {
        clearFlashes();

        getResources().then((resources) => setResources(resources));
        getEggs().then((eggs) => setEggs(eggs));
        getNests().then((nests) => setNests(nests));
        getNodes().then((nodes) => setNodes(nodes));
    }, []);

    const changeNest = (e: ChangeEvent<HTMLSelectElement>) => {
        setNest(parseInt(e.target.value));

        getEggs(parseInt(e.target.value)).then((eggs) => {
            setEggs(eggs);
            setEgg(eggs[0].id);
        });
    };

    const submit = (values: CreateValues) => {
        setLoading(true);
        clearFlashes('store:create');

        createServer(values, egg, nest, node)
            .then((data) => {
                if (!data.id) return;

                setLoading(false);
                clearFlashes('store:create');
                // @ts-expect-error this is valid
                window.location = `/server/${data.id}`;
            })
            .catch((error) => {
                setLoading(false);
                clearAndAddHttpError({ key: 'store:create', error });
            });
    };

    const getStepErrors = (errors: any, stepNum: number) => {
        if (stepNum === 1) {
            return errors.name ? [errors.name] : [];
        }
        if (stepNum === 2) {
            return [errors.cpu, errors.memory, errors.disk].filter(Boolean);
        }
        if (stepNum === 3) {
            return [errors.ports, errors.backups, errors.databases].filter(Boolean);
        }
        if (stepNum === 4) {
            return [errors.node, errors.nest, errors.egg].filter(Boolean);
        }
        return [];
    };

    if (!resources) return <Spinner size={'large'} centered />;

    if (!nodes) {
        return (
            <StoreError
                message={'No nodes are available for deployment. Try again later.'}
                admin={'Ensure you have at least one node that can be deployed to.'}
            />
        );
    }

    if (!nests || !eggs) {
        return (
            <StoreError
                message={'No server types are available for deployment. Try again later.'}
                admin={'Ensure you have at least one egg which is in a public nest.'}
            />
        );
    }

    const steps = [
        { number: 1, title: 'Basic Details', subtitle: 'Name & description' },
        { number: 2, title: 'Resource Limits', subtitle: 'CPU, RAM, Storage' },
        { number: 3, title: 'Feature Limits', subtitle: 'Allocations & addons' },
        { number: 4, title: 'Deployment', subtitle: 'Node, Nest & Egg' },
        { number: 5, title: 'Review & Confirm', subtitle: 'Final check' },
    ];

    return (
        <PageContentBlock
            title={'Create Server'}
            description={'A simple step-by-step flow  clean & flat.'}
            showFlashKey={'store:create'}
        >
            <div className='grid grid-cols-1 lg:grid-cols-4 gap-8'>
                <div className='lg:col-span-1'>
                    <div className='bg-gray-800/60 border border-gray-700/50 rounded-lg p-6 sticky top-8'>
                        <div className='space-y-2'>
                            {steps.map((step) => (
                                <div
                                    key={step.number}
                                    className={`flex items-start space-x-4 p-4 rounded transition-all cursor-pointer ${
                                        currentStep === step.number
                                            ? 'bg-gray-700/40 border border-gray-600/50'
                                            : currentStep > step.number
                                            ? 'bg-gray-800/20'
                                            : 'bg-transparent'
                                    }`}
                                    onClick={() => setCurrentStep(step.number)}
                                >
                                    <div
                                        className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center font-semibold text-sm ${
                                            currentStep === step.number
                                                ? 'bg-blue-600 text-white'
                                                : currentStep > step.number
                                                ? 'bg-green-600 text-white'
                                                : 'bg-gray-700 text-gray-400'
                                        }`}
                                    >
                                        {currentStep > step.number ? <Check className='w-4 h-4' /> : step.number}
                                    </div>
                                    <div className='flex-1 min-w-0'>
                                        <p
                                            className={`font-medium text-sm ${
                                                currentStep === step.number ? 'text-white' : 'text-gray-400'
                                            }`}
                                        >
                                            {step.title}
                                        </p>
                                        <p className='text-xs text-gray-500'>{step.subtitle}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>

                <div className='lg:col-span-3'>
                    <Formik
                        onSubmit={submit}
                        initialValues={{
                            name: `${user.username}'s server`,
                            description: 'Write a server description here.',
                            cpu: 50,
                            memory: 256,
                            disk: 256,
                            ports: 0,
                            backups: 0,
                            databases: 0,
                            nest: 0,
                            egg: 0,
                            node: 1,
                        }}
                        validationSchema={object().shape({
                            name: string().required().min(3),
                            description: string().optional().min(3).max(191),
                            cpu: number().required().min(20).max(100),
                            memory: number().required().min(256).max(2560),
                            disk: number().required().min(256).max(3072),
                            ports: number().required().min(1),
                            backups: number().optional().min(1).max(5),
                            databases: number().optional().max(1),
                            node: number().required(),
                            nest: number().required(),
                            egg: number().required(),
                        })}
                    >
                        {({ values, errors }) => {
                            const currentStepErrors = getStepErrors(errors, currentStep);
                            const canProgress = currentStepErrors.length === 0;

                            const selectedNest = nests?.find((n) => n.id === nest);
                            const selectedEgg = eggs?.find((e) => e.id === egg);
                            const selectedNode = nodes?.find((n) => n.id === node);

                            return (
                                <Form>
                                    <div className='bg-gray-800/60 border border-gray-700/50 rounded-lg p-8'>
                                        <FlashMessageRender byKey={'store:create'} className={'mb-6'} />

                                        {currentStepErrors.length > 0 && (
                                            <div className='mb-6 bg-red-900/30 border border-red-700/50 rounded-lg p-4'>
                                                <div className='flex gap-3'>
                                                    <AlertCircle className='w-5 h-5 text-red-400 flex-shrink-0 mt-0.5' />
                                                    <div>
                                                        <h3 className='text-red-400 font-semibold mb-2'>
                                                            Please complete the following:
                                                        </h3>
                                                        <ul className='space-y-1'>
                                                            {currentStepErrors.map((error, idx) => (
                                                                <li key={idx} className='text-red-300 text-sm'>
                                                                     {error}
                                                                </li>
                                                            ))}
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {currentStep === 1 && (
                                            <div className='space-y-6'>
                                                <div>
                                                    <h2 className='text-2xl font-bold text-white mb-2'>
                                                        Basic Details
                                                    </h2>
                                                    <p className='text-gray-400 mb-8'>
                                                        Set the basic fields for your new server.
                                                    </p>
                                                </div>

                                                <div className='space-y-6'>
                                                    <div>
                                                        <label className='block text-sm font-medium text-gray-300 mb-2'>
                                                            Server Name
                                                        </label>
                                                        <Field
                                                            name='name'
                                                            className='w-full bg-gray-900/50 border border-gray-700/50 rounded px-4 py-3 text-white placeholder-gray-600 focus:ring-1 focus:ring-blue-500 focus:border-blue-500/50 transition-colors'
                                                        />
                                                        <p className='mt-2 text-sm text-gray-500'>
                                                            Assign a name to your server for use in the Panel.
                                                        </p>
                                                    </div>

                                                    <div>
                                                        <label className='block text-sm font-medium text-gray-300 mb-2'>
                                                            Server Description
                                                            <span className='text-yellow-500 ml-2'>* Optional</span>
                                                        </label>
                                                        <Field
                                                            name='description'
                                                            className='w-full bg-gray-900/50 border border-gray-700/50 rounded px-4 py-3 text-white placeholder-gray-600 focus:ring-1 focus:ring-blue-500 focus:border-blue-500/50 transition-colors'
                                                        />
                                                        <p className='mt-2 text-sm text-gray-500'>
                                                            Set a description for your server.
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {currentStep === 2 && (
                                            <div className='space-y-6'>
                                                <div>
                                                    <h2 className='text-2xl font-bold text-white mb-2'>
                                                        Resource Limits
                                                    </h2>
                                                    <p className='text-gray-400 mb-8'>
                                                        Set specific limits for CPU, RAM and Storage.
                                                    </p>
                                                </div>

                                                <div className='grid grid-cols-1 md:grid-cols-3 gap-6'>
                                                    <div>
                                                        <label className='block text-sm font-medium text-gray-300 mb-2'>
                                                            CPU (%)
                                                        </label>
                                                        <Field
                                                            name='cpu'
                                                            type='number'
                                                            className='w-full bg-gray-900/50 border border-gray-700/50 rounded px-4 py-3 text-white placeholder-gray-600 focus:ring-1 focus:ring-blue-500 focus:border-blue-500/50 transition-colors'
                                                        />
                                                        <p className='mt-2 text-sm text-gray-500'>
                                                            Min: 20% | Max: 100%
                                                        </p>
                                                    </div>

                                                    <div>
                                                        <label className='block text-sm font-medium text-gray-300 mb-2'>
                                                            RAM (MB)
                                                        </label>
                                                        <Field
                                                            name='memory'
                                                            type='number'
                                                            className='w-full bg-gray-900/50 border border-gray-700/50 rounded px-4 py-3 text-white placeholder-gray-600 focus:ring-1 focus:ring-blue-500 focus:border-blue-500/50 transition-colors'
                                                        />
                                                        <p className='mt-2 text-sm text-gray-500'>
                                                            Min: 256 MB | Max: 2560 MB
                                                        </p>
                                                    </div>

                                                    <div>
                                                        <label className='block text-sm font-medium text-gray-300 mb-2'>
                                                            Storage (MB)
                                                        </label>
                                                        <Field
                                                            name='disk'
                                                            type='number'
                                                            className='w-full bg-gray-900/50 border border-gray-700/50 rounded px-4 py-3 text-white placeholder-gray-600 focus:ring-1 focus:ring-blue-500 focus:border-blue-500/50 transition-colors'
                                                        />
                                                        <p className='mt-2 text-sm text-gray-500'>
                                                            Min: 256 MB | Max: 3072 MB
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {currentStep === 3 && (
                                            <div className='space-y-6'>
                                                <div>
                                                    <h2 className='text-2xl font-bold text-white mb-2'>
                                                        Feature Limits
                                                    </h2>
                                                    <p className='text-gray-400 mb-8'>
                                                        Add databases, allocations and backups to your server.
                                                    </p>
                                                </div>

                                                <div className='grid grid-cols-1 md:grid-cols-3 gap-6'>
                                                    <div>
                                                        <label className='block text-sm font-medium text-gray-300 mb-2'>
                                                            Server Allocations
                                                        </label>
                                                        <Field
                                                            name='ports'
                                                            type='number'
                                                            className='w-full bg-gray-900/50 border border-gray-700/50 rounded px-4 py-3 text-white placeholder-gray-600 focus:ring-1 focus:ring-blue-500 focus:border-blue-500/50 transition-colors'
                                                        />
                                                        <p className='mt-2 text-sm text-gray-500'>Min: 1 (no max)</p>
                                                    </div>

                                                    <div>
                                                        <label className='block text-sm font-medium text-gray-300 mb-2'>
                                                            Server Backups
                                                            <span className='text-yellow-500 ml-2'>* Optional</span>
                                                        </label>
                                                        <Field
                                                            name='backups'
                                                            type='number'
                                                            className='w-full bg-gray-900/50 border border-gray-700/50 rounded px-4 py-3 text-white placeholder-gray-600 focus:ring-1 focus:ring-blue-500 focus:border-blue-500/50 transition-colors'
                                                        />
                                                        <p className='mt-2 text-sm text-gray-500'>Min: 1 | Max: 5</p>
                                                    </div>

                                                    <div>
                                                        <label className='block text-sm font-medium text-gray-300 mb-2'>
                                                            Server Databases
                                                            <span className='text-yellow-500 ml-2'>* Optional</span>
                                                        </label>
                                                        <Field
                                                            name='databases'
                                                            type='number'
                                                            className='w-full bg-gray-900/50 border border-gray-700/50 rounded px-4 py-3 text-white placeholder-gray-600 focus:ring-1 focus:ring-blue-500 focus:border-blue-500/50 transition-colors'
                                                        />
                                                        <p className='mt-2 text-sm text-gray-500'>Max: 1</p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {currentStep === 4 && (
                                            <div className='space-y-6'>
                                                <div>
                                                    <h2 className='text-2xl font-bold text-white mb-2'>
                                                        Select Deployment Settings
                                                    </h2>
                                                    <p className='text-gray-400 mb-8'>Choose a node and server type.</p>
                                                </div>

                                                <div className='grid grid-cols-1 md:grid-cols-3 gap-6'>
                                                    <div>
                                                        <label className='block text-sm font-medium text-gray-300 mb-2'>
                                                            Available Nodes
                                                        </label>
                                                        <Select
                                                            name='node'
                                                            onChange={(e) => setNode(parseInt(e.target.value))}
                                                            className='w-full bg-gray-900/50 border border-gray-700/50 rounded px-4 py-3 text-white focus:ring-1 focus:ring-blue-500 focus:border-blue-500/50 transition-colors'
                                                        >
                                                            {!node && <option>Select a node...</option>}
                                                            {nodes.map((n) => (
                                                                <option key={n.id} value={n.id}>
                                                                    {n.name} ({n.location}) |{' '}
                                                                    {100 -
                                                                        parseInt(
                                                                            ((n?.used / n?.total) * 100).toFixed(0)
                                                                        )}
                                                                    % free | {n.deployFee} credits
                                                                </option>
                                                            ))}
                                                        </Select>
                                                        <p className='mt-2 text-sm text-gray-500'>
                                                            Select a node to deploy your server to.
                                                        </p>
                                                    </div>

                                                    <div>
                                                        <label className='block text-sm font-medium text-gray-300 mb-2'>
                                                            Server Nest
                                                        </label>
                                                        <Select
                                                            name='nest'
                                                            onChange={(nest) => changeNest(nest)}
                                                            className='w-full bg-gray-900/50 border border-gray-700/50 rounded px-4 py-3 text-white focus:ring-1 focus:ring-blue-500 focus:border-blue-500/50 transition-colors'
                                                        >
                                                            {!nest && <option>Select a nest...</option>}
                                                            {nests.map((n) => (
                                                                <option key={n.id} value={n.id}>
                                                                    {n.name}
                                                                </option>
                                                            ))}
                                                        </Select>
                                                        <p className='mt-2 text-sm text-gray-500'>
                                                            Select a nest to use for your server.
                                                        </p>
                                                    </div>

                                                    <div>
                                                        <label className='block text-sm font-medium text-gray-300 mb-2'>
                                                            Server Egg
                                                        </label>
                                                        <Select
                                                            name='egg'
                                                            onChange={(e) => setEgg(parseInt(e.target.value))}
                                                            className='w-full bg-gray-900/50 border border-gray-700/50 rounded px-4 py-3 text-white focus:ring-1 focus:ring-blue-500 focus:border-blue-500/50 transition-colors'
                                                        >
                                                            {!egg && <option>Select an egg...</option>}
                                                            {eggs.map((e) => (
                                                                <option key={e.id} value={e.id}>
                                                                    {e.name}
                                                                </option>
                                                            ))}
                                                        </Select>
                                                        <p className='mt-2 text-sm text-gray-500'>
                                                            Choose what game you want to run on your server.
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {currentStep === 5 && (
                                            <div className='space-y-6'>
                                                <div>
                                                    <h2 className='text-2xl font-bold text-white mb-2'>
                                                        Review & Confirm
                                                    </h2>
                                                    <p className='text-gray-400 mb-8'>
                                                        Double-check everything before creating
                                                    </p>
                                                </div>

                                                <div className='space-y-4'>
                                                    <div className='bg-gray-900/30 border border-gray-700/50 rounded-lg p-4'>
                                                        <h3 className='text-sm font-semibold text-gray-300 mb-3'>
                                                            Basic Details
                                                        </h3>
                                                        <div className='space-y-2'>
                                                            <div className='flex justify-between'>
                                                                <span className='text-gray-500'>Server Name:</span>
                                                                <span className='text-white font-medium'>
                                                                    {values.name}
                                                                </span>
                                                            </div>
                                                            {values.description && (
                                                                <div className='flex justify-between'>
                                                                    <span className='text-gray-500'>Description:</span>
                                                                    <span className='text-white font-medium'>
                                                                        {values.description}
                                                                    </span>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>

                                                    <div className='bg-gray-900/30 border border-gray-700/50 rounded-lg p-4'>
                                                        <h3 className='text-sm font-semibold text-gray-300 mb-3'>
                                                            Resources
                                                        </h3>
                                                        <div className='space-y-2'>
                                                            <div className='flex justify-between'>
                                                                <span className='text-gray-500'>CPU:</span>
                                                                <span className='text-white font-medium'>
                                                                    {values.cpu}%
                                                                </span>
                                                            </div>
                                                            <div className='flex justify-between'>
                                                                <span className='text-gray-500'>RAM:</span>
                                                                <span className='text-white font-medium'>
                                                                    {values.memory}MB
                                                                </span>
                                                            </div>
                                                            <div className='flex justify-between'>
                                                                <span className='text-gray-500'>Disk:</span>
                                                                <span className='text-white font-medium'>
                                                                    {values.disk}MB
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div className='bg-gray-900/30 border border-gray-700/50 rounded-lg p-4'>
                                                        <h3 className='text-sm font-semibold text-gray-300 mb-3'>
                                                            Features
                                                        </h3>
                                                        <div className='space-y-2'>
                                                            <div className='flex justify-between'>
                                                                <span className='text-gray-500'>Allocations:</span>
                                                                <span className='text-white font-medium'>
                                                                    {values.ports}
                                                                </span>
                                                            </div>
                                                            {values.backups > 0 && (
                                                                <div className='flex justify-between'>
                                                                    <span className='text-gray-500'>Backups:</span>
                                                                    <span className='text-white font-medium'>
                                                                        {values.backups}
                                                                    </span>
                                                                </div>
                                                            )}
                                                            {values.databases > 0 && (
                                                                <div className='flex justify-between'>
                                                                    <span className='text-gray-500'>Databases:</span>
                                                                    <span className='text-white font-medium'>
                                                                        {values.databases}
                                                                    </span>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>

                                                    <div className='bg-gray-900/30 border border-gray-700/50 rounded-lg p-4'>
                                                        <h3 className='text-sm font-semibold text-gray-300 mb-3'>
                                                            Deployment
                                                        </h3>
                                                        <div className='space-y-2'>
                                                            <div className='flex justify-between'>
                                                                <span className='text-gray-500'>Node:</span>
                                                                <span className='text-white font-medium'>
                                                                    {selectedNode?.name || 'Not selected'}
                                                                </span>
                                                            </div>
                                                            <div className='flex justify-between'>
                                                                <span className='text-gray-500'>Nest:</span>
                                                                <span className='text-white font-medium'>
                                                                    {selectedNest?.name || 'Not selected'}
                                                                </span>
                                                            </div>
                                                            <div className='flex justify-between'>
                                                                <span className='text-gray-500'>Egg:</span>
                                                                <span className='text-white font-medium'>
                                                                    {selectedEgg?.name || 'Not selected'}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        <div className='flex items-center justify-between mt-8 pt-6 border-t border-gray-700/50'>
                                            <button
                                                type='button'
                                                onClick={() => setCurrentStep(Math.max(1, currentStep - 1))}
                                                disabled={currentStep === 1}
                                                className={`px-6 py-3 rounded font-medium transition-colors ${
                                                    currentStep === 1
                                                        ? 'bg-gray-700/40 text-gray-500 cursor-not-allowed'
                                                        : 'bg-gray-700/50 text-white hover:bg-gray-700/70'
                                                }`}
                                            >
                                                Back
                                            </button>

                                            <div className='text-sm text-gray-400'>Step {currentStep} of 5</div>

                                            {currentStep < 5 ? (
                                                <button
                                                    type='button'
                                                    onClick={() => setCurrentStep(Math.min(5, currentStep + 1))}
                                                    disabled={!canProgress}
                                                    className={`px-6 py-3 rounded font-medium transition-colors ${
                                                        canProgress
                                                            ? 'bg-blue-600 text-white hover:bg-blue-700'
                                                            : 'bg-gray-700/40 text-gray-500 cursor-not-allowed'
                                                    }`}
                                                >
                                                    Continue
                                                </button>
                                            ) : (
                                                <InputSpinner visible={loading}>
                                                    <button
                                                        type='submit'
                                                        disabled={loading || !canProgress}
                                                        className={`px-6 py-3 rounded font-medium flex items-center space-x-2 transition-colors ${
                                                            canProgress && !loading
                                                                ? 'bg-blue-600 text-white hover:bg-blue-700'
                                                                : 'bg-gray-700/40 text-gray-500 cursor-not-allowed opacity-50'
                                                        }`}
                                                    >
                                                        <Icon.Server className='w-5 h-5' />
                                                        <span>Create Server</span>
                                                    </button>
                                                </InputSpinner>
                                            )}
                                        </div>
                                    </div>
                                </Form>
                            );
                        }}
                    </Formik>
                </div>
            </div>
        </PageContentBlock>
    );
};
</file>

<file path="routes/base.php">
<?php

use Jexactyl\Http\Controllers\Base;
use Illuminate\Support\Facades\Route;
use Jexactyl\Http\Middleware\RequireTwoFactorAuthentication;

Route::get('/', [Base\IndexController::class, 'index'])->name('index')->fallback();
Route::get('/account', [Base\IndexController::class, 'index'])
    ->withoutMiddleware(RequireTwoFactorAuthentication::class)
    ->name('account');

Route::get('/locales/locale.json', Base\LocaleController::class)
    ->withoutMiddleware(['auth', RequireTwoFactorAuthentication::class])
    ->where('namespace', '.*');

Route::get('/{react}', [Base\IndexController::class, 'index'])
    ->where('react', '^(?!(\/)?(api|auth|admin|daemon)).+');

Route::post('/stripe/listen', [Base\StripeController::class, 'index']);
</file>

<file path="LICENSE">
MIT License

Copyright (c) 2025 NeoDesigns

Permission is refused to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software.
This software is not for use outside of NeoDesigns and it's partners and any use of this product without NeoDesigns express
permission for use will be met with a cease and desist order. Any further unauthorized use of the software will result in legal action on copyright infringement.

We DO not own Jexactyl or Pterodactyl or any other software being used in this product. We retain the rights to all the unoriginal code and assets used in this product such as but not linited to: 
- Google Sign in and Sign Up
- Custom Page Styling
- Robux Purchase System and other systems used within this product.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</file>

<file path="routes/api-client.php">
<?php

use Illuminate\Support\Facades\Route;
use Jexactyl\Http\Controllers\Api\Client;
use Jexactyl\Http\Middleware\Activity\ServerSubject;
use Jexactyl\Http\Middleware\Activity\AccountSubject;
use Jexactyl\Http\Middleware\RequireTwoFactorAuthentication;
use Jexactyl\Http\Middleware\Api\Client\Server\ResourceBelongsToServer;
use Jexactyl\Http\Middleware\Api\Client\Server\AuthenticateServerAccess;


/*
|--------------------------------------------------------------------------
| Client Control API
|--------------------------------------------------------------------------
|
| Endpoint: /api/client
|
*/
Route::get('/', [Client\ClientController::class, 'index'])->name('api:client.index');
Route::get('/permissions', [Client\ClientController::class, 'permissions']);

Route::prefix('/account')->middleware(AccountSubject::class)->group(function () {
    Route::prefix('/')->withoutMiddleware(RequireTwoFactorAuthentication::class)->group(function () {
        Route::get('/', [Client\AccountController::class, 'index'])->name('api:client.account');
        Route::get('/two-factor', [Client\TwoFactorController::class, 'index']);
        Route::post('/two-factor', [Client\TwoFactorController::class, 'store']);
        Route::post('/two-factor/disable', [Client\TwoFactorController::class, 'delete']);
    });

    Route::get('/logs', [Client\AccountLogController::class, 'index'])->withoutMiddleware(RequireTwoFactorAuthentication::class);
    Route::delete('/logs', [Client\AccountLogController::class, 'delete'])->withoutMiddleware(RequireTwoFactorAuthentication::class);

    Route::post('/verify', [Client\AccountController::class, 'verify'])->name('api:client.account.verify');
    Route::post('/coupon', [Client\AccountController::class, 'coupon'])->name('api:client.account.coupon');

    Route::put('/email', [Client\AccountController::class, 'updateEmail'])->name('api:client.account.update-email');
    Route::put('/password', [Client\AccountController::class, 'updatePassword'])->name('api:client.account.update-password');
    Route::put('/username', [Client\AccountController::class, 'updateUsername'])->name('api:client.account.update-username');

    Route::get('/activity', Client\ActivityLogController::class)->name('api:client.account.activity');
    Route::get('/activity/latest', [Client\ActivityLogController::class, 'latest'])->name('api:client.account.activity');

    Route::prefix('/referrals')->group(function () {
        Route::get('/', [Client\ReferralsController::class, 'index']);
        Route::get('/activity', [Client\ReferralsController::class, 'activity']);

        Route::post('/', [Client\ReferralsController::class, 'store']);
        Route::put('/use-code', [Client\ReferralsController::class, 'use']);

        Route::delete('/{code}', [Client\ReferralsController::class, 'delete']);
    });

    Route::get('/discord', [Client\DiscordController::class, 'link'])->name('api:client.account.discord');
    Route::get('/discord/callback', [Client\DiscordController::class, 'callback'])->name('api:client.account.discord.callback');
    Route::post('/discord/unlink', [Client\DiscordController::class, 'unlink'])->name('api:client.account.discord.unlink');

    Route::get('/api-keys', [Client\ApiKeyController::class, 'index']);
    Route::post('/api-keys', [Client\ApiKeyController::class, 'store']);
    Route::delete('/api-keys/{identifier}', [Client\ApiKeyController::class, 'delete']);

    Route::prefix('/ssh-keys')->group(function () {
        Route::get('/', [Client\SSHKeyController::class, 'index']);
        Route::post('/', [Client\SSHKeyController::class, 'store']);
        Route::post('/remove', [Client\SSHKeyController::class, 'delete']);
    });

    Route::prefix('/tickets')->group(function () {
        Route::get('/', [Client\TicketController::class, 'index']);
        Route::get('/{id}', [Client\TicketController::class, 'view']);
        Route::get('/{id}/messages', [Client\TicketController::class, 'viewMessages']);

        Route::post('/', [Client\TicketController::class, 'new']);
        Route::post('/{id}/messages', [Client\TicketController::class, 'newMessage']);

        Route::delete('/{id}', [Client\TicketController::class, 'close']);
    });
});

/*
|--------------------------------------------------------------------------
| Client Control API
|--------------------------------------------------------------------------
|
| Endpoint: /api/client/store
|
*/
Route::group([
    'prefix' => '/store',
], function () {
    Route::get('/', [Client\Store\ResourceController::class, 'user'])->name('api:client:store.user');
    Route::get('/costs', [Client\Store\ResourceController::class, 'costs'])->name('api:client:store.costs');
    Route::get('/nodes', [Client\Store\ServerController::class, 'nodes'])->name('api:client:store.nests');
    Route::get('/nests', [Client\Store\ServerController::class, 'nests'])->name('api:client:store.nests');

    Route::group(['prefix' => '/create', 'middleware' => 'throttle:storefront'], function () {
        Route::post('/', [Client\Store\ServerController::class, 'store'])->name('api:client:store.create');
    });

    Route::post('/eggs', [Client\Store\ServerController::class, 'eggs'])->name('api:client:store.eggs');
    Route::post('/stripe', [Client\Store\StripeController::class, 'purchase'])->name('api:client:store.stripe');
    Route::post('/resources', [Client\Store\ResourceController::class, 'purchase'])->name('api:client:store.resources');

    Route::group(['prefix' => '/earn', 'middleware' => 'throttle:earn'], function () {
        Route::post('/', [Client\Store\ResourceController::class, 'earn'])->name('api:client:store.earn');
    });

    Route::group(['prefix' => '/paypal'], function () {
        Route::get('/callback', [Client\Store\PayPalController::class, 'callback'])->name('api:client:store.paypal.callback');
        Route::post('/', [Client\Store\PayPalController::class, 'purchase'])->name('api:client:store.paypal');
    });
    Route::group(['prefix' => '/robux'], function () {
        Route::post('/profile', [Client\Store\RobuxController::class, 'getUserProfile']);
        Route::get('/products', [Client\Store\RobuxController::class, 'getProducts']);
        Route::post('/purchase', [Client\Store\RobuxController::class, 'initiatePurchase']);
        Route::post('/check', [Client\Store\RobuxController::class, 'checkPurchase']);
        Route::post('/cancel', [Client\Store\RobuxController::class, 'cancelPurchase']);
    });

});



/*
|--------------------------------------------------------------------------
| Client Control API
|--------------------------------------------------------------------------
|
| Endpoint: /api/client/servers/{server}
|
*/
Route::group([
    'prefix' => '/servers/{server}',
    'middleware' => [
        ServerSubject::class,
        AuthenticateServerAccess::class,
        ResourceBelongsToServer::class,
    ],
], function () {
    Route::get('/', [Client\Servers\ServerController::class, 'index'])->name('api:client:server.view');
    Route::get('/websocket', Client\Servers\WebsocketController::class)->name('api:client:server.ws');
    Route::get('/resources', Client\Servers\ResourceUtilizationController::class)->name('api:client:server.resources');
    Route::get('/activity', Client\Servers\ActivityLogController::class)->name('api:client:server.activity');

    Route::post('/background', [Client\Servers\ServerController::class, 'updateBackground']);
    Route::post('/command', [Client\Servers\CommandController::class, 'index']);
    Route::post('/power', [Client\Servers\PowerController::class, 'index']);

    // Routes for editing, deleting and renewing a server.
    Route::middleware(['throttle:server-edit'])->group(function () {
        Route::post('/edit', [Client\Servers\EditController::class, 'index'])->name('api:client:server.edit');
    });

    Route::middleware(['throttle:storefront'])->group(function () {
        Route::post('/renew', [Client\Servers\RenewalController::class, 'index'])->name('api:client:server.renew');
        Route::post('/delete', [Client\Servers\ServerController::class, 'delete'])->name('api:client:server.delete');
    });

    Route::post('/plugins', [Client\Servers\PluginController::class, 'index'])->name('api:client:server.plugins');
    Route::post('/plugins/install/{id}', [Client\Servers\PluginController::class, 'install'])->name('api:client:server.plugins');

    Route::group(['prefix' => '/analytics'], function () {
        Route::get('/', [Client\Servers\AnalyticsController::class, 'index']);
        Route::get('/messages', [Client\Servers\AnalyticsController::class, 'messages']);
    });

    Route::group(['prefix' => '/databases'], function () {
        Route::get('/', [Client\Servers\DatabaseController::class, 'index']);
        Route::post('/', [Client\Servers\DatabaseController::class, 'store']);
        Route::post('/{database}/rotate-password', [Client\Servers\DatabaseController::class, 'rotatePassword']);
        Route::delete('/{database}', [Client\Servers\DatabaseController::class, 'delete']);
    });

    Route::group(['prefix' => '/files'], function () {
        Route::get('/list', [Client\Servers\FileController::class, 'directory']);
        Route::get('/contents', [Client\Servers\FileController::class, 'contents']);
        Route::get('/download', [Client\Servers\FileController::class, 'download']);
        Route::put('/rename', [Client\Servers\FileController::class, 'rename']);
        Route::post('/copy', [Client\Servers\FileController::class, 'copy']);
        Route::post('/write', [Client\Servers\FileController::class, 'write']);
        Route::post('/compress', [Client\Servers\FileController::class, 'compress']);
        Route::post('/decompress', [Client\Servers\FileController::class, 'decompress']);
        Route::post('/delete', [Client\Servers\FileController::class, 'delete']);
        Route::post('/create-folder', [Client\Servers\FileController::class, 'create']);
        Route::post('/chmod', [Client\Servers\FileController::class, 'chmod']);
        Route::post('/pull', [Client\Servers\FileController::class, 'pull'])->middleware(['throttle:10,5']);
        Route::get('/upload', [Client\Servers\FileUploadController::class, '__invoke']);
    });

    Route::group(['prefix' => '/schedules'], function () {
        Route::get('/', [Client\Servers\ScheduleController::class, 'index']);
        Route::post('/', [Client\Servers\ScheduleController::class, 'store']);
        Route::get('/{schedule}', [Client\Servers\ScheduleController::class, 'view']);
        Route::post('/{schedule}', [Client\Servers\ScheduleController::class, 'update']);
        Route::post('/{schedule}/execute', [Client\Servers\ScheduleController::class, 'execute']);
        Route::delete('/{schedule}', [Client\Servers\ScheduleController::class, 'delete']);

        Route::post('/{schedule}/tasks', [Client\Servers\ScheduleTaskController::class, 'store']);
        Route::post('/{schedule}/tasks/{task}', [Client\Servers\ScheduleTaskController::class, 'update']);
        Route::delete('/{schedule}/tasks/{task}', [Client\Servers\ScheduleTaskController::class, 'delete']);
    });

    Route::group(['prefix' => '/network'], function () {
        Route::get('/allocations', [Client\Servers\NetworkAllocationController::class, 'index']);
        Route::post('/allocations', [Client\Servers\NetworkAllocationController::class, 'store']);
        Route::post('/allocations/{allocation}', [Client\Servers\NetworkAllocationController::class, 'update']);
        Route::post('/allocations/{allocation}/primary', [Client\Servers\NetworkAllocationController::class, 'setPrimary']);
        Route::delete('/allocations/{allocation}', [Client\Servers\NetworkAllocationController::class, 'delete']);
    });

    Route::group(['prefix' => '/users'], function () {
        Route::get('/', [Client\Servers\SubuserController::class, 'index']);
        Route::post('/', [Client\Servers\SubuserController::class, 'store']);
        Route::get('/{user}', [Client\Servers\SubuserController::class, 'view']);
        Route::post('/{user}', [Client\Servers\SubuserController::class, 'update']);
        Route::delete('/{user}', [Client\Servers\SubuserController::class, 'delete']);
    });

    Route::group(['prefix' => '/backups'], function () {
        Route::get('/', [Client\Servers\BackupController::class, 'index']);
        Route::post('/', [Client\Servers\BackupController::class, 'store']);
        Route::get('/{backup}', [Client\Servers\BackupController::class, 'view']);
        Route::get('/{backup}/download', [Client\Servers\BackupController::class, 'download']);
        Route::post('/{backup}/lock', [Client\Servers\BackupController::class, 'toggleLock']);
        Route::post('/{backup}/restore', [Client\Servers\BackupController::class, 'restore']);
        Route::delete('/{backup}', [Client\Servers\BackupController::class, 'delete']);
    });

    Route::group(['prefix' => '/startup'], function () {
        Route::get('/', [Client\Servers\StartupController::class, 'index']);
        Route::put('/variable', [Client\Servers\StartupController::class, 'update']);
    });

    Route::group(['prefix' => '/settings'], function () {
        Route::post('/rename', [Client\Servers\SettingsController::class, 'rename']);
        Route::post('/reinstall', [Client\Servers\SettingsController::class, 'reinstall']);
        Route::put('/docker-image', [Client\Servers\SettingsController::class, 'dockerImage']);
    });
});
</file>

<file path="resources/scripts/components/auth/LoginFormContainer.tsx">
// // import tw from 'twin.macro';
// // import { Form } from 'formik';
// // import { breakpoint } from '@/theme';
// // import React, { forwardRef } from 'react';
// // import styled from 'styled-components/macro';
// // import FlashMessageRender from '@/components/FlashMessageRender';

// // type Props = React.DetailedHTMLProps<React.FormHTMLAttributes<HTMLFormElement>, HTMLFormElement> & {
// //     title?: string;
// //     subtitle?: string;
// // };

// // const Container = styled.div`
// //     ${breakpoint('sm')`
// //         ${tw`w-4/5 mx-auto`}
// //     `};

// //     ${breakpoint('md')`
// //         ${tw`p-10`}
// //     `};

// //     ${breakpoint('lg')`
// //         ${tw`w-3/5`}
// //     `};

// //     ${breakpoint('xl')`
// //         ${tw`w-full`}
// //         max-width: 500px;
// //     `};
// // `;

// // const FormWrapper = styled.div`
// //     ${tw`w-full bg-gray-800 shadow-2xl rounded-2xl p-8 border border-gray-700`}
// // `;

// // export default forwardRef<HTMLFormElement, Props>(({ title, subtitle, ...props }, ref) => (
// //     <div css={tw`min-h-screen flex items-center justify-center p-4`} style={{ backgroundColor: '#1a1a1a' }}>
// //         <Container>
// //             <FlashMessageRender css={tw`mb-4 px-1`} />
// //             <FormWrapper>
// //                 {title && (
// //                     <div css={tw`text-center mb-6`}>
// //                         <h2 css={tw`text-3xl text-white font-bold mb-2`}>{title}</h2>
// //                         {subtitle && (
// //                             <p css={tw`text-gray-400 text-sm`}>{subtitle}</p>
// //                         )}
// //                     </div>
// //                 )}
// //                 <Form {...props} ref={ref}>
// //                     {props.children}
// //                 </Form>
// //             </FormWrapper>
// //         </Container>
// //     </div>
// // ));

// import tw from 'twin.macro';
// import { Form } from 'formik';
// import { breakpoint } from '@/theme';
// import React, { forwardRef } from 'react';
// import styled from 'styled-components/macro';
// import FlashMessageRender from '@/components/FlashMessageRender';

// type Props = React.DetailedHTMLProps<React.FormHTMLAttributes<HTMLFormElement>, HTMLFormElement> & {
//     title?: string;
//     subtitle?: string;
// };

// const Container = styled.div`
//     ${breakpoint('sm')`
//         ${tw`w-4/5 mx-auto`}
//     `};

//     ${breakpoint('md')`
//         ${tw`p-10`}
//     `};

//     ${breakpoint('lg')`
//         ${tw`w-3/5`}
//     `};

//     ${breakpoint('xl')`
//         ${tw`w-full`}
//         max-width: 500px;
//     `};
// `;

// const FormWrapper = styled.div`
//     ${tw`w-full bg-gray-800 shadow-2xl rounded-2xl p-8 border border-gray-700`}
// `;

// export default forwardRef<HTMLFormElement, Props>(({ title, subtitle, ...props }, ref) => (
//     <div css={tw`min-h-screen flex items-center justify-center p-4`} style={{ backgroundColor: '#1a1a1a', margin: 0, overflow: 'hidden' }}>
//         <Container css={tw`my-auto`}>
//             <FlashMessageRender css={tw`mb-4 px-1`} />
//             <FormWrapper>
//                 {title && (
//                     <div css={tw`text-center mb-6`}>
//                         <h2 css={tw`text-3xl text-white font-bold mb-2`}>{title}</h2>
//                         {subtitle && (
//                             <p css={tw`text-gray-400 text-sm`}>{subtitle}</p>
//                         )}
//                     </div>
//                 )}
//                 <Form {...props} ref={ref}>
//                     {props.children}
//                 </Form>
//             </FormWrapper>
//         </Container>
//     </div>
// ));

import tw from 'twin.macro';
import { Form } from 'formik';
import { breakpoint } from '@/theme';
import React, { forwardRef } from 'react';
import styled from 'styled-components/macro';
import FlashMessageRender from '@/components/FlashMessageRender';

type Props = React.DetailedHTMLProps<React.FormHTMLAttributes<HTMLFormElement>, HTMLFormElement> & {
    title?: string;
    subtitle?: string;
};

const Container = styled.div`
    ${tw`bg-gray-800 rounded-2xl shadow-xl p-8`};
    width: 100%;
    max-width: 28rem;

    ${breakpoint('sm')`
        ${tw`w-4/5 mx-auto`}
    `};

    ${breakpoint('md')`
        ${tw`p-10`}
    `};

    ${breakpoint('lg')`
        ${tw`w-3/5`}
    `};

    ${breakpoint('xl')`
        ${tw`w-full max-w-xl`}
    `};
`;

const Wrapper = styled.div`
    ${tw`flex flex-col`};
`;

export default forwardRef<HTMLFormElement, Props>(({ title, subtitle, ...props }, ref) => (
    <div css={tw`min-h-screen flex items-center justify-center p-4`} style={{ backgroundColor: '#1a1a1a' }}>
        <Container>
            <Wrapper>
                {title && (
                    <div css={tw`text-center mb-8`}>
                        <h1 css={tw`text-3xl font-bold text-white mb-2`}>
                            {title}
                        </h1>
                        {subtitle && (
                            <p css={tw`text-sm text-gray-400`}>
                                {subtitle}
                            </p>
                        )}
                    </div>
                )}
                
                <FlashMessageRender css={tw`mb-4 px-1`} />
                <Form {...props} ref={ref}>
                    {props.children}
                </Form>
            </Wrapper>
        </Container>
    </div>
));
</file>

<file path="resources/scripts/components/auth/LoginContainer.tsx">
import tw from 'twin.macro';
import Reaptcha from 'reaptcha';
import login from '@/api/auth/login';
import { object, string } from 'yup';
import useFlash from '@/plugins/useFlash';
import { useStoreState } from 'easy-peasy';
import { Formik, FormikHelpers } from 'formik';
import Field from '@/components/elements/Field';
import React, { useEffect, useRef, useState } from 'react';
import { Button } from '@/components/elements/button/index';
import { Link, RouteComponentProps } from 'react-router-dom';
import LoginFormContainer from '@/components/auth/LoginFormContainer';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import { faEye, faEyeSlash } from '@fortawesome/free-solid-svg-icons';
import discordLogin from '@/api/auth/discord';
import googleLogin from '@/api/auth/google'

interface Values {
    username: string;
    password: string;
}

const LoginContainer = ({ history }: RouteComponentProps) => {
    const ref = useRef<Reaptcha>(null);
    const [token, setToken] = useState('');
    const [showPassword, setShowPassword] = useState(false);
    const [discordLoading, setDiscordLoading] = useState(false);
    const [googleLoading, setGoogleLoading] = useState(false);
    
    // Easy to swap between env and state
    const siteName = process.env.REACT_APP_SITE_NAME || 'NeoDesigns Hosting';
    // const siteName = useStoreState((state) => state.settings.data?.name) || 'NeoDesigns Hosting';
    
    const email = useStoreState((state) => state.settings.data?.registration.email);
    const discord = useStoreState((state) => state.settings.data?.registration.discord);

    const { clearFlashes, clearAndAddHttpError } = useFlash();
    const { enabled: recaptchaEnabled, siteKey } = useStoreState((state) => state.settings.data!.recaptcha);

    useEffect(() => {
        clearFlashes();
    }, []);

    const handleGoogleLogin = () => {
        clearFlashes();
        setGoogleLoading(true);
        
        // Simple redirect to your backend route
        // Your backend will handle the OAuth redirect
        window.location.href = '/auth/google';
    };

    const handleDiscordLogin = () => {
        clearFlashes();
        setDiscordLoading(true);

        discordLogin()
            .then((data) => {
                if (!data) {
                    clearAndAddHttpError({ error: 'Discord auth failed. Please try again.' });
                    setDiscordLoading(false);
                    return;
                }
                window.location.href = data;
            })
            .catch((error) => {
                console.error(error);
                setDiscordLoading(false);
                clearAndAddHttpError({ error });
            });
    };

    const onSubmit = (values: Values, { setSubmitting }: FormikHelpers<Values>) => {
        clearFlashes();

        if (recaptchaEnabled && !token) {
            ref.current!.execute().catch((error) => {
                console.error(error);
                setSubmitting(false);
                clearAndAddHttpError({ error });
            });
            return;
        }

                login({ ...values, recaptchaData: token })
            .then((response) => {
                if (response.complete) {
                    // @ts-expect-error this is valid
                    window.location = response.intended || '/';
                    return;
                }
                // Persist confirmation token to sessionStorage as a fallback in case location.state isn't preserved.
                try {
                    if (response.confirmationToken && typeof window !== 'undefined') {
                        sessionStorage.setItem('checkpointToken', response.confirmationToken);
                    }
                } catch (e) {
                    // ignore sessionStorage errors
                }

                history.replace('/auth/login/checkpoint', { token: response.confirmationToken });
            })
            .catch((error) => {
                console.error(error);
                setToken('');
                if (ref.current) ref.current.reset();
                setSubmitting(false);
                clearAndAddHttpError({ error });
            });
    };

    return (
        <Formik
            onSubmit={onSubmit}
            initialValues={{ username: '', password: '' }}
            validationSchema={object().shape({
                username: string().required('A username or email must be provided.'),
                password: string().required('Please enter your account password.'),
            })}
        >
            {({ isSubmitting, setSubmitting, submitForm }) => (
                <LoginFormContainer title={siteName} subtitle="Sign in to your account to continue">
                    <div css={tw`space-y-4`}>
                        <Field 
                            light 
                            type={'text'} 
                            label={'Username or Email'} 
                            name={'username'} 
                            disabled={isSubmitting}
                            placeholder="Enter your email or username"
                        />

                        <div css={tw`relative`}>
                            <Field 
                                light 
                                type={showPassword ? 'text' : 'password'} 
                                label={'Password'} 
                                name={'password'} 
                                disabled={isSubmitting}
                                placeholder="Enter your password"
                            />
                            <button
                                type="button"
                                onClick={() => setShowPassword(!showPassword)}
                                css={tw`absolute right-3 top-9 text-gray-400 hover:text-gray-300 focus:outline-none`}
                            >
                                <FontAwesomeIcon icon={showPassword ? faEyeSlash : faEye} css={tw`text-sm`} />
                            </button>
                        </div>
                    </div>

                    <div css={tw`flex justify-center mt-4`}>
                        <Link
                            to={'/auth/password'}
                            css={tw`text-sm text-gray-400 hover:text-blue-400 transition-colors`}
                        >
                            Forgot Password?
                        </Link>
                    </div>

                    <div css={tw`mt-6`}>
                        <Button 
                            type={'submit'} 
                            size={Button.Sizes.Large} 
                            css={tw`w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 rounded-lg transition-colors`} 
                            disabled={isSubmitting}
                        >
                            {isSubmitting ? 'Signing In...' : 'Sign In'}
                        </Button>
                    </div>

                    {recaptchaEnabled && (
                        <Reaptcha
                            ref={ref}
                            size={'invisible'}
                            sitekey={siteKey || '_invalid_key'}
                            onVerify={(response) => {
                                setToken(response);
                                submitForm();
                            }}
                            onExpire={() => {
                                setSubmitting(false);
                                setToken('');
                            }}
                        />
                    )}

                    {(email || discord) && (
                        <>
                            <div css={tw`relative my-6`}>
                                <div css={tw`absolute inset-0 flex items-center`}>
                                    <div css={tw`w-full border-t border-gray-600`}></div>
                                </div>
                                <div css={tw`relative flex justify-center text-sm`}>
                                    <span css={tw`px-4 bg-gray-800 text-gray-400 uppercase tracking-wide text-xs`}>
                                        OR CONTINUE WITH
                                    </span>
                                </div>
                            </div>

                            <div css={tw`grid grid-cols-2 gap-4`}>
                                {discord && (
                                    <button
                                        type="button"
                                        onClick={handleDiscordLogin}
                                        disabled={discordLoading}
                                        css={tw`flex items-center justify-center px-4 py-3 bg-gray-900 hover:bg-gray-700 text-white rounded-lg transition-colors border border-gray-700`}
                                    >
                                        <img 
                                            src="/assets/svgs/discord.svg" 
                                            alt="Discord" 
                                            css={tw`w-5 h-5 mr-2`}
                                        />
                                        <span css={tw`font-medium text-sm`}>Discord</span>
                                    </button>
                                )}
                                
                                <button
                                    type="button"
                                    onClick={handleGoogleLogin}
                                    disabled={googleLoading}
                                    css={tw`flex items-center justify-center px-4 py-3 bg-gray-900 hover:bg-gray-700 text-white rounded-lg transition-colors border border-gray-700 disabled:opacity-50 disabled:cursor-not-allowed`}
                                >
                                    <svg css={tw`w-5 h-5 mr-2`} viewBox="0 0 24 24">
                                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                    </svg>
                                    <span css={tw`font-medium text-sm`}>
                                        {googleLoading ? 'Loading...' : 'Google'}
                                    </span>
                                </button>
                            </div>
                        </>
                    )}

                    <div css={tw`mt-6 text-center`}>
                        <span css={tw`text-sm text-gray-400`}>Don't have an account? </span>
                        {email && (
                            <Link
                                to={'/auth/register'}
                                css={tw`text-sm text-blue-400 hover:text-blue-300 font-medium transition-colors`}
                            >
                                Sign Up
                            </Link>
                        )}
                    </div>
                </LoginFormContainer>
            )}
        </Formik>
    );
};

export default LoginContainer;
</file>

</files>
